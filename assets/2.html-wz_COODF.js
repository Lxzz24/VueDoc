import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as s,c as a,d as t}from"./app-CvlAI_tu.js";const e={},p=t(`<p>æ—¢ç„¶æˆ‘ä»¬èƒ½é€šè¿‡ Filter ä¿®æ”¹ <code>HttpServletRequest</code>ï¼Œè‡ªç„¶ä¹Ÿèƒ½ä¿®æ”¹ <code>HttpServletResponse</code>ï¼Œå› ä¸ºè¿™ä¸¤è€…éƒ½æ˜¯æ¥å£ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨ä»€ä¹ˆæƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦ä¿®æ”¹ <code>HttpServletResponse</code>ã€‚</p><p>å‡è®¾æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ª Servletï¼Œä½†ç”±äºä¸šåŠ¡é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œå¤„ç†è¯¥è¯·æ±‚éœ€è¦è€—è´¹å¾ˆé•¿çš„æ—¶é—´ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span>urlPatterns <span class="token operator">=</span> <span class="token string">&quot;/slow/hello&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        resp<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¨¡æ‹Ÿè€—æ—¶ 1 ç§’:</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">PrintWriter</span> pw <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;h1&gt;Hello, world!&lt;/h1&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¥½æ¶ˆæ¯æ˜¯æ¯æ¬¡è¿”å›çš„å“åº”å†…å®¹æ˜¯å›ºå®šçš„ï¼Œå› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬èƒ½ä½¿ç”¨ç¼“å­˜å°†ç»“æœç¼“å­˜èµ·æ¥ï¼Œå°±å¯ä»¥å¤§å¤§æé«˜ Web åº”ç”¨ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚</p><p>ç¼“å­˜é€»è¾‘æœ€å¥½ä¸è¦åœ¨ Servlet å†…éƒ¨å®ç°ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›èƒ½å¤ç”¨ç¼“å­˜é€»è¾‘ï¼Œæ‰€ä»¥ï¼Œç¼–å†™ä¸€ä¸ª <code>CacheFilter</code> æœ€åˆé€‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@WebFilter</span><span class="token punctuation">(</span><span class="token string">&quot;/slow/*&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
    <span class="token comment">// Path åˆ° byte[] çš„ç¼“å­˜:</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> resp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">;</span>
        <span class="token comment">// è·å– Path:</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–ç¼“å­˜å†…å®¹:</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Cache-Hit&quot;</span><span class="token punctuation">,</span> data <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;No&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Yes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç¼“å­˜æœªæ‰¾åˆ°, æ„é€ ä¸€ä¸ªä¼ªé€ çš„ Response:</span>
            <span class="token class-name">CachedHttpServletResponse</span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CachedHttpServletResponse</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®©ä¸‹æ¸¸ç»„ä»¶å†™å…¥æ•°æ®åˆ°ä¼ªé€ çš„ Response:</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ä»ä¼ªé€ çš„ Response ä¸­è¯»å–å†™å…¥çš„å†…å®¹å¹¶æ”¾å…¥ç¼“å­˜:</span>
            data <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å†™å…¥åˆ°åŸå§‹çš„ Response:</span>
        <span class="token class-name">ServletOutputStream</span> output <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°ç¼“å­˜çš„å…³é”®åœ¨äºï¼Œè°ƒç”¨ <code>doFilter()</code> æ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½ä¼ å…¥åŸå§‹çš„ <code>HttpServletResponse</code>ï¼Œå› ä¸ºè¿™æ ·å°±ä¼šå†™å…¥ Socketï¼Œæˆ‘ä»¬ä¹Ÿå°±æ— æ³•è·å–ä¸‹æ¸¸ç»„ä»¶å†™å…¥çš„å†…å®¹ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ â€œä¼ªé€ â€ çš„ <code>HttpServletResponse</code>ï¼Œè®©ä¸‹æ¸¸ç»„ä»¶å†™å…¥åˆ°æˆ‘ä»¬é¢„è®¾çš„ <code>ByteArrayOutputStream</code>ï¼Œæˆ‘ä»¬å°± â€œæˆªè·â€ äº†ä¸‹æ¸¸ç»„ä»¶å†™å…¥çš„å†…å®¹ï¼Œäºæ˜¯ï¼Œå°±å¯ä»¥æŠŠå†…å®¹ç¼“å­˜èµ·æ¥ï¼Œå†é€šè¿‡åŸå§‹çš„ <code>HttpServletResponse</code> å®ä¾‹å†™å…¥åˆ°ç½‘ç»œã€‚</p><p>è¿™ä¸ª <code>CachedHttpServletResponse</code> å®ç°å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">CachedHttpServletResponse</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletResponseWrapper</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token keyword">open</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ByteArrayOutputStream</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CachedHttpServletResponse</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å– Writer:</span>
    <span class="token keyword">public</span> <span class="token class-name">PrintWriter</span> <span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">open</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot re-open writer!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">open</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å– OutputStream:</span>
    <span class="token keyword">public</span> <span class="token class-name">ServletOutputStream</span> <span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">open</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot re-open output stream!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">open</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServletOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWriteListener</span><span class="token punctuation">(</span><span class="token class-name">WriteListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// å®é™…å†™å…¥ ByteArrayOutputStream:</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                output<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿”å›å†™å…¥çš„ byte[]:</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> output<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯è§ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¿®æ”¹å“åº”ï¼Œå°±å¯ä»¥é€šè¿‡ <code>HttpServletResponseWrapper</code> æ„é€ ä¸€ä¸ª â€œä¼ªé€ â€ çš„ <code>HttpServletResponse</code>ï¼Œè¿™æ ·å°±èƒ½æ‹¦æˆªåˆ°å†™å…¥çš„æ•°æ®ã€‚</p><p>ä¿®æ”¹å“åº”æ—¶ï¼Œæœ€åä¸è¦å¿˜è®°æŠŠæ•°æ®å†™å…¥åŸå§‹çš„ <code>HttpServletResponse</code> å®ä¾‹ã€‚</p><p>è¿™ä¸ª <code>CacheFilter</code> åŒæ ·æ˜¯ä¸€ä¸ª â€œå¯æ’æ‹”â€ ç»„ä»¶ï¼Œå®ƒæ˜¯å¦å¯ç”¨ä¸å½±å“ Web åº”ç”¨ç¨‹åºçš„å…¶ä»–ç»„ä»¶ï¼ˆFilterã€Servletï¼‰ã€‚</p><h2 id="ğŸ€-ç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#ğŸ€-ç»ƒä¹ " aria-hidden="true">#</a> ğŸ€ ç»ƒä¹ </h2><p>é€šè¿‡ Filter ä¿®æ”¹å“åº”</p><h2 id="ğŸ€-å°ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ€-å°ç»“" aria-hidden="true">#</a> ğŸ€ å°ç»“</h2><p>å€ŸåŠ© <code>HttpServletResponseWrapper</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Filter ä¸­å®ç°å¯¹åŸå§‹ <code>HttpServletResponse</code> çš„ä¿®æ”¹ã€‚</p>`,17),o=[p];function c(l,u){return s(),a("div",null,o)}const r=n(e,[["render",c],["__file","2.html.vue"]]);export{r as default};
