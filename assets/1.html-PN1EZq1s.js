import{_ as p}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as o,o as c,c as l,a as s,e as n,b as e,d as a}from"./app-CvlAI_tu.js";const i={},u=a(`<p>Filter å¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œé¢„å¤„ç†ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå¾ˆå¤šå…¬å…±é¢„å¤„ç†é€»è¾‘æ”¾åˆ° Filter ä¸­å®Œæˆã€‚</p><p>è€ƒå¯Ÿè¿™æ ·ä¸€ç§éœ€æ±‚ï¼šæˆ‘ä»¬åœ¨ Web åº”ç”¨ä¸­ç»å¸¸éœ€è¦å¤„ç†ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ª UploadServlet å¯ä»¥ç®€å•åœ°ç¼–å†™å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span>urlPatterns <span class="token operator">=</span> <span class="token string">&quot;/upload/file&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯»å– Request Body:</span>
        <span class="token class-name">InputStream</span> input <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteArrayOutputStream</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            output<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO: å†™å…¥æ–‡ä»¶:</span>
        <span class="token comment">// æ˜¾ç¤ºä¸Šä¼ ç»“æœ:</span>
        <span class="token class-name">String</span> uploadedText <span class="token operator">=</span> output<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PrintWriter</span> pw <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;h1&gt;Uploaded:&lt;/h1&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;pre&gt;&lt;code&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>uploadedText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/code&gt;&lt;/pre&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),r={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1304227729113121",target:"_blank",rel:"noopener noreferrer"},k=a(`<p>è¿™ä¸ªéªŒè¯é€»è¾‘éå¸¸é€‚åˆå†™åœ¨ <code>ValidateUploadFilter</code> ä¸­ï¼Œå› ä¸ºå®ƒå¯ä»¥å¤ç”¨ã€‚</p><p>æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç®€å•çš„ç‰ˆæœ¬ï¼Œå¿«é€Ÿå®ç° <code>ValidateUploadFilter</code> çš„é€»è¾‘ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@WebFilter</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/*&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidateUploadFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> resp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">;</span>
        <span class="token comment">// è·å–å®¢æˆ·ç«¯ä¼ å…¥çš„ç­¾åæ–¹æ³•å’Œç­¾å:</span>
        <span class="token class-name">String</span> digest <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Signature-Method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> signature <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Signature&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>digest <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> digest<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> signature <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> signature<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sendErrorPage</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> <span class="token string">&quot;Missing signature.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è¯»å– Request çš„ Body å¹¶éªŒè¯ç­¾å:</span>
        <span class="token class-name">MessageDigest</span> md <span class="token operator">=</span> <span class="token function">getMessageDigest</span><span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InputStream</span> input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DigestInputStream</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> md<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> actual <span class="token operator">=</span> <span class="token function">toHexString</span><span class="token punctuation">(</span>md<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>signature<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sendErrorPage</span><span class="token punctuation">(</span>resp<span class="token punctuation">,</span> <span class="token string">&quot;Invalid signature.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// éªŒè¯æˆåŠŸåç»§ç»­å¤„ç†:</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å°† byte[] è½¬æ¢ä¸º hex string:</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> digest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">byte</span> b <span class="token operator">:</span> digest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%02x&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ ¹æ®åç§°åˆ›å»º MessageDigest:</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageDigest</span> <span class="token function">getMessageDigest</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å‘é€ä¸€ä¸ªé”™è¯¯å“åº”:</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendErrorPage</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">,</span> <span class="token class-name">String</span> errorMessage<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        resp<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token constant">SC_BAD_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PrintWriter</span> pw <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pw<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ª <code>ValidateUploadFilter</code> çš„é€»è¾‘ä¼¼ä¹æ²¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ curl å‘½ä»¤æµ‹è¯•ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">curl</span> http://localhost:8080/upload/file <span class="token parameter variable">-v</span> <span class="token parameter variable">-d</span> <span class="token string">&#39;test-data&#39;</span> <span class="token punctuation">\\</span>
  <span class="token parameter variable">-H</span> <span class="token string">&#39;Signature-Method: SHA-1&#39;</span> <span class="token punctuation">\\</span>
  <span class="token parameter variable">-H</span> <span class="token string">&#39;Signature: 7115e9890f5b5cc6914bdfa3b7c011db1cdafedb&#39;</span> <span class="token punctuation">\\</span>
  <span class="token parameter variable">-H</span> <span class="token string">&#39;Content-Type: application/octet-stream&#39;</span>
*   Trying ::1<span class="token punctuation">..</span>.
* TCP_NODELAY <span class="token builtin class-name">set</span>
* Connected to localhost <span class="token punctuation">(</span>::1<span class="token punctuation">)</span> port <span class="token number">8080</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> POST /upload/file HTTP/1.1
<span class="token operator">&gt;</span> Host: localhost:8080
<span class="token operator">&gt;</span> User-Agent: curl/7.64.1
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Signature-Method: SHA-1
<span class="token operator">&gt;</span> Signature: 7115e9890f5b5cc6914bdfa3b7c011db1cdafedb
<span class="token operator">&gt;</span> Content-Type: application/octet-stream
<span class="token operator">&gt;</span> Content-Length: <span class="token number">9</span>
<span class="token operator">&gt;</span>
* upload completely sent off: <span class="token number">9</span> out of <span class="token number">9</span> bytes
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span>
<span class="token operator">&lt;</span> Transfer-Encoding: chunked
<span class="token operator">&lt;</span> Date: Thu, <span class="token number">30</span> Jan <span class="token number">2020</span> <span class="token number">13</span>:56:39 GMT
<span class="token operator">&lt;</span>
* Connection <span class="token comment">#0 to host localhost left intact</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Uploaded:<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>pre<span class="token operator">&gt;</span><span class="token operator">&lt;</span>code<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/code<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/pre<span class="token operator">&gt;</span>
* Closing connection <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ValidateUploadFilter</code> å¯¹ç­¾åè¿›è¡ŒéªŒè¯çš„é€»è¾‘æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ï¼Œç»†å¿ƒçš„ç«¥é‹æ³¨æ„åˆ°ï¼Œ<code>UploadServlet</code> å¹¶æœªè¯»å–åˆ°ä»»ä½•æ•°æ®ï¼</p><p>è¿™é‡Œçš„åŸå› æ˜¯å¯¹ <code>HttpServletRequest</code> è¿›è¡Œè¯»å–æ—¶ï¼Œåªèƒ½è¯»å–ä¸€æ¬¡ã€‚å¦‚æœ Filter è°ƒç”¨ <code>getInputStream()</code> è¯»å–äº†ä¸€æ¬¡æ•°æ®ï¼Œåç»­ Servlet å¤„ç†æ—¶ï¼Œå†æ¬¡è¯»å–ï¼Œå°†æ— æ³•è¯»åˆ°ä»»ä½•æ•°æ®ã€‚æ€ä¹ˆåŠï¼Ÿ</p>`,7),d=s("code",null,"HttpServletRequest",-1),v={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017",target:"_blank",rel:"noopener noreferrer"},m=s("code",null,"getInputStream()",-1),b=s("code",null,"getReader()",-1),w=a(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ReReadableHttpServletRequest</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletRequestWrapper</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token keyword">open</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ReReadableHttpServletRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿”å› InputStream:</span>
    <span class="token keyword">public</span> <span class="token class-name">ServletInputStream</span> <span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">open</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot re-open input stream!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">open</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServletInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">private</span> <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> offset <span class="token operator">&gt;=</span> body<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReadListener</span><span class="token punctuation">(</span><span class="token class-name">ReadListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>offset<span class="token operator">&gt;=</span> body<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> n <span class="token operator">=</span> body<span class="token punctuation">[</span>offset<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
                offset<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> n<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿”å› Reader:</span>
    <span class="token keyword">public</span> <span class="token class-name">BufferedReader</span> <span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">open</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot re-open reader!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">open</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„è§‚å¯Ÿ <code>ReReadableHttpServletRequest</code> çš„æ„é€ æ–¹æ³•ï¼Œå®ƒä¿å­˜äº† <code>ValidateUploadFilter</code> è¯»å–çš„ <code>byte[]</code> å†…å®¹ï¼Œå¹¶åœ¨è°ƒç”¨ <code>getInputStream()</code> æ—¶é€šè¿‡ <code>byte[]</code> æ„é€ äº†ä¸€ä¸ªæ–°çš„ <code>ServletInputStream</code>ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬åœ¨ <code>ValidateUploadFilter</code> ä¸­ï¼ŒæŠŠ <code>doFilter()</code> è°ƒç”¨æ—¶ä¼ ç»™ä¸‹ä¸€ä¸ªå¤„ç†è€…çš„ <code>HttpServletRequest</code> æ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå·± â€œä¼ªé€ â€ çš„ <code>ReReadableHttpServletRequest</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReReadableHttpServletRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> output<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†æ³¨æ„åˆ°æˆ‘ä»¬ç¼–å†™ <code>ReReadableHttpServletRequest</code> æ—¶ï¼Œæ˜¯ä» <code>HttpServletRequestWrapper</code> ç»§æ‰¿ï¼Œè€Œä¸æ˜¯ç›´æ¥å®ç° <code>HttpServletRequest</code> æ¥å£ã€‚è¿™æ˜¯å› ä¸ºï¼ŒServlet çš„æ¯ä¸ªæ–°ç‰ˆæœ¬éƒ½ä¼šå¯¹æ¥å£å¢åŠ ä¸€äº›æ–°æ–¹æ³•ï¼Œä» <code>HttpServletRequestWrapper</code> ç»§æ‰¿å¯ä»¥ç¡®ä¿æ–°æ–¹æ³•è¢«æ­£ç¡®åœ°è¦†å†™äº†ï¼Œå› ä¸º <code>HttpServletRequestWrapper</code> æ˜¯ç”± Servlet çš„ jar åŒ…æä¾›çš„ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†è®©æˆ‘ä»¬æ–¹ä¾¿åœ°å®ç°å¯¹ <code>HttpServletRequest</code> æ¥å£çš„ä»£ç†ã€‚</p><p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹å¯¹ <code>HttpServletRequest</code> æ¥å£è¿›è¡Œä»£ç†çš„æ­¥éª¤ï¼š</p><ol><li>ä» <code>HttpServletRequestWrapper</code> ç»§æ‰¿ä¸€ä¸ª <code>XxxHttpServletRequest</code>ï¼Œéœ€è¦ä¼ å…¥åŸå§‹çš„ <code>HttpServletRequest</code> å®ä¾‹ï¼›</li><li>è¦†å†™æŸäº›æ–¹æ³•ï¼Œä½¿å¾—æ–°çš„ <code>XxxHttpServletRequest</code> å®ä¾‹çœ‹ä¸Šå» â€œæ”¹å˜â€ äº†åŸå§‹çš„ <code>HttpServletRequest</code> å®ä¾‹ï¼›</li><li>åœ¨ <code>doFilter()</code> ä¸­ä¼ å…¥æ–°çš„ <code>XxxHttpServletRequest</code> å®ä¾‹ã€‚</li></ol><p>è™½ç„¶æ•´ä¸ª Filter çš„ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œä½†å®ƒçš„å¥½å¤„åœ¨äºï¼šè¿™ä¸ª Filter åœ¨æ•´ä¸ªå¤„ç†é“¾ä¸­å®ç°äº†çµæ´»çš„ â€œå¯æ’æ‹”â€ ç‰¹æ€§ï¼Œå³æ˜¯å¦å¯ç”¨å¯¹ Web åº”ç”¨ç¨‹åºçš„å…¶ä»–ç»„ä»¶ï¼ˆFilterã€Servletï¼‰å®Œå…¨æ²¡æœ‰å½±å“ã€‚</p><h2 id="ğŸ€-ç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#ğŸ€-ç»ƒä¹ " aria-hidden="true">#</a> ğŸ€ ç»ƒä¹ </h2><p>ä½¿ç”¨ Filter ä¿®æ”¹è¯·æ±‚</p><h2 id="ğŸ€-å°ç»“" tabindex="-1"><a class="header-anchor" href="#ğŸ€-å°ç»“" aria-hidden="true">#</a> ğŸ€ å°ç»“</h2><p>å€ŸåŠ© <code>HttpServletRequestWrapper</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Filter ä¸­å®ç°å¯¹åŸå§‹ <code>HttpServletRequest</code> çš„ä¿®æ”¹ã€‚</p>`,12);function g(y,f){const t=o("ExternalLinkIcon");return c(),l("div",null,[u,s("p",null,[n("ä½†æ˜¯è¦ä¿è¯æ–‡ä»¶ä¸Šä¼ çš„å®Œæ•´æ€§æ€ä¹ˆåŠï¼Ÿåœ¨ "),s("a",r,[n("å“ˆå¸Œç®—æ³•"),e(t)]),n(" ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœåœ¨ä¸Šä¼ æ–‡ä»¶çš„åŒæ—¶ï¼ŒæŠŠæ–‡ä»¶çš„å“ˆå¸Œä¹Ÿä¼ è¿‡æ¥ï¼ŒæœåŠ¡å™¨ç«¯åšä¸€ä¸ªéªŒè¯ï¼Œå°±å¯ä»¥ç¡®ä¿ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ä¸€å®šæ˜¯å®Œæ•´çš„ã€‚")]),k,s("p",null,[n("è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª â€œä¼ªé€ â€ çš„ "),d,n("ï¼Œå…·ä½“åšæ³•æ˜¯ä½¿ç”¨ "),s("a",v,[n("ä»£ç†æ¨¡å¼"),e(t)]),n("ï¼Œå¯¹ "),m,n(" å’Œ "),b,n(" è¿”å›ä¸€ä¸ªæ–°çš„æµï¼š")]),w])}const q=p(i,[["render",g],["__file","1.html.vue"]]);export{q as default};
