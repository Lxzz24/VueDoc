import{_ as p}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as o,o as r,c as d,a as n,b as a,w as e,e as s,d as l}from"./app-CvlAI_tu.js";const u="/VueDoc/assets/l-20231221154251203-DcfmwSsb.png",v="/VueDoc/assets/l-20231221154305694-By0QiYDX.png",m="/VueDoc/assets/l-20231221154335517-DV6b6lxY.png",k="/VueDoc/assets/l-20231221154348695-CAGU-_IH.png",g="/VueDoc/assets/l-20231221154348764-Cd7JmdrV.png",b="/VueDoc/assets/l-20231221154408761-DLyAcMRm.png",h="/VueDoc/assets/l-20231221154408728-BuwgORLM.png",S="/VueDoc/assets/l-20231221154445746-DI0k4xey.png",f="/VueDoc/assets/l-20231221154445845-CWFLLe2i.png",x="/VueDoc/assets/l-20231221154501285-Dt1VHgjy.png",w={},C={class:"hint-container details"},q=n("summary",null,"ç›®å½•",-1),y={class:"table-of-contents"},M=n("ol",null,[n("li",null,"Servlet è§„èŒƒå®šä¹‰äº†å‡ ç§æ ‡å‡†ç»„ä»¶ï¼šServletã€JSPã€Filter å’Œ Listenerï¼›"),n("li",null,"Servlet çš„æ ‡å‡†ç»„ä»¶æ€»æ˜¯è¿è¡Œåœ¨ Servlet å®¹å™¨ä¸­ï¼Œå¦‚ Tomcatã€Jettyã€WebLogic ç­‰ã€‚")],-1),_=n("p",null,"ç›´æ¥ä½¿ç”¨ Servlet è¿›è¡Œ Web å¼€å‘å¥½æ¯”ç›´æ¥åœ¨ JDBC ä¸Šæ“ä½œæ•°æ®åº“ï¼Œæ¯”è¾ƒç¹çï¼Œæ›´å¥½çš„æ–¹æ³•æ˜¯åœ¨ Servlet åŸºç¡€ä¸Šå°è£… MVC æ¡†æ¶ï¼ŒåŸºäº MVC å¼€å‘ Web åº”ç”¨ï¼Œå¤§éƒ¨åˆ†æ—¶å€™ï¼Œä¸éœ€è¦æ¥è§¦ Servlet APIï¼Œå¼€å‘çœæ—¶çœåŠ›ã€‚",-1),R={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1266264917931808",target:"_blank",rel:"noopener noreferrer"},A={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1337408645759009",target:"_blank",rel:"noopener noreferrer"},F=n("p",null,"å› æ­¤ï¼Œå¼€å‘ Web åº”ç”¨ï¼Œé¦–å…ˆè¦é€‰æ‹©ä¸€ä¸ªä¼˜ç§€çš„ MVC æ¡†æ¶ã€‚å¸¸ç”¨çš„ MVC æ¡†æ¶æœ‰ï¼š",-1),T={href:"https://struts.apache.org/",target:"_blank",rel:"noopener noreferrer"},H=n("li",null,"WebWorkï¼šä¸€ä¸ªæ¯” Struts è®¾è®¡æ›´ä¼˜ç§€çš„ MVC æ¡†æ¶ï¼Œä½†ä¸çŸ¥é“å‡ºäºä»€ä¹ˆåŸå› ï¼Œä» 2.0 å¼€å§‹æŠŠè‡ªå·±çš„ä»£ç å…¨éƒ¨å¡ç»™ Struts 2 äº†ï¼›",-1),V={href:"https://turbine.apache.org/",target:"_blank",rel:"noopener noreferrer"},L=n("li",null,"å…¶ä»– 100+MVC æ¡†æ¶â€¦â€¦ï¼ˆç•¥ï¼‰",-1),W={href:"https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html",target:"_blank",rel:"noopener noreferrer"},j=n("p",null,"æœ¬ç« æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»å¦‚ä½•åŸºäº Spring MVC å¼€å‘ Web åº”ç”¨ã€‚",-1),I=n("h2",{id:"ğŸ€-ä½¿ç”¨-spring-mvc",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ğŸ€-ä½¿ç”¨-spring-mvc","aria-hidden":"true"},"#"),s(" ğŸ€ ä½¿ç”¨ Spring MVC")],-1),O={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1255945497738400",target:"_blank",rel:"noopener noreferrer"},P=n("ul",null,[n("li",null,"Servletï¼šèƒ½å¤„ç† HTTP è¯·æ±‚å¹¶å°† HTTP å“åº”è¿”å›ï¼›"),n("li",null,"JSPï¼šä¸€ç§åµŒå¥— Java ä»£ç çš„ HTMLï¼Œå°†è¢«ç¼–è¯‘ä¸º Servletï¼›"),n("li",null,"Filterï¼šèƒ½è¿‡æ»¤æŒ‡å®šçš„ URL ä»¥å®ç°æ‹¦æˆªåŠŸèƒ½ï¼›"),n("li",null,"Listenerï¼šç›‘å¬æŒ‡å®šçš„äº‹ä»¶ï¼Œå¦‚ ServletContextã€HttpSession çš„åˆ›å»ºå’Œé”€æ¯ã€‚")],-1),E=n("p",null,[s("æ­¤å¤–ï¼ŒServlet å®¹å™¨ä¸ºæ¯ä¸ª Web åº”ç”¨ç¨‹åºè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ "),n("code",null,"ServletContext"),s(" å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹å°±ä»£è¡¨äº† Web åº”ç”¨ç¨‹åºæœ¬èº«ã€‚")],-1),U={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1337408645759009",target:"_blank",rel:"noopener noreferrer"},B=l(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/signin&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">signin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯ï¼ŒSpring æä¾›çš„æ˜¯ä¸€ä¸ª IoC å®¹å™¨ï¼Œæ‰€æœ‰çš„ Beanï¼ŒåŒ…æ‹¬ Controllerï¼Œéƒ½åœ¨ Spring IoC å®¹å™¨ä¸­è¢«åˆå§‹åŒ–ï¼Œè€Œ Servlet å®¹å™¨ç”± JavaEE æœåŠ¡å™¨æä¾›ï¼ˆå¦‚ Tomcatï¼‰ï¼ŒServlet å®¹å™¨å¯¹ Spring ä¸€æ— æ‰€çŸ¥ï¼Œä»–ä»¬ä¹‹é—´åˆ°åº•ä¾é ä»€ä¹ˆè¿›è¡Œè”ç³»ï¼Œåˆæ˜¯ä»¥ä½•ç§é¡ºåºåˆå§‹åŒ–çš„ï¼Ÿ</p><p>åœ¨ç†è§£ä¸Šè¿°é—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŠŠåŸºäº Spring MVC å¼€å‘çš„é¡¹ç›®ç»“æ„æ­å»ºèµ·æ¥ã€‚é¦–å…ˆåˆ›å»ºåŸºäº Web çš„ Maven å·¥ç¨‹ï¼Œå¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š</p><ul><li>org.springframework:spring-context:6.0.0</li><li>org.springframework:spring-webmvc:6.0.0</li><li>org.springframework:spring-jdbc:6.0.0</li><li>jakarta.annotation:jakarta.annotation-api:2.1.1</li><li>io.pebbletemplates:pebble-spring6:3.2.0</li><li>ch.qos.logback:logback-core:1.4.4</li><li>ch.qos.logback:logback-classic:1.4.4</li><li>com.zaxxer:HikariCP:5.0.1</li><li>org.hsqldb:hsqldb:2.7.0</li></ul><p>ä»¥åŠ <code>provided</code> ä¾èµ–ï¼š</p><ul><li>org.apache.tomcat.embed:tomcat-embed-core:10.1.1</li><li>org.apache.tomcat.embed:tomcat-embed-jasper:10.1.1</li></ul><p>è¿™ä¸ªæ ‡å‡†çš„ Maven Web å·¥ç¨‹ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-ascii line-numbers-mode" data-ext="ascii"><pre class="language-ascii"><code>spring-web-mvc
â”œâ”€â”€ pom.xml
â””â”€â”€ src
    â””â”€â”€ main
        â”œâ”€â”€ java
        â”‚   â””â”€â”€ com
        â”‚       â””â”€â”€ itranswarp
        â”‚           â””â”€â”€ learnjava
        â”‚               â”œâ”€â”€ AppConfig.java
        â”‚               â”œâ”€â”€ DatabaseInitializer.java
        â”‚               â”œâ”€â”€ entity
        â”‚               â”‚   â””â”€â”€ User.java
        â”‚               â”œâ”€â”€ service
        â”‚               â”‚   â””â”€â”€ UserService.java
        â”‚               â””â”€â”€ web
        â”‚                   â””â”€â”€ UserController.java
        â”œâ”€â”€ resources
        â”‚   â”œâ”€â”€ jdbc.properties
        â”‚   â””â”€â”€ logback.xml
        â””â”€â”€ webapp
            â”œâ”€â”€ WEB-INF
            â”‚   â”œâ”€â”€ templates
            â”‚   â”‚   â”œâ”€â”€ _base.html
            â”‚   â”‚   â”œâ”€â”€ index.html
            â”‚   â”‚   â”œâ”€â”€ profile.html
            â”‚   â”‚   â”œâ”€â”€ register.html
            â”‚   â”‚   â””â”€â”€ signin.html
            â”‚   â””â”€â”€ web.xml
            â””â”€â”€ static
                â”œâ”€â”€ css
                â”‚   â””â”€â”€ bootstrap.css
                â””â”€â”€ js
                    â””â”€â”€ jquery.js
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ï¼Œ<code>src/main/webapp</code> æ˜¯æ ‡å‡† web ç›®å½•ï¼Œ<code>WEB-INF</code> å­˜æ”¾ <code>web.xml</code>ï¼Œç¼–è¯‘çš„ classï¼Œç¬¬ä¸‰æ–¹ jarï¼Œä»¥åŠä¸å…è®¸æµè§ˆå™¨ç›´æ¥è®¿é—®çš„ View æ¨¡ç‰ˆï¼Œ<code>static</code> ç›®å½•å­˜æ”¾æ‰€æœ‰é™æ€æ–‡ä»¶ã€‚</p><p>åœ¨ <code>src/main/resources</code> ç›®å½•ä¸­å­˜æ”¾çš„æ˜¯ Java ç¨‹åºè¯»å–çš„ classpath èµ„æºæ–‡ä»¶ï¼Œé™¤äº† JDBC çš„é…ç½®æ–‡ä»¶ <code>jdbc.properties</code> å¤–ï¼Œæˆ‘ä»¬åˆæ–°å¢äº†ä¸€ä¸ª <code>logback.xml</code>ï¼Œè¿™æ˜¯ Logback çš„é»˜è®¤æŸ¥æ‰¾çš„é…ç½®æ–‡ä»¶ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>STDOUT<span class="token punctuation">&quot;</span></span>
		<span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.PatternLayout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Pattern</span><span class="token punctuation">&gt;</span></span>%d{yyyy-MM-dd HH:mm:ss} %-5level %logger{36} - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Pattern</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.itranswarp.learnjava<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>info<span class="token punctuation">&quot;</span></span> <span class="token attr-name">additivity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>STDOUT<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>logger</span><span class="token punctuation">&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>STDOUT<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢ç»™å‡ºäº†ä¸€ä¸ªå†™å…¥åˆ°æ ‡å‡†è¾“å‡ºçš„ Logback é…ç½®ï¼Œå¯ä»¥åŸºäºä¸Šè¿°é…ç½®æ·»åŠ å†™å…¥åˆ°æ–‡ä»¶çš„é…ç½®ã€‚</p><p>åœ¨ <code>src/main/java</code> ä¸­å°±æ˜¯æˆ‘ä»¬ç¼–å†™çš„ Java ä»£ç äº†ã€‚</p><h3 id="é…ç½®-spring-mvc" tabindex="-1"><a class="header-anchor" href="#é…ç½®-spring-mvc" aria-hidden="true">#</a> é…ç½® Spring MVC</h3><p>å’Œæ™®é€š Spring é…ç½®ä¸€æ ·ï¼Œæˆ‘ä»¬ç¼–å†™æ­£å¸¸çš„ <code>AppConfig</code> åï¼Œåªéœ€åŠ ä¸Š <code>@EnableWebMvc</code> æ³¨è§£ï¼Œå°± â€œæ¿€æ´»â€ äº† Spring MVCï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span>
<span class="token annotation punctuation">@EnableWebMvc</span> <span class="token comment">// å¯ç”¨ Spring MVC</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:/jdbc.properties&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é™¤äº†åˆ›å»º <code>DataSource</code>ã€<code>JdbcTemplate</code>ã€<code>PlatformTransactionManager</code> å¤–ï¼Œ<code>AppConfig</code> éœ€è¦é¢å¤–åˆ›å»ºå‡ ä¸ªç”¨äº Spring MVC çš„ Beanï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token class-name">WebMvcConfigurer</span> <span class="token function">createWebMvcConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WebMvcConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addResourceHandlers</span><span class="token punctuation">(</span><span class="token class-name">ResourceHandlerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            registry<span class="token punctuation">.</span><span class="token function">addResourceHandler</span><span class="token punctuation">(</span><span class="token string">&quot;/static/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addResourceLocations</span><span class="token punctuation">(</span><span class="token string">&quot;/static/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>WebMvcConfigurer</code> å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æˆ‘ä»¬åœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ <code>WebMvcConfigurer</code>ï¼Œåªè¦†å†™ <code>addResourceHandlers()</code>ï¼Œç›®çš„æ˜¯è®© Spring MVC è‡ªåŠ¨å¤„ç†é™æ€æ–‡ä»¶ï¼Œå¹¶ä¸”æ˜ å°„è·¯å¾„ä¸º <code>/static/**</code>ã€‚</p><p>å¦ä¸€ä¸ªå¿…é¡»è¦åˆ›å»ºçš„ Bean æ˜¯ <code>ViewResolver</code>ï¼Œå› ä¸º Spring MVC å…è®¸é›†æˆä»»ä½•æ¨¡æ¿å¼•æ“ï¼Œä½¿ç”¨å“ªä¸ªæ¨¡æ¿å¼•æ“ï¼Œå°±å®ä¾‹åŒ–ä¸€ä¸ªå¯¹åº”çš„ <code>ViewResolver</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token class-name">ViewResolver</span> <span class="token function">createViewResolver</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> engine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PebbleEngine<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">autoEscaping</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token comment">// cache:</span>
            <span class="token punctuation">.</span><span class="token function">cacheActive</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token comment">// loader:</span>
            <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Servlet5Loader</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> viewResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PebbleViewResolver</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
    viewResolver<span class="token punctuation">.</span><span class="token function">setPrefix</span><span class="token punctuation">(</span><span class="token string">&quot;/WEB-INF/templates/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    viewResolver<span class="token punctuation">.</span><span class="token function">setSuffix</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> viewResolver<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ViewResolver</code> é€šè¿‡æŒ‡å®š <code>prefix</code> å’Œ <code>suffix</code> æ¥ç¡®å®šå¦‚ä½•æŸ¥æ‰¾ Viewã€‚ä¸Šè¿°é…ç½®ä½¿ç”¨ Pebble å¼•æ“ï¼ŒæŒ‡å®šæ¨¡æ¿æ–‡ä»¶å­˜æ”¾åœ¨ <code>/WEB-INF/templates/</code> ç›®å½•ä¸‹ã€‚</p><p>å‰©ä¸‹çš„ Bean éƒ½æ˜¯æ™®é€šçš„ <code>@Component</code>ï¼Œä½† Controller å¿…é¡»æ ‡è®°ä¸º <code>@Controller</code>ï¼Œä¾‹å¦‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// Controller ä½¿ç”¨ @Controller æ ‡è®°è€Œä¸æ˜¯ @Component:</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ­£å¸¸ä½¿ç”¨ @Autowired æ³¨å…¥:</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token comment">// å¤„ç†ä¸€ä¸ª URL æ˜ å°„:</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ˜¯æ™®é€šçš„ Java åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬é€šè¿‡ <code>main()</code> æ–¹æ³•å¯ä»¥å¾ˆç®€å•åœ°åˆ›å»ºä¸€ä¸ª Spring å®¹å™¨çš„å®ä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">AppConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œç°åœ¨æ˜¯ Web åº”ç”¨ç¨‹åºï¼Œè€Œ Web åº”ç”¨ç¨‹åºæ€»æ˜¯ç”± Servlet å®¹å™¨åˆ›å»ºï¼Œé‚£ä¹ˆï¼ŒSpring å®¹å™¨åº”è¯¥ç”±è°åˆ›å»ºï¼Ÿåœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼ŸSpring å®¹å™¨ä¸­çš„ Controller åˆæ˜¯å¦‚ä½•é€šè¿‡ Servlet è°ƒç”¨çš„ï¼Ÿ</p><p>åœ¨ Web åº”ç”¨ä¸­å¯åŠ¨ Spring å®¹å™¨æœ‰å¾ˆå¤šç§æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡ Listener å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Servlet å¯åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ XML é…ç½®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£é…ç½®ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬åªä»‹ç»ä¸€ç§ * æœ€ç®€å• * çš„å¯åŠ¨ Spring å®¹å™¨çš„æ–¹å¼ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨ <code>web.xml</code> ä¸­é…ç½® Spring MVC æä¾›çš„ <code>DispatcherServlet</code>ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>dispatcher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.servlet.DispatcherServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>contextClass<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>org.springframework.web.context.support.AnnotationConfigWebApplicationContext<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>contextConfigLocation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>com.itranswarp.learnjava.AppConfig<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load-on-startup</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>dispatcher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆå§‹åŒ–å‚æ•° <code>contextClass</code> æŒ‡å®šä½¿ç”¨æ³¨è§£é…ç½®çš„ <code>AnnotationConfigWebApplicationContext</code>ï¼Œé…ç½®æ–‡ä»¶çš„ä½ç½®å‚æ•° <code>contextConfigLocation</code> æŒ‡å‘ <code>AppConfig</code> çš„å®Œæ•´ç±»åï¼Œæœ€åï¼ŒæŠŠè¿™ä¸ª Servlet æ˜ å°„åˆ° <code>/*</code>ï¼Œå³å¤„ç†æ‰€æœ‰ URLã€‚</p><p>ä¸Šè¿°é…ç½®å¯ä»¥çœ‹ä½œä¸€ä¸ªæ ·æ¿é…ç½®ï¼Œæœ‰äº†è¿™ä¸ªé…ç½®ï¼ŒServlet å®¹å™¨ä¼šé¦–å…ˆåˆå§‹åŒ– Spring MVC çš„ <code>DispatcherServlet</code>ï¼Œåœ¨ <code>DispatcherServlet</code> å¯åŠ¨æ—¶ï¼Œå®ƒæ ¹æ®é…ç½® <code>AppConfig</code> åˆ›å»ºäº†ä¸€ä¸ªç±»å‹æ˜¯ <code>WebApplicationContext</code> çš„ IoC å®¹å™¨ï¼Œå®Œæˆæ‰€æœ‰ Bean çš„åˆå§‹åŒ–ï¼Œå¹¶å°†å®¹å™¨ç»‘åˆ° <code>ServletContext</code> ä¸Šã€‚</p><p>å› ä¸º <code>DispatcherServlet</code> æŒæœ‰ IoC å®¹å™¨ï¼Œèƒ½ä» IoC å®¹å™¨ä¸­è·å–æ‰€æœ‰ <code>@Controller</code> çš„ Beanï¼Œå› æ­¤ï¼Œ<code>DispatcherServlet</code> æ¥æ”¶åˆ°æ‰€æœ‰ HTTP è¯·æ±‚åï¼Œæ ¹æ® Controller æ–¹æ³•é…ç½®çš„è·¯å¾„ï¼Œå°±å¯ä»¥æ­£ç¡®åœ°æŠŠè¯·æ±‚è½¬å‘åˆ°æŒ‡å®šæ–¹æ³•ï¼Œå¹¶æ ¹æ®è¿”å›çš„ <code>ModelAndView</code> å†³å®šå¦‚ä½•æ¸²æŸ“é¡µé¢ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬åœ¨ <code>AppConfig</code> ä¸­é€šè¿‡ <code>main()</code> æ–¹æ³•å¯åŠ¨åµŒå…¥å¼ Tomcatï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Tomcat</span> tomcat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tomcat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tomcat<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tomcat<span class="token punctuation">.</span><span class="token function">getConnector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Context</span> ctx <span class="token operator">=</span> tomcat<span class="token punctuation">.</span><span class="token function">addWebapp</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;src/main/webapp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">WebResourceRoot</span> resources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardRoot</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    resources<span class="token punctuation">.</span><span class="token function">addPreResources</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">DirResourceSet</span><span class="token punctuation">(</span>resources<span class="token punctuation">,</span> <span class="token string">&quot;/WEB-INF/classes&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;target/classes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tomcat<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tomcat<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿° Web åº”ç”¨ç¨‹åºå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨ Spring MVC æ—¶çš„ä¸€ä¸ªæœ€å°å¯åŠ¨åŠŸèƒ½é›†ã€‚ç”±äºä½¿ç”¨äº† JDBC å’Œæ•°æ®åº“ï¼Œç”¨æˆ·çš„æ³¨å†Œã€ç™»å½•ä¿¡æ¯ä¼šè¢«æŒä¹…åŒ–ï¼š</p><figure><img src="`+u+`" alt="spring-mvc" tabindex="0" loading="lazy"><figcaption>spring-mvc</figcaption></figure><h3 id="ç¼–å†™-controller" tabindex="-1"><a class="header-anchor" href="#ç¼–å†™-controller" aria-hidden="true">#</a> ç¼–å†™ Controller</h3><p>æœ‰äº† Web åº”ç”¨ç¨‹åºçš„æœ€åŸºæœ¬çš„ç»“æ„ï¼Œæˆ‘ä»¬çš„é‡ç‚¹å°±å¯ä»¥æ”¾åœ¨å¦‚ä½•ç¼–å†™ Controller ä¸Šã€‚Spring MVC å¯¹ Controller æ²¡æœ‰å›ºå®šçš„è¦æ±‚ï¼Œä¹Ÿä¸éœ€è¦å®ç°ç‰¹å®šçš„æ¥å£ã€‚ä»¥ <code>UserController</code> ä¸ºä¾‹ï¼Œç¼–å†™ Controller åªéœ€è¦éµå¾ªä»¥ä¸‹è¦ç‚¹ï¼š</p><p>æ€»æ˜¯æ ‡è®° <code>@Controller</code> è€Œä¸æ˜¯ <code>@Component</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€ä¸ª HTTP è¯·æ±‚è·¯å¾„ï¼Œç”¨ <code>@GetMapping</code> æˆ– <code>@PostMapping</code> è¡¨ç¤º GET æˆ– POST è¯·æ±‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/signin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">doSignin</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> email<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span>
        <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éœ€è¦æ¥æ”¶çš„ HTTP å‚æ•°ä»¥ <code>@RequestParam()</code> æ ‡æ³¨ï¼Œå¯ä»¥è®¾ç½®é»˜è®¤å€¼ã€‚å¦‚æœæ–¹æ³•å‚æ•°éœ€è¦ä¼ å…¥ <code>HttpServletRequest</code>ã€<code>HttpServletResponse</code> æˆ–è€… <code>HttpSession</code>ï¼Œç›´æ¥æ·»åŠ è¿™ä¸ªç±»å‹çš„å‚æ•°å³å¯ï¼ŒSpring MVC ä¼šè‡ªåŠ¨æŒ‰ç±»å‹ä¼ å…¥ã€‚</p><p>è¿”å›çš„ ModelAndView é€šå¸¸åŒ…å« View çš„è·¯å¾„å’Œä¸€ä¸ª Map ä½œä¸º Modelï¼Œä½†ä¹Ÿå¯ä»¥æ²¡æœ‰ Modelï¼Œä¾‹å¦‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token string">&quot;signin.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä»… Viewï¼Œæ²¡æœ‰ Model</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿”å›é‡å®šå‘æ—¶æ—¢å¯ä»¥å†™ <code>new ModelAndView(&quot;redirect:/signin&quot;)</code>ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿”å› Stringï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:/signin&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:/profile&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœåœ¨æ–¹æ³•å†…éƒ¨ç›´æ¥æ“ä½œ <code>HttpServletResponse</code> å‘é€å“åº”ï¼Œè¿”å› <code>null</code> è¡¨ç¤ºæ— éœ€è¿›ä¸€æ­¥å¤„ç†ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">download</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/octet-stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OutputStream</span> output <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    output<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    output<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹ URL è¿›è¡Œåˆ†ç»„ï¼Œæ¯ç»„å¯¹åº”ä¸€ä¸ª Controller æ˜¯ä¸€ç§å¾ˆå¥½çš„ç»„ç»‡å½¢å¼ï¼Œå¹¶å¯ä»¥åœ¨ Controller çš„ class å®šä¹‰å‡ºæ·»åŠ  URL å‰ç¼€ï¼Œä¾‹å¦‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ³¨æ„å®é™… URL æ˜ å°„æ˜¯ / user/profile</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/profile&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ³¨æ„å®é™… URL æ˜ å°„æ˜¯ / user/changePassword</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/changePassword&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">changePassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®é™…æ–¹æ³•çš„ URL æ˜ å°„æ€»æ˜¯å‰ç¼€ + è·¯å¾„ï¼Œè¿™ç§å½¢å¼è¿˜å¯ä»¥æœ‰æ•ˆé¿å…ä¸å°å¿ƒå¯¼è‡´çš„é‡å¤çš„ URL æ˜ å°„ã€‚</p><p>å¯è§ï¼ŒSpring MVC å…è®¸æˆ‘ä»¬ç¼–å†™æ—¢ç®€å•åˆçµæ´»çš„ Controller å®ç°ã€‚</p><h3 id="ç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ " aria-hidden="true">#</a> ç»ƒä¹ </h3><p>åœ¨æ³¨å†Œã€ç™»å½•ç­‰åŠŸèƒ½çš„åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªä¿®æ”¹å£ä»¤çš„é¡µé¢ã€‚</p><h3 id="å°ç»“" tabindex="-1"><a class="header-anchor" href="#å°ç»“" aria-hidden="true">#</a> å°ç»“</h3><p>ä½¿ç”¨ Spring MVC æ—¶ï¼Œæ•´ä¸ª Web åº”ç”¨ç¨‹åºæŒ‰å¦‚ä¸‹é¡ºåºå¯åŠ¨ï¼š</p><ol><li>å¯åŠ¨ Tomcat æœåŠ¡å™¨ï¼›</li><li>Tomcat è¯»å– <code>web.xml</code> å¹¶åˆå§‹åŒ– <code>DispatcherServlet</code>ï¼›</li><li><code>DispatcherServlet</code> åˆ›å»º IoC å®¹å™¨å¹¶è‡ªåŠ¨æ³¨å†Œåˆ° <code>ServletContext</code> ä¸­ã€‚</li></ol><p>å¯åŠ¨åï¼Œæµè§ˆå™¨å‘å‡ºçš„ HTTP è¯·æ±‚å…¨éƒ¨ç”± <code>DispatcherServlet</code> æ¥æ”¶ï¼Œå¹¶æ ¹æ®é…ç½®è½¬å‘åˆ°æŒ‡å®š Controller çš„æŒ‡å®šæ–¹æ³•å¤„ç†ã€‚</p><h2 id="ğŸ€-ä½¿ç”¨-rest" tabindex="-1"><a class="header-anchor" href="#ğŸ€-ä½¿ç”¨-rest" aria-hidden="true">#</a> ğŸ€ ä½¿ç”¨ REST</h2><p>ä½¿ç”¨ Spring MVC å¼€å‘ Web åº”ç”¨ç¨‹åºçš„ä¸»è¦å·¥ä½œå°±æ˜¯ç¼–å†™ Controller é€»è¾‘ã€‚åœ¨ Web åº”ç”¨ä¸­ï¼Œé™¤äº†éœ€è¦ä½¿ç”¨ MVC ç»™ç”¨æˆ·æ˜¾ç¤ºé¡µé¢å¤–ï¼Œè¿˜æœ‰ä¸€ç±» API æ¥å£ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º RESTï¼Œé€šå¸¸è¾“å…¥è¾“å‡ºéƒ½æ˜¯ JSONï¼Œä¾¿äºç¬¬ä¸‰æ–¹è°ƒç”¨æˆ–è€…ä½¿ç”¨é¡µé¢ JavaScript ä¸ä¹‹äº¤äº’ã€‚</p><p>ç›´æ¥åœ¨ Controller ä¸­å¤„ç† JSON æ˜¯å¯ä»¥çš„ï¼Œå› ä¸º Spring MVC çš„ <code>@GetMapping</code> å’Œ <code>@PostMapping</code> éƒ½æ”¯æŒæŒ‡å®šè¾“å…¥å’Œè¾“å‡ºçš„æ ¼å¼ã€‚å¦‚æœæˆ‘ä»¬æƒ³æ¥æ”¶ JSONï¼Œè¾“å‡º JSONï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·å†™ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/rest&quot;</span><span class="token punctuation">,</span>
             consumes <span class="token operator">=</span> <span class="token string">&quot;application/json;charset=UTF-8&quot;</span><span class="token punctuation">,</span>
             produces <span class="token operator">=</span> <span class="token string">&quot;application/json;charset=UTF-8&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">rest</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;{\\&quot;restSupport\\&quot;:true}&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹åº”çš„ Maven å·¥ç¨‹éœ€è¦åŠ å…¥ Jackson è¿™ä¸ªä¾èµ–ï¼š<code>com.fasterxml.jackson.core:jackson-databind:2.14.0</code></p><p>æ³¨æ„åˆ° <code>@PostMapping</code> ä½¿ç”¨ <code>consumes</code> å£°æ˜èƒ½æ¥æ”¶çš„ç±»å‹ï¼Œä½¿ç”¨ <code>produces</code> å£°æ˜è¾“å‡ºçš„ç±»å‹ï¼Œå¹¶ä¸”é¢å¤–åŠ äº† <code>@ResponseBody</code> è¡¨ç¤ºè¿”å›çš„ <code>String</code> æ— éœ€é¢å¤–å¤„ç†ï¼Œç›´æ¥ä½œä¸ºè¾“å‡ºå†…å®¹å†™å…¥ <code>HttpServletResponse</code>ã€‚è¾“å…¥çš„ JSON åˆ™æ ¹æ®æ³¨è§£ <code>@RequestBody</code> ç›´æ¥è¢« Spring ååºåˆ—åŒ–ä¸º <code>User</code> è¿™ä¸ª JavaBeanã€‚</p><p>ä½¿ç”¨ curl å‘½ä»¤æµ‹è¯•ä¸€ä¸‹ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-H</span> <span class="token string">&quot;Content-Type: application/json&quot;</span> <span class="token parameter variable">-d</span> <span class="token string">&#39;{&quot;email&quot;:&quot;bob@example.com&quot;}&#39;</span> http://localhost:8080/rest
<span class="token operator">&gt;</span> POST /rest HTTP/1.1
<span class="token operator">&gt;</span> Host: localhost:8080
<span class="token operator">&gt;</span> User-Agent: curl/7.64.1
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Content-Type: application/json
<span class="token operator">&gt;</span> Content-Length: <span class="token number">27</span>
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span>
<span class="token operator">&lt;</span> Content-Type: application/json<span class="token punctuation">;</span><span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token operator">&lt;</span> Content-Length: <span class="token number">20</span>
<span class="token operator">&lt;</span> Date: Sun, <span class="token number">10</span> May <span class="token number">2020</span> 09:56:01 GMT
<span class="token operator">&lt;</span>
<span class="token punctuation">{</span><span class="token string">&quot;restSupport&quot;</span>:true<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¾“å‡ºæ­£æ˜¯æˆ‘ä»¬å†™å…¥çš„å­—ç¬¦ä¸²ã€‚</p><p>ç›´æ¥ç”¨ Spring çš„ Controller é…åˆä¸€å¤§å †æ³¨è§£å†™ REST å¤ªéº»çƒ¦äº†ï¼Œå› æ­¤ï¼ŒSpring è¿˜é¢å¤–æä¾›äº†ä¸€ä¸ª <code>@RestController</code> æ³¨è§£ï¼Œä½¿ç”¨ <code>@RestController</code> æ›¿ä»£ <code>@Controller</code> åï¼Œæ¯ä¸ªæ–¹æ³•è‡ªåŠ¨å˜æˆ API æ¥å£æ–¹æ³•ã€‚æˆ‘ä»¬è¿˜æ˜¯ä»¥å®é™…ä»£ç ä¸¾ä¾‹ï¼Œç¼–å†™ <code>ApiController</code> å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">users</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/users/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUserById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/signin&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">signin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SignInRequest</span> signinRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">signin</span><span class="token punctuation">(</span>signinRequest<span class="token punctuation">.</span>email<span class="token punctuation">,</span> signinRequest<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;SIGNIN_FAILED&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SignInRequest</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¼–å†™ REST æ¥å£åªéœ€è¦å®šä¹‰ <code>@RestController</code>ï¼Œç„¶åï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æ˜¯ä¸€ä¸ª API æ¥å£ï¼Œè¾“å…¥å’Œè¾“å‡ºåªè¦èƒ½è¢« Jackson åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ä¸º JSON å°±æ²¡æœ‰é—®é¢˜ã€‚æˆ‘ä»¬ç”¨æµè§ˆå™¨æµ‹è¯• GET è¯·æ±‚ï¼Œå¯ç›´æ¥æ˜¾ç¤º JSON å“åº”ï¼š</p><figure><img src="`+v+`" alt="user-api" tabindex="0" loading="lazy"><figcaption>user-api</figcaption></figure><p>è¦æµ‹è¯• POST è¯·æ±‚ï¼Œå¯ä»¥ç”¨ curl å‘½ä»¤ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-H</span> <span class="token string">&quot;Content-Type: application/json&quot;</span> <span class="token parameter variable">-d</span> <span class="token string">&#39;{&quot;email&quot;:&quot;bob@example.com&quot;,&quot;password&quot;:&quot;bob123&quot;}&#39;</span> http://localhost:8080/api/signin
<span class="token operator">&gt;</span> POST /api/signin HTTP/1.1
<span class="token operator">&gt;</span> Host: localhost:8080
<span class="token operator">&gt;</span> User-Agent: curl/7.64.1
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Content-Type: application/json
<span class="token operator">&gt;</span> Content-Length: <span class="token number">47</span>
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span>
<span class="token operator">&lt;</span> Content-Type: application/json
<span class="token operator">&lt;</span> Transfer-Encoding: chunked
<span class="token operator">&lt;</span> Date: Sun, <span class="token number">10</span> May <span class="token number">2020</span> 08:14:13 GMT
<span class="token operator">&lt;</span>
<span class="token punctuation">{</span><span class="token string">&quot;user&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;email&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;bob@example.com&quot;</span>,<span class="token string">&quot;password&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;bob123&quot;</span>,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Bob&quot;</span>,<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„è§‚å¯Ÿä¸Šè¿° JSON çš„è¾“å‡ºï¼Œ<code>User</code> èƒ½è¢«æ­£ç¡®åœ°åºåˆ—åŒ–ä¸º JSONï¼Œä½†æš´éœ²äº† <code>password</code> å±æ€§ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸æœŸæœ›çš„ã€‚è¦é¿å…è¾“å‡º <code>password</code> å±æ€§ï¼Œå¯ä»¥æŠŠ <code>User</code> å¤åˆ¶åˆ°å¦ä¸€ä¸ª <code>UserBean</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åªæŒæœ‰å¿…è¦çš„å±æ€§ï¼Œä½†è¿™æ ·åšæ¯”è¾ƒç¹çã€‚å¦ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ç›´æ¥åœ¨ <code>User</code> çš„ <code>password</code> å±æ€§å®šä¹‰å¤„åŠ ä¸Š <code>@JsonIgnore</code> è¡¨ç¤ºå®Œå…¨å¿½ç•¥è¯¥å±æ€§ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœå†™ä¸€ä¸ª <code>register(User user)</code> æ–¹æ³•ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•çš„ User å¯¹è±¡ä¹Ÿæ‹¿ä¸åˆ°æ³¨å†Œæ—¶ç”¨æˆ·ä¼ å…¥çš„å¯†ç äº†ã€‚å¦‚æœè¦å…è®¸è¾“å…¥ <code>password</code>ï¼Œä½†ä¸å…è®¸è¾“å‡º <code>password</code>ï¼Œå³åœ¨ JSON åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ï¼Œå…è®¸å†™å±æ€§ï¼Œç¦ç”¨è¯»å±æ€§ï¼Œå¯ä»¥æ›´ç²¾ç»†åœ°æ§åˆ¶å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span>access <span class="token operator">=</span> <span class="token class-name">Access</span><span class="token punctuation">.</span><span class="token constant">WRITE_ONLY</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŒæ ·çš„ï¼Œå¯ä»¥ä½¿ç”¨ <code>@JsonProperty(access = Access.READ_ONLY)</code> å…è®¸è¾“å‡ºï¼Œä¸å…è®¸è¾“å…¥ã€‚</p><h3 id="ç»ƒä¹ -1" tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ -1" aria-hidden="true">#</a> ç»ƒä¹ </h3><h3 id="å°ç»“-1" tabindex="-1"><a class="header-anchor" href="#å°ç»“-1" aria-hidden="true">#</a> å°ç»“</h3><p>ä½¿ç”¨ <code>@RestController</code> å¯ä»¥æ–¹ä¾¿åœ°ç¼–å†™ REST æœåŠ¡ï¼ŒSpring é»˜è®¤ä½¿ç”¨ JSON ä½œä¸ºè¾“å…¥å’Œè¾“å‡ºã€‚</p><p>è¦æ§åˆ¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ Jackson æä¾›çš„ <code>@JsonIgnore</code> å’Œ <code>@JsonProperty</code> æ³¨è§£ã€‚</p><h2 id="ğŸ€-é›†æˆ-filter" tabindex="-1"><a class="header-anchor" href="#ğŸ€-é›†æˆ-filter" aria-hidden="true">#</a> ğŸ€ é›†æˆ Filter</h2><p>åœ¨ Spring MVC ä¸­ï¼Œ<code>DispatcherServlet</code> åªéœ€è¦å›ºå®šé…ç½®åˆ° <code>web.xml</code> ä¸­ï¼Œå‰©ä¸‹çš„å·¥ä½œä¸»è¦æ˜¯ä¸“æ³¨äºç¼–å†™ Controllerã€‚</p>`,86),D={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1266264823560128",target:"_blank",rel:"noopener noreferrer"},J=n("code",null,"Filter",-1),N=l(`<p>æœ‰çš„ç«¥é‹åœ¨ä¸Šä¸€èŠ‚çš„ Web åº”ç”¨ä¸­å¯èƒ½å‘ç°äº†ï¼Œå¦‚æœæ³¨å†Œæ—¶è¾“å…¥ä¸­æ–‡ä¼šå¯¼è‡´ä¹±ç ï¼Œå› ä¸º Servlet é»˜è®¤æŒ‰é UTF-8 ç¼–ç è¯»å–å‚æ•°ã€‚ä¸ºäº†ä¿®å¤è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä½¿ç”¨ä¸€ä¸ª EncodingFilterï¼Œåœ¨å…¨å±€èŒƒå›´ç±»ç»™ <code>HttpServletRequest</code> å’Œ <code>HttpServletResponse</code> å¼ºåˆ¶è®¾ç½®ä¸º UTF-8 ç¼–ç ã€‚</p><p>å¯ä»¥è‡ªå·±ç¼–å†™ä¸€ä¸ª EncodingFilterï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ Spring MVC è‡ªå¸¦çš„ä¸€ä¸ª <code>CharacterEncodingFilter</code>ã€‚é…ç½® Filter æ—¶ï¼Œåªéœ€åœ¨ <code>web.xml</code> ä¸­å£°æ˜å³å¯ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>encodingFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.filter.CharacterEncodingFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>encoding<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>forceEncoding<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>encodingFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› ä¸ºè¿™ç§ Filter å’Œæˆ‘ä»¬ä¸šåŠ¡å…³ç³»ä¸å¤§ï¼Œæ³¨æ„åˆ° <code>CharacterEncodingFilter</code> å…¶å®å’Œ Spring çš„ IoC å®¹å™¨æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸¤è€…å‡äº’ä¸çŸ¥æ™“å¯¹æ–¹çš„å­˜åœ¨ï¼Œå› æ­¤ï¼Œé…ç½®è¿™ç§ Filter ååˆ†ç®€å•ã€‚</p><p>æˆ‘ä»¬å†è€ƒè™‘è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœå…è®¸ç”¨æˆ·ä½¿ç”¨ Basic æ¨¡å¼è¿›è¡Œç”¨æˆ·éªŒè¯ï¼Œå³åœ¨ HTTP è¯·æ±‚ä¸­æ·»åŠ å¤´ <code>Authorization: Basic email:password</code>ï¼Œè¿™ä¸ªéœ€æ±‚å¦‚ä½•å®ç°ï¼Ÿ</p><p>ç¼–å†™ä¸€ä¸ª <code>AuthFilter</code> æ˜¯æœ€ç®€å•çš„å®ç°æ–¹å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
        <span class="token comment">// è·å– Authorization å¤´:</span>
        <span class="token class-name">String</span> authHeader <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>authHeader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> authHeader<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;Basic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä» Header ä¸­æå– email å’Œ password:</span>
            <span class="token class-name">String</span> email <span class="token operator">=</span> <span class="token function">prefixFrom</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token function">suffixFrom</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç™»å½•:</span>
            <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">signin</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ”¾å…¥ Session:</span>
            req<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">UserController</span><span class="token punctuation">.</span><span class="token constant">KEY_USER</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ç»§ç»­å¤„ç†è¯·æ±‚:</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨é—®é¢˜æ¥äº†ï¼šåœ¨ Spring ä¸­åˆ›å»ºçš„è¿™ä¸ª <code>AuthFilter</code> æ˜¯ä¸€ä¸ªæ™®é€š Beanï¼ŒServlet å®¹å™¨å¹¶ä¸çŸ¥é“ï¼Œæ‰€ä»¥å®ƒä¸ä¼šèµ·ä½œç”¨ã€‚</p><p>å¦‚æœæˆ‘ä»¬ç›´æ¥åœ¨ <code>web.xml</code> ä¸­å£°æ˜è¿™ä¸ª <code>AuthFilter</code>ï¼Œæ³¨æ„åˆ° <code>AuthFilter</code> çš„å®ä¾‹å°†ç”± Servlet å®¹å™¨è€Œä¸æ˜¯ Spring å®¹å™¨åˆå§‹åŒ–ï¼Œå› æ­¤ï¼Œ<code>@Autowire</code> æ ¹æœ¬ä¸ç”Ÿæ•ˆï¼Œç”¨äºç™»å½•çš„ <code>UserService</code> æˆå‘˜å˜é‡æ°¸è¿œæ˜¯ <code>null</code>ã€‚</p><p>æ‰€ä»¥ï¼Œå¾—é€šè¿‡ä¸€ç§æ–¹å¼ï¼Œè®© Servlet å®¹å™¨å®ä¾‹åŒ–çš„ Filterï¼Œé—´æ¥å¼•ç”¨ Spring å®¹å™¨å®ä¾‹åŒ–çš„ <code>AuthFilter</code>ã€‚Spring MVC æä¾›äº†ä¸€ä¸ª <code>DelegatingFilterProxy</code>ï¼Œä¸“é—¨æ¥å¹²è¿™ä¸ªäº‹æƒ…ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>authFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.filter.DelegatingFilterProxy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>authFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬æ¥çœ‹å®ç°åŸç†ï¼š</p><ol><li>Servlet å®¹å™¨ä» <code>web.xml</code> ä¸­è¯»å–é…ç½®ï¼Œå®ä¾‹åŒ– <code>DelegatingFilterProxy</code>ï¼Œæ³¨æ„å‘½åæ˜¯ <code>authFilter</code>ï¼›</li><li>Spring å®¹å™¨é€šè¿‡æ‰«æ <code>@Component</code> å®ä¾‹åŒ– <code>AuthFilter</code>ã€‚</li></ol><p>å½“ <code>DelegatingFilterProxy</code> ç”Ÿæ•ˆåï¼Œå®ƒä¼šè‡ªåŠ¨æŸ¥æ‰¾æ³¨å†Œåœ¨ <code>ServletContext</code> ä¸Šçš„ Spring å®¹å™¨ï¼Œå†è¯•å›¾ä»å®¹å™¨ä¸­æŸ¥æ‰¾åä¸º <code>authFilter</code> çš„ Beanï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç”¨ <code>@Component</code> å£°æ˜çš„ <code>AuthFilter</code>ã€‚</p><p><code>DelegatingFilterProxy</code> å°†è¯·æ±‚ä»£ç†ç»™ <code>AuthFilter</code>ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelegatingFilterProxy</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Filter</span> delegate<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            delegate <span class="token operator">=</span> <span class="token function">findBeanFromSpringContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        delegate<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16),z={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017",target:"_blank",rel:"noopener noreferrer"},G=l(`<div class="language-ascii line-numbers-mode" data-ext="ascii"><pre class="language-ascii"><code>â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â” â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚DelegatingFilterProxyâ”‚â”€â”‚â”€â”‚â”€ â”€&gt;â”‚AuthFilter â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  DispatcherServlet  â”‚â”€ â”€ â”€ â”€&gt;â”‚Controllersâ”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
â”‚    Servlet Container    â”‚ â”‚  Spring Container
 â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€   â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœåœ¨ <code>web.xml</code> ä¸­é…ç½®çš„ Filter åå­—å’Œ Spring å®¹å™¨çš„ Bean çš„åå­—ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆéœ€è¦æŒ‡å®š Bean çš„åå­—ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>basicAuthFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.filter.DelegatingFilterProxy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- æŒ‡å®š Bean çš„åå­— --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>targetBeanName<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>authFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®é™…åº”ç”¨æ—¶ï¼Œå°½é‡ä¿æŒåå­—ä¸€è‡´ï¼Œä»¥å‡å°‘ä¸å¿…è¦çš„é…ç½®ã€‚</p><p>è¦ä½¿ç”¨ Basic æ¨¡å¼çš„ç”¨æˆ·è®¤è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ curl å‘½ä»¤æµ‹è¯•ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·ç™»å½•åæ˜¯ <code>tom@example.com</code>ï¼Œå£ä»¤æ˜¯ <code>tomcat</code>ï¼Œé‚£ä¹ˆå…ˆæ„é€ ä¸€ä¸ªä½¿ç”¨ URL ç¼–ç çš„ <code>ç”¨æˆ·å: å£ä»¤</code> çš„å­—ç¬¦ä¸²ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>tom%40example.com:tomcat
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ï¼Œæœ€ç»ˆæ„é€ å‡ºçš„ Header å¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Authorization: Basic dG9tJTQwZXhhbXBsZS5jb206dG9tY2F0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä½¿ç”¨å¦‚ä¸‹çš„ <code>curl</code> å‘½ä»¤å¹¶è·å¾—å“åº”å¦‚ä¸‹ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-H</span> <span class="token string">&#39;Authorization: Basic dG9tJTQwZXhhbXBsZS5jb206dG9tY2F0&#39;</span> http://localhost:8080/profile
<span class="token operator">&gt;</span> GET /profile HTTP/1.1
<span class="token operator">&gt;</span> Host: localhost:8080
<span class="token operator">&gt;</span> User-Agent: curl/7.64.1
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Authorization: Basic dG9tJTQwZXhhbXBsZS5jb206dG9tY2F0
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span>
<span class="token operator">&lt;</span> Set-Cookie: <span class="token assign-left variable">JSESSIONID</span><span class="token operator">=</span>CE0F4BFC394816F717443397D4FEABBE<span class="token punctuation">;</span> <span class="token assign-left variable">Path</span><span class="token operator">=</span>/<span class="token punctuation">;</span> HttpOnly
<span class="token operator">&lt;</span> Content-Type: text/html<span class="token punctuation">;</span><span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8
<span class="token operator">&lt;</span> Content-Language: en-CN
<span class="token operator">&lt;</span> Transfer-Encoding: chunked
<span class="token operator">&lt;</span> Date: Wed, <span class="token number">29</span> Apr <span class="token number">2020</span> 00:15:50 GMT
<span class="token operator">&lt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>doctype html<span class="token operator">&gt;</span>
<span class="token punctuation">..</span>.HTML è¾“å‡º<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°å“åº”è¯´æ˜ <code>AuthFilter</code> å·²ç”Ÿæ•ˆã€‚</p><blockquote><p>æ³¨æ„ï¼šBasic è®¤è¯æ¨¡å¼å¹¶ä¸å®‰å…¨ï¼Œæœ¬èŠ‚åªç”¨æ¥ä½œä¸ºä½¿ç”¨ Filter çš„ç¤ºä¾‹ã€‚</p></blockquote><h3 id="ç»ƒä¹ -2" tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ -2" aria-hidden="true">#</a> ç»ƒä¹ </h3><h3 id="å°ç»“-2" tabindex="-1"><a class="header-anchor" href="#å°ç»“-2" aria-hidden="true">#</a> å°ç»“</h3><p>å½“ä¸€ä¸ª Filter ä½œä¸º Spring å®¹å™¨ç®¡ç†çš„ Bean å­˜åœ¨æ—¶ï¼Œå¯ä»¥é€šè¿‡ <code>DelegatingFilterProxy</code> é—´æ¥åœ°å¼•ç”¨å®ƒå¹¶ä½¿å…¶ç”Ÿæ•ˆã€‚</p><h2 id="ğŸ€-ä½¿ç”¨-interceptor" tabindex="-1"><a class="header-anchor" href="#ğŸ€-ä½¿ç”¨-interceptor" aria-hidden="true">#</a> ğŸ€ ä½¿ç”¨ Interceptor</h2><p>åœ¨ Web ç¨‹åºä¸­ï¼Œæ³¨æ„åˆ°ä½¿ç”¨ Filter çš„æ—¶å€™ï¼ŒFilter ç”± Servlet å®¹å™¨ç®¡ç†ï¼Œå®ƒåœ¨ Spring MVC çš„ Web åº”ç”¨ç¨‹åºä¸­ä½œç”¨èŒƒå›´å¦‚ä¸‹ï¼š</p><div class="language-ascii line-numbers-mode" data-ext="ascii"><pre class="language-ascii"><code>         â”‚   â–²
         â–¼   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”
       â”‚Filter1â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚   â–²
         â–¼   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”Œ â”€ â”€ â”€â”‚Filter2â”‚â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”
       â””â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚        â”‚   â–²                  â”‚
         â–¼   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
  â”‚DispatcherServletâ”‚&lt;â”€â”€â”€â”
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚      â”‚
   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚              â”‚ModelAndViewâ”‚â”‚
   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚                     â–²      â”‚
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”œâ”€â”€â”€&gt;â”‚Controller1â”‚â”€â”€â”€â”€â”¤      â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”‚                     â”‚      â”‚
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â””â”€â”€â”€&gt;â”‚Controller2â”‚â”€â”€â”€â”€â”˜      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šå›¾è™šçº¿æ¡†å°±æ˜¯ Filter2 çš„æ‹¦æˆªèŒƒå›´ï¼ŒFilter ç»„ä»¶å®é™…ä¸Šå¹¶ä¸çŸ¥é“åç»­å†…éƒ¨å¤„ç†æ˜¯é€šè¿‡ Spring MVC æä¾›çš„ <code>DispatcherServlet</code> è¿˜æ˜¯å…¶ä»– Servlet ç»„ä»¶ï¼Œå› ä¸º Filter æ˜¯ Servlet è§„èŒƒå®šä¹‰çš„æ ‡å‡†ç»„ä»¶ï¼Œå®ƒå¯ä»¥åº”ç”¨åœ¨ä»»ä½•åŸºäº Servlet çš„ç¨‹åºä¸­ã€‚</p><p>å¦‚æœåªåŸºäº Spring MVC å¼€å‘åº”ç”¨ç¨‹åºï¼Œè¿˜å¯ä»¥ä½¿ç”¨ Spring MVC æä¾›çš„ä¸€ç§åŠŸèƒ½ç±»ä¼¼ Filter çš„æ‹¦æˆªå™¨ï¼šInterceptorã€‚å’Œ Filter ç›¸æ¯”ï¼ŒInterceptor æ‹¦æˆªèŒƒå›´ä¸æ˜¯åç»­æ•´ä¸ªå¤„ç†æµç¨‹ï¼Œè€Œæ˜¯ä»…é’ˆå¯¹ Controller æ‹¦æˆªï¼š</p><div class="language-ascii line-numbers-mode" data-ext="ascii"><pre class="language-ascii"><code>       â”‚   â–²
       â–¼   â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”
     â”‚Filter1â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚   â–²
       â–¼   â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”
     â”‚Filter2â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚   â–²
       â–¼   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚DispatcherServletâ”‚&lt;â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
 â”‚ â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”¼ â”€ â”€ â”€ â”
 â”‚                     â”‚
 â”‚ â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
 â”‚              â”‚   Render   â”‚
 â”‚ â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
 â”‚                     â–²
 â”‚ â”‚                   â”‚       â”‚
 â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ â”‚            â”‚ModelAndViewâ”‚ â”‚
 â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â”‚ â”‚                   â–²       â”‚
 â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
 â”œâ”€â”¼â”€&gt;â”‚Controller1â”‚â”€â”€â”€â”€â”¤       â”‚
 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
 â”‚ â”‚                   â”‚       â”‚
 â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
 â””â”€â”¼â”€&gt;â”‚Controller2â”‚â”€â”€â”€â”€â”˜       â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šå›¾è™šçº¿æ¡†å°±æ˜¯ Interceptor çš„æ‹¦æˆªèŒƒå›´ï¼Œæ³¨æ„åˆ° Controller çš„å¤„ç†æ–¹æ³•ä¸€èˆ¬éƒ½ç±»ä¼¼è¿™æ ·ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Controller
public class Controller1 {
    @GetMapping(&quot;/path/to/hello&quot;)
    ModelAndView hello() {
        ...
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€ä»¥ï¼ŒInterceptor çš„æ‹¦æˆªèŒƒå›´å…¶å®å°±æ˜¯ Controller æ–¹æ³•ï¼Œå®ƒå®é™…ä¸Šå°±ç›¸å½“äºåŸºäº AOP çš„æ–¹æ³•æ‹¦æˆªã€‚å› ä¸º Interceptor åªæ‹¦æˆª Controller æ–¹æ³•ï¼Œæ‰€ä»¥è¦æ³¨æ„ï¼Œè¿”å› <code>ModelAndView</code> å¹¶æ¸²æŸ“åï¼Œåç»­å¤„ç†å°±è„±ç¦»äº† Interceptor çš„æ‹¦æˆªèŒƒå›´ã€‚</p><p>ä½¿ç”¨ Interceptor çš„å¥½å¤„æ˜¯ Interceptor æœ¬èº«æ˜¯ Spring ç®¡ç†çš„ Beanï¼Œå› æ­¤æ³¨å…¥ä»»æ„ Bean éƒ½éå¸¸ç®€å•ã€‚æ­¤å¤–ï¼Œå¯ä»¥åº”ç”¨å¤šä¸ª Interceptorï¼Œå¹¶é€šè¿‡ç®€å•çš„ <code>@Order</code> æŒ‡å®šé¡ºåºã€‚æˆ‘ä»¬å…ˆå†™ä¸€ä¸ª <code>LoggerInterceptor</code>ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Order(1)
@Component
public class LoggerInterceptor implements HandlerInterceptor {

    final Logger logger = LoggerFactory.getLogger(getClass());

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        logger.info(&quot;preHandle {}...&quot;, request.getRequestURI());
        if (request.getParameter(&quot;debug&quot;) != null) {
            PrintWriter pw = response.getWriter();
            pw.write(&quot;&lt;p&gt;DEBUG MODE&lt;/p&gt;&quot;);
            pw.flush();
            return false;
        }
        return true;
    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        logger.info(&quot;postHandle {}.&quot;, request.getRequestURI());
        if (modelAndView != null) {
            modelAndView.addObject(&quot;__time__&quot;, LocalDateTime.now());
        }
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        logger.info(&quot;afterCompletion {}: exception = {}&quot;, request.getRequestURI(), ex);
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€ä¸ª Interceptor å¿…é¡»å®ç° <code>HandlerInterceptor</code> æ¥å£ï¼Œå¯ä»¥é€‰æ‹©å®ç° <code>preHandle()</code>ã€<code>postHandle()</code> å’Œ <code>afterCompletion()</code> æ–¹æ³•ã€‚<code>preHandle()</code> æ˜¯ Controller æ–¹æ³•è°ƒç”¨å‰æ‰§è¡Œï¼Œ<code>postHandle()</code> æ˜¯ Controller æ–¹æ³•æ­£å¸¸è¿”å›åæ‰§è¡Œï¼Œè€Œ <code>afterCompletion()</code> æ— è®º Controller æ–¹æ³•æ˜¯å¦æŠ›å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼Œå‚æ•° <code>ex</code> å°±æ˜¯ Controller æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ï¼ˆæœªæŠ›å‡ºå¼‚å¸¸æ˜¯ <code>null</code>ï¼‰ã€‚</p><p>åœ¨ <code>preHandle()</code> ä¸­ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¤„ç†å“åº”ï¼Œç„¶åè¿”å› <code>false</code> è¡¨ç¤ºæ— éœ€è°ƒç”¨ Controller æ–¹æ³•ç»§ç»­å¤„ç†äº†ï¼Œé€šå¸¸åœ¨è®¤è¯æˆ–è€…å®‰å…¨æ£€æŸ¥å¤±è´¥æ—¶ç›´æ¥è¿”å›é”™è¯¯å“åº”ã€‚åœ¨ <code>postHandle()</code> ä¸­ï¼Œå› ä¸ºæ•è·äº† Controller æ–¹æ³•è¿”å›çš„ <code>ModelAndView</code>ï¼Œæ‰€ä»¥å¯ä»¥ç»§ç»­å¾€ <code>ModelAndView</code> é‡Œæ·»åŠ ä¸€äº›é€šç”¨æ•°æ®ï¼Œå¾ˆå¤šé¡µé¢éœ€è¦çš„å…¨å±€æ•°æ®å¦‚ Copyright ä¿¡æ¯ç­‰éƒ½å¯ä»¥æ”¾åˆ°è¿™é‡Œï¼Œæ— éœ€åœ¨æ¯ä¸ª Controller æ–¹æ³•ä¸­é‡å¤æ·»åŠ ã€‚</p><p>æˆ‘ä»¬å†ç»§ç»­æ·»åŠ ä¸€ä¸ª <code>AuthInterceptor</code>ï¼Œç”¨äºæ›¿ä»£ä¸Šä¸€èŠ‚ä½¿ç”¨ <code>AuthFilter</code> è¿›è¡Œ Basic è®¤è¯çš„åŠŸèƒ½ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Order(2)
@Component
public class AuthInterceptor implements HandlerInterceptor {

    final Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    UserService userService;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
            throws Exception {
        logger.info(&quot;pre authenticate {}...&quot;, request.getRequestURI());
        try {
            authenticateByHeader(request);
        } catch (RuntimeException e) {
            logger.warn(&quot;login by authorization header failed.&quot;, e);
        }
        return true;
    }

    private void authenticateByHeader(HttpServletRequest req) {
        String authHeader = req.getHeader(&quot;Authorization&quot;);
        if (authHeader != null &amp;&amp; authHeader.startsWith(&quot;Basic&quot;)) {
            logger.info(&quot;try authenticate by authorization header...&quot;);
            String up = new String(Base64.getDecoder().decode(authHeader.substring(6)), StandardCharsets.UTF_8);
            int pos = up.indexOf(&#39;:&#39;);
            if (pos&gt; 0) {
                String email = URLDecoder.decode(up.substring(0, pos), StandardCharsets.UTF_8);
                String password = URLDecoder.decode(up.substring(pos + 1), StandardCharsets.UTF_8);
                User user = userService.signin(email, password);
                req.getSession().setAttribute(UserController.KEY_USER, user);
                logger.info(&quot;user {} login by authorization header ok.&quot;, email);
            }
        }
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ª <code>AuthInterceptor</code> æ˜¯ç”± Spring å®¹å™¨ç›´æ¥ç®¡ç†çš„ï¼Œå› æ­¤æ³¨å…¥ <code>UserService</code> éå¸¸æ–¹ä¾¿ã€‚</p><p>æœ€åï¼Œè¦è®©æ‹¦æˆªå™¨ç”Ÿæ•ˆï¼Œæˆ‘ä»¬åœ¨ <code>WebMvcConfigurer</code> ä¸­æ³¨å†Œæ‰€æœ‰çš„ Interceptorï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Bean
WebMvcConfigurer createWebMvcConfigurer(@Autowired HandlerInterceptor[] interceptors) {
    return new WebMvcConfigurer() {
        public void addInterceptors(InterceptorRegistry registry) {
            for (var interceptor : interceptors) {
                registry.addInterceptor(interceptor);
            }
        }
        ...
    };
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ‹¦æˆªå™¨æ²¡æœ‰ç”Ÿæ•ˆï¼Œè¯·æ£€æŸ¥æ˜¯å¦å¿˜äº†åœ¨ WebMvcConfigurer ä¸­æ³¨å†Œã€‚</p><h3 id="å¤„ç†å¼‚å¸¸" tabindex="-1"><a class="header-anchor" href="#å¤„ç†å¼‚å¸¸" aria-hidden="true">#</a> å¤„ç†å¼‚å¸¸</h3><p>åœ¨ Controller ä¸­ï¼ŒSpring MVC è¿˜å…è®¸å®šä¹‰åŸºäº <code>@ExceptionHandler</code> æ³¨è§£çš„å¼‚å¸¸å¤„ç†æ–¹æ³•ã€‚æˆ‘ä»¬æ¥çœ‹å…·ä½“çš„ç¤ºä¾‹ä»£ç ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Controller
public class UserController {
    @ExceptionHandler(RuntimeException.class)
    public ModelAndView handleUnknowException(Exception ex) {
        return new ModelAndView(&quot;500.html&quot;, Map.of(&quot;error&quot;, ex.getClass().getSimpleName(), &quot;message&quot;, ex.getMessage()));
    }
    ...
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¼‚å¸¸å¤„ç†æ–¹æ³•æ²¡æœ‰å›ºå®šçš„æ–¹æ³•ç­¾åï¼Œå¯ä»¥ä¼ å…¥ <code>Exception</code>ã€<code>HttpServletRequest</code> ç­‰ï¼Œè¿”å›å€¼å¯ä»¥æ˜¯ <code>void</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯ <code>ModelAndView</code>ï¼Œä¸Šè¿°ä»£ç é€šè¿‡ <code>@ExceptionHandler(RuntimeException.class)</code> è¡¨ç¤ºå½“å‘ç”Ÿ <code>RuntimeException</code> çš„æ—¶å€™ï¼Œå°±è‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•å¤„ç†ã€‚</p><p>æ³¨æ„åˆ°æˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªæ–°çš„ <code>ModelAndView</code>ï¼Œè¿™æ ·åœ¨åº”ç”¨ç¨‹åºå†…éƒ¨å¦‚æœå‘ç”Ÿäº†é¢„æ–™ä¹‹å¤–çš„å¼‚å¸¸ï¼Œå¯ä»¥ç»™ç”¨æˆ·æ˜¾ç¤ºä¸€ä¸ªå‡ºé”™é¡µé¢ï¼Œè€Œä¸æ˜¯ç®€å•çš„ 500 Internal Server Error æˆ– 404 Not Foundã€‚ä¾‹å¦‚ B ç«™çš„é”™è¯¯é¡µï¼š</p><figure><img src="`+m+'" alt="500" tabindex="0" loading="lazy"><figcaption>500</figcaption></figure><p>å¯ä»¥ç¼–å†™å¤šä¸ªé”™è¯¯å¤„ç†æ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•é’ˆå¯¹ç‰¹å®šçš„å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œå¤„ç† <code>LoginException</code> ä½¿å¾—é¡µé¢å¯ä»¥è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µã€‚</p><p>ä½¿ç”¨ <code>ExceptionHandler</code> æ—¶ï¼Œè¦æ³¨æ„å®ƒä»…ä½œç”¨äºå½“å‰çš„ Controllerï¼Œå³ ControllerA ä¸­å®šä¹‰çš„ä¸€ä¸ª <code>ExceptionHandler</code> æ–¹æ³•å¯¹ ControllerB ä¸èµ·ä½œç”¨ã€‚å¦‚æœæˆ‘ä»¬æœ‰å¾ˆå¤š Controllerï¼Œæ¯ä¸ª Controller éƒ½éœ€è¦å¤„ç†ä¸€äº›é€šç”¨çš„å¼‚å¸¸ï¼Œä¾‹å¦‚ <code>LoginException</code>ï¼Œæ€è€ƒä¸€ä¸‹åº”è¯¥æ€ä¹ˆé¿å…é‡å¤ä»£ç ï¼Ÿ</p><h3 id="ç»ƒä¹ -3" tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ -3" aria-hidden="true">#</a> ç»ƒä¹ </h3><h3 id="å°ç»“-3" tabindex="-1"><a class="header-anchor" href="#å°ç»“-3" aria-hidden="true">#</a> å°ç»“</h3><p>Spring MVC æä¾›äº† Interceptor ç»„ä»¶æ¥æ‹¦æˆª Controller æ–¹æ³•ï¼Œä½¿ç”¨æ—¶è¦æ³¨æ„ Interceptor çš„ä½œç”¨èŒƒå›´ã€‚</p><h2 id="ğŸ€-å¤„ç†-cors" tabindex="-1"><a class="header-anchor" href="#ğŸ€-å¤„ç†-cors" aria-hidden="true">#</a> ğŸ€ å¤„ç† CORS</h2><p>åœ¨å¼€å‘ REST åº”ç”¨æ—¶ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæ˜¯é€šè¿‡é¡µé¢çš„ JavaScript å’Œåç«¯çš„ REST API äº¤äº’ã€‚</p><p>åœ¨ JavaScript ä¸ REST äº¤äº’çš„æ—¶å€™ï¼Œæœ‰å¾ˆå¤šå®‰å…¨é™åˆ¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨æŒ‰åŒæºç­–ç•¥æ”¾è¡Œ JavaScript è°ƒç”¨ APIï¼Œå³ï¼š</p><ul><li>å¦‚æœ A ç«™åœ¨åŸŸå <code>a.com</code> é¡µé¢çš„ JavaScript è°ƒç”¨ A ç«™è‡ªå·±çš„ API æ—¶ï¼Œæ²¡æœ‰é—®é¢˜ï¼›</li><li>å¦‚æœ A ç«™åœ¨åŸŸå <code>a.com</code> é¡µé¢çš„ JavaScript è°ƒç”¨ B ç«™ <code>b.com</code> çš„ API æ—¶ï¼Œå°†è¢«æµè§ˆå™¨æ‹’ç»è®¿é—®ï¼Œå› ä¸ºä¸æ»¡è¶³åŒæºç­–ç•¥ã€‚</li></ul><p>åŒæºè¦æ±‚åŸŸåè¦å®Œå…¨ç›¸åŒï¼ˆ<code>a.com</code> å’Œ <code>www.a.com</code> ä¸åŒï¼‰ï¼Œåè®®è¦ç›¸åŒï¼ˆ<code>http</code> å’Œ <code>https</code> ä¸åŒï¼‰ï¼Œç«¯å£è¦ç›¸åŒ ã€‚</p><p>é‚£ä¹ˆï¼Œåœ¨åŸŸå <code>a.com</code> é¡µé¢çš„ JavaScript è¦è°ƒç”¨ B ç«™ <code>b.com</code> çš„ API æ—¶ï¼Œè¿˜æœ‰æ²¡æœ‰åŠæ³•ï¼Ÿ</p><p>åŠæ³•æ˜¯æœ‰çš„ï¼Œé‚£å°±æ˜¯ CORSï¼Œå…¨ç§° Cross-Origin Resource Sharingï¼Œæ˜¯ HTML5 è§„èŒƒå®šä¹‰çš„å¦‚ä½•è·¨åŸŸè®¿é—®èµ„æºã€‚å¦‚æœ A ç«™çš„ JavaScript è®¿é—® B ç«™ API çš„æ—¶å€™ï¼ŒB ç«™èƒ½å¤Ÿè¿”å›å“åº”å¤´ <code>Access-Control-Allow-Origin: http://a.com</code>ï¼Œé‚£ä¹ˆï¼Œæµè§ˆå™¨å°±å…è®¸ A ç«™çš„ JavaScript è®¿é—® B ç«™çš„ APIã€‚</p><p>æ³¨æ„åˆ°è·¨åŸŸè®¿é—®èƒ½å¦æˆåŠŸï¼Œå–å†³äº B ç«™æ˜¯å¦æ„¿æ„ç»™ A ç«™è¿”å›ä¸€ä¸ªæ­£ç¡®çš„ <code>Access-Control-Allow-Origin</code> å“åº”å¤´ï¼Œæ‰€ä»¥å†³å®šæƒæ°¸è¿œåœ¨æä¾› API çš„æœåŠ¡æ–¹æ‰‹ä¸­ã€‚</p>',53),Y={href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS",target:"_blank",rel:"noopener noreferrer"},Z=l(`<p>ä½¿ç”¨ Spring çš„ <code>@RestController</code> å¼€å‘ REST åº”ç”¨æ—¶ï¼ŒåŒæ ·ä¼šé¢å¯¹è·¨åŸŸé—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬å…è®¸æŒ‡å®šçš„ç½‘ç«™é€šè¿‡é¡µé¢ JavaScript è®¿é—®è¿™äº› REST APIï¼Œå°±å¿…é¡»æ­£ç¡®åœ°è®¾ç½® CORSã€‚</p><p>æœ‰å¥½å‡ ç§æ–¹æ³•è®¾ç½® CORSï¼Œæˆ‘ä»¬æ¥ä¸€ä¸€ä»‹ç»ã€‚</p><h3 id="ä½¿ç”¨-crossorigin" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-crossorigin" aria-hidden="true">#</a> ä½¿ç”¨ @CrossOrigin</h3><p>ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ <code>@CrossOrigin</code> æ³¨è§£ï¼Œå¯ä»¥åœ¨ <code>@RestController</code> çš„ class çº§åˆ«æˆ–æ–¹æ³•çº§åˆ«å®šä¹‰ä¸€ä¸ª <code>@CrossOrigin</code>ï¼Œä¾‹å¦‚ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@CrossOrigin(origins = &quot;http://local.liaoxuefeng.com:8080&quot;)
@RestController
@RequestMapping(&quot;/api&quot;)
public class ApiController {
    ...
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°å®šä¹‰åœ¨ <code>ApiController</code> å¤„çš„ <code>@CrossOrigin</code> æŒ‡å®šäº†åªå…è®¸æ¥è‡ª <code>local.liaoxuefeng.com</code> è·¨åŸŸè®¿é—®ï¼Œå…è®¸å¤šä¸ªåŸŸè®¿é—®éœ€è¦å†™æˆæ•°ç»„å½¢å¼ï¼Œä¾‹å¦‚ <code>origins = {&quot;http://a.com&quot;, &quot;https://www.b.com&quot;})</code>ã€‚å¦‚æœè¦å…è®¸ä»»ä½•åŸŸè®¿é—®ï¼Œå†™æˆ <code>origins = &quot;*&quot;</code> å³å¯ã€‚</p><p>å¦‚æœæœ‰å¤šä¸ª REST Controller éƒ½éœ€è¦ä½¿ç”¨ CORSï¼Œé‚£ä¹ˆï¼Œæ¯ä¸ª Controller éƒ½å¿…é¡»æ ‡æ³¨ <code>@CrossOrigin</code> æ³¨è§£ã€‚</p><h3 id="ä½¿ç”¨-corsregistry" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-corsregistry" aria-hidden="true">#</a> ä½¿ç”¨ CorsRegistry</h3><p>ç¬¬äºŒç§æ–¹æ³•æ˜¯åœ¨ <code>WebMvcConfigurer</code> ä¸­å®šä¹‰ä¸€ä¸ªå…¨å±€ CORS é…ç½®ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Bean
WebMvcConfigurer createWebMvcConfigurer() {
    return new WebMvcConfigurer() {
        @Override
        public void addCorsMappings(CorsRegistry registry) {
            registry.addMapping(&quot;/api/**&quot;)
                    .allowedOrigins(&quot;http://local.liaoxuefeng.com:8080&quot;)
                    .allowedMethods(&quot;GET&quot;, &quot;POST&quot;)
                    .maxAge(3600);
            // å¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»– URL è§„åˆ™:
            // registry.addMapping(&quot;/rest/v2/**&quot;)...
        }
    };
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ç§æ–¹å¼å¯ä»¥åˆ›å»ºä¸€ä¸ªå…¨å±€ CORS é…ç½®ï¼Œå¦‚æœä»”ç»†åœ°è®¾è®¡ URL ç»“æ„ï¼Œé‚£ä¹ˆå¯ä»¥ä¸€ç›®äº†ç„¶åœ°çœ‹åˆ°å„ä¸ª URL çš„ CORS è§„åˆ™ï¼Œæ¨èä½¿ç”¨è¿™ç§æ–¹å¼é…ç½® CORSã€‚</p><h3 id="ä½¿ç”¨-corsfilter" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-corsfilter" aria-hidden="true">#</a> ä½¿ç”¨ CorsFilter</h3>`,12),X=n("code",null,"CorsFilter",-1),Q={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1282384114745378/",target:"_blank",rel:"noopener noreferrer"},$=n("code",null,"web.xml",-1),K=l(`<h3 id="æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•" aria-hidden="true">#</a> æµ‹è¯•</h3><p>å½“æˆ‘ä»¬é…ç½®å¥½ CORS åï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ä¸€ä¸‹è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆã€‚</p><p>æˆ‘ä»¬å…ˆç”¨ <code>http://localhost:8080</code> åœ¨ Chrome æµè§ˆå™¨ä¸­æ‰“å¼€é¦–é¡µï¼Œç„¶åæ‰“å¼€ Chrome çš„å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° Consoleï¼Œè¾“å…¥ä¸€ä¸ª JavaScript è¯­å¥æ¥è·¨åŸŸè®¿é—® APIï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$.getJSON(&quot;http://local.liaoxuefeng.com:8080/api/users&quot;, (data) =&gt; console.log(JSON.stringify(data)));
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¸Šè¿°æºç«™çš„åŸŸæ˜¯ <code>http://localhost:8080</code>ï¼Œè·¨åŸŸè®¿é—®çš„æ˜¯ <code>http://local.liaoxuefeng.com:8080</code>ï¼Œå› ä¸ºé…ç½®çš„ CORS ä¸å…è®¸ <code>localhost</code> è®¿é—®ï¼Œæ‰€ä»¥ä¸å‡ºæ„å¤–åœ°å¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼š</p><figure><img src="`+k+`" alt="cors-deny" tabindex="0" loading="lazy"><figcaption>cors-deny</figcaption></figure><p>æµè§ˆé¢˜æ‰“å°äº†é”™è¯¯åŸå› å°±æ˜¯ <code>been blocked by CORS policy</code>ã€‚</p><p>æˆ‘ä»¬å†ç”¨ <code>http://local.liaoxuefeng.com:8080</code> åœ¨ Chrome æµè§ˆå™¨ä¸­æ‰“å¼€é¦–é¡µï¼Œåœ¨ Console ä¸­æ‰§è¡Œ JavaScript è®¿é—® <code>localhost</code>ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$.getJSON(&quot;http://localhost:8080/api/users&quot;, (data) =&gt; console.log(JSON.stringify(data)));
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å› ä¸º CORS è§„åˆ™å…è®¸æ¥è‡ª <code>http://local.liaoxuefeng.com:8080</code> çš„è®¿é—®ï¼Œå› æ­¤è®¿é—®æˆåŠŸï¼Œæ‰“å°å‡º API çš„è¿”å›å€¼ï¼š</p><figure><img src="`+g+`" alt="cors-ok" tabindex="0" loading="lazy"><figcaption>cors-ok</figcaption></figure><h3 id="ç»ƒä¹ -4" tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ -4" aria-hidden="true">#</a> ç»ƒä¹ </h3><h3 id="å°ç»“-4" tabindex="-1"><a class="header-anchor" href="#å°ç»“-4" aria-hidden="true">#</a> å°ç»“</h3><p>CORS å¯ä»¥æ§åˆ¶æŒ‡å®šåŸŸçš„é¡µé¢ JavaScript èƒ½å¦è®¿é—® APIã€‚</p><h2 id="ğŸ€-å›½é™…åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸ€-å›½é™…åŒ–" aria-hidden="true">#</a> ğŸ€ å›½é™…åŒ–</h2><p>La</p><p>åœ¨å¼€å‘åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œç»å¸¸ä¼šé‡åˆ°æ”¯æŒå¤šè¯­è¨€çš„éœ€æ±‚ï¼Œè¿™ç§æ”¯æŒå¤šè¯­è¨€çš„åŠŸèƒ½ç§°ä¹‹ä¸ºå›½é™…åŒ–ï¼Œè‹±æ–‡æ˜¯ internationalizationï¼Œç¼©å†™ä¸º i18nï¼ˆå› ä¸ºé¦–å­—æ¯ i å’Œæœ«å­—æ¯ n ä¸­é—´æœ‰ 18 ä¸ªå­—æ¯ï¼‰ã€‚</p><p>è¿˜æœ‰é’ˆå¯¹ç‰¹å®šåœ°åŒºçš„æœ¬åœ°åŒ–åŠŸèƒ½ï¼Œè‹±æ–‡æ˜¯ localizationï¼Œç¼©å†™ä¸º L10nï¼Œæœ¬åœ°åŒ–æ˜¯æŒ‡æ ¹æ®åœ°åŒºè°ƒæ•´ç±»ä¼¼å§“åã€æ—¥æœŸçš„æ˜¾ç¤ºç­‰ã€‚</p><p>ä¹Ÿæœ‰æŠŠä¸Šé¢ä¸¤è€…åˆç§°ä¸ºå…¨çƒåŒ–ï¼Œè‹±æ–‡æ˜¯ globalizationï¼Œç¼©å†™ä¸º g11nã€‚</p><p>åœ¨ Java ä¸­ï¼Œæ”¯æŒå¤šè¯­è¨€å’Œæœ¬åœ°åŒ–æ˜¯é€šè¿‡ <code>MessageFormat</code> é…åˆ <code>Locale</code> å®ç°çš„ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// MessageFormat
import java.text.MessageFormat;
import java.util.Locale;

public class Time {
    public static void main(String[] args) {
        double price = 123.5;
        int number = 10;
        Object[] arguments = { price, number};
        MessageFormat mfUS = new MessageFormat(&quot;Pay {0,number,currency} for {1} books.&quot;, Locale.US);
        System.out.println(mfUS.format(arguments));
        MessageFormat mfZH = new MessageFormat(&quot;{1} æœ¬ä¹¦ä¸€å…± {0,number,currency}ã€‚&quot;, Locale.CHINA);
        System.out.println(mfZH.format(arguments));
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äº Web åº”ç”¨ç¨‹åºï¼Œè¦å®ç°å›½é™…åŒ–åŠŸèƒ½ï¼Œä¸»è¦æ˜¯æ¸²æŸ“ View çš„æ—¶å€™ï¼Œè¦æŠŠå„ç§è¯­è¨€çš„èµ„æºæ–‡ä»¶æå‡ºæ¥ï¼Œè¿™æ ·ï¼Œä¸åŒçš„ç”¨æˆ·è®¿é—®åŒä¸€ä¸ªé¡µé¢æ—¶ï¼Œæ˜¾ç¤ºçš„è¯­è¨€å°±æ˜¯ä¸åŒçš„ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨ Spring MVC åº”ç”¨ç¨‹åºä¸­å¦‚ä½•å®ç°å›½é™…åŒ–ã€‚</p><h3 id="è·å–-locale" tabindex="-1"><a class="header-anchor" href="#è·å–-locale" aria-hidden="true">#</a> è·å– Locale</h3><p>å®ç°å›½é™…åŒ–çš„ç¬¬ä¸€æ­¥æ˜¯è·å–åˆ°ç”¨æˆ·çš„ <code>Locale</code>ã€‚åœ¨ Web åº”ç”¨ç¨‹åºä¸­ï¼ŒHTTP è§„èŒƒè§„å®šäº†æµè§ˆå™¨ä¼šåœ¨è¯·æ±‚ä¸­æºå¸¦ <code>Accept-Language</code> å¤´ï¼Œç”¨æ¥æŒ‡ç¤ºç”¨æˆ·æµè§ˆå™¨è®¾å®šçš„è¯­è¨€é¡ºåºï¼Œå¦‚ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Accept-Language: zh-CN,zh;q=0.8,en;q=0.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¸Šè¿° HTTP è¯·æ±‚å¤´è¡¨ç¤ºä¼˜å…ˆé€‰æ‹©ç®€ä½“ä¸­æ–‡ï¼Œå…¶æ¬¡é€‰æ‹©ä¸­æ–‡ï¼Œæœ€åé€‰æ‹©è‹±æ–‡ã€‚<code>q</code> è¡¨ç¤ºæƒé‡ï¼Œè§£æåæˆ‘ä»¬å¯è·å¾—ä¸€ä¸ªæ ¹æ®ä¼˜å…ˆçº§æ’åºçš„è¯­è¨€åˆ—è¡¨ï¼ŒæŠŠå®ƒè½¬æ¢ä¸º Java çš„ <code>Locale</code>ï¼Œå³è·å¾—äº†ç”¨æˆ·çš„ <code>Locale</code>ã€‚å¤§å¤šæ•°æ¡†æ¶é€šå¸¸åªè¿”å›æƒé‡æœ€é«˜çš„ <code>Locale</code>ã€‚</p><p>Spring MVC é€šè¿‡ <code>LocaleResolver</code> æ¥è‡ªåŠ¨ä» <code>HttpServletRequest</code> ä¸­è·å– <code>Locale</code>ã€‚æœ‰å¤šç§ <code>LocaleResolver</code> çš„å®ç°ç±»ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„æ˜¯ <code>CookieLocaleResolver</code>ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Primary
@Bean
LocaleResolver createLocaleResolver() {
    var clr = new CookieLocaleResolver();
    clr.setDefaultLocale(Locale.ENGLISH);
    clr.setDefaultTimeZone(TimeZone.getDefault());
    return clr;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>CookieLocaleResolver</code> ä» <code>HttpServletRequest</code> ä¸­è·å– <code>Locale</code> æ—¶ï¼Œé¦–å…ˆæ ¹æ®ä¸€ä¸ªç‰¹å®šçš„ Cookie åˆ¤æ–­æ˜¯å¦æŒ‡å®šäº† <code>Locale</code>ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä» HTTP å¤´è·å–ï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œå°±è¿”å›é»˜è®¤çš„ <code>Locale</code>ã€‚</p><p>å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç½‘ç«™æ—¶ï¼Œ<code>CookieLocaleResolver</code> åªèƒ½ä» HTTP å¤´è·å– <code>Locale</code>ï¼Œå³ä½¿ç”¨æµè§ˆå™¨çš„é»˜è®¤è¯­è¨€ã€‚é€šå¸¸ç½‘ç«™ä¹Ÿå…è®¸ç”¨æˆ·è‡ªå·±é€‰æ‹©è¯­è¨€ï¼Œæ­¤æ—¶ï¼Œ<code>CookieLocaleResolver</code> å°±ä¼šæŠŠç”¨æˆ·é€‰æ‹©çš„è¯­è¨€å­˜æ”¾åˆ° Cookie ä¸­ï¼Œä¸‹ä¸€æ¬¡è®¿é—®æ—¶ï¼Œå°±ä¼šè¿”å›ç”¨æˆ·ä¸Šæ¬¡é€‰æ‹©çš„è¯­è¨€è€Œä¸æ˜¯æµè§ˆå™¨é»˜è®¤è¯­è¨€ã€‚</p><h3 id="æå–èµ„æºæ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#æå–èµ„æºæ–‡ä»¶" aria-hidden="true">#</a> æå–èµ„æºæ–‡ä»¶</h3><p>ç¬¬äºŒæ­¥æ˜¯æŠŠå†™æ­»åœ¨æ¨¡æ¿ä¸­çš„å­—ç¬¦ä¸²ä»¥èµ„æºæ–‡ä»¶çš„æ–¹å¼å­˜å‚¨åœ¨å¤–éƒ¨ã€‚å¯¹äºå¤šè¯­è¨€ï¼Œä¸»æ–‡ä»¶åå¦‚æœå‘½åä¸º <code>messages</code>ï¼Œé‚£ä¹ˆèµ„æºæ–‡ä»¶å¿…é¡»æŒ‰å¦‚ä¸‹æ–¹å¼å‘½åå¹¶æ”¾å…¥ classpath ä¸­ï¼š</p><ul><li>é»˜è®¤è¯­è¨€ï¼Œæ–‡ä»¶åå¿…é¡»ä¸º <code>messages.properties</code>ï¼›</li><li>ç®€ä½“ä¸­æ–‡ï¼ŒLocale æ˜¯ <code>zh_CN</code>ï¼Œæ–‡ä»¶åå¿…é¡»ä¸º <code>messages_zh_CN.properties</code>ï¼›</li><li>æ—¥æ–‡ï¼ŒLocale æ˜¯ <code>ja_JP</code>ï¼Œæ–‡ä»¶åå¿…é¡»ä¸º <code>messages_ja_JP.properties</code>ï¼›</li><li>å…¶å®ƒæ›´å¤šè¯­è¨€â€¦â€¦</li></ul><p>æ¯ä¸ªèµ„æºæ–‡ä»¶éƒ½æœ‰ç›¸åŒçš„ keyï¼Œä¾‹å¦‚ï¼Œé»˜è®¤è¯­è¨€æ˜¯è‹±æ–‡ï¼Œæ–‡ä»¶ <code>messages.properties</code> å†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>language.select=Language
home=Home
signin=Sign In
copyright=CopyrightÂ©{0,number,#}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ–‡ä»¶ <code>messages_zh_CN.properties</code> å†…å®¹å¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>language.select = è¯­è¨€
home = é¦–é¡µ
signin = ç™»å½•
copyright = ç‰ˆæƒæ‰€æœ‰ Â©{0,number,#}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åˆ›å»º-messagesource" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º-messagesource" aria-hidden="true">#</a> åˆ›å»º MessageSource</h3><p>ç¬¬ä¸‰æ­¥æ˜¯åˆ›å»ºä¸€ä¸ª Spring æä¾›çš„ <code>MessageSource</code> å®ä¾‹ï¼Œå®ƒè‡ªåŠ¨è¯»å–æ‰€æœ‰çš„ <code>.properties</code> æ–‡ä»¶ï¼Œå¹¶æä¾›ä¸€ä¸ªç»Ÿä¸€æ¥å£æ¥å®ç° â€œç¿»è¯‘â€ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// code, arguments, locale:
String text = messageSource.getMessage(&quot;signin&quot;, null, locale);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ï¼Œ<code>signin</code> æ˜¯æˆ‘ä»¬åœ¨ <code>.properties</code> æ–‡ä»¶ä¸­å®šä¹‰çš„ keyï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>Object[]</code> æ•°ç»„ä½œä¸ºæ ¼å¼åŒ–æ—¶ä¼ å…¥çš„å‚æ•°ï¼Œæœ€åä¸€ä¸ªå‚æ•°å°±æ˜¯è·å–çš„ç”¨æˆ· <code>Locale</code> å®ä¾‹ã€‚</p><p>åˆ›å»º <code>MessageSource</code> å¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Bean(&quot;i18n&quot;)
MessageSource createMessageSource() {
    var messageSource = new ResourceBundleMessageSource();
    // æŒ‡å®šæ–‡ä»¶æ˜¯ UTF-8 ç¼–ç :
    messageSource.setDefaultEncoding(&quot;UTF-8&quot;);
    // æŒ‡å®šä¸»æ–‡ä»¶å:
    messageSource.setBasename(&quot;messages&quot;);
    return messageSource;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„åˆ° <code>ResourceBundleMessageSource</code> ä¼šè‡ªåŠ¨æ ¹æ®ä¸»æ–‡ä»¶åè‡ªåŠ¨æŠŠæ‰€æœ‰ç›¸å…³è¯­è¨€çš„èµ„æºæ–‡ä»¶éƒ½è¯»è¿›æ¥ã€‚</p><p>å†æ³¨æ„åˆ° Spring å®¹å™¨ä¼šåˆ›å»ºä¸åªä¸€ä¸ª <code>MessageSource</code> å®ä¾‹ï¼Œæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„è¿™ä¸ª <code>MessageSource</code> æ˜¯ä¸“é—¨ç»™é¡µé¢å›½é™…åŒ–ä½¿ç”¨çš„ï¼Œå› æ­¤å‘½åä¸º <code>i18n</code>ï¼Œä¸ä¼šä¸å…¶å®ƒ <code>MessageSource</code> å®ä¾‹å†²çªã€‚</p><h3 id="å®ç°å¤šè¯­è¨€" tabindex="-1"><a class="header-anchor" href="#å®ç°å¤šè¯­è¨€" aria-hidden="true">#</a> å®ç°å¤šè¯­è¨€</h3><p>è¦åœ¨ View ä¸­ä½¿ç”¨ <code>MessageSource</code> åŠ ä¸Š <code>Locale</code> è¾“å‡ºå¤šè¯­è¨€ï¼Œæˆ‘ä»¬é€šè¿‡ç¼–å†™ä¸€ä¸ª <code>MvcInterceptor</code>ï¼ŒæŠŠç›¸å…³èµ„æºæ³¨å…¥åˆ° <code>ModelAndView</code> ä¸­ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Component
public class MvcInterceptor implements HandlerInterceptor {
    @Autowired
    LocaleResolver localeResolver;

    // æ³¨æ„æ³¨å…¥çš„ MessageSource åç§°æ˜¯ i18n:
    @Autowired
    @Qualifier(&quot;i18n&quot;)
    MessageSource messageSource;

    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        if (modelAndView != null // è¿”å›äº† ModelAndView
            &amp;&amp; modelAndView.getViewName() != null // è®¾ç½®äº† View
            &amp;&amp; !modelAndView.getViewName().startsWith(&quot;redirect:&quot;) // ä¸æ˜¯é‡å®šå‘
        ) {
            // è§£æç”¨æˆ·çš„ Locale:
            Locale locale = localeResolver.resolveLocale(request);
            // æ”¾å…¥ Model:
            modelAndView.addObject(&quot;__messageSource__&quot;, messageSource);
            modelAndView.addObject(&quot;__locale__&quot;, locale);
        }
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸è¦å¿˜äº†åœ¨ <code>WebMvcConfigurer</code> ä¸­æ³¨å†Œ <code>MvcInterceptor</code>ã€‚ç°åœ¨ï¼Œå°±å¯ä»¥åœ¨ View ä¸­è°ƒç”¨ <code>MessageSource.getMessage()</code> æ–¹æ³•æ¥å®ç°å¤šè¯­è¨€ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;a href=&quot;/signin&quot;&gt;{{ __messageSource__.getMessage(&#39;signin&#39;, null, __locale__) }}&lt;/a&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¸Šè¿°è¿™ç§å†™æ³•è™½ç„¶å¯è¡Œï¼Œä½†æ ¼å¼å¤ªå¤æ‚äº†ã€‚ä½¿ç”¨ View æ—¶ï¼Œè¦æ ¹æ®æ¯ä¸ªç‰¹å®šçš„ View å¼•æ“å®šåˆ¶å›½é™…åŒ–å‡½æ•°ã€‚åœ¨ Pebble ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°è£…ä¸€ä¸ªå›½é™…åŒ–å‡½æ•°ï¼Œåç§°å°±æ˜¯ä¸‹åˆ’çº¿ <code>_</code>ï¼Œæ”¹é€ ä¸€ä¸‹åˆ›å»º <code>ViewResolver</code> çš„ä»£ç ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Bean
ViewResolver createViewResolver(@Autowired ServletContext servletContext, @Autowired @Qualifier(&quot;i18n&quot;) MessageSource messageSource) {
    var engine = new PebbleEngine.Builder()
            .autoEscaping(true)
            .cacheActive(false)
            .loader(new Servlet5Loader(servletContext))
            // æ·»åŠ æ‰©å±•:
            .extension(createExtension(messageSource))
            .build();
    var viewResolver = new PebbleViewResolver();
    viewResolver.setPrefix(&quot;/WEB-INF/templates/&quot;);
    viewResolver.setSuffix(&quot;&quot;);
    viewResolver.setPebbleEngine(engine);
    return viewResolver;
}

private Extension createExtension(MessageSource messageSource) {
    return new AbstractExtension() {
        @Override
        public Map&lt;String, Function&gt; getFunctions() {
            return Map.of(&quot;_&quot;, new Function() {
                public Object execute(Map&lt;String, Object&gt; args, PebbleTemplate self, EvaluationContext context, int lineNumber) {
                    String key = (String) args.get(&quot;0&quot;);
                    List&lt;Object&gt; arguments = this.extractArguments(args);
                    Locale locale = (Locale) context.getVariable(&quot;__locale__&quot;);
                    return messageSource.getMessage(key, arguments.toArray(), &quot;???&quot; + key + &quot;???&quot;, locale);
                }
                private List&lt;Object&gt; extractArguments(Map&lt;String, Object&gt; args) {
                    int i = 1;
                    List&lt;Object&gt; arguments = new ArrayList&lt;&gt;();
                    while (args.containsKey(String.valueOf(i))) {
                        Object param = args.get(String.valueOf(i));
                        arguments.add(param);
                        i++;
                    }
                    return arguments;
                }
                public List&lt;String&gt; getArgumentNames() {
                    return null;
                }
            });
        }
    };
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå¤šè¯­è¨€é¡µé¢æ”¹å†™ä¸ºï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;a href=&quot;/signin&quot;&gt;{{ _(&#39;signin&#39;) }}&lt;/a&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¦‚æœæ˜¯å¸¦å‚æ•°çš„å¤šè¯­è¨€ï¼Œéœ€è¦æŠŠå‚æ•°ä¼ è¿›å»ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;h5&gt;{{ _(&#39;copyright&#39;, 2020) }}&lt;/h5&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä½¿ç”¨å…¶å®ƒ View å¼•æ“æ—¶ï¼Œä¹Ÿåº”å½“æ ¹æ®å¼•æ“æ¥å£å®ç°æ›´æ–¹ä¾¿çš„è¯­æ³•ã€‚</p><h3 id="åˆ‡æ¢-locale" tabindex="-1"><a class="header-anchor" href="#åˆ‡æ¢-locale" aria-hidden="true">#</a> åˆ‡æ¢ Locale</h3><p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦å…è®¸ç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢ <code>Locale</code>ï¼Œç¼–å†™ä¸€ä¸ª <code>LocaleController</code> æ¥å®ç°è¯¥åŠŸèƒ½ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Controller
public class LocaleController {
    final Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    LocaleResolver localeResolver;

    @GetMapping(&quot;/locale/{lo}&quot;)
    public String setLocale(@PathVariable(&quot;lo&quot;) String lo, HttpServletRequest request, HttpServletResponse response) {
        // æ ¹æ®ä¼ å…¥çš„ lo åˆ›å»º Locale å®ä¾‹:
        Locale locale = null;
        int pos = lo.indexOf(&#39;_&#39;);
        if (pos&gt; 0) {
            String lang = lo.substring(0, pos);
            String country = lo.substring(pos + 1);
            locale = new Locale(lang, country);
        } else {
            locale = new Locale(lo);
        }
        // è®¾å®šæ­¤ Locale:
        localeResolver.setLocale(request, response, locale);
        logger.info(&quot;locale is set to {}.&quot;, locale);
        // åˆ·æ–°é¡µé¢:
        String referer = request.getHeader(&quot;Referer&quot;);
        return &quot;redirect:&quot; + (referer == null ? &quot;/&quot; : referer);
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨é¡µé¢è®¾è®¡ä¸­ï¼Œé€šå¸¸åœ¨å³ä¸Šè§’ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªè¯­è¨€é€‰æ‹©åˆ—è¡¨ï¼Œæ¥çœ‹çœ‹æ•ˆæœï¼š</p><figure><img src="`+b+'" alt="i18n-en" tabindex="0" loading="lazy"><figcaption>i18n-en</figcaption></figure><p>åˆ‡æ¢åˆ°ä¸­æ–‡ï¼š</p><figure><img src="'+h+`" alt="i18n-zh-cn" tabindex="0" loading="lazy"><figcaption>i18n-zh-cn</figcaption></figure><h3 id="ç»ƒä¹ -5" tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ -5" aria-hidden="true">#</a> ç»ƒä¹ </h3><h3 id="å°ç»“-5" tabindex="-1"><a class="header-anchor" href="#å°ç»“-5" aria-hidden="true">#</a> å°ç»“</h3><p>å¤šè¯­è¨€æ”¯æŒéœ€è¦ä» HTTP è¯·æ±‚ä¸­è§£æç”¨æˆ·çš„ Localeï¼Œç„¶åé’ˆå¯¹ä¸åŒ Locale æ˜¾ç¤ºä¸åŒçš„è¯­è¨€ï¼›</p><p>Spring MVC åº”ç”¨ç¨‹åºé€šè¿‡ <code>MessageSource</code> å’Œ <code>LocaleResolver</code>ï¼Œé…åˆ View å®ç°å›½é™…åŒ–ã€‚</p><h2 id="ğŸ€-å¼‚æ­¥å¤„ç†" tabindex="-1"><a class="header-anchor" href="#ğŸ€-å¼‚æ­¥å¤„ç†" aria-hidden="true">#</a> ğŸ€ å¼‚æ­¥å¤„ç†</h2><p>åœ¨ Servlet æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç”±æŸä¸ªçº¿ç¨‹å¤„ç†ï¼Œç„¶åï¼Œå°†å“åº”å†™å…¥ IO æµï¼Œå‘é€ç»™å®¢æˆ·ç«¯ã€‚ä»å¼€å§‹å¤„ç†è¯·æ±‚ï¼Œåˆ°å†™å…¥å“åº”å®Œæˆï¼Œéƒ½æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†çš„ã€‚</p><p>å®ç° Servlet å®¹å™¨çš„æ—¶å€™ï¼Œåªè¦æ¯å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹å¤„ç†å®ƒï¼Œå°±èƒ½ä¿è¯æ­£ç¡®å®ç°äº† Servlet çº¿ç¨‹æ¨¡å‹ã€‚åœ¨å®é™…äº§å“ä¸­ï¼Œä¾‹å¦‚ Tomcatï¼Œæ€»æ˜¯é€šè¿‡çº¿ç¨‹æ± æ¥å¤„ç†è¯·æ±‚ï¼Œå®ƒä»ç„¶ç¬¦åˆä¸€ä¸ªè¯·æ±‚ä»å¤´åˆ°å°¾éƒ½ç”±æŸä¸€ä¸ªçº¿ç¨‹å¤„ç†ã€‚</p><p>è¿™ç§çº¿ç¨‹æ¨¡å‹éå¸¸é‡è¦ï¼Œå› ä¸º Spring çš„ JDBC äº‹åŠ¡æ˜¯åŸºäº <code>ThreadLocal</code> å®ç°çš„ï¼Œå¦‚æœåœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä¸€ä¼šç”±çº¿ç¨‹ A å¤„ç†ï¼Œä¸€ä¼šåˆç”±çº¿ç¨‹ B å¤„ç†ï¼Œé‚£äº‹åŠ¡å°±å…¨ä¹±å¥—äº†ã€‚æ­¤å¤–ï¼Œå¾ˆå¤šå®‰å…¨è®¤è¯ï¼Œä¹Ÿæ˜¯åŸºäº <code>ThreadLocal</code> å®ç°çš„ï¼Œå¯ä»¥ä¿è¯åœ¨å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œå„ä¸ªçº¿ç¨‹äº’ä¸å½±å“ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªè¯·æ±‚å¤„ç†çš„æ—¶é—´è¾ƒé•¿ï¼Œä¾‹å¦‚å‡ ç§’é’Ÿç”šè‡³æ›´é•¿ï¼Œé‚£ä¹ˆï¼Œè¿™ç§åŸºäºçº¿ç¨‹æ± çš„åŒæ­¥æ¨¡å‹å¾ˆå¿«å°±ä¼šæŠŠæ‰€æœ‰çº¿ç¨‹è€—å°½ï¼Œå¯¼è‡´æœåŠ¡å™¨æ— æ³•å“åº”æ–°çš„è¯·æ±‚ã€‚å¦‚æœæŠŠé•¿æ—¶é—´å¤„ç†çš„è¯·æ±‚æ”¹ä¸ºå¼‚æ­¥å¤„ç†ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± çš„åˆ©ç”¨ç‡å°±ä¼šå¤§å¤§æé«˜ã€‚Servlet ä» 3.0 è§„èŒƒå¼€å§‹æ·»åŠ äº†å¼‚æ­¥æ”¯æŒï¼Œå…è®¸å¯¹ä¸€ä¸ªè¯·æ±‚è¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ Spring MVC ä¸­å¦‚ä½•å®ç°å¯¹è¯·æ±‚è¿›è¡Œå¼‚æ­¥å¤„ç†çš„é€»è¾‘ã€‚é¦–å…ˆå»ºç«‹ä¸€ä¸ª Web å·¥ç¨‹ï¼Œç„¶åç¼–è¾‘ <code>web.xml</code> æ–‡ä»¶å¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;web-app&gt;
    &lt;display-name&gt;Archetype Created Web Application&lt;/display-name&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;contextClass&lt;/param-name&gt;
            &lt;param-value&gt;org.springframework.web.context.support.AnnotationConfigWebApplicationContext&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
            &lt;param-value&gt;com.itranswarp.learnjava.AppConfig&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;load-on-startup&gt;0&lt;/load-on-startup&gt;
        &lt;async-supported&gt;true&lt;/async-supported&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å’Œå‰é¢æ™®é€šçš„ MVC ç¨‹åºç›¸æ¯”ï¼Œè¿™ä¸ª <code>web.xml</code> ä¸»è¦å¯¹ <code>DispatcherServlet</code> çš„é…ç½®å¤šäº†ä¸€ä¸ª <code>&lt;async-supported&gt;</code>ï¼Œé»˜è®¤å€¼æ˜¯ <code>false</code>ï¼Œå¿…é¡»æ˜ç¡®å†™æˆ <code>true</code>ï¼Œè¿™æ · Servlet å®¹å™¨æ‰ä¼šæ”¯æŒ async å¤„ç†ã€‚</p><p>ä¸‹ä¸€æ­¥å°±æ˜¯åœ¨ Controller ä¸­ç¼–å†™ async å¤„ç†é€»è¾‘ã€‚æˆ‘ä»¬ä»¥ <code>ApiController</code> ä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•å¼‚æ­¥å¤„ç†è¯·æ±‚ã€‚</p><p>ç¬¬ä¸€ç§ async å¤„ç†æ–¹å¼æ˜¯è¿”å›ä¸€ä¸ª <code>Callable</code>ï¼ŒSpring MVC è‡ªåŠ¨æŠŠè¿”å›çš„ <code>Callable</code> æ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œï¼Œç­‰å¾…ç»“æœè¿”å›åå†å†™å…¥å“åº”ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@GetMapping(&quot;/users&quot;)
public Callable&lt;List&lt;User&gt;&gt; users() {
    return () -&gt; {
        // æ¨¡æ‹Ÿ 3 ç§’è€—æ—¶:
        try {
            Thread.sleep(3000);
        } catch (InterruptedException e) {
        }
        return userService.getUsers();
    };
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬äºŒç§ async å¤„ç†æ–¹å¼æ˜¯è¿”å›ä¸€ä¸ª <code>DeferredResult</code> å¯¹è±¡ï¼Œç„¶ååœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œè®¾ç½®æ­¤å¯¹è±¡çš„å€¼å¹¶å†™å…¥å“åº”ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@GetMapping(&quot;/users/{id}&quot;)
public DeferredResult&lt;User&gt; user(@PathVariable(&quot;id&quot;) long id) {
    DeferredResult&lt;User&gt; result = new DeferredResult&lt;&gt;(3000L); // 3 ç§’è¶…æ—¶
    new Thread(() -&gt; {
        // ç­‰å¾… 1 ç§’:
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
        }
        try {
            User user = userService.getUserById(id);
            // è®¾ç½®æ­£å¸¸ç»“æœå¹¶ç”± Spring MVC å†™å…¥ Response:
            result.setResult(user);
        } catch (Exception e) {
            // è®¾ç½®é”™è¯¯ç»“æœå¹¶ç”± Spring MVC å†™å…¥ Response:
            result.setErrorResult(Map.of(&quot;error&quot;, e.getClass().getSimpleName(), &quot;message&quot;, e.getMessage()));
        }
    }).start();
    return result;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨ <code>DeferredResult</code> æ—¶ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶ï¼Œè¶…æ—¶ä¼šè‡ªåŠ¨è¿”å›è¶…æ—¶é”™è¯¯å“åº”ã€‚åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå¯ä»¥è°ƒç”¨ <code>setResult()</code> å†™å…¥ç»“æœï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ <code>setErrorResult()</code> å†™å…¥ä¸€ä¸ªé”™è¯¯ç»“æœã€‚</p><p>è¿è¡Œç¨‹åºï¼Œå½“æˆ‘ä»¬è®¿é—® <code>http://localhost:8080/api/users/1</code> æ—¶ï¼Œå‡å®šç”¨æˆ·å­˜åœ¨ï¼Œåˆ™æµè§ˆå™¨åœ¨ 1 ç§’åè¿”å›ç»“æœï¼š</p><figure><img src="`+S+'" alt="deferred-result-ok" tabindex="0" loading="lazy"><figcaption>deferred-result-ok</figcaption></figure><p>è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„ User IDï¼Œåˆ™ç­‰å¾… 1 ç§’åè¿”å›é”™è¯¯ç»“æœï¼š</p><figure><img src="'+f+`" alt="deferred-result-error" tabindex="0" loading="lazy"><figcaption>deferred-result-error</figcaption></figure><h3 id="ä½¿ç”¨-filter" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-filter" aria-hidden="true">#</a> ä½¿ç”¨ Filter</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨ async æ¨¡å¼å¤„ç†è¯·æ±‚æ—¶ï¼ŒåŸæœ‰çš„ Filter ä¹Ÿå¯ä»¥å·¥ä½œï¼Œä½†æˆ‘ä»¬å¿…é¡»åœ¨ <code>web.xml</code> ä¸­æ·»åŠ  <code>&lt;async-supported&gt;</code> å¹¶è®¾ç½®ä¸º <code>true</code>ã€‚æˆ‘ä»¬ç”¨ä¸¤ä¸ª Filterï¼šSyncFilter å’Œ AsyncFilter åˆ†åˆ«æµ‹è¯•ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;web-app ...&gt;
    ...
    &lt;filter&gt;
        &lt;filter-name&gt;sync-filter&lt;/filter-name&gt;
        &lt;filter-class&gt;com.itranswarp.learnjava.web.SyncFilter&lt;/filter-class&gt;
    &lt;/filter&gt;

    &lt;filter&gt;
        &lt;filter-name&gt;async-filter&lt;/filter-name&gt;
        &lt;filter-class&gt;com.itranswarp.learnjava.web.AsyncFilter&lt;/filter-class&gt;
        &lt;async-supported&gt;true&lt;/async-supported&gt;
    &lt;/filter&gt;

    &lt;filter-mapping&gt;
        &lt;filter-name&gt;sync-filter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/api/version&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;

    &lt;filter-mapping&gt;
        &lt;filter-name&gt;async-filter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/api/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
    ...
&lt;/web-app&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€ä¸ªå£°æ˜ä¸ºæ”¯æŒ <code>&lt;async-supported&gt;</code> çš„ Filter æ—¢å¯ä»¥è¿‡æ»¤ async å¤„ç†è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥è¿‡æ»¤æ­£å¸¸çš„åŒæ­¥å¤„ç†è¯·æ±‚ï¼Œè€Œæœªå£°æ˜ <code>&lt;async-supported&gt;</code> çš„ Filter æ— æ³•æ”¯æŒ async è¯·æ±‚ï¼Œå¦‚æœä¸€ä¸ªæ™®é€šçš„ Filter é‡åˆ° async è¯·æ±‚æ—¶ï¼Œä¼šç›´æ¥æŠ¥é”™ï¼Œå› æ­¤ï¼ŒåŠ¡å¿…æ³¨æ„æ™®é€š Filter çš„ <code>&lt;url-pattern&gt;</code> ä¸è¦åŒ¹é… async è¯·æ±‚è·¯å¾„ã€‚</p><p>åœ¨ <code>logback.xml</code> é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æŠŠè¾“å‡ºæ ¼å¼åŠ ä¸Š <code>[%thread]</code>ï¼Œå¯ä»¥è¾“å‡ºå½“å‰çº¿ç¨‹çš„åç§°ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration&gt;
    &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;layout class=&quot;ch.qos.logback.classic.PatternLayout&quot;&gt;
            &lt;Pattern&gt;%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n&lt;/Pattern&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;
    ...
&lt;/configuration&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºåŒæ­¥è¯·æ±‚ï¼Œä¾‹å¦‚ <code>/api/version</code>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2020-05-16 11:22:40 [http-nio-8080-exec-1] INFO  c.i.learnjava.web.SyncFilter - start SyncFilter...
2020-05-16 11:22:40 [http-nio-8080-exec-1] INFO  c.i.learnjava.web.AsyncFilter - start AsyncFilter...
2020-05-16 11:22:40 [http-nio-8080-exec-1] INFO  c.i.learnjava.web.ApiController - get version...
2020-05-16 11:22:40 [http-nio-8080-exec-1] INFO  c.i.learnjava.web.AsyncFilter - end AsyncFilter.
2020-05-16 11:22:40 [http-nio-8080-exec-1] INFO  c.i.learnjava.web.SyncFilter - end SyncFilter.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯è§ï¼Œæ¯ä¸ª Filter å’Œ <code>ApiController</code> éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚</p><p>å¯¹äºå¼‚æ­¥è¯·æ±‚ï¼Œä¾‹å¦‚ <code>/api/users</code>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2020-05-16 11:23:49 [http-nio-8080-exec-4] INFO  c.i.learnjava.web.AsyncFilter - start AsyncFilter...
2020-05-16 11:23:49 [http-nio-8080-exec-4] INFO  c.i.learnjava.web.ApiController - get users...
2020-05-16 11:23:49 [http-nio-8080-exec-4] INFO  c.i.learnjava.web.AsyncFilter - end AsyncFilter.
2020-05-16 11:23:52 [MvcAsync1] INFO  c.i.learnjava.web.ApiController - return users...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯è§ï¼Œ<code>AsyncFilter</code> å’Œ <code>ApiController</code> æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ï¼Œä½†æ˜¯ï¼Œè¿”å›å“åº”çš„æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ã€‚</p><p>å¯¹ <code>DeferredResult</code> æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2020-05-16 11:25:24 [http-nio-8080-exec-8] INFO  c.i.learnjava.web.AsyncFilter - start AsyncFilter...
2020-05-16 11:25:24 [http-nio-8080-exec-8] INFO  c.i.learnjava.web.AsyncFilter - end AsyncFilter.
2020-05-16 11:25:25 [Thread-2] INFO  c.i.learnjava.web.ApiController - deferred result is set.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŒæ ·ï¼Œè¿”å›å“åº”çš„æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ã€‚</p><p>åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œç»å¸¸ç”¨åˆ°çš„å°±æ˜¯ <code>DeferredResult</code>ï¼Œå› ä¸ºè¿”å› <code>DeferredResult</code> æ—¶ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶ã€æ­£å¸¸ç»“æœå’Œé”™è¯¯ç»“æœï¼Œæ˜“äºç¼–å†™æ¯”è¾ƒçµæ´»çš„é€»è¾‘ã€‚</p><p>ä½¿ç”¨ async å¼‚æ­¥å¤„ç†å“åº”æ—¶ï¼Œè¦æ—¶åˆ»ç‰¢è®°ï¼Œåœ¨å¦ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ä¸­çš„äº‹åŠ¡å’Œ Controller æ–¹æ³•ä¸­æ‰§è¡Œçš„äº‹åŠ¡ä¸æ˜¯åŒä¸€ä¸ªäº‹åŠ¡ï¼Œåœ¨ Controller ä¸­ç»‘å®šçš„ <code>ThreadLocal</code> ä¿¡æ¯ä¹Ÿæ— æ³•åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­è·å–ã€‚</p>`,104),nn=n("code",null,"java.nio",-1),sn={href:"https://netty.io/",target:"_blank",rel:"noopener noreferrer"},an=l(`<h3 id="ç»ƒä¹ -6" tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ -6" aria-hidden="true">#</a> ç»ƒä¹ </h3><h3 id="å°ç»“-6" tabindex="-1"><a class="header-anchor" href="#å°ç»“-6" aria-hidden="true">#</a> å°ç»“</h3><p>åœ¨ Spring MVC ä¸­å¼‚æ­¥å¤„ç†è¯·æ±‚éœ€è¦æ­£ç¡®é…ç½® <code>web.xml</code>ï¼Œå¹¶è¿”å› <code>Callable</code> æˆ– <code>DeferredResult</code> å¯¹è±¡ã€‚</p><h2 id="ğŸ€-ä½¿ç”¨-websocket" tabindex="-1"><a class="header-anchor" href="#ğŸ€-ä½¿ç”¨-websocket" aria-hidden="true">#</a> ğŸ€ ä½¿ç”¨ WebSocket</h2><p>WebSocket æ˜¯ä¸€ç§åŸºäº HTTP çš„é•¿é“¾æ¥æŠ€æœ¯ã€‚ä¼ ç»Ÿçš„ HTTP åè®®æ˜¯ä¸€ç§è¯·æ±‚ - å“åº”æ¨¡å‹ï¼Œå¦‚æœæµè§ˆå™¨ä¸å‘é€è¯·æ±‚ï¼Œé‚£ä¹ˆæœåŠ¡å™¨æ— æ³•ä¸»åŠ¨ç»™æµè§ˆå™¨æ¨é€æ•°æ®ã€‚å¦‚æœéœ€è¦å®šæœŸç»™æµè§ˆå™¨æ¨é€æ•°æ®ï¼Œä¾‹å¦‚è‚¡ç¥¨è¡Œæƒ…ï¼Œæˆ–è€…ä¸å®šæœŸç»™æµè§ˆå™¨æ¨é€æ•°æ®ï¼Œä¾‹å¦‚åœ¨çº¿èŠå¤©ï¼ŒåŸºäº HTTP åè®®å®ç°è¿™ç±»éœ€æ±‚ï¼Œåªèƒ½ä¾é æµè§ˆå™¨çš„ JavaScript å®šæ—¶è½®è¯¢ï¼Œæ•ˆç‡å¾ˆä½ä¸”å®æ—¶æ€§ä¸é«˜ã€‚</p><p>å› ä¸º HTTP æœ¬èº«æ˜¯åŸºäº TCP è¿æ¥çš„ï¼Œæ‰€ä»¥ï¼ŒWebSocket åœ¨ HTTP åè®®çš„åŸºç¡€ä¸Šåšäº†ä¸€ä¸ªç®€å•çš„å‡çº§ï¼Œå³å»ºç«‹ TCP è¿æ¥åï¼Œæµè§ˆå™¨å‘é€è¯·æ±‚æ—¶ï¼Œé™„å¸¦å‡ ä¸ªå¤´ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>GET /chat HTTP/1.1
Host: www.example.com
Upgrade: websocket
Connection: Upgrade
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°±è¡¨ç¤ºå®¢æˆ·ç«¯å¸Œæœ›å‡çº§è¿æ¥ï¼Œå˜æˆé•¿è¿æ¥çš„ WebSocketï¼ŒæœåŠ¡å™¨è¿”å›å‡çº§æˆåŠŸçš„å“åº”ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ”¶åˆ°æˆåŠŸå“åº”åè¡¨ç¤º WebSocketâ€œæ¡æ‰‹â€ æˆåŠŸï¼Œè¿™æ ·ï¼Œä»£è¡¨ WebSocket çš„è¿™ä¸ª TCP è¿æ¥å°†ä¸ä¼šè¢«æœåŠ¡å™¨å…³é—­ï¼Œè€Œæ˜¯ä¸€ç›´ä¿æŒï¼ŒæœåŠ¡å™¨å¯éšæ—¶å‘æµè§ˆå™¨æ¨é€æ¶ˆæ¯ï¼Œæµè§ˆå™¨ä¹Ÿå¯éšæ—¶å‘æœåŠ¡å™¨æ¨é€æ¶ˆæ¯ã€‚åŒæ–¹æ¨é€çš„æ¶ˆæ¯æ—¢å¯ä»¥æ˜¯æ–‡æœ¬æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥æ˜¯äºŒè¿›åˆ¶æ¶ˆæ¯ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œç»å¤§éƒ¨åˆ†åº”ç”¨ç¨‹åºä¼šæ¨é€åŸºäº JSON çš„æ–‡æœ¬æ¶ˆæ¯ã€‚</p><p>ç°ä»£æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒ WebSocket åè®®ï¼ŒæœåŠ¡å™¨åˆ™éœ€è¦åº•å±‚æ¡†æ¶æ”¯æŒã€‚Java çš„ Servlet è§„èŒƒä» 3.1 å¼€å§‹æ”¯æŒ WebSocketï¼Œæ‰€ä»¥ï¼Œå¿…é¡»é€‰æ‹©æ”¯æŒ Servlet 3.1 æˆ–æ›´é«˜è§„èŒƒçš„ Servlet å®¹å™¨ï¼Œæ‰èƒ½æ”¯æŒ WebSocketã€‚æœ€æ–°ç‰ˆæœ¬çš„ Tomcatã€Jetty ç­‰å¼€æºæœåŠ¡å™¨å‡æ”¯æŒ WebSocketã€‚</p><p>æˆ‘ä»¬ä»¥å®é™…ä»£ç æ¼”ç¤ºå¦‚ä½•åœ¨ Spring MVC ä¸­å®ç°å¯¹ WebSocket çš„æ”¯æŒã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨ <code>pom.xml</code> ä¸­åŠ å…¥ä»¥ä¸‹ä¾èµ–ï¼š</p><ul><li>org.apache.tomcat.embed:tomcat-embed-websocket:10.1.1</li><li>org.springframework:spring-websocket:6.0.0</li></ul><p>ç¬¬ä¸€é¡¹æ˜¯åµŒå…¥å¼ Tomcat æ”¯æŒ WebSocket çš„ç»„ä»¶ï¼Œç¬¬äºŒé¡¹æ˜¯ Spring å°è£…çš„æ”¯æŒ WebSocket çš„æ¥å£ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ AppConfig ä¸­åŠ å…¥ Spring Web å¯¹ WebSocket çš„é…ç½®ï¼Œæ­¤å¤„æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª <code>WebSocketConfigurer</code> å®ä¾‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Bean
WebSocketConfigurer createWebSocketConfigurer(
        @Autowired ChatHandler chatHandler,
        @Autowired ChatHandshakeInterceptor chatInterceptor)
{
    return new WebSocketConfigurer() {
        public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
            // æŠŠ URL ä¸æŒ‡å®šçš„ WebSocketHandler å…³è”ï¼Œå¯å…³è”å¤šä¸ª:
            registry.addHandler(chatHandler, &quot;/chat&quot;).addInterceptors(chatInterceptor);
        }
    };
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤å®ä¾‹åœ¨å†…éƒ¨é€šè¿‡ <code>WebSocketHandlerRegistry</code> æ³¨å†Œèƒ½å¤„ç† WebSocket çš„ <code>WebSocketHandler</code>ï¼Œä»¥åŠå¯é€‰çš„ WebSocket æ‹¦æˆªå™¨ <code>HandshakeInterceptor</code>ã€‚æˆ‘ä»¬æ³¨å…¥çš„è¿™ä¸¤ä¸ªç±»éƒ½æ˜¯è‡ªå·±ç¼–å†™çš„ä¸šåŠ¡é€»è¾‘ï¼Œåé¢æˆ‘ä»¬è¯¦ç»†è®¨è®ºå¦‚ä½•ç¼–å†™å®ƒä»¬ï¼Œè¿™é‡Œåªéœ€å…³æ³¨æµè§ˆå™¨è¿æ¥åˆ° WebSocket çš„ URL æ˜¯ <code>/chat</code>ã€‚</p><h3 id="å¤„ç†-websocket-è¿æ¥" tabindex="-1"><a class="header-anchor" href="#å¤„ç†-websocket-è¿æ¥" aria-hidden="true">#</a> å¤„ç† WebSocket è¿æ¥</h3><p>å’Œå¤„ç†æ™®é€š HTTP è¯·æ±‚ä¸åŒï¼Œæ²¡æ³•ç”¨ä¸€ä¸ªæ–¹æ³•å¤„ç†ä¸€ä¸ª URLã€‚Spring æä¾›äº† <code>TextWebSocketHandler</code> å’Œ <code>BinaryWebSocketHandler</code> åˆ†åˆ«å¤„ç†æ–‡æœ¬æ¶ˆæ¯å’ŒäºŒè¿›åˆ¶æ¶ˆæ¯ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©æ–‡æœ¬æ¶ˆæ¯ä½œä¸ºèŠå¤©å®¤çš„åè®®ï¼Œå› æ­¤ï¼Œ<code>ChatHandler</code> éœ€è¦ç»§æ‰¿è‡ª <code>TextWebSocketHandler</code>ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Component
public class ChatHandler extends TextWebSocketHandler {
    ...
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“æµè§ˆå™¨è¯·æ±‚ä¸€ä¸ª WebSocket è¿æ¥åï¼Œå¦‚æœæˆåŠŸå»ºç«‹è¿æ¥ï¼ŒSpring ä¼šè‡ªåŠ¨è°ƒç”¨ <code>afterConnectionEstablished()</code> æ–¹æ³•ï¼Œä»»ä½•åŸå› å¯¼è‡´ WebSocket è¿æ¥ä¸­æ–­æ—¶ï¼ŒSpring ä¼šè‡ªåŠ¨è°ƒç”¨ <code>afterConnectionClosed</code> æ–¹æ³•ï¼Œå› æ­¤ï¼Œè¦†å†™è¿™ä¸¤ä¸ªæ–¹æ³•å³å¯å¤„ç†è¿æ¥æˆåŠŸå’Œç»“æŸåçš„ä¸šåŠ¡é€»è¾‘ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Component
public class ChatHandler extends TextWebSocketHandler {
    // ä¿å­˜æ‰€æœ‰ Client çš„ WebSocket ä¼šè¯å®ä¾‹:
    private Map&lt;String, WebSocketSession&gt; clients = new ConcurrentHashMap&lt;&gt;();

    @Override
    public void afterConnectionEstablished(WebSocketSession session) throws Exception {
        // æ–°ä¼šè¯æ ¹æ® ID æ”¾å…¥ Map:
        clients.put(session.getId(), session);
        session.getAttributes().put(&quot;name&quot;, &quot;Guest1&quot;);
    }

    @Override
    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) throws Exception {
        clients.remove(session.getId());
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯ä¸ª WebSocket ä¼šè¯ä»¥ <code>WebSocketSession</code> è¡¨ç¤ºï¼Œä¸”å·²åˆ†é…å”¯ä¸€ IDã€‚å’Œ WebSocket ç›¸å…³çš„æ•°æ®ï¼Œä¾‹å¦‚ç”¨æˆ·åç§°ç­‰ï¼Œå‡å¯æ”¾å…¥å…³è”çš„ <code>getAttributes()</code> ä¸­ã€‚</p><p>ç”¨å®ä¾‹å˜é‡ <code>clients</code> æŒæœ‰å½“å‰æ‰€æœ‰çš„ <code>WebSocketSession</code> æ˜¯ä¸ºäº†å¹¿æ’­ï¼Œå³å‘æ‰€æœ‰ç”¨æˆ·æ¨é€åŒä¸€æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>String json = ...
TextMessage message = new TextMessage(json);
for (String id : clients.keySet()) {
    WebSocketSession session = clients.get(id);
    session.sendMessage(message);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å‘é€çš„æ¶ˆæ¯æ˜¯åºåˆ—åŒ–åçš„ JSONï¼Œå¯ä»¥ç”¨ <code>ChatMessage</code> è¡¨ç¤ºï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public class ChatMessage {
	public long timestamp;
	public String name;
    public String text;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯æ”¶åˆ°ä¸€ä¸ªç”¨æˆ·çš„æ¶ˆæ¯åï¼Œæˆ‘ä»¬å°±éœ€è¦å¹¿æ’­ç»™æ‰€æœ‰ç”¨æˆ·ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Component
public class ChatHandler extends TextWebSocketHandler {
    ...
    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
        String s = message.getPayload();
        String r = ... // æ ¹æ®è¾“å…¥æ¶ˆæ¯æ„é€ å¾…å‘é€æ¶ˆæ¯
        broadcastMessage(r); // æ¨é€ç»™æ‰€æœ‰ç”¨æˆ·
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœè¦æ¨é€ç»™æŒ‡å®šçš„å‡ ä¸ªç”¨æˆ·ï¼Œé‚£å°±éœ€è¦åœ¨ <code>clients</code> ä¸­æ ¹æ®æ¡ä»¶æŸ¥æ‰¾å‡ºæŸäº› <code>WebSocketSession</code>ï¼Œç„¶åå‘é€æ¶ˆæ¯ã€‚</p><p>æ³¨æ„åˆ°æˆ‘ä»¬åœ¨æ³¨å†Œ WebSocket æ—¶è¿˜ä¼ å…¥äº†ä¸€ä¸ª <code>ChatHandshakeInterceptor</code>ï¼Œè¿™ä¸ªç±»å®é™…ä¸Šå¯ä»¥ä» <code>HttpSessionHandshakeInterceptor</code> ç»§æ‰¿ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ WebSocket å»ºç«‹è¿æ¥åï¼ŒæŠŠ HttpSession çš„ä¸€äº›å±æ€§å¤åˆ¶åˆ° WebSocketSessionï¼Œä¾‹å¦‚ï¼Œç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ç­‰ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>@Component
public class ChatHandshakeInterceptor extends HttpSessionHandshakeInterceptor {
    public ChatHandshakeInterceptor() {
        // æŒ‡å®šä» HttpSession å¤åˆ¶å±æ€§åˆ° WebSocketSession:
        super(List.of(UserController.KEY_USER));
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·ï¼Œåœ¨ <code>ChatHandler</code> ä¸­ï¼Œå¯ä»¥ä» <code>WebSocketSession.getAttributes()</code> ä¸­è·å–åˆ°å¤åˆ¶è¿‡æ¥çš„å±æ€§ã€‚</p><h3 id="å®¢æˆ·ç«¯å¼€å‘" tabindex="-1"><a class="header-anchor" href="#å®¢æˆ·ç«¯å¼€å‘" aria-hidden="true">#</a> å®¢æˆ·ç«¯å¼€å‘</h3><p>åœ¨å®Œæˆäº†æœåŠ¡å™¨ç«¯çš„å¼€å‘åï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨é¡µé¢ç¼–å†™ä¸€ç‚¹ JavaScript é€»è¾‘ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// åˆ›å»º WebSocket è¿æ¥:
var ws = new WebSocket(&#39;ws://&#39; + location.host + &#39;/chat&#39;);
// è¿æ¥æˆåŠŸæ—¶:
ws.addEventListener(&#39;open&#39;, function (event) {
    console.log(&#39;websocket connected.&#39;);
});
// æ”¶åˆ°æ¶ˆæ¯æ—¶:
ws.addEventListener(&#39;message&#39;, function (event) {
    console.log(&#39;message:&#39; + event.data);
    var msgs = JSON.parse(event.data);
    // TODO:
});
// è¿æ¥å…³é—­æ—¶:
ws.addEventListener(&#39;close&#39;, function () {
    console.log(&#39;websocket closed.&#39;);
});
// ç»‘å®šåˆ°å…¨å±€å˜é‡:
window.chatWs = ws;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”¨æˆ·å¯ä»¥åœ¨è¿æ¥æˆåŠŸåä»»ä½•æ—¶å€™ç»™æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>var inputText = &#39;Hello, WebSocket.&#39;;
window.chatWs.send(JSON.stringify({text: inputText}));
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åï¼Œè¿è°ƒæµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯ï¼Œå¦‚æœä¸€åˆ‡æ— è¯¯ï¼Œå¯ä»¥å¼€å¤šä¸ªä¸åŒçš„æµè§ˆå™¨æµ‹è¯• WebSocket çš„æ¨é€å’Œå¹¿æ’­ï¼š</p><figure><img src="`+x+'" alt="chat" tabindex="0" loading="lazy"><figcaption>chat</figcaption></figure><p>å’Œä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»çš„å¼‚æ­¥å¤„ç†ç±»ä¼¼ï¼ŒServlet çš„çº¿ç¨‹æ¨¡å‹å¹¶ä¸é€‚åˆå¤§è§„æ¨¡çš„é•¿é“¾æ¥ã€‚åŸºäº NIO çš„ Netty ç­‰æ¡†æ¶æ›´é€‚åˆå¤„ç† WebSocket é•¿é“¾æ¥ï¼Œæˆ‘ä»¬å°†åœ¨åé¢ä»‹ç»ã€‚</p><h3 id="ç»ƒä¹ -7" tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ -7" aria-hidden="true">#</a> ç»ƒä¹ </h3><h3 id="å°ç»“-7" tabindex="-1"><a class="header-anchor" href="#å°ç»“-7" aria-hidden="true">#</a> å°ç»“</h3><p>åœ¨ Servlet ä¸­ä½¿ç”¨ WebSocket éœ€è¦ 3.1 åŠä»¥ä¸Šç‰ˆæœ¬ï¼›</p><p>é€šè¿‡ <code>spring-websocket</code> å¯ä»¥ç®€åŒ– WebSocket çš„å¼€å‘ã€‚</p>',45);function en(tn,ln){const t=o("router-link"),c=o("RouterLink"),i=o("ExternalLinkIcon");return r(),d("div",null,[n("details",C,[q,n("nav",y,[n("ul",null,[n("li",null,[a(t,{to:"#ğŸ€-ä½¿ç”¨-spring-mvc"},{default:e(()=>[s("ğŸ€ ä½¿ç”¨ Spring MVC")]),_:1}),n("ul",null,[n("li",null,[a(t,{to:"#é…ç½®-spring-mvc"},{default:e(()=>[s("é…ç½® Spring MVC")]),_:1})]),n("li",null,[a(t,{to:"#ç¼–å†™-controller"},{default:e(()=>[s("ç¼–å†™ Controller")]),_:1})]),n("li",null,[a(t,{to:"#ç»ƒä¹ "},{default:e(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(t,{to:"#å°ç»“"},{default:e(()=>[s("å°ç»“")]),_:1})])])]),n("li",null,[a(t,{to:"#ğŸ€-ä½¿ç”¨-rest"},{default:e(()=>[s("ğŸ€ ä½¿ç”¨ REST")]),_:1}),n("ul",null,[n("li",null,[a(t,{to:"#ç»ƒä¹ -1"},{default:e(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(t,{to:"#å°ç»“-1"},{default:e(()=>[s("å°ç»“")]),_:1})])])]),n("li",null,[a(t,{to:"#ğŸ€-é›†æˆ-filter"},{default:e(()=>[s("ğŸ€ é›†æˆ Filter")]),_:1}),n("ul",null,[n("li",null,[a(t,{to:"#ç»ƒä¹ -2"},{default:e(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(t,{to:"#å°ç»“-2"},{default:e(()=>[s("å°ç»“")]),_:1})])])]),n("li",null,[a(t,{to:"#ğŸ€-ä½¿ç”¨-interceptor"},{default:e(()=>[s("ğŸ€ ä½¿ç”¨ Interceptor")]),_:1}),n("ul",null,[n("li",null,[a(t,{to:"#å¤„ç†å¼‚å¸¸"},{default:e(()=>[s("å¤„ç†å¼‚å¸¸")]),_:1})]),n("li",null,[a(t,{to:"#ç»ƒä¹ -3"},{default:e(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(t,{to:"#å°ç»“-3"},{default:e(()=>[s("å°ç»“")]),_:1})])])]),n("li",null,[a(t,{to:"#ğŸ€-å¤„ç†-cors"},{default:e(()=>[s("ğŸ€ å¤„ç† CORS")]),_:1}),n("ul",null,[n("li",null,[a(t,{to:"#ä½¿ç”¨-crossorigin"},{default:e(()=>[s("ä½¿ç”¨ @CrossOrigin")]),_:1})]),n("li",null,[a(t,{to:"#ä½¿ç”¨-corsregistry"},{default:e(()=>[s("ä½¿ç”¨ CorsRegistry")]),_:1})]),n("li",null,[a(t,{to:"#ä½¿ç”¨-corsfilter"},{default:e(()=>[s("ä½¿ç”¨ CorsFilter")]),_:1})]),n("li",null,[a(t,{to:"#æµ‹è¯•"},{default:e(()=>[s("æµ‹è¯•")]),_:1})]),n("li",null,[a(t,{to:"#ç»ƒä¹ -4"},{default:e(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(t,{to:"#å°ç»“-4"},{default:e(()=>[s("å°ç»“")]),_:1})])])]),n("li",null,[a(t,{to:"#ğŸ€-å›½é™…åŒ–"},{default:e(()=>[s("ğŸ€ å›½é™…åŒ–")]),_:1}),n("ul",null,[n("li",null,[a(t,{to:"#è·å–-locale"},{default:e(()=>[s("è·å– Locale")]),_:1})]),n("li",null,[a(t,{to:"#æå–èµ„æºæ–‡ä»¶"},{default:e(()=>[s("æå–èµ„æºæ–‡ä»¶")]),_:1})]),n("li",null,[a(t,{to:"#åˆ›å»º-messagesource"},{default:e(()=>[s("åˆ›å»º MessageSource")]),_:1})]),n("li",null,[a(t,{to:"#å®ç°å¤šè¯­è¨€"},{default:e(()=>[s("å®ç°å¤šè¯­è¨€")]),_:1})]),n("li",null,[a(t,{to:"#åˆ‡æ¢-locale"},{default:e(()=>[s("åˆ‡æ¢ Locale")]),_:1})]),n("li",null,[a(t,{to:"#ç»ƒä¹ -5"},{default:e(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(t,{to:"#å°ç»“-5"},{default:e(()=>[s("å°ç»“")]),_:1})])])]),n("li",null,[a(t,{to:"#ğŸ€-å¼‚æ­¥å¤„ç†"},{default:e(()=>[s("ğŸ€ å¼‚æ­¥å¤„ç†")]),_:1}),n("ul",null,[n("li",null,[a(t,{to:"#ä½¿ç”¨-filter"},{default:e(()=>[s("ä½¿ç”¨ Filter")]),_:1})]),n("li",null,[a(t,{to:"#ç»ƒä¹ -6"},{default:e(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(t,{to:"#å°ç»“-6"},{default:e(()=>[s("å°ç»“")]),_:1})])])]),n("li",null,[a(t,{to:"#ğŸ€-ä½¿ç”¨-websocket"},{default:e(()=>[s("ğŸ€ ä½¿ç”¨ WebSocket")]),_:1}),n("ul",null,[n("li",null,[a(t,{to:"#å¤„ç†-websocket-è¿æ¥"},{default:e(()=>[s("å¤„ç† WebSocket è¿æ¥")]),_:1})]),n("li",null,[a(t,{to:"#å®¢æˆ·ç«¯å¼€å‘"},{default:e(()=>[s("å®¢æˆ·ç«¯å¼€å‘")]),_:1})]),n("li",null,[a(t,{to:"#ç»ƒä¹ -7"},{default:e(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(t,{to:"#å°ç»“-7"},{default:e(()=>[s("å°ç»“")]),_:1})])])])])])]),n("p",null,[s("åœ¨ "),a(c,{to:"/1-Java/21_Spring%E5%BC%80%E5%8F%91/docs/1-Java/20_Web%E5%BC%80%E5%8F%91/"},{default:e(()=>[s("Web å¼€å‘")]),_:1}),s(" ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯¦ç»†ä»‹ç»äº† JavaEE ä¸­ Web å¼€å‘çš„åŸºç¡€ï¼šServletã€‚å…·ä½“åœ°è¯´ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š")]),M,_,n("p",null,[s("æˆ‘ä»¬åœ¨ "),n("a",R,[s("MVC å¼€å‘"),a(i)]),s(" å’Œ"),n("a",A,[s("MVC é«˜çº§å¼€å‘"),a(i)]),s("å·²ç»ç”±æµ…å…¥æ·±åœ°ä»‹ç»äº†å¦‚ä½•ç¼–å†™ MVC æ¡†æ¶ã€‚å½“ç„¶ï¼Œè‡ªå·±å†™çš„ MVC ä¸»è¦æ˜¯ç†è§£åŸç†ï¼Œè¦å®ç°ä¸€ä¸ªåŠŸèƒ½å…¨é¢çš„ MVC éœ€è¦å¤§é‡çš„å·¥ä½œä»¥åŠå¹¿æ³›çš„æµ‹è¯•ã€‚")]),F,n("ul",null,[n("li",null,[n("a",T,[s("Struts"),a(i)]),s("ï¼šæœ€å¤è€çš„ä¸€ä¸ª MVC æ¡†æ¶ï¼Œç›®å‰ç‰ˆæœ¬æ˜¯ 2ï¼Œå’Œ 1.x æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼›")]),H,n("li",null,[n("a",V,[s("Turbine"),a(i)]),s("ï¼šä¸€ä¸ªé‡åº¦ä½¿ç”¨ Velocityï¼Œå¼ºè°ƒå¸ƒå±€çš„ MVC æ¡†æ¶ï¼›")]),L]),n("p",null,[s("Spring è™½ç„¶éƒ½å¯ä»¥é›†æˆä»»ä½• Web æ¡†æ¶ï¼Œä½†æ˜¯ï¼ŒSpring æœ¬èº«ä¹Ÿå¼€å‘äº†ä¸€ä¸ª MVC æ¡†æ¶ï¼Œå°±å« "),n("a",W,[s("Spring MVC"),a(i)]),s("ã€‚è¿™ä¸ª MVC æ¡†æ¶è®¾è®¡å¾—è¶³å¤Ÿä¼˜ç§€ä»¥è‡³äºæˆ‘ä»¬å·²ç»ä¸æƒ³å†è´¹åŠ²å»é›†æˆç±»ä¼¼ Struts è¿™æ ·çš„æ¡†æ¶äº†ã€‚")]),j,I,n("p",null,[s("æˆ‘ä»¬åœ¨å‰é¢ä»‹ç» "),n("a",O,[s("Web å¼€å‘"),a(i)]),s(" æ—¶å·²ç»è®²è¿‡äº† Java Web çš„åŸºç¡€ï¼šServlet å®¹å™¨ï¼Œä»¥åŠæ ‡å‡†çš„ Servlet ç»„ä»¶ï¼š")]),P,E,n("p",null,[s("åœ¨ "),n("a",U,[s("MVC é«˜çº§å¼€å‘"),a(i)]),s(" ä¸­ï¼Œæˆ‘ä»¬æ‰‹æ’¸äº†ä¸€ä¸ª MVC æ¡†æ¶ï¼Œæ¥å£å’Œ Spring MVC ç±»ä¼¼ã€‚å¦‚æœç›´æ¥ä½¿ç”¨ Spring MVCï¼Œæˆ‘ä»¬å†™å‡ºæ¥çš„ä»£ç ç±»ä¼¼ï¼š")]),B,n("p",null,[s("ä½†æ˜¯ï¼Œåœ¨ Servlet è§„èŒƒä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ "),n("a",D,[s("ä½¿ç”¨ Filter"),a(i)]),s("ã€‚å¦‚æœè¦åœ¨ Spring MVC ä¸­ä½¿ç”¨ "),J,s("ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ")]),N,n("p",null,[s("è¿™å°±æ˜¯ä¸€ä¸ª "),n("a",z,[s("ä»£ç†æ¨¡å¼"),a(i)]),s(" çš„ç®€å•åº”ç”¨ã€‚æˆ‘ä»¬ç”»ä¸ªå›¾è¡¨ç¤ºå®ƒä»¬ä¹‹é—´çš„å¼•ç”¨å…³ç³»å¦‚ä¸‹ï¼š")]),G,n("p",null,[s("å…³äº CORS çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ "),n("a",Y,[s("MDN æ–‡æ¡£"),a(i)]),s("ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚")]),Z,n("p",null,[s("ç¬¬ä¸‰ç§æ–¹æ³•æ˜¯ä½¿ç”¨ Spring æä¾›çš„ "),X,s("ï¼Œæˆ‘ä»¬åœ¨ "),n("a",Q,[s("é›†æˆ Filter"),a(i)]),s(" ä¸­è¯¦ç»†ä»‹ç»äº†å°† Spring å®¹å™¨å†…ç½®çš„ Bean æš´éœ²ä¸º Servlet å®¹å™¨çš„ Filter çš„æ–¹æ³•ï¼Œç”±äºè¿™ç§é…ç½®æ–¹å¼éœ€è¦ä¿®æ”¹ "),$,s("ï¼Œä¹Ÿæ¯”è¾ƒç¹çï¼Œæ‰€ä»¥æ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ã€‚")]),K,n("p",null,[s("æ­¤å¤–ï¼ŒServlet 3.0 è§„èŒƒæ·»åŠ çš„å¼‚æ­¥æ”¯æŒæ˜¯é’ˆå¯¹åŒæ­¥æ¨¡å‹æ‰“äº†ä¸€ä¸ª â€œè¡¥ä¸â€ï¼Œè™½ç„¶å¯ä»¥å¼‚æ­¥å¤„ç†è¯·æ±‚ï¼Œä½†é«˜å¹¶å‘å¼‚æ­¥è¯·æ±‚æ—¶ï¼Œå®ƒçš„å¤„ç†æ•ˆç‡å¹¶ä¸é«˜ï¼Œå› ä¸ºè¿™ç§å¼‚æ­¥æ¨¡å‹å¹¶æ²¡æœ‰ç”¨åˆ°çœŸæ­£çš„â€œåŸç”Ÿâ€ å¼‚æ­¥ã€‚Java æ ‡å‡†åº“æä¾›äº†å°è£…æ“ä½œç³»ç»Ÿçš„å¼‚æ­¥ IO åŒ… "),nn,s("ï¼Œæ˜¯çœŸæ­£çš„å¤šè·¯å¤ç”¨ IO æ¨¡å‹ï¼Œå¯ä»¥ç”¨å°‘é‡çº¿ç¨‹æ”¯æŒå¤§é‡å¹¶å‘ã€‚ä½¿ç”¨ NIO ç¼–ç¨‹å¤æ‚åº¦æ¯”åŒæ­¥ IO é«˜å¾ˆå¤šï¼Œå› æ­¤æˆ‘ä»¬å¾ˆå°‘ç›´æ¥ä½¿ç”¨ NIOã€‚ç›¸åï¼Œå¤§éƒ¨åˆ†éœ€è¦é«˜æ€§èƒ½å¼‚æ­¥ IO çš„åº”ç”¨ç¨‹åºä¼šé€‰æ‹© "),n("a",sn,[s("Netty"),a(i)]),s(" è¿™æ ·çš„æ¡†æ¶ï¼Œå®ƒåŸºäº NIO æä¾›äº†æ›´æ˜“äºä½¿ç”¨çš„ APIï¼Œæ–¹ä¾¿å¼€å‘å¼‚æ­¥åº”ç”¨ç¨‹åºã€‚")]),an])}const pn=p(w,[["render",en],["__file","4.html.vue"]]);export{pn as default};
