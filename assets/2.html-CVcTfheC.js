import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as o,o as l,c as u,a as n,b as a,w as p,e as s,d as c}from"./app-CvlAI_tu.js";const d={},r={class:"hint-container details"},k=n("summary",null,"ç›®å½•",-1),v={class:"table-of-contents"},m=c(`<p>AOP æ˜¯ Aspect Oriented Programmingï¼Œå³é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚</p><p>é‚£ä»€ä¹ˆæ˜¯ AOPï¼Ÿ</p><p>æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ OOPï¼šObject Oriented Programmingï¼ŒOOP ä½œä¸ºé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¨¡å¼ï¼Œè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼ŒOOP çš„ä¸»è¦åŠŸèƒ½æ˜¯æ•°æ®å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚</p><p>è€Œ AOP æ˜¯ä¸€ç§æ–°çš„ç¼–ç¨‹æ–¹å¼ï¼Œå®ƒå’Œ OOP ä¸åŒï¼ŒOOP æŠŠç³»ç»Ÿçœ‹ä½œå¤šä¸ªå¯¹è±¡çš„äº¤äº’ï¼ŒAOP æŠŠç³»ç»Ÿåˆ†è§£ä¸ºä¸åŒçš„å…³æ³¨ç‚¹ï¼Œæˆ–è€…ç§°ä¹‹ä¸ºåˆ‡é¢ï¼ˆAspectï¼‰ã€‚</p><p>è¦ç†è§£ AOP çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å…ˆç”¨ OOP ä¸¾ä¾‹ï¼Œæ¯”å¦‚ä¸€ä¸ªä¸šåŠ¡ç»„ä»¶ <code>BookService</code>ï¼Œå®ƒæœ‰å‡ ä¸ªä¸šåŠ¡æ–¹æ³•ï¼š</p><ul><li>createBookï¼šæ·»åŠ æ–°çš„ Bookï¼›</li><li>updateBookï¼šä¿®æ”¹ Bookï¼›</li><li>deleteBookï¼šåˆ é™¤ Bookã€‚</li></ul><p>å¯¹æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ï¼Œä¾‹å¦‚ï¼Œ<code>createBook()</code>ï¼Œé™¤äº†ä¸šåŠ¡é€»è¾‘ï¼Œè¿˜éœ€è¦å®‰å…¨æ£€æŸ¥ã€æ—¥å¿—è®°å½•å’Œäº‹åŠ¡å¤„ç†ï¼Œå®ƒçš„ä»£ç åƒè¿™æ ·ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createBook</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">securityCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Transaction</span> tx <span class="token operator">=</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ ¸å¿ƒä¸šåŠ¡é€»è¾‘</span>
            tx<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tx<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;created book:&quot;</span> <span class="token operator">+</span> book<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»§ç»­ç¼–å†™ <code>updateBook()</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateBook</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">securityCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Transaction</span> tx <span class="token operator">=</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ ¸å¿ƒä¸šåŠ¡é€»è¾‘</span>
            tx<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tx<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;updated book:&quot;</span> <span class="token operator">+</span> book<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºå®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰ä»£ç ï¼Œå®ƒä»¬ä¼šé‡å¤å‡ºç°åœ¨æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­ã€‚ä½¿ç”¨ OOPï¼Œæˆ‘ä»¬å¾ˆéš¾å°†è¿™äº›å››å¤„åˆ†æ•£çš„ä»£ç æ¨¡å—åŒ–ã€‚</p><p>è€ƒå¯Ÿä¸šåŠ¡æ¨¡å‹å¯ä»¥å‘ç°ï¼Œ<code>BookService</code> å…³å¿ƒçš„æ˜¯è‡ªèº«çš„æ ¸å¿ƒé€»è¾‘ï¼Œä½†æ•´ä¸ªç³»ç»Ÿè¿˜è¦æ±‚å…³æ³¨å®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å®é™…ä¸Š â€œæ¨ªè·¨â€ å¤šä¸ªä¸šåŠ¡æ–¹æ³•ï¼Œä¸ºäº†å®ç°è¿™äº›åŠŸèƒ½ï¼Œä¸å¾—ä¸åœ¨æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸Šé‡å¤ç¼–å†™ä»£ç ã€‚</p>`,12),b={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017",target:"_blank",rel:"noopener noreferrer"},g=c(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityCheckBookService</span> <span class="token keyword">implements</span> <span class="token class-name">BookService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BookService</span> target<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SecurityCheckBookService</span><span class="token punctuation">(</span><span class="token class-name">BookService</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createBook</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">securityCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        target<span class="token punctuation">.</span><span class="token function">createBook</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateBook</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">securityCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        target<span class="token punctuation">.</span><span class="token function">updateBook</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteBook</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">securityCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        target<span class="token punctuation">.</span><span class="token function">deleteBook</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">securityCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œå¿…é¡»å…ˆæŠ½å–æ¥å£ï¼Œç„¶åï¼Œé’ˆå¯¹æ¯ä¸ªæ–¹æ³•å®ç° Proxyã€‚</p><p>å¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œæ—¢ç„¶ <code>SecurityCheckBookService</code> çš„ä»£ç éƒ½æ˜¯æ ‡å‡†çš„ Proxy æ ·æ¿ä»£ç ï¼Œä¸å¦‚æŠŠæƒé™æ£€æŸ¥è§†ä½œä¸€ç§åˆ‡é¢ï¼ˆAspectï¼‰ï¼ŒæŠŠæ—¥å¿—ã€äº‹åŠ¡ä¹Ÿè§†ä¸ºåˆ‡é¢ï¼Œç„¶åï¼Œä»¥æŸç§è‡ªåŠ¨åŒ–çš„æ–¹å¼ï¼ŒæŠŠåˆ‡é¢ç»‡å…¥åˆ°æ ¸å¿ƒé€»è¾‘ä¸­ï¼Œå®ç° Proxy æ¨¡å¼ã€‚</p><p>å¦‚æœæˆ‘ä»¬ä»¥ AOP çš„è§†è§’æ¥ç¼–å†™ä¸Šè¿°ä¸šåŠ¡ï¼Œå¯ä»¥ä¾æ¬¡å®ç°ï¼š</p><ol><li>æ ¸å¿ƒé€»è¾‘ï¼Œå³ BookServiceï¼›</li><li>åˆ‡é¢é€»è¾‘ï¼Œå³ï¼š</li><li>æƒé™æ£€æŸ¥çš„ Aspectï¼›</li><li>æ—¥å¿—çš„ Aspectï¼›</li><li>äº‹åŠ¡çš„ Aspectã€‚</li></ol><p>ç„¶åï¼Œä»¥æŸç§æ–¹å¼ï¼Œè®©æ¡†æ¶æ¥æŠŠä¸Šè¿° 3 ä¸ª Aspect ä»¥ Proxy çš„æ–¹å¼ â€œç»‡å…¥â€ åˆ° <code>BookService</code> ä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±ä¸å¿…ç¼–å†™å¤æ‚è€Œå†—é•¿çš„ Proxy æ¨¡å¼ã€‚</p><h2 id="ğŸ€-aop-åŸç†" tabindex="-1"><a class="header-anchor" href="#ğŸ€-aop-åŸç†" aria-hidden="true">#</a> ğŸ€ AOP åŸç†</h2><p>å¦‚ä½•æŠŠåˆ‡é¢ç»‡å…¥åˆ°æ ¸å¿ƒé€»è¾‘ä¸­ï¼Ÿè¿™æ­£æ˜¯ AOP éœ€è¦è§£å†³çš„é—®é¢˜ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯è·å¾—äº† <code>BookService</code> çš„å¼•ç”¨ï¼Œå½“è°ƒç”¨ <code>bookService.createBook()</code> æ—¶ï¼Œå¦‚ä½•å¯¹è°ƒç”¨æ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œå¹¶åœ¨æ‹¦æˆªå‰åè¿›è¡Œå®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰å¤„ç†ï¼Œå°±ç›¸å½“äºå®Œæˆäº†æ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½ã€‚</p><p>åœ¨ Java å¹³å°ä¸Šï¼Œå¯¹äº AOP çš„ç»‡å…¥ï¼Œæœ‰ 3 ç§æ–¹å¼ï¼š</p><ol><li>ç¼–è¯‘æœŸï¼šåœ¨ç¼–è¯‘æ—¶ï¼Œç”±ç¼–è¯‘å™¨æŠŠåˆ‡é¢è°ƒç”¨ç¼–è¯‘è¿›å­—èŠ‚ç ï¼Œè¿™ç§æ–¹å¼éœ€è¦å®šä¹‰æ–°çš„å…³é”®å­—å¹¶æ‰©å±•ç¼–è¯‘å™¨ï¼ŒAspectJ å°±æ‰©å±•äº† Java ç¼–è¯‘å™¨ï¼Œä½¿ç”¨å…³é”®å­— aspect æ¥å®ç°ç»‡å…¥ï¼›</li><li>ç±»åŠ è½½å™¨ï¼šåœ¨ç›®æ ‡ç±»è¢«è£…è½½åˆ° JVM æ—¶ï¼Œé€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„ç±»åŠ è½½å™¨ï¼Œå¯¹ç›®æ ‡ç±»çš„å­—èŠ‚ç é‡æ–° â€œå¢å¼ºâ€ï¼›</li><li>è¿è¡ŒæœŸï¼šç›®æ ‡å¯¹è±¡å’Œåˆ‡é¢éƒ½æ˜¯æ™®é€š Java ç±»ï¼Œé€šè¿‡ JVM çš„åŠ¨æ€ä»£ç†åŠŸèƒ½æˆ–è€…ç¬¬ä¸‰æ–¹åº“å®ç°è¿è¡ŒæœŸåŠ¨æ€ç»‡å…¥ã€‚</li></ol>`,10),y={href:"https://github.com/cglib/cglib",target:"_blank",rel:"noopener noreferrer"},h={href:"https://www.javassist.org/",target:"_blank",rel:"noopener noreferrer"},S=c(`<p>AOP æŠ€æœ¯çœ‹ä¸Šå»æ¯”è¾ƒç¥ç§˜ï¼Œä½†å®é™…ä¸Šï¼Œå®ƒæœ¬è´¨å°±æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼Œè®©æˆ‘ä»¬æŠŠä¸€äº›å¸¸ç”¨åŠŸèƒ½å¦‚æƒé™æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰ï¼Œä»æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­å‰¥ç¦»å‡ºæ¥ã€‚</p><p>éœ€è¦ç‰¹åˆ«æŒ‡å‡ºçš„æ˜¯ï¼ŒAOP å¯¹äºè§£å†³ç‰¹å®šé—®é¢˜ï¼Œä¾‹å¦‚äº‹åŠ¡ç®¡ç†éå¸¸æœ‰ç”¨ï¼Œè¿™æ˜¯å› ä¸ºåˆ†æ•£åœ¨å„å¤„çš„äº‹åŠ¡ä»£ç å‡ ä¹æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå¹¶ä¸”å®ƒä»¬éœ€è¦çš„å‚æ•°ï¼ˆJDBC çš„ Connectionï¼‰ä¹Ÿæ˜¯å›ºå®šçš„ã€‚å¦ä¸€äº›ç‰¹å®šé—®é¢˜ï¼Œå¦‚æ—¥å¿—ï¼Œå°±ä¸é‚£ä¹ˆå®¹æ˜“å®ç°ï¼Œå› ä¸ºæ—¥å¿—è™½ç„¶ç®€å•ï¼Œä½†æ‰“å°æ—¥å¿—çš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦æ•è·å±€éƒ¨å˜é‡ï¼Œå¦‚æœä½¿ç”¨ AOP å®ç°æ—¥å¿—ï¼Œæˆ‘ä»¬åªèƒ½è¾“å‡ºå›ºå®šæ ¼å¼çš„æ—¥å¿—ï¼Œå› æ­¤ï¼Œä½¿ç”¨ AOP æ—¶ï¼Œå¿…é¡»é€‚åˆç‰¹å®šçš„åœºæ™¯ã€‚</p><h2 id="ğŸ€-è£…é…-aop" tabindex="-1"><a class="header-anchor" href="#ğŸ€-è£…é…-aop" aria-hidden="true">#</a> ğŸ€ è£…é… AOP</h2><p>åœ¨ AOP ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸‹é¢çš„æ¦‚å¿µï¼š</p><ul><li>Aspectï¼šåˆ‡é¢ï¼Œå³ä¸€ä¸ªæ¨ªè·¨å¤šä¸ªæ ¸å¿ƒé€»è¾‘çš„åŠŸèƒ½ï¼Œæˆ–è€…ç§°ä¹‹ä¸ºç³»ç»Ÿå…³æ³¨ç‚¹ï¼›</li><li>Joinpointï¼šè¿æ¥ç‚¹ï¼Œå³å®šä¹‰åœ¨åº”ç”¨ç¨‹åºæµç¨‹çš„ä½•å¤„æ’å…¥åˆ‡é¢çš„æ‰§è¡Œï¼›</li><li>Pointcutï¼šåˆ‡å…¥ç‚¹ï¼Œå³ä¸€ç»„è¿æ¥ç‚¹çš„é›†åˆï¼›</li><li>Adviceï¼šå¢å¼ºï¼ŒæŒ‡ç‰¹å®šè¿æ¥ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼›</li><li>Introductionï¼šå¼•ä»‹ï¼ŒæŒ‡ä¸ºä¸€ä¸ªå·²æœ‰çš„ Java å¯¹è±¡åŠ¨æ€åœ°å¢åŠ æ–°çš„æ¥å£ï¼›</li><li>Weavingï¼šç»‡å…¥ï¼ŒæŒ‡å°†åˆ‡é¢æ•´åˆåˆ°ç¨‹åºçš„æ‰§è¡Œæµç¨‹ä¸­ï¼›</li><li>Interceptorï¼šæ‹¦æˆªå™¨ï¼Œæ˜¯ä¸€ç§å®ç°å¢å¼ºçš„æ–¹å¼ï¼›</li><li>Target Objectï¼šç›®æ ‡å¯¹è±¡ï¼Œå³çœŸæ­£æ‰§è¡Œä¸šåŠ¡çš„æ ¸å¿ƒé€»è¾‘å¯¹è±¡ï¼›</li><li>AOP Proxyï¼šAOP ä»£ç†ï¼Œæ˜¯å®¢æˆ·ç«¯æŒæœ‰çš„å¢å¼ºåçš„å¯¹è±¡å¼•ç”¨ã€‚</li></ul><p>çœ‹å®Œä¸Šè¿°æœ¯è¯­ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å¯¹ AOP æœ‰äº†è¿›ä¸€æ­¥çš„å›°æƒ‘ï¼Ÿå…¶å®ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒ AOP åˆ›é€ çš„ â€œæœ¯è¯­â€ï¼Œåªéœ€è¦ç†è§£ AOP æœ¬è´¨ä¸Šåªæ˜¯ä¸€ç§ä»£ç†æ¨¡å¼çš„å®ç°æ–¹å¼ï¼Œåœ¨ Spring çš„å®¹å™¨ä¸­å®ç° AOP ç‰¹åˆ«æ–¹ä¾¿ã€‚</p><p>æˆ‘ä»¬ä»¥ <code>UserService</code> å’Œ <code>MailService</code> ä¸ºä¾‹ï¼Œè¿™ä¸¤ä¸ªå±äºæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡ç»™ <code>UserService</code> çš„æ¯ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œå‰æ·»åŠ æ—¥å¿—ï¼Œç»™ <code>MailService</code> çš„æ¯ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œå‰åæ·»åŠ æ—¥å¿—ï¼Œåœ¨ Spring ä¸­ï¼Œéœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ Maven å¼•å…¥ Spring å¯¹ AOP çš„æ”¯æŒï¼š</p><ul><li>org.springframework:spring-aspects:6.0.0</li></ul><p>ä¸Šè¿°ä¾èµ–ä¼šè‡ªåŠ¨å¼•å…¥ AspectJï¼Œä½¿ç”¨ AspectJ å®ç° AOP æ¯”è¾ƒæ–¹ä¾¿ï¼Œå› ä¸ºå®ƒçš„å®šä¹‰æ¯”è¾ƒç®€å•ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª <code>LoggingAspect</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggingAspect</span> <span class="token punctuation">{</span>
    <span class="token comment">// åœ¨æ‰§è¡Œ UserService çš„æ¯ä¸ªæ–¹æ³•å‰æ‰§è¡Œ:</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;execution(public * com.itranswarp.learnjava.service.UserService.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAccessCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;[Before] do access check...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åœ¨æ‰§è¡Œ MailService çš„æ¯ä¸ªæ–¹æ³•å‰åæ‰§è¡Œ:</span>
    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;execution(public * com.itranswarp.learnjava.service.MailService.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doLogging</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;[Around] start&quot;</span> <span class="token operator">+</span> pjp<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> retVal <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;[Around] done&quot;</span> <span class="token operator">+</span> pjp<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è§‚å¯Ÿ <code>doAccessCheck()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>@Before</code> æ³¨è§£ï¼Œåé¢çš„å­—ç¬¦ä¸²æ˜¯å‘Šè¯‰ AspectJ åº”è¯¥åœ¨ä½•å¤„æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œè¿™é‡Œå†™çš„æ„æ€æ˜¯ï¼šæ‰§è¡Œ <code>UserService</code> çš„æ¯ä¸ª <code>public</code> æ–¹æ³•å‰æ‰§è¡Œ <code>doAccessCheck()</code> ä»£ç ã€‚</p><p>å†è§‚å¯Ÿ <code>doLogging()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>@Around</code> æ³¨è§£ï¼Œå®ƒå’Œ <code>@Before</code> ä¸åŒï¼Œ<code>@Around</code> å¯ä»¥å†³å®šæ˜¯å¦æ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åœ¨ <code>doLogging()</code> å†…éƒ¨å…ˆæ‰“å°æ—¥å¿—ï¼Œå†è°ƒç”¨æ–¹æ³•ï¼Œæœ€åæ‰“å°æ—¥å¿—åè¿”å›ç»“æœã€‚</p><p>åœ¨ <code>LoggingAspect</code> ç±»çš„å£°æ˜å¤„ï¼Œé™¤äº†ç”¨ <code>@Component</code> è¡¨ç¤ºå®ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª Bean å¤–ï¼Œæˆ‘ä»¬å†åŠ ä¸Š <code>@Aspect</code> æ³¨è§£ï¼Œè¡¨ç¤ºå®ƒçš„ <code>@Before</code> æ ‡æ³¨çš„æ–¹æ³•éœ€è¦æ³¨å…¥åˆ° <code>UserService</code> çš„æ¯ä¸ª <code>public</code> æ–¹æ³•æ‰§è¡Œå‰ï¼Œ<code>@Around</code> æ ‡æ³¨çš„æ–¹æ³•éœ€è¦æ³¨å…¥åˆ° <code>MailService</code> çš„æ¯ä¸ª <code>public</code> æ–¹æ³•æ‰§è¡Œå‰åã€‚</p><p>ç´§æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦ç»™ <code>@Configuration</code> ç±»åŠ ä¸Šä¸€ä¸ª <code>@EnableAspectJAutoProxy</code> æ³¨è§£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Spring çš„ IoC å®¹å™¨çœ‹åˆ°è¿™ä¸ªæ³¨è§£ï¼Œå°±ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¸¦æœ‰ <code>@Aspect</code> çš„ Beanï¼Œç„¶åæ ¹æ®æ¯ä¸ªæ–¹æ³•çš„ <code>@Before</code>ã€<code>@Around</code> ç­‰æ³¨è§£æŠŠ AOP æ³¨å…¥åˆ°ç‰¹å®šçš„ Bean ä¸­ã€‚æ‰§è¡Œä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>Before<span class="token punctuation">]</span> <span class="token keyword">do</span> access check<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>Around<span class="token punctuation">]</span> start void com.itranswarp.learnjava.service.MailService.sendRegistrationMail<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
Welcome, test<span class="token operator">!</span>
<span class="token punctuation">[</span>Around<span class="token punctuation">]</span> <span class="token keyword">done</span> void com.itranswarp.learnjava.service.MailService.sendRegistrationMail<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
<span class="token punctuation">[</span>Before<span class="token punctuation">]</span> <span class="token keyword">do</span> access check<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>Around<span class="token punctuation">]</span> start void com.itranswarp.learnjava.service.MailService.sendLoginMail<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
Hi, Bob<span class="token operator">!</span> You are logged <span class="token keyword">in</span> at <span class="token number">2020</span>-02-14T23:13:52.167996+08:00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
<span class="token punctuation">[</span>Around<span class="token punctuation">]</span> <span class="token keyword">done</span> void com.itranswarp.learnjava.service.MailService.sendLoginMail<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™è¯´æ˜æ‰§è¡Œä¸šåŠ¡é€»è¾‘å‰åï¼Œç¡®å®æ‰§è¡Œäº†æˆ‘ä»¬å®šä¹‰çš„ Aspectï¼ˆå³ <code>LoggingAspect</code> çš„æ–¹æ³•ï¼‰ã€‚</p><p>æœ‰äº›ç«¥é‹ä¼šé—®ï¼Œ<code>LoggingAspect</code> å®šä¹‰çš„æ–¹æ³•ï¼Œæ˜¯å¦‚ä½•æ³¨å…¥åˆ°å…¶ä»– Bean çš„å‘¢ï¼Ÿ</p><p>å…¶å® AOP çš„åŸç†éå¸¸ç®€å•ã€‚æˆ‘ä»¬ä»¥ <code>LoggingAspect.doAccessCheck()</code> ä¸ºä¾‹ï¼Œè¦æŠŠå®ƒæ³¨å…¥åˆ° <code>UserService</code> çš„æ¯ä¸ª <code>public</code> æ–¹æ³•ä¸­ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ç¼–å†™ä¸€ä¸ªå­ç±»ï¼Œå¹¶æŒæœ‰åŸå§‹å®ä¾‹çš„å¼•ç”¨ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">UserServiceAopProxy</span> <span class="token keyword">extends</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> target<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">LoggingAspect</span> aspect<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UserServiceAopProxy</span><span class="token punctuation">(</span><span class="token class-name">UserService</span> target<span class="token punctuation">,</span> <span class="token class-name">LoggingAspect</span> aspect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>aspect <span class="token operator">=</span> aspect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å…ˆæ‰§è¡Œ Aspect çš„ä»£ç :</span>
        aspect<span class="token punctuation">.</span><span class="token function">doAccessCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å†æ‰§è¡Œ UserService çš„é€»è¾‘:</span>
        <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        aspect<span class="token punctuation">.</span><span class="token function">doAccessCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™äº›éƒ½æ˜¯ Spring å®¹å™¨å¯åŠ¨æ—¶ä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ›å»ºçš„æ³¨å…¥äº† Aspect çš„å­ç±»ï¼Œå®ƒå–ä»£äº†åŸå§‹çš„ <code>UserService</code>ï¼ˆåŸå§‹çš„ <code>UserService</code> å®ä¾‹ä½œä¸ºå†…éƒ¨å˜é‡éšè—åœ¨ <code>UserServiceAopProxy</code> ä¸­ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æ‰“å°ä» Spring å®¹å™¨è·å–çš„ <code>UserService</code> å®ä¾‹ç±»å‹ï¼Œå®ƒç±»ä¼¼ <code>UserService$$EnhancerBySpringCGLIB$$1f44e01c</code>ï¼Œå®é™…ä¸Šæ˜¯ Spring ä½¿ç”¨ CGLIB åŠ¨æ€åˆ›å»ºçš„å­ç±»ï¼Œä½†å¯¹äºè°ƒç”¨æ–¹æ¥è¯´ï¼Œæ„Ÿè§‰ä¸åˆ°ä»»ä½•åŒºåˆ«ã€‚</p><div class="hint-container note"><p class="hint-container-title">æ³¨</p><p>Spring å¯¹æ¥å£ç±»å‹ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¯¹æ™®é€šç±»ä½¿ç”¨ CGLIB åˆ›å»ºå­ç±»ã€‚å¦‚æœä¸€ä¸ª Bean çš„ class æ˜¯ finalï¼ŒSpring å°†æ— æ³•ä¸ºå…¶åˆ›å»ºå­ç±»ã€‚</p></div><p>å¯è§ï¼Œè™½ç„¶ Spring å®¹å™¨å†…éƒ¨å®ç° AOP çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼ˆéœ€è¦ä½¿ç”¨ AspectJ è§£ææ³¨è§£ï¼Œå¹¶é€šè¿‡ CGLIB å®ç°ä»£ç†ç±»ï¼‰ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨ AOP éå¸¸ç®€å•ï¼Œä¸€å…±éœ€è¦ä¸‰æ­¥ï¼š</p><ol><li>å®šä¹‰æ‰§è¡Œæ–¹æ³•ï¼Œå¹¶åœ¨æ–¹æ³•ä¸Šé€šè¿‡ AspectJ çš„æ³¨è§£å‘Šè¯‰ Spring åº”è¯¥åœ¨ä½•å¤„è°ƒç”¨æ­¤æ–¹æ³•ï¼›</li><li>æ ‡è®° <code>@Component</code> å’Œ <code>@Aspect</code>ï¼›</li><li>åœ¨ <code>@Configuration</code> ç±»ä¸Šæ ‡æ³¨ <code>@EnableAspectJAutoProxy</code>ã€‚</li></ol>`,27),w={href:"https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-pointcuts-examples",target:"_blank",rel:"noopener noreferrer"},f=c(`<p>Spring ä¹Ÿæä¾›å…¶ä»–æ–¹æ³•æ¥è£…é… AOPï¼Œä½†éƒ½æ²¡æœ‰ä½¿ç”¨ AspectJ æ³¨è§£çš„æ–¹å¼æ¥å¾—ç®€æ´æ˜äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å†ä½œä»‹ç»ã€‚</p><h3 id="æ‹¦æˆªå™¨ç±»å‹" tabindex="-1"><a class="header-anchor" href="#æ‹¦æˆªå™¨ç±»å‹" aria-hidden="true">#</a> æ‹¦æˆªå™¨ç±»å‹</h3><p>é¡¾åæ€ä¹‰ï¼Œæ‹¦æˆªå™¨æœ‰ä»¥ä¸‹ç±»å‹ï¼š</p><ul><li>@Beforeï¼šè¿™ç§æ‹¦æˆªå™¨å…ˆæ‰§è¡Œæ‹¦æˆªä»£ç ï¼Œå†æ‰§è¡Œç›®æ ‡ä»£ç ã€‚å¦‚æœæ‹¦æˆªå™¨æŠ›å¼‚å¸¸ï¼Œé‚£ä¹ˆç›®æ ‡ä»£ç å°±ä¸æ‰§è¡Œäº†ï¼›</li><li>@Afterï¼šè¿™ç§æ‹¦æˆªå™¨å…ˆæ‰§è¡Œç›®æ ‡ä»£ç ï¼Œå†æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ã€‚æ— è®ºç›®æ ‡ä»£ç æ˜¯å¦æŠ›å¼‚å¸¸ï¼Œæ‹¦æˆªå™¨ä»£ç éƒ½ä¼šæ‰§è¡Œï¼›</li><li>@AfterReturningï¼šå’Œ @After ä¸åŒçš„æ˜¯ï¼Œåªæœ‰å½“ç›®æ ‡ä»£ç æ­£å¸¸è¿”å›æ—¶ï¼Œæ‰æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ï¼›</li><li>@AfterThrowingï¼šå’Œ @After ä¸åŒçš„æ˜¯ï¼Œåªæœ‰å½“ç›®æ ‡ä»£ç æŠ›å‡ºäº†å¼‚å¸¸æ—¶ï¼Œæ‰æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ï¼›</li><li>@Aroundï¼šèƒ½å®Œå…¨æ§åˆ¶ç›®æ ‡ä»£ç æ˜¯å¦æ‰§è¡Œï¼Œå¹¶å¯ä»¥åœ¨æ‰§è¡Œå‰åã€æŠ›å¼‚å¸¸åæ‰§è¡Œä»»æ„æ‹¦æˆªä»£ç ï¼Œå¯ä»¥è¯´æ˜¯åŒ…å«äº†ä¸Šé¢æ‰€æœ‰åŠŸèƒ½ã€‚</li></ul><h3 id="ç»ƒä¹ " tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ " aria-hidden="true">#</a> ç»ƒä¹ </h3><p>ä½¿ç”¨ AOP å®ç°æ—¥å¿—</p><h3 id="å°ç»“" tabindex="-1"><a class="header-anchor" href="#å°ç»“" aria-hidden="true">#</a> å°ç»“</h3><p>åœ¨ Spring å®¹å™¨ä¸­ä½¿ç”¨ AOP éå¸¸ç®€å•ï¼Œåªéœ€è¦å®šä¹‰æ‰§è¡Œæ–¹æ³•ï¼Œå¹¶ç”¨ AspectJ çš„æ³¨è§£æ ‡æ³¨åº”è¯¥åœ¨ä½•å¤„è§¦å‘å¹¶æ‰§è¡Œã€‚</p><p>Spring é€šè¿‡ CGLIB åŠ¨æ€åˆ›å»ºå­ç±»ç­‰æ–¹å¼æ¥å®ç° AOP ä»£ç†æ¨¡å¼ï¼Œå¤§å¤§ç®€åŒ–äº†ä»£ç ã€‚</p><h2 id="ğŸ€-ä½¿ç”¨æ³¨è§£è£…é…-aop" tabindex="-1"><a class="header-anchor" href="#ğŸ€-ä½¿ç”¨æ³¨è§£è£…é…-aop" aria-hidden="true">#</a> ğŸ€ ä½¿ç”¨æ³¨è§£è£…é… AOP</h2><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²è§£äº†ä½¿ç”¨ AspectJ çš„æ³¨è§£ï¼Œå¹¶é…åˆä¸€ä¸ªå¤æ‚çš„ <code>execution(* xxx.Xyz.*(..))</code> è¯­æ³•æ¥å®šä¹‰åº”è¯¥å¦‚ä½•è£…é… AOPã€‚</p><p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™ç§å†™æ³•å…¶å®å¾ˆå°‘ä½¿ç”¨ã€‚å‡è®¾ä½ å†™äº†ä¸€ä¸ª <code>SecurityAspect</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityAspect</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;execution(public * com.itranswarp.learnjava.service.*.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContext</span><span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;check failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬èƒ½å®ç°æ— å·®åˆ«å…¨è¦†ç›–ï¼Œå³æŸä¸ªåŒ…ä¸‹é¢çš„æ‰€æœ‰ Bean çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¢«è¿™ä¸ª <code>check()</code> æ–¹æ³•æ‹¦æˆªã€‚</p><p>è¿˜æœ‰çš„ç«¥é‹å–œæ¬¢ç”¨æ–¹æ³•åå‰ç¼€è¿›è¡Œæ‹¦æˆªï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;execution(public * update*(..))&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doLogging</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¯¹ update å¼€å¤´çš„æ–¹æ³•åˆ‡æ¢æ•°æ®æº:</span>
    <span class="token class-name">String</span> old <span class="token operator">=</span> <span class="token function">setCurrentDataSource</span><span class="token punctuation">(</span><span class="token string">&quot;master&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> retVal <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">restoreCurrentDataSource</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ç§éç²¾å‡†æ‰“å‡»è¯¯ä¼¤é¢æ›´å¤§ï¼Œå› ä¸ºä»æ–¹æ³•å‰ç¼€åŒºåˆ†æ˜¯å¦æ˜¯æ•°æ®åº“æ“ä½œæ˜¯éå¸¸ä¸å¯å–çš„ã€‚</p><p>æˆ‘ä»¬åœ¨ä½¿ç”¨ AOP æ—¶ï¼Œè¦æ³¨æ„åˆ°è™½ç„¶ Spring å®¹å™¨å¯ä»¥æŠŠæŒ‡å®šçš„æ–¹æ³•é€šè¿‡ AOP è§„åˆ™è£…é…åˆ°æŒ‡å®šçš„ Bean çš„æŒ‡å®šæ–¹æ³•å‰åï¼Œä½†æ˜¯ï¼Œå¦‚æœè‡ªåŠ¨è£…é…æ—¶ï¼Œå› ä¸ºä¸æ°å½“çš„èŒƒå›´ï¼Œå®¹æ˜“å¯¼è‡´æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œå³å¾ˆå¤šä¸éœ€è¦ AOP ä»£ç†çš„ Bean ä¹Ÿè¢«è‡ªåŠ¨ä»£ç†äº†ï¼Œå¹¶ä¸”ï¼Œåç»­æ–°å¢çš„ Beanï¼Œå¦‚æœä¸æ¸…æ¥šç°æœ‰çš„ AOP è£…é…è§„åˆ™ï¼Œå®¹æ˜“è¢«å¼ºè¿«è£…é…ã€‚</p><p>ä½¿ç”¨ AOP æ—¶ï¼Œè¢«è£…é…çš„ Bean æœ€å¥½è‡ªå·±èƒ½æ¸…æ¸…æ¥šæ¥šåœ°çŸ¥é“è‡ªå·±è¢«å®‰æ’äº†ã€‚ä¾‹å¦‚ï¼ŒSpring æä¾›çš„ <code>@Transactional</code> å°±æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¾‹å­ã€‚å¦‚æœæˆ‘ä»¬è‡ªå·±å†™çš„ Bean å¸Œæœ›åœ¨ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ä¸­è¢«è°ƒç”¨ï¼Œå°±æ ‡æ³¨ä¸Š <code>@Transactional</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token comment">// æœ‰äº‹åŠ¡:</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ— äº‹åŠ¡:</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValidName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æœ‰äº‹åŠ¡:</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ–è€…ç›´æ¥åœ¨ class çº§åˆ«æ³¨è§£ï¼Œè¡¨ç¤º â€œæ‰€æœ‰ public æ–¹æ³•éƒ½è¢«å®‰æ’äº†â€ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ <code>@Transactional</code>ï¼ŒæŸä¸ªæ–¹æ³•æ˜¯å¦å¯ç”¨äº†äº‹åŠ¡å°±ä¸€æ¸…äºŒæ¥šäº†ã€‚å› æ­¤ï¼Œè£…é… AOP çš„æ—¶å€™ï¼Œä½¿ç”¨æ³¨è§£æ˜¯æœ€å¥½çš„æ–¹å¼ã€‚</p><p>æˆ‘ä»¬ä»¥ä¸€ä¸ªå®é™…ä¾‹å­æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æ³¨è§£å®ç° AOP è£…é…ã€‚ä¸ºäº†ç›‘æ§åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ€§èƒ½ç›‘æ§çš„æ³¨è§£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token constant">METHOD</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">MetricTime</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨éœ€è¦è¢«ç›‘æ§çš„å…³é”®æ–¹æ³•ä¸Šæ ‡æ³¨è¯¥æ³¨è§£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç›‘æ§ register() æ–¹æ³•æ€§èƒ½:</span>
    <span class="token annotation punctuation">@MetricTime</span><span class="token punctuation">(</span><span class="token string">&quot;register&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ <code>MetricAspect</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MetricAspect</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(metricTime)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">metric</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">MetricTime</span> metricTime<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> metricTime<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> t <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
            <span class="token comment">// å†™å…¥æ—¥å¿—æˆ–å‘é€è‡³ JMX:</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;[Metrics]&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> t <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ <code>metric()</code> æ–¹æ³•æ ‡æ³¨äº† <code>@Around(&quot;@annotation(metricTime)&quot;)</code>ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼Œç¬¦åˆæ¡ä»¶çš„ç›®æ ‡æ–¹æ³•æ˜¯å¸¦æœ‰ <code>@MetricTime</code> æ³¨è§£çš„æ–¹æ³•ï¼Œå› ä¸º <code>metric()</code> æ–¹æ³•å‚æ•°ç±»å‹æ˜¯ <code>MetricTime</code>ï¼ˆæ³¨æ„å‚æ•°åæ˜¯ <code>metricTime</code> ä¸æ˜¯ <code>MetricTime</code>ï¼‰ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒè·å–æ€§èƒ½ç›‘æ§çš„åç§°ã€‚</p><p>æœ‰äº† <code>@MetricTime</code> æ³¨è§£ï¼Œå†é…åˆ <code>MetricAspect</code>ï¼Œä»»ä½• Beanï¼Œåªè¦æ–¹æ³•æ ‡æ³¨äº† <code>@MetricTime</code> æ³¨è§£ï¼Œå°±å¯ä»¥è‡ªåŠ¨å®ç°æ€§èƒ½ç›‘æ§ã€‚è¿è¡Œä»£ç ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Welcome, Bob<span class="token operator">!</span>
<span class="token punctuation">[</span>Metrics<span class="token punctuation">]</span> register: 16ms
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç»ƒä¹ -1" tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ -1" aria-hidden="true">#</a> ç»ƒä¹ </h3><p>ä½¿ç”¨æ³¨è§£ + AOP å®ç°æ€§èƒ½ç›‘æ§</p><h3 id="å°ç»“-1" tabindex="-1"><a class="header-anchor" href="#å°ç»“-1" aria-hidden="true">#</a> å°ç»“</h3><p>ä½¿ç”¨æ³¨è§£å®ç° AOP éœ€è¦å…ˆå®šä¹‰æ³¨è§£ï¼Œç„¶åä½¿ç”¨ <code>@Around(&quot;@annotation(name)&quot;)</code> å®ç°è£…é…ï¼›</p><p>ä½¿ç”¨æ³¨è§£æ—¢ç®€å•ï¼Œåˆèƒ½æ˜ç¡®æ ‡è¯† AOP è£…é…ï¼Œæ˜¯ä½¿ç”¨ AOP æ¨èçš„æ–¹å¼ã€‚</p><h2 id="ğŸ€-aop-é¿å‘æŒ‡å—" tabindex="-1"><a class="header-anchor" href="#ğŸ€-aop-é¿å‘æŒ‡å—" aria-hidden="true">#</a> ğŸ€ AOP é¿å‘æŒ‡å—</h2>`,38),A={href:"https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017",target:"_blank",rel:"noopener noreferrer"},j=c(`<p>å› ä¸º Spring ä½¿ç”¨äº† CGLIB æ¥å®ç°è¿è¡ŒæœŸåŠ¨æ€åˆ›å»º Proxyï¼Œå¦‚æœæˆ‘ä»¬æ²¡èƒ½æ·±å…¥ç†è§£å…¶è¿è¡ŒåŸç†å’Œå®ç°æœºåˆ¶ï¼Œå°±ææœ‰å¯èƒ½é‡åˆ°å„ç§è¯¡å¼‚çš„é—®é¢˜ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ã€‚</p><p>å‡è®¾æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª <code>UserService</code> çš„ Beanï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token comment">// æˆå‘˜å˜é‡:</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ZoneId</span> zoneId <span class="token operator">=</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ„é€ æ–¹æ³•:</span>
    <span class="token keyword">public</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UserService(): init...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UserService(): zoneId =&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>zoneId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// public æ–¹æ³•:</span>
    <span class="token keyword">public</span> <span class="token class-name">ZoneId</span> <span class="token function">getZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> zoneId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// public final æ–¹æ³•:</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ZoneId</span> <span class="token function">getFinalZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> zoneId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†å†™ä¸ª <code>MailService</code>ï¼Œå¹¶æ³¨å…¥ <code>UserService</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MailService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ZoneId</span> zoneId <span class="token operator">=</span> userService<span class="token punctuation">.</span>zoneId<span class="token punctuation">;</span>
        <span class="token class-name">String</span> dt <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span>zoneId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Hello, it is&quot;</span> <span class="token operator">+</span> dt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åç”¨ <code>main()</code> æ–¹æ³•æµ‹è¯•ä¸€ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">AppConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MailService</span> mailService <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">MailService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>mailService<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æŸ¥çœ‹è¾“å‡ºï¼Œä¸€åˆ‡æ­£å¸¸ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>UserService(): init...
UserService(): zoneId = Asia/Shanghai
Hello, it is 2020-04-12T10:23:22.917721+08:00[Asia/Shanghai]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬ç»™ <code>UserService</code> åŠ ä¸Š AOP æ”¯æŒï¼Œå°±æ·»åŠ ä¸€ä¸ªæœ€ç®€å•çš„ <code>LoggingAspect</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggingAspect</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;execution(public * com..*.UserService.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAccessCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;[Before] do access check...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ«å¿˜äº†åœ¨ <code>AppConfig</code> ä¸ŠåŠ ä¸Š <code>@EnableAspectJAutoProxy</code>ã€‚å†æ¬¡è¿è¡Œï¼Œä¸å‡ºæ„å¤–çš„è¯ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª <code>NullPointerException</code>ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Exception <span class="token keyword">in</span> thread <span class="token string">&quot;main&quot;</span> java.lang.NullPointerException: zone
    at java.base/java.util.Objects.requireNonNull<span class="token punctuation">(</span>Objects.java:246<span class="token punctuation">)</span>
    at java.base/java.time.Clock.system<span class="token punctuation">(</span>Clock.java:203<span class="token punctuation">)</span>
    at java.base/java.time.ZonedDateTime.now<span class="token punctuation">(</span>ZonedDateTime.java:216<span class="token punctuation">)</span>
    at com.itranswarp.learnjava.service.MailService.sendMail<span class="token punctuation">(</span>MailService.java:19<span class="token punctuation">)</span>
    at com.itranswarp.learnjava.AppConfig.main<span class="token punctuation">(</span>AppConfig.java:21<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»”ç»†è·Ÿè¸ªä»£ç ï¼Œä¼šå‘ç° <code>null</code> å€¼å‡ºç°åœ¨ <code>MailService.sendMail()</code> å†…éƒ¨çš„è¿™ä¸€è¡Œä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MailService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ZoneId</span> zoneId <span class="token operator">=</span> userService<span class="token punctuation">.</span>zoneId<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zoneId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// null</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬è¿˜æ•…æ„åœ¨ <code>UserService</code> ä¸­ç‰¹æ„ç”¨ <code>final</code> ä¿®é¥°äº†ä¸€ä¸‹æˆå‘˜å˜é‡ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ZoneId</span> zoneId <span class="token operator">=</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”¨ <code>final</code> æ ‡æ³¨çš„æˆå‘˜å˜é‡ä¸º <code>null</code>ï¼Ÿé€—æˆ‘å‘¢ï¼Ÿ</p><h3 id="æ€ä¹ˆè‚¥å››" tabindex="-1"><a class="header-anchor" href="#æ€ä¹ˆè‚¥å››" aria-hidden="true">#</a> æ€ä¹ˆè‚¥å››ï¼Ÿ</h3><p>ä¸ºä»€ä¹ˆåŠ äº† AOP å°±æŠ¥ NPEï¼Œå»äº† AOP å°±ä¸€åˆ‡æ­£å¸¸ï¼Ÿ<code>final</code> å­—æ®µä¸æ‰§è¡Œï¼Œéš¾é“ JVM æœ‰é—®é¢˜ï¼Ÿä¸ºäº†è§£ç­”è¿™ä¸ªè¯¡å¼‚çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥ç†è§£ Spring ä½¿ç”¨ CGLIB ç”Ÿæˆ Proxy çš„åŸç†ï¼š</p><p>ç¬¬ä¸€æ­¥ï¼Œæ­£å¸¸åˆ›å»ºä¸€ä¸ª <code>UserService</code> çš„åŸå§‹å®ä¾‹ï¼Œè¿™æ˜¯é€šè¿‡åå°„è°ƒç”¨æ„é€ æ–¹æ³•å®ç°çš„ï¼Œå®ƒçš„è¡Œä¸ºå’Œæˆ‘ä»¬é¢„æœŸçš„å®Œå…¨ä¸€è‡´ï¼›</p><p>ç¬¬äºŒæ­¥ï¼Œé€šè¿‡ CGLIB åˆ›å»ºä¸€ä¸ª <code>UserService</code> çš„å­ç±»ï¼Œå¹¶å¼•ç”¨äº†åŸå§‹å®ä¾‹å’Œ <code>LoggingAspect</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">UserService</span>$$<span class="token class-name">EnhancerBySpringCGLIB</span> <span class="token keyword">extends</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserService</span> target<span class="token punctuation">;</span>
    <span class="token class-name">LoggingAspect</span> aspect<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UserService</span>$$<span class="token class-name">EnhancerBySpringCGLIB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ZoneId</span> <span class="token function">getZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        aspect<span class="token punctuation">.</span><span class="token function">doAccessCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">getZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆ‘ä»¬è§‚å¯Ÿ Spring åˆ›å»ºçš„ AOP ä»£ç†ï¼Œå®ƒçš„ç±»åæ€»æ˜¯ç±»ä¼¼ <code>UserService$$EnhancerBySpringCGLIB$$1c76af9d</code>ï¼ˆä½ æ²¡çœ‹é”™ï¼ŒJava çš„ç±»åå®é™…ä¸Šå…è®¸ <code>$</code> å­—ç¬¦ï¼‰ã€‚ä¸ºäº†è®©è°ƒç”¨æ–¹è·å¾— <code>UserService</code> çš„å¼•ç”¨ï¼Œå®ƒå¿…é¡»ç»§æ‰¿è‡ª <code>UserService</code>ã€‚ç„¶åï¼Œè¯¥ä»£ç†ç±»ä¼šè¦†å†™æ‰€æœ‰ <code>public</code> å’Œ <code>protected</code> æ–¹æ³•ï¼Œå¹¶åœ¨å†…éƒ¨å°†è°ƒç”¨å§”æ‰˜ç»™åŸå§‹çš„ <code>UserService</code> å®ä¾‹ã€‚</p><p>è¿™é‡Œå‡ºç°äº†ä¸¤ä¸ª <code>UserService</code> å®ä¾‹ï¼š</p><p>ä¸€ä¸ªæ˜¯æˆ‘ä»¬ä»£ç ä¸­å®šä¹‰çš„ <em>åŸå§‹å®ä¾‹</em>ï¼Œå®ƒçš„æˆå‘˜å˜é‡å·²ç»æŒ‰ç…§æˆ‘ä»¬é¢„æœŸçš„æ–¹å¼è¢«åˆå§‹åŒ–å®Œæˆï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">UserService</span> original <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ç¬¬äºŒä¸ª <code>UserService</code> å®ä¾‹å®é™…ä¸Šç±»å‹æ˜¯ <code>UserService$$EnhancerBySpringCGLIB</code>ï¼Œå®ƒå¼•ç”¨äº†åŸå§‹çš„ <code>UserService</code> å®ä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">UserService</span>$$<span class="token class-name">EnhancerBySpringCGLIB</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span>$$<span class="token class-name">EnhancerBySpringCGLIB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span>target <span class="token operator">=</span> original<span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span>aspect <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„åˆ°è¿™ç§æƒ…å†µä»…å‡ºç°åœ¨å¯ç”¨äº† AOP çš„æƒ…å†µï¼Œæ­¤åˆ»ï¼Œä» <code>ApplicationContext</code> ä¸­è·å–çš„ <code>UserService</code> å®ä¾‹æ˜¯ proxyï¼Œæ³¨å…¥åˆ° <code>MailService</code> ä¸­çš„ <code>UserService</code> å®ä¾‹ä¹Ÿæ˜¯ proxyã€‚</p><p>é‚£ä¹ˆæœ€ç»ˆçš„é—®é¢˜æ¥äº†ï¼šproxy å®ä¾‹çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿå°±æ˜¯ä» <code>UserService</code> ç»§æ‰¿çš„ <code>zoneId</code>ï¼Œå®ƒçš„å€¼æ˜¯ <code>null</code>ã€‚</p><p>åŸå› åœ¨äºï¼Œ<code>UserService</code> æˆå‘˜å˜é‡çš„åˆå§‹åŒ–ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ZoneId</span> zoneId <span class="token operator">=</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ <code>UserService$$EnhancerBySpringCGLIB</code> ä¸­ï¼Œå¹¶æœªæ‰§è¡Œã€‚åŸå› æ˜¯ï¼Œæ²¡å¿…è¦åˆå§‹åŒ– proxy çš„æˆå‘˜å˜é‡ï¼Œå› ä¸º proxy çš„ç›®çš„æ˜¯ä»£ç†æ–¹æ³•ã€‚</p><p>å®é™…ä¸Šï¼Œæˆå‘˜å˜é‡çš„åˆå§‹åŒ–æ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­å®Œæˆçš„ã€‚è¿™æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ZoneId</span> zoneId <span class="token operator">=</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯ç¼–è¯‘å™¨å®é™…ç¼–è¯‘çš„ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ZoneId</span> zoneId<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ„é€ æ–¹æ³•çš„ç¬¬ä¸€è¡Œä»£ç æ€»æ˜¯è°ƒç”¨ super()</span>
        zoneId <span class="token operator">=</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç»§ç»­åˆå§‹åŒ–æˆå‘˜å˜é‡</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶è€Œï¼Œå¯¹äº Spring é€šè¿‡ CGLIB åŠ¨æ€åˆ›å»ºçš„ <code>UserService$$EnhancerBySpringCGLIB</code> ä»£ç†ç±»ï¼Œå®ƒçš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¹¶æœªè°ƒç”¨ <code>super()</code>ï¼Œå› æ­¤ï¼Œä»çˆ¶ç±»ç»§æ‰¿çš„æˆå‘˜å˜é‡ï¼ŒåŒ…æ‹¬ <code>final</code> ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œç»Ÿç»Ÿéƒ½æ²¡æœ‰åˆå§‹åŒ–ã€‚</p><p>æœ‰çš„ç«¥é‹ä¼šé—®ï¼šJava è¯­è¨€è§„å®šï¼Œä»»ä½•ç±»çš„æ„é€ æ–¹æ³•ï¼Œç¬¬ä¸€è¡Œå¿…é¡»è°ƒç”¨ <code>super()</code>ï¼Œå¦‚æœæ²¡æœ‰ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åŠ ä¸Šï¼Œæ€ä¹ˆ Spring çš„ CGLIB å°±å¯ä»¥æç‰¹æ®Šï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºè‡ªåŠ¨åŠ  <code>super()</code> çš„åŠŸèƒ½æ˜¯ Java ç¼–è¯‘å™¨å®ç°çš„ï¼Œå®ƒå‘ç°ä½ æ²¡åŠ ï¼Œå°±è‡ªåŠ¨ç»™åŠ ä¸Šï¼Œå‘ç°ä½ åŠ é”™äº†ï¼Œå°±æŠ¥ç¼–è¯‘é”™è¯¯ã€‚ä½†å®é™…ä¸Šï¼Œå¦‚æœç›´æ¥æ„é€ å­—èŠ‚ç ï¼Œä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¸ä¸€å®šéè¦è°ƒç”¨ <code>super()</code>ã€‚Spring ä½¿ç”¨ CGLIB æ„é€ çš„ Proxy ç±»ï¼Œæ˜¯ç›´æ¥ç”Ÿæˆå­—èŠ‚ç ï¼Œå¹¶æ²¡æœ‰æºç  - ç¼–è¯‘ - å­—èŠ‚ç è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤ï¼š</p><div class="hint-container note"><p class="hint-container-title">æ³¨</p><p>Spring é€šè¿‡ CGLIB åˆ›å»ºçš„ä»£ç†ç±»ï¼Œä¸ä¼šåˆå§‹åŒ–ä»£ç†ç±»è‡ªèº«ç»§æ‰¿çš„ä»»ä½•æˆå‘˜å˜é‡ï¼ŒåŒ…æ‹¬ final ç±»å‹çš„æˆå‘˜å˜é‡ï¼</p></div><p>å†è€ƒå¯Ÿ <code>MailService</code> çš„ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MailService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ZoneId</span> zoneId <span class="token operator">=</span> userService<span class="token punctuation">.</span>zoneId<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>zoneId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// null</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ²¡æœ‰å¯ç”¨ AOPï¼Œæ³¨å…¥çš„æ˜¯åŸå§‹çš„ <code>UserService</code> å®ä¾‹ï¼Œé‚£ä¹ˆä¸€åˆ‡æ­£å¸¸ï¼Œå› ä¸º <code>UserService</code> å®ä¾‹çš„ <code>zoneId</code> å­—æ®µå·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–äº†ã€‚</p><p>å¦‚æœå¯åŠ¨äº† AOPï¼Œæ³¨å…¥çš„æ˜¯ä»£ç†åçš„ <code>UserService$$EnhancerBySpringCGLIB</code> å®ä¾‹ï¼Œé‚£ä¹ˆé—®é¢˜å¤§äº†ï¼šè·å–çš„ <code>UserService$$EnhancerBySpringCGLIB</code> å®ä¾‹çš„ <code>zoneId</code> å­—æ®µï¼Œæ°¸è¿œä¸º <code>null</code>ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šå¯ç”¨äº† AOPï¼Œå¦‚ä½•ä¿®å¤ï¼Ÿ</p><p>ä¿®å¤å¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠç›´æ¥è®¿é—®å­—æ®µçš„ä»£ç ï¼Œæ”¹ä¸ºé€šè¿‡æ–¹æ³•è®¿é—®ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MailService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸è¦ç›´æ¥è®¿é—® UserService çš„å­—æ®µ:</span>
        <span class="token class-name">ZoneId</span> zoneId <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ— è®ºæ³¨å…¥çš„ <code>UserService</code> æ˜¯åŸå§‹å®ä¾‹è¿˜æ˜¯ä»£ç†å®ä¾‹ï¼Œ<code>getZoneId()</code> éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œå› ä¸ºä»£ç†ç±»ä¼šè¦†å†™ <code>getZoneId()</code> æ–¹æ³•ï¼Œå¹¶å°†å…¶å§”æ‰˜ç»™åŸå§‹å®ä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">UserService</span>$$<span class="token class-name">EnhancerBySpringCGLIB</span> <span class="token keyword">extends</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserService</span> target <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token class-name">ZoneId</span> <span class="token function">getZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">.</span><span class="token function">getZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„åˆ°æˆ‘ä»¬è¿˜ç»™ <code>UserService</code> æ·»åŠ äº†ä¸€ä¸ª <code>public</code>+<code>final</code> çš„æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ZoneId</span> <span class="token function">getFinalZoneId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> zoneId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœåœ¨ <code>MailService</code> ä¸­ï¼Œè°ƒç”¨çš„ä¸æ˜¯ <code>getZoneId()</code>ï¼Œè€Œæ˜¯ <code>getFinalZoneId()</code>ï¼Œåˆä¼šå‡ºç° <code>NullPointerException</code>ï¼Œè¿™æ˜¯å› ä¸ºï¼Œä»£ç†ç±»æ— æ³•è¦†å†™ <code>final</code> æ–¹æ³•ï¼ˆè¿™ä¸€ç‚¹ç»•ä¸è¿‡ JVM çš„ ClassLoader æ£€æŸ¥ï¼‰ï¼Œè¯¥æ–¹æ³•è¿”å›çš„æ˜¯ä»£ç†ç±»çš„ <code>zoneId</code> å­—æ®µï¼Œå³ <code>null</code>ã€‚</p><p>å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬åŠ ä¸Šæ—¥å¿—ï¼ŒSpring åœ¨å¯åŠ¨æ—¶ä¼šæ‰“å°ä¸€ä¸ªè­¦å‘Šï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">10</span>:43:09.929 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> DEBUG org.springframework.aop.framework.CglibAopProxy - Final method <span class="token punctuation">[</span>public final java.time.ZoneId xxx.UserService.getFinalZoneId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> cannot get proxied via CGLIB: Calls to this method will NOT be routed to the target instance and might lead to NPEs against uninitialized fields <span class="token keyword">in</span> the proxy instance.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¸Šé¢çš„æ—¥å¿—å¤§æ„å°±æ˜¯ï¼Œå› ä¸ºè¢«ä»£ç†çš„ <code>UserService</code> æœ‰ä¸€ä¸ª <code>final</code> æ–¹æ³• <code>getFinalZoneId()</code>ï¼Œè¿™ä¼šå¯¼è‡´å…¶ä»– Bean å¦‚æœè°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ— æ³•å°†å…¶ä»£ç†åˆ°çœŸæ­£çš„åŸå§‹å®ä¾‹ï¼Œä»è€Œå¯èƒ½å‘ç”Ÿ NPE å¼‚å¸¸ã€‚</p><p>å› æ­¤ï¼Œæ­£ç¡®ä½¿ç”¨ AOPï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé¿å‘æŒ‡å—ï¼š</p><ol><li>è®¿é—®è¢«æ³¨å…¥çš„ Bean æ—¶ï¼Œæ€»æ˜¯è°ƒç”¨æ–¹æ³•è€Œéç›´æ¥è®¿é—®å­—æ®µï¼›</li><li>ç¼–å†™ Bean æ—¶ï¼Œå¦‚æœå¯èƒ½ä¼šè¢«ä»£ç†ï¼Œå°±ä¸è¦ç¼–å†™ <code>public final</code> æ–¹æ³•ã€‚</li></ol><p>è¿™æ ·æ‰èƒ½ä¿è¯æœ‰æ²¡æœ‰ AOPï¼Œä»£ç éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚</p><h3 id="æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#æ€è€ƒ" aria-hidden="true">#</a> æ€è€ƒ</h3><p>ä¸ºä»€ä¹ˆ Spring åˆ»æ„ä¸åˆå§‹åŒ– Proxy ç»§æ‰¿çš„å­—æ®µï¼Ÿ</p><p>å¦‚æœä¸€ä¸ª Bean ä¸å…è®¸ä»»ä½• AOP ä»£ç†ï¼Œåº”è¯¥æ€ä¹ˆåšæ¥ â€œä¿æŠ¤â€ è‡ªå·±åœ¨è¿è¡ŒæœŸä¸ä¼šè¢«ä»£ç†ï¼Ÿ</p><h3 id="ç»ƒä¹ -2" tabindex="-1"><a class="header-anchor" href="#ç»ƒä¹ -2" aria-hidden="true">#</a> ç»ƒä¹ </h3><p>ä¿®å¤å¯ç”¨ AOP å¯¼è‡´çš„ NPE</p><h3 id="å°ç»“-2" tabindex="-1"><a class="header-anchor" href="#å°ç»“-2" aria-hidden="true">#</a> å°ç»“</h3><p>ç”±äº Spring é€šè¿‡ CGLIB å®ç°ä»£ç†ç±»ï¼Œæˆ‘ä»¬è¦é¿å…ç›´æ¥è®¿é—® Bean çš„å­—æ®µï¼Œä»¥åŠç”± <code>final</code> æ–¹æ³•å¸¦æ¥çš„ â€œæœªä»£ç†â€ é—®é¢˜ã€‚</p><p>é‡åˆ° CglibAopProxy çš„ç›¸å…³æ—¥å¿—ï¼ŒåŠ¡å¿…è¦ä»”ç»†æ£€æŸ¥ï¼Œé˜²æ­¢å› ä¸º AOP å‡ºç° NPE å¼‚å¸¸ã€‚</p>`,69);function x(P,B){const e=o("router-link"),t=o("ExternalLinkIcon");return l(),u("div",null,[n("details",r,[k,n("nav",v,[n("ul",null,[n("li",null,[a(e,{to:"#ğŸ€-aop-åŸç†"},{default:p(()=>[s("ğŸ€ AOP åŸç†")]),_:1})]),n("li",null,[a(e,{to:"#ğŸ€-è£…é…-aop"},{default:p(()=>[s("ğŸ€ è£…é… AOP")]),_:1}),n("ul",null,[n("li",null,[a(e,{to:"#æ‹¦æˆªå™¨ç±»å‹"},{default:p(()=>[s("æ‹¦æˆªå™¨ç±»å‹")]),_:1})]),n("li",null,[a(e,{to:"#ç»ƒä¹ "},{default:p(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(e,{to:"#å°ç»“"},{default:p(()=>[s("å°ç»“")]),_:1})])])]),n("li",null,[a(e,{to:"#ğŸ€-ä½¿ç”¨æ³¨è§£è£…é…-aop"},{default:p(()=>[s("ğŸ€ ä½¿ç”¨æ³¨è§£è£…é… AOP")]),_:1}),n("ul",null,[n("li",null,[a(e,{to:"#ç»ƒä¹ -1"},{default:p(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(e,{to:"#å°ç»“-1"},{default:p(()=>[s("å°ç»“")]),_:1})])])]),n("li",null,[a(e,{to:"#ğŸ€-aop-é¿å‘æŒ‡å—"},{default:p(()=>[s("ğŸ€ AOP é¿å‘æŒ‡å—")]),_:1}),n("ul",null,[n("li",null,[a(e,{to:"#æ€ä¹ˆè‚¥å››"},{default:p(()=>[s("æ€ä¹ˆè‚¥å››ï¼Ÿ")]),_:1})]),n("li",null,[a(e,{to:"#æ€è€ƒ"},{default:p(()=>[s("æ€è€ƒ")]),_:1})]),n("li",null,[a(e,{to:"#ç»ƒä¹ -2"},{default:p(()=>[s("ç»ƒä¹ ")]),_:1})]),n("li",null,[a(e,{to:"#å°ç»“-2"},{default:p(()=>[s("å°ç»“")]),_:1})])])])])])]),m,n("p",null,[s("ä¸€ç§å¯è¡Œçš„æ–¹å¼æ˜¯ä½¿ç”¨ "),n("a",b,[s("Proxy æ¨¡å¼"),a(t)]),s("ï¼Œå°†æŸä¸ªåŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œæƒé™æ£€æŸ¥ï¼Œæ”¾å…¥ Proxy ä¸­ï¼š")]),g,n("p",null,[s("æœ€ç®€å•çš„æ–¹å¼æ˜¯ç¬¬ä¸‰ç§ï¼ŒSpring çš„ AOP å®ç°å°±æ˜¯åŸºäº JVM çš„åŠ¨æ€ä»£ç†ã€‚ç”±äº JVM çš„åŠ¨æ€ä»£ç†è¦æ±‚å¿…é¡»å®ç°æ¥å£ï¼Œå¦‚æœä¸€ä¸ªæ™®é€šç±»æ²¡æœ‰ä¸šåŠ¡æ¥å£ï¼Œå°±éœ€è¦é€šè¿‡ "),n("a",y,[s("CGLIB"),a(t)]),s(" æˆ–è€… "),n("a",h,[s("Javassist"),a(t)]),s(" è¿™äº›ç¬¬ä¸‰æ–¹åº“å®ç°ã€‚")]),S,n("p",null,[s("è‡³äº AspectJ çš„æ³¨å…¥è¯­æ³•åˆ™æ¯”è¾ƒå¤æ‚ï¼Œè¯·å‚è€ƒ "),n("a",w,[s("Spring æ–‡æ¡£"),a(t)]),s("ã€‚")]),f,n("p",null,[s("æ— è®ºæ˜¯ä½¿ç”¨ AspectJ è¯­æ³•ï¼Œè¿˜æ˜¯é…åˆ Annotationï¼Œä½¿ç”¨ AOPï¼Œå®é™…ä¸Šå°±æ˜¯è®© Spring è‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Proxyï¼Œä½¿å¾—è°ƒç”¨æ–¹èƒ½æ— æ„ŸçŸ¥åœ°è°ƒç”¨æŒ‡å®šæ–¹æ³•ï¼Œä½†è¿è¡ŒæœŸå´åŠ¨æ€ â€œç»‡å…¥â€ äº†å…¶ä»–é€»è¾‘ï¼Œå› æ­¤ï¼ŒAOP æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª"),n("a",A,[s("ä»£ç†æ¨¡å¼"),a(t)]),s("ã€‚")]),j])}const O=i(d,[["render",x],["__file","2.html.vue"]]);export{O as default};
