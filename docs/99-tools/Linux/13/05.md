---
title: 
sidebarDepth: 0 
category: Tools 
tag: Linux
---
# ç”¨æˆ·çš„ç‰¹æ®Š shell ä¸ PAM æ¨¡å—

å‰é¢è®²è§£çš„å¤§å¤šæ˜¯ä¸€èˆ¬èº«ä»½ç”¨æˆ·ä¸ç³»ç»Ÿç®¡ç†å‘˜ root çš„ç›¸å…³æ“ä½œï¼Œè€Œä¸”å¤§å¤šæ˜¯å…³äºå¯ç™»é™†ç³»ç»Ÿçš„è´¦æˆ·æ¥è¯´çš„ã€‚

é‚£ä¹ˆæƒ³è¦å»ºç«‹ä¸€ä¸ª **ä»…ä»…èƒ½ä½¿ç”¨ mail server ç›¸å…³é‚®ä»¶æœåŠ¡çš„è´¦æˆ·ï¼Œè€Œè¯¥è´¦æˆ·å¹¶ä¸èƒ½ç™»é™† Linux ä¸»æœº**ï¼Œå¦‚æœåˆ†é…å¯†ç åˆ™

å¦å¤– å‰é¢è¯´`/etc/login.defs`æ–‡ä»¶ä¸­ï¼Œå…³äºå¯†ç é•¿åº¦é»˜è®¤æ˜¯ 5 ä¸ªå­—ç¬¦ä¸²é•¿åº¦ï¼Œä½†æ˜¯è¯¥å€¼ä»¥åŠè¢« PAM æ¨¡å—æ‰€å–ä»£äº†ï¼Œé‚£ä¹ˆ PAM æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä»–å¯ä»¥å½±å“æˆ‘ä»¬ä½¿ç”¨è€…çš„ç™»å½•å‘¢ï¼Ÿ

## ğŸ€ ç‰¹æ®Šçš„ shellï¼š`/sbin/nologin`

åœ¨ passwd æ–‡ä»¶ç»“æ„é‡Œé¢æœ‰çœ‹åˆ°è¿‡è¿™ä¸ª shell çš„é…ç½®ï¼Œå¦‚æœé…ç½®äº†è¿™ä¸ª shell ç»™ä¸€ä¸ªè´¦æˆ·ï¼Œé‚£ä¹ˆè¯¥è´¦æˆ·è¯•å›¾ç™»å½•çš„æ—¶å€™ï¼Œå°±ä¼šæç¤ºå¦‚ä¸‹çš„ä¿¡æ¯

```bash
This account is currently not available
```

è¿™é‡Œè¯´çš„æ— æ³•ç™»å½•ä»…è¡¨ç¤ºï¼šè¿™ä¸ªä½¿ç”¨è€…æ— æ³•ä½¿ç”¨ bash æˆ–å…¶ä»– shell æ¥ç™»å½•ç³»ç»Ÿï¼Œå¹¶ä¸æ˜¯è¯´æ— æ³•ä½¿ç”¨å…¶ä»–ç³»ç»Ÿèµ„æº

é‚£ä¹ˆä¸Šé¢çš„æç¤ºå†…å®¹ï¼Œä»…ä»…æç¤ºè¯¥è´¦æˆ·ç›®å‰ä¸å¯ç”¨ï¼Œå…¶å®å¯ä»¥é€šè¿‡ `/etc/nologin.txt` æ–‡ä»¶æ¥è‡ªå®šä¹‰æç¤ºå†…å®¹

```bash
# åˆ©ç”¨çº¯ mail è´¦æˆ·ï¼Œä¾‹å¦‚ myuser3 æ—¶ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰å†…å®¹ç»™ç™»é™†è€…æŸ¥çœ‹

[root@study ~]# vim /etc/nologin.txt
 è¯¥è´¦æˆ·åªç”¨æ¥æ¥æ”¶é‚®ä»¶ï¼Œä¸æä¾›ç™»å½•æœåŠ¡ã€‚

# ä¹‹å‰åˆ›å»º myuser3 çš„æ—¶å€™ shell å°±è®¾ç½®çš„æ˜¯ /sbin/nologin
[pro2@study ~]$ su -l myuser3
Password: 
è¯¥è´¦æˆ·åªç”¨æ¥æ¥æ”¶é‚®ä»¶ï¼Œä¸æä¾›ç™»å½•æœåŠ¡ã€‚

# å¯ä»¥çœ‹åˆ°æç¤ºä¿¡æ¯å°±è¢«è‡ªå®šä¹‰äº†
```

## ğŸ€ PAM æ¨¡å—ç®€ä»‹

PAMï¼ˆPluggable Authentication Modules åµŒå…¥å¼æ¨¡å—ï¼‰å¯ä»¥è¯´æ˜¯ä¸€å¥—åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼Œæä¾›äº†è®¸å¤šéªŒè¯æœºåˆ¶ï¼Œåªè¦ä½¿ç”¨è€…å°†éªŒè¯é˜¶æ®µçš„éœ€æ±‚å‘ŠçŸ¥ PAM åï¼ŒPAM å°±èƒ½è¿”å›éªŒè¯ç»“æœæˆåŠŸæˆ–å¤±è´¥ã€‚

æ²¡æœ‰ç”¨ PAM ä¹‹å‰ï¼Œéœ€è¦è‡ªå·±å†™ç¨‹åºå¤„ç†è´¦æˆ·å¯†ç çš„éªŒè¯ï¼Œé‚£ä¹ˆå°±æœ‰äººæ”¶é›†äº†å¾ˆå¤šéªŒè¯éœ€æ±‚å®ç°åæä¾›äº†ä¸€ä¸ªéªŒè¯æ¨¡å—ã€‚å› æ­¤ç¨‹åºéƒ½å¯ä»¥å¼•ç”¨è¯¥æ¨¡å—æ¥è¿›è¡ŒéªŒè¯

![image-20200225155547026](./assets/image-20200225155547026.png)

å¦‚å›¾ç¤ºï¼ŒPAM æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ APIï¼Œä½ çš„ç¨‹åºä¹Ÿå¯ä»¥å¼•å…¥ä»–æ¥è¿›è¡ŒéªŒè¯

PAM ç”¨æ¥è¿›è¡ŒéªŒè¯çš„æ•°æ®æˆä¸ºæ¨¡å—ï¼ˆModulesï¼‰ï¼Œæ¯ä¸ª PAM æ¨¡å—åŠŸèƒ½éƒ½ä¸å¤ªç›¸åŒï¼Œæ¯”å¦‚ï¼Œä¹‹å‰ passwd æŒ‡ä»¤è¾“å…¥å¯†ç ï¼ŒæŠ¥é”™æç¤ºåœ¨å­—å…¸ä¸Šé¢æ‰¾åˆ°çš„å­—ç¬¦ä¸²ï¼Œè¿™æ˜¯ PAM çš„ pam_cracklib.so æ¨¡å—çš„åŠŸèƒ½

## ğŸ€ PAM æ¨¡å—è®¾ç½®è¯­æ³•

è¿™é‡Œä»¥  passwd æŒ‡ä»¤è°ƒç”¨çš„ PAM æ¥è¯´æ˜ï¼š

1. ç”¨æˆ·å¼€å§‹æ‰§è¡Œ `/usr/bin/passwd` ç¨‹åºï¼Œå¹¶è¾“å…¥å¯†ç 
2. passwd è°ƒç”¨ PAM æ¨¡å—è¿›è¡ŒéªŒè¯
3. PAM æ¨¡å—ä¼šåˆ° `/etc/pam.d/` å¯»æ‰¾ä¸æŒ‡ä»¤ passwd åŒåçš„é…ç½®æ–‡ä»¶
4. æ ¹æ® `/etc/pam.d/passwd` å†…çš„è®¾ç½®ï¼Œå¼•ç”¨ç›¸å…³çš„ PAM æ¨¡å—é€æ­¥è¿›è¡ŒéªŒè¯åˆ†æï¼›

é‚£ä¹ˆä»è¿™é‡Œå°±çœ‹å‡ºæ¥äº†ï¼Œä»–çš„å…¥å£é…ç½®æ˜¯ï¼š

1. é…ç½®æ–‡ä»¶è¦æ”¾åˆ° `/etc/pam.d/` ä¸­ï¼Œä¸”åŒå
2. ç¨‹åºè¦è°ƒç”¨

ä¸‹é¢å…ˆæ¥çœ‹çœ‹é…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚

```bash
[pro2@study ~]$ cat /etc/pam.d/passwd 
#%PAM-1.0		# PAM ç‰ˆæœ¬è¯´æ˜
auth       include	system-auth			# æ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªéªŒè¯ç¨‹åº
account    include	system-auth
password   substack	system-auth
-password   optional	pam_gnome_keyring.so use_authtok
password   substack	postlogin
éªŒè¯ç±»åˆ«	æ§åˆ¶æ ‡å‡†	PAM æ¨¡å—ä¸è¯¥æ¨¡å—çš„å‚æ•°
```

è¯¥æ–‡ä»¶ä¸­ï¼Œé™¤äº†ç¬¬ä¸€è¡Œå£°æ˜  PAM ç‰ˆæœ¬å¤–ï¼Œå…¶ä»–çš„ `#` å¼€å¤´çš„å‡ä¸ºæ‰¹æ³¨å†…å®¹

ä¸Šé¢ç¬¬ 2 å­—æ®µä¸­å‡ºç°çš„ include æ˜¯æ ‡è¯†ï¼Œè°ƒç”¨åé¢çš„æ–‡ä»¶æ¥ä½œä¸ºè¿™ä¸ªç±»åˆ«çš„éªŒè¯ï¼Œæ‰€ä»¥æ˜¯è°ƒç”¨ `/etc/pam.d/system-auth` æ–‡ä»¶æ¥è¿›è¡ŒéªŒè¯

1. éªŒè¯ç±»åˆ«ï¼ˆtypeï¼‰ï¼šä¸»è¦åˆ†ä¸º 4 ç§

   - authï¼šauthentication è®¤è¯

     ä¸»è¦ç”¨æ¥æ ¡éªŒä½¿ç”¨è€…çš„èº«ä»½éªŒè¯ï¼Œè¿™ç§ç±»åˆ«é€šå¸¸æ˜¯éœ€è¦å¯†ç æ¥æ ¡éªŒçš„ï¼Œæ‰€ä»¥åç»­æ¥çš„æ¨¡å—æ˜¯ç”¨æ¥æ ¡éªŒç”¨æˆ·çš„èº«ä»½

   - accountï¼šaccount è´¦æˆ·

     å¤§éƒ¨åˆ†æ˜¯åœ¨è¿›è¡Œ authorization æˆæƒï¼Œè¿™ç§ç±»åˆ«ä¸»è¦æ£€éªŒä½¿ç”¨è€…æ˜¯å¦å…·æœ‰æ­£ç¡®çš„æƒé™ï¼Œæ¯”å¦‚ï¼šä½¿ç”¨ä¸€ä¸ªè¿‡æœŸçš„å¯†ç æ¥ç™»å½•ï¼Œå°±æ— æ³•ç™»å½•äº†

   - session

     è¯¥ä½¿ç”¨è€…åœ¨æ­¤æ¬¡ç™»å½•ï¼ˆæˆ–ä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤ï¼‰æœŸé—´ï¼ŒPAM æ‰€ç»™äºˆçš„ç¯å¢ƒè®¾ç½®ã€‚è¿™ä¸ªç±»åˆ«é€šå¸¸ç”¨åœ¨è®°å½•ç”¨æˆ·ç™»å½•ä¸æ³¨é”€æ—¶çš„ä¿¡æ¯ã€‚

     ä¾‹å¦‚ï¼šå‡å¦‚ä½ å¸¸å¸¸ä½¿ç”¨ su æˆ– sudo æŒ‡ä»¤ï¼Œé‚£ä¹ˆåº”è¯¥å¯ä»¥åœ¨ `/var/log/secure` é‡Œé¢å‘ç°å¾ˆå¤šå…³äº pam çš„è¯´æ˜ï¼Œè€Œä¸”è®°è½½çš„æ•°æ®æ˜¯`session openã€session close` çš„ä¿¡æ¯

   - password å¯†ç 

     ä¸»è¦æä¾›éªŒè¯çš„ä¿®æ”¹å·¥ä½œï¼Œæ¯”å¦‚ä¿®æ”¹å¯†ç 

   è¿™ 4 ä¸ªéªŒè¯ç±»å‹é€šå¸¸æ˜¯æœ‰é¡ºåºçš„ï¼ˆä¹Ÿæœ‰ä¾‹å¤–ï¼‰ï¼Œæœ‰é¡ºåºæ˜¯å› ä¸ºï¼š

   1. æ€»æ˜¯è¦å…ˆéªŒè¯èº«ä»½ï¼ˆauthï¼‰å
   2. ç³»ç»Ÿæ‰èƒ½å¤Ÿè·å–åˆ°ç”¨æˆ·èº«ä»½ç»™äºˆé€‚å½“çš„æˆæƒä¸æƒé™è®¾ç½®ï¼ˆaccountï¼‰
   3. ç™»å½•ä¸æ³¨é”€æœŸé—´çš„ç¯å¢ƒæ‰éœ€è¦è®¾ç½®ï¼Œéœ€è¦è®°å½•ç™»å½•ä¸æ³¨é”€ä¿¡æ¯ ï¼ˆsessionï¼‰
   4. ä¿®æ”¹å¯†ç æ—¶ï¼Œä½¿ç”¨ password ç±»åˆ«

   æ ¹æ®ä¸šåŠ¡æ¥çœ‹ï¼Œè²Œä¼¼æ˜¯æœ‰å¿…è¦æœ‰é¡ºåºçš„

2. éªŒè¯çš„æ§åˆ¶æ——æ ‡ï¼ˆcontrol flagï¼‰

    ç®€å•è¯´ï¼šæ˜¯éªŒè¯é€šè¿‡çš„æ ‡å‡†ï¼Œä¸»è¦æœ‰ 4 ç§æ§åˆ¶æ–¹å¼

   - required

     éªŒè¯æˆåŠŸåˆ™å¸¦æœ‰ success æ ‡å¿—ï¼Œå¤±è´¥åˆ™ failure æ ‡å¿—ï¼Œä½†æ˜¯éƒ½ä¼šç»§ç»­åç»­çš„éªŒè¯æµç¨‹

   - requisite

     è‹¥éªŒè¯å¤±è´¥ç«‹åˆ»è¿”å› failure æ ‡å¿—ï¼Œå¹¶ç»ˆæ­¢åç»­çš„éªŒè¯æµç¨‹ã€‚è‹¥éªŒè¯æˆåŠŸåˆ™å¸¦æœ‰ success æ ‡å¿—ï¼Œå¹¶ç»§ç»­åç»­çš„éªŒè¯æµç¨‹ã€‚

      ç”±äºå¤±è´¥å°±ç»ˆæ­¢ï¼Œå› æ­¤å¤±è´¥æ—¶æ‰€äº§ç”Ÿçš„ PAM ä¿¡æ¯æ— æ³•é€šè¿‡åç»­çš„æ¨¡å—æ¥è®°å½•äº†

   - sufficient

     è‹¥éªŒè¯æˆåŠŸç«‹åˆ»å›ä¼  success ç»™åŸç¨‹åºï¼Œå¹¶ç»ˆæ­¢åç»­éªŒè¯æµç¨‹ï¼›

      è‹¥éªŒè¯å¤±è´¥åˆ™å¸¦æœ‰ failure æ ‡å¿—å¹¶ç»§ç»­åç»­çš„éªŒè¯æµç¨‹ã€‚ä¸ requisite ç›¸å

   - optional

     è¯¥æ¨¡å—æ§ä»¶å¤§å¤šæ•°æ˜¯æ˜¾ç¤ºä¿¡æ¯ï¼Œå¹¶ä¸æ˜¯ç”¨åœ¨éªŒè¯æ–¹é¢

   å›¾ç¤ºå¦‚ä¸‹ï¼š

   ![image-20200225205700001](./assets/image-20200225205700001.png)

## ğŸ€ å¸¸ç”¨æ¨¡å—ç®€ä»‹

ç”±äºå¸¸å¸¸éœ€è¦é€šè¿‡å„ç§æ–¹å¼æ¥ç™»å½• login ç³»ç»Ÿï¼Œæ¥çœ‹çœ‹ç™»å½•æ‰€éœ€è¦çš„ PAM æµç¨‹ï¼š

```bash
[mrcode@study ~]$ cat /etc/pam.d/login 
#%PAM-1.0
auth [user_unknown=ignore success=ok ignore=ignore default=bad] pam_securetty.so
auth       substack     system-auth
auth       include      postlogin
account    required     pam_nologin.so
account    include      system-auth
password   include      system-auth
# pam_selinux.so close should be the first session rule
session    required     pam_selinux.so close
session    required     pam_loginuid.so
session    optional     pam_console.so
# pam_selinux.so open should only be followed by sessions to be executed in the user context
session    required     pam_selinux.so open
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    include      system-auth
session    include      postlogin
-session   optional     pam_ck_connector.so

# è¿™é‡Œçœ‹åˆ°æœ€å¤šçš„åº”è¯¥æ˜¯æœ‰å¼•ç”¨äº† system-authï¼Œæ¥è§‚å¯Ÿä¸‹
[mrcode@study ~]$ cat /etc/pam.d/system-auth
#%PAM-1.0
# This file is auto-generated.
# User changes will be destroyed the next time authconfig is run.
auth        required      pam_env.so
auth        required      pam_faildelay.so delay=2000000
auth        sufficient    pam_fprintd.so
auth        sufficient    pam_unix.so nullok try_first_pass
auth        requisite     pam_succeed_if.so uid >= 1000 quiet_success
auth        required      pam_deny.so

account     required      pam_unix.so
account     sufficient    pam_localuser.so
account     sufficient    pam_succeed_if.so uid < 1000 quiet
account     required      pam_permit.so

password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=
password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok
password    required      pam_deny.so

session     optional      pam_keyinit.so revoke
session     required      pam_limits.so
-session     optional      pam_systemd.so
session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
session     required      pam_unix.so

```

system-auth ç”¨åˆ°äº†éå¸¸å¤šçš„ PAM æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—çš„åŠŸèƒ½éƒ½ä¸å¤ªç›¸åŒï¼Œè¯¦ç»†çš„æ¨¡å—æ•°æ®å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°ï¼š

- `/etc/pam.d/*`ï¼šæ¯ä¸ªç¨‹åºä¸ªåˆ«çš„ PAM é…ç½®æ–‡ä»¶
- `/lib64/security/*`ï¼šPAM æ¨¡å—æ–‡ä»¶çš„å®é™…æ”¾ç½®ç›®å½•
- `/etc/security/*`ï¼šå…¶ä»– PAM ç¯å¢ƒçš„é…ç½®æ–‡ä»¶
- `/usr/share/doc/pam-*`ï¼šè¯¦ç»†çš„ PAM è¯´æ˜æ–‡ä»¶

```bash
[root@study ~]# find / -name *.pam_nologin
/usr/share/doc/pam-1.1.8/txts/README.pam_nologin
æ¯”å¦‚ pam_nologin.so çš„è¯´æ˜æ–‡ä»¶ï¼Œå°±åœ¨ä»¥ä¸Šè·¯å¾„ï¼Œå¯ä»¥é˜…è¯»ä¸‹
```

ä¸‹é¢ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„æ¨¡å—ï¼Œè¯¦ç»†çš„ä¿¡æ¯éœ€è¦è‡ªå·±å»æŸ¥é˜…èµ„æ–™

- pam_securetty.soï¼šé™åˆ¶ç³»ç»Ÿç®¡ç†å‘˜ root åªèƒ½æ€ªä»å®‰å…¨çš„ secure ç»ˆç«¯æœºç™»å½•

  ä¾‹å¦‚ tty1ã€tty2 å°±æ˜¯ä¼ ç»Ÿçš„ç»ˆç«¯æœºè£…ç½®åç§°ã€‚å®‰å…¨çš„ç»ˆç«¯æœºè®¾ç½®åœ¨ `/etc/securetty` æ–‡ä»¶ä¸­ï¼Œé‡Œé¢åˆ—å‡ºäº†ç»ˆç«¯æœºåç§°ï¼ŒæŸ¥çœ‹ä¸‹å°±çŸ¥é“ä¸ºä»€ä¹ˆ root å¯ä»¥ä» tty1~tt2 ç™»å½•ï¼Œè€Œä¸èƒ½é€šè¿‡ telnet ç™»å½•äº†

- pam_nologin.soï¼šå¯ä»¥é™åˆ¶ä¸€èˆ¬ç”¨æˆ·æ˜¯å¦èƒ½å¤Ÿç™»å½•ä¸»æœº

  å½“ `/etc/nologin` æ–‡ä»¶å­˜åœ¨æ—¶ï¼Œåˆ™æ‰€æœ‰ä¸€èˆ¬ä½¿ç”¨è€…å‡æ— æ³•å†ç™»å½•ç³»ç»Ÿäº†ï¼Œå¹¶åœ¨ä»–ä»¬çš„ç»ˆç«¯æœºä¸Šä¼šå°†è¯¥æ–‡ä»¶å†…å®¹æ˜¾ç¤ºå‡ºæ¥ï¼›

  æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¯¥æ–‡ä»¶æ˜¯ä¸èƒ½å­˜åœ¨ç³»ç»Ÿä¸­çš„ï¼Œè¯¥æ¨¡å—å¯¹ root ä»¥åŠå·²ç»ç™»å½•ç³»ç»Ÿä¸­çš„ä¸€èˆ¬è´¦æˆ·æ²¡æœ‰å½±å“ã€‚æ³¨æ„ï¼šè¯¥æ–‡ä»¶ä¸ `/etc/nologin.txt` ä¸æ˜¯åŒä¸€ä¸ª

- pam_selinux.soï¼šSELinux æ˜¯ä¸ªé’ˆå¯¹ç¨‹åºæ¥è¿›è¡Œç»†éƒ¨ç®¡ç†æƒé™çš„åŠŸèƒ½

  åœ¨åç»­çš„ç¬¬ 16 ç« ä¸­å†æ¥è®¨è®º SELinuxã€‚ç”±äº SELinux ä¼šå½±å“åˆ°ç”¨æˆ·æ‰§è¡Œç¨‹åºçš„æƒé™ï¼Œå› æ­¤åˆ©ç”¨ PAM æ¨¡å—ï¼Œå°† SELinux æš‚æ—¶å…³é—­ï¼Œç­‰åˆ°éªŒè¯é€šè¿‡åï¼Œåœ¨å¯åŠ¨

- pam_console.soï¼š

  å½“ç³»ç»Ÿå‡ºç°æŸäº›é—®é¢˜ï¼Œæˆ–åˆ™æ˜¯éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„ç»ˆç«¯æ¥å£ï¼ˆå¦‚ RS232 ä¹‹ç±»çš„ç»ˆç«¯æœºè”æœºè®¾å¤‡ï¼‰ç™»å½•ä¸»æœºæ—¶ï¼Œè¯¥æ¨¡å—å¯ä»¥å¸®åŠ©å¤„ç†ä¸€äº›æ–‡ä»¶æƒé™é—®é¢˜ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥é€šè¿‡ç‰¹æ®Šç»ˆç«¯æ¥å£ console é¡ºåˆ©ç™»å½•ç³»ç»Ÿ

- pam_loginuid.soï¼š

  ç³»ç»Ÿè´¦æˆ·ä¸ä¸€èˆ¬è´¦æˆ·çš„ UID ä¸åŒçš„ï¼Œä¸€èˆ¬è´¦æˆ· UID å‡å¤§äº 1000 æ‰åˆç†ã€‚å¯ä»¥ç”¨è¯¥æ¨¡å—æ¥éªŒè¯ä½¿ç”¨è€…çš„ UID æ˜¯å¦ç¬¦åˆè¦æ±‚
  
- pam_unix.soï¼š

  å¾ˆå¤æ‚çš„ä¸”é‡è¦çš„æ¨¡å—ï¼Œå¯ä»¥ç”¨åœ¨éªŒè¯é˜¶æ®µçš„è®¤è¯åŠŸèƒ½ï¼Œå¯ä»¥ç”¨åœ¨æˆæƒé˜¶æ®µçš„è´¦æˆ·è®¸å¯è¯ç®¡ç†ï¼Œå¯ä»¥ç”¨åœ¨ä¼šè®®ï¼ˆsessionï¼‰é˜¶æ®µçš„ç™»å½•æ–‡ä»¶è®°å½•ï¼Œç”šè‡³å¯ä»¥ç”¨åœ¨å¯†ç æ›´æ–°é˜¶æ®µçš„æ ¡éªŒã€‚è¯¥æ¨¡å—åœ¨æ—©æœŸç”¨çš„è¾ƒå¤š

- pam_pwquality.soï¼š

  å¯ä»¥ç”¨æ¥æ ¡éªŒå¯†ç å¼ºåº¦ï¼ŒåŒ…æ‹¬æ˜¯å¦åœ¨å­—å…¸ä¸­ã€å¯†ç è¾“å…¥å‡ æ¬¡éƒ½å¤±è´¥å°±æ–­æ‰æ­¤æ¬¡è”æœºç­‰åŠŸèƒ½ã€‚

  æœ€æ—©ä½¿ç”¨çš„æ˜¯ pam_cracklib.so æ¨¡å—ï¼Œåæ¥æ”¹æˆ pam_pwquality.so æ¨¡å—ï¼Œpam_pwquality.so å…¼å®¹ pam_cracklib.so æ¨¡å—ï¼ŒåŒæ—¶æä¾›äº† `/etc/security/pwquality.conf` æ–‡ä»¶å¯ä»¥é¢å¤–æŒ‡å®šé»˜è®¤å€¼ï¼Œæ¯”è¾ƒå®¹æ˜“å¤„ç†ä¿®æ”¹

- pam_limits.so

  åœ¨ç¬¬ 10 ç« ä¸­è®²è§£çš„ ulimitï¼Œå°±æ˜¯è¯¥æ¨¡å—æä¾›çš„èƒ½åŠ›ï¼Œæ›´å¤šä¿¡æ¯å¯ä»¥æŸ¥çœ‹ `/etc/security/limits.conf` 

äº†è§£äº†æ¨¡å—å¤§è‡´åŠŸèƒ½åï¼Œè¿™é‡Œè®¨è®ºä¸‹ login çš„ PAM éªŒè¯æœºåˆ¶æµç¨‹ï¼š

1. éªŒè¯é˜¶æ®µ authï¼š
   1. ç»è¿‡ pam_securetty.so ï¼Œå¦‚æœä½¿ç”¨è€…æ˜¯ root æ—¶ï¼Œä¼šå‚è€ƒ /etc/securetty çš„è®¾ç½®
   2. ç»è¿‡ pam_env.so è®¾ç½®é¢å¤–çš„ç¯å¢ƒå˜é‡
   3. ç»è¿‡ pam_unix.so æ ¡éªŒå¯†ç ï¼Œè‹¥é€šè¿‡åˆ™å›æŠ¥ login ç¨‹åº
   4. è‹¥æœªé€šè¿‡ï¼Œåˆ™ç»§ç»­å¾€ä¸‹ä»¥ pam_succeed_if.so åˆ¤æ–­ UID æ˜¯å¤§äº 1000ï¼Œè‹¥å°äº 1000 åˆ™å›æŠ¥å¤±è´¥
   5. è‹¥å¤§äº 1000 åˆ™ä»¥ pam_deny.so æ‹’ç»è”æœº
2. æˆæƒé˜¶æ®µ accountï¼š
   1. ä»¥ pam_nologin.so åˆ¤æ–­ /etc/nologin æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™ä¸å…è®¸ä¸€èˆ¬ä½¿ç”¨è€…ç™»å½•
   2. æ¥ä¸‹æ¥ä»¥ pam_unix.so åŠ pam_localuser.so è¿›è¡Œè´¦æˆ·ç®¡ç†
   3. å†ä»¥ pam_succeed_if.so åˆ¤æ–­ UID æ˜¯å¦å°äº 1000ï¼Œè‹¥å°äº 1000 åˆ™ä¸è®°å½•ç™»å½•ä¿¡æ¯
   4. æœ€åå·² pam_permit.so å…è®¸è¯¥è´¦æˆ·ç™»å½•
3. å¯†ç é˜¶æ®µ passwordï¼š
   1. ä»¥ pam_pwauality.so è®¾ç½®å¯†ç ä»…èƒ½å°è¯•é”™è¯¯ 3 æ¬¡
   2. æ¥ä¸‹æ¥ä»¥ pam_unix.so é€šè¿‡ sha512 shadow ç­‰åŠŸèƒ½è¿›è¡Œå¯†ç æ ¡éªŒï¼Œè‹¥é€šè¿‡åˆ™å›æŠ¥ login ç¨‹åº
   3. è‹¥ä¸é€šè¿‡åˆ™ä»¥ pam_deny.so èšç„¦ç™»å½•
4. ä¼šè®®é˜¶æ®µ sessionï¼š
   1. ä»¥ pam_selinux.so æš‚æ—¶å…³é—­ SELinux
   2. ä½¿ç”¨ pam_limits.so è®¾ç½®å¥½ç”¨æˆ·èƒ½å¤Ÿæ“ä½œçš„ç³»ç»Ÿèµ„æº
   3. ç™»å½•æˆåŠŸåå¼€å§‹è®°å½•ç›¸å…³ä¿¡æ¯åœ¨ç™»å½•æ–‡ä»¶ä¸­
   4. ä»¥ pam_loginuid.so è§„èŒƒä¸åŒçš„ UID æƒé™
   5. å¼€å¯ pam_selinux.so åŠŸèƒ½

è¿™å°èŠ‚æ„Ÿè§‰å¤ªéš¾äº†ï¼Œç¬”è€…æ²¡æœ‰çœ‹æ‡‚ä¹Ÿè”æƒ³ä¸åˆ°ï¼ŒåªçŸ¥é“ /etc/nologin æ–‡ä»¶å­˜åœ¨çš„è¯ï¼Œä¸€èˆ¬ä½¿ç”¨è€…éƒ½ä¸èƒ½ç™»å½•ï¼Œè¿œç¨‹è”æœºæœ‰å¯èƒ½æ— æ³•ä½¿ç”¨ root ç™»å½•ï¼Œè¿™äº›éƒ½æ˜¯ PAM æ¨¡å—æä¾›çš„åŠŸèƒ½

## ğŸ€ å…¶ä»–ç›¸å…³æ–‡ä»¶

å‰é¢è®²åˆ°ï¼š

- `/etc/securetty` ä¼šå½±å“åˆ° root å¯ç™»å½•çš„å®‰å…¨ç»ˆç«¯æœº
- `/etc/nologin` ä¼šå½±å“åˆ°ä¸€èˆ¬ä½¿ç”¨è€…æ˜¯å¦èƒ½å¤Ÿç™»å½•
- `/etc/pam.d` æ˜¯ PAM ç›¸å…³é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•
- `/usr/share/doc/pam-(ç‰ˆæœ¬)` æ˜¯ PAM è¯´æ˜æ–‡ä»¶æ‰€åœ¨ç›®å½•
- `/lib64/security` æ˜¯ PAM æ¨¡å—ç¨‹åºæ–‡ä»¶æ‰€åœ¨ç›®å½•

ä¸»è¦çš„ PAM æ–‡ä»¶éƒ½åœ¨ `/etc/security` ç›®å½•ä¸­ï¼Œä¸‹é¢ä»‹ç»å‡ ä¸ªå¯èƒ½ä¼šç”¨åˆ°çš„é…ç½®æ–‡ä»¶

### limits.conf

[ ç¬¬ 10 ç« è®²åˆ°çš„ ulimit åŠŸèƒ½ ](./10/02.md#ä¸æ–‡ä»¶ç³»ç»ŸåŠç¨‹åºçš„é™åˆ¶å…³ç³»ï¼šulimit)ï¼Œé™¤äº†ä¿®æ”¹ä½¿ç”¨è€…çš„ `~/.bashrc` é…ç½®æ–‡ä»¶å¤–ï¼Œç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥é€šè¿‡ PAM æ¥ç®¡ç†ï¼Œå°±æ˜¯ `/etc/security/limits.conf` è¿™ä¸ªæ–‡ä»¶ã€‚è¿™é‡Œåšä¸ªç®€å•ä»‹ç»

```bash
# èŒƒä¾‹ 1ï¼šmrcode1 è¿™ä¸ªç”¨æˆ·åªèƒ½å»ºç«‹ 100MB çš„æ–‡ä»¶ï¼Œä¸”å¤§äº 90MB ä¼šè­¦å‘Š

[root@study ~]# vim /etc/security/limits.conf 
#<domain>      <type>  <item>         <value>
#
mrcode1 soft    fsize   90000
mrcode1 hard    fsize   100000
# è´¦æˆ·	é™åˆ¶ç±»å‹	é™åˆ¶é¡¹ç›®	é™åˆ¶å€¼
1 å­—æ®µï¼šè´¦æˆ·æˆ–ç¾¤ç»„ï¼Œè‹¥ä¸ºç¾¤ç»„åˆ™å‰é¢éœ€è¦åŠ ä¸Š @ï¼Œä¾‹å¦‚ @projecta
2 å­—æ®µï¼šç±»å‹ï¼Œæ˜¯ä¸¥æ ¼ hardï¼Œè¿˜æ˜¯ä»…è­¦å‘Š soft
3 å­—æ®µï¼šæ­¤ä¾‹ä¸­æ˜¯æ–‡ä»¶å®¹é‡
4 å­—æ®µï¼šä¸ºé™åˆ¶å€¼ï¼Œåœ¨æ­¤åˆ—ä¸­å•ä½ä¸º KB

# ä½¿ç”¨ mrcode1 ç™»å½•åæ‰§è¡Œä»¥ä¸‹æ“ä½œ
[mrcode1@study ~]$ ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) 90000		# æŸ¥çœ‹åˆ°è¿™é‡Œé™åˆ¶å˜æˆäº† 90000

#å°è¯•åˆ›å»ºå¤§äº 90MB çš„æ–‡ä»¶
[mrcode1@study ~]$ dd if=/dev/zero of=test bs=1M count=110
File size limit exceeded (core dumped)
[mrcode1@study ~]$ ll --block-size=K test
-rw-rw-r--. 1 mrcode1 mrcode1 90000K Feb 25 22:07 test
# å‘ç°è¯¥æ–‡ä»¶æœ€å¤šåªæœ‰ 90MB

```

```bash
# èŒƒä¾‹ 2ï¼š é™åˆ¶ pro1 è¿™ä¸ªç¾¤ç»„ï¼Œæ¯æ¬¡ä»…èƒ½æœ‰ä¸€ä¸ªç”¨æˆ·ç™»å½•ç³»ç»Ÿ maxlogins
[root@study ~]# vim /etc/security/limits.conf
@pro1   hard    maxlogins 1

# ç¾¤ç»„åŠŸèƒ½é™åˆ¶ï¼Œä¼¼ä¹åªå¯¹åˆå§‹ç¾¤ç»„æ‰æœ‰æ•ˆæœé™åˆ¶
# å¦‚æœå°è¯•å¤šä¸ª pro1 çš„ç™»å½•æ—¶ï¼Œç¬¬äºŒä¸ªä»¥åå°±æ— æ³•ç™»å½•äº†
# å¹¶ä¸”ä¼šåœ¨ /var/secure æ–‡ä»¶ä¸­è¿˜ä¼šå‡ºç°å¦‚ä¸‹çš„ä¿¡æ¯
pam_limits(login:session): Too many logins (max 1) for pro1
```

è¯¥æ–‡ä»¶è®¾ç½®å®Œå°±ç”Ÿæ•ˆäº†ã€‚ç”±äº PAM æ˜¯åœ¨ç¨‹åºè°ƒç”¨æ—¶æ‰è®¾ç½®ï¼Œå¯¹äºå·²ç»ç™»å½•è¿‡çš„ç³»ç»Ÿæ˜¯æ²¡æœ‰æ•ˆæœçš„ã€‚å†æ¬¡ç™»å½•æ—¶æ‰ä¼šç”Ÿæ•ˆ

### `/var/log/secureã€/var/log/messages`

å¦‚æœå‘ç”Ÿä»»ä½•æ— æ³•ç™»å½•æˆ–åˆ™æ˜¯äº§ç”Ÿä¸€äº›ä½ æ— æ³•é¢„æœŸçš„é”™è¯¯æ—¶ï¼Œç”±äº PAM æ¨¡å—éƒ½ä¼šå°†æ•°æ®è®°è½½åˆ° `/etc/log/secure` ä¸­ï¼Œæ‰€ä»¥å‘ç”Ÿäº†é—®é¢˜ï¼ŒåŠ¡å¿…åˆ°è¯¥æ–‡ä»¶æŸ¥çœ‹ä¸‹æ—¥å¿—ä¿¡æ¯ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼šåœ¨ `limits.conf` ä»‹ç»çš„èŒƒä¾‹ 2 ä¸­ï¼Œå¤šé‡ç™»å½•é”™è¯¯å¯ä»¥åˆ° `/var/log/secure` å†…æŸ¥è¯¢

