---
title: 
sidebarDepth: 0 
category: Tools 
tag: Linux
---
# é¸Ÿå“¥çš„å¤‡ä»½ç­–ç•¥

å…³äºå¤‡ä»½æ¥è¯´ï¼Œéœ€è¦æ ¹æ®åœºæ™¯ï¼Œæ•°æ®çš„é‡è¦ç¨‹åº¦ï¼Œæˆæœ¬ç­‰æ–¹å¼æ¥ç»¼åˆè€ƒè™‘ï¼Œè€Œä½œè€…è¿™é‡Œå°†å¤‡ä»½åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š

- æ¯æ—¥å¤‡ä»½ç»å¸¸æ€§å˜åŒ–çš„é‡è¦æ•°æ®
- æ¯å‘¨å¤‡ä»½ä¸å¸¸å˜åŠ¨çš„ä¿¡æ¯

ç¼–å†™ä¸¤ä¸ªç®€å•çš„ scripts æ¥å®Œæ•´è¿™ä¸¤é¡¹å·¥ä½œã€‚

è¿™é‡Œé’ˆå¯¹ä½œè€…çš„ç½‘ç«™æ¥è¯´ï¼Œå¤‡ä»½ç­–ç•¥å¦‚ä¸‹ï¼š

1. ä¸»æœºç¡¬ä»¶ï¼šä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„ filesystem æ¥å­˜å‚¨å¤‡ä»½æ•°æ®ï¼Œæ­¤ filesystem æŒ‚è½½åˆ° /backup ä¸­
2. æ¯æ—¥è¿›è¡Œï¼šç›®å‰ä»…å¤‡ä»½ MySql æ•°æ®åº“
3. æ¯å‘¨è¿›è¡Œï¼šåŒ…æ‹¬ `/home`ã€`/var`ã€`/etc`ã€`/boot`ã€`/boot`ã€`/usr/local` ç­‰ç›®å½•ä¸ç‰¹æ®ŠæœåŠ¡çš„ç›®å½•
4. è‡ªåŠ¨å¤„ç†ï¼šåˆ©ç”¨ `/etc/crontab` æ¥è‡ªåŠ¨æä¾›å¤‡ä»½çš„åŠŸèƒ½
5. å¼‚åœ°å¤‡ä»½ï¼šæ¯æœˆå®šæœŸçš„å°†æ•°æ®åˆ†åˆ«
   1. åˆ»å½•åˆ°å…‰ç›˜ä¸Š
   2. ä½¿ç”¨ç½‘ç»œä¼ è¾“åˆ°å¦ä¸€å°æ•°æ®ä¸Š

ä¸‹é¢æ¼”ç¤ºä½œè€…å¯¹ä»¥ä¸Šéœ€æ±‚ç¼–å†™çš„ script

## ğŸ€ æ¯å‘¨ç³»ç»Ÿå¤‡ä»½çš„ script

`/backup/backupwk.sh`

```bash
#!/bin/bash
# ç”¨æˆ·è¾“å…¥ä½ç½®ï¼Œç”¨æ¥å­˜å‚¨æ­¤è„šæœ¬æ‰€é¢„è®¡å¤‡ä»½çš„æ•°æ®ç›®å½•ï¼ˆä½¿ç”¨ç‹¬ç«‹æ–‡ä»¶ç³»ç»Ÿè¾ƒå¥½ï¼‰
basedir=/backup/weekly

PATH=/bin:/usr/bin:/sbin:/usr/sbin; 
export PATH
export LANG=C

# è®¾ç½®è¦å¤‡ä»½çš„æœåŠ¡çš„é…ç½®æ–‡ä»¶ï¼Œä»¥åŠå¤‡ä»½ç›®å½•
named=$basedir/named
postfixd=$basedir/postfix
vsftpd=$basedir/vsftp
sshd=$basedir/ssh
sambad=$basedir/samba
wwwd=$basedir/www
others=$basedir/others
userinfod=$basedir/userinfo

# åˆ¤æ–­ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™å»ºç«‹
for dirs in $named $postfixd $vsftpd $sshd $sambad $wwwd $others $userinfod
do
	[ ! -d "$dirs" ] && mkdir -p $dirs
done

# 1. å°†ç³»ç»Ÿä¸»è¦çš„æœåŠ¡é…ç½®æ–‡ä»¶åˆ†åˆ«å¤‡ä»½ä¸‹æ¥ï¼ŒåŒæ—¶ä¹Ÿå¤‡ä»½ /etc/ å…¨éƒ¨
cp -a /var/named/chroot/{etc,var} $named
cp -a /etc/postfix /etc/dovecot.conf $postfixd
cp -a /etc/vsftpd/* $vsftpd
cp -a /etc/ssh/* $sshd
cp -a /etc/samba/* $sambad
cp -a /etc/{my.cnf,php.ini,httpd} $wwwd

cd /var/lib
tar -jpc -f $wwwd/mysql.tar.bz2 mysql
cd /var/www
tar -jpc -f $wwwd/html.tar.bz2 html cgi-bin
cd /
tar -jpc -f $others/etc/tar.bz2 etc
cd /usr/
tar -jpc -f $others/local.tar.bz2 local

# 2. å…³äºä½¿ç”¨è€…æ–¹é¢
cp -a /etc/{passwd,shadow,group} $userinfod
cd /var/spool
tar -jpc -f $userinfod/mail.tar.bz2 mail
cd /
tar -jpc -f $userinfod/home.tar.bz2 home
cd /var/spool
tar -jpc -f $userinfod/cron.tar.bz2 cron at

```

æ›´æ”¹è„šæœ¬æƒé™ä¸æ‰§è¡Œ

```bash
chmod 700 /backup/backupwk.sh
/backup/backupwk.sh
```

## ğŸ€ æ¯æ—¥å¤‡ä»½æ•°æ®çš„ script

`/backup/backupday.sh`

```bash
#!/bin/bash
# å¤‡ä»½åˆ°çš„ç›®å½•
basedir=/backup/daily

PATH=/bin:/usr/bin:/sbin:/usr/sbin; 
export PATH
export LANG=C

basefile1=$basedir/mysql.$(data +%Y-%m-%d).tar.bz2
basefile2=$basedir/cgi-bin.$(data +%Y-%m-%d).tar.bz2

[ -d "$basedir" ] && mkdir $basedir

# 1. mysql æ•°æ®åº“ç›®å½•å’‹ /var/lib/mysql
cd /var/lib
tar -jpc -f $basefile1 mysql

# 2. www çš„ CGI ç¨‹åº
cd /var/www
tar -jpc -f $basefile2 cgi-bin
```

ä¸‹é¢æä¾›æ¯å‘¨ä¸æ¯æ—¥çš„ crontab é…ç½®

```bash
vim /etc/crontab
# æ¯å‘¨æ—¥çš„ 3:30 è¿›è¡Œé‡è¦æ–‡ä»¶å¤‡ä»½
30 3 * * 0 root /backup/backupwk.sh
# æ¯å¤© 2ï¼š30 è¿›è¡Œæ•°æ®åº“çš„å¤‡ä»½
30 2 * * * root /backup/backupday.sh
```

åœ¨è¿™ä¸ªå¤‡ä»½æ–¹æ¡ˆä¸­æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼šå½“ä½ å¤‡ä»½çš„æ—¶å€™ï¼Œå¦‚æœæ°å·§æœ‰æœ‰äººå‘è¡¨æ–‡ç« ï¼ˆmysql æ•°æ®å˜æ›´äº†ï¼‰ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å¯¼è‡´å‡ºç°ä¸€äº›é”™è¯¯ä¿¡æ¯ï¼Œè¿™é‡Œåªèƒ½æ˜¯å…ˆåœæ‰ mysql æœåŠ¡ï¼Œåœ¨å¼€å§‹å¤‡ä»½

## ğŸ€ è¿œç¨‹å¤‡ä»½ script

å¦‚æœä½ æœ‰ä¸¤å° Linux ä¸»æœºæ—¶ï¼Œé‚£ä¹ˆäº’ç›¸å°†å¯¹æ–¹çš„é‡è¦æ•°æ®ä¿å­˜ä¸€ä»½åœ¨è‡ªå·±çš„ç³»ç»Ÿä¸­ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„åŠæ³•ï¼Œå¯ä»¥ç”¨ sshd æœåŠ¡æ¥å®Œæˆä¸»æœºä¹‹é—´çš„æ•°æ®ä¼ è¾“

### ä½¿ç”¨ rsync ä¸Šä¼ å¤‡ä»½æ•°æ®

ä½¿ç”¨ rsync å¿…é¡»è¦åœ¨ä½ çš„æœåŠ¡å™¨ä¸Šå–å¾—æŸä¸ªè´¦æˆ·çš„ä½¿ç”¨æƒåï¼Œå¹¶è®©è¯¥è´¦æˆ·å¯ç”¨ä¸ç”¨å¯†ç å³å¯ç™»å½•æ‰å¯ä»¥ã€‚

å‡è®¾ä½ å·²ç»è®¾ç½®å¥½ mrcode å…å¯†ç™»å½•è¿œç¨‹æœåŠ¡å™¨ï¼Œéœ€è¦å°† `/backup/weekly` æ•´ä¸ªå¤‡ä»½åˆ° `/home/backup/weekly` æ—¶ï¼Œå¯ä»¥ç®€å•è¿™æ ·åš

```bash
vim /backup/rsync.sh
#!/bin/bash
remotedir=/home/backup/
basedir=/backup/weekly
host=127.0.0.1
id=mrcode

# ä¸‹é¢ä¸ºå®é™…çš„æŒ‡ä»¤
rsync -av -e ssh $basedir ${id}@${host}:${remotedir}
```

rsync å¯ä»¥é€šè¿‡ ssh æ¥è¿›è¡Œé•œåƒå¤‡ä»½ï¼Œæ‰€ä»¥æ²¡æœ‰å˜æ›´çš„æ–‡ä»¶å°†ä¸éœ€è¦ä¸Šä¼ ï¼Œéå¸¸çš„æ–¹ä¾¿

