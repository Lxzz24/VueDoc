---
title: 
sidebarDepth: 0 
category: Tools 
tag: Linux
---
# æœ¬ç« ä¹ é¢˜

# æƒ…æ™¯æ¨¡æ‹Ÿé¢˜

é€šè¿‡è®¾ç½®ã€å¯åŠ¨ã€è§‚å¯Ÿç­‰æœºåˆ¶ï¼Œå®Œæ•´äº†è§£ä¸€ä¸ªæœåŠ¡çš„å¯åŠ¨ä¸è§‚å¯Ÿ

- ç›®æ ‡ï¼šäº†è§£ daemon çš„ç®¡æ§æœºåˆ¶ï¼Œä»¥ sshd daemon ä¸ºä¾‹
- å‰æï¼šéœ€è¦å¯¹æœ¬ç« å·²ç»äº†è§£ï¼Œå°¤å…¶æ˜¯ systemd çš„ç®¡ç†éƒ¨åˆ†
- éœ€æ±‚ï¼šå·²ç»æœ‰ sshd è¿™ä¸ªæœåŠ¡ï¼Œä½†æ˜¯æ²¡æœ‰ä¿®æ”¹è¿‡ç«¯å£

å¯åŠ¨ä¸¤ä¸ª sshd æœåŠ¡ï¼Œå¦ä¸€ä¸ªä¸€ä¸ªä½¿ç”¨ç«¯å£ 222

```bash
# 1. æŸ¥çœ‹ sshd æœåŠ¡æ˜¯å¦å­˜åœ¨
[root@study ~]# systemctl status sshd.service 
* sshd.service - OpenSSH server daemon
   Loaded: loaded (/usr/lib/systemd/system/sshd.service; enabled; vendor preset: enabled)
   Active: active (running) since Tue 2020-03-17 10:49:56 CST; 3 days ago
     Docs: man:sshd(8)
           man:sshd_config(5)
 Main PID: 1378 (sshd)
    Tasks: 1
   CGroup: /system.slice/sshd.service
           `-1378 /usr/sbin/sshd -D

Mar 17 10:49:55 study.centos.mrcode systemd[1]: Starting OpenSSH server daemon...
Mar 17 10:49:56 study.centos.mrcode sshd[1378]: Server listening on 0.0.0.0 port 22.
Mar 17 10:49:56 study.centos.mrcode sshd[1378]: Server listening on :: port 22.
Mar 17 10:49:56 study.centos.mrcode systemd[1]: Started OpenSSH server daemon.
Mar 17 10:51:42 study.centos.mrcode sshd[2344]: Accepted password for mrcode from 192.168.4.170 port 60750 ssh2
Mar 17 17:35:40 study.centos.mrcode sshd[7250]: Accepted password for ftptest from 192.168.4.170 port 59071 ssh2
Mar 17 22:22:50 study.centos.mrcode sshd[10579]: Accepted password for root from 192.168.4.170 port 59851 ssh2

# æŸ¥çœ‹ä»–çš„å¯åŠ¨è„šæœ¬æ–‡ä»¶
[root@study ~]# cat /usr/lib/systemd/system/sshd.service
[Unit]
Description=OpenSSH server daemon
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target sshd-keygen.service
Wants=sshd-keygen.service

[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/sshd
ExecStart=/usr/sbin/sshd -D $OPTIONS
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target

# é€šè¿‡ man ssshd ä¸­çš„ FILES ä¿¡æ¯ä¸­ï¼Œæ‰¾åˆ°äº†ä»–çš„é…ç½®æ–‡ä»¶åœ°å€
/etc/ssh/sshd_config
             Contains configuration data for sshd.  The file format and configuration options are described in sshd_config(5).

# 2. å¤åˆ¶è¯¥é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¿®æ”¹ç«¯å£å·ä¸º 222
[root@study ~]# cd /etc/ssh/
[root@study ssh]# cp sshd_config sshd2_config
[root@study ssh]# vim sshd2_config
Port 222

# 3. ä¿®æ”¹å¯åŠ¨è„šæœ¬ç­‰æ–‡ä»¶
[root@study ssh]# cd /etc/systemd/system/
[root@study system]# cp /usr/lib/systemd/system/sshd.service sshd2.service
[root@study system]# vim sshd2.service
[Unit]
Description=OpenSSH server daemon 2
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target sshd-keygen.service
Wants=sshd-keygen.service

[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/sshd
# ä¸»è¦æ˜¯è¿™é‡Œ
ExecStart=/usr/sbin/sshd -f /etc/ssh/sshd2_config -D $OPTIONS
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target
# ä¸Šè¿°å¢åŠ äº† -f å‚æ•°æŒ‡å®šäº†åˆšåˆšæˆ‘ä»¬å¤åˆ¶å‡ºæ¥çš„é…ç½®æ–‡ä»¶
# è¯¥è¯­æ³•æ˜¯ä»è¿™ä¸ªè„šæœ¬ä¸­çš„ Documentation=man:sshd(8)ï¼Œç„¶åä½¿ç”¨ man 8 sshd èµ„æ–™ä¸­ SYNOPSIS ä¸­çš„  [-f config_file] å¾—çŸ¥ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªé…ç½®æ–‡ä»¶
# æ‰€ä»¥ï¼Œå…¶å®è¿™ä¸€æ­¥åº”è¯¥åœ¨æœ€å¼€å§‹çš„æ—¶å€™å»æŸ¥é˜…ï¼Œç„¶åæ‰æ˜¯æ¥è¾¾æˆè¿™ä¸ªé…ç½®æ–‡ä»¶çš„æ“ä½œ

# 4. é‡æ–°åŠ è½½é…ç½®ä¸è¿™ä¸ªæœåŠ¡çš„å¯åŠ¨ç­‰è§‚å¯Ÿ
[root@study system]# systemctl daemon-reload 
[root@study system]# systemctl enable sshd2.service 
Created symlink from /etc/systemd/system/multi-user.target.wants/sshd2.service to /etc/systemd/system/sshd2.service.
[root@study system]# systemctl start sshd2.service  
Job for sshd2.service failed because the control process exited with error code. See "systemctl status sshd2.service" and "journalctl -xe" for details.
[root@study system]# systemctl status sshd2.service 
* sshd2.service - OpenSSH server daemon 2
   Loaded: loaded (/etc/systemd/system/sshd2.service; enabled; vendor preset: disabled)
   Active: activating (auto-restart) (Result: exit-code) since Fri 2020-03-20 14:04:25 CST; 12s ago
     Docs: man:sshd(8)
           man:sshd_config(5)
  Process: 21511 ExecStart=/usr/sbin/sshd -f /etc/ssh/sshd2_config -D $OPTIONS (code=exited, status=255)
 Main PID: 21511 (code=exited, status=255)

Mar 20 14:04:25 study.centos.mrcode systemd[1]: sshd2.service: main process exited, code=exited, status=255/n/a
Mar 20 14:04:25 study.centos.mrcode systemd[1]: Failed to start OpenSSH server daemon 2.
Mar 20 14:04:25 study.centos.mrcode systemd[1]: Unit sshd2.service entered failed state.
Mar 20 14:04:25 study.centos.mrcode systemd[1]: sshd2.service failed.

# å‘ç°æ²¡æœ‰å¯åŠ¨èµ·æ¥ï¼Œå¯åŠ¨å¤±è´¥äº†ï¼Œå»è§‚å¯Ÿä»–çš„æ—¥å¿—è®°å½•
[root@study system]# tail -n 20 /var/log/messages
Mar 20 14:05:08 study python: SELinux is preventing /usr/sbin/sshd from name_bind access on the tcp_socket port 222.#012#012*****  Plugin bind_ports (99.5 confidence) suggests   ************************#012#012If you want to allow /usr/sbin/sshd to bind to network port 222#012Then you need to modify the port type.#012Do#012# semanage port -a -t PORT_TYPE -p tcp 222#012    where PORT_TYPE is one of the following: ssh_port_t, vnc_port_t, xserver_port_t.#012#012*****  Plugin catchall (1.49 confidence) suggests   **************************#012#012If you believe that sshd should be allowed name_bind access on the port 222 tcp_socket by default.#012Then you should report this as a bug.#012You can generate a local policy module to allow this access.#012Do#012allow this access for now by executing:#012# ausearch -c 'sshd' --raw | audit2allow -M my-sshd#012# semodule -i my-sshd.pp#012

# ä¼šå‘ç°è§¦å‘äº† SELInux ï¼Œæ²¡æœ‰é€šè¿‡æ£€æŸ¥ï¼Œ 99.5 çš„é‚£ä¸ªé…ç½®æ–¹æ¡ˆçš„è§£å†³å‘ŠçŸ¥æˆ‘ä»¬éœ€è¦æ‰§è¡Œ
semanage port -a -t ssh_port_t -p tcp 222
[root@study system]# netstat -tlnp | grep ssh
tcp        0      0 127.0.0.1:6010          0.0.0.0:*               LISTEN      2350/sshd: mrcode@p 
tcp        0      0 127.0.0.1:6011          0.0.0.0:*               LISTEN      10579/sshd: root@pt 
tcp        0      0 0.0.0.0:222             0.0.0.0:*               LISTEN      21918/sshd          
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1378/sshd           
tcp6       0      0 ::1:6010                :::*                    LISTEN      2350/sshd: mrcode@p 
tcp6       0      0 ::1:6011                :::*                    LISTEN      10579/sshd: root@pt 
tcp6       0      0 :::222                  :::*                    LISTEN      21918/sshd          
tcp6       0      0 :::22                   :::*                    LISTEN      1378/sshd

# å°±ä¼šå‘ç°å·²ç»å¯åŠ¨æˆåŠŸäº†
```

## ğŸ€ ç®€å•éƒ¨åˆ†

- ä½¿ç”¨ `netstat -tul` ä¸ `netstat -tunl` æœ‰ä»€ä¹ˆå·®åˆ«

  ä½¿ç”¨ n æ—¶ï¼Œnetstat ä¸ä¼šä½¿ç”¨ä¸»æœºåä¸æœåŠ¡åè¡¨ç¤ºï¼Œè€Œæ˜¯ä»¥ IP å’Œ ç«¯å£æ¥æ˜¾ç¤ºã€‚IP çš„åˆ†æä¸ `/etc/hosts` å’Œ `/etc/resolv.conf` æœ‰å…³ï¼Œport åˆ™ä¸ `/etc/services` æœ‰å…³

- æ‰¾åˆ° port 3306 çš„ç«¯å£å·çš„æœåŠ¡æ˜¯ä»€ä¹ˆ

  å¯ä»¥é€šè¿‡æœç´¢ `/etc/services` æœç´¢åˆ° 3306 å¯¹åº”ä¸ mysql æœåŠ¡ã€‚

  å¹¶ä¸”é€šè¿‡ `netstat -tlnp | grep 3306` çš„æ–¹å¼ä¹Ÿèƒ½å¾—åˆ°ä»–çš„æœåŠ¡åç§°ï¼ˆå¦‚æœè¿è¡Œä¸­çš„è¯ï¼‰

- å¯ä»¥é€šè¿‡å“ªäº›æŒ‡ä»¤æŸ¥è¯¢åˆ°ç›®å‰ç³»ç»Ÿé»˜è®¤å¼€æœºå¯åŠ¨çš„æœåŠ¡

  `systemctl list-units` å’Œ `systemctl list-unit-files`

- è·å–å“ªäº›æœåŠ¡åœ¨å¯åŠ¨çŠ¶æ€?

  é€šè¿‡ä¸Šé¢æŸ¥è¯¢å‡ºæ¥çš„æœåŠ¡ï¼Œåº”è¯¥ä½¿ç”¨ `systemctl status [unit.service]` ä¸€é¡¹ä¸€é¡¹æŸ¥è¯¢