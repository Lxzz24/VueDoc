---
title: 
sidebarDepth: 0 
category: Tools 
tag: Linux
---
# systemctl é’ˆå¯¹ timer çš„é…ç½®æ–‡ä»¶

æŸäº›æ—¶å€™éœ€è¦å®šæœŸæ‰§è¡ŒæŸé¡¹å·¥ä½œï¼Œæˆ–åˆ™æ˜¯å¼€æœºåæ‰§è¡Œï¼Œæˆ–åˆ™æ˜¯æŸæœåŠ¡å¯åŠ¨å¤šä¹…åæ‰§è¡Œç­‰ç­‰çš„éœ€æ±‚ã€‚åœ¨ä»¥å‰å¯ä»¥ä½¿ç”¨ crond æ¥å®šæœŸå¤„ç†ï¼Œå¦‚ä»Šæœ‰ systemd è¿™ä¸ªé•¿æœŸé©»ç•™åœ¨å†…å­˜ä¸­å¥½ç”¨çš„æœåŠ¡ï¼Œå¦å¤–è¿˜æä¾›äº†ä¸€ä¸ªååŠ›æœåŠ¡ timers.target ï¼Œå®ƒå¯ä»¥ååŠ©å®šæœŸå¤„ç†å„ç§ä»»åŠ¡

## ğŸ€ systemd.timer çš„ä¼˜åŠ¿

åœ¨ archlinux çš„å®˜ç½‘ wiki ä¸Šæœ‰æåˆ°ï¼Œä¸ºå•¥è¦ç”¨ systemd.timer ?

- ç”±äºæ‰€æœ‰çš„ systemd çš„æœåŠ¡äº§ç”Ÿçš„ä¿¡æ¯éƒ½ä¼šè¢«è®°å½•ï¼ˆlogï¼‰ï¼Œå› æ­¤æ¯” crond åœ¨ debug ä¸Šè¦æ›´æ¸…æ¥šæ–¹ä¾¿
- å„é¡¹ timer çš„å·¥ä½œå¯ä»¥è·Ÿ systemd çš„æœåŠ¡ç›¸ç»“åˆ
- å„é¡¹ timer çš„å·¥ä½œå¯ä»¥è·Ÿ control groupï¼ˆcgroup ç”¨æ¥å–ä»£ /etc/secure/limit.conf çš„åŠŸèƒ½ï¼‰ç»“åˆï¼Œæ¥é™åˆ¶è¯¥å·¥ä½œçš„èµ„æºåˆ©ç”¨
- æ—¶é—´å®‰æ’å¯ä»¥ç²¾ç¡®åˆ°æ¯«ç§’çš„å•ä½

å¼±ç‚¹å°±æ˜¯ï¼šæ²¡æœ‰ email é€šçŸ¥åŠŸèƒ½ï¼ˆé™¤éè‡ªå·±å®ç° email é€šçŸ¥ï¼‰ï¼Œä¹Ÿæ²¡æœ‰ç±»ä¼¼ anacron ä¸€æ®µæ—¶é—´å†…çš„éšæœºå–æ ·åŠŸèƒ½ï¼ˆrandom_delayï¼‰

## ğŸ€ ä»»åŠ¡éœ€æ±‚

æƒ³è¦ç”¨ systemd çš„ timer åŠŸèƒ½ï¼Œå¿…é¡»æœ‰å¦‚ä¸‹æ¡ä»¶ï¼š

- ç³»ç»Ÿçš„ timer.target å¿…é¡»å¯åŠ¨
- è¦æœ‰ sname.service çš„æœåŠ¡å­˜åœ¨ï¼šsname æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„åç§°
- è¦æœ‰ sname.timer çš„æ—¶é—´å¯åŠ¨æœåŠ¡å­˜åœ¨

ä½¿ç”¨å‰ä¸€å°èŠ‚å†™å¥½çš„  backup.service æ¥æµ‹è¯•

## ğŸ€ sname.timer çš„è®¾ç½®

`[Timer]` éƒ¨åˆ†

- OnActiveSecï¼šå½“ timers.target å¯åŠ¨å¤šä¹…åæ‰æ‰§è¡Œè¯¥ unit

- OnBootSecï¼šå½“å¼€æœºåå¤šä¹…ä¹‹åæ‰æ‰§è¡Œ

- OnStartupSecï¼šå½“ systemd ç¬¬ä¸€æ¬¡å¯åŠ¨åå¤šä¹…æ‰æ‰§è¡Œ

- OnUnitActiveSecï¼šè¿™ä¸ª timer é…ç½®æ–‡ä»¶æ‰€ç®¡ç†çš„é‚£ä¸ª unit æœåŠ¡åœ¨æœ€åä¸€æ¬¡å¯åŠ¨åï¼Œç›¸éš”å¤šä¹…åå†æ‰§è¡Œä¸€æ¬¡

- OnUnitInactiveSecï¼šè¿™ä¸ª timer é…ç½®æ–‡ä»¶æ‰€ç®¡ç†çš„é‚£ä¸ª unit æœåŠ¡åœ¨æœ€åä¸€æ¬¡åœæ­¢åï¼Œéš”å¤šä¹…å†æ‰§è¡Œä¸€æ¬¡

- OnCalendarï¼šä½¿ç”¨å®é™…æ—¶é—´ï¼ˆéå¾ªç¯æ—¶é—´ï¼‰çš„æ–¹å¼æ¥å¯åŠ¨æœåŠ¡ã€‚æ—¶é—´æ ¼å¼åç»­è®²è§£

- Unitï¼š

  ä¸€èˆ¬æ¥è¯´ä¸å¤ªéœ€è¦è®¾ç½®ï¼Œå½“ä½ çš„ sname.service ä¸ sname.timer ä¸­çš„ sname ä¸ä¸€è‡´æ—¶ï¼Œè¿™é‡ŒæŒ‡å‘çš„ service unit

- Persistent

  å½“ä½¿ç”¨ OnCalendar çš„è®¾ç½®æ—¶ï¼ŒæŒ‡å®šè¯¥åŠŸèƒ½è¦ä¸è¦æŒç»­è¿›è¡Œã€‚é€šå¸¸è®¾ç½®ä¸º yesï¼Œæ¯”è¾ƒèƒ½æ»¡è¶³ç±»ä¼¼ anacron çš„åŠŸèƒ½

## ğŸ€ ä½¿ç”¨ OnCalendar çš„æ—¶é—´

æƒ³è¦ä» crontab è½¬æˆ timer çš„åŠŸèƒ½ï¼Œå¯¹äºæ—¶é—´æ ¼å¼éœ€è¦äº†è§£ï¼ŒåŸºæœ¬ä¸Šçš„æ ¼å¼å¦‚ä¸‹

```bash
è¯­æ³•ï¼šè‹±æ–‡å‘¨å YYYY-MM-DD HH:MM:SS
èŒƒä¾‹ï¼šThu	  2020-03-20 10:00:00
```

ä¹Ÿå¯ä»¥ä½¿ç”¨æ—¶é—´é—´éš”æ—¶é—´æ¥å¤„ç†ï¼Œå¸¸ç”¨çš„æ—¶é—´é—´éš”å•ä½æœ‰ï¼š

- us æˆ– usecï¼šå¾®ç§’
- ms æˆ– msecï¼šæ¯«ç§’
- sã€secã€secondã€seconds
- mã€minã€minuteã€minutes
- hã€hrã€hourã€hours
- dã€dayã€days
- wã€weekã€weeks
- monthã€months
- yã€yearã€years

å¸¸è§çš„èŒƒä¾‹æœ‰

```bash
éš” 3 å°æ—¶ï¼š				3h æˆ– 3hr æˆ– 3hours
éš” 300 åˆ†é’Ÿè¿‡ 10 ç§’ï¼š	   10s 300m	
éš” 5 å¤©åˆ 100 åˆ†é’Ÿï¼š	   100m 5day
# é€šå¸¸è‹±æ–‡çš„å†™æ³•ï¼šå°å•ä½å†™åœ¨å‰é¢ï¼Œå¤§å•ä½å†™åé¢ã€å…ˆç§’ã€åˆ†ã€å°æ—¶ã€å¤©ç­‰
```

æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‹±æ–‡å¸¸ç”¨çš„å£è¯­åŒ–æ—¥æœŸä»£è¡¨ï¼Œä¾‹å¦‚ todayã€tomorrow ç­‰ï¼Œå‡è®¾ä»Šå¤©æ˜¯ 2015-08-13 13:50:00 é‚£ä¹ˆ

- nowï¼šThu 2015-08-13 13:50:00
- todayï¼šThu 2015-08-13 00:00:00
- tomorrowï¼šThu 2015-08-14 00:00:00
- hourlyï¼š`*-*-* *:00:00`
- dailyï¼š`*-*-* 00:00:00`
- weeklyï¼š`Mon *-*-* 00:00:00`
- monthlyï¼š`*-*-01 00:00:00`
- +3h10mï¼šThu 2015-08-13 17:00:00
- 2015-08-16ï¼šSun 2015-08-16 00:00:00

## ğŸ€ ä¸€ä¸ªå¾ªç¯æ—¶é—´è¿è¡Œçš„æ¡ˆä¾‹

éœ€æ±‚å¦‚ä¸‹ï¼š

- å¼€æœºå 2 å°æ—¶å¼€å§‹æ‰§è¡Œä¸€æ¬¡  backup.service
- è‡ªä»ç¬¬ä¸€æ¬¡æ‰§è¡Œåï¼Œæœªæ¥æ¯ä¸¤å¤©æ‰§è¡Œä¸€æ¬¡ backup.service

```bash
[root@study ~]# vim /etc/systemd/system/backup.timer
[Unit]
Description=backup my server timer

[Timer]
OnBootSec=2hrs
OnUnitActiveSec=2days

[Install]
WantedBy=multi-user.target

[root@study ~]# systemctl daemon-reload 
[root@study ~]# systemctl enable backup.timer
Created symlink from /etc/systemd/system/multi-user.target.wants/backup.timer to /etc/systemd/system/backup.timer.
[root@study ~]# systemctl restart backup.timer    
[root@study ~]# systemctl list-unit-files | grep backup
backup.service                                disabled		# åªéœ€è¦ timer å¯åŠ¨å°± ok
backup.timer                                  enabled

[root@study ~]# systemctl show timers.target 
ConditionTimestamp=Tue 2020-03-17 10:49:38 CST		# timer è¿™ä¸ª unit å¯åŠ¨çš„æ—¶é—´

[root@study ~]# systemctl show backup.service | grep ExecMainStartTimestamp
ExecMainStartTimestamp=Fri 2020-03-20 09:38:19 CST	# backup.service ä¸Šä¸€æ¬¡æ‰§è¡Œçš„æ—¶é—´

[root@study ~]# systemctl show backup.timer | grep NextElapseUSecMonotonic 
NextElapseUSecMonotonic=4d 22h 48min 56.756775s		# ä¸‹ä¸€æ¬¡æ‰§è¡Œè·ç¦» timers.target çš„æ—¶é—´
```

å…³äºè¿™ä¸ª NextElapseUSecMonotonic å€¼å¾—è¯´æ˜ï¼Œä¸Šæ¬¡æ‰§è¡Œ backup.service çš„æ—¶é—´åœ¨ 2020-03-20 09:38:19ï¼Œç”±äº 2 å¤©æ‰§è¡Œä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´åº”è¯¥æ˜¯ 2020-03-22 09:38:19 æ‰å¯¹ï¼Œä½†æ˜¯ç”±äº timer æ˜¯ç”± timers.target è¿™ä¸ª unit æ‰€ç®¡ç†çš„ï¼Œè€Œè¿™ä¸ª timers.target å¯åŠ¨æ—¶é—´æ˜¯åœ¨ 2020-03-17 10:49:38ï¼Œæ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ª NextElapseUSecMonotonic  è®°å½•çš„ä¸‹æ¬¡è¿è¡Œçš„æ—¶é—´ï¼Œå…¶å®æ˜¯ä¸ timers.target æ‰€è®°å½•çš„æ—¶é—´å·®ï¼Œå› æ­¤æ˜¯ `2020-03-22 09:38:19 -`  2020-03-17 10:49:38` ç»“æœå°±æ˜¯ç›¸å·® 4d 22h 48min;

è®¡ç®—å…¬å¼ï¼šNextElapseUSecMonotonic  = å®é™…ä¸‹ä¸€æ¬¡è¿è¡Œçš„æ—¶é—´ - timers.target çš„å¯åŠ¨æ—¶é—´



## ğŸ€ ä¸€ä¸ªå›ºå®šæ—¥æœŸè¿è¡Œçš„æ¡ˆä¾‹

```bash
[root@study ~]# vim /etc/systemd/system/backup2.timer
[Unit]
Description=backup my server timer2

[Timer]
OnCalendar=Sun *-*-* 02:00:00
Persistent=true
Unit=backup.service		# è¿™é‡Œçš„ timer åç§°ä¸åŸæ¥çš„ service ä¸ä¸€è‡´ï¼Œè¿™é‡ŒæŒ‡å®šä¸‹

[Install]
WantedBy=multi-user.target

[root@study ~]# systemctl daemon-reload
[root@study ~]# systemctl enable backup2.timer
Created symlink from /etc/systemd/system/multi-user.target.wants/backup2.timer to /etc/systemd/system/backup2.timer.
[root@study ~]# systemctl restart backup2.timer 
[root@study ~]# systemctl list-unit-files | grep backup
backup.service                                disabled
backup.timer                                  enabled 
backup2.timer                                 enabled 
[root@study ~]# systemctl show timers.target | grep ConditionTimestamp
ConditionTimestamp=Tue 2020-03-17 10:49:38 CST
ConditionTimestampMonotonic=15862087
[root@study ~]#  systemctl show backup.service | grep ExecMainStartTimestamp
ExecMainStartTimestamp=Fri 2020-03-20 09:38:19 CST
ExecMainStartTimestampMonotonic=254936756737
[root@study ~]# systemctl show backup2.timer | grep NextElapseUSecRealtime
NextElapseUSecRealtime=50y 2month 2w 5d 9h
# ç”±äºåªæœ‰ä¸€æ¬¡è¿è¡Œï¼Œæ‰€ä»¥æ²¡æœ‰ NextElapseUSecMonotonic å€¼äº†ã€‚
# è¿™é‡Œçš„æ—¶é—´æ˜¯ Unix æ ‡å‡†æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯æ˜¯ 1970-01-01 00:00:00 å»æ¯”è¾ƒçš„
# è¿™é‡Œæ˜¯ 50 å¹´ 2ä¸ªæœˆ 2å‘¨ 5å¤© 9å°æ—¶æ‰ä¼šæ‰§è¡Œï¼Œè¿™ä¸ªæ˜¯å¯¹æ¯”çš„æ—¥å†æ—¶é—´ï¼ˆ1970-01-01 00:00:00ï¼‰
# æ—¶é—´çš„åŸºå‡†å€¼ä¸ä¸€æ ·ã€‚ä¸€å®šè¦æ³¨æ„
```

