---
title: 
sidebarDepth: 0 
category: Tools 
tag: Linux
---
# SELinux åˆæ¢

CentOS 5.x ä¹‹åï¼ŒSELinux å·²ç»æ˜¯ä¸ªéå¸¸å®Œå¤‡çš„æ ¸å¿ƒæ¨¡å—äº†ï¼Œå°¤å…¶æ˜¯ CentOS æä¾›äº†å¾ˆå¤šç®¡ç† SELinux çš„æŒ‡ä»¤ä¸æœºåˆ¶ï¼Œå› æ­¤åœ¨æ•´ç†æ¶æ„ä¸Šé¢æ˜¯å•çº¯ä¸”å®¹æ˜“æ“ä½œç®¡ç†çš„ï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰è‡ªè¡Œå¼€å‘ç½‘ç»œæœåŠ¡è½¯ä»¶ä»¥åŠä½¿ç”¨å…¶ä»–ç¬¬ä¸‰æ–¹ååŠ›è½¯ä»¶çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯å…¨éƒ¨ä½¿ç”¨ CentOS å®˜æ–¹æä¾›çš„è½¯ä»¶æ¥ä½¿ç”¨æˆ‘ä»¬æœåŠ¡å™¨çš„æƒ…å†µä¸‹ï¼Œå»ºè®®ä¸è¦å…³é—­ SELinux

## ğŸ€ ä»€ä¹ˆæ˜¯ SELinux

Security Enhanced Linux çš„ç¼©å†™ SELinuxï¼Œå­—é¢æ„æ€æ˜¯å®‰å…¨å¼ºåŒ–çš„ LInuxã€‚è‡³äºå¼ºåŒ–çš„æ˜¯å“ªä¸ªéƒ¨åˆ†ï¼Ÿä¸‹é¢æ¥äº†è§£ä¸‹

### å½“åˆè®¾è®¡çš„ç›®æ ‡ï¼šé¿å…èµ„æºçš„è¯¯ç”¨

SELinux æ˜¯ç”±ç¾å›½å›½å®¶å®‰å…¨å±€ï¼ˆNSAï¼‰å¼€å‘çš„ï¼Œéœ€æ±‚æ¥æºäºå†…éƒ¨å‘˜å·¥èµ„æºè¯¯ç”¨å¯¼è‡´ç³»ç»Ÿå‡ºç°é—®é¢˜ï¼›

èµ„æºè¯¯ç”¨ï¼šå°†ä¸€ä¸ª `/var/www/html/` ç›®å½•æƒé™è®¾ç½®æˆ 777ï¼Œé‚£ä¹ˆå½“å¯åŠ¨ www æœåŠ¡å™¨è½¯ä»¶ï¼Œå°±æ„å‘³ç€è¿™ä¸ªè½¯ä»¶è§¦å‘çš„è¿›ç¨‹æ‹¥æœ‰å¯¹è¯¥ç›®å½•å†™å…¥çš„æƒé™ï¼Œåªè¦é€šè¿‡è¯¥è¿›ç¨‹æœåŠ¡å™¨å¯¹ç›®å½•å¤§é‡å†™å…¥ï¼Œå°±ä¼šå¯¼è‡´ç³»ç»Ÿç¡¬ç›˜èµ„æºè¢«çˆ†ç ´

SELinux æ˜¯åœ¨è¿›è¡Œè¿›ç¨‹ã€æ–‡ä»¶ç­‰è¥¿éƒ¨æƒé™è®¾ç½®ä¾æ®çš„ä¸€ä¸ªæ ¸å¿ƒæ¨¡å—ï¼Œç”±äºå¯åŠ¨ç½‘ç»œæœåŠ¡çš„ä¹Ÿæ˜¯è¿›ç¨‹ï¼Œå› æ­¤åˆšå¥½ä¹Ÿèƒ½å¤Ÿæ§åˆ¶ç½‘ç»œæœåŠ¡æ˜¯å¦èƒ½å­˜å–ç³»ç»Ÿèµ„æºçš„ä¸€é“å…³å¡

åœ¨è®²è§£ SELinux ä¹‹å‰ï¼Œå…ˆå›é¡¾ä¸€ä¸‹ä¹‹å‰è®²åˆ°çš„ï¼šç³»ç»Ÿæ–‡ä»¶æƒé™ä¸ç”¨æˆ·ä¹‹é—´çš„å…³ç³»

### ä¼ ç»Ÿçš„æ–‡ä»¶æƒé™ä¸è´¦æˆ·å…³ç³»ï¼šè‡ªä¸»å¼è®¿é—®æ§åˆ¶ DAC

ç¬¬ 13 ç« ä¸­è®²åˆ°ï¼šç³»ç»Ÿè´¦æˆ·ä¸»è¦åˆ†ä¸ºç³»ç»Ÿç®¡ç†å‘˜ï¼ˆrootï¼‰ä¸ä¸€èˆ¬ç”¨æˆ·ï¼Œä»–ä»¬èƒ½å¦ä½¿ç”¨ç³»ç»Ÿä¸Šçš„æ–‡ä»¶èµ„æºä¸ rwx æƒé™è®¾ç½®æœ‰å…³ã€‚ï¼ˆå„ç§æƒé™è®¾ç½®å¯¹ root æ— æ•ˆï¼‰ã€‚å½“æŸä¸ªè¿›ç¨‹æƒ³è¦å¯¹æ–‡ä»¶è¿›è¡Œå­˜å–æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®è¯¥è¿›ç¨‹çš„æ‹¥æœ‰è€…ã€ç¾¤ç»„ï¼Œå¹¶æ¯”å¯¹æ–‡ä»¶çš„æƒé™ï¼Œè‹¥é€šè¿‡æƒé™æ£€æŸ¥ï¼Œå°±å¯ä»¥å­˜å–è¯¥æ–‡ä»¶

è¿™ç§å­˜å–æ–‡ä»¶çš„æ–¹å¼è¢«ç§°ä¸º **è‡ªä¸»å¼è®¿é—®æ§åˆ¶ Discretionary Access Controller ç®€ç§° DAC**ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ä¾æ®è¿›ç¨‹çš„æ‹¥æœ‰è€…ä¸æ–‡ä»¶èµ„æºçš„ rwx æƒé™æ¥å†³å®šæœ‰æ— å­˜å–çš„èƒ½åŠ›ã€‚DAC æœ‰å¦‚ä¸‹å›°æ‰°ï¼š

- root å…·æœ‰æœ€é«˜çš„æƒé™ï¼šåªè¦å–å¾—å±äº root çš„è¿›ç¨‹ï¼Œé‚£ä¹ˆå°±å¾ˆå±é™©
- ä½¿ç”¨è€…å¯ä»¥å–å¾—è¿›ç¨‹æ¥å˜æ›´æ–‡ä»¶èµ„æºçš„è®¿é—®æƒé™ï¼šå¦‚æœå°†æŸä¸ªç›®å½•æƒé™ä¸å°å¿ƒè®¾ç½®ä¸º 777ï¼Œç”±äºå¯¹ä»»ä½•äººçš„æƒé™ä¼šå˜æˆ rwxï¼Œå› æ­¤è¯¥ç›®å½•å°±ä¼šè¢«ä»»ä½•äººæ‰€ä»»æ„å­˜å–

### ä»¥æ”¿ç­–è§„åˆ™è§„å®šç‰¹å®šè¿›ç¨‹è¯»å–ç‰¹å®šæ–‡ä»¶ï¼šå§”ä»»å¼è®¿é—®æ§åˆ¶ MAC

ä¸ºäº†é¿å… DAC çš„å›°æ‰°ï¼ŒSELinux å¯¼å…¥äº†å§”ä»»å¼è®¿é—®æ§åˆ¶ Mandatory Access Control ç®€ç§° MAC

MAC å¯ä»¥é’ˆå¯¹ç‰¹å®šçš„è¿›ç¨‹ä¸ç‰¹å®šçš„æ–‡ä»¶èµ„æºæ¥è¿›è¡Œæƒé™çš„æ§åˆ¶ã€‚å³ä½¿ä½ æ˜¯ rootï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨ä¸åŒçš„è¿›ç¨‹æ—¶ï¼Œä½ æ‰€èƒ½å–å¾—çš„æƒé™å¹¶ä¸ä¸€å®šæ˜¯ rootï¼Œè€Œéœ€è¦çœ‹å½“æ—¶è¯¥è¿›ç¨‹çš„è®¾ç½®ã€‚å¦‚æ­¤ä¸€æ¥é’ˆå¯¹æ§åˆ¶çš„ã€Œä¸»ä½“ã€å˜æˆäº†ã€Œè¿›ç¨‹ã€è€Œä¸æ˜¯ä½¿ç”¨è€…ï¼Œä½†æ˜¯çœŸä¸ªç³»ç»Ÿè¿›ç¨‹å¾ˆå¤šã€æ–‡ä»¶ä¹Ÿå¾ˆå¤šï¼Œä¸€é¡¹ä¸€é¡¹æ§åˆ¶å¤ªéº»çƒ¦ï¼Œæ‰€ä»¥ SELinux ä¹Ÿæä¾›ä¸€äº›é¢„è®¾çš„æ”¿ç­– **Policy** ï¼Œå¹¶åœ¨è¯¥æ”¿ç­–å†…æä¾›å¤šä¸ªè§„åˆ™ **rule**ï¼Œè®©ä½ å¯ä»¥é€‰æ‹©æ˜¯å¦å¯ç”¨è¯¥æ§åˆ¶è§„åˆ™

åœ¨è¯¥ç§æ¨¡å¼ä¸‹ï¼Œè¿›ç¨‹èƒ½å¤Ÿæ´»åŠ¨çš„ç©ºå˜å°äº†ã€‚æ¯”å¦‚ï¼šwww æœåŠ¡å™¨è½¯ä»¶è¾¾æˆè¿›ç¨‹ä¸º httpd è¿™ä¸ªç¨‹åºï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ httpd ä»…èƒ½åœ¨ `/var/www` ç›®å½•ä¸‹å­˜å–æ–‡ä»¶ï¼Œå¦‚æœ httpd è¿›ç¨‹è¦å»å…¶ä»–ç›®å½•å­˜å‚¨æ•°æ®æ—¶ï¼Œé™¤äº†è§„åˆ™è®¾ç½®è¦å¼€æ”¾å¤–ï¼Œç›®æ ‡ç›®å½•ä¹Ÿè¦è®¾ç½®æˆ httpd å¯è¯»å–çš„æ¨¡å¼ type æ‰è¡Œï¼Œé™åˆ¶éå¸¸å¤šï¼Œæ‰€ä»¥ï¼Œå³ä½¿ httpd è¿™ä¸ªè¿›ç¨‹è¢«é»‘å®¢å–å¾—äº†æ§åˆ¶æƒé™ï¼Œå®ƒä¹Ÿæ— æƒé™æµè§ˆå…¶ä»–çš„ç›®å½•æ–‡ä»¶

ç®€å•è¯´ï¼Œé’ˆå¯¹ Apache è¿™ä¸ª www ç½‘ç»œæœåŠ¡ä½¿ç”¨ DAC æˆ– MAC çš„ç»“æœæ¥è¯´ï¼Œä¸¤è€…çš„å…³ç³»å¯ç”¨ä¸‹å›¾æ¥è¯´æ˜

![image-20200316175339460](./assets/image-20200316175339460.png)

åœ†ç¯è¡¨ç¤ºç”»åœ°ä¸ºç‰¢ï¼ŒDAC æ¨¡å¼ä¸‹ï¼Œç”±äºæ˜¯ rootï¼Œç‰¢æˆ¿å¯¹ root æ— æ•ˆã€‚åœ¨ MAC ä¸‹ï¼Œç‰¢æˆ¿å°±ç”Ÿæ•ˆäº†

## ğŸ€ SELinux çš„è¿ä½œæ¨¡å¼

**å¼ºè°ƒ**ï¼šSELinux æ˜¯é€šè¿‡ MAC æ–¹å¼æ¥ç®¡æ§ **è¿›ç¨‹**ï¼Œè¿›ç¨‹æ˜¯ä¸»ä½“ï¼Œè€Œç›®æ ‡åˆ™æ˜¯è¯¥è¿›ç¨‹èƒ½å¦è¯»å–çš„æ–‡ä»¶èµ„æºã€‚

- ä¸»ä½“ Subjectï¼šå¯ä»¥çœ‹æˆå°±æ˜¯ è¿›ç¨‹

- ç›®æ ‡ Objectï¼šç›®æ ‡èµ„æºï¼Œä¸€èˆ¬å°±æ˜¯æ–‡ä»¶ç³»ç»Ÿ

- æ”¿ç­– Policyï¼šä¼šæ ¹æ®æŸäº›æœåŠ¡æ¥åˆ¶å®šåŸºæœ¬çš„å­˜å–å®‰å…¨æ€§æ”¿ç­–ï¼Œæ”¿ç­–å†…è¿˜ä¼šæœ‰è¯¦ç»†çš„è§„åˆ™ rule æ¥æŒ‡å®šä¸åŒçš„æœåŠ¡å¼€æ”¾æŸäº›èµ„æºçš„å­˜å–ã€‚åœ¨ç›®å‰çš„ CentOS 7.x é‡Œé¢ä»…æä¾› 3 ä¸ªä¸»è¦çš„æ”¿ç­–ï¼š

  - targetedï¼šé’ˆå¯¹ç½‘ç»œæœåŠ¡é™åˆ¶è¾ƒå¤šï¼Œé’ˆå¯¹æœ¬æœºé™åˆ¶è¾ƒå°‘ï¼Œæ˜¯é¢„è®¾çš„æ”¿ç­–
  - minimumï¼šç”± target ä¿®æ­£è€Œæ¥ï¼Œä»…é’ˆå¯¹é€‰æ‹©çš„è¿›ç¨‹æ¥ä¿æŠ¤
  - mlsï¼šå®Œæ•´çš„ SELinux é™åˆ¶ï¼Œé™åˆ¶æ–¹é¢è¾ƒä¸¥æ ¼

- å®‰å…¨æ€§æœ¬æ–‡ security context

  ä¸»ä½“æ˜¯å¦èƒ½å­˜å–ç›®æ ‡é™¤äº†æ”¿ç­–æŒ‡å®šä¹‹å¤–ï¼Œ**ä¸»ä½“ä¸ç›®æ ‡çš„å®‰å…¨æ€§æœ¬æ–‡å¿…é¡»ä¸€è‡´æ‰èƒ½å¤Ÿé¡ºåˆ©å­˜å–**

   security context ç±»ä¼¼æ–‡ä»¶ç³»ç»Ÿçš„ rwxï¼Œå¦‚æœè®¾ç½®é”™è¯¯ï¼Œä½ çš„æŸäº›æœåŠ¡ï¼ˆä¸»ä½“è¿›ç¨‹ï¼‰å°±æ— æ³•å­˜å–æ–‡ä»¶ç³»ç»Ÿï¼ˆç›®æ ‡èµ„æºï¼‰ï¼Œå°±ä¼šå‡ºç°æƒé™ä¸ç¬¦å¯¹çš„é”™è¯¯ä¿¡æ¯äº†

ç”±äº SELinux é‡ç‚¹åœ¨ä¿æŠ¤è¿›ç¨‹è¯»å–æ–‡ä»¶ç³»ç»Ÿçš„æƒé™ï¼Œä¸Šè¿°è¯´æ˜çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![image-20200317094948523](./assets/image-20200317094948523.png)

ä¼ ç»Ÿçš„è¿›ç¨‹ä¸æ–‡ä»¶çš„ rwx æ–¹å¼ï¼Œåœ¨è¿™ä¸­é—´å¢åŠ äº† SELinux æœˆ å®‰å…¨æ€§æœ¬æ–‡ _è§„åˆ™_ ï¼Œé€šè¿‡äº†è¿™äº›è§„åˆ™ä¹‹åï¼Œæ‰å’Œä¼ ç»Ÿçš„è¿›ç¨‹ä¸æ–‡ä»¶çš„ rwx æ–¹å¼ä¸€è‡´ã€‚

ç¬”è€…ç†è§£ä¸ºæ˜¯é€šè¿‡æ‹¦æˆªå™¨çš„æ–¹å¼ï¼Œå‡ºå°äº† SELinux ï¼Œå‰é¢é€šè¿‡ SElinux æ‹¦æˆªç»†åŒ–æƒé™ï¼Œç¬¦åˆè¦æ±‚çš„å†å»åˆ°ä¼ ç»Ÿçš„æ–¹å¼ï¼Œè¿™æ ·ä¸€æ¥å°±å¯¹ä¼ ç»Ÿçš„åŠ å¼ºäº†

### å®‰å…¨æ€§æœ¬æ–‡ Security Context

CentOS 7.x çš„ target æ”¿ç­–æä¾›äº†éå¸¸å¤šçš„è§„åˆ™ï¼Œåªéœ€è¦å¦‚ä½•å¼€å¯å…³é—­æŸé¡¹è§„åˆ™å³å¯ã€‚

å®‰å…¨æ€§æœ¬æ–‡åˆ™éå¸¸éº»çƒ¦ï¼Œå¯èƒ½éœ€è¦è‡ªè¡Œé…ç½®å®ƒï¼Œæ¯”å¦‚ä½ å¸¸å¸¸è®¾ç½®æ–‡ä»¶çš„ rwx æƒé™ï¼Œé‚£ä¹ˆè¿™ä¸ªå®‰å…¨æ€§æœ¬æ–‡å°±ç±»ä¼¼ï¼Œå¯ä»¥çœ‹æˆæ˜¯ SELinux ä¸­çš„ rwx

å®‰å…¨æ€§æœ¬æ–‡å­˜åœ¨äºä¸»ä½“è¿›ç¨‹ä¸­ä¸ç›®æ ‡æ–‡ä»¶èµ„æºä¸­ï¼Œç‰©ç†ä½ç½®æ˜¯æ”¾åœ¨æ–‡ä»¶çš„ inode ä¸­ï¼Œå› æ­¤ä¸»ä½“è¿›ç¨‹æƒ³è¦è¯»å–ç›®æ ‡æ–‡ä»¶èµ„æºæ—¶ï¼ŒåŒæ ·éœ€è¦è¯»å– inodeï¼Œè¿™å°±å¯ä»¥å¯¹æ¯”å®‰å…¨æ€§æœ¬æ–‡ä¸€çº§ rwx ç­‰æƒé™æ˜¯å¦æ­£ç¡®äº†ã€‚

è§‚å¯Ÿå®‰å…¨æ€§æœ¬æ–‡å¯ä½¿ç”¨ `ls -Z` ï¼Œä½†æ˜¯å‰ææ˜¯éœ€è¦å¯åŠ¨ SELinux æ‰è¡Œï¼Œä¸‹ä¸ªå°èŠ‚ä¼šä»‹ç»å¦‚ä½•å¯åŠ¨ SELinuxï¼Œè¿™é‡Œå…ˆä»‹ç»çŸ¥è¯†ç‚¹

```bash
[root@study ~]# ls -Z
-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 accountadd.sh
-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 accountadd.txt
-rwxr--r--+ root root unconfined_u:object_r:admin_home_t:s0 acl_test1
-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 addaccount2.sh
-rw-------. root root system_u:object_r:admin_home_t:s0 anaconda-ks.cfg
-rw-r--r--. root root system_u:object_r:admin_home_t:s0 initial-setup-ks.cfg
# ä¸Šè¿°å­—æ®µå¾ˆé•¿çš„é‚£ä¸€æ å°±æ˜¯å®‰å…¨æ€§æœ¬æ–‡äº†
```

å®‰å…¨æ€§æœ¬æ–‡ä¸»è¦ç”¨å†’å·åˆ†å‰²ä¸ºä¸‰ä¸ªå­—æ®µï¼Œå«ä¹‰å¦‚ä¸‹ï¼š

- identifyï¼šèº«ä»½

  ç›¸å½“äºè´¦æˆ·æ–¹é¢çš„èº«ä»½è¯†åˆ«ï¼Œå¸¸è§æœ‰å‡ ä¸‹å‡ ç§ç±»å‹

  - unconfined_uï¼šä¸å—é™çš„ç”¨æˆ·

    è¯¥æ–‡ä»¶æ¥è‡ªä¸å—é™çš„è¿›ç¨‹æ‰€äº§ç”Ÿçš„ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨å¯ç™»å½•è´¦å·æ¥å–å¾— bashï¼Œé¢„è®¾çš„ bash ç¯å¢ƒæ˜¯ä¸å— SELinux ç®¡åˆ¶çš„ï¼Œå› ä¸º bash å¹¶ä¸æ˜¯ä»€ä¹ˆç‰¹åˆ«çš„ç½‘ç»œæœåŠ¡ï¼Œå› æ­¤åœ¨è¯¥ bash è¿›ç¨‹æ‰€äº§ç”Ÿçš„æ–‡ä»¶ï¼Œå…¶èº«ä»½è¯†åˆ«å¤§å¤šå°±æ˜¯è¯¥ç±»å‹äº†

  - system_uï¼šç³»ç»Ÿç”¨æˆ·

    åŸºæœ¬ä¸Šï¼Œå¦‚æœæ˜¯ç³»ç»Ÿä¼šè½¯ä»¶æœ¬èº«æ‰€æä¾›çš„æ–‡ä»¶ï¼Œå¤§å¤šå°±æ˜¯è¯¥ç±»å‹ï¼Œå¦‚æœæ˜¯ç”¨æˆ·é€šè¿‡ bash è‡ªå·±å»ºç«‹çš„æ–‡ä»¶ï¼Œå¤§å¤šåˆ™æ˜¯ä¸å—é™çš„ unconfined_u èº«ä»½ï¼Œå¦‚æœæ˜¯ç½‘ç»œæœåŠ¡æ‰€äº§ç”Ÿçš„æ–‡ä»¶ï¼Œæˆ–åˆ™æ˜¯ç³»ç»ŸæœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„æ–‡ä»¶ï¼Œåˆ™å¤§éƒ¨åˆ†æ˜¯ system_u 

- roleï¼šè§’è‰²

  é€šè¿‡è¯¥å­—æ®µï¼Œå¯ä»¥çŸ¥é“è¿™ä¸ªèµ„æ–™æ˜¯å±äºè¿›ç¨‹ã€æ–‡ä»¶èµ„æºè¿˜æ˜¯ä»£è¡¨ä½¿ç”¨è€…ï¼Œä¸€èˆ¬çš„è§’è‰²æœ‰ï¼š

  - object_rï¼šä»£è¡¨çš„æ˜¯æ–‡ä»¶æˆ–ç›®å½•ç­‰æ–‡ä»¶èµ„æº
  - system_rï¼šä»£è¡¨çš„æ˜¯è¿›ç¨‹ï¼Œä¸è¿‡ä¸€èˆ¬ä½¿ç”¨è€…ä¹Ÿä¼šè¢«æŒ‡å®šä¸º system_r

- typeï¼šç±»å‹ï¼Œæœ€é‡è¦

  åœ¨é¢„è®¾çš„ targeted æ”¿ç­–ä¸­ï¼Œ identify ä¸ role å­—æ®µåŸºæœ¬ä¸Šæ˜¯ä¸é‡è¦çš„ï¼Œè€Œ type æ˜¯æœ€é‡è¦çš„ï¼ŒåŸºæœ¬ä¸Šï¼Œä¸€ä¸ªä¸»ä½“è¿›ç¨‹èƒ½ä¸èƒ½è¯»å–åˆ°è¿™ä¸ªæ–‡ä»¶èµ„æºï¼Œä¸ç±»å‹å­—æ®µæœ‰å…³ï¼Œè€Œç±»å‹å­—æ®µåœ¨æ–‡ä»¶ä¸è¿›ç¨‹çš„å®šä¹‰ä¸ç›¸åŒï¼š

  - typeï¼šåœ¨æ–‡ä»¶èµ„æºï¼ˆobjectï¼‰ä¸Šé¢ç§°ä¸ºç±»å‹ï¼ˆtypeï¼‰
  - domainï¼šåœ¨ä¸»ä½“è¿›ç¨‹ï¼ˆsubjectï¼‰åˆ™ç§°ä¸ºé¢†åŸŸï¼ˆdomainï¼‰

  domain éœ€è¦ä¸ type æ­é…ï¼Œåˆ™è¯¥è¿›ç¨‹æ‰èƒ½å¤Ÿé¡ºåˆ©çš„è¯»å–æ–‡ä»¶èµ„æº

  ## è¿›ç¨‹ä¸æ–‡ä»¶ SELinux type å­—æ®µçš„ç›¸å…³æ€§

  é€šè¿‡èº«ä»½è¯†åˆ«ä¸è§’è‰²å­—æ®µçš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å¤§æ¦‚æŸä¸ªè¿›ç¨‹æ‰€ä»£è¡¨çš„æ„ä¹‰

  ```bash
  # è§‚å¯Ÿä¸‹ç³»ç»Ÿ è¿›ç¨‹çš„ SELinux ç›¸å…³ä¿¡æ¯
  [root@study ~]# ps -eZ
  LABEL                             PID TTY          TIME CMD
  system_u:system_r:init_t:s0         1 ?        00:00:01 systemd
  system_u:system_r:kernel_t:s0       2 ?        00:00:00 kthreadd
  system_u:system_r:kernel_t:s0       4 ?        00:00:00 kworker/0:0H
  system_u:system_r:kernel_t:s0       5 ?        00:00:00 kworker/u2:0
  ...
  system_u:system_r:sshd_t:s0-s0:c0.c1023 2344 ? 00:00:00 sshd
  unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 2350 ? 00:00:00 sshd
  unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 2353 pts/0 00:00:00 bash
  unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 2415 pts/0 00:00:00 su
  unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 2424 pts/0 00:00:00 bash
  system_u:system_r:kernel_t:s0    2726 ?        00:00:00 kworker/u2:2
  system_u:system_r:kernel_t:s0    2778 ?        00:00:00 kworker/0:1
  system_u:system_r:kernel_t:s0    2836 ?        00:00:00 kworker/0:3
  system_u:system_r:kernel_t:s0    2877 ?        00:00:00 kworker/0:0
  system_u:system_r:ksmtuned_t:s0  2885 ?        00:00:00 sleep
  unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 2886 pts/0 00:00:00 ps
  
  # åŸºæœ¬ä¸Šè¿›ç¨‹ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œ
  # ä¸€ç§æ˜¯ç³»ç»Ÿæœ‰å—é™çš„ system_u:system_rï¼Œ
  # å¦ä¸€ç§å¯èƒ½æ˜¯ç”¨æˆ·è‡ªå·±çš„ï¼Œæ¯”è¾ƒä¸å—é™çš„è¿›ç¨‹ï¼ˆé€šå¸¸æ˜¯æœ¬æœºç”¨æˆ·è‡ªå·±æ‰§è¡Œçš„ç¨‹åº ï¼‰ unconfined_u:unconfined_r
  
  # unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 2424 pts/0 00:00:00 bash
  # æ¯”å¦‚ä¸Šé¢è¿™ä¸ªè¿›ç¨‹ï¼Œå°±æ˜¯æˆ‘ä»¬è‡ªå·±æ‰§è¡Œå‘½ä»¤æ‰€åœ¨çš„ bash
  
  ```

  åŸºæœ¬ä¸Šï¼Œè¿™äº›å¯¹äºèµ„æ–™åœ¨ targeted æ”¿ç­–ä¸‹çš„å¯¹åº”å¯¹ä¸‹

  | èº«ä»½è¯†åˆ«     | è§’è‰²         | å¯¹åº”åœ¨ targeted çš„æ„ä¹‰                                       |
  | ------------ | ------------ | ------------------------------------------------------------ |
  | unconfined_u | unconfined_r | ä¸€èˆ¬å¯ç™»é™†ä½¿ç”¨è€…çš„è¿›ç¨‹ï¼Œæ¯”è¾ƒæ²¡æœ‰å—é™çš„è¿›ç¨‹ã€‚å¤§å¤šæ•°éƒ½æ˜¯ç”¨æˆ·å·²ç»é¡ºåˆ©ç™»é™†ç³»ç»Ÿï¼ˆä¸è®ºæ˜¯ç½‘ç»œè¿˜æ˜¯æœ¬æœºç™»é™†æ¥å–å¾—å¯ç”¨çš„ shellï¼‰åï¼Œæ‰€ç”¨æ¥æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ï¼Œå¦‚ bash x window ç›¸å…³å¯Œå®‰å±…ç­‰ |
  | system_u     | system_r     | ç”±äºä¸ºç³»ç»Ÿè´¦æˆ·ï¼Œå› æ­¤æ˜¯éäº¤è°ˆå¼çš„ç³»ç»Ÿè¿è¡Œè¿›ç¨‹ï¼Œå¤§å¤šæ•°çš„ç³»ç»Ÿè¿›ç¨‹å‡æ˜¯è¿™ç§ç±»å‹ |

  å¦‚ä¸Šæ‰€è¿°ï¼Œåœ¨é¢„è®¾çš„ target æ”¿ç­–ä¸‹ï¼Œæœ€é‡è¦çš„æ˜¯ type å­—æ®µï¼Œä¸»ä½“ä¸ç›®æ ‡ä¹‹é—´æ˜¯å¦å…·æœ‰å¯è¯»å†™çš„æƒé™ï¼Œä¸è¿›ç¨‹çš„ domain ä¸æ–‡ä»¶çš„ type æœ‰å…³ã€‚è¿™ä¸¤è€…çš„å…³ç³»å¯ä»¥ä½¿ç”¨ crond ä»¥åŠä»–çš„é…ç½®æ–‡ä»¶æ¥è¯´æ˜
  
  ```bash
  # 1. å…ˆçœ‹çœ‹ crond è¿™ä¸ªè¿›ç¨‹çš„å®‰å…¨æœ¬æ–‡å†…å®¹
  [root@study ~]# ps -eZ | grep cron
  system_u:system_r:crond_t:s0-s0:c0.c1023 1398 ? 00:00:00 atd
  system_u:system_r:crond_t:s0-s0:c0.c1023 1400 ? 00:00:00 crond
  # è¿™ä¸ªå®‰å…¨æœ¬æ–‡çš„ç±»å‹åç§°ä¸º crond_t æ ¼å¼
  
  # 2. çœ‹çœ‹ /usr/ssbin/crond ã€ /etc/cron.dã€/etc/cron.d æ–‡ä»¶çš„å®‰å…¨æœ¬æ–‡å†…å®¹
  [root@study ~]# ll -Zd /usr/sbin/crond /etc/crontab /etc/cron.d
  drwxr-xr-x. root root system_u:object_r:system_cron_spool_t:s0 /etc/cron.d
  -rw-r--r--. root root system_u:object_r:system_cron_spool_t:s0 /etc/crontab
  -rwxr-xr-x. root root system_u:object_r:crond_exec_t:s0 /usr/sbin/crond
  ```
  
  æ‰§è¡Œ `/usr/ssbin/crond` åï¼Œè¯¥ç¨‹åºç¼–ç¨‹çš„è¿›ç¨‹ domain ç±»ä¼¼æ˜¯ crond_tï¼Œå®ƒèƒ½å¤Ÿè¯»å–çš„é…ç½®æ–‡ä»¶æ˜¯ `system_cron_spool_t` ç±»å‹ã€‚å› æ­¤æ— è®º `/etc/crontab`ä¸ `/etc/cron.d` ä»¥åŠ `/var/spool/cron` éƒ½ä¼šæ˜¯ç›¸å…³çš„ SELinux ç±»å‹ï¼ˆ`/var/spool/cron` ä¸º `user_cron_spool_t` ç±»å‹ï¼‰ã€‚ä¸‹é¢å›¾ç¤ºè¯´æ˜
  
  ![image-20200317115128966](./assets/image-20200317115128966.png)

1.  crond æ‰§è¡Œåï¼Œå…·æœ‰ crond_exec_t ç±»å‹
2. è¯¥æ–‡ä»¶ç±»å‹ä¼šé€ æˆä¸»ä½“è¿›ç¨‹ Subject å…·æœ‰ crond è¿™ä¸ªé¢†åŸŸ domainï¼Œæ”¿ç­–é’ˆå¯¹è¿™ä¸ªé¢†åŸŸæœ‰è®¸å¤šè§„åˆ™ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å¯ä»¥è¯»å–çš„ç›®æ ‡èµ„æºç±»å‹
3. ç”±äº crond domain è¢«è®¾ç½®ä¸ºå¯ä»¥è¯»å– system_cron_spool_t ç±»å‹çš„ç›®æ ‡æ–‡ä»¶ objectï¼Œå› æ­¤ä½ çš„é…ç½®æ–‡ä»¶æ”¾åˆ° `/etc/cron.d/` ç›®å½•ä¸‹ï¼Œå°±èƒ½å¤Ÿè¢« crond è¿›ç¨‹è¯»å–äº†
4. ä½†æ˜¯æœ€ç»ˆèƒ½ä¸èƒ½è¯»åˆ°æ­£ç¡®çš„èµ„æ–™ï¼Œè¿˜éœ€è¦çœ‹ä¼ ç»Ÿçš„ rwx æ˜¯å¦ç¬¦åˆ Linux çš„æƒé™è§„èŒƒ

ä¸‹é¢æ¥æµ‹è¯•ä¸Šè¿°è¯´æ˜

```bash
# 1. å‡è®¾ä½ å› ä¸ºä¸ç†Ÿæ‚‰çš„ç¼˜æ•…ï¼Œå› æ­¤æ˜¯åœ¨ root å®¶ç›®å½•å»ºç«‹ä¸€ä¸ªå¦‚ä¸‹çš„ cron è®¾ç½®
[root@study ~]# vim checktime
10 * * * * root sleep 60s

# 2. å‘ç°æ–‡ä»¶æ”¾é”™ç›®å½•äº†ï¼Œåˆä¸æƒ³è¦ä¿ç•™å‰¯æœ¬ï¼Œå› æ­¤ä½¿ç”¨ mv ç§»åŠ¨åˆ°æ­£ç¡®çš„ç›®å½•
[root@study ~]# mv checktime /etc/cron.d/
[root@study ~]# ll /etc/cron.d/checktime 
-rw-r--r--. 1 root root 26 Mar 17 13:12 /etc/cron.d/checktime
# æƒé™æ˜¯ 644ï¼Œä»»ä½•è¿›ç¨‹éƒ½å¯ä»¥è¯»å–

# 3. å¼ºåˆ¶é‡æ–°å¯åŠ¨ crondï¼Œç„¶åæŸ¥çœ‹ç™»å½•æ—¥å¿—
[root@study ~]# systemctl restart crond          
[root@study ~]# tail /var/log/cron
Mar 17 13:01:01 study run-parts(/etc/cron.hourly)[3889]: finished mcelog.cron
Mar 17 13:10:01 study CROND[3972]: (root) CMD (/usr/lib64/sa/sa1 1 1)
Mar 17 13:14:01 study crond[1400]: ((null)) Unauthorized SELinux context=system_u:system_r:system_cronjob_t:s0-s0:c0.c1023 file_context=unconfined_u:object_r:admin_home_t:s0 (/etc/cron.d/checktime)
Mar 17 13:14:01 study crond[1400]: (root) FAILED (loading cron table)
Mar 17 13:15:08 study crond[1400]: (CRON) INFO (Shutting down)
Mar 17 13:15:08 study crond[4073]: (CRON) INFO (RANDOM_DELAY will be scaled with factor 13% if used.)
Mar 17 13:15:08 study crond[4073]: ((null)) Unauthorized SELinux context=system_u:system_r:system_cronjob_t:s0-s0:c0.c1023 file_context=unconfined_u:object_r:admin_home_t:s0 (/etc/cron.d/checktime)
Mar 17 13:15:08 study crond[4073]: (root) FAILED (loading cron table)
Mar 17 13:15:08 study crond[4073]: (CRON) INFO (running with inotify support)
Mar 17 13:15:08 study crond[4073]: (CRON) INFO (@reboot jobs will be run at computer's startup.)

# ä¸Šè¿°æ—¥å¿—ä¸­æœ‰ Unauthorized çš„ä¿¡æ¯ï¼Œè¡¨ç¤ºæœ‰é”™è¯¯ï¼Œå› ä¸ºåŸæœ¬çš„å®‰å…¨æœ¬æ–‡ä¸æ–‡ä»¶çš„å®é™…å®‰å…¨æœ¬æ–‡æ— æ³•æ­é…çš„ç¼˜æ•…ï¼Œ
# ä¿¡æ¯è¿˜åˆ—å‡ºäº† SELinux context ä¸ file_context çš„ä¿¡æ¯ï¼Œè¡¨ç¤ºçš„ç¡®ä¸åŒ¹é…
```

ä»å¦‚ä¸Šçš„æµ‹è¯•æ¥çœ‹ï¼Œä¸Šè¿°æµ‹è¯•ç”±äºå®‰å…¨æœ¬æ–‡ä¸åŒ¹é…å¯¼è‡´è¿›ç¨‹æ— æ³•è¯»å–è¯¥æ–‡ä»¶

## ğŸ€ SELinux ä¸‰ç§æ¨¡å¼çš„å¯åŠ¨ã€å…³é—­ä¸è§‚å¯Ÿ

å¹¶éæ‰€æœ‰çš„ Linux distribution éƒ½æ”¯æŒ SELinuxï¼ŒCentOS 7.x æœ¬èº«å°±æœ‰æ”¯æŒ SELinuxï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦è‡ªè¡Œç¼–è¯‘ SELinux åˆ°ä½ çš„ Linux æ ¸å¿ƒä¸­ã€‚ç›®å‰ SELinux æ˜¯å¦å¯åŠ¨æœ‰ä¸‰ç§æ¨¡å¼ï¼š

- enforcingï¼šå¼ºåˆ¶æ¨¡å¼ï¼Œè¡¨ç¤º SELinux è¿è¡Œä¸­ï¼Œä¸”å·²ç»æ­£ç¡®çš„å¼€å§‹é™åˆ¶ domain/type äº†
- permissiveï¼šå®½å®¹æ¨¡å¼ï¼Œè¡¨ç¤º SELinux è¿è¡Œä¸­ï¼Œä¸è¿‡ä»…æœ‰è­¦å‘Šè¿›è¡Œå¹¶ä¸ä¼šå®é™…é™åˆ¶ domain/type çš„å­˜å–ã€‚è¿™ç§æ¨¡å¼å¯ä»¥ç”¨æ¥ debug SELinux çš„é…ç½®
- disabledï¼šSELinux å…³é—­ä¸­

ä¸‰ç§æ¨¡å¼çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![image-20200317132323274](./assets/image-20200317132323274.png)

æ³¨æ„ï¼šå¹¶éæœ‰æ‰€çš„è¿›ç¨‹éƒ½å— SELinux çš„ç®¡æ§ï¼Œæ³¨æ„æ˜¯æœ‰ **å—é™çš„è¿›ç¨‹ä¸»ä½“**ï¼Œå¯ä»¥é€šè¿‡ `ps -eZ` æ¥è§‚å¯Ÿè¯¥è¿›ç¨‹æ˜¯å¦æœ‰å—é™ï¼ˆconfinedï¼‰ã€‚ä¸‹é¢æ¥è§‚å¯Ÿ crond ä¸ bash ç¨‹åºæ˜¯å¦æœ‰è¢«é™åˆ¶

```bash
[root@study ~]# ps -eZ | grep -E 'cron|bash'
system_u:system_r:crond_t:s0-s0:c0.c1023 1398 ? 00:00:00 atd
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 2353 pts/0 00:00:00 bash
unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 2424 pts/0 00:00:00 bash
system_u:system_r:crond_t:s0-s0:c0.c1023 4073 ? 00:00:00 crond
```

å› ä¸ºç›®å‰ target è¿™ä¸ªæ”¿ç­–ä¸‹ï¼Œåªæœ‰ç¬¬ 3 ä¸ªå­—æ®µ type ä¼šæœ‰å½±å“ï¼Œå› æ­¤å¯ä»¥çœ‹åˆ° crond æœ‰ `crond_t` ç±»å‹ï¼Œæ˜¯å—é™çš„ï¼Œè€Œ bash æ˜¯ `unconfined_t` ç±»å‹ï¼Œæ˜¯ä¸å—é™çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ bash ä¸ä¼šç»è¿‡ä¸Šå›¾çš„æµç¨‹ï¼Œè€Œç›´æ¥å»åˆ¤å®š rwx

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–å½“å‰çš„ SELinux æ¨¡å¼

```bash
[root@study ~]# getenforce 
Enforcing
```

æŸ¥è¯¢å½“å‰ SELinux çš„æ”¿ç­–ï¼ˆPolicyï¼‰

```bash
sestatus [-vb]

é€‰é¡¹ä¸å‚æ•°ï¼š
	-vï¼šæ£€æŸ¥ /etc/sestatus.conf å†…çš„æ–‡ä»¶ä¸è¿›ç¨‹çš„å®‰å…¨æ€§æœ¬æ–‡å†…å®¹
	-bï¼šå°†ç›®å‰æ”¿ç­–çš„è§„åˆ™å¸ƒå°”å€¼åˆ—å‡ºï¼Œå³æŸäº›è§„åˆ™ rule æ˜¯å¦è¦å¯åŠ¨ï¼ˆ0/1ï¼‰
```

```bash
# èŒƒä¾‹ 1ï¼šåˆ—å‡ºç›®å‰ SELinux ä½¿ç”¨çš„å“ªä¸ªæ”¿ç­– Policy

[root@study ~]# sestatus   		
SELinux status:                 enabled				# SELinux æ˜¯å¦å¯åŠ¨
SELinuxfs mount:                /sys/fs/selinux		# SELinux çš„ç›¸å…³æ–‡ä»¶æ•°æ®æŒ‚è½½ç‚¹
SELinux root directory:         /etc/selinux		# SELinux çš„æ ¹ç›®å½•æ‰€åœ¨
Loaded policy name:             targeted			# å½“å‰çš„æ”¿ç­–
Current mode:                   enforcing			# å½“å‰æ¨¡å¼
Mode from config file:          enforcing			# ç›®å‰é…ç½®æ–‡ä»¶å†…è§„èŒƒçš„ SELinux æ¨¡å¼
Policy MLS status:              enabled				# æ˜¯å¦å«æœ‰ MLS çš„æ¨¡å¼æœºåˆ¶
Policy deny_unknown status:     allowed				# æ˜¯å¦é¢„è®¾æŠµæŒ¡æœªçŸ¥çš„ä¸»ä½“è¿›ç¨‹
Max kernel policy version:      31
```

ä¸Šè¿°ä¿¡æ¯ç§‘çŸ¥é“ï¼ŒSELinux ç›®å‰çš„æ”¿ç­–æ˜¯ targeted ï¼Œå¯é€šè¿‡å¦‚ä¸‹æ–¹å¼ä¿®æ”¹

```bash
[root@study ~]# vim /etc/selinux/config 
# This file controls the state of SELinux on the system.
# SELINUX= can take one of these three values:
#     enforcing - SELinux security policy is enforced.
#     permissive - SELinux prints warnings instead of enforcing.
#     disabled - No SELinux policy is loaded.
SELINUX=enforcing		 	# å¯é€‰æ‹©ä¸ºä¸Šè¿° 3 ä¸ª
# SELINUXTYPE= can take one of three values:
#     targeted - Targeted processes are protected,
#     minimum - Modification of targeted policy. Only selected processes are protected. 
#     mls - Multi Level Security protection.
SELINUXTYPE=targeted		# å¯é€‰å€¼ä¸ºä¸Šè¿° 3 ä¸ª
```

### SElinux çš„å¯åŠ¨ä¸å…³é—­

ç”±äº SElinux æ˜¯æ•´åˆåˆ°æ ¸å¿ƒä¸­å»çš„ï¼Œå› æ­¤ä¿®æ”¹ä¸Šè¿°é…ç½®æ–‡ä»¶ä¹‹åï¼Œéœ€è¦é‡æ–°å¯åŠ¨ã€‚

æ³¨æ„ï¼šå¦‚æœä» disable è½¬åˆ°å¯åŠ¨ SELinux çš„æ¨¡å¼æ—¶ï¼Œç”±äºç³»ç»Ÿå¿…é¡»è¦é’ˆå¯¹æ–‡ä»¶å†™å…¥å®‰å…¨æ€§æœ¬æ–‡ä¿¡æ¯ï¼Œå› æ­¤å¼€æœºè¿‡ç¨‹éœ€è¦è€—è´¹ä¸å°‘æ—¶é—´ç­‰å¾…é‡æ–°å†™å…¥ SELinux å®‰å…¨æ€§æœ¬æ–‡ï¼ˆæœ‰æ—¶ä¹Ÿç§°ä¸ºSELinux Labelï¼‰ï¼Œè€Œä¸”åœ¨å†™å®Œä¹‹åè¿˜éœ€è¦é‡æ–°å¯åŠ¨ä¸€æ¬¡ï¼Œå¯åŠ¨æˆåŠŸä¹‹åï¼Œå†ä½¿ç”¨ `getenforce å’Œ sestatus` æ¥è§‚å¯Ÿæ˜¯å¦æœ‰æˆåŠŸå¯åŠ¨åˆ° Enforcing æ¨¡å¼

å¦‚æœå½“å‰å·²ç»æ˜¯ Enforcing æ¨¡å¼ï¼Œå¯èƒ½ç”±äºä¸€äº›è®¾ç½®é—®é¢˜å¤§é“è‡³ SELinux è®©æŸäº›æœåŠ¡æ— æ³•æ­£å¸¸çš„è¿è¡Œï¼Œæ­¤æ—¶å¯å°†æ¨¡å¼ä¿®æ”¹ä¸ºå®½å®¹æ¨¡å¼ï¼ˆpermissiveï¼‰ï¼Œè®© SELinux åªå‘å‡ºè­¦å‘Šä¿¡æ¯

```bash
setenforce [0|1]

é€‰é¡¹ä¸å‚æ•°ï¼š
	0ï¼šè½¬æˆ permissive å®½å®¹æ¨¡å¼
	1ï¼šè½¬æˆ Enforcing å¼ºåˆ¶æ¨¡å¼
æ³¨æ„ï¼šæ— æ³•åœ¨ Disabled æ¨¡å¼ä¸‹è¿›ç¨‹æ¨¡å¼çš„åˆ‡æ¢	
```

æŸäº›æ—¶å€™ä» Disabled æ¢æˆ Enforcing ä¹‹åï¼Œæœ‰éƒ¨åˆ†æœåŠ¡å¯èƒ½æ— æ³•é¡ºåˆ©å¯åŠ¨ï¼Œå¯èƒ½ä¼šæŠ¥é”™ `/lib/xxx` æ•°æ®æ²¡æœ‰æƒé™è¯»å–çš„é”™è¯¯ä¿¡æ¯ã€‚è¿™å¤§å¤šæ•°æ˜¯ç”±äºé‡æ–°å†™å…¥ Selinux typeï¼ˆRelabelï¼‰å‡ºé”™çš„åŸå› ï¼Œä½¿ç”¨ Permissive æ¨¡å¼å°±æ²¡æœ‰è¯¥é”™è¯¯ã€‚æœ€ç®€å•çš„åŠæ³•æ˜¯åœ¨ Permissive æ¨¡å¼ä¸‹ä½¿ç”¨æŒ‡ä»¤ `restorecon -Rv  /` é‡æ–°è¿˜åŸæ‰€æœ‰ SELinux çš„ç±»å‹

## ğŸ€ SELinux æ”¿ç­–å†…çš„è§„åˆ™ç®¡ç†

### SELinux å„ä¸ªè§„åˆ™çš„å¸ƒå°”å€¼æŸ¥è¯¢ï¼šgetsebool

```bash
getsebool [-a] [è§„åˆ™åç§°]

é€‰é¡¹ä¸å‚æ•°ï¼š
	-aï¼šåˆ—å‡ºç›®å‰ç³»ç»Ÿä¸Šæ‰€æœ‰ SELinux è§„åˆ™çš„å¸ƒå°”å€¼ä¸ºå¼€å¯æˆ–å…³é—­ï¼ˆon/offï¼‰
```

```bash
# èŒƒä¾‹ 1ï¼šæŸ¥è¯¢æ‰€æœ‰çš„å¸ƒå°”å€¼è®¾ç½®
[root@study ~]# getsebool -a
abrt_anon_write --> off
abrt_handle_event --> off
abrt_upload_watch_anon_write --> on
...
cron_can_relabel --> off		# è¿™ä¸ªä¸ cron æœ‰å…³
cron_system_cronjob_use_shares --> off
cron_userdomain_transition --> on
...
httpd_anon_write --> off		# ä¸ç½‘é¡µ http æœ‰å…³
httpd_builtin_scripting --> on
httpd_can_check_spam --> off
# æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªè§„åˆ™
```

### SELinux å„ä¸ªè§„åˆ™è§„èŒƒçš„ä¸»ä½“è¿›ç¨‹èƒ½å¤Ÿè¯»å–çš„æ–‡ä»¶ SELinux type æŸ¥è¯¢ seinfoã€sesearch

ä¸Šè¿°æŒ‡ä»¤çŸ¥é“äº†æ‰€æœ‰çš„è§„åˆ™å¼€å¯æƒ…å†µï¼Œå¯ä»¥é€šè¿‡ seinfoã€sesearch ç­‰å·¥å…·æ¥æŸ¥çœ‹æ¯ä¸ªè§„åˆ™å…·ä½“åœ¨é™åˆ¶ä»€ä¹ˆã€‚

ä¸Šè¿°å·¥å…·å¹¶æœªé¢„è£…ï¼Œ[è¯·æ‹¿å‡ºå®‰è£…å…‰ç›˜æŒ‚è½½åˆ° /mnt ç›®å½•ä¸‹](../07/03.md#æŒ‚è½½-cd-æˆ–-dvd-å…‰ç›˜)ï¼Œå®‰è£…

```bash
[root@study ~]# blkid 
/dev/sr0: UUID="2019-09-11-18-50-31-00" LABEL="CentOS 7 x86_64" TYPE="iso9660" PTTYPE="dos" 
/dev/sda1: UUID="e9d54afb-2afe-42de-87fe-9f55d747fcd9" TYPE="xfs" 
/dev/sda2: UUID="CNUXwS-J3Lh-0nDA-TssW-l1vT-90us-MHYnT1" TYPE="LVM2_member" 
/dev/mapper/centos_study-root: UUID="d7e09bb4-2f04-4ed4-b377-91a22fe85ce7" TYPE="xfs" 
/dev/mapper/centos_study-swap: UUID="684eebc0-3f70-4fc1-9a5d-d683f6a07cd0" TYPE="swap" 
[root@study ~]# mount /dev/sr0 /mnt/
mount: /dev/sr0 is write-protected, mounting read-only
[root@study ~]# yum install /mnt/Packages/setools-console-*                               
...
Complete!
[root@study ~]# umount /mnt/  # å¸è½½å…‰ç›˜
```

```bash
seinfo [-Atrub]

é€‰é¡¹ä¸å‚æ•°ï¼š
	-Aï¼šåˆ—å‡º SELinux çš„çŠ¶æ€ã€è§„åˆ™å¸ƒå°”å€¼ã€èº«ä»½è¯†åˆ«ã€è§’è‰²ã€ç±»å‹ç­‰æ‰€æœ‰ä¿¡æ¯
	-uï¼šåˆ—å‡º SELinux çš„æ‰€æœ‰èº«ä»½è¯†åˆ« user ç§ç±»
	-rï¼šåˆ—å‡º SELinux çš„æ‰€æœ‰è§’è‰² role ç§ç±»
	-tï¼šåˆ—å‡º SELinux çš„æ‰€æœ‰ç±»å‹ type ç§ç±»
	-bï¼šåˆ—å‡ºæ‰€æœ‰è§„åˆ™çš„ç§ç±»ï¼ˆå¸ƒå°”å€¼ï¼‰
```

```bash
# èŒƒä¾‹ 1ï¼šåˆ—å‡º SELinux åœ¨æ­¤æ”¿ç­–ä¸‹çš„ç»Ÿè®¡çŠ¶æ€
[root@study ~]# seinfo 

Statistics for policy file: /sys/fs/selinux/policy
Policy Version & Type: v.31 (binary, mls)

   Classes:           130    Permissions:       272
   Sensitivities:       1    Categories:       1024
   Types:            4792    Attributes:        253
   Users:               8    Roles:              14
   Booleans:          316    Cond. Expr.:       362
   Allow:          107360    Neverallow:          0
   Auditallow:        157    Dontaudit:       10020
   Type_trans:      18129    Type_change:        74
   Type_member:        35    Role allow:         39
   Role_trans:        416    Range_trans:      5899
   Constraints:       143    Validatetrans:       0
   Initial SIDs:       27    Fs_use:             32
   Genfscon:          103    Portcon:           614
   Netifcon:            0    Nodecon:             0
   Permissives:         0    Polcap:              5
   
# å½“å‰æ”¿ç­–æ˜¯ targeted ï¼Ÿ ï¼ˆå“ªé‡Œæ˜¾ç¤ºçš„ï¼Ÿï¼‰ï¼Œæ­¤æ”¿ç­–ä¸‹çš„ Types ç±»å‹æœ‰ 4792 ä¸ª
# SELinux çš„è§„åˆ™ï¼ˆBooleansï¼‰æœ‰ 316 æ¡
```

åœ¨å‰é¢è®²åˆ°è¿‡å‡ ä¸ªèº«ä»½è¯†åˆ« user ä¸ è§’è‰² roleï¼Œseinfo å¯ä»¥æŸ¥è¯¢åˆ°æ‰€æœ‰çš„ç§ç±»ï¼Œå¯è‡ªè¡ŒæŸ¥è¯¢

åœ¨å‰é¢è®²åˆ° `/etc/cron.d/checktime`  çš„ SElinux type ç±»å‹ä¸å¤ªå¯¹ï¼Œæˆ‘ä»¬çŸ¥é“ crond è¿›ç¨‹çš„ type æ˜¯ `crond_t`ï¼Œé‚£ä¹ˆæŸ¥æ‰¾ä¸‹ `crond_t` èƒ½å¤Ÿè¯»å–çš„æ–‡ä»¶ SELinux type æœ‰å“ªäº›

```bash
sesearch [-A] [-s ä¸»ä½“ç±»åˆ«] [-t ç›®æ ‡ç±»åˆ«] [-b å¸ƒå°”å€¼]

é€‰é¡¹ä¸å‚æ•°ï¼š
	-Aï¼šåˆ—å‡ºåé¢æ•°æ®ä¸­ï¼Œå…è®¸ã€Œè¯»å–æˆ–æ”¾è¡Œã€çš„ç›¸å…³æ•°æ®
	-tï¼šåé¢è¿˜è¦æ¥ typeã€ä¾‹å¦‚ -t httpd_t
	-bï¼šåé¢æ¥ SELinux çš„è§„åˆ™ï¼Œä¾‹å¦‚ -b httpd_enable_ftp_server
	
```

```bash
# èŒƒä¾‹ 1ï¼šæ‰¾å‡º crond_t ä¸»ä½“è¿›ç¨‹èƒ½å¤Ÿè¯»å–çš„æ–‡ä»¶ SELinux type

[root@study ~]# sesearch -A -s crond_t | grep spool
   allow crond_t var_spool_t : dir { ioctl read getattr lock search open } ; 
   allow crond_t system_cron_spool_t : dir { ioctl read getattr lock search open } ; 
   allow crond_t user_cron_spool_t : lnk_file { read getattr } ; 
   allow crond_t user_cron_spool_t : file { ioctl read write create getattr setattr lock append unlink link rename open } ; 
   allow crond_t system_cron_spool_t : file { ioctl read write create getattr setattr lock append unlink link rename open } ; 
   allow crond_t var_spool_t : file { ioctl read getattr lock open } ; 
   allow crond_t cron_spool_t : file { ioctl read write create getattr setattr lock append unlink link rename open } ; 
   allow daemon user_cron_spool_t : file { ioctl read write getattr lock append } ; 
   allow crond_t cron_spool_t : dir { ioctl read write getattr lock add_name remove_name search open } ; 
   allow crond_t user_cron_spool_t : dir { ioctl read write getattr lock add_name remove_name search open } ; 
   allow crond_t user_cron_spool_t : file { ioctl read write create getattr setattr lock append unlink link rename open } ; 
   allow crond_t system_cron_spool_t : file { ioctl read write create getattr setattr lock append unlink link rename open } ;
   
# allow åé¢æ˜¯ä¸»ä½“è¿›ç¨‹ä»¥åŠæ–‡ä»¶çš„ SELinux typeï¼Œä¸Šé¢æ•°æ®æ˜¯æˆªå–å‡ºæ¥çš„
# crond_t å¯ä»¥è¯»å– system_cron_spool_t çš„æ–‡ä»¶/ç›®å½•ç±»å‹ç­‰

# èŒƒä¾‹ 2ï¼šæ‰¾å‡º crond_t æ˜¯å¦èƒ½è¯»å– /etc/cron.d/checktime è¿™ä¸ªæˆ‘ä»¬è‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶ï¼Ÿ
[root@study ~]# ll -Z /etc/cron.d/checktime 
-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 /etc/cron.d/checktime
# ä¸¤ä¸ªé‡ç‚¹ï¼šSELinux type ä¸º admin_home_tï¼Œä¸€ä¸ªæ˜¯æ–‡ä»¶ï¼ˆfileï¼‰

[root@study ~]# sesearch -A -s crond_t | grep admin_home_t
   allow domain admin_home_t : dir { getattr search open } ; 
   allow crond_t admin_home_t : dir { ioctl read getattr lock search open } ; 
   allow userdom_filetrans_type admin_home_t : lnk_file { read getattr } ; 
   allow userdom_filetrans_type admin_home_t : dir { ioctl read write getattr lock add_name remove_name search open } ; 
   allow domain admin_home_t : lnk_file { read getattr } ; 
   allow crond_t admin_home_t : lnk_file { read getattr } ;
   
# å‘ç°æœ‰ crond_t admin_home_t å­˜åœ¨ï¼Œä¸è¿‡è¿™ä¸ªæ˜¯æ€»ä½“çš„ä¿¡æ¯
# æ²¡æœ‰é’ˆå¯¹æŸäº›è§„åˆ™çš„æŸ¥è¯¢ï¼Œæ‰€ä»¥ä¸èƒ½ç¡®å®š checktime èƒ½å¦è¢«è¯»å–ï¼Œä½†æ˜¯åŸºæœ¬ä¸Šå°±æ˜¯ SELinux type å‡ºç°é—®é¢˜ï¼Œæ‰æ— æ³•è¯»å–çš„
```

ç°åœ¨çŸ¥é“äº† `/etc/cron.d/checktime` æ˜¯ SELinux type é”™è¯¯å¯¼è‡´æ— æ³•è¯»å–çš„ã€‚çœ‹æ¥åœ¨ `getsebool -a` ä¸­çœ‹åˆ°çš„ `httpd_enable_homedirs` æ˜¯ä»€ä¹ˆï¼Ÿåˆæ˜¯è§„èŒƒäº†å“ªäº›ä¸»ä½“è¿›ç¨‹èƒ½å¤Ÿè¯»å–çš„ SELinux type

```bash
[root@study ~]# semanage boolean -l | grep httpd_enable_homedirs
httpd_enable_homedirs          (off  ,  off)  Allow httpd to enable homedirs
# httpd_enable_homedirs çš„åŠŸèƒ½æ˜¯å…è®¸ httpd è¿›ç¨‹è¯»å–ç”¨æˆ·å®¶ç›®å½•

# èŒƒä¾‹ 3ï¼šåˆ—å‡ºè¯¥è§„åˆ™ä¸­ï¼Œä¸»ä½“è¿›ç¨‹èƒ½å¤Ÿè¯»å–çš„æ–‡ä»¶  SELinux type
[root@study ~]# sesearch -A -b httpd_enable_homedirs
Found 77 semantic av rules:
   allow httpd_t user_home_type : lnk_file { read getattr } ; 
   allow httpd_suexec_t user_home_type : lnk_file { read getattr } ; 
   allow httpd_suexec_t user_home_dir_t : lnk_file { read getattr } ; 
   allow httpd_t nfs_t : lnk_file { read getattr } ; 
   allow httpd_sys_script_t nfs_t : file { ioctl read getattr lock open } ; 
   allow httpd_sys_script_t cifs_t : lnk_file { read getattr } ; 
   allow httpd_user_script_t user_home_type : lnk_file { read getattr } ; 
   allow httpd_user_script_t user_home_type : dir { getattr search open } ; 
   allow httpd_t cifs_t : file { ioctl read getattr lock open } ; 
   allow httpd_sys_script_t nfs_t : dir { getattr search open } ; 
   allow httpd_sys_script_t nfs_t : dir { ioctl read getattr lock search open } ; 
   allow httpd_sys_script_t nfs_t : dir { getattr search open } ; 
   allow httpd_sys_script_t nfs_t : dir { ioctl read getattr lock search open } ; 
   allow httpd_t user_home_dir_t : dir { getattr search open } ; 
   allow httpd_sys_script_t cifs_t : file { ioctl read getattr lock open } ; 
   allow httpd_sys_script_t user_home_dir_t : dir { getattr search open } ; 
   allow httpd_sys_script_t user_home_dir_t : lnk_file { read getattr } ;
   xxx
 # ä»ä¸Šé¢çš„æ•°æ®æ‰å¯ä»¥ç†è§£ï¼Œä¸»è¦æ˜¯æ”¾è¡Œ httpd_t èƒ½å¦è¯»å–ç”¨æˆ·å®¶ç›®å½•çš„æ–‡ä»¶ ï¼ˆç¬”è€…è¿™é‡Œæ˜¯æ‡µé€¼çš„æ²¡æœ‰çœ‹å‡ºæ¥ï¼‰
 # æ‰€ä»¥ï¼Œå¦‚æœè¯¥è§„åˆ™æ²¡æœ‰å¯åŠ¨ï¼ŒåŸºæœ¬ä¸Š httpd_t è¿™ç§è¿›ç¨‹å°±æ— æ³•è¯»å–ç”¨æˆ·å®¶ç›®å½•ä¸‹çš„æ–‡ä»¶
```

### ä¿®æ”¹ SELinux è§„åˆ™çš„å¸ƒå°”å€¼ setsebool

æŸ¥è¯¢åˆ°æŸä¸ª SELinux rule ï¼Œå¹¶ä¸”ä»¥ seaserch çŸ¥é“è¯¥è§„åˆ™çš„ç”¨é€”åï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼æ¥ç®¡ç†

```bash
setsebool [-p] [è§„åˆ™åç§°][0|1]

-Pï¼šç›´æ¥å°†è®¾ç½®å€¼å†™å…¥é…ç½®æ–‡ä»¶ï¼Œè¯¥è®¾ç½®æ•°æ®æœªæ¥ä¼šç”Ÿæ•ˆ
```

```bash
# èŒƒä¾‹ 1ï¼šæŸ¥è¯¢ httpd_enable_homedirs è¿™ä¸ªè§„åˆ™çš„çŠ¶æ€ï¼Œå¹¶ä¸”ä¿®æ”¹è¿™ä¸ªè§„åˆ™ä¸ºä¸åŒçš„å¸ƒå°”å€¼
[root@study ~]# getsebool httpd_enable_homedirs
httpd_enable_homedirs --> off			# å…³é—­çŠ¶æ€
[root@study ~]# setsebool -P httpd_enable_homedirs 1		# å¼€å¯å®ƒ
[root@study ~]# getsebool httpd_enable_homedirs
httpd_enable_homedirs --> on

```

## ğŸ€ SELinux å®‰å…¨æœ¬æ–‡çš„ä¿®æ”¹

SELinux å¯¹å—é™çš„ä¸»ä½“è¿›ç¨‹æ²¡æœ‰å½±å“ï¼š

1. è€ƒè™‘ SELinux çš„ä¸‰ç§ç±»å‹
2. è€ƒè™‘ SELinuxçš„æ”¿ç­–è§„åˆ™æ˜¯å¦æ”¾è¡Œ
3. æ¯”å¯¹ SELinux type å…³ç³»

ä¸Šé¢è®²è§£è¿‡å¯ä»¥é€šè¿‡ sesearch æ¥æ‰¾åˆ°ä¸»ä½“è¿›ç¨‹ä¸æ–‡ä»¶çš„ SELinux type å…³ç³»ï¼Œé‚£ä¹ˆæ€ä¹ˆä¿®æ”¹æ–‡ä»¶çš„ SELinux typeï¼Œèƒ½è®©ä¸»ä½“è¿›ç¨‹è¯»åˆ°å‘¢ï¼Ÿ

### ä½¿ç”¨ chcon æ‰‹åŠ¨ä¿®æ”¹æ–‡ä»¶çš„ SELinux type

```bash
chcon [-R] [-t type] [-u user] [-r role] æ–‡ä»¶
chcon [-R] --reference=èŒƒä¾‹æ–‡ä»¶ æ–‡ä»¶

é€‰é¡¹ä¸å‚æ•°ï¼š
	-Rï¼šè¿åŒè¯¥ç›®å½•ä¸‹çš„æ¬¡ç›®å½•ä¹ŸåŒæ—¶ä¿®æ”¹
	-tï¼šåé¢æ¥å®‰å…¨æ€§æœ¬æ–‡çš„ç±»å‹å­—æ®µï¼Œä¾‹å¦‚ httpd_sys_content_t
	-uï¼šåé¢æ¥èº«ä»½è¯†åˆ«ï¼Œä¾‹å¦‚ system_u (ä¸é‡è¦)
	-rï¼šåé¢æ¥è§’è‰²ï¼Œä¾‹å¦‚ system_r ï¼ˆä¸é‡è¦ï¼‰
	-vï¼šè‹¥æœ‰å˜åŒ–æˆåŠŸï¼Œå°†å˜åŠ¨çš„ç»“æœåˆ—å‡ºæ¥
	--reference=æ–‡ä»¶ï¼šæ‹¿æŸä¸ªæ–‡ä»¶æ¡£èŒƒä¾‹æ¥ä¿®æ”¹åç»­æ¥çš„æ–‡ä»¶çš„ç±»å‹
```

```bash
# èŒƒä¾‹ 1ï¼šæŸ¥è¯¢ /etc/hosts çš„ SELinux typeï¼Œå¹¶å°†è¯¥ç±»å‹å¥—ç”¨åˆ° /etc/cron.d/checktime ä¸Š
[root@study ~]# ll -Z /etc/hosts
-rw-r--r--. root root system_u:object_r:net_conf_t:s0  /etc/hosts
# net_conf_t æ˜¯ä¸Šé¢æ–‡ä»¶ä¸­çš„ç±»å‹
[root@study ~]# chcon -v -t net_conf_t /etc/cron.d/checktime 
changing security context of '/etc/cron.d/checktime'
[root@study ~]# ll -Z /etc/cron.d/checktime 
-rw-r--r--. root root unconfined_u:object_r:net_conf_t:s0 /etc/cron.d/checktime

# èŒƒä¾‹ 2ï¼šç›´æ¥ä»¥ /etc/shadow çš„ type å¥—ç”¨
[root@study ~]# chcon -v --reference=/etc/shadow /etc/cron.d/checktime
changing security context of '/etc/cron.d/checktime'
[root@study ~]# ll -Z /etc/shadow /etc/cron.d/checktime 
-rw-r--r--. root root system_u:object_r:shadow_t:s0    /etc/cron.d/checktime
----------. root root system_u:object_r:shadow_t:s0    /etc/shadow

```

ä¸Šé¢çš„ç¤ºä¾‹å¹¶ä¸èƒ½è§£å†³ crond ä¸èƒ½è¯»å– `/etc/cron.d/checktime` çš„é—®é¢˜ï¼Œå› ä¸ºéœ€è¦æ”¹æˆ `/etc/cron.d` ä¸‹çš„æ ‡å‡† type æ‰è¡Œã€‚å¯ä»¥ä½¿ç”¨ restorecon æ¥è®© SELinux è‡ªå·±é»˜è®¤è§£å†³ç›®å½•ä¸‹çš„ type é—®é¢˜

### ä½¿ç”¨ restorecon è®©æ–‡ä»¶æ¢å¤æ­£ç¡®çš„ SELinux type

```bash
restorecon [-Rv] æ–‡ä»¶æˆ–ç›®å½•

é€‰é¡¹ä¸å‚æ•°ï¼š
	-Rï¼šè¿åŒæ¬¡ç›®å½•ä¸€èµ·ä¿®æ”¹
	-vï¼šå°†è¿‡ç¨‹æ˜¾ç¤ºåˆ°å±å¹•ä¸Š
```

```bash
# èŒƒä¾‹ 3ï¼šå°† /etc/cron.d/ ä¸‹çš„æ–‡ä»¶éƒ½æ¢å¤æˆé¢„è®¾çš„ SELinux type
[root@study ~]# restorecon -Rv /etc/cron.d/
restorecon reset /etc/cron.d/checktime context system_u:object_r:shadow_t:s0->system_u:object_r:system_cron_spool_t:s0

# ä¸Šé¢å°†  shadow_t æ”¹æˆäº† system_cron_spool_t ç±»å‹

# èŒƒä¾‹ 4ï¼šé‡æ–°å¯åŠ¨ crond çœ‹çœ‹æœ‰æ²¡æœ‰æ­£ç¡®å¯åŠ¨ checktime
[root@study ~]# systemctl restart crond          
[root@study ~]# tail /var/log/cron
Mar 17 16:01:01 study CROND[5886]: (root) CMD (run-parts /etc/cron.hourly)
Mar 17 16:01:01 study run-parts(/etc/cron.hourly)[5886]: starting 0anacron
Mar 17 16:01:01 study run-parts(/etc/cron.hourly)[5898]: finished 0anacron
Mar 17 16:01:01 study run-parts(/etc/cron.hourly)[5886]: starting mcelog.cron
Mar 17 16:01:01 study run-parts(/etc/cron.hourly)[5904]: finished mcelog.cron
Mar 17 16:10:01 study CROND[5989]: (root) CMD (/usr/lib64/sa/sa1 1 1)
Mar 17 16:12:48 study crond[4073]: (CRON) INFO (Shutting down)
Mar 17 16:12:48 study crond[6068]: (CRON) INFO (RANDOM_DELAY will be scaled with factor 62% if used.)
Mar 17 16:12:49 study crond[6068]: (CRON) INFO (running with inotify support)
Mar 17 16:12:49 study crond[6068]: (CRON) INFO (@reboot jobs will be run at computer's startup.)
# æ²¡æœ‰æŠ¥é”™ä¿¡æ¯
```

ä»è¿™é‡Œçœ‹æ¥ restorecon å¾ˆæ–¹ä¾¿ï¼Œchcon è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„

### semanage é»˜è®¤ç›®å½•çš„å®‰å…¨æ€§æœ¬æ–‡æŸ¥è¯¢ä¸ä¿®æ”¹

ä¸ºä»€ä¹ˆ restorecon å¯ä»¥æ¢å¤åŸæœ¬çš„ SELinux type å‘¢ï¼Ÿé‚£ä¸€å®šæ˜¯æœ‰ä¸ªåœ°æ–¹åœ¨è®°å½•æ¯ä¸ªæ–‡ä»¶/ç›®å½•çš„ SELinux é»˜è®¤ç±»å‹

1. å¦‚ä½•æŸ¥è¯¢é¢„è®¾çš„ SELinux type
2. å¦‚ä½•å¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ é¢„è®¾çš„ SELinux type

```bash
semanage {login|user|port|interface|fcontext|translation} -l
semanage fcontext -{a|d|m} [-frst] file_spec

é€‰é¡¹ä¸å‚æ•°ï¼š
	fcontextï¼šä¸»è¦ç”¨åœ¨å®‰å…¨æ€§æœ¬æ–‡æ–¹é¢çš„ç”¨é€”ï¼Œ -l ä¸ºæŸ¥è¯¢
	-aï¼šå¢åŠ ï¼›å¯ä»¥å¢åŠ ä¸€äº›ç›®å½•çš„é»˜è®¤å®‰å…¨æ€§æœ¬æ–‡ç±»å‹è®¾ç½®
	-mï¼šä¿®æ”¹
	-dï¼šåˆ é™¤
```

```bash
# èŒƒä¾‹ 1ï¼šæŸ¥è¯¢ /etc/   /etc/cron.d/ çš„é¢„è®¾ SELinux type
[root@study ~]# semanage fcontext -l | grep -E '^/etc |^/etc/cron'
/etc/cron.daily(/.*)?                              all files          system_u:object_r:bin_t:s0 
/etc/cron.weekly(/.*)?                             all files          system_u:object_r:bin_t:s0 
/etc/cron.hourly(/.*)?                             all files          system_u:object_r:bin_t:s0 
/etc/cron.monthly(/.*)?                            all files          system_u:object_r:bin_t:s0 
/etc/cron.minutely/openshift-facts                 regular file       system_u:object_r:openshift_cron_exec_t:s0 
/etc/cron\.(daily|monthly)/acct                    regular file       system_u:object_r:acct_exec_t:s0 
/etc/cron\.(daily|weekly)/sysklogd                 regular file       system_u:object_r:logrotate_exec_t:s0 
/etc/cron\.(daily|monthly)/mailman                 regular file       system_u:object_r:mailman_queue_exec_t:s0 
/etc/cron\.(daily|weekly)/man-db.*                 regular file       system_u:object_r:mandb_exec_t:s0 
/etc/cron\.(daily|monthly)/radiusd                 regular file       system_u:object_r:radiusd_exec_t:s0 
/etc/cron\.(daily|weekly)/ntp-simple               regular file       system_u:object_r:ntpd_exec_t:s0 
/etc/cron\.(daily|weekly)/ntp-server               regular file       system_u:object_r:ntpd_exec_t:s0 
/etc/cron\.((daily)|(weekly)|(monthly))/freeradius regular file       system_u:object_r:radiusd_exec_t:s0 
/etc/cron\.d(/.*)?                                 all files          system_u:object_r:system_cron_spool_t:s0 
/etc/cron\.daily/[sm]locate                        regular file       system_u:object_r:locate_exec_t:s0 
/etc/cron\.weekly/(c)?fingerd                      regular file       system_u:object_r:fingerd_exec_t:s0 
/etc                                               all files          system_u:object_r:etc_t:s0 
/etc/crontab                                       regular file       system_u:object_r:system_cron_spool_t:s0 
/etc/cron\.daily/prelink                           regular file       system_u:object_r:prelink_cron_system_exec_t:s0 
/etc/cron\.daily/calamaris                         regular file       system_u:object_r:calamaris_exec_t:s0 
/etc/cron\.daily/certwatch                         regular file       system_u:object_r:certwatch_exec_t:s0 
/etc/cron\.monthly/proftpd                         regular file       system_u:object_r:ftpd_exec_t:s0

```

çœ‹ `/etc/cron\.d(/.*)?                                 all files          system_u:object_r:system_cron_spool_t:s0`  è¿™ä¸€è¡Œï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç›´æ¥ä½¿ç”¨ vim åœ¨ `/etc/cron.d` ä¸‹æ–°å»ºæ–‡ä»¶æ—¶ï¼Œé¢„è®¾ SELinux type æ˜¯æ­£ç¡®çš„ã€‚

ç»ƒä¹ ï¼šä¸‹é¢è¦å»ºç«‹ä¸€ä¸ª `/srv/mycron` ç›®å½•ï¼Œé»˜è®¤ä¹Ÿæ˜¯éœ€è¦å˜æˆ `system_cron_spool_t` æ—¶

```bash
# 1. å…ˆå»ºç«‹ mycron ç›®å½•ï¼Œå†æ”¾å…¥é…ç½®æ–‡ä»¶ï¼Œè§‚å¯Ÿ SELinux type
[root@study ~]# mkdir /srv/mycron
[root@study ~]# cp /etc/cron.d/checktime /srv/mycron/
[root@study ~]# ll -dZ /srv/mycron/ /srv/mycron/checktime 
drwxr-xr-x. root root unconfined_u:object_r:var_t:s0   /srv/mycron/
-rw-r--r--. root root unconfined_u:object_r:var_t:s0   /srv/mycron/checktime
# å‘ç°å˜æˆäº† var_t

# 2. è§‚å¯Ÿä¸Šå±‚ /srv çš„ SELinux type
[root@study ~]# semanage fcontext -l | grep '^/srv'
/srv/.*                                            all files          system_u:object_r:var_t:s0 
/srv/([^/]*/)?www(/.*)?                            all files          system_u:object_r:httpd_sys_content_t:s0 
/srv/([^/]*/)?ftp(/.*)?                            all files          system_u:object_r:public_content_t:s0 
/srv/([^/]*/)?rsync(/.*)?                          all files          system_u:object_r:public_content_t:s0 
/srv/([^/]*/)?www/logs(/.*)?                       all files          system_u:object_r:httpd_log_t:s0 
/srv/node(/.*)?                                    all files          system_u:object_r:swift_data_t:s0 
/srv/gallery2(/.*)?                                all files          system_u:object_r:httpd_sys_content_t:s0 
/srv/lib/gitosis(/.*)?                             all files          system_u:object_r:gitosis_var_lib_t:s0 
/srv/gallery2/smarty(/.*)?                         all files          system_u:object_r:httpd_sys_rw_content_t:s0 
/srv/loopback-device(/.*)?                         all files          system_u:object_r:swift_data_t:s0 
/srv                                               all files          system_u:object_r:var_t:s0
# å¯ä»¥çœ‹åˆ°è¿™é‡Œé»˜è®¤å°±æ˜¯  var_t ç±»å‹çš„

# 3. å°† mycron é»˜è®¤å€¼æ”¹ä¸º system_cron_spool_t
[root@study ~]# semanage fcontext -a -t system_cron_spool_t "/srv/mycron(/.*)?"
[root@study ~]# semanage fcontext -l | grep '^/srv/mycron'
/srv/mycron(/.*)?                                  all files          system_u:object_r:system_cron_spool_t:s0 

# 4. å›å¤ /srv/mycron ä»¥åŠå­ç›®å½•ç›¸å…³çš„ SELinux type
[root@study ~]# restorecon -Rv /srv/mycron/
restorecon reset /srv/mycron context unconfined_u:object_r:var_t:s0->unconfined_u:object_r:system_cron_spool_t:s0
restorecon reset /srv/mycron/checktime context unconfined_u:object_r:var_t:s0->unconfined_u:object_r:system_cron_spool_t:s0
```

é€šè¿‡è¿™ä¸ªä¾‹å­æ¥çœ‹ï¼Œrestorecon çš„ç¡®æ˜¯å¾ˆæ–¹ä¾¿ ï¼Œå­¦ä¼šè¿™äº›åŸºç¡€çš„å·¥å…·ï¼Œå¯¹äº SELinux æ¥è¯´åŸºæœ¬ä¸Šä¹Ÿå¤Ÿç”¨äº†

## ğŸ€ ä¸€ä¸ªç½‘ç»œæœåŠ¡æ¡ˆä¾‹åŠç™»å½•æ–‡ä»¶ååŠ©

æœ¬ç« åœ¨ SELinux å°èŠ‚ä¸­ä»‹ç»åˆ°çš„å„ä¸ªæŒ‡ä»¤ï¼Œå°¤å…¶æ˜¯ setseboolã€chconã€restorecon ç­‰éƒ½æ˜¯ä¸ºäº†å½“ä½ çš„æŸäº›ç½‘ç»œæœåŠ¡æ— æ³•æ­£å¸¸æä¾›ç›¸å…³åŠŸèƒ½æ—¶ï¼Œæ‰éœ€è¦è¿›è¡Œä¿®æ”¹çš„ä¸€äº›æŒ‡ä»¤åŠ¨ä½œã€‚

å¯ä»¥é€šè¿‡ä¸»åŠ¨æ£€æŸ¥çš„æ–¹å¼æ¥æ£€æŸ¥æ˜¯å¦æœ‰ SELinux äº§ç”Ÿçš„é”™è¯¯ã€‚è€Œä¸æ˜¯ç­‰å®¢æˆ·ç«¯è”æœºå¤±è´¥æ¥åé¦ˆ

### setroubleshootï¼šé”™è¯¯ä¿¡æ¯å†™å…¥ `/var/log/messages`

å‡ ä¹æ‰€æœ‰ SELinux ç›¸å…³çš„ç¨‹åºéƒ½æ˜¯ä»¥ se å¼€å¤´ï¼Œè¯¥æœåŠ¡æ—¶é”™è¯¯å…‹æœï¼Œå¯åŠ¨åï¼Œä¼šå°†å…³äº SELinux çš„é”™è¯¯ä¿¡æ¯ä¸å…‹æœæ–¹æ³•è®°å½•åˆ° `/var/log/messages` ä¸ `/var/log/setroubleshoot/*` ä¸­

éœ€è¦å®‰è£…ï¼šsetroubleshoot ä¸ setroubleshoot-serverã€‚åŸæœ¬ SELinux ä¿¡æ¯æ˜¯ä¸¤ä¸ªæœåŠ¡æ¥è®°å½•çš„ï¼Œåˆ†åˆ«æ˜¯ auditd ä¸ setroubleshootã€‚åœ¨ CentOS 6.x èµ·æ•´åˆæˆ auditd äº†ã€‚æ‰€ä»¥å®‰è£…å¥½ setroubleshoot-server åï¼Œéœ€è¦é‡æ–°å¯åŠ¨ auditd æœåŠ¡ï¼Œå¦åˆ™ setroubleshoot åŠŸèƒ½ä¸ä¼šè¢«å¯åŠ¨

å®é™…ä¸Šã€‚CentOS 7.x å¯¹ setroubleshoot çš„è¿è¡Œæ–¹å¼æ˜¯ï¼šå…ˆç”± auditd å»å‘¼å« audispd æœåŠ¡ï¼Œç„¶å audispd æœåŠ¡å¯åŠ¨ sedispatch ç¨‹åºï¼Œ sedispatch å†å°†åŸæœ¬çš„ auditd ä¿¡æ¯è½¬æˆ setroubleshoot çš„ä¿¡æ¯ï¼Œå­˜å‚¨ä¸‹æ¥

```bash
[root@study ~]# rpm -qa | grep setroubleshoot
setroubleshoot-3.2.30-7.el7.x86_64
setroubleshoot-plugins-3.0.67-4.el7.noarch
setroubleshoot-server-3.2.30-7.el7.x86_64
```

åœ¨é¢„è®¾çš„æƒ…å†µä¸‹ setroubleshoot è¢«å®‰è£…äº†ï¼Œè®°å¾—åˆšå®‰è£… setroubleshoot çš„è¯ï¼Œéœ€è¦é‡æ–°å¯åŠ¨ auditd æœåŠ¡çš„ã€

ç›®å‰æˆ‘ä»¬æ²¡æœ‰ä»»ä½•å—é™çš„ç½‘ç»œæœåŠ¡ä¸»ä½“è¿›ç¨‹åœ¨è¿è¡Œï¼Œä¸‹é¢ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ FTP æœåŠ¡å™¨è½¯ä»¶ç¤ºä¾‹ï¼Œæ¥äº†è§£ä¸Šé¢è®²åˆ°çš„è®¸å¤šé‡ç‚¹åº”ç”¨

### å®ä¾‹è¯´æ˜ï¼šé€šè¿‡ vsftpd è¿™ä¸ª FTP æœåŠ¡å™¨æ¥å­˜å–ç³»ç»Ÿä¸Šçš„æ–‡ä»¶

åœ¨ CentOS 7.x ç¯å¢ƒä¸‹ï¼Œ FTP çš„é»˜è®¤æœåŠ¡å™¨è½¯ä»¶ä¸»è¦æ˜¯ vsftpd 

è¯¦ç»†çš„ FTP åè®®åœ¨æœåŠ¡å™¨ç¯‡è®²è§£ï¼Œè¿™é‡Œç®€å•åˆ©ç”¨ vsftpd ä¸ FTP çš„åè®®æ¥è®²è§£ SELinux çš„é—®é¢˜ä¸é”™è¯¯å…‹æœã€‚

ä¸‹é¢åªæ¥å—ä¸€äº›ç®€å•çš„ FTP  çŸ¥è¯†ï¼šå®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨ FTP è´¦æˆ·ç™»å½• FTP æœåŠ¡å™¨ï¼Œæœ‰ä¸€ä¸ªç§°ä¸ºã€ŒåŒ¿å ï¼ˆanonymousï¼‰ã€çš„è´¦æˆ·å¯ä»¥ç™»å½•ç³»ç»Ÿï¼Œä½†æ˜¯è¿™ä¸ªåŒ¿åçš„è´¦æˆ·ç™»å½•åï¼Œåªèƒ½å­˜å–ä¸€ä¸ªç‰¹å®šçš„ç›®å½•ï¼Œè€Œæ— æ³•è„±ç¦»è¯¥ç›®å½•

åœ¨ vsftpd ä¸­ï¼Œä¸€èˆ¬ç”¨æˆ·ä¸åŒ¿åè€…çš„å®¶ç›®å½•è¯´æ˜å¦‚ä¸‹ï¼š

- åŒ¿åè€…ï¼šå¦‚æœä½¿ç”¨æµè§ˆå™¨æ¥è”æœºåˆ° FTP æœåŠ¡å™¨ï¼Œé‚£é¢„è®¾å°±æ˜¯ä½¿ç”¨åŒ¿åè€…ç™»å½•ç³»ç»Ÿã€‚åŒ¿åè€…çš„å®¶ç›®å½•é»˜è®¤æ˜¯åœ¨ `/var/ftp` ä¸­ï¼ŒåŒæ—¶ï¼ŒåŒ¿åè€…åœ¨å®¶ç›®å½•ä¸‹åªèƒ½ä¸‹è½½æ•°æ®ï¼Œä¸èƒ½ä¸Šä¼ æ•°æ®åˆ° FTP æœåŠ¡å™¨ï¼ŒåŒæ—¶åŒ¿åè€…æ— æ³•ç¦»å¼€ FTP æœåŠ¡å™¨çš„ `/var/ftp` ç›®å½•
- ä¸€èˆ¬ FTP è´¦æˆ·ï¼šåœ¨é¢„è®¾æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ UID å¤§äº 1000 çš„è´¦æˆ·ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ FTP æ¥ç™»å½•ç³»ç»Ÿï¼Œç™»å½•ç³»ç»Ÿåï¼Œæ‰€æœ‰çš„è´¦æˆ·éƒ½èƒ½å¤Ÿå–å¾—è‡ªå·±å®¶ç›®å½•ä¸‹çš„æ–‡ä»¶æ•°æ®ï¼Œé¢„è®¾ä¹Ÿå¯ä»¥ä¸Šä¼ ã€ä¸‹è½½æ–‡ä»¶çš„

ä¸ºäº†é¿å…ä¸ä¹‹å‰ç« èŠ‚çš„ç”¨æˆ·äº§ç”Ÿè¯¯è§£æƒ…å†µï¼Œåˆ›å»ºä¸€ä¸ªåä¸º ftptest çš„è´¦æˆ·ï¼Œä¸”è´¦æˆ·å¯†ç ä¸º myftp123

```bash
[root@study ~]# useradd -s /sbin/nologin ftptest
[root@study ~]# echo "myftp123" | passwd --stdin ftptest
Changing password for user ftptest.
passwd: all authentication tokens updated successfully.
```

ä¸‹é¢æ¥å®‰è£… vsftp æœåŠ¡å™¨è½¯ä»¶ï¼ˆè¿˜æ˜¯åœ¨å…‰ç›˜ä¸­å®‰è£…ï¼Œå‰é¢æŒ‚è½½é‚£æ ·ï¼‰

```bash
[root@study ~]# yum install /mnt/Packages/vsftpd-3*                    

[root@study ~]# systemctl start vsftpd		# å¯åŠ¨ vsftpd æœåŠ¡
[root@study ~]# systemctl enable vsftpd		# è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨
Created symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.
[root@study ~]# netstat -tlnp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      1374/cupsd          
tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1578/master         
tcp        0      0 127.0.0.1:6010          0.0.0.0:*               LISTEN      2350/sshd: mrcode@p 
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1/systemd           
tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      1975/dnsmasq        
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1378/sshd           
tcp6       0      0 ::1:631                 :::*                    LISTEN      1374/cupsd          
tcp6       0      0 ::1:25                  :::*                    LISTEN      1578/master         
tcp6       0      0 ::1:6010                :::*                    LISTEN      2350/sshd: mrcode@p 
tcp6       0      0 :::111                  :::*                    LISTEN      1/systemd           
tcp6       0      0 :::21                   :::*                    LISTEN      6656/vsftpd         
tcp6       0      0 :::22                   :::*                    LISTEN      1378/sshd

# å¯ä»¥çœ‹åˆ°   6656/vsftpd è¿™è¡Œæ•°æ®ï¼Œä»£è¡¨å·²ç»å¯åŠ¨äº†
```

### åŒ¿åè€…æ— æ³•ä¸‹è½½çš„é—®é¢˜

æ¨¡æ‹Ÿä¸€äº› FTP çš„å¸¸ç”¨çŠ¶æ€ï¼Œå‡è®¾å°† `/etc/securetty` ä»¥åŠä¸»è¦çš„ `/etc/sysctl.conf` æ”¾ç½®ç»™æ‰€æœ‰äººä¸‹è½½ï¼Œé‚£ä¹ˆå¯ä»¥èƒ½ä¼šè¿™æ ·åš

```bash
[root@study ~]# cp -a /etc/securetty /etc/sysctl.conf /var/ftp/pub
[root@study ~]# ll /var/ftp/pub/
total 8
-rw-------. 1 root root 221 Oct 31  2018 securetty
-rw-r--r--. 1 root root 449 Aug  9  2019 sysctl.conf

```

ä¸€èˆ¬æ¥è¯´ï¼Œé»˜è®¤è¦ç»™ç”¨æˆ·ä¸‹è½½çš„ FTP æ–‡ä»¶ä¼šæ”¾åœ¨ `/var/ftp/pub` ç›®å½•ä¸­ã€‚ä¸‹é¢ä½¿ç”¨ç®€å•çš„ç»ˆç«¯æœºæµè§ˆå™¨ curl æ¥è§‚å¯Ÿ

```bash
# 1. æŸ¥çœ‹ FTP æ ¹ç›®å½•ä¸‹æœ‰å“ªäº›å†…å®¹
[root@study ~]# curl ftp://localhost
drwxr-xr-x    2 0        0              42 Mar 17 09:03 pub
# ç¡®å®çœ‹åˆ°äº† pub ç›®å½•

# 2. æŸ¥çœ‹ pub ç›®å½•å†…çš„å†…å®¹
[root@study ~]# curl ftp://localhost/pub
curl: (78) RETR response: 550
# æ— æ³•è®¿é—®ï¼Œæ˜¯å› ä¸º pub æ˜¯ä¸€ä¸ªç›®å½•éœ€è¦åç¼€ / ç»“å°¾
[root@study ~]# curl ftp://localhost/pub/
-rw-------    1 0        0             221 Oct 30  2018 securetty
-rw-r--r--    1 0        0             449 Aug 08  2019 sysctl.conf

# 3. æŸ¥çœ‹é‡Œé¢çš„æ–‡ä»¶å†…å®¹
[root@study ~]# curl ftp://localhost/pub/sysctl.conf
# sysctl settings are defined through files in
# /usr/lib/sysctl.d/, /run/sysctl.d/, and /etc/sysctl.d/.
#
# Vendors settings live in /usr/lib/sysctl.d/.
# To override a whole file, create a new file with the same in
# /etc/sysctl.d/ and put new settings there. To override
# only specific settings, add a file with a lexically later
# name in /etc/sysctl.d/ and put new settings there.
#
# For more information, see sysctl.conf(5) and sysctl.d(5).

# ä¸Šé¢ä¸æ˜¯é”™è¯¯ä¿¡æ¯ï¼Œæ˜¯å“ªä¸ªæ–‡ä»¶çš„å†…å®¹

# 4. ç»§ç»­æŸ¥çœ‹ä¸‹ä¸€ä¸ªæ–‡ä»¶å†…å®¹
[root@study ~]# curl ftp://localhost/pub/securetty  
curl: (78) RETR response: 550
# è¿™é‡Œçœ‹ä¸åˆ°äº†ï¼Œä½†æ˜¯ securetty çš„ç¡®æ˜¯ä¸€ä¸ªæ–‡ä»¶è€Œä¸æ˜¯ä¸€ä¸ªç›®å½•ï¼ŒåŸºæœ¬åŸå› åº”è¯¥æ˜¯æƒé™é—®é¢˜
# å› ä¸º vsftpd é»˜è®¤æ”¾åœ¨ /var/ftp/pub å†…çš„èµ„æ–™ï¼Œæ— è®ºä»€ä¹ˆ SELinux type å‡ ä¹éƒ½å¯ä»¥è¢«è¯»å–æ‰å¯¹

# 5. ä¿®æ­£æƒé™åï¼Œå†è§‚å¯Ÿä¸€æ¬¡ securetty æ–‡ä»¶
[root@study ~]# ll /var/ftp/pub/
total 8
-rw-------. 1 root root 221 Oct 31  2018 securetty
-rw-r--r--. 1 root root 449 Aug  9  2019 sysctl.conf
# å¯ä»¥çœ‹åˆ° securetty çš„å…¶ä»–äººæƒé™æ²¡æœ‰ã€‚æ”¹å˜æˆå…¶ä»–äººä¹Ÿå¯ä»¥è¯»å–
[root@study ~]# chmod a+r /var/ftp/pub/securetty 
[root@study ~]# curl ftp://localhost/pub/securetty
console
vc/1
vc/2
vc/3
# æ­¤æ—¶å·²ç»èƒ½çœ‹åˆ°æ–‡ä»¶å†…å®¹äº†

# 6. ä¿®æ­£ SELinux type çš„å†…å®¹ï¼ˆéå¿…é¡»ï¼‰
[root@study ~]# restorecon -Rv /var/ftp/
restorecon reset /var/ftp/pub/securetty context system_u:object_r:etc_runtime_t:s0->system_u:object_r:public_content_t:s0
restorecon reset /var/ftp/pub/sysctl.conf context system_u:object_r:system_conf_t:s0->system_u:object_r:public_content_t:s0
```

ä¸Šè¿°åˆ—å­å‘Šè¯‰æˆ‘ä»¬ï¼Œè¦å…ˆä»æƒé™è§’åº¦æ¥æ£€æŸ¥ï¼Œå¦‚æœæ— æ³•è¢«è¯»å– ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰ r æˆ–åˆ™æ²¡æœ‰ rx æƒé™ï¼Œå¹¶ä¸ä¸€å®šæ˜¯ SELinux å¼•èµ·çš„ã€‚ä¸‹é¢çœ‹çœ‹ç”¨ä¸€èˆ¬è´¦æˆ·ç™»å½•

### æ— æ³•ä»å®¶ç›®å½•ä¸‹è½½æ–‡ä»¶çš„é—®é¢˜åˆ†æä¸è§£å†³

ç”±äºé€šè¿‡ä¸€èˆ¬è´¦æˆ·ï¼Œå‰é¢å»ºç«‹çš„ ftptest è´¦æˆ·ç™»å½•çš„è¯ï¼Œæ–‡å­—å‹çš„ FTP å®¢æˆ·ç«¯è½¯ä»¶ï¼Œé»˜è®¤ä¼šå°†ç”¨æˆ·å¼•å¯¼åœ¨æ ¹ç›®å½•ï¼Œè€Œä¸æ˜¯å®¶ç›®å½•ï¼Œå› æ­¤ï¼Œè®¿é—®çš„ URL éœ€è¦æ›´æ”¹ä¸€ä¸‹

```bash
# 0. åœ¨ ftptest å®¶ç›®å½•ä¸‹åˆ›å»ºä¸€äº›æ•°æ®
[root@study ~]# echo  ~ftptest/
/home/ftptest/
[root@study ~]# echo "testing" >  ~ftptest/test.txt
[root@study ~]# cp -a /etc/hosts /etc/sysctl.conf ~ftptest/
[root@study ~]# ll ~ftptest/
total 12
-rw-r--r--. 1 root root 158 Jun  7  2013 hosts
-rw-r--r--. 1 root root 449 Aug  9  2019 sysctl.conf
-rw-r--r--. 1 root root   8 Mar 17 17:23 test.txt

# 1. ä¸€èˆ¬è´¦æˆ·ç›´æ¥ç™»å½• FTP æœåŠ¡å™¨ï¼ŒåŒæ—¶å˜æ¢ç›®å½•åˆ°å®¶ç›®å½•
[root@study ~]# curl ftp://ftptest:myftp123@localhost/~/
curl: (67) Access denied: 530			# è¿™é‡ŒæŠ¥é”™äº†
# æ³¨æ„ï¼šä¹¦ä¸Šåœ¨å¢åŠ  ftptest ç”¨æˆ·çš„æ—¶å€™ï¼Œä½¿ç”¨çš„æ˜¯ /sbin/nologinï¼Œå°±æ— æ³•è®¿é—® ftpï¼Œè¿™é‡Œä¿®æ”¹ä¸‹ï¼Œå°±å¯ä»¥äº†
[root@study ~]# usermod -s  /bin/bash ftptest
[root@study ~]# curl ftp://ftptest:myftp123@localhost/~/
-rw-r--r--    1 0        0             158 Jun 07  2013 hosts
-rw-r--r--    1 0        0             449 Aug 08  2019 sysctl.conf
-rw-r--r--    1 0        0               8 Mar 17 09:23 test.txt
# çœ‹å·¦è¾¹çš„æƒé™ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„
# ä»è¿™é‡Œå¼€å§‹ï¼Œç¬”è€…çš„å®éªŒå’Œä¹¦ä¸Šçš„ç»“æœå¯¹ä¸ä¸Šäº†ï¼Œä¸‹é¢åªè®°å½•ä¹¦ä¸Šçš„æ“ä½œæŒ‡ä»¤
# å°±æ˜¯å› ä¸ºä¸Šé¢ä¿®æ”¹ç”¨æˆ·çš„ bash åï¼Œè™½ç„¶å¯ä»¥è®¿é—®äº†ï¼Œä½†æ˜¯ä¸‹é¢çš„å´å¯ä»¥ä¸‹è½½æ–‡ä»¶ï¼Œæ— æ³•è¾¾åˆ°å’Œä¹¦ä¸Šçš„æ•ˆæœä¸€æ ·

# 2. ä¸‹è½½ä¸Šé¢å¯ä»¥é˜…è¯»çš„æƒé™æ–‡ä»¶
[root@study ~]# curl ftp://ftptest:myftp123@localhost/~/test.txt
curl:(78) RETR response:550
# æ— æ³•è®¿ä¸‹è½½ï¼Œæ˜¯å¦æ˜¯ SELinux é€ æˆçš„ï¼Ÿ

# 3. å°† SELinux ä» Enforce è½¬æˆ Permissive 
[root@study ~]# setenforce 0
[root@study ~]# curl ftp://ftptest:myftp123@localhost/~/test.txt
testing
[root@study ~]# setenforce 1	# ç¡®å®šæ˜¯ SELinux æƒé™é—®é¢˜åï¼Œæ”¹å›æ¥
# éœ€è¦è¯¥è§„åˆ™è¿˜æ˜¯è¯¥ typeï¼Ÿç°åœ¨ä¸çŸ¥é“
# æ‰€ä»¥å…ˆæŸ¥è¯¢ä¸‹ç™»å½•æ—¥å¿—æœ‰æ²¡æœ‰ç›¸å…³çš„ä¿¡æ¯æä¾›ç»™æˆ‘ä»¬å¤„ç†

[root@study ~]# vim /var/log/messages
Aug 9 02:55:58 station3-39 setroubleshoot:SELinux is preventing /usr/sbin/vsftpd
	from lock access on the file /home/ftptest/test.txt. For complete SELinux messages.
	run sealert -l 3axxxxxxxx
# ä¹‹ç±»çš„å­—æ ·ï¼Œå…³é”®è¯å°±æ˜¯ sealert ï¼Œæ‰§è¡Œè¿™æ¡å‘½ä»¤
[root@study ~]# sealert -l 3axxxxxxxx
SELinux is preventing /usr/sbin/vsftpd from lock access on the file /home/ftptest/test/txt.
# ä¸‹é¢è¯´æœ‰ 47.5% çš„å‡ ç‡æ˜¯ç”±äºè¿™ä¸ªåŸå› æ‰€å‘ç”Ÿï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ setsebool å»è§£å†³çš„æ„æ€
******* Plugin catchall_boolean(47.5 confidence) suggests ********

if you want to allow ftp to home dir
...
Do
setsebool -P ftp_home_dir 1

******* Plugin catchall(6.38confidence) suggests ********
DO
# grep vsftpd /var/log/audit/audit.log | audit2allow -M mypol
# semodule -i mypol.pp

# ä¸‹é¢å°±é‡è¦äº†ï¼Œæ˜¯æ•´ä¸ªé—®é¢˜å‘ç”Ÿçš„ä¸»è¦åŸå› 
Additional Information:
Source Context	system_u:system_r:ftpd_t:s0-s0:c0.c1023
Target Context	unconfined_u:object_r:user_home_t:s0
Target Objects	/home/ftptest/test/txt [ file ]

```

é€šè¿‡ä¸Šé¢çš„æµ‹è¯•ï¼ŒçŸ¥é“ä¸»è¦çš„é—®é¢˜å‘ç”Ÿåœ¨ SElinux çš„ type ä¸æ˜¯ vsftpd_t æ‰€èƒ½è¯»å–çš„åŸå› ï¼Œä¸Šé¢ 47.5 çš„æ¦‚ç‡é—®é¢˜ï¼Œftp_home_dir æ˜¯ SELinux rules çš„é…ç½®

```bash
# 1. ç¡®è®¤ä¸‹ SELinux çš„æ¨¡å¼ï¼Œå¹¶ä¸”æ— æ³•è®¿é—®
[root@study ~]# getenforce 
Enforcing
[root@study ~]# curl ftp://ftptest:myftp123@localhost/~/test.txt
curl:(78) RETR response:550
[root@study ~]# setsebool -P ftp_home_dir 1
Boolean ftp_home_dir is not defined
# å¯æƒœç¬”è€…è¿™é‡Œæç¤ºæ²¡æœ‰è¢«å®šä¹‰ï¼Œä¸ä¹¦ä¸Šå¯¹ä¸ä¸Šå•Š
```

### ä¸€èˆ¬è´¦æˆ·ç”¨æˆ·ä»éæ­£è§„ç›®å½•ä¸Šä¼ /ä¸‹è½½æ–‡ä»¶

æä¾› `/srv/gogogo` ç›®å½•ç»™ ftptest ç”¨æˆ·ä½¿ç”¨ï¼Œè¯¥å¦‚ä½•å¤„ç†ï¼Ÿå‡è®¾ä¸è€ƒè™‘ SELiunx çš„è¯ï¼Œå°±æ˜¯å¦‚ä¸‹æ–¹å¼

```bash
# 1. å¤„ç†å¥½æ‰€éœ€è¦çš„ç›®å½•æ•°æ®
[root@study ~]# mkdir /srv/gogogo
[root@study ~]# chgrp ftptest /srv/gogogo/
# æŠŠç”¨æˆ·ç»„æ”¹æˆ ftptest è¿™ä¸ªç»„
[root@study ~]# ll -d /srv/gogogo/
drwxr-xr-x. 2 root ftptest 22 3æœˆ  17 22:43 /srv/gogogo/
[root@study ~]# echo "test" > /srv/gogogo/test.txt
[root@study ~]# curl ftp://ftptest:myftp123@localhost//srv/gogogo/test.txt
curl: (78) RETR response: 550
# è®¿é—®ä¸äº†ï¼ŒæŸ¥çœ‹æ—¥å¿—
[root@study ~]# grep sealert /var/log/messages | tail
Mar 17 22:46:35 study setroubleshoot: SELinux is preventing /usr/sbin/vsftpd from read access on the file test.txt. For complete SELinux messages run: sealert -l 88f08c09-c510-4518-bbcc-58bcee06ffb0

[root@study ~]# sealert -l 88f08c09-c510-4518-bbcc-58bcee06ffb0
SELinux is preventing /usr/sbin/vsftpd from read access on the file test.txt.

# è™½ç„¶è¿™ä¸ªå¯ä¿¡åº¦å¾ˆé«˜ï¼Œä¸è¿‡ï¼Œå› ä¸ºä¼šå…¨éƒ¨æ–¹å‘ FTPï¼Œæ‰€ä»¥ä¸è€ƒè™‘
*****  Plugin catchall_boolean (57.6 confidence) suggests   ******************

If you want to allow ftpd to full access
Then you must tell SELinux about this by enabling the 'ftpd_full_access' boolean.

Do
setsebool -P ftpd_full_access 1

# å› ä¸ºæ˜¯éæ­£è§„ç›®å½•çš„ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™è¾¹åŠ ä¸Šé¢„è®¾ SELinux type ææ€•èƒ½è§£å†³
*****  Plugin catchall_labels (36.2 confidence) suggests   *******************

If you want to allow vsftpd to have read access on the test.txt file
Then you need to change the label on test.txt
Do
# ä¸‹é¢è¿™ä¸€æ¡æ•°æ®
# semanage fcontext -a -t FILE_TYPE 'test.txt'
.... å¾ˆå¤šæ•°æ®
Then execute:
restorecon -v 'test.txt'		# è¿˜æœ‰è¿™ä¸€æ¡æ•°æ®ï¼Œéƒ½æ˜¯è¦å‚è€ƒçš„è§£å†³æ–¹æ¡ˆ

*****  Plugin catchall (7.64 confidence) suggests   **************************

If you believe that vsftpd should be allowed read access on the test.txt file by default.
Then you should report this as a bug.
You can generate a local policy module to allow this access.
Do
allow this access for now by executing:
# ausearch -c 'vsftpd' --raw | audit2allow -M my-vsftpd
# semodule -i my-vsftpd.pp


Additional Information:
Source Context                system_u:system_r:ftpd_t:s0-s0:c0.c1023
Target Context                unconfined_u:object_r:var_t:s0
Target Objects                test.txt [ file ]
Source                        vsftpd
Source Path                   /usr/sbin/vsftpd
Port                          <Unknown>
Host                          study.centos.mrcode
Source RPM Packages           
Target RPM Packages           
Policy RPM                    selinux-policy-3.13.1-252.el7.noarch
Selinux Enabled               True
Policy Type                   targeted
Enforcing Mode                Enforcing
Host Name                     study.centos.mrcode
Platform                      Linux study.centos.mrcode 3.10.0-1062.el7.x86_64
                              #1 SMP Wed Aug 7 18:08:02 UTC 2019 x86_64 x86_64
Alert Count                   2
First Seen                    2020-03-17 22:46:17 CST
Last Seen                     2020-03-17 22:46:32 CST
Local ID                      88f08c09-c510-4518-bbcc-58bcee06ffb0

Raw Audit Messages
type=AVC msg=audit(1584456392.386:979): avc:  denied  { read } for  pid=10979 comm="vsftpd" name="test.txt" dev="dm-0" ino=35108539 scontext=system_u:system_r:ftpd_t:s0-s0:c0.c1023 tcontext=unconfined_u:object_r:var_t:s0 tclass=file permissive=0


Hash: vsftpd,ftpd_t,var_t,file,read

# 3. æŸ¥çœ‹ /var/ftp çš„ SELinux type
[root@study ~]#  ll -Zd /var/ftp/
drwxr-xr-x. root root system_u:object_r:public_content_t:s0 /var/ftp/
[root@study ~]#  ll -Zd /srv/gogogo/
drwxr-xr-x. root ftptest unconfined_u:object_r:var_t:s0   /srv/gogogo/

# 4. ä»¥ sealert å»ºè®®çš„æ–¹æ³•æ¥å¤„ç†å¥½ SELinux type
[root@study ~]# semanage fcontext -a -t public_content_t '/srv/gogogo(/.*)?'
[root@study ~]# restorecon -Rv /srv/gogogo
restorecon reset /srv/gogogo context unconfined_u:object_r:var_t:s0->unconfined_u:object_r:public_content_t:s0
restorecon reset /srv/gogogo/test.txt context unconfined_u:object_r:var_t:s0->unconfined_u:object_r:public_content_t:s0
# å†æ¬¡è®¿é—®å°±å¯ä»¥äº†
[root@study ~]# curl ftp://ftptest:myftp123@localhost//srv/gogogo/test.txt
test
```

åœ¨è¿™ä¸ªèŒƒä¾‹ä¸­ï¼Œä¿®æ”¹çš„æ˜¯ typeï¼Œå‰ä¸€ä¸ªèŒƒä¾‹ä¸­ä¿®æ”¹çš„æ˜¯ ruleï¼Œä¸å¤ªä¸€æ ·çš„

### æ— æ³•å˜æ›´ FTP è”æœºç«¯å£é—®é¢˜åˆ†æè§£å†³

æ¯”å¦‚ä½ æƒ³è¦æ”¹å˜ FTP é»˜è®¤çš„å¯åŠ¨ç«¯å£ 21 æ”¹æˆ 555ï¼ŒåŸºæœ¬ä¸Šï¼Œæ—¢ç„¶ SELinux çš„ä¸»ä½“è¿›ç¨‹å¤§å¤šæ˜¯è¢«å—é™çš„ç½‘ç»œæœåŠ¡ï¼Œå¾ˆæœ‰å¯èƒ½è¿ç«¯å£ä¹Ÿé™åˆ¶äº†ï¼Œä¸‹é¢å°è¯•ä¿®æ”¹ç«¯å£ï¼Œæ¥æŸ¥çœ‹æ˜¯æ€ä¹ˆè§£å†³é—®é¢˜çš„

```bash
# 1. å…ˆå¤„ç† vsftpd çš„é…ç½®æ–‡ä»¶ï¼ŒåŠ å…¥ port çš„ç«¯å£å‚æ•°
[root@study ~]# vim /etc/vsftpd/vsftpd.conf 
listen_port=555

# 2. é‡å¯æœåŠ¡ï¼Œå¹¶æŸ¥çœ‹æ—¥å¿—
[root@study ~]# systemctl restart vsftpd
Job for vsftpd.service failed because the control process exited with error code. See "systemctl status vsftpd.service" and "journalctl -xe" for details.
[root@study ~]# grep sealert /var/log/messages
Mar 17 23:03:23 study setroubleshoot: SELinux is preventing /usr/sbin/vsftpd from name_bind access on the tcp_socket port 555. For complete SELinux messages run: sealert -l e3e3dee0-83eb-4cb8-b894-8be590fee082

[root@study ~]# sealert -l e3e3dee0-83eb-4cb8-b894-8be590fee082
SELinux is preventing /usr/sbin/vsftpd from name_bind access on the tcp_socket port 555.

# è¿™ä¸ª 92.2 çš„æ¦‚ç‡ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯è¿™ä¸ªäº†
*****  Plugin bind_ports (92.2 confidence) suggests   ************************

If you want to allow /usr/sbin/vsftpd to bind to network port 555
Then you need to modify the port type.
Do
# semanage port -a -t PORT_TYPE -p tcp 555
    where PORT_TYPE is one of the following: certmaster_port_t, cluster_port_t, ephemeral_port_t, ftp_data_port_t, ftp_port_t, hadoop_datanode_port_t, hplip_port_t, isns_port_t, port_t, postgrey_port_t, unreserved_port_t.

*****  Plugin catchall_boolean (7.83 confidence) suggests   ******************

If you want to allow nis to enabled
Then you must tell SELinux about this by enabling the 'nis_enabled' boolean.

Do
setsebool -P nis_enabled 1

*****  Plugin catchall (1.41 confidence) suggests   **************************

If you believe that vsftpd should be allowed name_bind access on the port 555 tcp_socket by default.
Then you should report this as a bug.
You can generate a local policy module to allow this access.
Do
allow this access for now by executing:
# ausearch -c 'vsftpd' --raw | audit2allow -M my-vsftpd
# semodule -i my-vsftpd.pp


Additional Information:
Source Context                system_u:system_r:ftpd_t:s0-s0:c0.c1023
Target Context                system_u:object_r:hi_reserved_port_t:s0
Target Objects                port 555 [ tcp_socket ]
Source                        vsftpd
Source Path                   /usr/sbin/vsftpd
Port                          555
Host                          study.centos.mrcode
Source RPM Packages           vsftpd-3.0.2-25.el7.x86_64
Target RPM Packages           
Policy RPM                    selinux-policy-3.13.1-252.el7.noarch
Selinux Enabled               True
Policy Type                   targeted
Enforcing Mode                Enforcing
Host Name                     study.centos.mrcode
Platform                      Linux study.centos.mrcode 3.10.0-1062.el7.x86_64
                              #1 SMP Wed Aug 7 18:08:02 UTC 2019 x86_64 x86_64
Alert Count                   1
First Seen                    2020-03-17 23:03:20 CST
Last Seen                     2020-03-17 23:03:20 CST
Local ID                      e3e3dee0-83eb-4cb8-b894-8be590fee082

Raw Audit Messages
type=AVC msg=audit(1584457400.225:1008): avc:  denied  { name_bind } for  pid=11443 comm="vsftpd" src=555 scontext=system_u:system_r:ftpd_t:s0-s0:c0.c1023 tcontext=system_u:object_r:hi_reserved_port_t:s0 tclass=tcp_socket permissive=0


type=SYSCALL msg=audit(1584457400.225:1008): arch=x86_64 syscall=bind success=no exit=EACCES a0=4 a1=55e9e4d4e800 a2=1c a3=3 items=0 ppid=11440 pid=11443 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm=vsftpd exe=/usr/sbin/vsftpd subj=system_u:system_r:ftpd_t:s0-s0:c0.c1023 key=(null)

Hash: vsftpd,ftpd_t,hi_reserved_port_t,tcp_socket,name_bind

# 3. æ ¹æ®å»ºè®®è§£å†³æ‰§è¡ŒæŒ‡ä»¤, 92% å“ªä¸ªæŒ‡ä»¤ä¸‹é¢ PORT_TYPE ä¸‹é¢åˆå¯é€‰çš„ ftp_port_t
# ä½†æ˜¯ç¬”è€…è¿˜æ˜¯æ‡µé€¼çš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆé‚£ä¹ˆå¤šé‡Œé¢å°±é€‰è¿™ä¸ªäº†
[root@study ~]# semanage port -a -t ftp_port_t -p tcp 555
[root@study ~]# systemctl restart vsftpd
[root@study ~]# netstat -tlnp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      1374/cupsd          
tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1578/master         
tcp        0      0 127.0.0.1:6010          0.0.0.0:*               LISTEN      2350/sshd: mrcode@p 
tcp        0      0 127.0.0.1:6011          0.0.0.0:*               LISTEN      10579/sshd: root@pt 
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1/systemd           
tcp        0      0 192.168.122.1:53        0.0.0.0:*               LISTEN      1975/dnsmasq        
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1378/sshd           
tcp6       0      0 ::1:631                 :::*                    LISTEN      1374/cupsd          
tcp6       0      0 ::1:25                  :::*                    LISTEN      1578/master         
tcp6       0      0 ::1:6010                :::*                    LISTEN      2350/sshd: mrcode@p 
tcp6       0      0 ::1:6011                :::*                    LISTEN      10579/sshd: root@pt 
tcp6       0      0 :::555                  :::*                    LISTEN      11573/vsftpd        
tcp6       0      0 :::111                  :::*                    LISTEN      1/systemd           
tcp6       0      0 :::22                   :::*                    LISTEN      1378/sshd     
# å¯ä»¥çœ‹åˆ° vsftpd çš„ç«¯å£å˜æˆäº† 555 äº†

# 4. å®éªŒçœ‹çœ‹è¯¥ port æ˜¯å¦å¯ç”¨
[root@study ~]# curl ftp://localhost:555
drwxr-xr-x    2 0        0              42 Mar 17 09:03 pub
```

