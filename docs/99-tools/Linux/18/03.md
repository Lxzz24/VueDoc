---
title: 
sidebarDepth: 0 
category: Tools 
tag: Linux
---
# ç™»å½•æ–‡ä»¶çš„è½®æ›¿ logrotate

è½®æ›¿ï¼Œå°±æ˜¯å®šæ—¶çš„æ‰§è¡Œå¤‡ä»½æ“ä½œï¼Œå¯ä»¥æŸ¥çœ‹ `/etc/cron.daily/logrotate` ï¼Œé‡Œé¢é…ç½®äº†æ–‡ä»¶è½®æ›¿è¡Œä¸º

## ğŸ€ logrotate çš„é…ç½®æ–‡ä»¶

é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š

- `/etc/logrotate.conf`ï¼šé…ç½®æ–‡ä»¶
- `/etc/logrotate.d/`ï¼šè¯¥ç›®å½•ä¸‹æ˜¯ç»†åŒ–çš„åˆ†ç±»ï¼Œæ¯”å¦‚ä½ æœ‰ä½ è‡ªå·±çš„è½¯ä»¶éœ€è¦è½®æ›¿æ“ä½œï¼Œå°±å¯ä»¥æ”¾åˆ°è¯¥ç›®å½•ä¸‹

logrotate çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†æ—§çš„æ—¥å¿—æ–‡ä»¶ç§»åŠ¨æˆæ—§æ–‡ä»¶ï¼Œå¹¶ä¸”é‡æ–°å»ºç«‹ä¸€ä¸ªæ–°çš„ç©ºçš„æ–‡ä»¶ã€‚å®ƒçš„æ‰§è¡Œç»“æœå¦‚ä¸‹å›¾ç¤ºæ„ï¼š

![image-20200322154057573](./assets/image-20200322154057573.png)

ä¸Šå›¾æ˜¯ä¸€ä¸ªè¿‡ç¨‹ï¼Œåé¢çš„å›¾ç¤ºå·²ç»åŒ…å«äº†å‰é¢çš„è¿‡ç¨‹ã€‚

- ç¬¬ 1 æ¬¡æ‰§è¡Œå®Œ rotate åï¼šåŸæœ¬çš„ messages æ–‡ä»¶å˜æˆäº† messages.1ï¼Œè€Œä¸”ä¼šåˆ¶é€ ä¸€ä¸ªç©ºçš„ message å‡ºæ¥
- ç¬¬ 2 æ¬¡ï¼šmessages.1 å˜æˆäº† messages.2

ä»¥æ­¤ä¸‹å»ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®å€¼ä¿ç•™ä¸‰ä¸ªæ–‡ä»¶æ—¥å¿—ä¿¡æ¯ï¼Œé‚£ä¹ˆå½“æ‰§è¡Œç¬¬ 4 æ¬¡çš„æ—¶å€™ï¼Œåˆ™ messages.3 ä¼šè¢«ç§»é™¤ï¼Œä¹Ÿå°±æ˜¯æ–°çš„å¤‡ä»½æ–‡ä»¶ä¼šå°†æ—§çš„ç»™è¦†ç›–æ‰

é‚£ä¹ˆå¤šä¹…æ‰§è¡Œä¸€æ¬¡ logrotate å‘¢ï¼Ÿä¿ç•™å‡ ä¸ªå¤‡ä»½æ–‡ä»¶å‘¢ï¼Ÿè¿™äº›éƒ½åœ¨ logrotate.conf ä¸­é…ç½®çš„

```bash
[root@study ~]# vim /etc/logrotate.conf 
# ä¸‹é¢æ˜¯é¢„è®¾çš„é»˜è®¤å€¼ï¼Œå¦‚æœæŸäº›æ–‡ä»¶åˆè®¾ç½®äº†å…¶ä»–çš„å‚æ•°ï¼Œé‚£ä¹ˆå°±ä»¥å®ƒè‡ªå·±çš„è®¾ç½®ä¸ºå‡†

# see "man logrotate" for details
# rotate log files weekly
weekly				# æ¯å‘¨è¿›è¡Œä¸€æ¬¡

# keep 4 weeks worth of backlogs
rotate 4			# ä¿ç•™å‡ ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œè¿™é‡Œé¢„è®¾æ˜¯ 4 ä¸ª

# create new (empty) log files after rotating old ones
create				# æ˜¯å¦å»ºç«‹ä¸€ä¸ªæ–°çš„æ–‡ä»¶æ¥ç»§ç»­å­˜å‚¨æ–°çš„æ•°æ®

# use date as a suffix of the rotated file
dateext				# æ˜¯å¦ä¸ºè½®æ›¿çš„æ–‡ä»¶åŠ ä¸Šæ—¥æœŸä½œä¸ºæ–‡ä»¶å

# uncomment this if you want your log files compressed
#compress			# è½®æ›¿çš„æ–‡ä»¶æ˜¯å¦éœ€è¦å‹ç¼©

# RPM packages drop log rotation information into this directory
include /etc/logrotate.d		# è¯¥ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶éƒ½è¯»è¿›æ¥æ‰§è¡Œ rotate çš„å·¥ä½œ

# no packages own wtmp and btmp -- we'll rotate them here
/var/log/wtmp {		# ä»…é’ˆå¯¹  /var/log/wtmp æ‰€è®¾ç½®çš„å‚æ•°
    monthly									# æ¯ä¸ªæœˆä¸€æ¬¡
    create 0664 root utmp		# åˆ›å»ºæ–°æ–‡ä»¶çš„æƒé™æ‰€å±è´¦æˆ·/ç¾¤ç»„
    minsize 1M							# æ–‡ä»¶å®¹é‡è¶…è¿‡ 1M åæ‰è¿›è¡Œ rotate
    rotate 1								# ä»…ä¿ç•™ä¸€ä¸ªï¼Œå³åªæœ‰ wtmp.1 
}
# wtmp å¯è®°å½•ç™»é™†è€…ä¸ç³»ç»Ÿé‡æ–°å¯åŠ¨æ—¶çš„å®é™…ä¸æ¥æºä¸»æœºä»¥åŠç™»å½•æœŸé—´çš„å®é™…
/var/log/btmp {
    missingok
    monthly
    create 0600 root utmp
    rotate 1
}

# system-specific logs may be also be configured here
```

ä»é…ç½®æ–‡ä»¶ä¸­çœ‹åˆ° `/etc/logrotate.d/` ç›®å½•æ˜¯è¯¥é…ç½®æ–‡ä»¶çš„è§„èŒƒæ”¯æŒã€‚ç”¨é€”å°±æ˜¯æ–¹ä¾¿æ·»åŠ è‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶ï¼Œè€Œä¸ç”¨æŠŠæ‰€æœ‰é…ç½®éƒ½å†™åˆ°ä¸»è¦çš„é…ç½®æ–‡ä»¶ä¸­ã€‚æ¯”å¦‚ä½ å¼€å‘äº†ä¸€ä¸ªè½¯ä»¶ï¼Œæœ‰è½®æ›¿æ—¥å¿—æ–‡ä»¶çš„éœ€æ±‚ï¼Œå°±å¯ä»¥å§é…ç½®æ–‡ä»¶æ”¾åˆ°è¯¥ç›®å½•ä¸‹ï¼Œå°±å¯ä»¥äº†

ä¸‹é¢ä»¥ `rsyslog.service` æœåŠ¡çš„æ–‡ä»¶ï¼Œæ¥è®¾ç½®å®ƒçš„ rotate

```bash
# è¯¥æ–‡ä»¶æ˜¯å­˜åœ¨çš„ï¼Œæˆ‘ä»¬æ¥ä¿®æ”¹ä¸å­¦ä¹ 
[root@study ~]# vim /etc/logrotate.d/syslog 
/var/log/cron
/var/log/maillog
/var/log/messages
/var/log/secure
/var/log/spooler
{
    missingok
    sharedscripts
    postrotate
        /bin/kill -HUP `cat /var/run/syslogd.pid 2> /dev/null` 2> /dev/null || true
    endscript
}

```

ä¸‹é¢æ¥çœ‹çœ‹è®¾ç½®çš„è¯­æ³•

- æ–‡ä»¶åï¼šå¯ä»¥ç”¨ç©ºæ ¼ç¬¦å·åˆ†å‰²å¤šä¸ªæ–‡ä»¶

- å‚æ•°ï¼š`{}` ä¸­çš„é…ç½®

- æ‰§è¡Œè„šæœ¬ï¼š

  å¯ä»¥è°ƒç”¨å¤–éƒ¨æŒ‡ä»¤æ¥è¿›è¡Œé¢å¤–çš„å‘½ä»¤ï¼Œéœ€è¦ä¸ `sharedscripts...endscript` çš„è®¾ç½®ï¼Œå¯ç”¨ç¯å¢ƒå«ä¹‰ï¼š

  - prerotateï¼šåœ¨å¯åŠ¨ logrotate ä¹‹å‰è¿›è¡Œçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ä¿®æ”¹æ—¥å¿—æ–‡ä»¶çš„å±æ€§ç­‰æ“ä½œ

  - postrotateï¼šåœ¨åšå®Œ logrotate ä¹‹åå¯åŠ¨çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚é‡æ–°å¯åŠ¨ï¼ˆkill -HUPï¼‰ æŸä¸ªæœåŠ¡

â€‹        ä¸Šé¢ä¸¤ä¸ªé’©å­åœ¨å¯¹äºå·²åŠ ä¸Šç‰¹æ®Šå±æ€§çš„æ–‡ä»¶å¤„ç†ä¸Šé¢ï¼Œå¾ˆé‡è¦æ–¹ä¾¿

é‚£ä¹ˆä¸Šè¿°æ–‡ä»¶çš„é…ç½®å«ä¹‰ä¸ºï¼š

- è¯¥é…ç½®åªå¯¹ä¸Šè¿°åˆ—å‡ºæ¥çš„ 5 ä¸ªæ–‡ä»¶æœ‰æ•ˆ
- æ¯å‘¨ä¸€æ¬¡ã€ä¿ç•™ 4 ä¸ªã€ä¸”è½®æ›¿ä¸‹æ¥çš„æ–‡ä»¶ä¸è¿›è¡Œå‹ç¼©ï¼›è¿™äº›éƒ½æ˜¯é»˜è®¤å€¼ï¼Œå¹¶æ²¡æœ‰åœ¨è¯¥æ–‡ä»¶ä¸­é…ç½®
- è½®æ›¿å®Œæˆåï¼ˆpostrotateï¼‰å–å¾— syslog çš„ PID åï¼Œä»¥ kill-HUP æ–¹å¼é‡æ–°å¯åŠ¨ syslogd

ä½†æ˜¯å¦‚æœæœ‰ç‰¹æ®Šå±æ€§çš„è¯ï¼Œæ¯”å¦‚ä½¿ç”¨äº† `chattr +a`ï¼Œé‚£ä¹ˆè¯¥æ–‡ä»¶æ— æ³•åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯æ— æ³•è¢«æ›´åï¼Œè€Œ logrotate çš„å·¥ä½œåŸç†å°±æ˜¯å°†å½“å‰çš„æ–‡ä»¶æ›´åã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨ä¸Šé¢æä¾›çš„ä¸¤ä¸ªé’©å­æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜

```bash
[root@study ~]# vim /etc/logrotate.d/syslog 
/var/log/cron
/var/log/maillog
/var/log/messages
/var/log/secure
/var/log/spooler
{
	  sharedscripts
    prerotate
    	/usr/bin/chattr -a /var/log/messages
    endscript
    missingok
    sharedscripts
    postrotate
        /bin/kill -HUP `cat /var/run/syslogd.pid 2> /dev/null` 2> /dev/null || true
				/usr/bin/chattr +a /var/log/messages   
   endscript
}
```

æç¤ºä¸‹ï¼š`kill -HUP` æŒ‡å®šçš„ä¿¡å·é‡å«ä¹‰æ˜¯å°† rsyslog.conf èµ„æ–™é‡æ–°è¯»å–ä¸€æ¬¡ï¼Œå¯ä»¥ç†è§£ä¸º reload æ“ä½œ

## ğŸ€ å®é™…æµ‹è¯• logrotate åŠ¨ä½œ

ä¸Šè¿°æµ‹è¯•å®Œæˆä¹‹åï¼Œæµ‹è¯•ä¸‹

```bash
logrotate [-vf] logfile

é€‰é¡¹ä¸å‚æ•°ï¼š
	-vï¼šå¯åŠ¨æ˜¾ç¤ºæ¨¡å¼ï¼Œä¼šæ˜¾ç¤º logrotate è¿è¡Œçš„è¿‡ç¨‹
	-fï¼šæ— è®ºæ˜¯å¦ç¬¦åˆé…ç½®æ–‡ä»¶çš„æ•°æ®ï¼Œå¼ºåˆ¶æ¯ä¸ªæ—¥å¿—æ–‡ä»¶éƒ½è¿›è¡Œ rotate çš„æ“ä½œ
```

ä¸‹é¢æ‰§è¡Œä¸€æ¬¡çœ‹çœ‹æ•´ä¸ªæµç¨‹

```bash
[root@study ~]# logrotate -v /etc/logrotate.conf 
reading config file /etc/logrotate.conf		# è¯»å–ä¸»è¦çš„é…ç½®æ–‡ä»¶
including /etc/logrotate.d								# è¯»å–æ¨¡å—åŒ–çš„å¤–éƒ¨é…ç½®æ–‡ä»¶
reading config file bootlog
reading config file chrony
reading config file cups
....
Allocating hash table for state file, size 15360 B

Handling 15 logs							# å…±æœ‰ 15 ä¸ªæ—¥å¿—æ–‡ä»¶
...
rotating pattern: /var/log/cron
/var/log/maillog
/var/log/messages
/var/log/secure
/var/log/spooler
 weekly (4 rotations)
empty log files are rotated, old logs are removed
considering log /var/log/cron
  log does not need rotating (log has been rotated at 2020-3-15 21:37, that is not week ago yet)
considering log /var/log/maillog
  log does not need rotating (log has been rotated at 2020-3-15 21:37, that is not week ago yet)
considering log /var/log/messages		# å¤„ç† messages æ–‡ä»¶
	# ç”±äºæ—¶é—´æœªåˆ°ï¼Œä¸éœ€è¦æ“ä½œ
  log does not need rotating (log has been rotated at 2020-3-15 21:37, that is not week ago yet)
considering log /var/log/secure
  log does not need rotating (log has been rotated at 2020-3-15 21:37, that is not week ago yet)
considering log /var/log/spooler
  log does not need rotating (log has been rotated at 2020-3-15 21:37, that is not week ago yet)
not running postrotate script, since no logs were rotated
```

```bash
# èŒƒä¾‹ 2ï¼šå¼ºåˆ¶ logrotate æ“ä½œ
[root@study ~]# logrotate -v /etc/logrotate.conf 
rotating pattern: /var/log/cron
/var/log/maillog
/var/log/messages
/var/log/secure
/var/log/spooler
 forced from command line (4 rotations)
empty log files are rotated, old logs are removed
considering log /var/log/cron
  log needs rotating
considering log /var/log/maillog
  log needs rotating
considering log /var/log/messages
  log needs rotating
considering log /var/log/secure
  log needs rotating
considering log /var/log/spooler
  log needs rotating
rotating log /var/log/cron, log->rotateCount is 4
dateext suffix '-20200316'
glob pattern '-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'
rotating log /var/log/maillog, log->rotateCount is 4
dateext suffix '-20200316'
glob pattern '-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'
rotating log /var/log/messages, log->rotateCount is 4
dateext suffix '-20200316'
glob pattern '-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'
rotating log /var/log/secure, log->rotateCount is 4
glob pattern '-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'
fscreate context set to system_u:object_r:cron_log_t:s0
renaming /var/log/cron to /var/log/cron-20200316
creating new /var/log/cron mode = 0600 uid = 0 gid = 0
fscreate context set to system_u:object_r:var_log_t:s0
renaming /var/log/maillog to /var/log/maillog-20200316
creating new /var/log/maillog mode = 0600 uid = 0 gid = 0
fscreate context set to system_u:object_r:var_log_t:s0
# é‡å‘½åäº†æ–‡ä»¶ï¼Œç„¶ååˆåˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶
renaming /var/log/messages to /var/log/messages-20200316
creating new /var/log/messages mode = 0600 uid = 0 gid = 0
fscreate context set to system_u:object_r:var_log_t:s0
renaming /var/log/secure to /var/log/secure-20200316
creating new /var/log/secure mode = 0600 uid = 0 gid = 0
fscreate context set to system_u:object_r:var_log_t:s0
renaming /var/log/spooler to /var/log/spooler-20200316
creating new /var/log/spooler mode = 0600 uid = 0 gid = 0
running postrotate script
removing old log /var/log/cron-20200225
removing old log /var/log/maillog-20200225
removing old log /var/log/messages-20200225
removing old log /var/log/secure-20200225
removing old log /var/log/spooler-20200225

[root@study ~]# ll /var/log/messages*; lsattr /var/log/messages
-rw-------. 1 root root    345 Mar 16 00:01 /var/log/messages
-rw-------. 1 root root 756608 Mar  1 18:30 /var/log/messages-20200301
-rw-------. 1 root root 270175 Mar  8 12:23 /var/log/messages-20200308
-rw-------. 1 root root 187277 Mar 15 21:30 /var/log/messages-20200315
-rw-------. 1 root root  12425 Mar 16 00:00 /var/log/messages-20200316
-----a---------- /var/log/messages
# ä¸Šé¢æˆ‘ä»¬é…ç½®çš„å¤„ç†ç‰¹æ®Šå±æ€§çš„è„šæœ¬ç”Ÿæ•ˆäº†
```

ç”±äº logrotate å·²ç»åŠ å…¥åˆ° crontab é‡Œé¢äº†ï¼Œåªéœ€è¦ç•™æ„ä¸‹ `/var/log/messages` æ˜¯å¦æœ‰ç±»ä¼¼å¦‚ä¸‹çš„ä¿¡æ¯

```bash
[root@study ~]# grep 'www.rsyslog.com' /var/log/messages
Mar 16 00:00:42 study rsyslogd: [origin software="rsyslogd" swVersion="8.24.0-38.el7" x-pid="7107" x-info="http://www.rsyslog.com"] rsyslogd was HUPed

```

è¿™ä¸ªæ˜¯ rsyslogd é‡æ–°å¯åŠ¨çš„æ—¶é—´ï¼Œï¼ˆå› ä¸º `/etc/logrotate.d/syslog` ä¸­é…ç½®äº†é‡æ–°å¯åŠ¨çš„ï¼‰

## ğŸ€ è‡ªå®šä¹‰æ—¥å¿—æ–‡ä»¶çš„è½®æ›¿åŠŸèƒ½

åœ¨å‰é¢ç« èŠ‚æ€»ï¼Œ å»ºç«‹äº†ä¸€ä¸ª `/var/log/admin.log` æ–‡ä»¶ï¼Œéœ€è¦é…ç½®å¦‚ä¸‹éœ€æ±‚

- æ·»åŠ  `+a` å±æ€§
- ä¸€ä¸ªæœˆè½®æ›¿ä¸€æ¬¡
- å½“æ–‡ä»¶å¤§äº 10MB æ—¶ï¼Œåˆ™ä¸»åŠ¨è½®æ›¿ï¼Œä¸éœ€è¦è€ƒè™‘ä¸€ä¸ªæœˆçš„æ—¶é—´
- ä¿å­˜ 5 ä¸ªå¤‡ä»½æ–‡ä»¶
- å¤‡ä»½æ–‡ä»¶éœ€è¦å‹ç¼©



```bash
# 1. æ·»åŠ  a å±æ€§ï¼Œå¹¶æµ‹è¯•æ˜¯å¦æœ‰æ•ˆ
[root@study ~]# chattr +a /var/log/admin.log
[root@study ~]# lsattr /var/log/admin.log
-----a---------- /var/log/admin.log
[root@study ~]# rm /var/log/admin.log 
rm: remove regular file '/var/log/admin.log'? y
rm: cannot remove '/var/log/admin.log': Operation not permitted
# è¿ root éƒ½æ— æ³•åˆ é™¤

# 2. å»ºç«‹ logrotate é…ç½®æ–‡ä»¶
[root@study ~]# vim /etc/logrotate.d/admin
/var/log/admin.log {
  monthly		# æ¯ä¸ªæœˆä¸€æ¬¡
  size=10M	# æ–‡ä»¶å®¹é‡å¤§äº 10M åˆ™å¼€å§‹å¤„ç½®
  rotate 5	# ä¿ç•™ 5 ä¸ª
  compress	# å‹ç¼©
  sharedscripts
  prerotate
        /usr/bin/chattr -a /var/log/admin.log
  endscript
  sharedscripts
  postrotate
  			# å°±æ˜¯è¿™é‡Œï¼Œæ¯ä¸ªéƒ½è¦é‡æ–°å¯åŠ¨å•Šï¼Ÿéš¾è¯¥æœåŠ¡å¯åŠ¨å¾—æœ‰ç‚¹é¢‘ç¹å•Š
        /bin/kill -HUP `cat /var/run/syslogd.pid 2> /dev/null` 2> /dev/null || true
        /usr/bin/chattr +a /var/log/admin.log
  endscript
}

# 3. æµ‹è¯•ä¸‹ logrotate ç›¸å…³åŠŸèƒ½ä¿¡æ¯æ˜¾ç¤º
[root@study ~]# logrotate -v /etc/logrotate.conf 
[root@study ~]# logrotate -v /etc/logrotate.conf             
reading config file /etc/logrotate.conf
including /etc/logrotate.d
reading config file admin		# çœ‹åˆ°å·²ç»åŠ è½½æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶äº†
...
rotating pattern: /var/log/admin.log  10485760 bytes (5 rotations)
empty log files are rotated, old logs are removed
considering log /var/log/admin.log
  log does not need rotating (log size is below the 'size' threshold)
not running prerotate script, since no logs will be rotated
# å¯ä»¥çœ‹åˆ°ï¼Œæ£€æµ‹åˆ° size ä¸å¤Ÿï¼Œä¸ç”¨å¤„ç†

# 4. å¼ºåˆ¶æ‰§è¡Œ logrotate ï¼Œå¹¶æŸ¥çœ‹ç›¸å…³ä¿¡æ¯
[root@study ~]# logrotate -vf /etc/logrotate.conf
rotating pattern: /var/log/admin.log  forced from command line (5 rotations)
empty log files are rotated, old logs are removed
considering log /var/log/admin.log
  log needs rotating
rotating log /var/log/admin.log, log->rotateCount is 5
dateext suffix '-20200316'
glob pattern '-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'
glob finding old rotated logs failed
running prerotate script
fscreate context set to system_u:object_r:var_log_t:s0
renaming /var/log/admin.log to /var/log/admin.log-20200316
creating new /var/log/admin.log mode = 0600 uid = 0 gid = 0
running postrotate script
compressing log with: /bin/gzip
set default create context to system_u:object_r:var_log_t:s0

[root@study ~]# lsattr /var/log/admin.log*       
-----a---------- /var/log/admin.log
---------------- /var/log/admin.log-20200316.gz
# å¯ä»¥çœ‹åˆ°çš„ç¡®è¢«å‹ç¼©è¿‡ï¼Œå½“å‰çš„ a å±æ€§ä¹Ÿæ­£å¸¸
```
