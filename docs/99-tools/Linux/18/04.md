---
title: 
sidebarDepth: 0 
category: Tools 
tag: Linux
---
# systemd-journald.service ç®€ä»‹

ä»¥å‰åªæœ‰ rsyslogd çš„æ—¶å€™ï¼Œç”±äº rsyslogd å¿…é¡»è¦å¼€æœºå®Œæˆä¸”æ‰§è¡Œäº† rsyslogd daemon åï¼Œæ—¥å¿—æ–‡ä»¶æ‰ä¼šå¼€å§‹è®°å½•ã€‚æ‰€ä»¥ï¼Œæ ¸å¿ƒè¿˜éœ€è¦è‡ªå·±äº§ç”Ÿä¸€ä¸ª klogd çš„æœåŠ¡ï¼Œæ‰èƒ½å°†ç³»ç»Ÿåœ¨å¼€æœºè¿‡ç¨‹ã€å¯åŠ¨æœåŠ¡çš„è¿‡ç¨‹ä¸­çš„ä¿¡æ¯è®°å½•ä¸‹æ¥ï¼Œç„¶åç­‰ rsyslogd å¯åŠ¨åä¼ é€ç»™å®ƒå¤„ç†

æœ‰äº† systemd åï¼Œç”±äºå®ƒæ˜¯æ ¸å¿ƒå”¤é†’çš„ï¼Œåˆæ˜¯ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„è½¯ä»¶ï¼Œå®ƒå¯ä»¥ä¸»åŠ¨è°ƒç”¨ systemd-journald æ¥ååŠ©è®°å½•æ—¥å¿—æ–‡ä»¶ï¼Œå› æ­¤åœ¨å¼€æœºè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¯åŠ¨æœåŠ¡äºæœåŠ¡è‹¥å¯åŠ¨å¤±è´¥çš„æƒ…å†µç­‰ï¼Œéƒ½å¯ä»¥ç›´æ¥è¢«è®°å½•åˆ° systemd-journald sé‡Œ

systemd-journald è®°å½•åˆ°å†…å­˜ä¸­ï¼Œå†ç»™ rsyslogd è®°å½•åˆ°ç¡¬ç›˜ä¸­

::: tip
linux çš„å†…å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä¹Ÿæœ‰å¯¹åº”çš„æ–‡ä»¶å½¢æ€åœ¨ /run/log/ ä¸‹ï¼Œåªæ˜¯äººçœ¼çœ‹ä¸æ‡‚å°±æ˜¯äº†ï¼Œé‡å¯åï¼Œè¯¥æ•°æ®å°±æ²¡æœ‰äº†
:::



## ğŸ€ ä½¿ç”¨ journalctl è§‚å¯Ÿæ—¥å¿—ä¿¡æ¯

```bash
journalct [-nrpf] [--since TIME] [--until TIME] _optional

é€‰é¡¹ä¸å‚æ•°ï¼š
	é¢„è®¾ä¼šæ˜¾ç¤ºå…¨éƒ¨çš„ log å†…å®¹ï¼Œä»æ—§çš„è¾“å‡ºåˆ°æœ€æ–°çš„ä¿¡æ¯
	-nï¼šæ˜¾ç¤ºæœ€è¿‘ n è¡Œçš„ä¿¡æ¯ï¼Œæ‰¾æœ€æ–°ä¿¡æ¯æ—¶æœ‰ç”¨
	-rï¼šåå‘è¾“å‡ºï¼Œä»æœ€æ–°çš„è¾“å‡ºåˆ°æœ€æ—§çš„è¾“å‡º
	-pï¼šæ˜¾ç¤ºåé¢æ¥çš„ä¿¡æ¯é‡è¦æ€§æ’åºï¼Œå‰ä¸€ç« è®²è§£çš„æ—¥å¿—çº§åˆ«
	-fï¼šç±»ä¼¼ tail -f åŠŸèƒ½ï¼ŒæŒç»­æ˜¾ç¤º journal æ—¥å¿—å†…å®¹
	--since --unitlï¼šè®¾ç½®å¼€å§‹ä¸ç»“æŸæ—¶é—´ï¼Œåªæ˜¾ç¤ºæŸæ®µæ—¶é—´èŒƒå›´å†…çš„æ•°æ®
	_SYSTEMD_UNIT=unit.serviceï¼šåªè¾“å‡ºæŸä¸ªæœåŠ¡çš„ä¿¡æ¯
	_COMM=bashï¼šåªè¾“å‡ºä¸ bash æœ‰å…³çš„ä¿¡æ¯
	_PID=pidï¼šåªè¾“å‡ºæŸä¸ª PID çš„ä¿¡æ¯
	_UID=uidï¼šåªè¾“å‡ºæŸä¸ª uid çš„ä¿¡æ¯
	SYSLOG_FACILITY=[0-23]ï¼šä½¿ç”¨ syslog.h è§„èŒƒçš„æœåŠ¡ç›¸å¯¹åº”çš„åºå·æ¥æ˜¾ç¤ºæŒ‡å®šæ•°æ®
```

```bash
# èŒƒä¾‹ 1ï¼š æ˜¾ç¤ºç›®å‰ç³»ç»Ÿä¸­æ‰€æœ‰çš„  journal æ—¥å¿—æ•°æ®
[root@study ~]# journalctl 
-- Logs begin at Sun 2020-03-15 20:13:33 CST, end at Mon 2020-03-16 00:50:01 CST. --
Mar 15 20:13:33 study.centos.mrcode systemd-journal[90]: Runtime journal is using 7.2M (max allowed 58.1M, trying to leave 87.
Mar 15 20:13:33 study.centos.mrcode kernel: Initializing cgroup subsys cpuset
Mar 15 20:13:33 study.centos.mrcode kernel: Initializing cgroup subsys cpu
Mar 15 20:13:33 study.centos.mrcode kernel: Initializing cgroup subsys cpuacct
Mar 15 20:13:33 study.centos.mrcode kernel: Linux version 3.10.0-1062.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc ver
Mar 15 20:13:33 study.centos.mrcode kernel: Command line: BOOT_IMAGE=/vmlinuz-3.10.0-1062.el7.x86_64 root=/dev/mapper/centos-r
Mar 15 20:13:33 study.centos.mrcode kernel: e820: BIOS-provided physical RAM map:
# ä»å½“æ¬¡å¼€æœºä»¥æ¥çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œé€šè¿‡ less ä¸€é¡µé¡µæ˜¾ç¤ºï¼Œæ•°æ®æµå¾ˆå¤§

# èŒƒä¾‹ 2ï¼šä»…æ˜¾ç¤º 2020/03/22 æ•´å¤©ã€æ˜¨å¤© çš„æ•°æ®
[root@study ~]# journalctl --since "2020-03-16 00:00:00" --until "2020-03-16 23:59:59"
[root@study ~]# journalctl --since today		# ä»Šå¤©
[root@study ~]# journalctl --since yesterday --unitl today		# æ˜¨å¤©åˆ°ä»Šå¤©

# èŒƒä¾‹ 3ï¼šåªæ‹›æ•° crond.service çš„æ•°æ®ï¼Œ åŒæ—¶åªåˆ—å‡ºæœ€æ–°çš„ 10 è¡Œä¿¡æ¯
[root@study ~]# journalctl _SYSTEMD_UNIT=crond.service -n 10

# èŒƒä¾‹ 4ï¼šæ‰¾å‡º suã€login æ‰§è¡Œçš„çš„æ—¥å¿—ï¼ŒåŒæ—¶åªåˆ—å‡ºæœ€æ–°çš„ 10 è¡Œæ•°æ®
[root@study ~]# journalctl _COMM=su _COMM=login -n 10

# èŒƒä¾‹ 5ï¼šæ‰¾å‡ºä¿¡æ¯ä¸¥é‡ç­‰çº§ä¸º error çš„ä¿¡æ¯
[root@study ~]# journalctl -p err

# èŒƒä¾‹ 6ï¼šæ‰¾å‡ºä¸ç™»å½•æœåŠ¡ authã€authpriv æœ‰å…³çš„æ—¥å¿—æ–‡ä»¶ä¿¡æ¯
[root@study ~]# journalctl SYSLOG_FACILITY=4 SYSLOG_FACILITY=10
# å…³äº  SYSLOG_FACILITY çš„å¯¹åº”ï¼Œå‚è€ƒå‰é¢çš„ç« èŠ‚

```

ä½¿ç”¨å®ƒçš„ `-f` å®æ—¶æ˜¾ç¤ºåŠŸèƒ½

```bash
# ç¬¬ä¸€ä¸ªç»ˆç«¯æœº
[root@study ~]# journalctl -f
... ä¸‹é¢çš„ä¿¡æ¯æ˜¯ï¼Œ2 å·ç»ˆç«¯æœºæ‰§è¡ŒæŒ‡ä»¤åæ˜¾ç¤ºçš„ä¿¡æ¯
Mar 16 01:15:25 study.centos.mrcode postfix/pickup[14953]: 827B31075: uid=1000 from=<mrcode>
Mar 16 01:15:25 study.centos.mrcode postfix/cleanup[20434]: 827B31075: message-id=<20200315171525.827B31075@study.centos.mrcode>
Mar 16 01:15:25 study.centos.mrcode postfix/qmgr[1618]: 827B31075: from=<mrcode@study.centos.mrcode>, size=449, nrcpt=1 (queue active)
Mar 16 01:15:25 study.centos.mrcode postfix/local[20436]: 827B31075: to=<dmtsai@study.centos.mrcode>, orig_to=<dmtsai>, relay=local, delay=0.02, delays=0.02/0/0/0, dsn=5.1.1, status=bounced (unknown user: "dmtsai")
Mar 16 01:15:25 study.centos.mrcode postfix/cleanup[20434]: 87ED81076: message-id=<20200315171525.87ED81076@study.centos.mrcode>
Mar 16 01:15:25 study.centos.mrcode postfix/bounce[20437]: 827B31075: sender non-delivery notification: 87ED81076
Mar 16 01:15:25 study.centos.mrcode postfix/qmgr[1618]: 827B31075: removed
Mar 16 01:15:25 study.centos.mrcode postfix/qmgr[1618]: 87ED81076: from=<>, size=2291, nrcpt=1 (queue active)
Mar 16 01:15:25 study.centos.mrcode postfix/local[20436]: 87ED81076: to=<mrcode@study.centos.mrcode>, relay=local, delay=0.01, delays=0/0/0/0, dsn=2.0.0, status=sent (delivered to mailbox)
Mar 16 01:15:25 study.centos.mrcode postfix/qmgr[1618]: 87ED81076: removed


# ç¬¬äºŒä¸ªç»ˆç«¯æœº
[mrcode@study ~]$ echo "test" | mail -s 'test' dmtsai

```

## ğŸ€  logger æŒ‡ä»¤çš„åº”ç”¨

journalctl æŒ‡ä»¤æ˜¯æŸ¥é˜…ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ logger æŠŠä½ çš„æ•°æ®å­˜å‚¨åˆ°æ–‡ä»¶ä¸­ï¼Œä¸‹é¢ä»‹ç»æœ€ç®€å•çš„æœ¬æœºä¿¡æ¯ä¼ é€’ï¼Œæ›´å¤šçš„æ–¹æ³•è¯·è‡ªè¡ŒæŸ¥é˜… man logger 

```bash
logger [-p æœåŠ¡åç§°.ç­‰çº§] "ä¿¡æ¯"
```

```bash
# èŒƒä¾‹ 1ï¼š è®© dmtsai ä½¿ç”¨ logger æ¥ä¼ é€æ•°æ®åˆ°æ—¥å¿—æ–‡ä»¶
[root@study ~]$ logger -p user.info "I will check logger command"
[root@study ~]# journalctl SYSLOG_FACILITY=1 -n 3
-- Logs begin at Sun 2020-03-15 20:13:33 CST, end at Mon 2020-03-16 01:20:43 CST. --
Mar 15 20:13:50 study.centos.mrcode spice-vdagent[1860]: Cannot access vdagent virtio channel /dev/virtio-ports/com.redhat.spi
Mar 15 20:13:50 study.centos.mrcode spice-streaming-agent[1867]: Failed to open the streaming device "/dev/virtio-ports/org.sp
Mar 16 01:20:43 study.centos.mrcode mrcode[13699]: I will check logger command
# å¯ä»¥çœ‹åˆ°è¿™é‡Œå·²ç»ä¼ è¾“åˆ°äº†
```

ä¹‹å‰å†™çš„ backup.service æœåŠ¡ä¸­ï¼Œå¦‚æœä½¿ç”¨æ‰‹åŠ¨æ–¹å¼æ¥å¤‡ä»½ï¼Œå³æ‰‹åŠ¨æ‰§è¡Œ `/backups/backup.sh log` æ¥å¤‡ä»½æ—¶ï¼Œé€šè¿‡ logger è®°å½•å¤‡ä»½å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´

```bash
[root@study ~]# vim /backups/backup.sh
#!/bin/bash

if [ "${1}" == 'log' ]; then
	logger -p syslog.info "backup.sh is starting"
fi

source="/etc /home /root /var/lib /var/spool/{cron,at,mail}"
target="/backups/backup-system-$(date +%Y-%m-%d).tar.gz"

[ ! -d /backups ] && mkdir /backups

tar -zcvf ${target} ${source} $> /backups/backup.log

if [ "${1}" == 'log' ]; then
	logger -p syslog.info "backup.sh is finished"
fi

[root@study ~]# /backups/backup.sh log
[root@study ~]# journalctl SYSLOG_FACILITY=5 -n 3
-- Logs begin at Sun 2020-03-15 20:13:33 CST, end at Mon 2020-03-16 01:28:54 CST. --
Mar 16 00:42:45 study.centos.mrcode rsyslogd[7107]:  [origin software="rsyslogd" swVersion="8.24.0-38.el7" x-pid="7107" x-info
Mar 16 01:28:27 study.centos.mrcode mrcode[17659]: backup.sh is starting
Mar 16 01:28:54 study.centos.mrcode mrcode[19555]: backup.sh is finished

```

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥æŒ‡ä»¤æ˜¯ç±»ä¼¼ä¸€ä¸ªæ—¥å¿—æœåŠ¡æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæŠŠæ—¥å¿—ä¿¡æ¯è®°å½•ä¸‹æ¥

## ğŸ€ ä¿å­˜ journal çš„æ–¹å¼

systemd-journald.service çš„ä¿¡æ¯åœ¨å†…å­˜ä¸­ï¼Œè€ŒæŒä¹…åŒ–åˆ°ç¡¬ç›˜çš„æ•°æ®æ˜¯é€šè¿‡ rsyslogd æ¥åšçš„ï¼Œå¦‚æœä½ æƒ³è¦ä¿å­˜ä¸‹ journald å¤„ç†çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹çš„æ–¹å¼

åŸºæœ¬ä¸Š systemd-journald.service çš„é…ç½®æ–‡ä»¶ä¸»è¦å‚è€ƒ `/etc/systemd/journald.conf` çš„å†…å®¹ï¼Œé»˜è®¤é…ç½®åŸºæœ¬ä¸Šæ»¡è¶³éœ€æ±‚ï¼Œå¦‚æœ‰å®šåˆ¶ä¿¡æ¯ï¼Œè¯·é€šè¿‡ man 5 journald.conf æŸ¥é˜…

```bash
# 1. å¤„ç†æ‰€éœ€è¦çš„ç›®å½•ä¸ç›¸å…³æƒé™è®¾ç½®
[root@study ~]# mkdir /var/log/journal
[root@study ~]# chown root:systemd-journal /var/log/journal/
[root@study ~]# chmod 2775 /var/log/journal/

# 2. é‡æ–°å¯åŠ¨ systemd-journald å¹¶è§‚å¯Ÿå¤‡ä»½çš„æ—¥å¿—æ•°æ®
[root@study ~]# systemctl restart systemd-journald.service 
[root@study ~]# ll /var/log/journal/
total 0
drwxr-sr-x. 2 root systemd-journal 28 Mar 16 01:35 f228ab37c368416c84c6b27971ba45a9

# é…ç½®é¢„è®¾çš„ç›®å½•åï¼ŒæœåŠ¡é‡å¯åï¼Œä¼šè‡ªåŠ¨å¤åˆ¶ä¸€ä»½åˆ°è¯¥ç›®å½•ä¸‹
```

ä½œè€…å»ºè®®ï¼›æœ‰ rsyslog.service ä»¥åŠ logrotate çš„å­˜åœ¨ï¼Œæ‰€ä»¥è¿™é‡Œäº§ç”Ÿçš„ä¿¡æ¯å¯ä»¥ä¸ç”¨å­˜æ¡£