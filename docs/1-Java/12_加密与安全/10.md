---
title: æ•°å­—è¯ä¹¦
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

æˆ‘ä»¬çŸ¥é“ï¼Œæ‘˜è¦ç®—æ³•ç”¨æ¥ç¡®ä¿æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œéå¯¹ç§°åŠ å¯†ç®—æ³•å¯ä»¥å¯¹æ•°æ®è¿›è¡ŒåŠ è§£å¯†ï¼Œç­¾åç®—æ³•å¯ä»¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’ŒæŠ—å¦è®¤æ€§ï¼ŒæŠŠè¿™äº›ç®—æ³•é›†åˆåˆ°ä¸€èµ·ï¼Œå¹¶æä¸€å¥—å®Œå–„çš„æ ‡å‡†ï¼Œè¿™å°±æ˜¯æ•°å­—è¯ä¹¦ã€‚

å› æ­¤ï¼Œæ•°å­—è¯ä¹¦å°±æ˜¯é›†åˆäº†å¤šç§å¯†ç å­¦ç®—æ³•ï¼Œç”¨äºå®ç°æ•°æ®åŠ è§£å¯†ã€èº«ä»½è®¤è¯ã€ç­¾åç­‰å¤šç§åŠŸèƒ½çš„ä¸€ç§å®‰å…¨æ ‡å‡†ã€‚

æ•°å­—è¯ä¹¦å¯ä»¥é˜²æ­¢ä¸­é—´äººæ”»å‡»ï¼Œå› ä¸ºå®ƒé‡‡ç”¨é“¾å¼ç­¾åè®¤è¯ï¼Œå³é€šè¿‡æ ¹è¯ä¹¦ï¼ˆRoot CAï¼‰å»ç­¾åä¸‹ä¸€çº§è¯ä¹¦ï¼Œè¿™æ ·å±‚å±‚ç­¾åï¼Œç›´åˆ°æœ€ç»ˆçš„ç”¨æˆ·è¯ä¹¦ã€‚è€Œ Root CA è¯ä¹¦å†…ç½®äºæ“ä½œç³»ç»Ÿä¸­ï¼Œæ‰€ä»¥ï¼Œä»»ä½•ç»è¿‡ CA è®¤è¯çš„æ•°å­—è¯ä¹¦éƒ½å¯ä»¥å¯¹å…¶æœ¬èº«è¿›è¡Œæ ¡éªŒï¼Œç¡®ä¿è¯ä¹¦æœ¬èº«ä¸æ˜¯ä¼ªé€ çš„ã€‚

æˆ‘ä»¬åœ¨ä¸Šç½‘æ—¶å¸¸ç”¨çš„ HTTPS åè®®å°±æ˜¯æ•°å­—è¯ä¹¦çš„åº”ç”¨ã€‚æµè§ˆå™¨ä¼šè‡ªåŠ¨éªŒè¯è¯ä¹¦çš„æœ‰æ•ˆæ€§ï¼š

![cert](assets/l-20231128145113102.jpeg)

è¦ä½¿ç”¨æ•°å­—è¯ä¹¦ï¼Œé¦–å…ˆéœ€è¦åˆ›å»ºè¯ä¹¦ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåˆæ³•çš„æ•°å­—è¯ä¹¦éœ€è¦ç»è¿‡ CA ç­¾åï¼Œè¿™éœ€è¦è®¤è¯åŸŸåå¹¶æ”¯ä»˜ä¸€å®šçš„è´¹ç”¨ã€‚å¼€å‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªç­¾åçš„è¯ä¹¦ï¼Œè¿™ç§è¯ä¹¦å¯ä»¥æ­£å¸¸å¼€å‘è°ƒè¯•ï¼Œä½†ä¸èƒ½å¯¹å¤–ä½œä¸ºæœåŠ¡ä½¿ç”¨ï¼Œå› ä¸ºå…¶ä»–å®¢æˆ·ç«¯å¹¶ä¸è®¤å¯æœªç» CA ç­¾åçš„è¯ä¹¦ã€‚

æ³¨ï¼š[è…¾è®¯äº‘](https://cloud.tencent.com/) å¯ç”³è¯·æœ‰æ•ˆæœŸ 1 å¹´çš„å…è´¹ SSL è¯ä¹¦ï¼Œ[Let's Encrypt](https://letsencrypt.org/) å¯ç”³è¯·æœ‰æ•ˆæœŸ 90 å¤©çš„å…è´¹ SSL è¯ä¹¦ã€‚

åœ¨ Java ç¨‹åºä¸­ï¼Œæ•°å­—è¯ä¹¦å­˜å‚¨åœ¨ä¸€ç§ Java ä¸“ç”¨çš„ key store æ–‡ä»¶ä¸­ï¼ŒJDK æä¾›äº†ä¸€ç³»åˆ—å‘½ä»¤æ¥åˆ›å»ºå’Œç®¡ç† key storeã€‚æˆ‘ä»¬ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ›å»ºä¸€ä¸ª key storeï¼Œå¹¶è®¾å®šå£ä»¤ 123456ï¼š

```
keytool -storepass 123456 -genkeypair -keyalg RSA -keysize 1024 -sigalg SHA1withRSA -validity 3650 -alias mycert -keystore my.keystore -dname "CN=www.sample.com, OU=sample, O=sample, L=BJ, ST=BJ, C=CN"
```

å‡ ä¸ªä¸»è¦çš„å‚æ•°æ˜¯ï¼š

- keyalgï¼šæŒ‡å®š RSA åŠ å¯†ç®—æ³•ï¼›
- sigalgï¼šæŒ‡å®š SHA1withRSA ç­¾åç®—æ³•ï¼›
- validityï¼šæŒ‡å®šè¯ä¹¦æœ‰æ•ˆæœŸ 3650 å¤©ï¼›
- aliasï¼šæŒ‡å®šè¯ä¹¦åœ¨ç¨‹åºä¸­å¼•ç”¨çš„åç§°ï¼›
- dnameï¼šæœ€é‡è¦çš„ `CN=www.sample.com` æŒ‡å®šäº† `Common Name`ï¼Œå¦‚æœè¯ä¹¦ç”¨åœ¨ HTTPS ä¸­ï¼Œè¿™ä¸ªåç§°å¿…é¡»ä¸åŸŸåå®Œå…¨ä¸€è‡´ã€‚

æ‰§è¡Œä¸Šè¿°å‘½ä»¤ï¼ŒJDK ä¼šåœ¨å½“å‰ç›®å½•åˆ›å»ºä¸€ä¸ª `my.keystore` æ–‡ä»¶ï¼Œå¹¶å­˜å‚¨åˆ›å»ºæˆåŠŸçš„ä¸€ä¸ªç§é’¥å’Œä¸€ä¸ªè¯ä¹¦ï¼Œå®ƒçš„åˆ«åæ˜¯ `mycert`ã€‚

æœ‰äº† key store å­˜å‚¨çš„è¯ä¹¦ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ•°å­—è¯ä¹¦è¿›è¡ŒåŠ è§£å¯†å’Œç­¾åï¼š

```java
import java.io.InputStream;
import java.math.BigInteger;
import java.security.*;
import java.security.cert.*;
import javax.crypto.Cipher;

public class Main {
    public static void main(String[] args) throws Exception {
        byte[] message = "Hello, use X.509 cert!".getBytes("UTF-8");
        // è¯»å– KeyStore:
        KeyStore ks = loadKeyStore("/my.keystore", "123456");
        // è¯»å–ç§é’¥:
        PrivateKey privateKey = (PrivateKey) ks.getKey("mycert", "123456".toCharArray());
        // è¯»å–è¯ä¹¦:
        X509Certificate certificate = (X509Certificate) ks.getCertificate("mycert");
        // åŠ å¯†:
        byte[] encrypted = encrypt(certificate, message);
        System.out.println(String.format("encrypted: %x", new BigInteger(1, encrypted)));
        // è§£å¯†:
        byte[] decrypted = decrypt(privateKey, encrypted);
        System.out.println("decrypted:" + new String(decrypted, "UTF-8"));
        // ç­¾å:
        byte[] sign = sign(privateKey, certificate, message);
        System.out.println(String.format("signature: %x", new BigInteger(1, sign)));
        // éªŒè¯ç­¾å:
        boolean verified = verify(certificate, message, sign);
        System.out.println("verify:" + verified);
    }

    static KeyStore loadKeyStore(String keyStoreFile, String password) {
        try (InputStream input = Main.class.getResourceAsStream(keyStoreFile)) {
            if (input == null) {
                throw new RuntimeException("file not found in classpath:" + keyStoreFile);
            }
            KeyStore ks = KeyStore.getInstance(KeyStore.getDefaultType());
            ks.load(input, password.toCharArray());
            return ks;
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    static byte[] encrypt(X509Certificate certificate, byte[] message) throws GeneralSecurityException {
        Cipher cipher = Cipher.getInstance(certificate.getPublicKey().getAlgorithm());
        cipher.init(Cipher.ENCRYPT_MODE, certificate.getPublicKey());
        return cipher.doFinal(message);
    }

    static byte[] decrypt(PrivateKey privateKey, byte[] data) throws GeneralSecurityException {
        Cipher cipher = Cipher.getInstance(privateKey.getAlgorithm());
        cipher.init(Cipher.DECRYPT_MODE, privateKey);
        return cipher.doFinal(data);
    }

    static byte[] sign(PrivateKey privateKey, X509Certificate certificate, byte[] message)
            throws GeneralSecurityException {
        Signature signature = Signature.getInstance(certificate.getSigAlgName());
        signature.initSign(privateKey);
        signature.update(message);
        return signature.sign();
    }

    static boolean verify(X509Certificate certificate, byte[] message, byte[] sig) throws GeneralSecurityException {
        Signature signature = Signature.getInstance(certificate.getSigAlgName());
        signature.initVerify(certificate);
        signature.update(message);
        return signature.verify(sig);
    }
}
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä» key store ç›´æ¥è¯»å–äº†ç§é’¥ - å…¬é’¥å¯¹ï¼Œç§é’¥ä»¥ `PrivateKey` å®ä¾‹è¡¨ç¤ºï¼Œå…¬é’¥ä»¥ `X509Certificate` è¡¨ç¤ºï¼Œå®é™…ä¸Šæ•°å­—è¯ä¹¦åªåŒ…å«å…¬é’¥ï¼Œå› æ­¤ï¼Œè¯»å–è¯ä¹¦å¹¶ä¸éœ€è¦å£ä»¤ï¼Œåªæœ‰è¯»å–ç§é’¥æ‰éœ€è¦ã€‚å¦‚æœéƒ¨ç½²åˆ° Web æœåŠ¡å™¨ä¸Šï¼Œä¾‹å¦‚ Nginxï¼Œéœ€è¦æŠŠç§é’¥å¯¼å‡ºä¸º Private Key æ ¼å¼ï¼ŒæŠŠè¯ä¹¦å¯¼å‡ºä¸º X509Certificate æ ¼å¼ã€‚

ä»¥ HTTPS åè®®ä¸ºä¾‹ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨å»ºç«‹å®‰å…¨è¿æ¥çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. æµè§ˆå™¨å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€è‡ªå·±çš„æ•°å­—è¯ä¹¦ï¼›
2. æµè§ˆå™¨ç”¨æ“ä½œç³»ç»Ÿå†…ç½®çš„ Root CA æ¥éªŒè¯æœåŠ¡å™¨çš„è¯ä¹¦æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæœ‰æ•ˆï¼Œå°±ä½¿ç”¨è¯¥è¯ä¹¦åŠ å¯†ä¸€ä¸ªéšæœºçš„ AES å£ä»¤å¹¶å‘é€ç»™æœåŠ¡å™¨ï¼›
3. æœåŠ¡å™¨ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†è·å¾— AES å£ä»¤ï¼Œå¹¶åœ¨åç»­é€šè®¯ä¸­ä½¿ç”¨ AES åŠ å¯†ã€‚

ä¸Šè¿°æµç¨‹åªæ˜¯ä¸€ç§æœ€å¸¸è§çš„å•å‘éªŒè¯ã€‚å¦‚æœæœåŠ¡å™¨è¿˜è¦éªŒè¯å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¹Ÿéœ€è¦æŠŠè‡ªå·±çš„è¯ä¹¦å‘é€ç»™æœåŠ¡å™¨éªŒè¯ï¼Œè¿™ç§åœºæ™¯å¸¸è§äºç½‘é“¶ç­‰ã€‚

æ³¨æ„ï¼šæ•°å­—è¯ä¹¦å­˜å‚¨çš„æ˜¯å…¬é’¥ï¼Œä»¥åŠç›¸å…³çš„è¯ä¹¦é“¾å’Œç®—æ³•ä¿¡æ¯ã€‚ç§é’¥å¿…é¡»ä¸¥æ ¼ä¿å¯†ï¼Œå¦‚æœæ•°å­—è¯ä¹¦å¯¹åº”çš„ç§é’¥æ³„æ¼ï¼Œå°±ä¼šé€ æˆä¸¥é‡çš„å®‰å…¨å¨èƒã€‚å¦‚æœ CA è¯ä¹¦çš„ç§é’¥æ³„æ¼ï¼Œé‚£ä¹ˆè¯¥ CA è¯ä¹¦ç­¾å‘çš„æ‰€æœ‰è¯ä¹¦å°†ä¸å¯ä¿¡ã€‚æ•°å­—è¯ä¹¦æœåŠ¡å•† [DigiNotar](https://en.wikipedia.org/wiki/DigiNotar) å°±å‘ç”Ÿè¿‡ç§é’¥æ³„æ¼å¯¼è‡´å…¬å¸ç ´äº§çš„äº‹æ•…ã€‚

## ğŸ€ ç»ƒä¹ 

```java
package com.itranswarp.learnjava;

import java.io.InputStream;
import java.math.BigInteger;
import java.security.*;
import java.security.cert.*;

import javax.crypto.Cipher;

public class Main {
	public static void main(String[] args) throws Exception {
		byte[] message = "Hello, use X.509 cert!".getBytes("UTF-8");
		// è¯»å– KeyStore:
		KeyStore ks = loadKeyStore("/my.keystore", "123456");
		// è¯»å–ç§é’¥:
		PrivateKey privateKey = (PrivateKey) ks.getKey("mycert", "123456".toCharArray());
		// è¯»å–è¯ä¹¦:
		X509Certificate certificate = (X509Certificate) ks.getCertificate("mycert");
		// åŠ å¯†:
		byte[] encrypted = encrypt(certificate, message);
		System.out.println(String.format("encrypted: %x", new BigInteger(1, encrypted)));
		// è§£å¯†:
		byte[] decrypted = decrypt(privateKey, encrypted);
		System.out.println("decrypted:" + new String(decrypted, "UTF-8"));
		// ç­¾å:
		byte[] sign = sign(privateKey, certificate, message);
		System.out.println(String.format("signature: %x", new BigInteger(1, sign)));
		// éªŒè¯ç­¾å:
		boolean verified = verify(certificate, message, sign);
		System.out.println("verify:" + verified);
	}

	static KeyStore loadKeyStore(String keyStoreFile, String password) {
		try (InputStream input = Main.class.getResourceAsStream(keyStoreFile)) {
			if (input == null) {
				throw new RuntimeException("file not found in classpath:" + keyStoreFile);
			}
			KeyStore ks = KeyStore.getInstance(KeyStore.getDefaultType());
			ks.load(input, password.toCharArray());
			return ks;
		} catch (Exception e) {
			throw new RuntimeException(e);
		}
	}

	static byte[] encrypt(X509Certificate certificate, byte[] message) throws GeneralSecurityException {
		Cipher cipher = Cipher.getInstance(certificate.getPublicKey().getAlgorithm());
		cipher.init(Cipher.ENCRYPT_MODE, certificate.getPublicKey());
		return cipher.doFinal(message);
	}

	static byte[] decrypt(PrivateKey privateKey, byte[] data) throws GeneralSecurityException {
		Cipher cipher = Cipher.getInstance(privateKey.getAlgorithm());
		cipher.init(Cipher.DECRYPT_MODE, privateKey);
		return cipher.doFinal(data);
	}

	static byte[] sign(PrivateKey privateKey, X509Certificate certificate, byte[] message)
			throws GeneralSecurityException {
		Signature signature = Signature.getInstance(certificate.getSigAlgName());
		signature.initSign(privateKey);
		signature.update(message);
		return signature.sign();
	}

	static boolean verify(X509Certificate certificate, byte[] message, byte[] sig) throws GeneralSecurityException {
		Signature signature = Signature.getInstance(certificate.getSigAlgName());
		signature.initVerify(certificate);
		signature.update(message);
		return signature.verify(sig);
	}
}
```

## ğŸ€ å°ç»“

æ•°å­—è¯ä¹¦å°±æ˜¯é›†åˆäº†å¤šç§å¯†ç å­¦ç®—æ³•ï¼Œç”¨äºå®ç°æ•°æ®åŠ è§£å¯†ã€èº«ä»½è®¤è¯ã€ç­¾åç­‰å¤šç§åŠŸèƒ½çš„ä¸€ç§å®‰å…¨æ ‡å‡†ã€‚

æ•°å­—è¯ä¹¦é‡‡ç”¨é“¾å¼ç­¾åç®¡ç†ï¼Œé¡¶çº§çš„ Root CA è¯ä¹¦å·²å†…ç½®åœ¨æ“ä½œç³»ç»Ÿä¸­ã€‚

æ•°å­—è¯ä¹¦å­˜å‚¨çš„æ˜¯å…¬é’¥ï¼Œå¯ä»¥å®‰å…¨å…¬å¼€ï¼Œè€Œç§é’¥å¿…é¡»ä¸¥æ ¼ä¿å¯†ã€‚