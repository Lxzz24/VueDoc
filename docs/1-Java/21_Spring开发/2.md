---
title: ä½¿ç”¨ AOP
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

AOP æ˜¯ Aspect Oriented Programmingï¼Œå³é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚

é‚£ä»€ä¹ˆæ˜¯ AOPï¼Ÿ

æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ OOPï¼šObject Oriented Programmingï¼ŒOOP ä½œä¸ºé¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ¨¡å¼ï¼Œè·å¾—äº†å·¨å¤§çš„æˆåŠŸï¼ŒOOP çš„ä¸»è¦åŠŸèƒ½æ˜¯æ•°æ®å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚

è€Œ AOP æ˜¯ä¸€ç§æ–°çš„ç¼–ç¨‹æ–¹å¼ï¼Œå®ƒå’Œ OOP ä¸åŒï¼ŒOOP æŠŠç³»ç»Ÿçœ‹ä½œå¤šä¸ªå¯¹è±¡çš„äº¤äº’ï¼ŒAOP æŠŠç³»ç»Ÿåˆ†è§£ä¸ºä¸åŒçš„å…³æ³¨ç‚¹ï¼Œæˆ–è€…ç§°ä¹‹ä¸ºåˆ‡é¢ï¼ˆAspectï¼‰ã€‚

è¦ç†è§£ AOP çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å…ˆç”¨ OOP ä¸¾ä¾‹ï¼Œæ¯”å¦‚ä¸€ä¸ªä¸šåŠ¡ç»„ä»¶ `BookService`ï¼Œå®ƒæœ‰å‡ ä¸ªä¸šåŠ¡æ–¹æ³•ï¼š

- createBookï¼šæ·»åŠ æ–°çš„ Bookï¼›
- updateBookï¼šä¿®æ”¹ Bookï¼›
- deleteBookï¼šåˆ é™¤ Bookã€‚

å¯¹æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ï¼Œä¾‹å¦‚ï¼Œ`createBook()`ï¼Œé™¤äº†ä¸šåŠ¡é€»è¾‘ï¼Œè¿˜éœ€è¦å®‰å…¨æ£€æŸ¥ã€æ—¥å¿—è®°å½•å’Œäº‹åŠ¡å¤„ç†ï¼Œå®ƒçš„ä»£ç åƒè¿™æ ·ï¼š

```java
public class BookService {
    public void createBook(Book book) {
        securityCheck();
        Transaction tx = startTransaction();
        try {
            // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
            tx.commit();
        } catch (RuntimeException e) {
            tx.rollback();
            throw e;
        }
        log("created book:" + book);
    }
}
```

ç»§ç»­ç¼–å†™ `updateBook()`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
public class BookService {
    public void updateBook(Book book) {
        securityCheck();
        Transaction tx = startTransaction();
        try {
            // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
            tx.commit();
        } catch (RuntimeException e) {
            tx.rollback();
            throw e;
        }
        log("updated book:" + book);
    }
}
```

å¯¹äºå®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰ä»£ç ï¼Œå®ƒä»¬ä¼šé‡å¤å‡ºç°åœ¨æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­ã€‚ä½¿ç”¨ OOPï¼Œæˆ‘ä»¬å¾ˆéš¾å°†è¿™äº›å››å¤„åˆ†æ•£çš„ä»£ç æ¨¡å—åŒ–ã€‚

è€ƒå¯Ÿä¸šåŠ¡æ¨¡å‹å¯ä»¥å‘ç°ï¼Œ`BookService` å…³å¿ƒçš„æ˜¯è‡ªèº«çš„æ ¸å¿ƒé€»è¾‘ï¼Œä½†æ•´ä¸ªç³»ç»Ÿè¿˜è¦æ±‚å…³æ³¨å®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å®é™…ä¸Š â€œæ¨ªè·¨â€ å¤šä¸ªä¸šåŠ¡æ–¹æ³•ï¼Œä¸ºäº†å®ç°è¿™äº›åŠŸèƒ½ï¼Œä¸å¾—ä¸åœ¨æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸Šé‡å¤ç¼–å†™ä»£ç ã€‚

ä¸€ç§å¯è¡Œçš„æ–¹å¼æ˜¯ä½¿ç”¨ [Proxy æ¨¡å¼](https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017)ï¼Œå°†æŸä¸ªåŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œæƒé™æ£€æŸ¥ï¼Œæ”¾å…¥ Proxy ä¸­ï¼š

```java
public class SecurityCheckBookService implements BookService {
    private final BookService target;

    public SecurityCheckBookService(BookService target) {
        this.target = target;
    }

    public void createBook(Book book) {
        securityCheck();
        target.createBook(book);
    }

    public void updateBook(Book book) {
        securityCheck();
        target.updateBook(book);
    }

    public void deleteBook(Book book) {
        securityCheck();
        target.deleteBook(book);
    }

    private void securityCheck() {
        ...
    }
}
```

è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œå¿…é¡»å…ˆæŠ½å–æ¥å£ï¼Œç„¶åï¼Œé’ˆå¯¹æ¯ä¸ªæ–¹æ³•å®ç° Proxyã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œæ—¢ç„¶ `SecurityCheckBookService` çš„ä»£ç éƒ½æ˜¯æ ‡å‡†çš„ Proxy æ ·æ¿ä»£ç ï¼Œä¸å¦‚æŠŠæƒé™æ£€æŸ¥è§†ä½œä¸€ç§åˆ‡é¢ï¼ˆAspectï¼‰ï¼ŒæŠŠæ—¥å¿—ã€äº‹åŠ¡ä¹Ÿè§†ä¸ºåˆ‡é¢ï¼Œç„¶åï¼Œä»¥æŸç§è‡ªåŠ¨åŒ–çš„æ–¹å¼ï¼ŒæŠŠåˆ‡é¢ç»‡å…¥åˆ°æ ¸å¿ƒé€»è¾‘ä¸­ï¼Œå®ç° Proxy æ¨¡å¼ã€‚

å¦‚æœæˆ‘ä»¬ä»¥ AOP çš„è§†è§’æ¥ç¼–å†™ä¸Šè¿°ä¸šåŠ¡ï¼Œå¯ä»¥ä¾æ¬¡å®ç°ï¼š

1. æ ¸å¿ƒé€»è¾‘ï¼Œå³ BookServiceï¼›
2. åˆ‡é¢é€»è¾‘ï¼Œå³ï¼š
3. æƒé™æ£€æŸ¥çš„ Aspectï¼›
4. æ—¥å¿—çš„ Aspectï¼›
5. äº‹åŠ¡çš„ Aspectã€‚

ç„¶åï¼Œä»¥æŸç§æ–¹å¼ï¼Œè®©æ¡†æ¶æ¥æŠŠä¸Šè¿° 3 ä¸ª Aspect ä»¥ Proxy çš„æ–¹å¼ â€œç»‡å…¥â€ åˆ° `BookService` ä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå°±ä¸å¿…ç¼–å†™å¤æ‚è€Œå†—é•¿çš„ Proxy æ¨¡å¼ã€‚

## ğŸ€ AOP åŸç†

å¦‚ä½•æŠŠåˆ‡é¢ç»‡å…¥åˆ°æ ¸å¿ƒé€»è¾‘ä¸­ï¼Ÿè¿™æ­£æ˜¯ AOP éœ€è¦è§£å†³çš„é—®é¢˜ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯è·å¾—äº† `BookService` çš„å¼•ç”¨ï¼Œå½“è°ƒç”¨ `bookService.createBook()` æ—¶ï¼Œå¦‚ä½•å¯¹è°ƒç”¨æ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œå¹¶åœ¨æ‹¦æˆªå‰åè¿›è¡Œå®‰å…¨æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰å¤„ç†ï¼Œå°±ç›¸å½“äºå®Œæˆäº†æ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½ã€‚

åœ¨ Java å¹³å°ä¸Šï¼Œå¯¹äº AOP çš„ç»‡å…¥ï¼Œæœ‰ 3 ç§æ–¹å¼ï¼š

1. ç¼–è¯‘æœŸï¼šåœ¨ç¼–è¯‘æ—¶ï¼Œç”±ç¼–è¯‘å™¨æŠŠåˆ‡é¢è°ƒç”¨ç¼–è¯‘è¿›å­—èŠ‚ç ï¼Œè¿™ç§æ–¹å¼éœ€è¦å®šä¹‰æ–°çš„å…³é”®å­—å¹¶æ‰©å±•ç¼–è¯‘å™¨ï¼ŒAspectJ å°±æ‰©å±•äº† Java ç¼–è¯‘å™¨ï¼Œä½¿ç”¨å…³é”®å­— aspect æ¥å®ç°ç»‡å…¥ï¼›
2. ç±»åŠ è½½å™¨ï¼šåœ¨ç›®æ ‡ç±»è¢«è£…è½½åˆ° JVM æ—¶ï¼Œé€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„ç±»åŠ è½½å™¨ï¼Œå¯¹ç›®æ ‡ç±»çš„å­—èŠ‚ç é‡æ–° â€œå¢å¼ºâ€ï¼›
3. è¿è¡ŒæœŸï¼šç›®æ ‡å¯¹è±¡å’Œåˆ‡é¢éƒ½æ˜¯æ™®é€š Java ç±»ï¼Œé€šè¿‡ JVM çš„åŠ¨æ€ä»£ç†åŠŸèƒ½æˆ–è€…ç¬¬ä¸‰æ–¹åº“å®ç°è¿è¡ŒæœŸåŠ¨æ€ç»‡å…¥ã€‚

æœ€ç®€å•çš„æ–¹å¼æ˜¯ç¬¬ä¸‰ç§ï¼ŒSpring çš„ AOP å®ç°å°±æ˜¯åŸºäº JVM çš„åŠ¨æ€ä»£ç†ã€‚ç”±äº JVM çš„åŠ¨æ€ä»£ç†è¦æ±‚å¿…é¡»å®ç°æ¥å£ï¼Œå¦‚æœä¸€ä¸ªæ™®é€šç±»æ²¡æœ‰ä¸šåŠ¡æ¥å£ï¼Œå°±éœ€è¦é€šè¿‡ [CGLIB](https://github.com/cglib/cglib) æˆ–è€… [Javassist](https://www.javassist.org/) è¿™äº›ç¬¬ä¸‰æ–¹åº“å®ç°ã€‚

AOP æŠ€æœ¯çœ‹ä¸Šå»æ¯”è¾ƒç¥ç§˜ï¼Œä½†å®é™…ä¸Šï¼Œå®ƒæœ¬è´¨å°±æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼Œè®©æˆ‘ä»¬æŠŠä¸€äº›å¸¸ç”¨åŠŸèƒ½å¦‚æƒé™æ£€æŸ¥ã€æ—¥å¿—ã€äº‹åŠ¡ç­‰ï¼Œä»æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­å‰¥ç¦»å‡ºæ¥ã€‚

éœ€è¦ç‰¹åˆ«æŒ‡å‡ºçš„æ˜¯ï¼ŒAOP å¯¹äºè§£å†³ç‰¹å®šé—®é¢˜ï¼Œä¾‹å¦‚äº‹åŠ¡ç®¡ç†éå¸¸æœ‰ç”¨ï¼Œè¿™æ˜¯å› ä¸ºåˆ†æ•£åœ¨å„å¤„çš„äº‹åŠ¡ä»£ç å‡ ä¹æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œå¹¶ä¸”å®ƒä»¬éœ€è¦çš„å‚æ•°ï¼ˆJDBC çš„ Connectionï¼‰ä¹Ÿæ˜¯å›ºå®šçš„ã€‚å¦ä¸€äº›ç‰¹å®šé—®é¢˜ï¼Œå¦‚æ—¥å¿—ï¼Œå°±ä¸é‚£ä¹ˆå®¹æ˜“å®ç°ï¼Œå› ä¸ºæ—¥å¿—è™½ç„¶ç®€å•ï¼Œä½†æ‰“å°æ—¥å¿—çš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦æ•è·å±€éƒ¨å˜é‡ï¼Œå¦‚æœä½¿ç”¨ AOP å®ç°æ—¥å¿—ï¼Œæˆ‘ä»¬åªèƒ½è¾“å‡ºå›ºå®šæ ¼å¼çš„æ—¥å¿—ï¼Œå› æ­¤ï¼Œä½¿ç”¨ AOP æ—¶ï¼Œå¿…é¡»é€‚åˆç‰¹å®šçš„åœºæ™¯ã€‚



## ğŸ€ è£…é… AOP


åœ¨ AOP ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸‹é¢çš„æ¦‚å¿µï¼š

- Aspectï¼šåˆ‡é¢ï¼Œå³ä¸€ä¸ªæ¨ªè·¨å¤šä¸ªæ ¸å¿ƒé€»è¾‘çš„åŠŸèƒ½ï¼Œæˆ–è€…ç§°ä¹‹ä¸ºç³»ç»Ÿå…³æ³¨ç‚¹ï¼›
- Joinpointï¼šè¿æ¥ç‚¹ï¼Œå³å®šä¹‰åœ¨åº”ç”¨ç¨‹åºæµç¨‹çš„ä½•å¤„æ’å…¥åˆ‡é¢çš„æ‰§è¡Œï¼›
- Pointcutï¼šåˆ‡å…¥ç‚¹ï¼Œå³ä¸€ç»„è¿æ¥ç‚¹çš„é›†åˆï¼›
- Adviceï¼šå¢å¼ºï¼ŒæŒ‡ç‰¹å®šè¿æ¥ç‚¹ä¸Šæ‰§è¡Œçš„åŠ¨ä½œï¼›
- Introductionï¼šå¼•ä»‹ï¼ŒæŒ‡ä¸ºä¸€ä¸ªå·²æœ‰çš„ Java å¯¹è±¡åŠ¨æ€åœ°å¢åŠ æ–°çš„æ¥å£ï¼›
- Weavingï¼šç»‡å…¥ï¼ŒæŒ‡å°†åˆ‡é¢æ•´åˆåˆ°ç¨‹åºçš„æ‰§è¡Œæµç¨‹ä¸­ï¼›
- Interceptorï¼šæ‹¦æˆªå™¨ï¼Œæ˜¯ä¸€ç§å®ç°å¢å¼ºçš„æ–¹å¼ï¼›
- Target Objectï¼šç›®æ ‡å¯¹è±¡ï¼Œå³çœŸæ­£æ‰§è¡Œä¸šåŠ¡çš„æ ¸å¿ƒé€»è¾‘å¯¹è±¡ï¼›
- AOP Proxyï¼šAOP ä»£ç†ï¼Œæ˜¯å®¢æˆ·ç«¯æŒæœ‰çš„å¢å¼ºåçš„å¯¹è±¡å¼•ç”¨ã€‚

çœ‹å®Œä¸Šè¿°æœ¯è¯­ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å¯¹ AOP æœ‰äº†è¿›ä¸€æ­¥çš„å›°æƒ‘ï¼Ÿå…¶å®ï¼Œæˆ‘ä»¬ä¸ç”¨å…³å¿ƒ AOP åˆ›é€ çš„ â€œæœ¯è¯­â€ï¼Œåªéœ€è¦ç†è§£ AOP æœ¬è´¨ä¸Šåªæ˜¯ä¸€ç§ä»£ç†æ¨¡å¼çš„å®ç°æ–¹å¼ï¼Œåœ¨ Spring çš„å®¹å™¨ä¸­å®ç° AOP ç‰¹åˆ«æ–¹ä¾¿ã€‚

æˆ‘ä»¬ä»¥ `UserService` å’Œ `MailService` ä¸ºä¾‹ï¼Œè¿™ä¸¤ä¸ªå±äºæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡ç»™ `UserService` çš„æ¯ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œå‰æ·»åŠ æ—¥å¿—ï¼Œç»™ `MailService` çš„æ¯ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œå‰åæ·»åŠ æ—¥å¿—ï¼Œåœ¨ Spring ä¸­ï¼Œéœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š

é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ Maven å¼•å…¥ Spring å¯¹ AOP çš„æ”¯æŒï¼š

- org.springframework:spring-aspects:6.0.0

ä¸Šè¿°ä¾èµ–ä¼šè‡ªåŠ¨å¼•å…¥ AspectJï¼Œä½¿ç”¨ AspectJ å®ç° AOP æ¯”è¾ƒæ–¹ä¾¿ï¼Œå› ä¸ºå®ƒçš„å®šä¹‰æ¯”è¾ƒç®€å•ã€‚

ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª `LoggingAspect`ï¼š

```java
@Aspect
@Component
public class LoggingAspect {
    // åœ¨æ‰§è¡Œ UserService çš„æ¯ä¸ªæ–¹æ³•å‰æ‰§è¡Œ:
    @Before("execution(public * com.itranswarp.learnjava.service.UserService.*(..))")
    public void doAccessCheck() {
        System.err.println("[Before] do access check...");
    }

    // åœ¨æ‰§è¡Œ MailService çš„æ¯ä¸ªæ–¹æ³•å‰åæ‰§è¡Œ:
    @Around("execution(public * com.itranswarp.learnjava.service.MailService.*(..))")
    public Object doLogging(ProceedingJoinPoint pjp) throws Throwable {
        System.err.println("[Around] start" + pjp.getSignature());
        Object retVal = pjp.proceed();
        System.err.println("[Around] done" + pjp.getSignature());
        return retVal;
    }
}
```

è§‚å¯Ÿ `doAccessCheck()` æ–¹æ³•ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `@Before` æ³¨è§£ï¼Œåé¢çš„å­—ç¬¦ä¸²æ˜¯å‘Šè¯‰ AspectJ åº”è¯¥åœ¨ä½•å¤„æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œè¿™é‡Œå†™çš„æ„æ€æ˜¯ï¼šæ‰§è¡Œ `UserService` çš„æ¯ä¸ª `public` æ–¹æ³•å‰æ‰§è¡Œ `doAccessCheck()` ä»£ç ã€‚

å†è§‚å¯Ÿ `doLogging()` æ–¹æ³•ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `@Around` æ³¨è§£ï¼Œå®ƒå’Œ `@Before` ä¸åŒï¼Œ`@Around` å¯ä»¥å†³å®šæ˜¯å¦æ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åœ¨ `doLogging()` å†…éƒ¨å…ˆæ‰“å°æ—¥å¿—ï¼Œå†è°ƒç”¨æ–¹æ³•ï¼Œæœ€åæ‰“å°æ—¥å¿—åè¿”å›ç»“æœã€‚

åœ¨ `LoggingAspect` ç±»çš„å£°æ˜å¤„ï¼Œé™¤äº†ç”¨ `@Component` è¡¨ç¤ºå®ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª Bean å¤–ï¼Œæˆ‘ä»¬å†åŠ ä¸Š `@Aspect` æ³¨è§£ï¼Œè¡¨ç¤ºå®ƒçš„ `@Before` æ ‡æ³¨çš„æ–¹æ³•éœ€è¦æ³¨å…¥åˆ° `UserService` çš„æ¯ä¸ª `public` æ–¹æ³•æ‰§è¡Œå‰ï¼Œ`@Around` æ ‡æ³¨çš„æ–¹æ³•éœ€è¦æ³¨å…¥åˆ° `MailService` çš„æ¯ä¸ª `public` æ–¹æ³•æ‰§è¡Œå‰åã€‚

ç´§æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦ç»™ `@Configuration` ç±»åŠ ä¸Šä¸€ä¸ª `@EnableAspectJAutoProxy` æ³¨è§£ï¼š

```java
@Configuration
@ComponentScan
@EnableAspectJAutoProxy
public class AppConfig {
    ...
}
```

Spring çš„ IoC å®¹å™¨çœ‹åˆ°è¿™ä¸ªæ³¨è§£ï¼Œå°±ä¼šè‡ªåŠ¨æŸ¥æ‰¾å¸¦æœ‰ `@Aspect` çš„ Beanï¼Œç„¶åæ ¹æ®æ¯ä¸ªæ–¹æ³•çš„ `@Before`ã€`@Around` ç­‰æ³¨è§£æŠŠ AOP æ³¨å…¥åˆ°ç‰¹å®šçš„ Bean ä¸­ã€‚æ‰§è¡Œä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

```bash
[Before] do access check...
[Around] start void com.itranswarp.learnjava.service.MailService.sendRegistrationMail(User)
Welcome, test!
[Around] done void com.itranswarp.learnjava.service.MailService.sendRegistrationMail(User)
[Before] do access check...
[Around] start void com.itranswarp.learnjava.service.MailService.sendLoginMail(User)
Hi, Bob! You are logged in at 2020-02-14T23:13:52.167996+08:00[Asia/Shanghai]
[Around] done void com.itranswarp.learnjava.service.MailService.sendLoginMail(User)
```

è¿™è¯´æ˜æ‰§è¡Œä¸šåŠ¡é€»è¾‘å‰åï¼Œç¡®å®æ‰§è¡Œäº†æˆ‘ä»¬å®šä¹‰çš„ Aspectï¼ˆå³ `LoggingAspect` çš„æ–¹æ³•ï¼‰ã€‚

æœ‰äº›ç«¥é‹ä¼šé—®ï¼Œ`LoggingAspect` å®šä¹‰çš„æ–¹æ³•ï¼Œæ˜¯å¦‚ä½•æ³¨å…¥åˆ°å…¶ä»– Bean çš„å‘¢ï¼Ÿ

å…¶å® AOP çš„åŸç†éå¸¸ç®€å•ã€‚æˆ‘ä»¬ä»¥ `LoggingAspect.doAccessCheck()` ä¸ºä¾‹ï¼Œè¦æŠŠå®ƒæ³¨å…¥åˆ° `UserService` çš„æ¯ä¸ª `public` æ–¹æ³•ä¸­ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ç¼–å†™ä¸€ä¸ªå­ç±»ï¼Œå¹¶æŒæœ‰åŸå§‹å®ä¾‹çš„å¼•ç”¨ï¼š

```java
public UserServiceAopProxy extends UserService {
    private UserService target;
    private LoggingAspect aspect;

    public UserServiceAopProxy(UserService target, LoggingAspect aspect) {
        this.target = target;
        this.aspect = aspect;
    }

    public User login(String email, String password) {
        // å…ˆæ‰§è¡Œ Aspect çš„ä»£ç :
        aspect.doAccessCheck();
        // å†æ‰§è¡Œ UserService çš„é€»è¾‘:
        return target.login(email, password);
    }

    public User register(String email, String password, String name) {
        aspect.doAccessCheck();
        return target.register(email, password, name);
    }

    ...
}
```

è¿™äº›éƒ½æ˜¯ Spring å®¹å™¨å¯åŠ¨æ—¶ä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ›å»ºçš„æ³¨å…¥äº† Aspect çš„å­ç±»ï¼Œå®ƒå–ä»£äº†åŸå§‹çš„ `UserService`ï¼ˆåŸå§‹çš„ `UserService` å®ä¾‹ä½œä¸ºå†…éƒ¨å˜é‡éšè—åœ¨ `UserServiceAopProxy` ä¸­ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æ‰“å°ä» Spring å®¹å™¨è·å–çš„ `UserService` å®ä¾‹ç±»å‹ï¼Œå®ƒç±»ä¼¼ `UserService$$EnhancerBySpringCGLIB$$1f44e01c`ï¼Œå®é™…ä¸Šæ˜¯ Spring ä½¿ç”¨ CGLIB åŠ¨æ€åˆ›å»ºçš„å­ç±»ï¼Œä½†å¯¹äºè°ƒç”¨æ–¹æ¥è¯´ï¼Œæ„Ÿè§‰ä¸åˆ°ä»»ä½•åŒºåˆ«ã€‚

> [!NOTE]
> Spring å¯¹æ¥å£ç±»å‹ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¯¹æ™®é€šç±»ä½¿ç”¨ CGLIB åˆ›å»ºå­ç±»ã€‚å¦‚æœä¸€ä¸ª Bean çš„ class æ˜¯ finalï¼ŒSpring å°†æ— æ³•ä¸ºå…¶åˆ›å»ºå­ç±»ã€‚

å¯è§ï¼Œè™½ç„¶ Spring å®¹å™¨å†…éƒ¨å®ç° AOP çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼ˆéœ€è¦ä½¿ç”¨ AspectJ è§£ææ³¨è§£ï¼Œå¹¶é€šè¿‡ CGLIB å®ç°ä»£ç†ç±»ï¼‰ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨ AOP éå¸¸ç®€å•ï¼Œä¸€å…±éœ€è¦ä¸‰æ­¥ï¼š

1. å®šä¹‰æ‰§è¡Œæ–¹æ³•ï¼Œå¹¶åœ¨æ–¹æ³•ä¸Šé€šè¿‡ AspectJ çš„æ³¨è§£å‘Šè¯‰ Spring åº”è¯¥åœ¨ä½•å¤„è°ƒç”¨æ­¤æ–¹æ³•ï¼›
2. æ ‡è®° `@Component` å’Œ `@Aspect`ï¼›
3. åœ¨ `@Configuration` ç±»ä¸Šæ ‡æ³¨ `@EnableAspectJAutoProxy`ã€‚

è‡³äº AspectJ çš„æ³¨å…¥è¯­æ³•åˆ™æ¯”è¾ƒå¤æ‚ï¼Œè¯·å‚è€ƒ [Spring æ–‡æ¡£](https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-pointcuts-examples)ã€‚

Spring ä¹Ÿæä¾›å…¶ä»–æ–¹æ³•æ¥è£…é… AOPï¼Œä½†éƒ½æ²¡æœ‰ä½¿ç”¨ AspectJ æ³¨è§£çš„æ–¹å¼æ¥å¾—ç®€æ´æ˜äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å†ä½œä»‹ç»ã€‚

### æ‹¦æˆªå™¨ç±»å‹

é¡¾åæ€ä¹‰ï¼Œæ‹¦æˆªå™¨æœ‰ä»¥ä¸‹ç±»å‹ï¼š

- @Beforeï¼šè¿™ç§æ‹¦æˆªå™¨å…ˆæ‰§è¡Œæ‹¦æˆªä»£ç ï¼Œå†æ‰§è¡Œç›®æ ‡ä»£ç ã€‚å¦‚æœæ‹¦æˆªå™¨æŠ›å¼‚å¸¸ï¼Œé‚£ä¹ˆç›®æ ‡ä»£ç å°±ä¸æ‰§è¡Œäº†ï¼›
- @Afterï¼šè¿™ç§æ‹¦æˆªå™¨å…ˆæ‰§è¡Œç›®æ ‡ä»£ç ï¼Œå†æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ã€‚æ— è®ºç›®æ ‡ä»£ç æ˜¯å¦æŠ›å¼‚å¸¸ï¼Œæ‹¦æˆªå™¨ä»£ç éƒ½ä¼šæ‰§è¡Œï¼›
- @AfterReturningï¼šå’Œ @After ä¸åŒçš„æ˜¯ï¼Œåªæœ‰å½“ç›®æ ‡ä»£ç æ­£å¸¸è¿”å›æ—¶ï¼Œæ‰æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ï¼›
- @AfterThrowingï¼šå’Œ @After ä¸åŒçš„æ˜¯ï¼Œåªæœ‰å½“ç›®æ ‡ä»£ç æŠ›å‡ºäº†å¼‚å¸¸æ—¶ï¼Œæ‰æ‰§è¡Œæ‹¦æˆªå™¨ä»£ç ï¼›
- @Aroundï¼šèƒ½å®Œå…¨æ§åˆ¶ç›®æ ‡ä»£ç æ˜¯å¦æ‰§è¡Œï¼Œå¹¶å¯ä»¥åœ¨æ‰§è¡Œå‰åã€æŠ›å¼‚å¸¸åæ‰§è¡Œä»»æ„æ‹¦æˆªä»£ç ï¼Œå¯ä»¥è¯´æ˜¯åŒ…å«äº†ä¸Šé¢æ‰€æœ‰åŠŸèƒ½ã€‚

### ç»ƒä¹ 

ä½¿ç”¨ AOP å®ç°æ—¥å¿—

### å°ç»“

åœ¨ Spring å®¹å™¨ä¸­ä½¿ç”¨ AOP éå¸¸ç®€å•ï¼Œåªéœ€è¦å®šä¹‰æ‰§è¡Œæ–¹æ³•ï¼Œå¹¶ç”¨ AspectJ çš„æ³¨è§£æ ‡æ³¨åº”è¯¥åœ¨ä½•å¤„è§¦å‘å¹¶æ‰§è¡Œã€‚

Spring é€šè¿‡ CGLIB åŠ¨æ€åˆ›å»ºå­ç±»ç­‰æ–¹å¼æ¥å®ç° AOP ä»£ç†æ¨¡å¼ï¼Œå¤§å¤§ç®€åŒ–äº†ä»£ç ã€‚



## ğŸ€ ä½¿ç”¨æ³¨è§£è£…é… AOP


ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²è§£äº†ä½¿ç”¨ AspectJ çš„æ³¨è§£ï¼Œå¹¶é…åˆä¸€ä¸ªå¤æ‚çš„ `execution(* xxx.Xyz.*(..))` è¯­æ³•æ¥å®šä¹‰åº”è¯¥å¦‚ä½•è£…é… AOPã€‚

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™ç§å†™æ³•å…¶å®å¾ˆå°‘ä½¿ç”¨ã€‚å‡è®¾ä½ å†™äº†ä¸€ä¸ª `SecurityAspect`ï¼š

```java
@Aspect
@Component
public class SecurityAspect {
    @Before("execution(public * com.itranswarp.learnjava.service.*.*(..))")
    public void check() {
        if (SecurityContext.getCurrentUser() == null) {
            throw new RuntimeException("check failed");
        }
    }
}
```

åŸºæœ¬èƒ½å®ç°æ— å·®åˆ«å…¨è¦†ç›–ï¼Œå³æŸä¸ªåŒ…ä¸‹é¢çš„æ‰€æœ‰ Bean çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¢«è¿™ä¸ª `check()` æ–¹æ³•æ‹¦æˆªã€‚

è¿˜æœ‰çš„ç«¥é‹å–œæ¬¢ç”¨æ–¹æ³•åå‰ç¼€è¿›è¡Œæ‹¦æˆªï¼š

```java
@Around("execution(public * update*(..))")
public Object doLogging(ProceedingJoinPoint pjp) throws Throwable {
    // å¯¹ update å¼€å¤´çš„æ–¹æ³•åˆ‡æ¢æ•°æ®æº:
    String old = setCurrentDataSource("master");
    Object retVal = pjp.proceed();
    restoreCurrentDataSource(old);
    return retVal;
}
```

è¿™ç§éç²¾å‡†æ‰“å‡»è¯¯ä¼¤é¢æ›´å¤§ï¼Œå› ä¸ºä»æ–¹æ³•å‰ç¼€åŒºåˆ†æ˜¯å¦æ˜¯æ•°æ®åº“æ“ä½œæ˜¯éå¸¸ä¸å¯å–çš„ã€‚

æˆ‘ä»¬åœ¨ä½¿ç”¨ AOP æ—¶ï¼Œè¦æ³¨æ„åˆ°è™½ç„¶ Spring å®¹å™¨å¯ä»¥æŠŠæŒ‡å®šçš„æ–¹æ³•é€šè¿‡ AOP è§„åˆ™è£…é…åˆ°æŒ‡å®šçš„ Bean çš„æŒ‡å®šæ–¹æ³•å‰åï¼Œä½†æ˜¯ï¼Œå¦‚æœè‡ªåŠ¨è£…é…æ—¶ï¼Œå› ä¸ºä¸æ°å½“çš„èŒƒå›´ï¼Œå®¹æ˜“å¯¼è‡´æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œå³å¾ˆå¤šä¸éœ€è¦ AOP ä»£ç†çš„ Bean ä¹Ÿè¢«è‡ªåŠ¨ä»£ç†äº†ï¼Œå¹¶ä¸”ï¼Œåç»­æ–°å¢çš„ Beanï¼Œå¦‚æœä¸æ¸…æ¥šç°æœ‰çš„ AOP è£…é…è§„åˆ™ï¼Œå®¹æ˜“è¢«å¼ºè¿«è£…é…ã€‚

ä½¿ç”¨ AOP æ—¶ï¼Œè¢«è£…é…çš„ Bean æœ€å¥½è‡ªå·±èƒ½æ¸…æ¸…æ¥šæ¥šåœ°çŸ¥é“è‡ªå·±è¢«å®‰æ’äº†ã€‚ä¾‹å¦‚ï¼ŒSpring æä¾›çš„ `@Transactional` å°±æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¾‹å­ã€‚å¦‚æœæˆ‘ä»¬è‡ªå·±å†™çš„ Bean å¸Œæœ›åœ¨ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ä¸­è¢«è°ƒç”¨ï¼Œå°±æ ‡æ³¨ä¸Š `@Transactional`ï¼š

```java
@Component
public class UserService {
    // æœ‰äº‹åŠ¡:
    @Transactional
    public User createUser(String name) {
        ...
    }

    // æ— äº‹åŠ¡:
    public boolean isValidName(String name) {
        ...
    }

    // æœ‰äº‹åŠ¡:
    @Transactional
    public void updateUser(User user) {
        ...
    }
}
```

æˆ–è€…ç›´æ¥åœ¨ class çº§åˆ«æ³¨è§£ï¼Œè¡¨ç¤º â€œæ‰€æœ‰ public æ–¹æ³•éƒ½è¢«å®‰æ’äº†â€ï¼š

```java
@Component
@Transactional
public class UserService {
    ...
}
```

é€šè¿‡ `@Transactional`ï¼ŒæŸä¸ªæ–¹æ³•æ˜¯å¦å¯ç”¨äº†äº‹åŠ¡å°±ä¸€æ¸…äºŒæ¥šäº†ã€‚å› æ­¤ï¼Œè£…é… AOP çš„æ—¶å€™ï¼Œä½¿ç”¨æ³¨è§£æ˜¯æœ€å¥½çš„æ–¹å¼ã€‚

æˆ‘ä»¬ä»¥ä¸€ä¸ªå®é™…ä¾‹å­æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æ³¨è§£å®ç° AOP è£…é…ã€‚ä¸ºäº†ç›‘æ§åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ€§èƒ½ç›‘æ§çš„æ³¨è§£ï¼š

```java
@Target(METHOD)
@Retention(RUNTIME)
public @interface MetricTime {
    String value();
}
```

åœ¨éœ€è¦è¢«ç›‘æ§çš„å…³é”®æ–¹æ³•ä¸Šæ ‡æ³¨è¯¥æ³¨è§£ï¼š

```java
@Component
public class UserService {
    // ç›‘æ§ register() æ–¹æ³•æ€§èƒ½:
    @MetricTime("register")
    public User register(String email, String password, String name) {
        ...
    }
    ...
}
```

ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ `MetricAspect`ï¼š

```java
@Aspect
@Component
public class MetricAspect {
    @Around("@annotation(metricTime)")
    public Object metric(ProceedingJoinPoint joinPoint, MetricTime metricTime) throws Throwable {
        String name = metricTime.value();
        long start = System.currentTimeMillis();
        try {
            return joinPoint.proceed();
        } finally {
            long t = System.currentTimeMillis() - start;
            // å†™å…¥æ—¥å¿—æˆ–å‘é€è‡³ JMX:
            System.err.println("[Metrics]" + name + ":" + t + "ms");
        }
    }
}
```

æ³¨æ„ `metric()` æ–¹æ³•æ ‡æ³¨äº† `@Around("@annotation(metricTime)")`ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼Œç¬¦åˆæ¡ä»¶çš„ç›®æ ‡æ–¹æ³•æ˜¯å¸¦æœ‰ `@MetricTime` æ³¨è§£çš„æ–¹æ³•ï¼Œå› ä¸º `metric()` æ–¹æ³•å‚æ•°ç±»å‹æ˜¯ `MetricTime`ï¼ˆæ³¨æ„å‚æ•°åæ˜¯ `metricTime` ä¸æ˜¯ `MetricTime`ï¼‰ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒè·å–æ€§èƒ½ç›‘æ§çš„åç§°ã€‚

æœ‰äº† `@MetricTime` æ³¨è§£ï¼Œå†é…åˆ `MetricAspect`ï¼Œä»»ä½• Beanï¼Œåªè¦æ–¹æ³•æ ‡æ³¨äº† `@MetricTime` æ³¨è§£ï¼Œå°±å¯ä»¥è‡ªåŠ¨å®ç°æ€§èƒ½ç›‘æ§ã€‚è¿è¡Œä»£ç ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```bash
Welcome, Bob!
[Metrics] register: 16ms
```

### ç»ƒä¹ 

ä½¿ç”¨æ³¨è§£ + AOP å®ç°æ€§èƒ½ç›‘æ§

### å°ç»“

ä½¿ç”¨æ³¨è§£å®ç° AOP éœ€è¦å…ˆå®šä¹‰æ³¨è§£ï¼Œç„¶åä½¿ç”¨ `@Around("@annotation(name)")` å®ç°è£…é…ï¼›

ä½¿ç”¨æ³¨è§£æ—¢ç®€å•ï¼Œåˆèƒ½æ˜ç¡®æ ‡è¯† AOP è£…é…ï¼Œæ˜¯ä½¿ç”¨ AOP æ¨èçš„æ–¹å¼ã€‚



## ğŸ€ AOP é¿å‘æŒ‡å—


æ— è®ºæ˜¯ä½¿ç”¨ AspectJ è¯­æ³•ï¼Œè¿˜æ˜¯é…åˆ Annotationï¼Œä½¿ç”¨ AOPï¼Œå®é™…ä¸Šå°±æ˜¯è®© Spring è‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Proxyï¼Œä½¿å¾—è°ƒç”¨æ–¹èƒ½æ— æ„ŸçŸ¥åœ°è°ƒç”¨æŒ‡å®šæ–¹æ³•ï¼Œä½†è¿è¡ŒæœŸå´åŠ¨æ€ â€œç»‡å…¥â€ äº†å…¶ä»–é€»è¾‘ï¼Œå› æ­¤ï¼ŒAOP æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª[ä»£ç†æ¨¡å¼](https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017)ã€‚

å› ä¸º Spring ä½¿ç”¨äº† CGLIB æ¥å®ç°è¿è¡ŒæœŸåŠ¨æ€åˆ›å»º Proxyï¼Œå¦‚æœæˆ‘ä»¬æ²¡èƒ½æ·±å…¥ç†è§£å…¶è¿è¡ŒåŸç†å’Œå®ç°æœºåˆ¶ï¼Œå°±ææœ‰å¯èƒ½é‡åˆ°å„ç§è¯¡å¼‚çš„é—®é¢˜ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ã€‚

å‡è®¾æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `UserService` çš„ Beanï¼š

```java
@Component
public class UserService {
    // æˆå‘˜å˜é‡:
    public final ZoneId zoneId = ZoneId.systemDefault();

    // æ„é€ æ–¹æ³•:
    public UserService() {
        System.out.println("UserService(): init...");
        System.out.println("UserService(): zoneId =" + this.zoneId);
    }

    // public æ–¹æ³•:
    public ZoneId getZoneId() {
        return zoneId;
    }

    // public final æ–¹æ³•:
    public final ZoneId getFinalZoneId() {
        return zoneId;
    }
}
```

å†å†™ä¸ª `MailService`ï¼Œå¹¶æ³¨å…¥ `UserService`ï¼š

```java
@Component
public class MailService {
    @Autowired
    UserService userService;

    public String sendMail() {
        ZoneId zoneId = userService.zoneId;
        String dt = ZonedDateTime.now(zoneId).toString();
        return "Hello, it is" + dt;
    }
}
```

æœ€åç”¨ `main()` æ–¹æ³•æµ‹è¯•ä¸€ä¸‹ï¼š

```java
@Configuration
@ComponentScan
public class AppConfig {
    public static void main(String[] args) {
        ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);
        MailService mailService = context.getBean(MailService.class);
        System.out.println(mailService.sendMail());
    }
}
```

æŸ¥çœ‹è¾“å‡ºï¼Œä¸€åˆ‡æ­£å¸¸ï¼š

```
UserService(): init...
UserService(): zoneId = Asia/Shanghai
Hello, it is 2020-04-12T10:23:22.917721+08:00[Asia/Shanghai]
```

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬ç»™ `UserService` åŠ ä¸Š AOP æ”¯æŒï¼Œå°±æ·»åŠ ä¸€ä¸ªæœ€ç®€å•çš„ `LoggingAspect`ï¼š

```java
@Aspect
@Component
public class LoggingAspect {
    @Before("execution(public * com..*.UserService.*(..))")
    public void doAccessCheck() {
        System.err.println("[Before] do access check...");
    }
}
```

åˆ«å¿˜äº†åœ¨ `AppConfig` ä¸ŠåŠ ä¸Š `@EnableAspectJAutoProxy`ã€‚å†æ¬¡è¿è¡Œï¼Œä¸å‡ºæ„å¤–çš„è¯ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª `NullPointerException`ï¼š

```bash
Exception in thread "main" java.lang.NullPointerException: zone
    at java.base/java.util.Objects.requireNonNull(Objects.java:246)
    at java.base/java.time.Clock.system(Clock.java:203)
    at java.base/java.time.ZonedDateTime.now(ZonedDateTime.java:216)
    at com.itranswarp.learnjava.service.MailService.sendMail(MailService.java:19)
    at com.itranswarp.learnjava.AppConfig.main(AppConfig.java:21)
```

ä»”ç»†è·Ÿè¸ªä»£ç ï¼Œä¼šå‘ç° `null` å€¼å‡ºç°åœ¨ `MailService.sendMail()` å†…éƒ¨çš„è¿™ä¸€è¡Œä»£ç ï¼š

```java
@Component
public class MailService {
    @Autowired
    UserService userService;

    public String sendMail() {
        ZoneId zoneId = userService.zoneId;
        System.out.println(zoneId); // null
        ...
    }
}
```

æˆ‘ä»¬è¿˜æ•…æ„åœ¨ `UserService` ä¸­ç‰¹æ„ç”¨ `final` ä¿®é¥°äº†ä¸€ä¸‹æˆå‘˜å˜é‡ï¼š

```java
@Component
public class UserService {
    public final ZoneId zoneId = ZoneId.systemDefault();
    ...
}
```

ç”¨ `final` æ ‡æ³¨çš„æˆå‘˜å˜é‡ä¸º `null`ï¼Ÿé€—æˆ‘å‘¢ï¼Ÿ

### æ€ä¹ˆè‚¥å››ï¼Ÿ

ä¸ºä»€ä¹ˆåŠ äº† AOP å°±æŠ¥ NPEï¼Œå»äº† AOP å°±ä¸€åˆ‡æ­£å¸¸ï¼Ÿ`final` å­—æ®µä¸æ‰§è¡Œï¼Œéš¾é“ JVM æœ‰é—®é¢˜ï¼Ÿä¸ºäº†è§£ç­”è¿™ä¸ªè¯¡å¼‚çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥ç†è§£ Spring ä½¿ç”¨ CGLIB ç”Ÿæˆ Proxy çš„åŸç†ï¼š

ç¬¬ä¸€æ­¥ï¼Œæ­£å¸¸åˆ›å»ºä¸€ä¸ª `UserService` çš„åŸå§‹å®ä¾‹ï¼Œè¿™æ˜¯é€šè¿‡åå°„è°ƒç”¨æ„é€ æ–¹æ³•å®ç°çš„ï¼Œå®ƒçš„è¡Œä¸ºå’Œæˆ‘ä»¬é¢„æœŸçš„å®Œå…¨ä¸€è‡´ï¼›

ç¬¬äºŒæ­¥ï¼Œé€šè¿‡ CGLIB åˆ›å»ºä¸€ä¸ª `UserService` çš„å­ç±»ï¼Œå¹¶å¼•ç”¨äº†åŸå§‹å®ä¾‹å’Œ `LoggingAspect`ï¼š

```java
public UserService$$EnhancerBySpringCGLIB extends UserService {
    UserService target;
    LoggingAspect aspect;

    public UserService$$EnhancerBySpringCGLIB() {
    }

    public ZoneId getZoneId() {
        aspect.doAccessCheck();
        return target.getZoneId();
    }
}
```

å¦‚æœæˆ‘ä»¬è§‚å¯Ÿ Spring åˆ›å»ºçš„ AOP ä»£ç†ï¼Œå®ƒçš„ç±»åæ€»æ˜¯ç±»ä¼¼ `UserService$$EnhancerBySpringCGLIB$$1c76af9d`ï¼ˆä½ æ²¡çœ‹é”™ï¼ŒJava çš„ç±»åå®é™…ä¸Šå…è®¸ `$` å­—ç¬¦ï¼‰ã€‚ä¸ºäº†è®©è°ƒç”¨æ–¹è·å¾— `UserService` çš„å¼•ç”¨ï¼Œå®ƒå¿…é¡»ç»§æ‰¿è‡ª `UserService`ã€‚ç„¶åï¼Œè¯¥ä»£ç†ç±»ä¼šè¦†å†™æ‰€æœ‰ `public` å’Œ `protected` æ–¹æ³•ï¼Œå¹¶åœ¨å†…éƒ¨å°†è°ƒç”¨å§”æ‰˜ç»™åŸå§‹çš„ `UserService` å®ä¾‹ã€‚

è¿™é‡Œå‡ºç°äº†ä¸¤ä¸ª `UserService` å®ä¾‹ï¼š

ä¸€ä¸ªæ˜¯æˆ‘ä»¬ä»£ç ä¸­å®šä¹‰çš„ *åŸå§‹å®ä¾‹*ï¼Œå®ƒçš„æˆå‘˜å˜é‡å·²ç»æŒ‰ç…§æˆ‘ä»¬é¢„æœŸçš„æ–¹å¼è¢«åˆå§‹åŒ–å®Œæˆï¼š

```java
UserService original = new UserService();
```

ç¬¬äºŒä¸ª `UserService` å®ä¾‹å®é™…ä¸Šç±»å‹æ˜¯ `UserService$$EnhancerBySpringCGLIB`ï¼Œå®ƒå¼•ç”¨äº†åŸå§‹çš„ `UserService` å®ä¾‹ï¼š

```java
UserService$$EnhancerBySpringCGLIB proxy = new UserService$$EnhancerBySpringCGLIB();
proxy.target = original;
proxy.aspect = ...
```

æ³¨æ„åˆ°è¿™ç§æƒ…å†µä»…å‡ºç°åœ¨å¯ç”¨äº† AOP çš„æƒ…å†µï¼Œæ­¤åˆ»ï¼Œä» `ApplicationContext` ä¸­è·å–çš„ `UserService` å®ä¾‹æ˜¯ proxyï¼Œæ³¨å…¥åˆ° `MailService` ä¸­çš„ `UserService` å®ä¾‹ä¹Ÿæ˜¯ proxyã€‚

é‚£ä¹ˆæœ€ç»ˆçš„é—®é¢˜æ¥äº†ï¼šproxy å®ä¾‹çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿå°±æ˜¯ä» `UserService` ç»§æ‰¿çš„ `zoneId`ï¼Œå®ƒçš„å€¼æ˜¯ `null`ã€‚

åŸå› åœ¨äºï¼Œ`UserService` æˆå‘˜å˜é‡çš„åˆå§‹åŒ–ï¼š

```java
public class UserService {
    public final ZoneId zoneId = ZoneId.systemDefault();
    ...
}
```

åœ¨ `UserService$$EnhancerBySpringCGLIB` ä¸­ï¼Œå¹¶æœªæ‰§è¡Œã€‚åŸå› æ˜¯ï¼Œæ²¡å¿…è¦åˆå§‹åŒ– proxy çš„æˆå‘˜å˜é‡ï¼Œå› ä¸º proxy çš„ç›®çš„æ˜¯ä»£ç†æ–¹æ³•ã€‚

å®é™…ä¸Šï¼Œæˆå‘˜å˜é‡çš„åˆå§‹åŒ–æ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­å®Œæˆçš„ã€‚è¿™æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ä»£ç ï¼š

```java
public class UserService {
    public final ZoneId zoneId = ZoneId.systemDefault();
    public UserService() {
    }
}
```

è¿™æ˜¯ç¼–è¯‘å™¨å®é™…ç¼–è¯‘çš„ä»£ç ï¼š

```java
public class UserService {
    public final ZoneId zoneId;
    public UserService() {
        super(); // æ„é€ æ–¹æ³•çš„ç¬¬ä¸€è¡Œä»£ç æ€»æ˜¯è°ƒç”¨ super()
        zoneId = ZoneId.systemDefault(); // ç»§ç»­åˆå§‹åŒ–æˆå‘˜å˜é‡
    }
}
```

ç„¶è€Œï¼Œå¯¹äº Spring é€šè¿‡ CGLIB åŠ¨æ€åˆ›å»ºçš„ `UserService$$EnhancerBySpringCGLIB` ä»£ç†ç±»ï¼Œå®ƒçš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¹¶æœªè°ƒç”¨ `super()`ï¼Œå› æ­¤ï¼Œä»çˆ¶ç±»ç»§æ‰¿çš„æˆå‘˜å˜é‡ï¼ŒåŒ…æ‹¬ `final` ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œç»Ÿç»Ÿéƒ½æ²¡æœ‰åˆå§‹åŒ–ã€‚

æœ‰çš„ç«¥é‹ä¼šé—®ï¼šJava è¯­è¨€è§„å®šï¼Œä»»ä½•ç±»çš„æ„é€ æ–¹æ³•ï¼Œç¬¬ä¸€è¡Œå¿…é¡»è°ƒç”¨ `super()`ï¼Œå¦‚æœæ²¡æœ‰ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åŠ ä¸Šï¼Œæ€ä¹ˆ Spring çš„ CGLIB å°±å¯ä»¥æç‰¹æ®Šï¼Ÿ

è¿™æ˜¯å› ä¸ºè‡ªåŠ¨åŠ  `super()` çš„åŠŸèƒ½æ˜¯ Java ç¼–è¯‘å™¨å®ç°çš„ï¼Œå®ƒå‘ç°ä½ æ²¡åŠ ï¼Œå°±è‡ªåŠ¨ç»™åŠ ä¸Šï¼Œå‘ç°ä½ åŠ é”™äº†ï¼Œå°±æŠ¥ç¼–è¯‘é”™è¯¯ã€‚ä½†å®é™…ä¸Šï¼Œå¦‚æœç›´æ¥æ„é€ å­—èŠ‚ç ï¼Œä¸€ä¸ªç±»çš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¸ä¸€å®šéè¦è°ƒç”¨ `super()`ã€‚Spring ä½¿ç”¨ CGLIB æ„é€ çš„ Proxy ç±»ï¼Œæ˜¯ç›´æ¥ç”Ÿæˆå­—èŠ‚ç ï¼Œå¹¶æ²¡æœ‰æºç  - ç¼–è¯‘ - å­—èŠ‚ç è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤ï¼š

> [!NOTE]
> Spring é€šè¿‡ CGLIB åˆ›å»ºçš„ä»£ç†ç±»ï¼Œä¸ä¼šåˆå§‹åŒ–ä»£ç†ç±»è‡ªèº«ç»§æ‰¿çš„ä»»ä½•æˆå‘˜å˜é‡ï¼ŒåŒ…æ‹¬ final ç±»å‹çš„æˆå‘˜å˜é‡ï¼

å†è€ƒå¯Ÿ `MailService` çš„ä»£ç ï¼š

```java
@Component
public class MailService {
    @Autowired
    UserService userService;

    public String sendMail() {
        ZoneId zoneId = userService.zoneId;
        System.out.println(zoneId); // null
        ...
    }
}
```

å¦‚æœæ²¡æœ‰å¯ç”¨ AOPï¼Œæ³¨å…¥çš„æ˜¯åŸå§‹çš„ `UserService` å®ä¾‹ï¼Œé‚£ä¹ˆä¸€åˆ‡æ­£å¸¸ï¼Œå› ä¸º `UserService` å®ä¾‹çš„ `zoneId` å­—æ®µå·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–äº†ã€‚

å¦‚æœå¯åŠ¨äº† AOPï¼Œæ³¨å…¥çš„æ˜¯ä»£ç†åçš„ `UserService$$EnhancerBySpringCGLIB` å®ä¾‹ï¼Œé‚£ä¹ˆé—®é¢˜å¤§äº†ï¼šè·å–çš„ `UserService$$EnhancerBySpringCGLIB` å®ä¾‹çš„ `zoneId` å­—æ®µï¼Œæ°¸è¿œä¸º `null`ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šå¯ç”¨äº† AOPï¼Œå¦‚ä½•ä¿®å¤ï¼Ÿ

ä¿®å¤å¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠç›´æ¥è®¿é—®å­—æ®µçš„ä»£ç ï¼Œæ”¹ä¸ºé€šè¿‡æ–¹æ³•è®¿é—®ï¼š

```java
@Component
public class MailService {
    @Autowired
    UserService userService;

    public String sendMail() {
        // ä¸è¦ç›´æ¥è®¿é—® UserService çš„å­—æ®µ:
        ZoneId zoneId = userService.getZoneId();
        ...
    }
}
```

æ— è®ºæ³¨å…¥çš„ `UserService` æ˜¯åŸå§‹å®ä¾‹è¿˜æ˜¯ä»£ç†å®ä¾‹ï¼Œ`getZoneId()` éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œå› ä¸ºä»£ç†ç±»ä¼šè¦†å†™ `getZoneId()` æ–¹æ³•ï¼Œå¹¶å°†å…¶å§”æ‰˜ç»™åŸå§‹å®ä¾‹ï¼š

```java
public UserService$$EnhancerBySpringCGLIB extends UserService {
    UserService target = ...
    ...

    public ZoneId getZoneId() {
        return target.getZoneId();
    }
}
```

æ³¨æ„åˆ°æˆ‘ä»¬è¿˜ç»™ `UserService` æ·»åŠ äº†ä¸€ä¸ª `public`+`final` çš„æ–¹æ³•ï¼š

```java
@Component
public class UserService {
    ...
    public final ZoneId getFinalZoneId() {
        return zoneId;
    }
}
```

å¦‚æœåœ¨ `MailService` ä¸­ï¼Œè°ƒç”¨çš„ä¸æ˜¯ `getZoneId()`ï¼Œè€Œæ˜¯ `getFinalZoneId()`ï¼Œåˆä¼šå‡ºç° `NullPointerException`ï¼Œè¿™æ˜¯å› ä¸ºï¼Œä»£ç†ç±»æ— æ³•è¦†å†™ `final` æ–¹æ³•ï¼ˆè¿™ä¸€ç‚¹ç»•ä¸è¿‡ JVM çš„ ClassLoader æ£€æŸ¥ï¼‰ï¼Œè¯¥æ–¹æ³•è¿”å›çš„æ˜¯ä»£ç†ç±»çš„ `zoneId` å­—æ®µï¼Œå³ `null`ã€‚

å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬åŠ ä¸Šæ—¥å¿—ï¼ŒSpring åœ¨å¯åŠ¨æ—¶ä¼šæ‰“å°ä¸€ä¸ªè­¦å‘Šï¼š

```bash
10:43:09.929 [main] DEBUG org.springframework.aop.framework.CglibAopProxy - Final method [public final java.time.ZoneId xxx.UserService.getFinalZoneId()] cannot get proxied via CGLIB: Calls to this method will NOT be routed to the target instance and might lead to NPEs against uninitialized fields in the proxy instance.
```

ä¸Šé¢çš„æ—¥å¿—å¤§æ„å°±æ˜¯ï¼Œå› ä¸ºè¢«ä»£ç†çš„ `UserService` æœ‰ä¸€ä¸ª `final` æ–¹æ³• `getFinalZoneId()`ï¼Œè¿™ä¼šå¯¼è‡´å…¶ä»– Bean å¦‚æœè°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ— æ³•å°†å…¶ä»£ç†åˆ°çœŸæ­£çš„åŸå§‹å®ä¾‹ï¼Œä»è€Œå¯èƒ½å‘ç”Ÿ NPE å¼‚å¸¸ã€‚

å› æ­¤ï¼Œæ­£ç¡®ä½¿ç”¨ AOPï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé¿å‘æŒ‡å—ï¼š

1. è®¿é—®è¢«æ³¨å…¥çš„ Bean æ—¶ï¼Œæ€»æ˜¯è°ƒç”¨æ–¹æ³•è€Œéç›´æ¥è®¿é—®å­—æ®µï¼›
2. ç¼–å†™ Bean æ—¶ï¼Œå¦‚æœå¯èƒ½ä¼šè¢«ä»£ç†ï¼Œå°±ä¸è¦ç¼–å†™ `public final` æ–¹æ³•ã€‚

è¿™æ ·æ‰èƒ½ä¿è¯æœ‰æ²¡æœ‰ AOPï¼Œä»£ç éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚

### æ€è€ƒ

ä¸ºä»€ä¹ˆ Spring åˆ»æ„ä¸åˆå§‹åŒ– Proxy ç»§æ‰¿çš„å­—æ®µï¼Ÿ

å¦‚æœä¸€ä¸ª Bean ä¸å…è®¸ä»»ä½• AOP ä»£ç†ï¼Œåº”è¯¥æ€ä¹ˆåšæ¥ â€œä¿æŠ¤â€ è‡ªå·±åœ¨è¿è¡ŒæœŸä¸ä¼šè¢«ä»£ç†ï¼Ÿ

### ç»ƒä¹ 

ä¿®å¤å¯ç”¨ AOP å¯¼è‡´çš„ NPE

### å°ç»“

ç”±äº Spring é€šè¿‡ CGLIB å®ç°ä»£ç†ç±»ï¼Œæˆ‘ä»¬è¦é¿å…ç›´æ¥è®¿é—® Bean çš„å­—æ®µï¼Œä»¥åŠç”± `final` æ–¹æ³•å¸¦æ¥çš„ â€œæœªä»£ç†â€ é—®é¢˜ã€‚

é‡åˆ° CglibAopProxy çš„ç›¸å…³æ—¥å¿—ï¼ŒåŠ¡å¿…è¦ä»”ç»†æ£€æŸ¥ï¼Œé˜²æ­¢å› ä¸º AOP å‡ºç° NPE å¼‚å¸¸ã€‚

