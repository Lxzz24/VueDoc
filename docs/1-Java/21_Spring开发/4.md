---
title: å¼€å‘ Web åº”ç”¨
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::


åœ¨ [Web å¼€å‘](docs/1-Java/20_Webå¼€å‘/README.md) ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯¦ç»†ä»‹ç»äº† JavaEE ä¸­ Web å¼€å‘çš„åŸºç¡€ï¼šServletã€‚å…·ä½“åœ°è¯´ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

1. Servlet è§„èŒƒå®šä¹‰äº†å‡ ç§æ ‡å‡†ç»„ä»¶ï¼šServletã€JSPã€Filter å’Œ Listenerï¼›
2. Servlet çš„æ ‡å‡†ç»„ä»¶æ€»æ˜¯è¿è¡Œåœ¨ Servlet å®¹å™¨ä¸­ï¼Œå¦‚ Tomcatã€Jettyã€WebLogic ç­‰ã€‚

ç›´æ¥ä½¿ç”¨ Servlet è¿›è¡Œ Web å¼€å‘å¥½æ¯”ç›´æ¥åœ¨ JDBC ä¸Šæ“ä½œæ•°æ®åº“ï¼Œæ¯”è¾ƒç¹çï¼Œæ›´å¥½çš„æ–¹æ³•æ˜¯åœ¨ Servlet åŸºç¡€ä¸Šå°è£… MVC æ¡†æ¶ï¼ŒåŸºäº MVC å¼€å‘ Web åº”ç”¨ï¼Œå¤§éƒ¨åˆ†æ—¶å€™ï¼Œä¸éœ€è¦æ¥è§¦ Servlet APIï¼Œå¼€å‘çœæ—¶çœåŠ›ã€‚

æˆ‘ä»¬åœ¨ [MVC å¼€å‘](https://www.liaoxuefeng.com/wiki/1252599548343744/1266264917931808) å’Œ[MVC é«˜çº§å¼€å‘](https://www.liaoxuefeng.com/wiki/1252599548343744/1337408645759009)å·²ç»ç”±æµ…å…¥æ·±åœ°ä»‹ç»äº†å¦‚ä½•ç¼–å†™ MVC æ¡†æ¶ã€‚å½“ç„¶ï¼Œè‡ªå·±å†™çš„ MVC ä¸»è¦æ˜¯ç†è§£åŸç†ï¼Œè¦å®ç°ä¸€ä¸ªåŠŸèƒ½å…¨é¢çš„ MVC éœ€è¦å¤§é‡çš„å·¥ä½œä»¥åŠå¹¿æ³›çš„æµ‹è¯•ã€‚

å› æ­¤ï¼Œå¼€å‘ Web åº”ç”¨ï¼Œé¦–å…ˆè¦é€‰æ‹©ä¸€ä¸ªä¼˜ç§€çš„ MVC æ¡†æ¶ã€‚å¸¸ç”¨çš„ MVC æ¡†æ¶æœ‰ï¼š

- [Struts](https://struts.apache.org/)ï¼šæœ€å¤è€çš„ä¸€ä¸ª MVC æ¡†æ¶ï¼Œç›®å‰ç‰ˆæœ¬æ˜¯ 2ï¼Œå’Œ 1.x æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼›
- WebWorkï¼šä¸€ä¸ªæ¯” Struts è®¾è®¡æ›´ä¼˜ç§€çš„ MVC æ¡†æ¶ï¼Œä½†ä¸çŸ¥é“å‡ºäºä»€ä¹ˆåŸå› ï¼Œä» 2.0 å¼€å§‹æŠŠè‡ªå·±çš„ä»£ç å…¨éƒ¨å¡ç»™ Struts 2 äº†ï¼›
- [Turbine](https://turbine.apache.org/)ï¼šä¸€ä¸ªé‡åº¦ä½¿ç”¨ Velocityï¼Œå¼ºè°ƒå¸ƒå±€çš„ MVC æ¡†æ¶ï¼›
- å…¶ä»– 100+MVC æ¡†æ¶â€¦â€¦ï¼ˆç•¥ï¼‰

Spring è™½ç„¶éƒ½å¯ä»¥é›†æˆä»»ä½• Web æ¡†æ¶ï¼Œä½†æ˜¯ï¼ŒSpring æœ¬èº«ä¹Ÿå¼€å‘äº†ä¸€ä¸ª MVC æ¡†æ¶ï¼Œå°±å« [Spring MVC](https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html)ã€‚è¿™ä¸ª MVC æ¡†æ¶è®¾è®¡å¾—è¶³å¤Ÿä¼˜ç§€ä»¥è‡³äºæˆ‘ä»¬å·²ç»ä¸æƒ³å†è´¹åŠ²å»é›†æˆç±»ä¼¼ Struts è¿™æ ·çš„æ¡†æ¶äº†ã€‚

æœ¬ç« æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»å¦‚ä½•åŸºäº Spring MVC å¼€å‘ Web åº”ç”¨ã€‚



## ğŸ€ ä½¿ç”¨ Spring MVC


æˆ‘ä»¬åœ¨å‰é¢ä»‹ç» [Web å¼€å‘](https://www.liaoxuefeng.com/wiki/1252599548343744/1255945497738400) æ—¶å·²ç»è®²è¿‡äº† Java Web çš„åŸºç¡€ï¼šServlet å®¹å™¨ï¼Œä»¥åŠæ ‡å‡†çš„ Servlet ç»„ä»¶ï¼š

- Servletï¼šèƒ½å¤„ç† HTTP è¯·æ±‚å¹¶å°† HTTP å“åº”è¿”å›ï¼›
- JSPï¼šä¸€ç§åµŒå¥— Java ä»£ç çš„ HTMLï¼Œå°†è¢«ç¼–è¯‘ä¸º Servletï¼›
- Filterï¼šèƒ½è¿‡æ»¤æŒ‡å®šçš„ URL ä»¥å®ç°æ‹¦æˆªåŠŸèƒ½ï¼›
- Listenerï¼šç›‘å¬æŒ‡å®šçš„äº‹ä»¶ï¼Œå¦‚ ServletContextã€HttpSession çš„åˆ›å»ºå’Œé”€æ¯ã€‚

æ­¤å¤–ï¼ŒServlet å®¹å™¨ä¸ºæ¯ä¸ª Web åº”ç”¨ç¨‹åºè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ `ServletContext` å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹å°±ä»£è¡¨äº† Web åº”ç”¨ç¨‹åºæœ¬èº«ã€‚

åœ¨ [MVC é«˜çº§å¼€å‘](https://www.liaoxuefeng.com/wiki/1252599548343744/1337408645759009) ä¸­ï¼Œæˆ‘ä»¬æ‰‹æ’¸äº†ä¸€ä¸ª MVC æ¡†æ¶ï¼Œæ¥å£å’Œ Spring MVC ç±»ä¼¼ã€‚å¦‚æœç›´æ¥ä½¿ç”¨ Spring MVCï¼Œæˆ‘ä»¬å†™å‡ºæ¥çš„ä»£ç ç±»ä¼¼ï¼š

```java
@Controller
public class UserController {
    @GetMapping("/register")
    public ModelAndView register() {
        ...
    }

    @PostMapping("/signin")
    public ModelAndView signin(@RequestParam("email") String email, @RequestParam("password") String password) {
        ...
    }
    ...
}
```

ä½†æ˜¯ï¼ŒSpring æä¾›çš„æ˜¯ä¸€ä¸ª IoC å®¹å™¨ï¼Œæ‰€æœ‰çš„ Beanï¼ŒåŒ…æ‹¬ Controllerï¼Œéƒ½åœ¨ Spring IoC å®¹å™¨ä¸­è¢«åˆå§‹åŒ–ï¼Œè€Œ Servlet å®¹å™¨ç”± JavaEE æœåŠ¡å™¨æä¾›ï¼ˆå¦‚ Tomcatï¼‰ï¼ŒServlet å®¹å™¨å¯¹ Spring ä¸€æ— æ‰€çŸ¥ï¼Œä»–ä»¬ä¹‹é—´åˆ°åº•ä¾é ä»€ä¹ˆè¿›è¡Œè”ç³»ï¼Œåˆæ˜¯ä»¥ä½•ç§é¡ºåºåˆå§‹åŒ–çš„ï¼Ÿ

åœ¨ç†è§£ä¸Šè¿°é—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŠŠåŸºäº Spring MVC å¼€å‘çš„é¡¹ç›®ç»“æ„æ­å»ºèµ·æ¥ã€‚é¦–å…ˆåˆ›å»ºåŸºäº Web çš„ Maven å·¥ç¨‹ï¼Œå¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š

- org.springframework:spring-context:6.0.0
- org.springframework:spring-webmvc:6.0.0
- org.springframework:spring-jdbc:6.0.0
- jakarta.annotation:jakarta.annotation-api:2.1.1
- io.pebbletemplates:pebble-spring6:3.2.0
- ch.qos.logback:logback-core:1.4.4
- ch.qos.logback:logback-classic:1.4.4
- com.zaxxer:HikariCP:5.0.1
- org.hsqldb:hsqldb:2.7.0

ä»¥åŠ `provided` ä¾èµ–ï¼š

- org.apache.tomcat.embed:tomcat-embed-core:10.1.1
- org.apache.tomcat.embed:tomcat-embed-jasper:10.1.1

è¿™ä¸ªæ ‡å‡†çš„ Maven Web å·¥ç¨‹ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```ascii
spring-web-mvc
â”œâ”€â”€ pom.xml
â””â”€â”€ src
    â””â”€â”€ main
        â”œâ”€â”€ java
        â”‚   â””â”€â”€ com
        â”‚       â””â”€â”€ itranswarp
        â”‚           â””â”€â”€ learnjava
        â”‚               â”œâ”€â”€ AppConfig.java
        â”‚               â”œâ”€â”€ DatabaseInitializer.java
        â”‚               â”œâ”€â”€ entity
        â”‚               â”‚   â””â”€â”€ User.java
        â”‚               â”œâ”€â”€ service
        â”‚               â”‚   â””â”€â”€ UserService.java
        â”‚               â””â”€â”€ web
        â”‚                   â””â”€â”€ UserController.java
        â”œâ”€â”€ resources
        â”‚   â”œâ”€â”€ jdbc.properties
        â”‚   â””â”€â”€ logback.xml
        â””â”€â”€ webapp
            â”œâ”€â”€ WEB-INF
            â”‚   â”œâ”€â”€ templates
            â”‚   â”‚   â”œâ”€â”€ _base.html
            â”‚   â”‚   â”œâ”€â”€ index.html
            â”‚   â”‚   â”œâ”€â”€ profile.html
            â”‚   â”‚   â”œâ”€â”€ register.html
            â”‚   â”‚   â””â”€â”€ signin.html
            â”‚   â””â”€â”€ web.xml
            â””â”€â”€ static
                â”œâ”€â”€ css
                â”‚   â””â”€â”€ bootstrap.css
                â””â”€â”€ js
                    â””â”€â”€ jquery.js
```

å…¶ä¸­ï¼Œ`src/main/webapp` æ˜¯æ ‡å‡† web ç›®å½•ï¼Œ`WEB-INF` å­˜æ”¾ `web.xml`ï¼Œç¼–è¯‘çš„ classï¼Œç¬¬ä¸‰æ–¹ jarï¼Œä»¥åŠä¸å…è®¸æµè§ˆå™¨ç›´æ¥è®¿é—®çš„ View æ¨¡ç‰ˆï¼Œ`static` ç›®å½•å­˜æ”¾æ‰€æœ‰é™æ€æ–‡ä»¶ã€‚

åœ¨ `src/main/resources` ç›®å½•ä¸­å­˜æ”¾çš„æ˜¯ Java ç¨‹åºè¯»å–çš„ classpath èµ„æºæ–‡ä»¶ï¼Œé™¤äº† JDBC çš„é…ç½®æ–‡ä»¶ `jdbc.properties` å¤–ï¼Œæˆ‘ä»¬åˆæ–°å¢äº†ä¸€ä¸ª `logback.xml`ï¼Œè¿™æ˜¯ Logback çš„é»˜è®¤æŸ¥æ‰¾çš„é…ç½®æ–‡ä»¶ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
	<appender name="STDOUT"
		class="ch.qos.logback.core.ConsoleAppender">
		<layout class="ch.qos.logback.classic.PatternLayout">
			<Pattern>%d{yyyy-MM-dd HH:mm:ss} %-5level %logger{36} - %msg%n</Pattern>
		</layout>
	</appender>

	<logger name="com.itranswarp.learnjava" level="info" additivity="false">
		<appender-ref ref="STDOUT" />
	</logger>

	<root level="info">
		<appender-ref ref="STDOUT" />
	</root>
</configuration>
```

ä¸Šé¢ç»™å‡ºäº†ä¸€ä¸ªå†™å…¥åˆ°æ ‡å‡†è¾“å‡ºçš„ Logback é…ç½®ï¼Œå¯ä»¥åŸºäºä¸Šè¿°é…ç½®æ·»åŠ å†™å…¥åˆ°æ–‡ä»¶çš„é…ç½®ã€‚

åœ¨ `src/main/java` ä¸­å°±æ˜¯æˆ‘ä»¬ç¼–å†™çš„ Java ä»£ç äº†ã€‚

### é…ç½® Spring MVC

å’Œæ™®é€š Spring é…ç½®ä¸€æ ·ï¼Œæˆ‘ä»¬ç¼–å†™æ­£å¸¸çš„ `AppConfig` åï¼Œåªéœ€åŠ ä¸Š `@EnableWebMvc` æ³¨è§£ï¼Œå°± â€œæ¿€æ´»â€ äº† Spring MVCï¼š

```java
@Configuration
@ComponentScan
@EnableWebMvc // å¯ç”¨ Spring MVC
@EnableTransactionManagement
@PropertySource("classpath:/jdbc.properties")
public class AppConfig {
    ...
}
```

é™¤äº†åˆ›å»º `DataSource`ã€`JdbcTemplate`ã€`PlatformTransactionManager` å¤–ï¼Œ`AppConfig` éœ€è¦é¢å¤–åˆ›å»ºå‡ ä¸ªç”¨äº Spring MVC çš„ Beanï¼š

```java
@Bean
WebMvcConfigurer createWebMvcConfigurer() {
    return new WebMvcConfigurer() {
        @Override
        public void addResourceHandlers(ResourceHandlerRegistry registry) {
            registry.addResourceHandler("/static/**").addResourceLocations("/static/");
        }
    };
}
```

`WebMvcConfigurer` å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æˆ‘ä»¬åœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ `WebMvcConfigurer`ï¼Œåªè¦†å†™ `addResourceHandlers()`ï¼Œç›®çš„æ˜¯è®© Spring MVC è‡ªåŠ¨å¤„ç†é™æ€æ–‡ä»¶ï¼Œå¹¶ä¸”æ˜ å°„è·¯å¾„ä¸º `/static/**`ã€‚

å¦ä¸€ä¸ªå¿…é¡»è¦åˆ›å»ºçš„ Bean æ˜¯ `ViewResolver`ï¼Œå› ä¸º Spring MVC å…è®¸é›†æˆä»»ä½•æ¨¡æ¿å¼•æ“ï¼Œä½¿ç”¨å“ªä¸ªæ¨¡æ¿å¼•æ“ï¼Œå°±å®ä¾‹åŒ–ä¸€ä¸ªå¯¹åº”çš„ `ViewResolver`ï¼š

```java
@Bean
ViewResolver createViewResolver(@Autowired ServletContext servletContext) {
    var engine = new PebbleEngine.Builder().autoEscaping(true)
            // cache:
            .cacheActive(false)
            // loader:
            .loader(new Servlet5Loader(servletContext))
            .build();
    var viewResolver = new PebbleViewResolver(engine);
    viewResolver.setPrefix("/WEB-INF/templates/");
    viewResolver.setSuffix("");
    return viewResolver;
}
```

`ViewResolver` é€šè¿‡æŒ‡å®š `prefix` å’Œ `suffix` æ¥ç¡®å®šå¦‚ä½•æŸ¥æ‰¾ Viewã€‚ä¸Šè¿°é…ç½®ä½¿ç”¨ Pebble å¼•æ“ï¼ŒæŒ‡å®šæ¨¡æ¿æ–‡ä»¶å­˜æ”¾åœ¨ `/WEB-INF/templates/` ç›®å½•ä¸‹ã€‚

å‰©ä¸‹çš„ Bean éƒ½æ˜¯æ™®é€šçš„ `@Component`ï¼Œä½† Controller å¿…é¡»æ ‡è®°ä¸º `@Controller`ï¼Œä¾‹å¦‚ï¼š

```java
// Controller ä½¿ç”¨ @Controller æ ‡è®°è€Œä¸æ˜¯ @Component:
@Controller
public class UserController {
    // æ­£å¸¸ä½¿ç”¨ @Autowired æ³¨å…¥:
    @Autowired
    UserService userService;

    // å¤„ç†ä¸€ä¸ª URL æ˜ å°„:
    @GetMapping("/")
    public ModelAndView index() {
        ...
    }
    ...
}
```

å¦‚æœæ˜¯æ™®é€šçš„ Java åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬é€šè¿‡ `main()` æ–¹æ³•å¯ä»¥å¾ˆç®€å•åœ°åˆ›å»ºä¸€ä¸ª Spring å®¹å™¨çš„å®ä¾‹ï¼š

```java
public static void main(String[] args) {
    var context = new AnnotationConfigApplicationContext(AppConfig.class);
}
```

ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œç°åœ¨æ˜¯ Web åº”ç”¨ç¨‹åºï¼Œè€Œ Web åº”ç”¨ç¨‹åºæ€»æ˜¯ç”± Servlet å®¹å™¨åˆ›å»ºï¼Œé‚£ä¹ˆï¼ŒSpring å®¹å™¨åº”è¯¥ç”±è°åˆ›å»ºï¼Ÿåœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼ŸSpring å®¹å™¨ä¸­çš„ Controller åˆæ˜¯å¦‚ä½•é€šè¿‡ Servlet è°ƒç”¨çš„ï¼Ÿ

åœ¨ Web åº”ç”¨ä¸­å¯åŠ¨ Spring å®¹å™¨æœ‰å¾ˆå¤šç§æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡ Listener å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Servlet å¯åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ XML é…ç½®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£é…ç½®ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬åªä»‹ç»ä¸€ç§ * æœ€ç®€å• * çš„å¯åŠ¨ Spring å®¹å™¨çš„æ–¹å¼ã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨ `web.xml` ä¸­é…ç½® Spring MVC æä¾›çš„ `DispatcherServlet`ï¼š

```xml
<?xml version="1.0"?>
<web-app>
    <servlet>
        <servlet-name>dispatcher</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <init-param>
            <param-name>contextClass</param-name>
            <param-value>org.springframework.web.context.support.AnnotationConfigWebApplicationContext</param-value>
        </init-param>
        <init-param>
            <param-name>contextConfigLocation</param-name>
            <param-value>com.itranswarp.learnjava.AppConfig</param-value>
        </init-param>
        <load-on-startup>0</load-on-startup>
    </servlet>

    <servlet-mapping>
        <servlet-name>dispatcher</servlet-name>
        <url-pattern>/*</url-pattern>
    </servlet-mapping>
</web-app>
```

åˆå§‹åŒ–å‚æ•° `contextClass` æŒ‡å®šä½¿ç”¨æ³¨è§£é…ç½®çš„ `AnnotationConfigWebApplicationContext`ï¼Œé…ç½®æ–‡ä»¶çš„ä½ç½®å‚æ•° `contextConfigLocation` æŒ‡å‘ `AppConfig` çš„å®Œæ•´ç±»åï¼Œæœ€åï¼ŒæŠŠè¿™ä¸ª Servlet æ˜ å°„åˆ° `/*`ï¼Œå³å¤„ç†æ‰€æœ‰ URLã€‚

ä¸Šè¿°é…ç½®å¯ä»¥çœ‹ä½œä¸€ä¸ªæ ·æ¿é…ç½®ï¼Œæœ‰äº†è¿™ä¸ªé…ç½®ï¼ŒServlet å®¹å™¨ä¼šé¦–å…ˆåˆå§‹åŒ– Spring MVC çš„ `DispatcherServlet`ï¼Œåœ¨ `DispatcherServlet` å¯åŠ¨æ—¶ï¼Œå®ƒæ ¹æ®é…ç½® `AppConfig` åˆ›å»ºäº†ä¸€ä¸ªç±»å‹æ˜¯ `WebApplicationContext` çš„ IoC å®¹å™¨ï¼Œå®Œæˆæ‰€æœ‰ Bean çš„åˆå§‹åŒ–ï¼Œå¹¶å°†å®¹å™¨ç»‘åˆ° `ServletContext` ä¸Šã€‚

å› ä¸º `DispatcherServlet` æŒæœ‰ IoC å®¹å™¨ï¼Œèƒ½ä» IoC å®¹å™¨ä¸­è·å–æ‰€æœ‰ `@Controller` çš„ Beanï¼Œå› æ­¤ï¼Œ`DispatcherServlet` æ¥æ”¶åˆ°æ‰€æœ‰ HTTP è¯·æ±‚åï¼Œæ ¹æ® Controller æ–¹æ³•é…ç½®çš„è·¯å¾„ï¼Œå°±å¯ä»¥æ­£ç¡®åœ°æŠŠè¯·æ±‚è½¬å‘åˆ°æŒ‡å®šæ–¹æ³•ï¼Œå¹¶æ ¹æ®è¿”å›çš„ `ModelAndView` å†³å®šå¦‚ä½•æ¸²æŸ“é¡µé¢ã€‚

æœ€åï¼Œæˆ‘ä»¬åœ¨ `AppConfig` ä¸­é€šè¿‡ `main()` æ–¹æ³•å¯åŠ¨åµŒå…¥å¼ Tomcatï¼š

```java
public static void main(String[] args) throws Exception {
    Tomcat tomcat = new Tomcat();
    tomcat.setPort(Integer.getInteger("port", 8080));
    tomcat.getConnector();
    Context ctx = tomcat.addWebapp("", new File("src/main/webapp").getAbsolutePath());
    WebResourceRoot resources = new StandardRoot(ctx);
    resources.addPreResources(
            new DirResourceSet(resources, "/WEB-INF/classes", new File("target/classes").getAbsolutePath(), "/"));
    ctx.setResources(resources);
    tomcat.start();
    tomcat.getServer().await();
}
```

ä¸Šè¿° Web åº”ç”¨ç¨‹åºå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨ Spring MVC æ—¶çš„ä¸€ä¸ªæœ€å°å¯åŠ¨åŠŸèƒ½é›†ã€‚ç”±äºä½¿ç”¨äº† JDBC å’Œæ•°æ®åº“ï¼Œç”¨æˆ·çš„æ³¨å†Œã€ç™»å½•ä¿¡æ¯ä¼šè¢«æŒä¹…åŒ–ï¼š

![spring-mvc](./assets/l-20231221154251203.png)

### ç¼–å†™ Controller

æœ‰äº† Web åº”ç”¨ç¨‹åºçš„æœ€åŸºæœ¬çš„ç»“æ„ï¼Œæˆ‘ä»¬çš„é‡ç‚¹å°±å¯ä»¥æ”¾åœ¨å¦‚ä½•ç¼–å†™ Controller ä¸Šã€‚Spring MVC å¯¹ Controller æ²¡æœ‰å›ºå®šçš„è¦æ±‚ï¼Œä¹Ÿä¸éœ€è¦å®ç°ç‰¹å®šçš„æ¥å£ã€‚ä»¥ `UserController` ä¸ºä¾‹ï¼Œç¼–å†™ Controller åªéœ€è¦éµå¾ªä»¥ä¸‹è¦ç‚¹ï¼š

æ€»æ˜¯æ ‡è®° `@Controller` è€Œä¸æ˜¯ `@Component`ï¼š

```java
@Controller
public class UserController {
    ...
}
```

ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€ä¸ª HTTP è¯·æ±‚è·¯å¾„ï¼Œç”¨ `@GetMapping` æˆ– `@PostMapping` è¡¨ç¤º GET æˆ– POST è¯·æ±‚ï¼š

```java
@PostMapping("/signin")
public ModelAndView doSignin(
        @RequestParam("email") String email,
        @RequestParam("password") String password,
        HttpSession session) {
    ...
}
```

éœ€è¦æ¥æ”¶çš„ HTTP å‚æ•°ä»¥ `@RequestParam()` æ ‡æ³¨ï¼Œå¯ä»¥è®¾ç½®é»˜è®¤å€¼ã€‚å¦‚æœæ–¹æ³•å‚æ•°éœ€è¦ä¼ å…¥ `HttpServletRequest`ã€`HttpServletResponse` æˆ–è€… `HttpSession`ï¼Œç›´æ¥æ·»åŠ è¿™ä¸ªç±»å‹çš„å‚æ•°å³å¯ï¼ŒSpring MVC ä¼šè‡ªåŠ¨æŒ‰ç±»å‹ä¼ å…¥ã€‚

è¿”å›çš„ ModelAndView é€šå¸¸åŒ…å« View çš„è·¯å¾„å’Œä¸€ä¸ª Map ä½œä¸º Modelï¼Œä½†ä¹Ÿå¯ä»¥æ²¡æœ‰ Modelï¼Œä¾‹å¦‚ï¼š

```java
return new ModelAndView("signin.html"); // ä»… Viewï¼Œæ²¡æœ‰ Model
```

è¿”å›é‡å®šå‘æ—¶æ—¢å¯ä»¥å†™ `new ModelAndView("redirect:/signin")`ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿”å› Stringï¼š

```java
public String index() {
    if (...) {
        return "redirect:/signin";
    } else {
        return "redirect:/profile";
    }
}
```

å¦‚æœåœ¨æ–¹æ³•å†…éƒ¨ç›´æ¥æ“ä½œ `HttpServletResponse` å‘é€å“åº”ï¼Œè¿”å› `null` è¡¨ç¤ºæ— éœ€è¿›ä¸€æ­¥å¤„ç†ï¼š

```java
public ModelAndView download(HttpServletResponse response) {
    byte[] data = ...
    response.setContentType("application/octet-stream");
    OutputStream output = response.getOutputStream();
    output.write(data);
    output.flush();
    return null;
}
```

å¯¹ URL è¿›è¡Œåˆ†ç»„ï¼Œæ¯ç»„å¯¹åº”ä¸€ä¸ª Controller æ˜¯ä¸€ç§å¾ˆå¥½çš„ç»„ç»‡å½¢å¼ï¼Œå¹¶å¯ä»¥åœ¨ Controller çš„ class å®šä¹‰å‡ºæ·»åŠ  URL å‰ç¼€ï¼Œä¾‹å¦‚ï¼š

```java
@Controller
@RequestMapping("/user")
public class UserController {
    // æ³¨æ„å®é™… URL æ˜ å°„æ˜¯ / user/profile
    @GetMapping("/profile")
    public ModelAndView profile() {
        ...
    }

    // æ³¨æ„å®é™… URL æ˜ å°„æ˜¯ / user/changePassword
    @GetMapping("/changePassword")
    public ModelAndView changePassword() {
        ...
    }
}
```

å®é™…æ–¹æ³•çš„ URL æ˜ å°„æ€»æ˜¯å‰ç¼€ + è·¯å¾„ï¼Œè¿™ç§å½¢å¼è¿˜å¯ä»¥æœ‰æ•ˆé¿å…ä¸å°å¿ƒå¯¼è‡´çš„é‡å¤çš„ URL æ˜ å°„ã€‚

å¯è§ï¼ŒSpring MVC å…è®¸æˆ‘ä»¬ç¼–å†™æ—¢ç®€å•åˆçµæ´»çš„ Controller å®ç°ã€‚

### ç»ƒä¹ 

åœ¨æ³¨å†Œã€ç™»å½•ç­‰åŠŸèƒ½çš„åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªä¿®æ”¹å£ä»¤çš„é¡µé¢ã€‚


### å°ç»“

ä½¿ç”¨ Spring MVC æ—¶ï¼Œæ•´ä¸ª Web åº”ç”¨ç¨‹åºæŒ‰å¦‚ä¸‹é¡ºåºå¯åŠ¨ï¼š

1. å¯åŠ¨ Tomcat æœåŠ¡å™¨ï¼›
2. Tomcat è¯»å– `web.xml` å¹¶åˆå§‹åŒ– `DispatcherServlet`ï¼›
3. `DispatcherServlet` åˆ›å»º IoC å®¹å™¨å¹¶è‡ªåŠ¨æ³¨å†Œåˆ° `ServletContext` ä¸­ã€‚

å¯åŠ¨åï¼Œæµè§ˆå™¨å‘å‡ºçš„ HTTP è¯·æ±‚å…¨éƒ¨ç”± `DispatcherServlet` æ¥æ”¶ï¼Œå¹¶æ ¹æ®é…ç½®è½¬å‘åˆ°æŒ‡å®š Controller çš„æŒ‡å®šæ–¹æ³•å¤„ç†ã€‚



## ğŸ€ ä½¿ç”¨ REST

ä½¿ç”¨ Spring MVC å¼€å‘ Web åº”ç”¨ç¨‹åºçš„ä¸»è¦å·¥ä½œå°±æ˜¯ç¼–å†™ Controller é€»è¾‘ã€‚åœ¨ Web åº”ç”¨ä¸­ï¼Œé™¤äº†éœ€è¦ä½¿ç”¨ MVC ç»™ç”¨æˆ·æ˜¾ç¤ºé¡µé¢å¤–ï¼Œè¿˜æœ‰ä¸€ç±» API æ¥å£ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º RESTï¼Œé€šå¸¸è¾“å…¥è¾“å‡ºéƒ½æ˜¯ JSONï¼Œä¾¿äºç¬¬ä¸‰æ–¹è°ƒç”¨æˆ–è€…ä½¿ç”¨é¡µé¢ JavaScript ä¸ä¹‹äº¤äº’ã€‚

ç›´æ¥åœ¨ Controller ä¸­å¤„ç† JSON æ˜¯å¯ä»¥çš„ï¼Œå› ä¸º Spring MVC çš„ `@GetMapping` å’Œ `@PostMapping` éƒ½æ”¯æŒæŒ‡å®šè¾“å…¥å’Œè¾“å‡ºçš„æ ¼å¼ã€‚å¦‚æœæˆ‘ä»¬æƒ³æ¥æ”¶ JSONï¼Œè¾“å‡º JSONï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·å†™ï¼š

```java
@PostMapping(value = "/rest",
             consumes = "application/json;charset=UTF-8",
             produces = "application/json;charset=UTF-8")
@ResponseBody
public String rest(@RequestBody User user) {
    return "{\"restSupport\":true}";
}
```

å¯¹åº”çš„ Maven å·¥ç¨‹éœ€è¦åŠ å…¥ Jackson è¿™ä¸ªä¾èµ–ï¼š`com.fasterxml.jackson.core:jackson-databind:2.14.0`

æ³¨æ„åˆ° `@PostMapping` ä½¿ç”¨ `consumes` å£°æ˜èƒ½æ¥æ”¶çš„ç±»å‹ï¼Œä½¿ç”¨ `produces` å£°æ˜è¾“å‡ºçš„ç±»å‹ï¼Œå¹¶ä¸”é¢å¤–åŠ äº† `@ResponseBody` è¡¨ç¤ºè¿”å›çš„ `String` æ— éœ€é¢å¤–å¤„ç†ï¼Œç›´æ¥ä½œä¸ºè¾“å‡ºå†…å®¹å†™å…¥ `HttpServletResponse`ã€‚è¾“å…¥çš„ JSON åˆ™æ ¹æ®æ³¨è§£ `@RequestBody` ç›´æ¥è¢« Spring ååºåˆ—åŒ–ä¸º `User` è¿™ä¸ª JavaBeanã€‚

ä½¿ç”¨ curl å‘½ä»¤æµ‹è¯•ä¸€ä¸‹ï¼š

```bash
$ curl -v -H "Content-Type: application/json" -d '{"email":"bob@example.com"}' http://localhost:8080/rest
> POST /rest HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/7.64.1
> Accept: */*
> Content-Type: application/json
> Content-Length: 27
>
< HTTP/1.1 200
< Content-Type: application/json;charset=utf-8
< Content-Length: 20
< Date: Sun, 10 May 2020 09:56:01 GMT
<
{"restSupport":true}
```

è¾“å‡ºæ­£æ˜¯æˆ‘ä»¬å†™å…¥çš„å­—ç¬¦ä¸²ã€‚

ç›´æ¥ç”¨ Spring çš„ Controller é…åˆä¸€å¤§å †æ³¨è§£å†™ REST å¤ªéº»çƒ¦äº†ï¼Œå› æ­¤ï¼ŒSpring è¿˜é¢å¤–æä¾›äº†ä¸€ä¸ª `@RestController` æ³¨è§£ï¼Œä½¿ç”¨ `@RestController` æ›¿ä»£ `@Controller` åï¼Œæ¯ä¸ªæ–¹æ³•è‡ªåŠ¨å˜æˆ API æ¥å£æ–¹æ³•ã€‚æˆ‘ä»¬è¿˜æ˜¯ä»¥å®é™…ä»£ç ä¸¾ä¾‹ï¼Œç¼–å†™ `ApiController` å¦‚ä¸‹ï¼š

```java
@RestController
@RequestMapping("/api")
public class ApiController {
    @Autowired
    UserService userService;

    @GetMapping("/users")
    public List<User> users() {
        return userService.getUsers();
    }

    @GetMapping("/users/{id}")
    public User user(@PathVariable("id") long id) {
        return userService.getUserById(id);
    }

    @PostMapping("/signin")
    public Map<String, Object> signin(@RequestBody SignInRequest signinRequest) {
        try {
            User user = userService.signin(signinRequest.email, signinRequest.password);
            return Map.of("user", user);
        } catch (Exception e) {
            return Map.of("error", "SIGNIN_FAILED", "message", e.getMessage());
        }
    }

    public static class SignInRequest {
        public String email;
        public String password;
    }
}
```

ç¼–å†™ REST æ¥å£åªéœ€è¦å®šä¹‰ `@RestController`ï¼Œç„¶åï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æ˜¯ä¸€ä¸ª API æ¥å£ï¼Œè¾“å…¥å’Œè¾“å‡ºåªè¦èƒ½è¢« Jackson åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ä¸º JSON å°±æ²¡æœ‰é—®é¢˜ã€‚æˆ‘ä»¬ç”¨æµè§ˆå™¨æµ‹è¯• GET è¯·æ±‚ï¼Œå¯ç›´æ¥æ˜¾ç¤º JSON å“åº”ï¼š

![user-api](./assets/l-20231221154305694.png)

è¦æµ‹è¯• POST è¯·æ±‚ï¼Œå¯ä»¥ç”¨ curl å‘½ä»¤ï¼š

```bash
$ curl -v -H "Content-Type: application/json" -d '{"email":"bob@example.com","password":"bob123"}' http://localhost:8080/api/signin
> POST /api/signin HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/7.64.1
> Accept: */*
> Content-Type: application/json
> Content-Length: 47
>
< HTTP/1.1 200
< Content-Type: application/json
< Transfer-Encoding: chunked
< Date: Sun, 10 May 2020 08:14:13 GMT
<
{"user":{"id":1,"email":"bob@example.com","password":"bob123","name":"Bob",...
```

æ³¨æ„è§‚å¯Ÿä¸Šè¿° JSON çš„è¾“å‡ºï¼Œ`User` èƒ½è¢«æ­£ç¡®åœ°åºåˆ—åŒ–ä¸º JSONï¼Œä½†æš´éœ²äº† `password` å±æ€§ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸æœŸæœ›çš„ã€‚è¦é¿å…è¾“å‡º `password` å±æ€§ï¼Œå¯ä»¥æŠŠ `User` å¤åˆ¶åˆ°å¦ä¸€ä¸ª `UserBean` å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åªæŒæœ‰å¿…è¦çš„å±æ€§ï¼Œä½†è¿™æ ·åšæ¯”è¾ƒç¹çã€‚å¦ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ç›´æ¥åœ¨ `User` çš„ `password` å±æ€§å®šä¹‰å¤„åŠ ä¸Š `@JsonIgnore` è¡¨ç¤ºå®Œå…¨å¿½ç•¥è¯¥å±æ€§ï¼š

```java
public class User {
    ...

    @JsonIgnore
    public String getPassword() {
        return password;
    }

    ...
}
```

ä½†æ˜¯è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœå†™ä¸€ä¸ª `register(User user)` æ–¹æ³•ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•çš„ User å¯¹è±¡ä¹Ÿæ‹¿ä¸åˆ°æ³¨å†Œæ—¶ç”¨æˆ·ä¼ å…¥çš„å¯†ç äº†ã€‚å¦‚æœè¦å…è®¸è¾“å…¥ `password`ï¼Œä½†ä¸å…è®¸è¾“å‡º `password`ï¼Œå³åœ¨ JSON åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ï¼Œå…è®¸å†™å±æ€§ï¼Œç¦ç”¨è¯»å±æ€§ï¼Œå¯ä»¥æ›´ç²¾ç»†åœ°æ§åˆ¶å¦‚ä¸‹ï¼š

```java
public class User {
    ...

    @JsonProperty(access = Access.WRITE_ONLY)
    public String getPassword() {
        return password;
    }

    ...
}
```

åŒæ ·çš„ï¼Œå¯ä»¥ä½¿ç”¨ `@JsonProperty(access = Access.READ_ONLY)` å…è®¸è¾“å‡ºï¼Œä¸å…è®¸è¾“å…¥ã€‚

### ç»ƒä¹ 


### å°ç»“

ä½¿ç”¨ `@RestController` å¯ä»¥æ–¹ä¾¿åœ°ç¼–å†™ REST æœåŠ¡ï¼ŒSpring é»˜è®¤ä½¿ç”¨ JSON ä½œä¸ºè¾“å…¥å’Œè¾“å‡ºã€‚

è¦æ§åˆ¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ Jackson æä¾›çš„ `@JsonIgnore` å’Œ `@JsonProperty` æ³¨è§£ã€‚



## ğŸ€ é›†æˆ Filter


åœ¨ Spring MVC ä¸­ï¼Œ`DispatcherServlet` åªéœ€è¦å›ºå®šé…ç½®åˆ° `web.xml` ä¸­ï¼Œå‰©ä¸‹çš„å·¥ä½œä¸»è¦æ˜¯ä¸“æ³¨äºç¼–å†™ Controllerã€‚

ä½†æ˜¯ï¼Œåœ¨ Servlet è§„èŒƒä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ [ä½¿ç”¨ Filter](https://www.liaoxuefeng.com/wiki/1252599548343744/1266264823560128)ã€‚å¦‚æœè¦åœ¨ Spring MVC ä¸­ä½¿ç”¨ `Filter`ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ

æœ‰çš„ç«¥é‹åœ¨ä¸Šä¸€èŠ‚çš„ Web åº”ç”¨ä¸­å¯èƒ½å‘ç°äº†ï¼Œå¦‚æœæ³¨å†Œæ—¶è¾“å…¥ä¸­æ–‡ä¼šå¯¼è‡´ä¹±ç ï¼Œå› ä¸º Servlet é»˜è®¤æŒ‰é UTF-8 ç¼–ç è¯»å–å‚æ•°ã€‚ä¸ºäº†ä¿®å¤è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä½¿ç”¨ä¸€ä¸ª EncodingFilterï¼Œåœ¨å…¨å±€èŒƒå›´ç±»ç»™ `HttpServletRequest` å’Œ `HttpServletResponse` å¼ºåˆ¶è®¾ç½®ä¸º UTF-8 ç¼–ç ã€‚

å¯ä»¥è‡ªå·±ç¼–å†™ä¸€ä¸ª EncodingFilterï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ Spring MVC è‡ªå¸¦çš„ä¸€ä¸ª `CharacterEncodingFilter`ã€‚é…ç½® Filter æ—¶ï¼Œåªéœ€åœ¨ `web.xml` ä¸­å£°æ˜å³å¯ï¼š

```xml
<web-app>
    <filter>
        <filter-name>encodingFilter</filter-name>
        <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
        <init-param>
            <param-name>encoding</param-name>
            <param-value>UTF-8</param-value>
        </init-param>
        <init-param>
            <param-name>forceEncoding</param-name>
            <param-value>true</param-value>
        </init-param>
    </filter>

    <filter-mapping>
        <filter-name>encodingFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
    ...
</web-app>
```

å› ä¸ºè¿™ç§ Filter å’Œæˆ‘ä»¬ä¸šåŠ¡å…³ç³»ä¸å¤§ï¼Œæ³¨æ„åˆ° `CharacterEncodingFilter` å…¶å®å’Œ Spring çš„ IoC å®¹å™¨æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸¤è€…å‡äº’ä¸çŸ¥æ™“å¯¹æ–¹çš„å­˜åœ¨ï¼Œå› æ­¤ï¼Œé…ç½®è¿™ç§ Filter ååˆ†ç®€å•ã€‚

æˆ‘ä»¬å†è€ƒè™‘è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœå…è®¸ç”¨æˆ·ä½¿ç”¨ Basic æ¨¡å¼è¿›è¡Œç”¨æˆ·éªŒè¯ï¼Œå³åœ¨ HTTP è¯·æ±‚ä¸­æ·»åŠ å¤´ `Authorization: Basic email:password`ï¼Œè¿™ä¸ªéœ€æ±‚å¦‚ä½•å®ç°ï¼Ÿ

ç¼–å†™ä¸€ä¸ª `AuthFilter` æ˜¯æœ€ç®€å•çš„å®ç°æ–¹å¼ï¼š

```java
@Component
public class AuthFilter implements Filter {
    @Autowired
    UserService userService;

    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest req = (HttpServletRequest) request;
        // è·å– Authorization å¤´:
        String authHeader = req.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("Basic")) {
            // ä» Header ä¸­æå– email å’Œ password:
            String email = prefixFrom(authHeader);
            String password = suffixFrom(authHeader);
            // ç™»å½•:
            User user = userService.signin(email, password);
            // æ”¾å…¥ Session:
            req.getSession().setAttribute(UserController.KEY_USER, user);
        }
        // ç»§ç»­å¤„ç†è¯·æ±‚:
        chain.doFilter(request, response);
    }
}
```

ç°åœ¨é—®é¢˜æ¥äº†ï¼šåœ¨ Spring ä¸­åˆ›å»ºçš„è¿™ä¸ª `AuthFilter` æ˜¯ä¸€ä¸ªæ™®é€š Beanï¼ŒServlet å®¹å™¨å¹¶ä¸çŸ¥é“ï¼Œæ‰€ä»¥å®ƒä¸ä¼šèµ·ä½œç”¨ã€‚

å¦‚æœæˆ‘ä»¬ç›´æ¥åœ¨ `web.xml` ä¸­å£°æ˜è¿™ä¸ª `AuthFilter`ï¼Œæ³¨æ„åˆ° `AuthFilter` çš„å®ä¾‹å°†ç”± Servlet å®¹å™¨è€Œä¸æ˜¯ Spring å®¹å™¨åˆå§‹åŒ–ï¼Œå› æ­¤ï¼Œ`@Autowire` æ ¹æœ¬ä¸ç”Ÿæ•ˆï¼Œç”¨äºç™»å½•çš„ `UserService` æˆå‘˜å˜é‡æ°¸è¿œæ˜¯ `null`ã€‚

æ‰€ä»¥ï¼Œå¾—é€šè¿‡ä¸€ç§æ–¹å¼ï¼Œè®© Servlet å®¹å™¨å®ä¾‹åŒ–çš„ Filterï¼Œé—´æ¥å¼•ç”¨ Spring å®¹å™¨å®ä¾‹åŒ–çš„ `AuthFilter`ã€‚Spring MVC æä¾›äº†ä¸€ä¸ª `DelegatingFilterProxy`ï¼Œä¸“é—¨æ¥å¹²è¿™ä¸ªäº‹æƒ…ï¼š

```xml
<web-app>
    <filter>
        <filter-name>authFilter</filter-name>
        <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
    </filter>

    <filter-mapping>
        <filter-name>authFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
    ...
</web-app>
```

æˆ‘ä»¬æ¥çœ‹å®ç°åŸç†ï¼š

1. Servlet å®¹å™¨ä» `web.xml` ä¸­è¯»å–é…ç½®ï¼Œå®ä¾‹åŒ– `DelegatingFilterProxy`ï¼Œæ³¨æ„å‘½åæ˜¯ `authFilter`ï¼›
2. Spring å®¹å™¨é€šè¿‡æ‰«æ `@Component` å®ä¾‹åŒ– `AuthFilter`ã€‚

å½“ `DelegatingFilterProxy` ç”Ÿæ•ˆåï¼Œå®ƒä¼šè‡ªåŠ¨æŸ¥æ‰¾æ³¨å†Œåœ¨ `ServletContext` ä¸Šçš„ Spring å®¹å™¨ï¼Œå†è¯•å›¾ä»å®¹å™¨ä¸­æŸ¥æ‰¾åä¸º `authFilter` çš„ Beanï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç”¨ `@Component` å£°æ˜çš„ `AuthFilter`ã€‚

`DelegatingFilterProxy` å°†è¯·æ±‚ä»£ç†ç»™ `AuthFilter`ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```java
public class DelegatingFilterProxy implements Filter {
    private Filter delegate;
    public void doFilter(...) throws ... {
        if (delegate == null) {
            delegate = findBeanFromSpringContainer();
        }
        delegate.doFilter(req, resp, chain);
    }
}
```

è¿™å°±æ˜¯ä¸€ä¸ª [ä»£ç†æ¨¡å¼](https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017) çš„ç®€å•åº”ç”¨ã€‚æˆ‘ä»¬ç”»ä¸ªå›¾è¡¨ç¤ºå®ƒä»¬ä¹‹é—´çš„å¼•ç”¨å…³ç³»å¦‚ä¸‹ï¼š

```ascii
â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â” â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚DelegatingFilterProxyâ”‚â”€â”‚â”€â”‚â”€ â”€>â”‚AuthFilter â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  DispatcherServlet  â”‚â”€ â”€ â”€ â”€>â”‚Controllersâ”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
â”‚    Servlet Container    â”‚ â”‚  Spring Container
 â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€   â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
```

å¦‚æœåœ¨ `web.xml` ä¸­é…ç½®çš„ Filter åå­—å’Œ Spring å®¹å™¨çš„ Bean çš„åå­—ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆéœ€è¦æŒ‡å®š Bean çš„åå­—ï¼š

```xml
<filter>
    <filter-name>basicAuthFilter</filter-name>
    <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
    <!-- æŒ‡å®š Bean çš„åå­— -->
    <init-param>
        <param-name>targetBeanName</param-name>
        <param-value>authFilter</param-value>
    </init-param>
</filter>
```

å®é™…åº”ç”¨æ—¶ï¼Œå°½é‡ä¿æŒåå­—ä¸€è‡´ï¼Œä»¥å‡å°‘ä¸å¿…è¦çš„é…ç½®ã€‚

è¦ä½¿ç”¨ Basic æ¨¡å¼çš„ç”¨æˆ·è®¤è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ curl å‘½ä»¤æµ‹è¯•ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·ç™»å½•åæ˜¯ `tom@example.com`ï¼Œå£ä»¤æ˜¯ `tomcat`ï¼Œé‚£ä¹ˆå…ˆæ„é€ ä¸€ä¸ªä½¿ç”¨ URL ç¼–ç çš„ ` ç”¨æˆ·å: å£ä»¤ ` çš„å­—ç¬¦ä¸²ï¼š

```
tom%40example.com:tomcat
```

å¯¹å…¶è¿›è¡Œ Base64 ç¼–ç ï¼Œæœ€ç»ˆæ„é€ å‡ºçš„ Header å¦‚ä¸‹ï¼š

```
Authorization: Basic dG9tJTQwZXhhbXBsZS5jb206dG9tY2F0
```

ä½¿ç”¨å¦‚ä¸‹çš„ `curl` å‘½ä»¤å¹¶è·å¾—å“åº”å¦‚ä¸‹ï¼š

```bash
$ curl -v -H 'Authorization: Basic dG9tJTQwZXhhbXBsZS5jb206dG9tY2F0' http://localhost:8080/profile
> GET /profile HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/7.64.1
> Accept: */*
> Authorization: Basic dG9tJTQwZXhhbXBsZS5jb206dG9tY2F0
>
< HTTP/1.1 200
< Set-Cookie: JSESSIONID=CE0F4BFC394816F717443397D4FEABBE; Path=/; HttpOnly
< Content-Type: text/html;charset=UTF-8
< Content-Language: en-CN
< Transfer-Encoding: chunked
< Date: Wed, 29 Apr 2020 00:15:50 GMT
<
<!doctype html>
...HTML è¾“å‡º...
```

ä¸Šè¿°å“åº”è¯´æ˜ `AuthFilter` å·²ç”Ÿæ•ˆã€‚

> æ³¨æ„ï¼šBasic è®¤è¯æ¨¡å¼å¹¶ä¸å®‰å…¨ï¼Œæœ¬èŠ‚åªç”¨æ¥ä½œä¸ºä½¿ç”¨ Filter çš„ç¤ºä¾‹ã€‚

### ç»ƒä¹ 


### å°ç»“

å½“ä¸€ä¸ª Filter ä½œä¸º Spring å®¹å™¨ç®¡ç†çš„ Bean å­˜åœ¨æ—¶ï¼Œå¯ä»¥é€šè¿‡ `DelegatingFilterProxy` é—´æ¥åœ°å¼•ç”¨å®ƒå¹¶ä½¿å…¶ç”Ÿæ•ˆã€‚



## ğŸ€ ä½¿ç”¨ Interceptor


åœ¨ Web ç¨‹åºä¸­ï¼Œæ³¨æ„åˆ°ä½¿ç”¨ Filter çš„æ—¶å€™ï¼ŒFilter ç”± Servlet å®¹å™¨ç®¡ç†ï¼Œå®ƒåœ¨ Spring MVC çš„ Web åº”ç”¨ç¨‹åºä¸­ä½œç”¨èŒƒå›´å¦‚ä¸‹ï¼š

```ascii
         â”‚   â–²
         â–¼   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”
       â”‚Filter1â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚   â–²
         â–¼   â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”Œ â”€ â”€ â”€â”‚Filter2â”‚â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”
       â””â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚        â”‚   â–²                  â”‚
         â–¼   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
  â”‚DispatcherServletâ”‚<â”€â”€â”€â”
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚      â”‚
   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚              â”‚ModelAndViewâ”‚â”‚
   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚                     â–²      â”‚
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”œâ”€â”€â”€>â”‚Controller1â”‚â”€â”€â”€â”€â”¤      â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”‚                     â”‚      â”‚
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â””â”€â”€â”€>â”‚Controller2â”‚â”€â”€â”€â”€â”˜      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
```

ä¸Šå›¾è™šçº¿æ¡†å°±æ˜¯ Filter2 çš„æ‹¦æˆªèŒƒå›´ï¼ŒFilter ç»„ä»¶å®é™…ä¸Šå¹¶ä¸çŸ¥é“åç»­å†…éƒ¨å¤„ç†æ˜¯é€šè¿‡ Spring MVC æä¾›çš„ `DispatcherServlet` è¿˜æ˜¯å…¶ä»– Servlet ç»„ä»¶ï¼Œå› ä¸º Filter æ˜¯ Servlet è§„èŒƒå®šä¹‰çš„æ ‡å‡†ç»„ä»¶ï¼Œå®ƒå¯ä»¥åº”ç”¨åœ¨ä»»ä½•åŸºäº Servlet çš„ç¨‹åºä¸­ã€‚

å¦‚æœåªåŸºäº Spring MVC å¼€å‘åº”ç”¨ç¨‹åºï¼Œè¿˜å¯ä»¥ä½¿ç”¨ Spring MVC æä¾›çš„ä¸€ç§åŠŸèƒ½ç±»ä¼¼ Filter çš„æ‹¦æˆªå™¨ï¼šInterceptorã€‚å’Œ Filter ç›¸æ¯”ï¼ŒInterceptor æ‹¦æˆªèŒƒå›´ä¸æ˜¯åç»­æ•´ä¸ªå¤„ç†æµç¨‹ï¼Œè€Œæ˜¯ä»…é’ˆå¯¹ Controller æ‹¦æˆªï¼š

```ascii
       â”‚   â–²
       â–¼   â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”
     â”‚Filter1â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚   â–²
       â–¼   â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”
     â”‚Filter2â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚   â–²
       â–¼   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚DispatcherServletâ”‚<â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
 â”‚ â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”¼ â”€ â”€ â”€ â”
 â”‚                     â”‚
 â”‚ â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
 â”‚              â”‚   Render   â”‚
 â”‚ â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
 â”‚                     â–²
 â”‚ â”‚                   â”‚       â”‚
 â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ â”‚            â”‚ModelAndViewâ”‚ â”‚
 â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â”‚ â”‚                   â–²       â”‚
 â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
 â”œâ”€â”¼â”€>â”‚Controller1â”‚â”€â”€â”€â”€â”¤       â”‚
 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
 â”‚ â”‚                   â”‚       â”‚
 â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
 â””â”€â”¼â”€>â”‚Controller2â”‚â”€â”€â”€â”€â”˜       â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
```

ä¸Šå›¾è™šçº¿æ¡†å°±æ˜¯ Interceptor çš„æ‹¦æˆªèŒƒå›´ï¼Œæ³¨æ„åˆ° Controller çš„å¤„ç†æ–¹æ³•ä¸€èˆ¬éƒ½ç±»ä¼¼è¿™æ ·ï¼š

```
@Controller
public class Controller1 {
    @GetMapping("/path/to/hello")
    ModelAndView hello() {
        ...
    }
}
```

æ‰€ä»¥ï¼ŒInterceptor çš„æ‹¦æˆªèŒƒå›´å…¶å®å°±æ˜¯ Controller æ–¹æ³•ï¼Œå®ƒå®é™…ä¸Šå°±ç›¸å½“äºåŸºäº AOP çš„æ–¹æ³•æ‹¦æˆªã€‚å› ä¸º Interceptor åªæ‹¦æˆª Controller æ–¹æ³•ï¼Œæ‰€ä»¥è¦æ³¨æ„ï¼Œè¿”å› `ModelAndView` å¹¶æ¸²æŸ“åï¼Œåç»­å¤„ç†å°±è„±ç¦»äº† Interceptor çš„æ‹¦æˆªèŒƒå›´ã€‚

ä½¿ç”¨ Interceptor çš„å¥½å¤„æ˜¯ Interceptor æœ¬èº«æ˜¯ Spring ç®¡ç†çš„ Beanï¼Œå› æ­¤æ³¨å…¥ä»»æ„ Bean éƒ½éå¸¸ç®€å•ã€‚æ­¤å¤–ï¼Œå¯ä»¥åº”ç”¨å¤šä¸ª Interceptorï¼Œå¹¶é€šè¿‡ç®€å•çš„ `@Order` æŒ‡å®šé¡ºåºã€‚æˆ‘ä»¬å…ˆå†™ä¸€ä¸ª `LoggerInterceptor`ï¼š

```
@Order(1)
@Component
public class LoggerInterceptor implements HandlerInterceptor {

    final Logger logger = LoggerFactory.getLogger(getClass());

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        logger.info("preHandle {}...", request.getRequestURI());
        if (request.getParameter("debug") != null) {
            PrintWriter pw = response.getWriter();
            pw.write("<p>DEBUG MODE</p>");
            pw.flush();
            return false;
        }
        return true;
    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        logger.info("postHandle {}.", request.getRequestURI());
        if (modelAndView != null) {
            modelAndView.addObject("__time__", LocalDateTime.now());
        }
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        logger.info("afterCompletion {}: exception = {}", request.getRequestURI(), ex);
    }
}
```

ä¸€ä¸ª Interceptor å¿…é¡»å®ç° `HandlerInterceptor` æ¥å£ï¼Œå¯ä»¥é€‰æ‹©å®ç° `preHandle()`ã€`postHandle()` å’Œ `afterCompletion()` æ–¹æ³•ã€‚`preHandle()` æ˜¯ Controller æ–¹æ³•è°ƒç”¨å‰æ‰§è¡Œï¼Œ`postHandle()` æ˜¯ Controller æ–¹æ³•æ­£å¸¸è¿”å›åæ‰§è¡Œï¼Œè€Œ `afterCompletion()` æ— è®º Controller æ–¹æ³•æ˜¯å¦æŠ›å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼Œå‚æ•° `ex` å°±æ˜¯ Controller æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ï¼ˆæœªæŠ›å‡ºå¼‚å¸¸æ˜¯ `null`ï¼‰ã€‚

åœ¨ `preHandle()` ä¸­ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¤„ç†å“åº”ï¼Œç„¶åè¿”å› `false` è¡¨ç¤ºæ— éœ€è°ƒç”¨ Controller æ–¹æ³•ç»§ç»­å¤„ç†äº†ï¼Œé€šå¸¸åœ¨è®¤è¯æˆ–è€…å®‰å…¨æ£€æŸ¥å¤±è´¥æ—¶ç›´æ¥è¿”å›é”™è¯¯å“åº”ã€‚åœ¨ `postHandle()` ä¸­ï¼Œå› ä¸ºæ•è·äº† Controller æ–¹æ³•è¿”å›çš„ `ModelAndView`ï¼Œæ‰€ä»¥å¯ä»¥ç»§ç»­å¾€ `ModelAndView` é‡Œæ·»åŠ ä¸€äº›é€šç”¨æ•°æ®ï¼Œå¾ˆå¤šé¡µé¢éœ€è¦çš„å…¨å±€æ•°æ®å¦‚ Copyright ä¿¡æ¯ç­‰éƒ½å¯ä»¥æ”¾åˆ°è¿™é‡Œï¼Œæ— éœ€åœ¨æ¯ä¸ª Controller æ–¹æ³•ä¸­é‡å¤æ·»åŠ ã€‚

æˆ‘ä»¬å†ç»§ç»­æ·»åŠ ä¸€ä¸ª `AuthInterceptor`ï¼Œç”¨äºæ›¿ä»£ä¸Šä¸€èŠ‚ä½¿ç”¨ `AuthFilter` è¿›è¡Œ Basic è®¤è¯çš„åŠŸèƒ½ï¼š

```
@Order(2)
@Component
public class AuthInterceptor implements HandlerInterceptor {

    final Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    UserService userService;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
            throws Exception {
        logger.info("pre authenticate {}...", request.getRequestURI());
        try {
            authenticateByHeader(request);
        } catch (RuntimeException e) {
            logger.warn("login by authorization header failed.", e);
        }
        return true;
    }

    private void authenticateByHeader(HttpServletRequest req) {
        String authHeader = req.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("Basic")) {
            logger.info("try authenticate by authorization header...");
            String up = new String(Base64.getDecoder().decode(authHeader.substring(6)), StandardCharsets.UTF_8);
            int pos = up.indexOf(':');
            if (pos> 0) {
                String email = URLDecoder.decode(up.substring(0, pos), StandardCharsets.UTF_8);
                String password = URLDecoder.decode(up.substring(pos + 1), StandardCharsets.UTF_8);
                User user = userService.signin(email, password);
                req.getSession().setAttribute(UserController.KEY_USER, user);
                logger.info("user {} login by authorization header ok.", email);
            }
        }
    }
}
```

è¿™ä¸ª `AuthInterceptor` æ˜¯ç”± Spring å®¹å™¨ç›´æ¥ç®¡ç†çš„ï¼Œå› æ­¤æ³¨å…¥ `UserService` éå¸¸æ–¹ä¾¿ã€‚

æœ€åï¼Œè¦è®©æ‹¦æˆªå™¨ç”Ÿæ•ˆï¼Œæˆ‘ä»¬åœ¨ `WebMvcConfigurer` ä¸­æ³¨å†Œæ‰€æœ‰çš„ Interceptorï¼š

```
@Bean
WebMvcConfigurer createWebMvcConfigurer(@Autowired HandlerInterceptor[] interceptors) {
    return new WebMvcConfigurer() {
        public void addInterceptors(InterceptorRegistry registry) {
            for (var interceptor : interceptors) {
                registry.addInterceptor(interceptor);
            }
        }
        ...
    };
}
```

 å¦‚æœæ‹¦æˆªå™¨æ²¡æœ‰ç”Ÿæ•ˆï¼Œè¯·æ£€æŸ¥æ˜¯å¦å¿˜äº†åœ¨ WebMvcConfigurer ä¸­æ³¨å†Œã€‚

### å¤„ç†å¼‚å¸¸

åœ¨ Controller ä¸­ï¼ŒSpring MVC è¿˜å…è®¸å®šä¹‰åŸºäº `@ExceptionHandler` æ³¨è§£çš„å¼‚å¸¸å¤„ç†æ–¹æ³•ã€‚æˆ‘ä»¬æ¥çœ‹å…·ä½“çš„ç¤ºä¾‹ä»£ç ï¼š

```
@Controller
public class UserController {
    @ExceptionHandler(RuntimeException.class)
    public ModelAndView handleUnknowException(Exception ex) {
        return new ModelAndView("500.html", Map.of("error", ex.getClass().getSimpleName(), "message", ex.getMessage()));
    }
    ...
}
```

å¼‚å¸¸å¤„ç†æ–¹æ³•æ²¡æœ‰å›ºå®šçš„æ–¹æ³•ç­¾åï¼Œå¯ä»¥ä¼ å…¥ `Exception`ã€`HttpServletRequest` ç­‰ï¼Œè¿”å›å€¼å¯ä»¥æ˜¯ `void`ï¼Œä¹Ÿå¯ä»¥æ˜¯ `ModelAndView`ï¼Œä¸Šè¿°ä»£ç é€šè¿‡ `@ExceptionHandler(RuntimeException.class)` è¡¨ç¤ºå½“å‘ç”Ÿ `RuntimeException` çš„æ—¶å€™ï¼Œå°±è‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•å¤„ç†ã€‚

æ³¨æ„åˆ°æˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªæ–°çš„ `ModelAndView`ï¼Œè¿™æ ·åœ¨åº”ç”¨ç¨‹åºå†…éƒ¨å¦‚æœå‘ç”Ÿäº†é¢„æ–™ä¹‹å¤–çš„å¼‚å¸¸ï¼Œå¯ä»¥ç»™ç”¨æˆ·æ˜¾ç¤ºä¸€ä¸ªå‡ºé”™é¡µé¢ï¼Œè€Œä¸æ˜¯ç®€å•çš„ 500 Internal Server Error æˆ– 404 Not Foundã€‚ä¾‹å¦‚ B ç«™çš„é”™è¯¯é¡µï¼š

![500](./assets/l-20231221154335517.png)

å¯ä»¥ç¼–å†™å¤šä¸ªé”™è¯¯å¤„ç†æ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•é’ˆå¯¹ç‰¹å®šçš„å¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œå¤„ç† `LoginException` ä½¿å¾—é¡µé¢å¯ä»¥è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µã€‚

ä½¿ç”¨ `ExceptionHandler` æ—¶ï¼Œè¦æ³¨æ„å®ƒä»…ä½œç”¨äºå½“å‰çš„ Controllerï¼Œå³ ControllerA ä¸­å®šä¹‰çš„ä¸€ä¸ª `ExceptionHandler` æ–¹æ³•å¯¹ ControllerB ä¸èµ·ä½œç”¨ã€‚å¦‚æœæˆ‘ä»¬æœ‰å¾ˆå¤š Controllerï¼Œæ¯ä¸ª Controller éƒ½éœ€è¦å¤„ç†ä¸€äº›é€šç”¨çš„å¼‚å¸¸ï¼Œä¾‹å¦‚ `LoginException`ï¼Œæ€è€ƒä¸€ä¸‹åº”è¯¥æ€ä¹ˆé¿å…é‡å¤ä»£ç ï¼Ÿ

### ç»ƒä¹ 


### å°ç»“

Spring MVC æä¾›äº† Interceptor ç»„ä»¶æ¥æ‹¦æˆª Controller æ–¹æ³•ï¼Œä½¿ç”¨æ—¶è¦æ³¨æ„ Interceptor çš„ä½œç”¨èŒƒå›´ã€‚



## ğŸ€ å¤„ç† CORS

åœ¨å¼€å‘ REST åº”ç”¨æ—¶ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæ˜¯é€šè¿‡é¡µé¢çš„ JavaScript å’Œåç«¯çš„ REST API äº¤äº’ã€‚

åœ¨ JavaScript ä¸ REST äº¤äº’çš„æ—¶å€™ï¼Œæœ‰å¾ˆå¤šå®‰å…¨é™åˆ¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨æŒ‰åŒæºç­–ç•¥æ”¾è¡Œ JavaScript è°ƒç”¨ APIï¼Œå³ï¼š

- å¦‚æœ A ç«™åœ¨åŸŸå `a.com` é¡µé¢çš„ JavaScript è°ƒç”¨ A ç«™è‡ªå·±çš„ API æ—¶ï¼Œæ²¡æœ‰é—®é¢˜ï¼›
- å¦‚æœ A ç«™åœ¨åŸŸå `a.com` é¡µé¢çš„ JavaScript è°ƒç”¨ B ç«™ `b.com` çš„ API æ—¶ï¼Œå°†è¢«æµè§ˆå™¨æ‹’ç»è®¿é—®ï¼Œå› ä¸ºä¸æ»¡è¶³åŒæºç­–ç•¥ã€‚

åŒæºè¦æ±‚åŸŸåè¦å®Œå…¨ç›¸åŒï¼ˆ`a.com` å’Œ `www.a.com` ä¸åŒï¼‰ï¼Œåè®®è¦ç›¸åŒï¼ˆ`http` å’Œ `https` ä¸åŒï¼‰ï¼Œç«¯å£è¦ç›¸åŒ ã€‚

é‚£ä¹ˆï¼Œåœ¨åŸŸå `a.com` é¡µé¢çš„ JavaScript è¦è°ƒç”¨ B ç«™ `b.com` çš„ API æ—¶ï¼Œè¿˜æœ‰æ²¡æœ‰åŠæ³•ï¼Ÿ

åŠæ³•æ˜¯æœ‰çš„ï¼Œé‚£å°±æ˜¯ CORSï¼Œå…¨ç§° Cross-Origin Resource Sharingï¼Œæ˜¯ HTML5 è§„èŒƒå®šä¹‰çš„å¦‚ä½•è·¨åŸŸè®¿é—®èµ„æºã€‚å¦‚æœ A ç«™çš„ JavaScript è®¿é—® B ç«™ API çš„æ—¶å€™ï¼ŒB ç«™èƒ½å¤Ÿè¿”å›å“åº”å¤´ `Access-Control-Allow-Origin: http://a.com`ï¼Œé‚£ä¹ˆï¼Œæµè§ˆå™¨å°±å…è®¸ A ç«™çš„ JavaScript è®¿é—® B ç«™çš„ APIã€‚

æ³¨æ„åˆ°è·¨åŸŸè®¿é—®èƒ½å¦æˆåŠŸï¼Œå–å†³äº B ç«™æ˜¯å¦æ„¿æ„ç»™ A ç«™è¿”å›ä¸€ä¸ªæ­£ç¡®çš„ `Access-Control-Allow-Origin` å“åº”å¤´ï¼Œæ‰€ä»¥å†³å®šæƒæ°¸è¿œåœ¨æä¾› API çš„æœåŠ¡æ–¹æ‰‹ä¸­ã€‚

å…³äº CORS çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ [MDN æ–‡æ¡£](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚

ä½¿ç”¨ Spring çš„ `@RestController` å¼€å‘ REST åº”ç”¨æ—¶ï¼ŒåŒæ ·ä¼šé¢å¯¹è·¨åŸŸé—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬å…è®¸æŒ‡å®šçš„ç½‘ç«™é€šè¿‡é¡µé¢ JavaScript è®¿é—®è¿™äº› REST APIï¼Œå°±å¿…é¡»æ­£ç¡®åœ°è®¾ç½® CORSã€‚

æœ‰å¥½å‡ ç§æ–¹æ³•è®¾ç½® CORSï¼Œæˆ‘ä»¬æ¥ä¸€ä¸€ä»‹ç»ã€‚

### ä½¿ç”¨ @CrossOrigin

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ `@CrossOrigin` æ³¨è§£ï¼Œå¯ä»¥åœ¨ `@RestController` çš„ class çº§åˆ«æˆ–æ–¹æ³•çº§åˆ«å®šä¹‰ä¸€ä¸ª `@CrossOrigin`ï¼Œä¾‹å¦‚ï¼š

```
@CrossOrigin(origins = "http://local.liaoxuefeng.com:8080")
@RestController
@RequestMapping("/api")
public class ApiController {
    ...
}
```

ä¸Šè¿°å®šä¹‰åœ¨ `ApiController` å¤„çš„ `@CrossOrigin` æŒ‡å®šäº†åªå…è®¸æ¥è‡ª `local.liaoxuefeng.com` è·¨åŸŸè®¿é—®ï¼Œå…è®¸å¤šä¸ªåŸŸè®¿é—®éœ€è¦å†™æˆæ•°ç»„å½¢å¼ï¼Œä¾‹å¦‚ `origins = {"http://a.com", "https://www.b.com"})`ã€‚å¦‚æœè¦å…è®¸ä»»ä½•åŸŸè®¿é—®ï¼Œå†™æˆ `origins = "*"` å³å¯ã€‚

å¦‚æœæœ‰å¤šä¸ª REST Controller éƒ½éœ€è¦ä½¿ç”¨ CORSï¼Œé‚£ä¹ˆï¼Œæ¯ä¸ª Controller éƒ½å¿…é¡»æ ‡æ³¨ `@CrossOrigin` æ³¨è§£ã€‚

### ä½¿ç”¨ CorsRegistry

ç¬¬äºŒç§æ–¹æ³•æ˜¯åœ¨ `WebMvcConfigurer` ä¸­å®šä¹‰ä¸€ä¸ªå…¨å±€ CORS é…ç½®ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```
@Bean
WebMvcConfigurer createWebMvcConfigurer() {
    return new WebMvcConfigurer() {
        @Override
        public void addCorsMappings(CorsRegistry registry) {
            registry.addMapping("/api/**")
                    .allowedOrigins("http://local.liaoxuefeng.com:8080")
                    .allowedMethods("GET", "POST")
                    .maxAge(3600);
            // å¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»– URL è§„åˆ™:
            // registry.addMapping("/rest/v2/**")...
        }
    };
}
```

è¿™ç§æ–¹å¼å¯ä»¥åˆ›å»ºä¸€ä¸ªå…¨å±€ CORS é…ç½®ï¼Œå¦‚æœä»”ç»†åœ°è®¾è®¡ URL ç»“æ„ï¼Œé‚£ä¹ˆå¯ä»¥ä¸€ç›®äº†ç„¶åœ°çœ‹åˆ°å„ä¸ª URL çš„ CORS è§„åˆ™ï¼Œæ¨èä½¿ç”¨è¿™ç§æ–¹å¼é…ç½® CORSã€‚

### ä½¿ç”¨ CorsFilter

ç¬¬ä¸‰ç§æ–¹æ³•æ˜¯ä½¿ç”¨ Spring æä¾›çš„ `CorsFilter`ï¼Œæˆ‘ä»¬åœ¨ [é›†æˆ Filter](https://www.liaoxuefeng.com/wiki/1252599548343744/1282384114745378/) ä¸­è¯¦ç»†ä»‹ç»äº†å°† Spring å®¹å™¨å†…ç½®çš„ Bean æš´éœ²ä¸º Servlet å®¹å™¨çš„ Filter çš„æ–¹æ³•ï¼Œç”±äºè¿™ç§é…ç½®æ–¹å¼éœ€è¦ä¿®æ”¹ `web.xml`ï¼Œä¹Ÿæ¯”è¾ƒç¹çï¼Œæ‰€ä»¥æ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ã€‚

### æµ‹è¯•

å½“æˆ‘ä»¬é…ç½®å¥½ CORS åï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ä¸€ä¸‹è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆã€‚

æˆ‘ä»¬å…ˆç”¨ `http://localhost:8080` åœ¨ Chrome æµè§ˆå™¨ä¸­æ‰“å¼€é¦–é¡µï¼Œç„¶åæ‰“å¼€ Chrome çš„å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° Consoleï¼Œè¾“å…¥ä¸€ä¸ª JavaScript è¯­å¥æ¥è·¨åŸŸè®¿é—® APIï¼š

```
$.getJSON("http://local.liaoxuefeng.com:8080/api/users", (data) => console.log(JSON.stringify(data)));
```

ä¸Šè¿°æºç«™çš„åŸŸæ˜¯ `http://localhost:8080`ï¼Œè·¨åŸŸè®¿é—®çš„æ˜¯ `http://local.liaoxuefeng.com:8080`ï¼Œå› ä¸ºé…ç½®çš„ CORS ä¸å…è®¸ `localhost` è®¿é—®ï¼Œæ‰€ä»¥ä¸å‡ºæ„å¤–åœ°å¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼š

![cors-deny](./assets/l-20231221154348695.png)

æµè§ˆé¢˜æ‰“å°äº†é”™è¯¯åŸå› å°±æ˜¯ `been blocked by CORS policy`ã€‚

æˆ‘ä»¬å†ç”¨ `http://local.liaoxuefeng.com:8080` åœ¨ Chrome æµè§ˆå™¨ä¸­æ‰“å¼€é¦–é¡µï¼Œåœ¨ Console ä¸­æ‰§è¡Œ JavaScript è®¿é—® `localhost`ï¼š

```
$.getJSON("http://localhost:8080/api/users", (data) => console.log(JSON.stringify(data)));
```

å› ä¸º CORS è§„åˆ™å…è®¸æ¥è‡ª `http://local.liaoxuefeng.com:8080` çš„è®¿é—®ï¼Œå› æ­¤è®¿é—®æˆåŠŸï¼Œæ‰“å°å‡º API çš„è¿”å›å€¼ï¼š

![cors-ok](./assets/l-20231221154348764.png)

### ç»ƒä¹ 


### å°ç»“

CORS å¯ä»¥æ§åˆ¶æŒ‡å®šåŸŸçš„é¡µé¢ JavaScript èƒ½å¦è®¿é—® APIã€‚



## ğŸ€ å›½é™…åŒ–

La

åœ¨å¼€å‘åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œç»å¸¸ä¼šé‡åˆ°æ”¯æŒå¤šè¯­è¨€çš„éœ€æ±‚ï¼Œè¿™ç§æ”¯æŒå¤šè¯­è¨€çš„åŠŸèƒ½ç§°ä¹‹ä¸ºå›½é™…åŒ–ï¼Œè‹±æ–‡æ˜¯ internationalizationï¼Œç¼©å†™ä¸º i18nï¼ˆå› ä¸ºé¦–å­—æ¯ i å’Œæœ«å­—æ¯ n ä¸­é—´æœ‰ 18 ä¸ªå­—æ¯ï¼‰ã€‚

è¿˜æœ‰é’ˆå¯¹ç‰¹å®šåœ°åŒºçš„æœ¬åœ°åŒ–åŠŸèƒ½ï¼Œè‹±æ–‡æ˜¯ localizationï¼Œç¼©å†™ä¸º L10nï¼Œæœ¬åœ°åŒ–æ˜¯æŒ‡æ ¹æ®åœ°åŒºè°ƒæ•´ç±»ä¼¼å§“åã€æ—¥æœŸçš„æ˜¾ç¤ºç­‰ã€‚

ä¹Ÿæœ‰æŠŠä¸Šé¢ä¸¤è€…åˆç§°ä¸ºå…¨çƒåŒ–ï¼Œè‹±æ–‡æ˜¯ globalizationï¼Œç¼©å†™ä¸º g11nã€‚

åœ¨ Java ä¸­ï¼Œæ”¯æŒå¤šè¯­è¨€å’Œæœ¬åœ°åŒ–æ˜¯é€šè¿‡ `MessageFormat` é…åˆ `Locale` å®ç°çš„ï¼š

```
// MessageFormat
import java.text.MessageFormat;
import java.util.Locale;

public class Time {
    public static void main(String[] args) {
        double price = 123.5;
        int number = 10;
        Object[] arguments = { price, number};
        MessageFormat mfUS = new MessageFormat("Pay {0,number,currency} for {1} books.", Locale.US);
        System.out.println(mfUS.format(arguments));
        MessageFormat mfZH = new MessageFormat("{1} æœ¬ä¹¦ä¸€å…± {0,number,currency}ã€‚", Locale.CHINA);
        System.out.println(mfZH.format(arguments));
    }
}
```



å¯¹äº Web åº”ç”¨ç¨‹åºï¼Œè¦å®ç°å›½é™…åŒ–åŠŸèƒ½ï¼Œä¸»è¦æ˜¯æ¸²æŸ“ View çš„æ—¶å€™ï¼Œè¦æŠŠå„ç§è¯­è¨€çš„èµ„æºæ–‡ä»¶æå‡ºæ¥ï¼Œè¿™æ ·ï¼Œä¸åŒçš„ç”¨æˆ·è®¿é—®åŒä¸€ä¸ªé¡µé¢æ—¶ï¼Œæ˜¾ç¤ºçš„è¯­è¨€å°±æ˜¯ä¸åŒçš„ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨ Spring MVC åº”ç”¨ç¨‹åºä¸­å¦‚ä½•å®ç°å›½é™…åŒ–ã€‚

### è·å– Locale

å®ç°å›½é™…åŒ–çš„ç¬¬ä¸€æ­¥æ˜¯è·å–åˆ°ç”¨æˆ·çš„ `Locale`ã€‚åœ¨ Web åº”ç”¨ç¨‹åºä¸­ï¼ŒHTTP è§„èŒƒè§„å®šäº†æµè§ˆå™¨ä¼šåœ¨è¯·æ±‚ä¸­æºå¸¦ `Accept-Language` å¤´ï¼Œç”¨æ¥æŒ‡ç¤ºç”¨æˆ·æµè§ˆå™¨è®¾å®šçš„è¯­è¨€é¡ºåºï¼Œå¦‚ï¼š

```
Accept-Language: zh-CN,zh;q=0.8,en;q=0.2
```

ä¸Šè¿° HTTP è¯·æ±‚å¤´è¡¨ç¤ºä¼˜å…ˆé€‰æ‹©ç®€ä½“ä¸­æ–‡ï¼Œå…¶æ¬¡é€‰æ‹©ä¸­æ–‡ï¼Œæœ€åé€‰æ‹©è‹±æ–‡ã€‚`q` è¡¨ç¤ºæƒé‡ï¼Œè§£æåæˆ‘ä»¬å¯è·å¾—ä¸€ä¸ªæ ¹æ®ä¼˜å…ˆçº§æ’åºçš„è¯­è¨€åˆ—è¡¨ï¼ŒæŠŠå®ƒè½¬æ¢ä¸º Java çš„ `Locale`ï¼Œå³è·å¾—äº†ç”¨æˆ·çš„ `Locale`ã€‚å¤§å¤šæ•°æ¡†æ¶é€šå¸¸åªè¿”å›æƒé‡æœ€é«˜çš„ `Locale`ã€‚

Spring MVC é€šè¿‡ `LocaleResolver` æ¥è‡ªåŠ¨ä» `HttpServletRequest` ä¸­è·å– `Locale`ã€‚æœ‰å¤šç§ `LocaleResolver` çš„å®ç°ç±»ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„æ˜¯ `CookieLocaleResolver`ï¼š

```
@Primary
@Bean
LocaleResolver createLocaleResolver() {
    var clr = new CookieLocaleResolver();
    clr.setDefaultLocale(Locale.ENGLISH);
    clr.setDefaultTimeZone(TimeZone.getDefault());
    return clr;
}
```

`CookieLocaleResolver` ä» `HttpServletRequest` ä¸­è·å– `Locale` æ—¶ï¼Œé¦–å…ˆæ ¹æ®ä¸€ä¸ªç‰¹å®šçš„ Cookie åˆ¤æ–­æ˜¯å¦æŒ‡å®šäº† `Locale`ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä» HTTP å¤´è·å–ï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œå°±è¿”å›é»˜è®¤çš„ `Locale`ã€‚

å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç½‘ç«™æ—¶ï¼Œ`CookieLocaleResolver` åªèƒ½ä» HTTP å¤´è·å– `Locale`ï¼Œå³ä½¿ç”¨æµè§ˆå™¨çš„é»˜è®¤è¯­è¨€ã€‚é€šå¸¸ç½‘ç«™ä¹Ÿå…è®¸ç”¨æˆ·è‡ªå·±é€‰æ‹©è¯­è¨€ï¼Œæ­¤æ—¶ï¼Œ`CookieLocaleResolver` å°±ä¼šæŠŠç”¨æˆ·é€‰æ‹©çš„è¯­è¨€å­˜æ”¾åˆ° Cookie ä¸­ï¼Œä¸‹ä¸€æ¬¡è®¿é—®æ—¶ï¼Œå°±ä¼šè¿”å›ç”¨æˆ·ä¸Šæ¬¡é€‰æ‹©çš„è¯­è¨€è€Œä¸æ˜¯æµè§ˆå™¨é»˜è®¤è¯­è¨€ã€‚

### æå–èµ„æºæ–‡ä»¶

ç¬¬äºŒæ­¥æ˜¯æŠŠå†™æ­»åœ¨æ¨¡æ¿ä¸­çš„å­—ç¬¦ä¸²ä»¥èµ„æºæ–‡ä»¶çš„æ–¹å¼å­˜å‚¨åœ¨å¤–éƒ¨ã€‚å¯¹äºå¤šè¯­è¨€ï¼Œä¸»æ–‡ä»¶åå¦‚æœå‘½åä¸º `messages`ï¼Œé‚£ä¹ˆèµ„æºæ–‡ä»¶å¿…é¡»æŒ‰å¦‚ä¸‹æ–¹å¼å‘½åå¹¶æ”¾å…¥ classpath ä¸­ï¼š

- é»˜è®¤è¯­è¨€ï¼Œæ–‡ä»¶åå¿…é¡»ä¸º `messages.properties`ï¼›
- ç®€ä½“ä¸­æ–‡ï¼ŒLocale æ˜¯ `zh_CN`ï¼Œæ–‡ä»¶åå¿…é¡»ä¸º `messages_zh_CN.properties`ï¼›
- æ—¥æ–‡ï¼ŒLocale æ˜¯ `ja_JP`ï¼Œæ–‡ä»¶åå¿…é¡»ä¸º `messages_ja_JP.properties`ï¼›
- å…¶å®ƒæ›´å¤šè¯­è¨€â€¦â€¦

æ¯ä¸ªèµ„æºæ–‡ä»¶éƒ½æœ‰ç›¸åŒçš„ keyï¼Œä¾‹å¦‚ï¼Œé»˜è®¤è¯­è¨€æ˜¯è‹±æ–‡ï¼Œæ–‡ä»¶ `messages.properties` å†…å®¹å¦‚ä¸‹ï¼š

```
language.select=Language
home=Home
signin=Sign In
copyright=CopyrightÂ©{0,number,#}
```

æ–‡ä»¶ `messages_zh_CN.properties` å†…å®¹å¦‚ä¸‹ï¼š

```
language.select = è¯­è¨€
home = é¦–é¡µ
signin = ç™»å½•
copyright = ç‰ˆæƒæ‰€æœ‰ Â©{0,number,#}
```

### åˆ›å»º MessageSource

ç¬¬ä¸‰æ­¥æ˜¯åˆ›å»ºä¸€ä¸ª Spring æä¾›çš„ `MessageSource` å®ä¾‹ï¼Œå®ƒè‡ªåŠ¨è¯»å–æ‰€æœ‰çš„ `.properties` æ–‡ä»¶ï¼Œå¹¶æä¾›ä¸€ä¸ªç»Ÿä¸€æ¥å£æ¥å®ç° â€œç¿»è¯‘â€ï¼š

```
// code, arguments, locale:
String text = messageSource.getMessage("signin", null, locale);
```

å…¶ä¸­ï¼Œ`signin` æ˜¯æˆ‘ä»¬åœ¨ `.properties` æ–‡ä»¶ä¸­å®šä¹‰çš„ keyï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ `Object[]` æ•°ç»„ä½œä¸ºæ ¼å¼åŒ–æ—¶ä¼ å…¥çš„å‚æ•°ï¼Œæœ€åä¸€ä¸ªå‚æ•°å°±æ˜¯è·å–çš„ç”¨æˆ· `Locale` å®ä¾‹ã€‚

åˆ›å»º `MessageSource` å¦‚ä¸‹ï¼š

```
@Bean("i18n")
MessageSource createMessageSource() {
    var messageSource = new ResourceBundleMessageSource();
    // æŒ‡å®šæ–‡ä»¶æ˜¯ UTF-8 ç¼–ç :
    messageSource.setDefaultEncoding("UTF-8");
    // æŒ‡å®šä¸»æ–‡ä»¶å:
    messageSource.setBasename("messages");
    return messageSource;
}
```

æ³¨æ„åˆ° `ResourceBundleMessageSource` ä¼šè‡ªåŠ¨æ ¹æ®ä¸»æ–‡ä»¶åè‡ªåŠ¨æŠŠæ‰€æœ‰ç›¸å…³è¯­è¨€çš„èµ„æºæ–‡ä»¶éƒ½è¯»è¿›æ¥ã€‚

å†æ³¨æ„åˆ° Spring å®¹å™¨ä¼šåˆ›å»ºä¸åªä¸€ä¸ª `MessageSource` å®ä¾‹ï¼Œæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„è¿™ä¸ª `MessageSource` æ˜¯ä¸“é—¨ç»™é¡µé¢å›½é™…åŒ–ä½¿ç”¨çš„ï¼Œå› æ­¤å‘½åä¸º `i18n`ï¼Œä¸ä¼šä¸å…¶å®ƒ `MessageSource` å®ä¾‹å†²çªã€‚

### å®ç°å¤šè¯­è¨€

è¦åœ¨ View ä¸­ä½¿ç”¨ `MessageSource` åŠ ä¸Š `Locale` è¾“å‡ºå¤šè¯­è¨€ï¼Œæˆ‘ä»¬é€šè¿‡ç¼–å†™ä¸€ä¸ª `MvcInterceptor`ï¼ŒæŠŠç›¸å…³èµ„æºæ³¨å…¥åˆ° `ModelAndView` ä¸­ï¼š

```
@Component
public class MvcInterceptor implements HandlerInterceptor {
    @Autowired
    LocaleResolver localeResolver;

    // æ³¨æ„æ³¨å…¥çš„ MessageSource åç§°æ˜¯ i18n:
    @Autowired
    @Qualifier("i18n")
    MessageSource messageSource;

    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        if (modelAndView != null // è¿”å›äº† ModelAndView
            && modelAndView.getViewName() != null // è®¾ç½®äº† View
            && !modelAndView.getViewName().startsWith("redirect:") // ä¸æ˜¯é‡å®šå‘
        ) {
            // è§£æç”¨æˆ·çš„ Locale:
            Locale locale = localeResolver.resolveLocale(request);
            // æ”¾å…¥ Model:
            modelAndView.addObject("__messageSource__", messageSource);
            modelAndView.addObject("__locale__", locale);
        }
    }
}
```

ä¸è¦å¿˜äº†åœ¨ `WebMvcConfigurer` ä¸­æ³¨å†Œ `MvcInterceptor`ã€‚ç°åœ¨ï¼Œå°±å¯ä»¥åœ¨ View ä¸­è°ƒç”¨ `MessageSource.getMessage()` æ–¹æ³•æ¥å®ç°å¤šè¯­è¨€ï¼š

```
<a href="/signin">{{ __messageSource__.getMessage('signin', null, __locale__) }}</a>
```

ä¸Šè¿°è¿™ç§å†™æ³•è™½ç„¶å¯è¡Œï¼Œä½†æ ¼å¼å¤ªå¤æ‚äº†ã€‚ä½¿ç”¨ View æ—¶ï¼Œè¦æ ¹æ®æ¯ä¸ªç‰¹å®šçš„ View å¼•æ“å®šåˆ¶å›½é™…åŒ–å‡½æ•°ã€‚åœ¨ Pebble ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°è£…ä¸€ä¸ªå›½é™…åŒ–å‡½æ•°ï¼Œåç§°å°±æ˜¯ä¸‹åˆ’çº¿ `_`ï¼Œæ”¹é€ ä¸€ä¸‹åˆ›å»º `ViewResolver` çš„ä»£ç ï¼š

```
@Bean
ViewResolver createViewResolver(@Autowired ServletContext servletContext, @Autowired @Qualifier("i18n") MessageSource messageSource) {
    var engine = new PebbleEngine.Builder()
            .autoEscaping(true)
            .cacheActive(false)
            .loader(new Servlet5Loader(servletContext))
            // æ·»åŠ æ‰©å±•:
            .extension(createExtension(messageSource))
            .build();
    var viewResolver = new PebbleViewResolver();
    viewResolver.setPrefix("/WEB-INF/templates/");
    viewResolver.setSuffix("");
    viewResolver.setPebbleEngine(engine);
    return viewResolver;
}

private Extension createExtension(MessageSource messageSource) {
    return new AbstractExtension() {
        @Override
        public Map<String, Function> getFunctions() {
            return Map.of("_", new Function() {
                public Object execute(Map<String, Object> args, PebbleTemplate self, EvaluationContext context, int lineNumber) {
                    String key = (String) args.get("0");
                    List<Object> arguments = this.extractArguments(args);
                    Locale locale = (Locale) context.getVariable("__locale__");
                    return messageSource.getMessage(key, arguments.toArray(), "???" + key + "???", locale);
                }
                private List<Object> extractArguments(Map<String, Object> args) {
                    int i = 1;
                    List<Object> arguments = new ArrayList<>();
                    while (args.containsKey(String.valueOf(i))) {
                        Object param = args.get(String.valueOf(i));
                        arguments.add(param);
                        i++;
                    }
                    return arguments;
                }
                public List<String> getArgumentNames() {
                    return null;
                }
            });
        }
    };
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå¤šè¯­è¨€é¡µé¢æ”¹å†™ä¸ºï¼š

```
<a href="/signin">{{ _('signin') }}</a>
```

å¦‚æœæ˜¯å¸¦å‚æ•°çš„å¤šè¯­è¨€ï¼Œéœ€è¦æŠŠå‚æ•°ä¼ è¿›å»ï¼š

```
<h5>{{ _('copyright', 2020) }}</h5>
```

ä½¿ç”¨å…¶å®ƒ View å¼•æ“æ—¶ï¼Œä¹Ÿåº”å½“æ ¹æ®å¼•æ“æ¥å£å®ç°æ›´æ–¹ä¾¿çš„è¯­æ³•ã€‚

### åˆ‡æ¢ Locale

æœ€åï¼Œæˆ‘ä»¬éœ€è¦å…è®¸ç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢ `Locale`ï¼Œç¼–å†™ä¸€ä¸ª `LocaleController` æ¥å®ç°è¯¥åŠŸèƒ½ï¼š

```
@Controller
public class LocaleController {
    final Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    LocaleResolver localeResolver;

    @GetMapping("/locale/{lo}")
    public String setLocale(@PathVariable("lo") String lo, HttpServletRequest request, HttpServletResponse response) {
        // æ ¹æ®ä¼ å…¥çš„ lo åˆ›å»º Locale å®ä¾‹:
        Locale locale = null;
        int pos = lo.indexOf('_');
        if (pos> 0) {
            String lang = lo.substring(0, pos);
            String country = lo.substring(pos + 1);
            locale = new Locale(lang, country);
        } else {
            locale = new Locale(lo);
        }
        // è®¾å®šæ­¤ Locale:
        localeResolver.setLocale(request, response, locale);
        logger.info("locale is set to {}.", locale);
        // åˆ·æ–°é¡µé¢:
        String referer = request.getHeader("Referer");
        return "redirect:" + (referer == null ? "/" : referer);
    }
}
```

åœ¨é¡µé¢è®¾è®¡ä¸­ï¼Œé€šå¸¸åœ¨å³ä¸Šè§’ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªè¯­è¨€é€‰æ‹©åˆ—è¡¨ï¼Œæ¥çœ‹çœ‹æ•ˆæœï¼š

![i18n-en](./assets/l-20231221154408761.png)

åˆ‡æ¢åˆ°ä¸­æ–‡ï¼š

![i18n-zh-cn](./assets/l-20231221154408728.png)

### ç»ƒä¹ 


### å°ç»“

å¤šè¯­è¨€æ”¯æŒéœ€è¦ä» HTTP è¯·æ±‚ä¸­è§£æç”¨æˆ·çš„ Localeï¼Œç„¶åé’ˆå¯¹ä¸åŒ Locale æ˜¾ç¤ºä¸åŒçš„è¯­è¨€ï¼›

Spring MVC åº”ç”¨ç¨‹åºé€šè¿‡ `MessageSource` å’Œ `LocaleResolver`ï¼Œé…åˆ View å®ç°å›½é™…åŒ–ã€‚



## ğŸ€ å¼‚æ­¥å¤„ç†


åœ¨ Servlet æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç”±æŸä¸ªçº¿ç¨‹å¤„ç†ï¼Œç„¶åï¼Œå°†å“åº”å†™å…¥ IO æµï¼Œå‘é€ç»™å®¢æˆ·ç«¯ã€‚ä»å¼€å§‹å¤„ç†è¯·æ±‚ï¼Œåˆ°å†™å…¥å“åº”å®Œæˆï¼Œéƒ½æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†çš„ã€‚

å®ç° Servlet å®¹å™¨çš„æ—¶å€™ï¼Œåªè¦æ¯å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹å¤„ç†å®ƒï¼Œå°±èƒ½ä¿è¯æ­£ç¡®å®ç°äº† Servlet çº¿ç¨‹æ¨¡å‹ã€‚åœ¨å®é™…äº§å“ä¸­ï¼Œä¾‹å¦‚ Tomcatï¼Œæ€»æ˜¯é€šè¿‡çº¿ç¨‹æ± æ¥å¤„ç†è¯·æ±‚ï¼Œå®ƒä»ç„¶ç¬¦åˆä¸€ä¸ªè¯·æ±‚ä»å¤´åˆ°å°¾éƒ½ç”±æŸä¸€ä¸ªçº¿ç¨‹å¤„ç†ã€‚

è¿™ç§çº¿ç¨‹æ¨¡å‹éå¸¸é‡è¦ï¼Œå› ä¸º Spring çš„ JDBC äº‹åŠ¡æ˜¯åŸºäº `ThreadLocal` å®ç°çš„ï¼Œå¦‚æœåœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä¸€ä¼šç”±çº¿ç¨‹ A å¤„ç†ï¼Œä¸€ä¼šåˆç”±çº¿ç¨‹ B å¤„ç†ï¼Œé‚£äº‹åŠ¡å°±å…¨ä¹±å¥—äº†ã€‚æ­¤å¤–ï¼Œå¾ˆå¤šå®‰å…¨è®¤è¯ï¼Œä¹Ÿæ˜¯åŸºäº `ThreadLocal` å®ç°çš„ï¼Œå¯ä»¥ä¿è¯åœ¨å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œå„ä¸ªçº¿ç¨‹äº’ä¸å½±å“ã€‚

ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªè¯·æ±‚å¤„ç†çš„æ—¶é—´è¾ƒé•¿ï¼Œä¾‹å¦‚å‡ ç§’é’Ÿç”šè‡³æ›´é•¿ï¼Œé‚£ä¹ˆï¼Œè¿™ç§åŸºäºçº¿ç¨‹æ± çš„åŒæ­¥æ¨¡å‹å¾ˆå¿«å°±ä¼šæŠŠæ‰€æœ‰çº¿ç¨‹è€—å°½ï¼Œå¯¼è‡´æœåŠ¡å™¨æ— æ³•å“åº”æ–°çš„è¯·æ±‚ã€‚å¦‚æœæŠŠé•¿æ—¶é—´å¤„ç†çš„è¯·æ±‚æ”¹ä¸ºå¼‚æ­¥å¤„ç†ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± çš„åˆ©ç”¨ç‡å°±ä¼šå¤§å¤§æé«˜ã€‚Servlet ä» 3.0 è§„èŒƒå¼€å§‹æ·»åŠ äº†å¼‚æ­¥æ”¯æŒï¼Œå…è®¸å¯¹ä¸€ä¸ªè¯·æ±‚è¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ Spring MVC ä¸­å¦‚ä½•å®ç°å¯¹è¯·æ±‚è¿›è¡Œå¼‚æ­¥å¤„ç†çš„é€»è¾‘ã€‚é¦–å…ˆå»ºç«‹ä¸€ä¸ª Web å·¥ç¨‹ï¼Œç„¶åç¼–è¾‘ `web.xml` æ–‡ä»¶å¦‚ä¸‹ï¼š

```
<web-app>
    <display-name>Archetype Created Web Application</display-name>

    <servlet>
        <servlet-name>dispatcher</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <init-param>
            <param-name>contextClass</param-name>
            <param-value>org.springframework.web.context.support.AnnotationConfigWebApplicationContext</param-value>
        </init-param>
        <init-param>
            <param-name>contextConfigLocation</param-name>
            <param-value>com.itranswarp.learnjava.AppConfig</param-value>
        </init-param>
        <load-on-startup>0</load-on-startup>
        <async-supported>true</async-supported>
    </servlet>

    <servlet-mapping>
        <servlet-name>dispatcher</servlet-name>
        <url-pattern>/*</url-pattern>
    </servlet-mapping>
</web-app>
```

å’Œå‰é¢æ™®é€šçš„ MVC ç¨‹åºç›¸æ¯”ï¼Œè¿™ä¸ª `web.xml` ä¸»è¦å¯¹ `DispatcherServlet` çš„é…ç½®å¤šäº†ä¸€ä¸ª `<async-supported>`ï¼Œé»˜è®¤å€¼æ˜¯ `false`ï¼Œå¿…é¡»æ˜ç¡®å†™æˆ `true`ï¼Œè¿™æ · Servlet å®¹å™¨æ‰ä¼šæ”¯æŒ async å¤„ç†ã€‚

ä¸‹ä¸€æ­¥å°±æ˜¯åœ¨ Controller ä¸­ç¼–å†™ async å¤„ç†é€»è¾‘ã€‚æˆ‘ä»¬ä»¥ `ApiController` ä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•å¼‚æ­¥å¤„ç†è¯·æ±‚ã€‚

ç¬¬ä¸€ç§ async å¤„ç†æ–¹å¼æ˜¯è¿”å›ä¸€ä¸ª `Callable`ï¼ŒSpring MVC è‡ªåŠ¨æŠŠè¿”å›çš„ `Callable` æ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œï¼Œç­‰å¾…ç»“æœè¿”å›åå†å†™å…¥å“åº”ï¼š

```
@GetMapping("/users")
public Callable<List<User>> users() {
    return () -> {
        // æ¨¡æ‹Ÿ 3 ç§’è€—æ—¶:
        try {
            Thread.sleep(3000);
        } catch (InterruptedException e) {
        }
        return userService.getUsers();
    };
}
```

ç¬¬äºŒç§ async å¤„ç†æ–¹å¼æ˜¯è¿”å›ä¸€ä¸ª `DeferredResult` å¯¹è±¡ï¼Œç„¶ååœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œè®¾ç½®æ­¤å¯¹è±¡çš„å€¼å¹¶å†™å…¥å“åº”ï¼š

```
@GetMapping("/users/{id}")
public DeferredResult<User> user(@PathVariable("id") long id) {
    DeferredResult<User> result = new DeferredResult<>(3000L); // 3 ç§’è¶…æ—¶
    new Thread(() -> {
        // ç­‰å¾… 1 ç§’:
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
        }
        try {
            User user = userService.getUserById(id);
            // è®¾ç½®æ­£å¸¸ç»“æœå¹¶ç”± Spring MVC å†™å…¥ Response:
            result.setResult(user);
        } catch (Exception e) {
            // è®¾ç½®é”™è¯¯ç»“æœå¹¶ç”± Spring MVC å†™å…¥ Response:
            result.setErrorResult(Map.of("error", e.getClass().getSimpleName(), "message", e.getMessage()));
        }
    }).start();
    return result;
}
```

ä½¿ç”¨ `DeferredResult` æ—¶ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶ï¼Œè¶…æ—¶ä¼šè‡ªåŠ¨è¿”å›è¶…æ—¶é”™è¯¯å“åº”ã€‚åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå¯ä»¥è°ƒç”¨ `setResult()` å†™å…¥ç»“æœï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ `setErrorResult()` å†™å…¥ä¸€ä¸ªé”™è¯¯ç»“æœã€‚

è¿è¡Œç¨‹åºï¼Œå½“æˆ‘ä»¬è®¿é—® `http://localhost:8080/api/users/1` æ—¶ï¼Œå‡å®šç”¨æˆ·å­˜åœ¨ï¼Œåˆ™æµè§ˆå™¨åœ¨ 1 ç§’åè¿”å›ç»“æœï¼š

![deferred-result-ok](./assets/l-20231221154445746.png)

è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„ User IDï¼Œåˆ™ç­‰å¾… 1 ç§’åè¿”å›é”™è¯¯ç»“æœï¼š

![deferred-result-error](./assets/l-20231221154445845.png)

### ä½¿ç”¨ Filter

å½“æˆ‘ä»¬ä½¿ç”¨ async æ¨¡å¼å¤„ç†è¯·æ±‚æ—¶ï¼ŒåŸæœ‰çš„ Filter ä¹Ÿå¯ä»¥å·¥ä½œï¼Œä½†æˆ‘ä»¬å¿…é¡»åœ¨ `web.xml` ä¸­æ·»åŠ  `<async-supported>` å¹¶è®¾ç½®ä¸º `true`ã€‚æˆ‘ä»¬ç”¨ä¸¤ä¸ª Filterï¼šSyncFilter å’Œ AsyncFilter åˆ†åˆ«æµ‹è¯•ï¼š

```
<web-app ...>
    ...
    <filter>
        <filter-name>sync-filter</filter-name>
        <filter-class>com.itranswarp.learnjava.web.SyncFilter</filter-class>
    </filter>

    <filter>
        <filter-name>async-filter</filter-name>
        <filter-class>com.itranswarp.learnjava.web.AsyncFilter</filter-class>
        <async-supported>true</async-supported>
    </filter>

    <filter-mapping>
        <filter-name>sync-filter</filter-name>
        <url-pattern>/api/version</url-pattern>
    </filter-mapping>

    <filter-mapping>
        <filter-name>async-filter</filter-name>
        <url-pattern>/api/*</url-pattern>
    </filter-mapping>
    ...
</web-app>
```

ä¸€ä¸ªå£°æ˜ä¸ºæ”¯æŒ `<async-supported>` çš„ Filter æ—¢å¯ä»¥è¿‡æ»¤ async å¤„ç†è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥è¿‡æ»¤æ­£å¸¸çš„åŒæ­¥å¤„ç†è¯·æ±‚ï¼Œè€Œæœªå£°æ˜ `<async-supported>` çš„ Filter æ— æ³•æ”¯æŒ async è¯·æ±‚ï¼Œå¦‚æœä¸€ä¸ªæ™®é€šçš„ Filter é‡åˆ° async è¯·æ±‚æ—¶ï¼Œä¼šç›´æ¥æŠ¥é”™ï¼Œå› æ­¤ï¼ŒåŠ¡å¿…æ³¨æ„æ™®é€š Filter çš„ `<url-pattern>` ä¸è¦åŒ¹é… async è¯·æ±‚è·¯å¾„ã€‚

åœ¨ `logback.xml` é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æŠŠè¾“å‡ºæ ¼å¼åŠ ä¸Š `[%thread]`ï¼Œå¯ä»¥è¾“å‡ºå½“å‰çº¿ç¨‹çš„åç§°ï¼š

```
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <layout class="ch.qos.logback.classic.PatternLayout">
            <Pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</Pattern>
        </layout>
    </appender>
    ...
</configuration>
```

å¯¹äºåŒæ­¥è¯·æ±‚ï¼Œä¾‹å¦‚ `/api/version`ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```
2020-05-16 11:22:40 [http-nio-8080-exec-1] INFO  c.i.learnjava.web.SyncFilter - start SyncFilter...
2020-05-16 11:22:40 [http-nio-8080-exec-1] INFO  c.i.learnjava.web.AsyncFilter - start AsyncFilter...
2020-05-16 11:22:40 [http-nio-8080-exec-1] INFO  c.i.learnjava.web.ApiController - get version...
2020-05-16 11:22:40 [http-nio-8080-exec-1] INFO  c.i.learnjava.web.AsyncFilter - end AsyncFilter.
2020-05-16 11:22:40 [http-nio-8080-exec-1] INFO  c.i.learnjava.web.SyncFilter - end SyncFilter.
```

å¯è§ï¼Œæ¯ä¸ª Filter å’Œ `ApiController` éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚

å¯¹äºå¼‚æ­¥è¯·æ±‚ï¼Œä¾‹å¦‚ `/api/users`ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```
2020-05-16 11:23:49 [http-nio-8080-exec-4] INFO  c.i.learnjava.web.AsyncFilter - start AsyncFilter...
2020-05-16 11:23:49 [http-nio-8080-exec-4] INFO  c.i.learnjava.web.ApiController - get users...
2020-05-16 11:23:49 [http-nio-8080-exec-4] INFO  c.i.learnjava.web.AsyncFilter - end AsyncFilter.
2020-05-16 11:23:52 [MvcAsync1] INFO  c.i.learnjava.web.ApiController - return users...
```

å¯è§ï¼Œ`AsyncFilter` å’Œ `ApiController` æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ï¼Œä½†æ˜¯ï¼Œè¿”å›å“åº”çš„æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ã€‚

å¯¹ `DeferredResult` æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```
2020-05-16 11:25:24 [http-nio-8080-exec-8] INFO  c.i.learnjava.web.AsyncFilter - start AsyncFilter...
2020-05-16 11:25:24 [http-nio-8080-exec-8] INFO  c.i.learnjava.web.AsyncFilter - end AsyncFilter.
2020-05-16 11:25:25 [Thread-2] INFO  c.i.learnjava.web.ApiController - deferred result is set.
```

åŒæ ·ï¼Œè¿”å›å“åº”çš„æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ã€‚

åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œç»å¸¸ç”¨åˆ°çš„å°±æ˜¯ `DeferredResult`ï¼Œå› ä¸ºè¿”å› `DeferredResult` æ—¶ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶ã€æ­£å¸¸ç»“æœå’Œé”™è¯¯ç»“æœï¼Œæ˜“äºç¼–å†™æ¯”è¾ƒçµæ´»çš„é€»è¾‘ã€‚

ä½¿ç”¨ async å¼‚æ­¥å¤„ç†å“åº”æ—¶ï¼Œè¦æ—¶åˆ»ç‰¢è®°ï¼Œåœ¨å¦ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ä¸­çš„äº‹åŠ¡å’Œ Controller æ–¹æ³•ä¸­æ‰§è¡Œçš„äº‹åŠ¡ä¸æ˜¯åŒä¸€ä¸ªäº‹åŠ¡ï¼Œåœ¨ Controller ä¸­ç»‘å®šçš„ `ThreadLocal` ä¿¡æ¯ä¹Ÿæ— æ³•åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­è·å–ã€‚

æ­¤å¤–ï¼ŒServlet 3.0 è§„èŒƒæ·»åŠ çš„å¼‚æ­¥æ”¯æŒæ˜¯é’ˆå¯¹åŒæ­¥æ¨¡å‹æ‰“äº†ä¸€ä¸ª â€œè¡¥ä¸â€ï¼Œè™½ç„¶å¯ä»¥å¼‚æ­¥å¤„ç†è¯·æ±‚ï¼Œä½†é«˜å¹¶å‘å¼‚æ­¥è¯·æ±‚æ—¶ï¼Œå®ƒçš„å¤„ç†æ•ˆç‡å¹¶ä¸é«˜ï¼Œå› ä¸ºè¿™ç§å¼‚æ­¥æ¨¡å‹å¹¶æ²¡æœ‰ç”¨åˆ°çœŸæ­£çš„â€œåŸç”Ÿâ€ å¼‚æ­¥ã€‚Java æ ‡å‡†åº“æä¾›äº†å°è£…æ“ä½œç³»ç»Ÿçš„å¼‚æ­¥ IO åŒ… `java.nio`ï¼Œæ˜¯çœŸæ­£çš„å¤šè·¯å¤ç”¨ IO æ¨¡å‹ï¼Œå¯ä»¥ç”¨å°‘é‡çº¿ç¨‹æ”¯æŒå¤§é‡å¹¶å‘ã€‚ä½¿ç”¨ NIO ç¼–ç¨‹å¤æ‚åº¦æ¯”åŒæ­¥ IO é«˜å¾ˆå¤šï¼Œå› æ­¤æˆ‘ä»¬å¾ˆå°‘ç›´æ¥ä½¿ç”¨ NIOã€‚ç›¸åï¼Œå¤§éƒ¨åˆ†éœ€è¦é«˜æ€§èƒ½å¼‚æ­¥ IO çš„åº”ç”¨ç¨‹åºä¼šé€‰æ‹© [Netty](https://netty.io/) è¿™æ ·çš„æ¡†æ¶ï¼Œå®ƒåŸºäº NIO æä¾›äº†æ›´æ˜“äºä½¿ç”¨çš„ APIï¼Œæ–¹ä¾¿å¼€å‘å¼‚æ­¥åº”ç”¨ç¨‹åºã€‚

### ç»ƒä¹ 


### å°ç»“

åœ¨ Spring MVC ä¸­å¼‚æ­¥å¤„ç†è¯·æ±‚éœ€è¦æ­£ç¡®é…ç½® `web.xml`ï¼Œå¹¶è¿”å› `Callable` æˆ– `DeferredResult` å¯¹è±¡ã€‚



## ğŸ€ ä½¿ç”¨ WebSocket


WebSocket æ˜¯ä¸€ç§åŸºäº HTTP çš„é•¿é“¾æ¥æŠ€æœ¯ã€‚ä¼ ç»Ÿçš„ HTTP åè®®æ˜¯ä¸€ç§è¯·æ±‚ - å“åº”æ¨¡å‹ï¼Œå¦‚æœæµè§ˆå™¨ä¸å‘é€è¯·æ±‚ï¼Œé‚£ä¹ˆæœåŠ¡å™¨æ— æ³•ä¸»åŠ¨ç»™æµè§ˆå™¨æ¨é€æ•°æ®ã€‚å¦‚æœéœ€è¦å®šæœŸç»™æµè§ˆå™¨æ¨é€æ•°æ®ï¼Œä¾‹å¦‚è‚¡ç¥¨è¡Œæƒ…ï¼Œæˆ–è€…ä¸å®šæœŸç»™æµè§ˆå™¨æ¨é€æ•°æ®ï¼Œä¾‹å¦‚åœ¨çº¿èŠå¤©ï¼ŒåŸºäº HTTP åè®®å®ç°è¿™ç±»éœ€æ±‚ï¼Œåªèƒ½ä¾é æµè§ˆå™¨çš„ JavaScript å®šæ—¶è½®è¯¢ï¼Œæ•ˆç‡å¾ˆä½ä¸”å®æ—¶æ€§ä¸é«˜ã€‚

å› ä¸º HTTP æœ¬èº«æ˜¯åŸºäº TCP è¿æ¥çš„ï¼Œæ‰€ä»¥ï¼ŒWebSocket åœ¨ HTTP åè®®çš„åŸºç¡€ä¸Šåšäº†ä¸€ä¸ªç®€å•çš„å‡çº§ï¼Œå³å»ºç«‹ TCP è¿æ¥åï¼Œæµè§ˆå™¨å‘é€è¯·æ±‚æ—¶ï¼Œé™„å¸¦å‡ ä¸ªå¤´ï¼š

```
GET /chat HTTP/1.1
Host: www.example.com
Upgrade: websocket
Connection: Upgrade
```

å°±è¡¨ç¤ºå®¢æˆ·ç«¯å¸Œæœ›å‡çº§è¿æ¥ï¼Œå˜æˆé•¿è¿æ¥çš„ WebSocketï¼ŒæœåŠ¡å™¨è¿”å›å‡çº§æˆåŠŸçš„å“åº”ï¼š

```
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
```

æ”¶åˆ°æˆåŠŸå“åº”åè¡¨ç¤º WebSocketâ€œæ¡æ‰‹â€ æˆåŠŸï¼Œè¿™æ ·ï¼Œä»£è¡¨ WebSocket çš„è¿™ä¸ª TCP è¿æ¥å°†ä¸ä¼šè¢«æœåŠ¡å™¨å…³é—­ï¼Œè€Œæ˜¯ä¸€ç›´ä¿æŒï¼ŒæœåŠ¡å™¨å¯éšæ—¶å‘æµè§ˆå™¨æ¨é€æ¶ˆæ¯ï¼Œæµè§ˆå™¨ä¹Ÿå¯éšæ—¶å‘æœåŠ¡å™¨æ¨é€æ¶ˆæ¯ã€‚åŒæ–¹æ¨é€çš„æ¶ˆæ¯æ—¢å¯ä»¥æ˜¯æ–‡æœ¬æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥æ˜¯äºŒè¿›åˆ¶æ¶ˆæ¯ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œç»å¤§éƒ¨åˆ†åº”ç”¨ç¨‹åºä¼šæ¨é€åŸºäº JSON çš„æ–‡æœ¬æ¶ˆæ¯ã€‚

ç°ä»£æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒ WebSocket åè®®ï¼ŒæœåŠ¡å™¨åˆ™éœ€è¦åº•å±‚æ¡†æ¶æ”¯æŒã€‚Java çš„ Servlet è§„èŒƒä» 3.1 å¼€å§‹æ”¯æŒ WebSocketï¼Œæ‰€ä»¥ï¼Œå¿…é¡»é€‰æ‹©æ”¯æŒ Servlet 3.1 æˆ–æ›´é«˜è§„èŒƒçš„ Servlet å®¹å™¨ï¼Œæ‰èƒ½æ”¯æŒ WebSocketã€‚æœ€æ–°ç‰ˆæœ¬çš„ Tomcatã€Jetty ç­‰å¼€æºæœåŠ¡å™¨å‡æ”¯æŒ WebSocketã€‚

æˆ‘ä»¬ä»¥å®é™…ä»£ç æ¼”ç¤ºå¦‚ä½•åœ¨ Spring MVC ä¸­å®ç°å¯¹ WebSocket çš„æ”¯æŒã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `pom.xml` ä¸­åŠ å…¥ä»¥ä¸‹ä¾èµ–ï¼š

- org.apache.tomcat.embed:tomcat-embed-websocket:10.1.1
- org.springframework:spring-websocket:6.0.0

ç¬¬ä¸€é¡¹æ˜¯åµŒå…¥å¼ Tomcat æ”¯æŒ WebSocket çš„ç»„ä»¶ï¼Œç¬¬äºŒé¡¹æ˜¯ Spring å°è£…çš„æ”¯æŒ WebSocket çš„æ¥å£ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ AppConfig ä¸­åŠ å…¥ Spring Web å¯¹ WebSocket çš„é…ç½®ï¼Œæ­¤å¤„æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª `WebSocketConfigurer` å®ä¾‹ï¼š

```
@Bean
WebSocketConfigurer createWebSocketConfigurer(
        @Autowired ChatHandler chatHandler,
        @Autowired ChatHandshakeInterceptor chatInterceptor)
{
    return new WebSocketConfigurer() {
        public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
            // æŠŠ URL ä¸æŒ‡å®šçš„ WebSocketHandler å…³è”ï¼Œå¯å…³è”å¤šä¸ª:
            registry.addHandler(chatHandler, "/chat").addInterceptors(chatInterceptor);
        }
    };
}
```

æ­¤å®ä¾‹åœ¨å†…éƒ¨é€šè¿‡ `WebSocketHandlerRegistry` æ³¨å†Œèƒ½å¤„ç† WebSocket çš„ `WebSocketHandler`ï¼Œä»¥åŠå¯é€‰çš„ WebSocket æ‹¦æˆªå™¨ `HandshakeInterceptor`ã€‚æˆ‘ä»¬æ³¨å…¥çš„è¿™ä¸¤ä¸ªç±»éƒ½æ˜¯è‡ªå·±ç¼–å†™çš„ä¸šåŠ¡é€»è¾‘ï¼Œåé¢æˆ‘ä»¬è¯¦ç»†è®¨è®ºå¦‚ä½•ç¼–å†™å®ƒä»¬ï¼Œè¿™é‡Œåªéœ€å…³æ³¨æµè§ˆå™¨è¿æ¥åˆ° WebSocket çš„ URL æ˜¯ `/chat`ã€‚

### å¤„ç† WebSocket è¿æ¥

å’Œå¤„ç†æ™®é€š HTTP è¯·æ±‚ä¸åŒï¼Œæ²¡æ³•ç”¨ä¸€ä¸ªæ–¹æ³•å¤„ç†ä¸€ä¸ª URLã€‚Spring æä¾›äº† `TextWebSocketHandler` å’Œ `BinaryWebSocketHandler` åˆ†åˆ«å¤„ç†æ–‡æœ¬æ¶ˆæ¯å’ŒäºŒè¿›åˆ¶æ¶ˆæ¯ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©æ–‡æœ¬æ¶ˆæ¯ä½œä¸ºèŠå¤©å®¤çš„åè®®ï¼Œå› æ­¤ï¼Œ`ChatHandler` éœ€è¦ç»§æ‰¿è‡ª `TextWebSocketHandler`ï¼š

```
@Component
public class ChatHandler extends TextWebSocketHandler {
    ...
}
```

å½“æµè§ˆå™¨è¯·æ±‚ä¸€ä¸ª WebSocket è¿æ¥åï¼Œå¦‚æœæˆåŠŸå»ºç«‹è¿æ¥ï¼ŒSpring ä¼šè‡ªåŠ¨è°ƒç”¨ `afterConnectionEstablished()` æ–¹æ³•ï¼Œä»»ä½•åŸå› å¯¼è‡´ WebSocket è¿æ¥ä¸­æ–­æ—¶ï¼ŒSpring ä¼šè‡ªåŠ¨è°ƒç”¨ `afterConnectionClosed` æ–¹æ³•ï¼Œå› æ­¤ï¼Œè¦†å†™è¿™ä¸¤ä¸ªæ–¹æ³•å³å¯å¤„ç†è¿æ¥æˆåŠŸå’Œç»“æŸåçš„ä¸šåŠ¡é€»è¾‘ï¼š

```
@Component
public class ChatHandler extends TextWebSocketHandler {
    // ä¿å­˜æ‰€æœ‰ Client çš„ WebSocket ä¼šè¯å®ä¾‹:
    private Map<String, WebSocketSession> clients = new ConcurrentHashMap<>();

    @Override
    public void afterConnectionEstablished(WebSocketSession session) throws Exception {
        // æ–°ä¼šè¯æ ¹æ® ID æ”¾å…¥ Map:
        clients.put(session.getId(), session);
        session.getAttributes().put("name", "Guest1");
    }

    @Override
    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) throws Exception {
        clients.remove(session.getId());
    }
}
```

æ¯ä¸ª WebSocket ä¼šè¯ä»¥ `WebSocketSession` è¡¨ç¤ºï¼Œä¸”å·²åˆ†é…å”¯ä¸€ IDã€‚å’Œ WebSocket ç›¸å…³çš„æ•°æ®ï¼Œä¾‹å¦‚ç”¨æˆ·åç§°ç­‰ï¼Œå‡å¯æ”¾å…¥å…³è”çš„ `getAttributes()` ä¸­ã€‚

ç”¨å®ä¾‹å˜é‡ `clients` æŒæœ‰å½“å‰æ‰€æœ‰çš„ `WebSocketSession` æ˜¯ä¸ºäº†å¹¿æ’­ï¼Œå³å‘æ‰€æœ‰ç”¨æˆ·æ¨é€åŒä¸€æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼š

```
String json = ...
TextMessage message = new TextMessage(json);
for (String id : clients.keySet()) {
    WebSocketSession session = clients.get(id);
    session.sendMessage(message);
}
```

æˆ‘ä»¬å‘é€çš„æ¶ˆæ¯æ˜¯åºåˆ—åŒ–åçš„ JSONï¼Œå¯ä»¥ç”¨ `ChatMessage` è¡¨ç¤ºï¼š

```
public class ChatMessage {
	public long timestamp;
	public String name;
    public String text;
}
```

æ¯æ”¶åˆ°ä¸€ä¸ªç”¨æˆ·çš„æ¶ˆæ¯åï¼Œæˆ‘ä»¬å°±éœ€è¦å¹¿æ’­ç»™æ‰€æœ‰ç”¨æˆ·ï¼š

```
@Component
public class ChatHandler extends TextWebSocketHandler {
    ...
    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
        String s = message.getPayload();
        String r = ... // æ ¹æ®è¾“å…¥æ¶ˆæ¯æ„é€ å¾…å‘é€æ¶ˆæ¯
        broadcastMessage(r); // æ¨é€ç»™æ‰€æœ‰ç”¨æˆ·
    }
}
```

å¦‚æœè¦æ¨é€ç»™æŒ‡å®šçš„å‡ ä¸ªç”¨æˆ·ï¼Œé‚£å°±éœ€è¦åœ¨ `clients` ä¸­æ ¹æ®æ¡ä»¶æŸ¥æ‰¾å‡ºæŸäº› `WebSocketSession`ï¼Œç„¶åå‘é€æ¶ˆæ¯ã€‚

æ³¨æ„åˆ°æˆ‘ä»¬åœ¨æ³¨å†Œ WebSocket æ—¶è¿˜ä¼ å…¥äº†ä¸€ä¸ª `ChatHandshakeInterceptor`ï¼Œè¿™ä¸ªç±»å®é™…ä¸Šå¯ä»¥ä» `HttpSessionHandshakeInterceptor` ç»§æ‰¿ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ WebSocket å»ºç«‹è¿æ¥åï¼ŒæŠŠ HttpSession çš„ä¸€äº›å±æ€§å¤åˆ¶åˆ° WebSocketSessionï¼Œä¾‹å¦‚ï¼Œç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ç­‰ï¼š

```
@Component
public class ChatHandshakeInterceptor extends HttpSessionHandshakeInterceptor {
    public ChatHandshakeInterceptor() {
        // æŒ‡å®šä» HttpSession å¤åˆ¶å±æ€§åˆ° WebSocketSession:
        super(List.of(UserController.KEY_USER));
    }
}
```

è¿™æ ·ï¼Œåœ¨ `ChatHandler` ä¸­ï¼Œå¯ä»¥ä» `WebSocketSession.getAttributes()` ä¸­è·å–åˆ°å¤åˆ¶è¿‡æ¥çš„å±æ€§ã€‚

### å®¢æˆ·ç«¯å¼€å‘

åœ¨å®Œæˆäº†æœåŠ¡å™¨ç«¯çš„å¼€å‘åï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨é¡µé¢ç¼–å†™ä¸€ç‚¹ JavaScript é€»è¾‘ï¼š

```
// åˆ›å»º WebSocket è¿æ¥:
var ws = new WebSocket('ws://' + location.host + '/chat');
// è¿æ¥æˆåŠŸæ—¶:
ws.addEventListener('open', function (event) {
    console.log('websocket connected.');
});
// æ”¶åˆ°æ¶ˆæ¯æ—¶:
ws.addEventListener('message', function (event) {
    console.log('message:' + event.data);
    var msgs = JSON.parse(event.data);
    // TODO:
});
// è¿æ¥å…³é—­æ—¶:
ws.addEventListener('close', function () {
    console.log('websocket closed.');
});
// ç»‘å®šåˆ°å…¨å±€å˜é‡:
window.chatWs = ws;
```

ç”¨æˆ·å¯ä»¥åœ¨è¿æ¥æˆåŠŸåä»»ä½•æ—¶å€™ç»™æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼š

```
var inputText = 'Hello, WebSocket.';
window.chatWs.send(JSON.stringify({text: inputText}));
```

æœ€åï¼Œè¿è°ƒæµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯ï¼Œå¦‚æœä¸€åˆ‡æ— è¯¯ï¼Œå¯ä»¥å¼€å¤šä¸ªä¸åŒçš„æµè§ˆå™¨æµ‹è¯• WebSocket çš„æ¨é€å’Œå¹¿æ’­ï¼š

![chat](./assets/l-20231221154501285.png)

å’Œä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»çš„å¼‚æ­¥å¤„ç†ç±»ä¼¼ï¼ŒServlet çš„çº¿ç¨‹æ¨¡å‹å¹¶ä¸é€‚åˆå¤§è§„æ¨¡çš„é•¿é“¾æ¥ã€‚åŸºäº NIO çš„ Netty ç­‰æ¡†æ¶æ›´é€‚åˆå¤„ç† WebSocket é•¿é“¾æ¥ï¼Œæˆ‘ä»¬å°†åœ¨åé¢ä»‹ç»ã€‚

### ç»ƒä¹ 


### å°ç»“

åœ¨ Servlet ä¸­ä½¿ç”¨ WebSocket éœ€è¦ 3.1 åŠä»¥ä¸Šç‰ˆæœ¬ï¼›

é€šè¿‡ `spring-websocket` å¯ä»¥ç®€åŒ– WebSocket çš„å¼€å‘ã€‚
