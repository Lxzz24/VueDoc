---
title: è®¿é—®æ•°æ®åº“
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

- [â˜˜ï¸ ä½¿ç”¨ JDBC](#ä½¿ç”¨-JDBC)
- [â˜˜ï¸ ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡](#ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡)
- [â˜˜ï¸ ä½¿ç”¨ DAO](#ä½¿ç”¨-DAO)
- [â˜˜ï¸ é›†æˆ Hibernate](#é›†æˆ-Hibernate)
- [â˜˜ï¸ é›†æˆ JPA](#é›†æˆ-JPA)
- [â˜˜ï¸ é›†æˆ MyBatis](#é›†æˆ-MyBatis)
- [â˜˜ï¸ è®¾è®¡ ORM](#è®¾è®¡-ORM)


æ•°æ®åº“åŸºæœ¬ä¸Šæ˜¯ç°ä»£åº”ç”¨ç¨‹åºçš„æ ‡å‡†å­˜å‚¨ï¼Œç»å¤§å¤šæ•°ç¨‹åºéƒ½æŠŠè‡ªå·±çš„ä¸šåŠ¡æ•°æ®å­˜å‚¨åœ¨å…³ç³»æ•°æ®åº“ä¸­ï¼Œå¯è§ï¼Œè®¿é—®æ•°æ®åº“å‡ ä¹æ˜¯æ‰€æœ‰åº”ç”¨ç¨‹åºå¿…å¤‡èƒ½åŠ›ã€‚

æˆ‘ä»¬åœ¨å‰é¢å·²ç»ä»‹ç»äº† Java ç¨‹åºè®¿é—®æ•°æ®åº“çš„æ ‡å‡†æ¥å£ JDBCï¼Œå®ƒçš„å®ç°æ–¹å¼éå¸¸ç®€æ´ï¼Œå³ï¼šJava æ ‡å‡†åº“å®šä¹‰æ¥å£ï¼Œå„æ•°æ®åº“å‚å•†ä»¥ â€œé©±åŠ¨â€ çš„å½¢å¼å®ç°æ¥å£ã€‚åº”ç”¨ç¨‹åºè¦ä½¿ç”¨å“ªä¸ªæ•°æ®åº“ï¼Œå°±æŠŠè¯¥æ•°æ®åº“å‚å•†çš„é©±åŠ¨ä»¥ jar åŒ…å½¢å¼å¼•å…¥è¿›æ¥ï¼ŒåŒæ—¶è‡ªèº«ä»…ä½¿ç”¨ JDBC æ¥å£ï¼Œç¼–è¯‘æœŸå¹¶ä¸éœ€è¦ç‰¹å®šå‚å•†çš„é©±åŠ¨ã€‚

ä½¿ç”¨ JDBC è™½ç„¶ç®€å•ï¼Œä½†ä»£ç æ¯”è¾ƒç¹çã€‚Spring ä¸ºäº†ç®€åŒ–æ•°æ®åº“è®¿é—®ï¼Œä¸»è¦åšäº†ä»¥ä¸‹å‡ ç‚¹å·¥ä½œï¼š

- æä¾›äº†ç®€åŒ–çš„è®¿é—® JDBC çš„æ¨¡æ¿ç±»ï¼Œä¸å¿…æ‰‹åŠ¨é‡Šæ”¾èµ„æºï¼›
- æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ DAO ç±»ä»¥å®ç° Data Access Object æ¨¡å¼ï¼›
- æŠŠ `SQLException` å°è£…ä¸º `DataAccessException`ï¼Œè¿™ä¸ªå¼‚å¸¸æ˜¯ä¸€ä¸ª `RuntimeException`ï¼Œå¹¶ä¸”è®©æˆ‘ä»¬èƒ½åŒºåˆ† SQL å¼‚å¸¸çš„åŸå› ï¼Œä¾‹å¦‚ï¼Œ`DuplicateKeyException` è¡¨ç¤ºè¿åäº†ä¸€ä¸ªå”¯ä¸€çº¦æŸï¼›
- èƒ½æ–¹ä¾¿åœ°é›†æˆ Hibernateã€JPA å’Œ MyBatis è¿™äº›æ•°æ®åº“è®¿é—®æ¡†æ¶ã€‚

æœ¬ç« æˆ‘ä»¬å°†è¯¦ç»†è®²è§£åœ¨ Spring ä¸­è®¿é—®æ•°æ®åº“çš„æœ€ä½³å®è·µã€‚



## ğŸ€ ä½¿ç”¨ JDBC

æˆ‘ä»¬åœ¨å‰é¢ä»‹ç» [JDBC ç¼–ç¨‹](https://www.liaoxuefeng.com/wiki/1252599548343744/1255943820274272) æ—¶å·²ç»è®²è¿‡ï¼ŒJava ç¨‹åºä½¿ç”¨ JDBC æ¥å£è®¿é—®å…³ç³»æ•°æ®åº“çš„æ—¶å€™ï¼Œéœ€è¦ä»¥ä¸‹å‡ æ­¥ï¼š

- åˆ›å»ºå…¨å±€ `DataSource` å®ä¾‹ï¼Œè¡¨ç¤ºæ•°æ®åº“è¿æ¥æ± ï¼›
- åœ¨éœ€è¦è¯»å†™æ•°æ®åº“çš„æ–¹æ³•å†…éƒ¨ï¼ŒæŒ‰å¦‚ä¸‹æ­¥éª¤è®¿é—®æ•°æ®åº“ï¼š
    - ä»å…¨å±€ `DataSource` å®ä¾‹è·å– `Connection` å®ä¾‹ï¼›
    - é€šè¿‡ `Connection` å®ä¾‹åˆ›å»º `PreparedStatement` å®ä¾‹ï¼›
    - æ‰§è¡Œ SQL è¯­å¥ï¼Œå¦‚æœæ˜¯æŸ¥è¯¢ï¼Œåˆ™é€šè¿‡ `ResultSet` è¯»å–ç»“æœé›†ï¼Œå¦‚æœæ˜¯ä¿®æ”¹ï¼Œåˆ™è·å¾— `int` ç»“æœã€‚

æ­£ç¡®ç¼–å†™ JDBC ä»£ç çš„å…³é”®æ˜¯ä½¿ç”¨ `try ... finally` é‡Šæ”¾èµ„æºï¼Œæ¶‰åŠåˆ°äº‹åŠ¡çš„ä»£ç éœ€è¦æ­£ç¡®æäº¤æˆ–å›æ»šäº‹åŠ¡ã€‚

åœ¨ Spring ä½¿ç”¨ JDBCï¼Œé¦–å…ˆæˆ‘ä»¬é€šè¿‡ IoC å®¹å™¨åˆ›å»ºå¹¶ç®¡ç†ä¸€ä¸ª `DataSource` å®ä¾‹ï¼Œç„¶åï¼ŒSpring æä¾›äº†ä¸€ä¸ª `JdbcTemplate`ï¼Œå¯ä»¥æ–¹ä¾¿åœ°è®©æˆ‘ä»¬æ“ä½œ JDBCï¼Œå› æ­¤ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå®ä¾‹åŒ–ä¸€ä¸ª `JdbcTemplate`ã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªç±»ä¸»è¦ä½¿ç”¨äº† [Template æ¨¡å¼](https://www.liaoxuefeng.com/wiki/1252599548343744/1281319636041762)ã€‚

ç¼–å†™ç¤ºä¾‹ä»£ç æˆ–è€…æµ‹è¯•ä»£ç æ—¶ï¼Œæˆ‘ä»¬å¼ºçƒˆæ¨èä½¿ç”¨ [HSQLDB](http://hsqldb.org/) è¿™ä¸ªæ•°æ®åº“ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨ Java ç¼–å†™çš„å…³ç³»æ•°æ®åº“ï¼Œå¯ä»¥ä»¥å†…å­˜æ¨¡å¼æˆ–è€…æ–‡ä»¶æ¨¡å¼è¿è¡Œï¼Œæœ¬èº«åªæœ‰ä¸€ä¸ª jar åŒ…ï¼Œéå¸¸é€‚åˆæ¼”ç¤ºä»£ç æˆ–è€…æµ‹è¯•ä»£ç ã€‚

æˆ‘ä»¬ä»¥å®é™…å·¥ç¨‹ä¸ºä¾‹ï¼Œå…ˆåˆ›å»º Maven å·¥ç¨‹ `spring-data-jdbc`ï¼Œç„¶åå¼•å…¥ä»¥ä¸‹ä¾èµ–ï¼š

- org.springframework:spring-context:6.0.0
- org.springframework:spring-jdbc:6.0.0
- jakarta.annotation:jakarta.annotation-api:2.1.1
- com.zaxxer:HikariCP:5.0.1
- org.hsqldb:hsqldb:2.7.1

åœ¨ `AppConfig` ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä»¥ä¸‹å‡ ä¸ªå¿…é¡»çš„ Beanï¼š

```java
@Configuration
@ComponentScan
@PropertySource("jdbc.properties")
public class AppConfig {

    @Value("${jdbc.url}")
    String jdbcUrl;

    @Value("${jdbc.username}")
    String jdbcUsername;

    @Value("${jdbc.password}")
    String jdbcPassword;

    @Bean
    DataSource createDataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl(jdbcUrl);
        config.setUsername(jdbcUsername);
        config.setPassword(jdbcPassword);
        config.addDataSourceProperty("autoCommit", "true");
        config.addDataSourceProperty("connectionTimeout", "5");
        config.addDataSourceProperty("idleTimeout", "60");
        return new HikariDataSource(config);
    }

    @Bean
    JdbcTemplate createJdbcTemplate(@Autowired DataSource dataSource) {
        return new JdbcTemplate(dataSource);
    }
}
```

åœ¨ä¸Šè¿°é…ç½®ä¸­ï¼š

1. é€šè¿‡ `@PropertySource("jdbc.properties")` è¯»å–æ•°æ®åº“é…ç½®æ–‡ä»¶ï¼›
2. é€šè¿‡ `@Value("${jdbc.url}")` æ³¨å…¥é…ç½®æ–‡ä»¶çš„ç›¸å…³é…ç½®ï¼›
3. åˆ›å»ºä¸€ä¸ª DataSource å®ä¾‹ï¼Œå®ƒçš„å®é™…ç±»å‹æ˜¯ `HikariDataSource`ï¼Œåˆ›å»ºæ—¶éœ€è¦ç”¨åˆ°æ³¨å…¥çš„é…ç½®ï¼›
4. åˆ›å»ºä¸€ä¸ª JdbcTemplate å®ä¾‹ï¼Œå®ƒéœ€è¦æ³¨å…¥ `DataSource`ï¼Œè¿™æ˜¯é€šè¿‡æ–¹æ³•å‚æ•°å®Œæˆæ³¨å…¥çš„ã€‚

æœ€åï¼Œé’ˆå¯¹ HSQLDB å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ `jdbc.properties`ï¼š

```conf
## ğŸ€ æ•°æ®åº“æ–‡ä»¶åä¸º testdb:
jdbc.url=jdbc:hsqldb:file:testdb

## ğŸ€ Hsqldb é»˜è®¤çš„ç”¨æˆ·åæ˜¯ saï¼Œå£ä»¤æ˜¯ç©ºå­—ç¬¦ä¸²:
jdbc.username=sa
jdbc.password=
```

å¯ä»¥é€šè¿‡ HSQLDB è‡ªå¸¦çš„å·¥å…·æ¥åˆå§‹åŒ–æ•°æ®åº“è¡¨ï¼Œè¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ª Beanï¼Œåœ¨ Spring å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª `users` è¡¨ï¼š

```java
@Component
public class DatabaseInitializer {
    @Autowired
    JdbcTemplate jdbcTemplate;

    @PostConstruct
    public void init() {
        jdbcTemplate.update("CREATE TABLE IF NOT EXISTS users (" //
                + "id BIGINT IDENTITY NOT NULL PRIMARY KEY," //
                + "email VARCHAR(100) NOT NULL," //
                + "password VARCHAR(100) NOT NULL," //
                + "name VARCHAR(100) NOT NULL," //
                + "UNIQUE (email))");
    }
}
```

ç°åœ¨ï¼Œæ‰€æœ‰å‡†å¤‡å·¥ä½œéƒ½å·²å®Œæ¯•ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨éœ€è¦è®¿é—®æ•°æ®åº“çš„ Bean ä¸­ï¼Œæ³¨å…¥ `JdbcTemplate` å³å¯ï¼š

```java
@Component
public class UserService {
    @Autowired
    JdbcTemplate jdbcTemplate;
    ...
}
```

### JdbcTemplate ç”¨æ³•

Spring æä¾›çš„ `JdbcTemplate` é‡‡ç”¨ Template æ¨¡å¼ï¼Œæä¾›äº†ä¸€ç³»åˆ—ä»¥å›è°ƒä¸ºç‰¹ç‚¹çš„å·¥å…·æ–¹æ³•ï¼Œç›®çš„æ˜¯é¿å…ç¹ççš„ `try...catch` è¯­å¥ã€‚

æˆ‘ä»¬ä»¥å…·ä½“çš„ç¤ºä¾‹æ¥è¯´æ˜ JdbcTemplate çš„ç”¨æ³•ã€‚

é¦–å…ˆæˆ‘ä»¬çœ‹ `T execute(ConnectionCallback<T> action)` æ–¹æ³•ï¼Œå®ƒæä¾›äº† Jdbc çš„ `Connection` ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼š

```java
public User getUserById(long id) {
    // æ³¨æ„ä¼ å…¥çš„æ˜¯ ConnectionCallback:
    return jdbcTemplate.execute((Connection conn) -> {
        // å¯ä»¥ç›´æ¥ä½¿ç”¨ conn å®ä¾‹ï¼Œä¸è¦é‡Šæ”¾å®ƒï¼Œå›è°ƒç»“æŸå JdbcTemplate è‡ªåŠ¨é‡Šæ”¾:
        // åœ¨å†…éƒ¨æ‰‹åŠ¨åˆ›å»ºçš„ PreparedStatementã€ResultSet å¿…é¡»ç”¨ try(...) é‡Šæ”¾:
        try (var ps = conn.prepareStatement("SELECT * FROM users WHERE id = ?")) {
            ps.setObject(1, id);
            try (var rs = ps.executeQuery()) {
                if (rs.next()) {
                    return new User( // new User object:
                            rs.getLong("id"), // id
                            rs.getString("email"), // email
                            rs.getString("password"), // password
                            rs.getString("name")); // name
                }
                throw new RuntimeException("user not found by id.");
            }
        }
    });
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šè¿°å›è°ƒæ–¹æ³•å…è®¸è·å– Connectionï¼Œç„¶ååšä»»ä½•åŸºäº Connection çš„æ“ä½œã€‚

æˆ‘ä»¬å†çœ‹ `T execute(String sql, PreparedStatementCallback<T> action)` çš„ç”¨æ³•ï¼š

```java
public User getUserByName(String name) {
    // éœ€è¦ä¼ å…¥ SQL è¯­å¥ï¼Œä»¥åŠ PreparedStatementCallback:
    return jdbcTemplate.execute("SELECT * FROM users WHERE name = ?", (PreparedStatement ps) -> {
        // PreparedStatement å®ä¾‹å·²ç»ç”± JdbcTemplate åˆ›å»ºï¼Œå¹¶åœ¨å›è°ƒåè‡ªåŠ¨é‡Šæ”¾:
        ps.setObject(1, name);
        try (var rs = ps.executeQuery()) {
            if (rs.next()) {
                return new User( // new User object:
                        rs.getLong("id"), // id
                        rs.getString("email"), // email
                        rs.getString("password"), // password
                        rs.getString("name")); // name
            }
            throw new RuntimeException("user not found by id.");
        }
    });
}
```

æœ€åï¼Œæˆ‘ä»¬çœ‹ `T queryForObject(String sql, RowMapper<T> rowMapper, Object... args)` æ–¹æ³•ï¼š

```java
public User getUserByEmail(String email) {
    // ä¼ å…¥ SQLï¼Œå‚æ•°å’Œ RowMapper å®ä¾‹:
    return jdbcTemplate.queryForObject("SELECT * FROM users WHERE email = ?",
            (ResultSet rs, int rowNum) -> {
                // å°† ResultSet çš„å½“å‰è¡Œæ˜ å°„ä¸ºä¸€ä¸ª JavaBean:
                return new User( // new User object:
                        rs.getLong("id"), // id
                        rs.getString("email"), // email
                        rs.getString("password"), // password
                        rs.getString("name")); // name
            },
            email);
}
```

åœ¨ `queryForObject()` æ–¹æ³•ä¸­ï¼Œä¼ å…¥ SQL ä»¥åŠ SQL å‚æ•°åï¼Œ`JdbcTemplate` ä¼šè‡ªåŠ¨åˆ›å»º `PreparedStatement`ï¼Œè‡ªåŠ¨æ‰§è¡ŒæŸ¥è¯¢å¹¶è¿”å› `ResultSet`ï¼Œæˆ‘ä»¬æä¾›çš„ `RowMapper` éœ€è¦åšçš„äº‹æƒ…å°±æ˜¯æŠŠ `ResultSet` çš„å½“å‰è¡Œæ˜ å°„æˆä¸€ä¸ª JavaBean å¹¶è¿”å›ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ `Connection`ã€`PreparedStatement` å’Œ `ResultSet` éƒ½ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†ã€‚

`RowMapper` ä¸ä¸€å®šè¿”å› JavaBeanï¼Œå®é™…ä¸Šå®ƒå¯ä»¥è¿”å›ä»»ä½• Java å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ `SELECT COUNT(*)` æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥è¿”å› `Long`ï¼š

```java
public long getUsers() {
    return jdbcTemplate.queryForObject("SELECT COUNT(*) FROM users", (ResultSet rs, int rowNum) -> {
        // SELECT COUNT(*) æŸ¥è¯¢åªæœ‰ä¸€åˆ—ï¼Œå–ç¬¬ä¸€åˆ—æ•°æ®:
        return rs.getLong(1);
    });
}
```

å¦‚æœæˆ‘ä»¬æœŸæœ›è¿”å›å¤šè¡Œè®°å½•ï¼Œè€Œä¸æ˜¯ä¸€è¡Œï¼Œå¯ä»¥ç”¨ `query()` æ–¹æ³•ï¼š

```java
public List<User> getUsers(int pageIndex) {
    int limit = 100;
    int offset = limit * (pageIndex - 1);
    return jdbcTemplate.query("SELECT * FROM users LIMIT ? OFFSET ?",
            new BeanPropertyRowMapper<>(User.class),
            limit, offset);
}
```

ä¸Šè¿° `query()` æ–¹æ³•ä¼ å…¥çš„å‚æ•°ä»ç„¶æ˜¯ SQLã€SQL å‚æ•°ä»¥åŠ `RowMapper` å®ä¾‹ã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ Spring æä¾›çš„ `BeanPropertyRowMapper`ã€‚å¦‚æœæ•°æ®åº“è¡¨çš„ç»“æ„æ°å¥½å’Œ JavaBean çš„å±æ€§åç§°ä¸€è‡´ï¼Œé‚£ä¹ˆ `BeanPropertyRowMapper` å°±å¯ä»¥ç›´æ¥æŠŠä¸€è¡Œè®°å½•æŒ‰åˆ—åè½¬æ¢ä¸º JavaBeanã€‚

å¦‚æœæˆ‘ä»¬æ‰§è¡Œçš„ä¸æ˜¯æŸ¥è¯¢ï¼Œè€Œæ˜¯æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨ `update()` æ–¹æ³•ï¼š

```java
public void updateUser(User user) {
    // ä¼ å…¥ SQLï¼ŒSQL å‚æ•°ï¼Œè¿”å›æ›´æ–°çš„è¡Œæ•°:
    if (1 != jdbcTemplate.update("UPDATE users SET name = ? WHERE id = ?", user.getName(), user.getId())) {
        throw new RuntimeException("User not found by id");
    }
}
```

åªæœ‰ä¸€ç§ `INSERT` æ“ä½œæ¯”è¾ƒç‰¹æ®Šï¼Œé‚£å°±æ˜¯å¦‚æœæŸä¸€åˆ—æ˜¯è‡ªå¢åˆ—ï¼ˆä¾‹å¦‚è‡ªå¢ä¸»é”®ï¼‰ï¼Œé€šå¸¸ï¼Œæˆ‘ä»¬éœ€è¦è·å–æ’å…¥åçš„è‡ªå¢å€¼ã€‚`JdbcTemplate` æä¾›äº†ä¸€ä¸ª `KeyHolder` æ¥ç®€åŒ–è¿™ä¸€æ“ä½œï¼š

```java
public User register(String email, String password, String name) {
    // åˆ›å»ºä¸€ä¸ª KeyHolder:
    KeyHolder holder = new GeneratedKeyHolder();
    if (1 != jdbcTemplate.update(
        // å‚æ•° 1:PreparedStatementCreator
        (conn) -> {
            // åˆ›å»º PreparedStatement æ—¶ï¼Œå¿…é¡»æŒ‡å®š RETURN_GENERATED_KEYS:
            var ps = conn.prepareStatement("INSERT INTO users(email, password, name) VALUES(?, ?, ?)",
                    Statement.RETURN_GENERATED_KEYS);
            ps.setObject(1, email);
            ps.setObject(2, password);
            ps.setObject(3, name);
            return ps;
        },
        // å‚æ•° 2:KeyHolder
        holder)
    ) {
        throw new RuntimeException("Insert failed.");
    }
    // ä» KeyHolder ä¸­è·å–è¿”å›çš„è‡ªå¢å€¼:
    return new User(holder.getKey().longValue(), email, password, name);
}
```

`JdbcTemplate` è¿˜æœ‰è®¸å¤šé‡è½½æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ä¸€ä¸€ä»‹ç»ã€‚éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œ`JdbcTemplate` åªæ˜¯å¯¹ JDBC æ“ä½œçš„ä¸€ä¸ªç®€å•å°è£…ï¼Œå®ƒçš„ç›®çš„æ˜¯å°½é‡å‡å°‘æ‰‹åŠ¨ç¼–å†™ `try(resource) {...}` çš„ä»£ç ï¼Œå¯¹äºæŸ¥è¯¢ï¼Œä¸»è¦é€šè¿‡ `RowMapper` å®ç°äº† JDBC ç»“æœé›†åˆ° Java å¯¹è±¡çš„è½¬æ¢ã€‚

æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ `JdbcTemplate` çš„ç”¨æ³•ï¼Œé‚£å°±æ˜¯ï¼š

- é’ˆå¯¹ç®€å•æŸ¥è¯¢ï¼Œä¼˜é€‰ `query()` å’Œ `queryForObject()`ï¼Œå› ä¸ºåªéœ€æä¾› SQL è¯­å¥ã€å‚æ•°å’Œ `RowMapper`ï¼›
- é’ˆå¯¹æ›´æ–°æ“ä½œï¼Œä¼˜é€‰ `update()`ï¼Œå› ä¸ºåªéœ€æä¾› SQL è¯­å¥å’Œå‚æ•°ï¼›
- ä»»ä½•å¤æ‚çš„æ“ä½œï¼Œæœ€ç»ˆä¹Ÿå¯ä»¥é€šè¿‡ `execute(ConnectionCallback)` å®ç°ï¼Œå› ä¸ºæ‹¿åˆ° `Connection` å°±å¯ä»¥åšä»»ä½• JDBC æ“ä½œã€‚

å®é™…ä¸Šæˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„ä»ç„¶æ˜¯å„ç§æŸ¥è¯¢ã€‚å¦‚æœåœ¨è®¾è®¡è¡¨ç»“æ„çš„æ—¶å€™ï¼Œèƒ½å¤Ÿå’Œ JavaBean çš„å±æ€§ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨ `BeanPropertyRowMapper` å°±å¾ˆæ–¹ä¾¿ã€‚å¦‚æœè¡¨ç»“æ„å’Œ JavaBean ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿé‚£å°±éœ€è¦ç¨å¾®æ”¹å†™ä¸€ä¸‹æŸ¥è¯¢ï¼Œä½¿ç»“æœé›†çš„ç»“æ„å’Œ JavaBean ä¿æŒä¸€è‡´ã€‚

ä¾‹å¦‚ï¼Œè¡¨çš„åˆ—åæ˜¯ `office_address`ï¼Œè€Œ JavaBean å±æ€§æ˜¯ `workAddress`ï¼Œå°±éœ€è¦æŒ‡å®šåˆ«åï¼Œæ”¹å†™æŸ¥è¯¢å¦‚ä¸‹ï¼š

```sql
SELECT id, email, office_address AS workAddress, name FROM users WHERE email = ?
```

### ç»ƒä¹ 


### å°ç»“

Spring æä¾›äº† `JdbcTemplate` æ¥ç®€åŒ– JDBC æ“ä½œï¼›

ä½¿ç”¨ `JdbcTemplate` æ—¶ï¼Œæ ¹æ®éœ€è¦ä¼˜å…ˆé€‰æ‹©é«˜çº§æ–¹æ³•ï¼›

ä»»ä½• JDBC æ“ä½œéƒ½å¯ä»¥ä½¿ç”¨ä¿åº•çš„ `execute(ConnectionCallback)` æ–¹æ³•ã€‚



## ğŸ€ ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡


ä½¿ç”¨ Spring æ“ä½œ JDBC è™½ç„¶æ–¹ä¾¿ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å‰é¢è®¨è®º JDBC çš„æ—¶å€™ï¼Œè®²åˆ°è¿‡ [JDBC äº‹åŠ¡](https://www.liaoxuefeng.com/wiki/1252599548343744/1321748500840481)ï¼Œå¦‚æœè¦åœ¨ Spring ä¸­æ“ä½œäº‹åŠ¡ï¼Œæ²¡å¿…è¦æ‰‹å†™ JDBC äº‹åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ Spring æä¾›çš„é«˜çº§æ¥å£æ¥æ“ä½œäº‹åŠ¡ã€‚

Spring æä¾›äº†ä¸€ä¸ª `PlatformTransactionManager` æ¥è¡¨ç¤ºäº‹åŠ¡ç®¡ç†å™¨ï¼Œæ‰€æœ‰çš„äº‹åŠ¡éƒ½ç”±å®ƒè´Ÿè´£ç®¡ç†ã€‚è€Œäº‹åŠ¡ç”± `TransactionStatus` è¡¨ç¤ºã€‚å¦‚æœæ‰‹å†™äº‹åŠ¡ä»£ç ï¼Œä½¿ç”¨ `try...catch` å¦‚ä¸‹ï¼š

```java
TransactionStatus tx = null;
try {
    // å¼€å¯äº‹åŠ¡:
    tx = txManager.getTransaction(new DefaultTransactionDefinition());
    // ç›¸å…³ JDBC æ“ä½œ:
    jdbcTemplate.update("...");
    jdbcTemplate.update("...");
    // æäº¤äº‹åŠ¡:
    txManager.commit(tx);
} catch (RuntimeException e) {
    // å›æ»šäº‹åŠ¡:
    txManager.rollback(tx);
    throw e;
}
```

Spring ä¸ºå•¥è¦æŠ½è±¡å‡º `PlatformTransactionManager` å’Œ `TransactionStatus`ï¼ŸåŸå› æ˜¯ JavaEE é™¤äº†æä¾› JDBC äº‹åŠ¡å¤–ï¼Œå®ƒè¿˜æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ JTAï¼ˆJava Transaction APIï¼‰ã€‚åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯æŒ‡å¤šä¸ªæ•°æ®æºï¼ˆæ¯”å¦‚å¤šä¸ªæ•°æ®åº“ï¼Œå¤šä¸ªæ¶ˆæ¯ç³»ç»Ÿï¼‰è¦åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å®ç°äº‹åŠ¡çš„æ—¶å€™ï¼Œåº”è¯¥æ€ä¹ˆå®ç°ã€‚åˆ†å¸ƒå¼äº‹åŠ¡å®ç°èµ·æ¥éå¸¸å¤æ‚ï¼Œç®€å•åœ°è¯´å°±æ˜¯é€šè¿‡ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å™¨å®ç°ä¸¤é˜¶æ®µæäº¤ï¼Œä½†æœ¬èº«æ•°æ®åº“äº‹åŠ¡å°±ä¸å¿«ï¼ŒåŸºäºæ•°æ®åº“äº‹åŠ¡å®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡å°±æ…¢å¾—éš¾ä»¥å¿å—ï¼Œæ‰€ä»¥ä½¿ç”¨ç‡ä¸é«˜ã€‚

Spring ä¸ºäº†åŒæ—¶æ”¯æŒ JDBC å’Œ JTA ä¸¤ç§äº‹åŠ¡æ¨¡å‹ï¼Œå°±æŠ½è±¡å‡º `PlatformTransactionManager`ã€‚å› ä¸ºæˆ‘ä»¬çš„ä»£ç åªéœ€è¦ JDBC äº‹åŠ¡ï¼Œå› æ­¤ï¼Œåœ¨ `AppConfig` ä¸­ï¼Œéœ€è¦å†å®šä¹‰ä¸€ä¸ª `PlatformTransactionManager` å¯¹åº”çš„ Beanï¼Œå®ƒçš„å®é™…ç±»å‹æ˜¯ `DataSourceTransactionManager`ï¼š

```java
@Configuration
@ComponentScan
@PropertySource("jdbc.properties")
public class AppConfig {
    ...
    @Bean
    PlatformTransactionManager createTxManager(@Autowired DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

ä½¿ç”¨ç¼–ç¨‹çš„æ–¹å¼ä½¿ç”¨ Spring äº‹åŠ¡ä»ç„¶æ¯”è¾ƒç¹çï¼Œæ›´å¥½çš„æ–¹å¼æ˜¯é€šè¿‡å£°æ˜å¼äº‹åŠ¡æ¥å®ç°ã€‚ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡éå¸¸ç®€å•ï¼Œé™¤äº†åœ¨ `AppConfig` ä¸­è¿½åŠ ä¸€ä¸ªä¸Šè¿°å®šä¹‰çš„ `PlatformTransactionManager` å¤–ï¼Œå†åŠ ä¸€ä¸ª `@EnableTransactionManagement` å°±å¯ä»¥å¯ç”¨å£°æ˜å¼äº‹åŠ¡ï¼š

```java
@Configuration
@ComponentScan
@EnableTransactionManagement // å¯ç”¨å£°æ˜å¼
@PropertySource("jdbc.properties")
public class AppConfig {
    ...
}
```

ç„¶åï¼Œå¯¹éœ€è¦äº‹åŠ¡æ”¯æŒçš„æ–¹æ³•ï¼ŒåŠ ä¸€ä¸ª `@Transactional` æ³¨è§£ï¼š

```java
@Component
public class UserService {
    // æ­¤ public æ–¹æ³•è‡ªåŠ¨å…·æœ‰äº‹åŠ¡æ”¯æŒ:
    @Transactional
    public User register(String email, String password, String name) {
       ...
    }
}
```

æˆ–è€…æ›´ç®€å•ä¸€ç‚¹ï¼Œç›´æ¥åœ¨ Bean çš„ `class` å¤„åŠ ä¸Šï¼Œè¡¨ç¤ºæ‰€æœ‰ `public` æ–¹æ³•éƒ½å…·æœ‰äº‹åŠ¡æ”¯æŒï¼š

```java
@Component
@Transactional
public class UserService {
    ...
}
```

Spring å¯¹ä¸€ä¸ªå£°æ˜å¼äº‹åŠ¡çš„æ–¹æ³•ï¼Œå¦‚ä½•å¼€å¯äº‹åŠ¡æ”¯æŒï¼ŸåŸç†ä»ç„¶æ˜¯ AOP ä»£ç†ï¼Œå³é€šè¿‡è‡ªåŠ¨åˆ›å»º Bean çš„ Proxy å®ç°ï¼š

```java
public class UserService$$EnhancerBySpringCGLIB extends UserService {
    UserService target = ...
    PlatformTransactionManager txManager = ...

    public User register(String email, String password, String name) {
        TransactionStatus tx = null;
        try {
            tx = txManager.getTransaction(new DefaultTransactionDefinition());
            target.register(email, password, name);
            txManager.commit(tx);
        } catch (RuntimeException e) {
            txManager.rollback(tx);
            throw e;
        }
    }
    ...
}
```

æ³¨æ„ï¼šå£°æ˜äº† `@EnableTransactionManagement` åï¼Œä¸å¿…é¢å¤–æ·»åŠ  `@EnableAspectJAutoProxy`ã€‚

### å›æ»šäº‹åŠ¡

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœå‘ç”Ÿäº† `RuntimeException`ï¼ŒSpring çš„å£°æ˜å¼äº‹åŠ¡å°†è‡ªåŠ¨å›æ»šã€‚åœ¨ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ä¸­ï¼Œå¦‚æœç¨‹åºåˆ¤æ–­éœ€è¦å›æ»šäº‹åŠ¡ï¼Œåªéœ€æŠ›å‡º `RuntimeException`ï¼Œä¾‹å¦‚ï¼š

```java
@Transactional
public buyProducts(long productId, int num) {
    ...
    if (store < num) {
        // åº“å­˜ä¸å¤Ÿï¼Œè´­ä¹°å¤±è´¥:
        throw new IllegalArgumentException("No enough products");
    }
    ...
}
```

å¦‚æœè¦é’ˆå¯¹ Checked Exception å›æ»šäº‹åŠ¡ï¼Œéœ€è¦åœ¨ `@Transactional` æ³¨è§£ä¸­å†™å‡ºæ¥ï¼š

```java
@Transactional(rollbackFor = {RuntimeException.class, IOException.class})
public buyProducts(long productId, int num) throws IOException {
    ...
}
```

ä¸Šè¿°ä»£ç è¡¨ç¤ºåœ¨æŠ›å‡º `RuntimeException` æˆ– `IOException` æ—¶ï¼Œäº‹åŠ¡å°†å›æ»šã€‚

ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®ä¸šåŠ¡å¼‚å¸¸ä½“ç³»ä» `RuntimeException` æ´¾ç”Ÿï¼Œè¿™æ ·å°±ä¸å¿…å£°æ˜ä»»ä½•ç‰¹æ®Šå¼‚å¸¸å³å¯è®© Spring çš„å£°æ˜å¼äº‹åŠ¡æ­£å¸¸å·¥ä½œï¼š

```java
public class BusinessException extends RuntimeException {
    ...
}

public class LoginException extends BusinessException {
    ...
}

public class PaymentException extends BusinessException {
    ...
}
```

### äº‹åŠ¡è¾¹ç•Œ

åœ¨ä½¿ç”¨äº‹åŠ¡çš„æ—¶å€™ï¼Œæ˜ç¡®äº‹åŠ¡è¾¹ç•Œéå¸¸é‡è¦ã€‚å¯¹äºå£°æ˜å¼äº‹åŠ¡ï¼Œä¾‹å¦‚ï¼Œä¸‹é¢çš„ `register()` æ–¹æ³•ï¼š

```java
@Component
public class UserService {
    @Transactional
    public User register(String email, String password, String name) { // äº‹åŠ¡å¼€å§‹
       ...
    } // äº‹åŠ¡ç»“æŸ
}
```

å®ƒçš„äº‹åŠ¡è¾¹ç•Œå°±æ˜¯ `register()` æ–¹æ³•å¼€å§‹å’Œç»“æŸã€‚

ç±»ä¼¼çš„ï¼Œä¸€ä¸ªè´Ÿè´£ç»™ç”¨æˆ·å¢åŠ ç§¯åˆ†çš„ `addBonus()` æ–¹æ³•ï¼š

```java
@Component
public class BonusService {
    @Transactional
    public void addBonus(long userId, int bonus) { // äº‹åŠ¡å¼€å§‹
       ...
    } // äº‹åŠ¡ç»“æŸ
}
```

å®ƒçš„äº‹åŠ¡è¾¹ç•Œå°±æ˜¯ `addBonus()` æ–¹æ³•å¼€å§‹å’Œç»“æŸã€‚

åœ¨ç°å®ä¸–ç•Œä¸­ï¼Œé—®é¢˜æ€»æ˜¯è¦å¤æ‚ä¸€ç‚¹ç‚¹ã€‚ç”¨æˆ·æ³¨å†Œåï¼Œèƒ½è‡ªåŠ¨è·å¾— 100 ç§¯åˆ†ï¼Œå› æ­¤ï¼Œå®é™…ä»£ç å¦‚ä¸‹ï¼š

```java
@Component
public class UserService {
    @Autowired
    BonusService bonusService;

    @Transactional
    public User register(String email, String password, String name) {
        // æ’å…¥ç”¨æˆ·è®°å½•:
        User user = jdbcTemplate.insert("...");
        // å¢åŠ  100 ç§¯åˆ†:
        bonusService.addBonus(user.id, 100);
    }
}
```

ç°åœ¨é—®é¢˜æ¥äº†ï¼šè°ƒç”¨æ–¹ï¼ˆæ¯”å¦‚ `RegisterController`ï¼‰è°ƒç”¨ `UserService.register()` è¿™ä¸ªäº‹åŠ¡æ–¹æ³•ï¼Œå®ƒåœ¨å†…éƒ¨åˆè°ƒç”¨äº† `BonusService.addBonus()` è¿™ä¸ªäº‹åŠ¡æ–¹æ³•ï¼Œä¸€å…±æœ‰å‡ ä¸ªäº‹åŠ¡ï¼Ÿå¦‚æœ `addBonus()` æŠ›å‡ºäº†å¼‚å¸¸éœ€è¦å›æ»šäº‹åŠ¡ï¼Œ`register()` æ–¹æ³•çš„äº‹åŠ¡æ˜¯å¦ä¹Ÿè¦å›æ»šï¼Ÿ

é—®é¢˜çš„å¤æ‚åº¦æ˜¯ä¸æ˜¯ä¸€ä¸‹å­æé«˜äº† 10 å€ï¼Ÿ

### äº‹åŠ¡ä¼ æ’­

è¦è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å®šä¹‰äº‹åŠ¡çš„ä¼ æ’­æ¨¡å‹ã€‚

å‡è®¾ç”¨æˆ·æ³¨å†Œçš„å…¥å£æ˜¯ `RegisterController`ï¼Œå®ƒæœ¬èº«æ²¡æœ‰äº‹åŠ¡ï¼Œä»…ä»…æ˜¯è°ƒç”¨ `UserService.register()` è¿™ä¸ªäº‹åŠ¡æ–¹æ³•ï¼š

```java
@Controller
public class RegisterController {
    @Autowired
    UserService userService;

    @PostMapping("/register")
    public ModelAndView doRegister(HttpServletRequest req) {
        String email = req.getParameter("email");
        String password = req.getParameter("password");
        String name = req.getParameter("name");
        User user = userService.register(email, password, name);
        return ...
    }
}
```

å› æ­¤ï¼Œ`UserService.register()` è¿™ä¸ªäº‹åŠ¡æ–¹æ³•çš„èµ·å§‹å’Œç»“æŸï¼Œå°±æ˜¯äº‹åŠ¡çš„èŒƒå›´ã€‚

æˆ‘ä»¬éœ€è¦å…³å¿ƒçš„é—®é¢˜æ˜¯ï¼Œåœ¨ `UserService.register()` è¿™ä¸ªäº‹åŠ¡æ–¹æ³•å†…ï¼Œè°ƒç”¨ `BonusService.addBonus()`ï¼Œæˆ‘ä»¬æœŸå¾…çš„äº‹åŠ¡è¡Œä¸ºæ˜¯ä»€ä¹ˆï¼š

```java
@Transactional
public User register(String email, String password, String name) {
    // äº‹åŠ¡å·²å¼€å¯:
    User user = jdbcTemplate.insert("...");
    // ???:
    bonusService.addBonus(user.id, 100);
} // äº‹åŠ¡ç»“æŸ
```

å¯¹äºå¤§å¤šæ•°ä¸šåŠ¡æ¥è¯´ï¼Œæˆ‘ä»¬æœŸå¾… `BonusService.addBonus()` çš„è°ƒç”¨ï¼Œå’Œ `UserService.register()` åº”å½“èåˆåœ¨ä¸€èµ·ï¼Œå®ƒçš„è¡Œä¸ºåº”è¯¥å¦‚ä¸‹ï¼š

`UserService.register()` å·²ç»å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆåœ¨å†…éƒ¨è°ƒç”¨ `BonusService.addBonus()` æ—¶ï¼Œ`BonusService.addBonus()` æ–¹æ³•å°±æ²¡å¿…è¦å†å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡ï¼Œç›´æ¥åŠ å…¥åˆ° `BonusService.register()` çš„äº‹åŠ¡é‡Œå°±å¥½äº†ã€‚

å…¶å®å°±ç›¸å½“äºï¼š

1. `UserService.register()` å…ˆæ‰§è¡Œäº†ä¸€æ¡ INSERT è¯­å¥ï¼š`INSERT INTO users ...`
2. `BonusService.addBonus()` å†æ‰§è¡Œä¸€æ¡ INSERT è¯­å¥ï¼š`INSERT INTO bonus ...`

å› æ­¤ï¼ŒSpring çš„å£°æ˜å¼äº‹åŠ¡ä¸ºäº‹åŠ¡ä¼ æ’­å®šä¹‰äº†å‡ ä¸ªçº§åˆ«ï¼Œé»˜è®¤ä¼ æ’­çº§åˆ«å°±æ˜¯ REQUIREDï¼Œå®ƒçš„æ„æ€æ˜¯ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æœ‰äº‹åŠ¡ï¼Œå°±åŠ å…¥åˆ°å½“å‰äº‹åŠ¡ä¸­æ‰§è¡Œã€‚

æˆ‘ä»¬è§‚å¯Ÿ `UserService.register()` æ–¹æ³•ï¼Œå®ƒåœ¨ `RegisterController` ä¸­æ‰§è¡Œï¼Œå› ä¸º `RegisterController` æ²¡æœ‰äº‹åŠ¡ï¼Œå› æ­¤ï¼Œ`UserService.register()` æ–¹æ³•ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡ã€‚

åœ¨ `UserService.register()` æ–¹æ³•å†…éƒ¨ï¼Œè°ƒç”¨ `BonusService.addBonus()` æ–¹æ³•æ—¶ï¼Œå› ä¸º `BonusService.addBonus()` æ£€æµ‹åˆ°å½“å‰å·²ç»æœ‰äº‹åŠ¡äº†ï¼Œå› æ­¤ï¼Œå®ƒä¼šåŠ å…¥åˆ°å½“å‰äº‹åŠ¡ä¸­æ‰§è¡Œã€‚

å› æ­¤ï¼Œæ•´ä¸ªä¸šåŠ¡æµç¨‹çš„äº‹åŠ¡è¾¹ç•Œå°±æ¸…æ™°äº†ï¼šå®ƒåªæœ‰ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶ä¸”èŒƒå›´å°±æ˜¯ `UserService.register()` æ–¹æ³•ã€‚

æœ‰çš„ç«¥é‹ä¼šé—®ï¼šæŠŠ `BonusService.addBonus()` æ–¹æ³•çš„ `@Transactional` å»æ‰ï¼Œå˜æˆä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œé‚£ä¸å°±è§„é¿äº†å¤æ‚çš„ä¼ æ’­æ¨¡å‹å—ï¼Ÿ

å»æ‰ `BonusService.addBonus()` æ–¹æ³•çš„ `@Transactional`ï¼Œä¼šå¼•æ¥å¦ä¸€ä¸ªé—®é¢˜ï¼Œå³å…¶ä»–åœ°æ–¹å¦‚æœè°ƒç”¨ `BonusService.addBonus()` æ–¹æ³•ï¼Œé‚£å°±æ²¡æ³•ä¿è¯äº‹åŠ¡äº†ã€‚ä¾‹å¦‚ï¼Œè§„å®šç”¨æˆ·ç™»å½•æ—¶ç§¯åˆ† + 5ï¼š

```java
@Controller
public class LoginController {
    @Autowired
    BonusService bonusService;

    @PostMapping("/login")
    public ModelAndView doLogin(HttpServletRequest req) {
        User user = ...
        bonusService.addBonus(user.id, 5);
    }
}
```

å¯è§ï¼Œ`BonusService.addBonus()` æ–¹æ³•å¿…é¡»è¦æœ‰ `@Transactional`ï¼Œå¦åˆ™ï¼Œç™»å½•åç§¯åˆ†å°±æ— æ³•æ·»åŠ äº†ã€‚

é»˜è®¤çš„äº‹åŠ¡ä¼ æ’­çº§åˆ«æ˜¯ `REQUIRED`ï¼Œå®ƒæ»¡è¶³ç»å¤§éƒ¨åˆ†çš„éœ€æ±‚ã€‚è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ä¼ æ’­çº§åˆ«ï¼š

`SUPPORTS`ï¼šè¡¨ç¤ºå¦‚æœæœ‰äº‹åŠ¡ï¼Œå°±åŠ å…¥åˆ°å½“å‰äº‹åŠ¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹Ÿä¸å¼€å¯äº‹åŠ¡æ‰§è¡Œã€‚è¿™ç§ä¼ æ’­çº§åˆ«å¯ç”¨äºæŸ¥è¯¢æ–¹æ³•ï¼Œå› ä¸º SELECT è¯­å¥æ—¢å¯ä»¥åœ¨äº‹åŠ¡å†…æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥ä¸éœ€è¦äº‹åŠ¡ï¼›

`MANDATORY`ï¼šè¡¨ç¤ºå¿…é¡»è¦å­˜åœ¨å½“å‰äº‹åŠ¡å¹¶åŠ å…¥æ‰§è¡Œï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸ã€‚è¿™ç§ä¼ æ’­çº§åˆ«å¯ç”¨äºæ ¸å¿ƒæ›´æ–°é€»è¾‘ï¼Œæ¯”å¦‚ç”¨æˆ·ä½™é¢å˜æ›´ï¼Œå®ƒæ€»æ˜¯è¢«å…¶ä»–äº‹åŠ¡æ–¹æ³•è°ƒç”¨ï¼Œä¸èƒ½ç›´æ¥ç”±éäº‹åŠ¡æ–¹æ³•è°ƒç”¨ï¼›

`REQUIRES_NEW`ï¼šè¡¨ç¤ºä¸ç®¡å½“å‰æœ‰æ²¡æœ‰äº‹åŠ¡ï¼Œéƒ½å¿…é¡»å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡æ‰§è¡Œã€‚å¦‚æœå½“å‰å·²ç»æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡ä¼šæŒ‚èµ·ï¼Œç­‰æ–°äº‹åŠ¡å®Œæˆåï¼Œå†æ¢å¤æ‰§è¡Œï¼›

`NOT_SUPPORTED`ï¼šè¡¨ç¤ºä¸æ”¯æŒäº‹åŠ¡ï¼Œå¦‚æœå½“å‰æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡ä¼šæŒ‚èµ·ï¼Œç­‰è¿™ä¸ªæ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œå†æ¢å¤æ‰§è¡Œï¼›

`NEVER`ï¼šå’Œ `NOT_SUPPORTED` ç›¸æ¯”ï¼Œå®ƒä¸ä½†ä¸æ”¯æŒäº‹åŠ¡ï¼Œè€Œä¸”åœ¨ç›‘æµ‹åˆ°å½“å‰æœ‰äº‹åŠ¡æ—¶ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸æ‹’ç»æ‰§è¡Œï¼›

`NESTED`ï¼šè¡¨ç¤ºå¦‚æœå½“å‰æœ‰äº‹åŠ¡ï¼Œåˆ™å¼€å¯ä¸€ä¸ªåµŒå¥—çº§åˆ«äº‹åŠ¡ï¼Œå¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡ã€‚

ä¸Šé¢è¿™ä¹ˆå¤šç§äº‹åŠ¡çš„ä¼ æ’­çº§åˆ«ï¼Œå…¶å®é»˜è®¤çš„ `REQUIRED` å·²ç»æ»¡è¶³ç»å¤§éƒ¨åˆ†éœ€æ±‚ï¼Œ`SUPPORTS` å’Œ `REQUIRES_NEW` åœ¨å°‘æ•°æƒ…å†µä¸‹ä¼šç”¨åˆ°ï¼Œå…¶ä»–åŸºæœ¬ä¸ä¼šç”¨åˆ°ï¼Œå› ä¸ºæŠŠäº‹åŠ¡æå¾—è¶Šå¤æ‚ï¼Œä¸ä»…é€»è¾‘è·Ÿç€å¤æ‚ï¼Œè€Œä¸”é€Ÿåº¦ä¹Ÿä¼šè¶Šæ…¢ã€‚

å®šä¹‰äº‹åŠ¡çš„ä¼ æ’­çº§åˆ«ä¹Ÿæ˜¯å†™åœ¨ `@Transactional` æ³¨è§£é‡Œçš„ï¼š

```java
@Transactional(propagation = Propagation.REQUIRES_NEW)
public Product createProduct() {
    ...
}
```

ç°åœ¨åªå‰©æœ€åä¸€ä¸ªé—®é¢˜äº†ï¼šSpring æ˜¯å¦‚ä½•ä¼ æ’­äº‹åŠ¡çš„ï¼Ÿ

æˆ‘ä»¬ [åœ¨ JDBC ä¸­ä½¿ç”¨äº‹åŠ¡](/1-Java/17_JDBCç¼–ç¨‹/4.md) çš„æ—¶å€™ï¼Œæ˜¯è¿™ä¹ˆä¸ªå†™æ³•ï¼š

```java
Connection conn = openConnection();
try {
    // å…³é—­è‡ªåŠ¨æäº¤:
    conn.setAutoCommit(false);
    // æ‰§è¡Œå¤šæ¡ SQL è¯­å¥:
    insert(); update(); delete();
    // æäº¤äº‹åŠ¡:
    conn.commit();
} catch (SQLException e) {
    // å›æ»šäº‹åŠ¡:
    conn.rollback();
} finally {
    conn.setAutoCommit(true);
    conn.close();
}
```

Spring ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡ï¼Œæœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡æ‰§è¡Œ JDBC äº‹åŠ¡æ¥å®ç°åŠŸèƒ½çš„ï¼Œé‚£ä¹ˆï¼Œä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ï¼Œå¦‚ä½•è·çŸ¥å½“å‰æ˜¯å¦å­˜åœ¨äº‹åŠ¡ï¼Ÿ

ç­”æ¡ˆæ˜¯ [ä½¿ç”¨ ThreadLocal](/1-Java/13_å¤šçº¿ç¨‹/22.md)ã€‚Spring æ€»æ˜¯æŠŠ JDBC ç›¸å…³çš„ `Connection` å’Œ `TransactionStatus` å®ä¾‹ç»‘å®šåˆ° `ThreadLocal`ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ä» `ThreadLocal` æœªå–åˆ°äº‹åŠ¡ï¼Œé‚£ä¹ˆå®ƒä¼šæ‰“å¼€ä¸€ä¸ªæ–°çš„ JDBC è¿æ¥ï¼ŒåŒæ—¶å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦åˆ™ï¼Œå®ƒå°±ç›´æ¥ä½¿ç”¨ä» `ThreadLocal` è·å–çš„ JDBC è¿æ¥ä»¥åŠ `TransactionStatus`ã€‚

å› æ­¤ï¼Œäº‹åŠ¡èƒ½æ­£ç¡®ä¼ æ’­çš„å‰ææ˜¯ï¼Œæ–¹æ³•è°ƒç”¨æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹å†…æ‰è¡Œã€‚å¦‚æœåƒä¸‹é¢è¿™æ ·å†™ï¼š

```java
@Transactional
public User register(String email, String password, String name) { // BEGIN TX-A
    User user = jdbcTemplate.insert("...");
    new Thread(() -> {
        // BEGIN TX-B:
        bonusService.addBonus(user.id, 100);
        // END TX-B
    }).start();
} // END TX-A
```

åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨ `BonusService.addBonus()`ï¼Œå®ƒæ ¹æœ¬è·å–ä¸åˆ°å½“å‰äº‹åŠ¡ï¼Œå› æ­¤ï¼Œ`UserService.register()` å’Œ `BonusService.addBonus()` ä¸¤ä¸ªæ–¹æ³•ï¼Œå°†åˆ†åˆ«å¼€å¯ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„äº‹åŠ¡ã€‚

æ¢å¥è¯è¯´ï¼Œäº‹åŠ¡åªèƒ½åœ¨å½“å‰çº¿ç¨‹ä¼ æ’­ï¼Œæ— æ³•è·¨çº¿ç¨‹ä¼ æ’­ã€‚

é‚£å¦‚æœæˆ‘ä»¬æƒ³å®ç°è·¨çº¿ç¨‹ä¼ æ’­äº‹åŠ¡å‘¢ï¼ŸåŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯è¦æƒ³åŠæ³•æŠŠå½“å‰çº¿ç¨‹ç»‘å®šåˆ° `ThreadLocal` çš„ `Connection` å’Œ `TransactionStatus` å®ä¾‹ä¼ é€’ç»™æ–°çº¿ç¨‹ï¼Œä½†å®ç°èµ·æ¥éå¸¸å¤æ‚ï¼Œæ ¹æ®å¼‚å¸¸å›æ»šæ›´åŠ å¤æ‚ï¼Œä¸æ¨èè‡ªå·±å»å®ç°ã€‚

### ç»ƒä¹ 


### å°ç»“

Spring æä¾›çš„å£°æ˜å¼äº‹åŠ¡æå¤§åœ°æ–¹ä¾¿äº†åœ¨æ•°æ®åº“ä¸­ä½¿ç”¨äº‹åŠ¡ï¼Œæ­£ç¡®ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡çš„å…³é”®åœ¨äºç¡®å®šå¥½äº‹åŠ¡è¾¹ç•Œï¼Œç†è§£äº‹åŠ¡ä¼ æ’­çº§åˆ«ã€‚



## ğŸ€ ä½¿ç”¨ DAO


åœ¨ä¼ ç»Ÿçš„å¤šå±‚åº”ç”¨ç¨‹åºä¸­ï¼Œé€šå¸¸æ˜¯ Web å±‚è°ƒç”¨ä¸šåŠ¡å±‚ï¼Œä¸šåŠ¡å±‚è°ƒç”¨æ•°æ®è®¿é—®å±‚ã€‚ä¸šåŠ¡å±‚è´Ÿè´£å¤„ç†å„ç§ä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ•°æ®è®¿é—®å±‚åªè´Ÿè´£å¯¹æ•°æ®è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚å› æ­¤ï¼Œå®ç°æ•°æ®è®¿é—®å±‚å°±æ˜¯ç”¨ `JdbcTemplate` å®ç°å¯¹æ•°æ®åº“çš„æ“ä½œã€‚

ç¼–å†™æ•°æ®è®¿é—®å±‚çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ DAO æ¨¡å¼ã€‚DAO å³ Data Access Object çš„ç¼©å†™ï¼Œå®ƒæ²¡æœ‰ä»€ä¹ˆç¥ç§˜ä¹‹å¤„ï¼Œå®ç°èµ·æ¥åŸºæœ¬å¦‚ä¸‹ï¼š

```java
public class UserDao {

    @Autowired
    JdbcTemplate jdbcTemplate;

    User getById(long id) {
        ...
    }

    List<User> getUsers(int page) {
        ...
    }

    User createUser(User user) {
        ...
    }

    User updateUser(User user) {
        ...
    }

    void deleteUser(User user) {
        ...
    }
}
```

Spring æä¾›äº†ä¸€ä¸ª `JdbcDaoSupport` ç±»ï¼Œç”¨äºç®€åŒ– DAO çš„å®ç°ã€‚è¿™ä¸ª `JdbcDaoSupport` æ²¡ä»€ä¹ˆå¤æ‚çš„ï¼Œæ ¸å¿ƒä»£ç å°±æ˜¯æŒæœ‰ä¸€ä¸ª `JdbcTemplate`ï¼š

```java
public abstract class JdbcDaoSupport extends DaoSupport {

    private JdbcTemplate jdbcTemplate;

    public final void setJdbcTemplate(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
        initTemplateConfig();
    }

    public final JdbcTemplate getJdbcTemplate() {
        return this.jdbcTemplate;
    }

    ...
}
```

å®ƒçš„æ„å›¾æ˜¯å­ç±»ç›´æ¥ä» `JdbcDaoSupport` ç»§æ‰¿åï¼Œå¯ä»¥éšæ—¶è°ƒç”¨ `getJdbcTemplate()` è·å¾— `JdbcTemplate` çš„å®ä¾‹ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šå› ä¸º `JdbcDaoSupport` çš„ `jdbcTemplate` å­—æ®µæ²¡æœ‰æ ‡è®° `@Autowired`ï¼Œæ‰€ä»¥ï¼Œå­ç±»æƒ³è¦æ³¨å…¥ `JdbcTemplate`ï¼Œè¿˜å¾—è‡ªå·±æƒ³ä¸ªåŠæ³•ï¼š

```java
@Component
@Transactional
public class UserDao extends JdbcDaoSupport {
    @Autowired
    JdbcTemplate jdbcTemplate;

    @PostConstruct
    public void init() {
        super.setJdbcTemplate(jdbcTemplate);
    }
}
```

æœ‰çš„ç«¥é‹å¯èƒ½çœ‹å‡ºæ¥äº†ï¼šæ—¢ç„¶ `UserDao` éƒ½å·²ç»æ³¨å…¥äº† `JdbcTemplate`ï¼Œé‚£å†æŠŠå®ƒæ”¾åˆ°çˆ¶ç±»é‡Œï¼Œé€šè¿‡ `getJdbcTemplate()` è®¿é—®å²‚ä¸æ˜¯å¤šæ­¤ä¸€ä¸¾ï¼Ÿ

å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„ XML é…ç½®ï¼Œå¹¶ä¸éœ€è¦ç¼–å†™ `@Autowired JdbcTemplate jdbcTemplate`ï¼Œä½†æ˜¯è€ƒè™‘åˆ°ç°åœ¨åŸºæœ¬ä¸Šæ˜¯ä½¿ç”¨æ³¨è§£çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª `AbstractDao`ï¼Œä¸“é—¨è´Ÿè´£æ³¨å…¥ `JdbcTemplate`ï¼š

```java
public abstract class AbstractDao extends JdbcDaoSupport {
    @Autowired
    private JdbcTemplate jdbcTemplate;

    @PostConstruct
    public void init() {
        super.setJdbcTemplate(jdbcTemplate);
    }
}
```

è¿™æ ·ï¼Œå­ç±»çš„ä»£ç å°±éå¸¸å¹²å‡€ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ `getJdbcTemplate()`ï¼š

```java
@Component
@Transactional
public class UserDao extends AbstractDao {
    public User getById(long id) {
        return getJdbcTemplate().queryForObject(
                "SELECT * FROM users WHERE id = ?",
                new BeanPropertyRowMapper<>(User.class),
                id
        );
    }
    ...
}
```

å€˜è‹¥è‚¯å†å¤šå†™ä¸€ç‚¹æ ·æ¿ä»£ç ï¼Œå°±å¯ä»¥æŠŠ `AbstractDao` æ”¹æˆæ³›å‹ï¼Œå¹¶å®ç° `getById()`ï¼Œ`getAll()`ï¼Œ`deleteById()` è¿™æ ·çš„é€šç”¨æ–¹æ³•ï¼š

```java
public abstract class AbstractDao<T> extends JdbcDaoSupport {
    private String table;
    private Class<T> entityClass;
    private RowMapper<T> rowMapper;

    public AbstractDao() {
        // è·å–å½“å‰ç±»å‹çš„æ³›å‹ç±»å‹:
        this.entityClass = getParameterizedType();
        this.table = this.entityClass.getSimpleName().toLowerCase() + "s";
        this.rowMapper = new BeanPropertyRowMapper<>(entityClass);
    }

    public T getById(long id) {
        return getJdbcTemplate().queryForObject("SELECT * FROM" + table + "WHERE id = ?", this.rowMapper, id);
    }

    public List<T> getAll(int pageIndex) {
        int limit = 100;
        int offset = limit * (pageIndex - 1);
        return getJdbcTemplate().query("SELECT * FROM" + table + "LIMIT ? OFFSET ?",
                new Object[] { limit, offset},
                this.rowMapper);
    }

    public void deleteById(long id) {
        getJdbcTemplate().update("DELETE FROM" + table + "WHERE id = ?", id);
    }
    ...
}
```

è¿™æ ·ï¼Œæ¯ä¸ªå­ç±»å°±è‡ªåŠ¨è·å¾—äº†è¿™äº›é€šç”¨æ–¹æ³•ï¼š

```java
@Component
@Transactional
public class UserDao extends AbstractDao<User> {
    // å·²ç»æœ‰äº†:
    // User getById(long)
    // List<User> getAll(int)
    // void deleteById(long)
}

@Component
@Transactional
public class BookDao extends AbstractDao<Book> {
    // å·²ç»æœ‰äº†:
    // Book getById(long)
    // List<Book> getAll(int)
    // void deleteById(long)
}
```

å¯è§ï¼ŒDAO æ¨¡å¼å°±æ˜¯ä¸€ä¸ªç®€å•çš„æ•°æ®è®¿é—®æ¨¡å¼ï¼Œæ˜¯å¦ä½¿ç”¨ DAOï¼Œæ ¹æ®å®é™…æƒ…å†µå†³å®šï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™ï¼Œç›´æ¥åœ¨ Service å±‚æ“ä½œæ•°æ®åº“ä¹Ÿæ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ã€‚

### ç»ƒä¹ 


### å°ç»“

Spring æä¾›äº† `JdbcDaoSupport` æ¥ä¾¿äºæˆ‘ä»¬å®ç° DAO æ¨¡å¼ï¼›

å¯ä»¥åŸºäºæ³›å‹å®ç°æ›´é€šç”¨ã€æ›´ç®€æ´çš„ DAO æ¨¡å¼ã€‚



## ğŸ€ é›†æˆ Hibernate


ä½¿ç”¨ `JdbcTemplate` çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç”¨å¾—æœ€å¤šçš„æ–¹æ³•å°±æ˜¯ `List<T> query(String, RowMapper, Object...)`ã€‚è¿™ä¸ª `RowMapper` çš„ä½œç”¨å°±æ˜¯æŠŠ `ResultSet` çš„ä¸€è¡Œè®°å½•æ˜ å°„ä¸º Java Beanã€‚

è¿™ç§æŠŠå…³ç³»æ•°æ®åº“çš„è¡¨è®°å½•æ˜ å°„ä¸º Java å¯¹è±¡çš„è¿‡ç¨‹å°±æ˜¯ ORMï¼šObject-Relational Mappingã€‚ORM æ—¢å¯ä»¥æŠŠè®°å½•è½¬æ¢æˆ Java å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æŠŠ Java å¯¹è±¡è½¬æ¢ä¸ºè¡Œè®°å½•ã€‚

ä½¿ç”¨ `JdbcTemplate` é…åˆ `RowMapper` å¯ä»¥çœ‹ä½œæ˜¯æœ€åŸå§‹çš„ ORMã€‚å¦‚æœè¦å®ç°æ›´è‡ªåŠ¨åŒ–çš„ ORMï¼Œå¯ä»¥é€‰æ‹©æˆç†Ÿçš„ ORM æ¡†æ¶ï¼Œä¾‹å¦‚ [Hibernate](https://hibernate.org/)ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åœ¨ Spring ä¸­é›†æˆ Hibernateã€‚

Hibernate ä½œä¸º ORM æ¡†æ¶ï¼Œå®ƒå¯ä»¥æ›¿ä»£ `JdbcTemplate`ï¼Œä½† Hibernate ä»ç„¶éœ€è¦ JDBC é©±åŠ¨ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ JDBC é©±åŠ¨ã€è¿æ¥æ± ï¼Œä»¥åŠ Hibernate æœ¬èº«ã€‚åœ¨ Maven ä¸­ï¼Œæˆ‘ä»¬åŠ å…¥ä»¥ä¸‹ä¾èµ–é¡¹ï¼š

- org.springframework:spring-context:6.0.0
- org.springframework:spring-orm:6.0.0
- jakarta.annotation:jakarta.annotation-api:2.1.1
- jakarta.persistence:jakarta.persistence-api:3.1.0
- org.hibernate:hibernate-core:6.1.4.Final
- com.zaxxer:HikariCP:5.0.1
- org.hsqldb:hsqldb:2.7.1

åœ¨ `AppConfig` ä¸­ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦åˆ›å»º `DataSource`ã€å¼•å…¥ JDBC é…ç½®æ–‡ä»¶ï¼Œä»¥åŠå¯ç”¨å£°æ˜å¼äº‹åŠ¡ï¼š

```java
@Configuration
@ComponentScan
@EnableTransactionManagement
@PropertySource("jdbc.properties")
public class AppConfig {
    @Bean
    DataSource createDataSource() {
        ...
    }
}
```

ä¸ºäº†å¯ç”¨ Hibernateï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª `LocalSessionFactoryBean`ï¼š

```java
public class AppConfig {
    @Bean
    LocalSessionFactoryBean createSessionFactory(@Autowired DataSource dataSource) {
        var props = new Properties();
        props.setProperty("hibernate.hbm2ddl.auto", "update"); // ç”Ÿäº§ç¯å¢ƒä¸è¦ä½¿ç”¨
        props.setProperty("hibernate.dialect", "org.hibernate.dialect.HSQLDialect");
        props.setProperty("hibernate.show_sql", "true");
        var sessionFactoryBean = new LocalSessionFactoryBean();
        sessionFactoryBean.setDataSource(dataSource);
        // æ‰«ææŒ‡å®šçš„ package è·å–æ‰€æœ‰ entity class:
        sessionFactoryBean.setPackagesToScan("com.itranswarp.learnjava.entity");
        sessionFactoryBean.setHibernateProperties(props);
        return sessionFactoryBean;
    }
}
```

æ³¨æ„æˆ‘ä»¬åœ¨ [å®šåˆ¶ Bean](/1-Java/21_Springå¼€å‘/1.md#å®šåˆ¶-Bean) ä¸­è®²åˆ°è¿‡ `FactoryBean`ï¼Œ`LocalSessionFactoryBean` æ˜¯ä¸€ä¸ª `FactoryBean`ï¼Œå®ƒä¼šå†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª `SessionFactory`ï¼Œåœ¨ Hibernate ä¸­ï¼Œ`Session` æ˜¯å°è£…äº†ä¸€ä¸ª JDBC `Connection` çš„å®ä¾‹ï¼Œè€Œ `SessionFactory` æ˜¯å°è£…äº† JDBC `DataSource` çš„å®ä¾‹ï¼Œå³ `SessionFactory` æŒæœ‰è¿æ¥æ± ï¼Œæ¯æ¬¡éœ€è¦æ“ä½œæ•°æ®åº“çš„æ—¶å€™ï¼Œ`SessionFactory` åˆ›å»ºä¸€ä¸ªæ–°çš„ `Session`ï¼Œç›¸å½“äºä»è¿æ¥æ± è·å–åˆ°ä¸€ä¸ªæ–°çš„ `Connection`ã€‚`SessionFactory` å°±æ˜¯ Hibernate æä¾›çš„æœ€æ ¸å¿ƒçš„ä¸€ä¸ªå¯¹è±¡ï¼Œä½† `LocalSessionFactoryBean` æ˜¯ Spring æä¾›çš„ä¸ºäº†è®©æˆ‘ä»¬æ–¹ä¾¿åˆ›å»º `SessionFactory` çš„ç±»ã€‚

æ³¨æ„åˆ°ä¸Šé¢åˆ›å»º `LocalSessionFactoryBean` çš„ä»£ç ï¼Œé¦–å…ˆç”¨ `Properties` æŒæœ‰ Hibernate åˆå§‹åŒ– `SessionFactory` æ—¶ç”¨åˆ°çš„æ‰€æœ‰è®¾ç½®ï¼Œå¸¸ç”¨çš„è®¾ç½®è¯·å‚è€ƒ [Hibernate æ–‡æ¡£](https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#configurations)ï¼Œè¿™é‡Œæˆ‘ä»¬åªå®šä¹‰äº† 3 ä¸ªè®¾ç½®ï¼š

- `hibernate.hbm2ddl.auto=update`ï¼šè¡¨ç¤ºè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“çš„è¡¨ç»“æ„ï¼Œæ³¨æ„ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨ï¼›
- `hibernate.dialect=org.hibernate.dialect.HSQLDialect`ï¼šæŒ‡ç¤º Hibernate ä½¿ç”¨çš„æ•°æ®åº“æ˜¯ HSQLDBã€‚Hibernate ä½¿ç”¨ä¸€ç§ HQL çš„æŸ¥è¯¢è¯­å¥ï¼Œå®ƒå’Œ SQL ç±»ä¼¼ï¼Œä½†çœŸæ­£åœ¨ â€œç¿»è¯‘â€ æˆ SQL æ—¶ï¼Œä¼šæ ¹æ®è®¾å®šçš„æ•°æ®åº“ â€œæ–¹è¨€â€ æ¥ç”Ÿæˆé’ˆå¯¹æ•°æ®åº“ä¼˜åŒ–çš„ SQLï¼›
- `hibernate.show_sql=true`ï¼šè®© Hibernate æ‰“å°æ‰§è¡Œçš„ SQLï¼Œè¿™å¯¹äºè°ƒè¯•éå¸¸æœ‰ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°çœ‹åˆ° Hibernate ç”Ÿæˆçš„ SQL è¯­å¥æ˜¯å¦ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚

é™¤äº†è®¾ç½® `DataSource` å’Œ `Properties` ä¹‹å¤–ï¼Œæ³¨æ„åˆ° `setPackagesToScan()` æˆ‘ä»¬ä¼ å…¥äº†ä¸€ä¸ª `package` åç§°ï¼Œå®ƒæŒ‡ç¤º Hibernate æ‰«æè¿™ä¸ªåŒ…ä¸‹é¢çš„æ‰€æœ‰ Java ç±»ï¼Œè‡ªåŠ¨æ‰¾å‡ºèƒ½æ˜ å°„ä¸ºæ•°æ®åº“è¡¨è®°å½•çš„ JavaBeanã€‚åé¢æˆ‘ä»¬ä¼šä»”ç»†è®¨è®ºå¦‚ä½•ç¼–å†™ç¬¦åˆ Hibernate è¦æ±‚çš„ JavaBeanã€‚

ç´§æ¥ç€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»º `HibernateTransactionManager`ï¼š

```java
public class AppConfig {
    @Bean
    PlatformTransactionManager createTxManager(@Autowired SessionFactory sessionFactory) {
        return new HibernateTransactionManager(sessionFactory);
    }
}
```

`HibernateTransactionManager` æ˜¯é…åˆ Hibernate ä½¿ç”¨å£°æ˜å¼äº‹åŠ¡æ‰€å¿…é¡»çš„ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œæ‰€æœ‰çš„é…ç½®éƒ½å®šä¹‰å®Œæ¯•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å°†æ•°æ®åº“è¡¨ç»“æ„æ˜ å°„ä¸º Java å¯¹è±¡ã€‚

è€ƒå¯Ÿå¦‚ä¸‹çš„æ•°æ®åº“è¡¨ï¼š

```sql
CREATE TABLE user
    id BIGINT NOT NULL AUTO_INCREMENT,
    email VARCHAR(100) NOT NULL,
    password VARCHAR(100) NOT NULL,
    name VARCHAR(100) NOT NULL,
    createdAt BIGINT NOT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `email` (`email`)
;
```

å…¶ä¸­ï¼Œ`id` æ˜¯è‡ªå¢ä¸»é”®ï¼Œ`email`ã€`password`ã€`name` æ˜¯ `VARCHAR` ç±»å‹ï¼Œ`email` å¸¦å”¯ä¸€ç´¢å¼•ä»¥ç¡®ä¿å”¯ä¸€æ€§ï¼Œ`createdAt` å­˜å‚¨æ•´å‹ç±»å‹çš„æ—¶é—´æˆ³ã€‚ç”¨ JavaBean è¡¨ç¤ºå¦‚ä¸‹ï¼š

```java
public class User {
    private Long id;
    private String email;
    private String password;
    private String name;
    private Long createdAt;

    // getters and setters
    ...
}
```

è¿™ç§æ˜ å°„å…³ç³»ååˆ†æ˜“æ‡‚ï¼Œä½†æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›æ³¨è§£æ¥å‘Šè¯‰ Hibernate å¦‚ä½•æŠŠ `User` ç±»æ˜ å°„åˆ°è¡¨è®°å½•ï¼š

```java
@Entity
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(nullable = false, updatable = false)
    public Long getId() { ...}

    @Column(nullable = false, unique = true, length = 100)
    public String getEmail() { ...}

    @Column(nullable = false, length = 100)
    public String getPassword() { ...}

    @Column(nullable = false, length = 100)
    public String getName() { ...}

    @Column(nullable = false, updatable = false)
    public Long getCreatedAt() { ...}
}
```

å¦‚æœä¸€ä¸ª JavaBean è¢«ç”¨äºæ˜ å°„ï¼Œæˆ‘ä»¬å°±æ ‡è®°ä¸€ä¸ª `@Entity`ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜ å°„çš„è¡¨åæ˜¯ `user`ï¼Œå¦‚æœå®é™…çš„è¡¨åä¸åŒï¼Œä¾‹å¦‚å®é™…è¡¨åæ˜¯ `users`ï¼Œå¯ä»¥è¿½åŠ ä¸€ä¸ª `@Table(name="users")` è¡¨ç¤ºï¼š

```java
@Entity
@Table(name="users")
public class User {
    ...
}
```

æ¯ä¸ªå±æ€§åˆ°æ•°æ®åº“åˆ—çš„æ˜ å°„ç”¨ `@Column()` æ ‡è¯†ï¼Œ`nullable` æŒ‡ç¤ºåˆ—æ˜¯å¦å…è®¸ä¸º `NULL`ï¼Œ`updatable` æŒ‡ç¤ºè¯¥åˆ—æ˜¯å¦å…è®¸è¢«ç”¨åœ¨ `UPDATE` è¯­å¥ï¼Œ`length` æŒ‡ç¤º `String` ç±»å‹çš„åˆ—çš„é•¿åº¦ï¼ˆå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤æ˜¯ `255`ï¼‰ã€‚

å¯¹äºä¸»é”®ï¼Œè¿˜éœ€è¦ç”¨ `@Id` æ ‡è¯†ï¼Œè‡ªå¢ä¸»é”®å†è¿½åŠ ä¸€ä¸ª `@GeneratedValue`ï¼Œä»¥ä¾¿ Hibernate èƒ½è¯»å–åˆ°è‡ªå¢ä¸»é”®çš„å€¼ã€‚

ç»†å¿ƒçš„ç«¥é‹å¯èƒ½è¿˜æ³¨æ„åˆ°ï¼Œä¸»é”® `id` å®šä¹‰çš„ç±»å‹ä¸æ˜¯ `long`ï¼Œè€Œæ˜¯ `Long`ã€‚è¿™æ˜¯å› ä¸º Hibernate å¦‚æœæ£€æµ‹åˆ°ä¸»é”®ä¸º `null`ï¼Œå°±ä¸ä¼šåœ¨ `INSERT` è¯­å¥ä¸­æŒ‡å®šä¸»é”®çš„å€¼ï¼Œè€Œæ˜¯è¿”å›ç”±æ•°æ®åº“ç”Ÿæˆçš„è‡ªå¢å€¼ï¼Œå¦åˆ™ï¼ŒHibernate è®¤ä¸ºæˆ‘ä»¬çš„ç¨‹åºæŒ‡å®šäº†ä¸»é”®çš„å€¼ï¼Œä¼šåœ¨ `INSERT` è¯­å¥ä¸­ç›´æ¥åˆ—å‡ºã€‚`long` å‹å­—æ®µæ€»æ˜¯å…·æœ‰é»˜è®¤å€¼ `0`ï¼Œå› æ­¤ï¼Œæ¯æ¬¡æ’å…¥çš„ä¸»é”®å€¼æ€»æ˜¯ 0ï¼Œå¯¼è‡´é™¤ç¬¬ä¸€æ¬¡å¤–åç»­æ’å…¥éƒ½å°†å¤±è´¥ã€‚

`createdAt` è™½ç„¶æ˜¯æ•´å‹ï¼Œä½†æˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨ `long`ï¼Œè€Œæ˜¯ `Long`ï¼Œè¿™æ˜¯å› ä¸ºä½¿ç”¨åŸºæœ¬ç±»å‹ä¼šå¯¼è‡´ findByExample æŸ¥è¯¢ä¼šæ·»åŠ æ„å¤–çš„æ¡ä»¶ï¼Œè¿™é‡Œåªéœ€ç‰¢è®°ï¼Œä½œä¸ºæ˜ å°„ä½¿ç”¨çš„ JavaBeanï¼Œæ‰€æœ‰å±æ€§éƒ½ä½¿ç”¨åŒ…è£…ç±»å‹è€Œä¸æ˜¯åŸºæœ¬ç±»å‹ã€‚

> [!WARNNING]
> ä½¿ç”¨ Hibernate æ—¶ï¼Œä¸è¦ä½¿ç”¨åŸºæœ¬ç±»å‹çš„å±æ€§ï¼Œæ€»æ˜¯ä½¿ç”¨åŒ…è£…ç±»å‹ï¼Œå¦‚ Long æˆ– Integerã€‚

ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ª `Book` ç±»ï¼š

```java
@Entity
public class Book {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(nullable = false, updatable = false)
    public Long getId() { ...}

    @Column(nullable = false, length = 100)
    public String getTitle() { ...}

    @Column(nullable = false, updatable = false)
    public Long getCreatedAt() { ...}
}
```

å¦‚æœä»”ç»†è§‚å¯Ÿ `User` å’Œ `Book`ï¼Œä¼šå‘ç°å®ƒä»¬å®šä¹‰çš„ `id`ã€`createdAt` å±æ€§æ˜¯ä¸€æ ·çš„ï¼Œè¿™åœ¨æ•°æ®åº“è¡¨ç»“æ„çš„è®¾è®¡ä¸­å¾ˆå¸¸è§ï¼šå¯¹äºæ¯ä¸ªè¡¨ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç»Ÿä¸€ä½¿ç”¨ä¸€ç§ä¸»é”®ç”Ÿæˆæœºåˆ¶ï¼Œå¹¶æ·»åŠ  `createdAt` è¡¨ç¤ºåˆ›å»ºæ—¶é—´ï¼Œ`updatedAt` è¡¨ç¤ºä¿®æ”¹æ—¶é—´ç­‰é€šç”¨å­—æ®µã€‚

ä¸å¿…åœ¨ `User` å’Œ `Book` ä¸­é‡å¤å®šä¹‰è¿™äº›é€šç”¨å­—æ®µï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬æåˆ°ä¸€ä¸ªæŠ½è±¡ç±»ä¸­ï¼š

```java
@MappedSuperclass
public abstract class AbstractEntity {

    private Long id;
    private Long createdAt;

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(nullable = false, updatable = false)
    public Long getId() { ...}

    @Column(nullable = false, updatable = false)
    public Long getCreatedAt() { ...}

    @Transient
    public ZonedDateTime getCreatedDateTime() {
        return Instant.ofEpochMilli(this.createdAt).atZone(ZoneId.systemDefault());
    }

    @PrePersist
    public void preInsert() {
        setCreatedAt(System.currentTimeMillis());
    }
}
```

å¯¹äº `AbstractEntity` æ¥è¯´ï¼Œæˆ‘ä»¬è¦æ ‡æ³¨ä¸€ä¸ª `@MappedSuperclass` è¡¨ç¤ºå®ƒç”¨äºç»§æ‰¿ã€‚æ­¤å¤–ï¼Œæ³¨æ„åˆ°æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `@Transient` æ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€ä¸ª â€œè™šæ‹Ÿâ€ çš„å±æ€§ã€‚å› ä¸º `getCreatedDateTime()` æ˜¯è®¡ç®—å¾—å‡ºçš„å±æ€§ï¼Œè€Œä¸æ˜¯ä»æ•°æ®åº“è¡¨è¯»å‡ºçš„å€¼ï¼Œå› æ­¤å¿…é¡»è¦æ ‡æ³¨ `@Transient`ï¼Œå¦åˆ™ Hibernate ä¼šå°è¯•ä»æ•°æ®åº“è¯»å–åä¸º `createdDateTime` è¿™ä¸ªä¸å­˜åœ¨çš„å­—æ®µä»è€Œå‡ºé”™ã€‚

å†æ³¨æ„åˆ° `@PrePersist` æ ‡è¯†çš„æ–¹æ³•ï¼Œå®ƒè¡¨ç¤ºåœ¨æˆ‘ä»¬å°†ä¸€ä¸ª JavaBean æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¹‹å‰ï¼ˆå³æ‰§è¡Œ INSERT è¯­å¥ï¼‰ï¼ŒHibernate ä¼šå…ˆæ‰§è¡Œè¯¥æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è‡ªåŠ¨è®¾ç½®å¥½ `createdAt` å±æ€§ã€‚

æœ‰äº† `AbstractEntity`ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤§å¹…ç®€åŒ– `User` å’Œ `Book`ï¼š

```java
@Entity
public class User extends AbstractEntity {

    @Column(nullable = false, unique = true, length = 100)
    public String getEmail() { ...}

    @Column(nullable = false, length = 100)
    public String getPassword() { ...}

    @Column(nullable = false, length = 100)
    public String getName() { ...}
}
```

æ³¨æ„åˆ°ä½¿ç”¨çš„æ‰€æœ‰æ³¨è§£å‡æ¥è‡ª `jakarta.persistence`ï¼Œå®ƒæ˜¯ JPA è§„èŒƒçš„ä¸€éƒ¨åˆ†ã€‚è¿™é‡Œæˆ‘ä»¬åªä»‹ç»ä½¿ç”¨æ³¨è§£çš„æ–¹å¼é…ç½® Hibernate æ˜ å°„å…³ç³»ï¼Œä¸å†ä»‹ç»ä¼ ç»Ÿçš„æ¯”è¾ƒç¹ççš„ XML é…ç½®ã€‚é€šè¿‡ Spring é›†æˆ Hibernate æ—¶ï¼Œä¹Ÿä¸å†éœ€è¦ `hibernate.cfg.xml` é…ç½®æ–‡ä»¶ï¼Œç”¨ä¸€å¥è¯æ€»ç»“ï¼š

 ä½¿ç”¨ Spring é›†æˆ Hibernateï¼Œé…åˆ JPA æ³¨è§£ï¼Œæ— éœ€ä»»ä½•é¢å¤–çš„ XML é…ç½®ã€‚

ç±»ä¼¼ `User`ã€`Book` è¿™æ ·çš„ç”¨äº ORM çš„ Java Beanï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¹‹ä¸º Entity Beanã€‚

æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚æœå¯¹ `user` è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚å› ä¸ºä½¿ç”¨äº† Hibernateï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¦åšçš„ï¼Œå®é™…ä¸Šæ˜¯å¯¹ `User` è¿™ä¸ª JavaBean è¿›è¡Œ â€œå¢åˆ æ”¹æŸ¥â€ã€‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ª `UserService`ï¼Œæ³¨å…¥ `SessionFactory`ï¼š

```java
@Component
@Transactional
public class UserService {
    @Autowired
    SessionFactory sessionFactory;
}
```

### Insert æ“ä½œ

è¦æŒä¹…åŒ–ä¸€ä¸ª `User` å®ä¾‹ï¼Œæˆ‘ä»¬åªéœ€è°ƒç”¨ `persist()` æ–¹æ³•ã€‚ä»¥ `register()` æ–¹æ³•ä¸ºä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
public User register(String email, String password, String name) {
    // åˆ›å»ºä¸€ä¸ª User å¯¹è±¡:
    User user = new User();
    // è®¾ç½®å¥½å„ä¸ªå±æ€§:
    user.setEmail(email);
    user.setPassword(password);
    user.setName(name);
    // ä¸è¦è®¾ç½® idï¼Œå› ä¸ºä½¿ç”¨äº†è‡ªå¢ä¸»é”®
    // ä¿å­˜åˆ°æ•°æ®åº“:
    sessionFactory.getCurrentSession().persist(user);
    // ç°åœ¨å·²ç»è‡ªåŠ¨è·å¾—äº† id:
    System.out.println(user.getId());
    return user;
}
```

### Delete æ“ä½œ

åˆ é™¤ä¸€ä¸ª `User` ç›¸å½“äºä»è¡¨ä¸­åˆ é™¤å¯¹åº”çš„è®°å½•ã€‚æ³¨æ„ Hibernate æ€»æ˜¯ç”¨ `id` æ¥åˆ é™¤è®°å½•ï¼Œå› æ­¤ï¼Œè¦æ­£ç¡®è®¾ç½® `User` çš„ `id` å±æ€§æ‰èƒ½æ­£å¸¸åˆ é™¤è®°å½•ï¼š

```java
public boolean deleteUser(Long id) {
    User user = sessionFactory.getCurrentSession().byId(User.class).load(id);
    if (user != null) {
        sessionFactory.getCurrentSession().remove(user);
        return true;
    }
    return false;
}
```

é€šè¿‡ä¸»é”®åˆ é™¤è®°å½•æ—¶ï¼Œä¸€ä¸ªå¸¸è§çš„ç”¨æ³•æ˜¯å…ˆæ ¹æ®ä¸»é”®åŠ è½½è¯¥è®°å½•ï¼Œå†åˆ é™¤ã€‚æ³¨æ„åˆ°å½“è®°å½•ä¸å­˜åœ¨æ—¶ï¼Œ`load()` è¿”å› `null`ã€‚

### Update æ“ä½œ

æ›´æ–°è®°å½•ç›¸å½“äºå…ˆæ›´æ–° `User` çš„æŒ‡å®šå±æ€§ï¼Œç„¶åè°ƒç”¨ `merge()` æ–¹æ³•ï¼š

```java
public void updateUser(Long id, String name) {
    User user = sessionFactory.getCurrentSession().byId(User.class).load(id);
    user.setName(name);
    sessionFactory.getCurrentSession().merge(user);
}
```

å‰é¢æˆ‘ä»¬åœ¨å®šä¹‰ `User` æ—¶ï¼Œå¯¹æœ‰çš„å±æ€§æ ‡æ³¨äº† `@Column(updatable=false)`ã€‚Hibernate åœ¨æ›´æ–°è®°å½•æ—¶ï¼Œå®ƒåªä¼šæŠŠ `@Column(updatable=true)` çš„å±æ€§åŠ å…¥åˆ° `UPDATE` è¯­å¥ä¸­ï¼Œè¿™æ ·å¯ä»¥æä¾›ä¸€å±‚é¢å¤–çš„å®‰å…¨æ€§ï¼Œå³å¦‚æœä¸å°å¿ƒä¿®æ”¹äº† `User` çš„ `email`ã€`createdAt` ç­‰å±æ€§ï¼Œæ‰§è¡Œ `update()` æ—¶å¹¶ä¸ä¼šæ›´æ–°å¯¹åº”çš„æ•°æ®åº“åˆ—ã€‚ä½†ä¹Ÿå¿…é¡»ç‰¢è®°ï¼šè¿™ä¸ªåŠŸèƒ½æ˜¯ Hibernate æä¾›çš„ï¼Œå¦‚æœç»•è¿‡ Hibernate ç›´æ¥é€šè¿‡ JDBC æ‰§è¡Œ `UPDATE` è¯­å¥ä»ç„¶å¯ä»¥æ›´æ–°æ•°æ®åº“çš„ä»»æ„åˆ—çš„å€¼ã€‚

æœ€åï¼Œæˆ‘ä»¬ç¼–å†™çš„å¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ˜¯å„ç§å„æ ·çš„æŸ¥è¯¢ã€‚æ ¹æ® `id` æŸ¥è¯¢æˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ `load()`ï¼Œå¦‚æœè¦ä½¿ç”¨æ¡ä»¶æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ï¼š

```sql
SELECT * FROM user WHERE email = ? AND password = ?
```

æˆ‘ä»¬æ¥çœ‹çœ‹å¯ä»¥ä½¿ç”¨ä»€ä¹ˆæŸ¥è¯¢ã€‚

### ä½¿ç”¨ HQL æŸ¥è¯¢

ä¸€ç§å¸¸ç”¨çš„æŸ¥è¯¢æ˜¯ç›´æ¥ç¼–å†™ Hibernate å†…ç½®çš„ HQL æŸ¥è¯¢ï¼š

```java
List<User> list = sessionFactory.getCurrentSession()
        .createQuery("from User u where u.email = ?1 and u.password = ?2", User.class)
        .setParameter(1, email).setParameter(2, password)
        .list();
```

å’Œ SQL ç›¸æ¯”ï¼ŒHQL ä½¿ç”¨ç±»åå’Œå±æ€§åï¼Œç”± Hibernate è‡ªåŠ¨è½¬æ¢ä¸ºå®é™…çš„è¡¨åå’Œåˆ—åã€‚è¯¦ç»†çš„ HQL è¯­æ³•å¯ä»¥å‚è€ƒ [Hibernate æ–‡æ¡£](https://docs.jboss.org/hibernate/orm/6.1/userguide/html_single/Hibernate_User_Guide.html#query-language)ã€‚

é™¤äº†å¯ä»¥ç›´æ¥ä¼ å…¥ HQL å­—ç¬¦ä¸²å¤–ï¼ŒHibernate è¿˜å¯ä»¥ä½¿ç”¨ä¸€ç§ `NamedQuery`ï¼Œå®ƒç»™æŸ¥è¯¢èµ·ä¸ªåå­—ï¼Œç„¶åä¿å­˜åœ¨æ³¨è§£ä¸­ã€‚ä½¿ç”¨ `NamedQuery` æ—¶ï¼Œæˆ‘ä»¬è¦å…ˆåœ¨ `User` ç±»æ ‡æ³¨ï¼š

```java
@NamedQueries(
    @NamedQuery(
        // æŸ¥è¯¢åç§°:
        name = "login",
        // æŸ¥è¯¢è¯­å¥:
        query = "SELECT u FROM User u WHERE u.email = :e AND u.password = :pwd"
    )
)
@Entity
public class User extends AbstractEntity {
    ...
}
```

æ³¨æ„åˆ°å¼•å…¥çš„ `NamedQuery` æ˜¯ `jakarta.persistence.NamedQuery`ï¼Œå®ƒå’Œç›´æ¥ä¼ å…¥ HQL æœ‰ç‚¹ä¸åŒçš„æ˜¯ï¼Œå ä½ç¬¦ä½¿ç”¨ `:e` å’Œ `:pwd`ã€‚

ä½¿ç”¨ `NamedQuery` åªéœ€è¦å¼•å…¥æŸ¥è¯¢åå’Œå‚æ•°ï¼š

```java
public User login(String email, String password) {
    List<User> list = sessionFactory.getCurrentSession()
        .createNamedQuery("login", User.class) // åˆ›å»º NamedQuery
        .setParameter("e", email) // ç»‘å®š e å‚æ•°
        .setParameter("pwd", password) // ç»‘å®š pwd å‚æ•°
        .list();
    return list.isEmpty() ? null : list.get(0);
}
```

ç›´æ¥å†™ HQL å’Œä½¿ç”¨ `NamedQuery` å„æœ‰ä¼˜åŠ£ã€‚å‰è€…å¯ä»¥åœ¨ä»£ç ä¸­ç›´è§‚åœ°çœ‹åˆ°æŸ¥è¯¢è¯­å¥ï¼Œåè€…å¯ä»¥åœ¨ `User` ç±»ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç›¸å…³æŸ¥è¯¢ã€‚

### ç»ƒä¹ 


### å°ç»“

åœ¨ Spring ä¸­é›†æˆ Hibernate éœ€è¦é…ç½®çš„ Bean å¦‚ä¸‹ï¼š

- DataSourceï¼›
- LocalSessionFactoryï¼›
- HibernateTransactionManagerã€‚

æ¨èä½¿ç”¨ Annotation é…ç½®æ‰€æœ‰çš„ Entity Beanã€‚



## ğŸ€ é›†æˆ JPA


ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²äº†åœ¨ Spring ä¸­é›†æˆ Hibernateã€‚Hibernate æ˜¯ç¬¬ä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„ ORM æ¡†æ¶ï¼Œä½†æ˜¯å¾ˆå¤šå°ä¼™ä¼´è¿˜å¬è¯´è¿‡ JPAï¼šJava Persistence APIï¼Œè¿™åˆæ˜¯å•¥ï¼Ÿ

åœ¨è®¨è®º JPA ä¹‹å‰ï¼Œæˆ‘ä»¬è¦æ³¨æ„åˆ° JavaEE æ—©åœ¨ 1999 å¹´å°±å‘å¸ƒäº†ï¼Œå¹¶ä¸”æœ‰ Servletã€JMS ç­‰è¯¸å¤šæ ‡å‡†ã€‚å’Œå…¶ä»–å¹³å°ä¸åŒï¼ŒJava ä¸–ç•Œæ—©æœŸéå¸¸çƒ­è¡·äºæ ‡å‡†å…ˆè¡Œï¼Œå„å®¶è·Ÿè¿›ï¼šå¤§å®¶å…ˆåä¸‹æ¥æŠŠæ¥å£å®šäº†ï¼Œç„¶åï¼Œå„è‡ªå›å®¶å¹²æ´»å»å®ç°æ¥å£ï¼Œè¿™æ ·ï¼Œç”¨æˆ·å°±å¯ä»¥åœ¨ä¸åŒçš„å‚å®¶æä¾›çš„äº§å“è¿›è¡Œé€‰æ‹©ï¼Œè¿˜å¯ä»¥éšæ„åˆ‡æ¢ï¼Œå› ä¸ºç”¨æˆ·ç¼–å†™ä»£ç çš„æ—¶å€™åªéœ€è¦å¼•ç”¨æ¥å£ï¼Œå¹¶ä¸éœ€è¦å¼•ç”¨å…·ä½“çš„åº•å±‚å®ç°ï¼ˆæƒ³æƒ³ JDBCï¼‰ã€‚

JPA å°±æ˜¯ JavaEE çš„ä¸€ä¸ª ORM æ ‡å‡†ï¼Œå®ƒçš„å®ç°å…¶å®å’Œ Hibernate æ²¡å•¥æœ¬è´¨åŒºåˆ«ï¼Œä½†æ˜¯ç”¨æˆ·å¦‚æœä½¿ç”¨ JPAï¼Œé‚£ä¹ˆå¼•ç”¨çš„å°±æ˜¯ `jakarta.persistence` è¿™ä¸ª â€œæ ‡å‡†â€ åŒ…ï¼Œè€Œä¸æ˜¯ `org.hibernate` è¿™æ ·çš„ç¬¬ä¸‰æ–¹åŒ…ã€‚å› ä¸º JPA åªæ˜¯æ¥å£ï¼Œæ‰€ä»¥ï¼Œè¿˜éœ€è¦é€‰æ‹©ä¸€ä¸ªå®ç°äº§å“ï¼Œè·Ÿ JDBC æ¥å£å’Œ MySQL é©±åŠ¨ä¸€ä¸ªé“ç†ã€‚

æˆ‘ä»¬ä½¿ç”¨ JPA æ—¶ä¹Ÿå®Œå…¨å¯ä»¥é€‰æ‹© Hibernate ä½œä¸ºåº•å±‚å®ç°ï¼Œä½†ä¹Ÿå¯ä»¥é€‰æ‹©å…¶å®ƒçš„ JPA æä¾›æ–¹ï¼Œæ¯”å¦‚ [EclipseLink](https://www.eclipse.org/eclipselink/)ã€‚Spring å†…ç½®äº† JPA çš„é›†æˆï¼Œå¹¶æ”¯æŒé€‰æ‹© Hibernate æˆ– EclipseLink ä½œä¸ºå®ç°ã€‚è¿™é‡Œæˆ‘ä»¬ä»ç„¶ä»¥ä¸»æµçš„ Hibernate ä½œä¸º JPA å®ç°ä¸ºä¾‹å­ï¼Œæ¼”ç¤º JPA çš„åŸºæœ¬ç”¨æ³•ã€‚

å’Œä½¿ç”¨ Hibernate ä¸€æ ·ï¼Œæˆ‘ä»¬åªéœ€è¦å¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š

- org.springframework:spring-context:6.0.0
- org.springframework:spring-orm:6.0.0
- jakarta.annotation:jakarta.annotation-api:2.1.1
- jakarta.persistence:jakarta.persistence-api:3.1.0
- org.hibernate:hibernate-core:6.1.4.Final
- com.zaxxer:HikariCP:5.0.1
- org.hsqldb:hsqldb:2.7.1

å®é™…ä¸Šæˆ‘ä»¬è¿™é‡Œå¼•å…¥çš„ä¾èµ–å’Œä¸Šä¸€èŠ‚é›†æˆ Hibernate å¼•å…¥çš„ä¾èµ–å®Œå…¨ä¸€æ ·ï¼Œå› ä¸º Hibernate æ—¢æä¾›äº†å®ƒè‡ªå·±çš„æ¥å£ï¼Œä¹Ÿæä¾›äº† JPA æ¥å£ï¼Œæˆ‘ä»¬ç”¨ JPA æ¥å£å°±ç›¸å½“äºé€šè¿‡ JPA æ“ä½œ Hibernateã€‚

ç„¶åï¼Œåœ¨ `AppConfig` ä¸­å¯ç”¨å£°æ˜å¼äº‹åŠ¡ç®¡ç†ï¼Œåˆ›å»º `DataSource`ï¼š

```java
@Configuration
@ComponentScan
@EnableTransactionManagement
@PropertySource("jdbc.properties")
public class AppConfig {
    @Bean
    DataSource createDataSource() { ...}
}
```

ä½¿ç”¨ Hibernate æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª `LocalSessionFactoryBean`ï¼Œå¹¶è®©å®ƒå†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª `SessionFactory`ã€‚ä½¿ç”¨ JPA ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬ä¹Ÿåˆ›å»ºä¸€ä¸ª `LocalContainerEntityManagerFactoryBean`ï¼Œå¹¶è®©å®ƒå†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª `EntityManagerFactory`ï¼š

```java
@Bean
public LocalContainerEntityManagerFactoryBean createEntityManagerFactory(@Autowired DataSource dataSource) {
    var emFactory = new LocalContainerEntityManagerFactoryBean();
    // æ³¨å…¥ DataSource:
    emFactory.setDataSource(dataSource);
    // æ‰«ææŒ‡å®šçš„ package è·å–æ‰€æœ‰ entity class:
    emFactory.setPackagesToScan(AbstractEntity.class.getPackageName());
    // ä½¿ç”¨ Hibernate ä½œä¸º JPA å®ç°:
    emFactory.setJpaVendorAdapter(new HibernateJpaVendorAdapter());
    // å…¶ä»–é…ç½®é¡¹:
    var props = new Properties();
    props.setProperty("hibernate.hbm2ddl.auto", "update"); // ç”Ÿäº§ç¯å¢ƒä¸è¦ä½¿ç”¨
    props.setProperty("hibernate.dialect", "org.hibernate.dialect.HSQLDialect");
    props.setProperty("hibernate.show_sql", "true");
    emFactory.setJpaProperties(props);
    return emFactory;
}
```

è§‚å¯Ÿä¸Šè¿°ä»£ç ï¼Œé™¤äº†éœ€è¦æ³¨å…¥ `DataSource` å’Œè®¾å®šè‡ªåŠ¨æ‰«æçš„ `package` å¤–ï¼Œè¿˜éœ€è¦æŒ‡å®š JPA çš„æä¾›å•†ï¼Œè¿™é‡Œä½¿ç”¨ Spring æä¾›çš„ä¸€ä¸ª `HibernateJpaVendorAdapter`ï¼Œæœ€åï¼Œé’ˆå¯¹ Hibernate è‡ªå·±éœ€è¦çš„é…ç½®ï¼Œä»¥ `Properties` çš„å½¢å¼æ³¨å…¥ã€‚

æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ª `JpaTransactionManager`ï¼Œä»¥å®ç°å£°æ˜å¼äº‹åŠ¡ï¼š

```java
@Bean
PlatformTransactionManager createTxManager(@Autowired EntityManagerFactory entityManagerFactory) {
    return new JpaTransactionManager(entityManagerFactory);
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº† JPA çš„å…¨éƒ¨åˆå§‹åŒ–å·¥ä½œã€‚æœ‰äº›ç«¥é‹å¯èƒ½ä»ç½‘ä¸Šæœç´¢å¾—çŸ¥ JPA éœ€è¦ `persistence.xml` é…ç½®æ–‡ä»¶ï¼Œä»¥åŠå¤æ‚çš„ `orm.xml` æ–‡ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬è´Ÿè´£åœ°å‘Šè¯‰å¤§å®¶ï¼Œä½¿ç”¨ Spring+Hibernate ä½œä¸º JPA å®ç°ï¼Œæ— éœ€ä»»ä½•é…ç½®æ–‡ä»¶ã€‚

æ‰€æœ‰ Entity Bean çš„é…ç½®å’Œä¸Šä¸€èŠ‚å®Œå…¨ç›¸åŒï¼Œå…¨éƒ¨é‡‡ç”¨ Annotation æ ‡æ³¨ã€‚æˆ‘ä»¬ç°åœ¨åªéœ€å…³å¿ƒå…·ä½“çš„ä¸šåŠ¡ç±»å¦‚ä½•é€šè¿‡ JPA æ¥å£æ“ä½œæ•°æ®åº“ã€‚

è¿˜æ˜¯ä»¥ `UserService` ä¸ºä¾‹ï¼Œé™¤äº†æ ‡æ³¨ `@Component` å’Œ `@Transactional` å¤–ï¼Œæˆ‘ä»¬éœ€è¦æ³¨å…¥ä¸€ä¸ª `EntityManager`ï¼Œä½†æ˜¯ä¸è¦ä½¿ç”¨ `Autowired`ï¼Œè€Œæ˜¯ `@PersistenceContext`ï¼š

```java
@Component
@Transactional
public class UserService {
    @PersistenceContext
    EntityManager em;
}
```

æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ JDBCã€Hibernate å’Œ JPA æä¾›çš„æ¥å£ï¼Œå®é™…ä¸Šï¼Œå®ƒä»¬çš„å…³ç³»å¦‚ä¸‹ï¼š

| JDBC       | Hibernate      | JPA                  |
| :--------- | :------------- | :------------------- |
| DataSource | SessionFactory | EntityManagerFactory |
| Connection | Session        | EntityManager        |

`SessionFactory` å’Œ `EntityManagerFactory` ç›¸å½“äº `DataSource`ï¼Œ`Session` å’Œ `EntityManager` ç›¸å½“äº `Connection`ã€‚æ¯æ¬¡éœ€è¦è®¿é—®æ•°æ®åº“çš„æ—¶å€™ï¼Œéœ€è¦è·å–æ–°çš„ `Session` å’Œ `EntityManager`ï¼Œç”¨å®Œåå†å…³é—­ã€‚

ä½†æ˜¯ï¼Œæ³¨æ„åˆ° `UserService` æ³¨å…¥çš„ä¸æ˜¯ `EntityManagerFactory`ï¼Œè€Œæ˜¯ `EntityManager`ï¼Œå¹¶ä¸”æ ‡æ³¨äº† `@PersistenceContext`ã€‚éš¾é“ä½¿ç”¨ JPA å¯ä»¥å…è®¸å¤šçº¿ç¨‹æ“ä½œåŒä¸€ä¸ª `EntityManager`ï¼Ÿ

å®é™…ä¸Šè¿™é‡Œæ³¨å…¥çš„å¹¶ä¸æ˜¯çœŸæ­£çš„ `EntityManager`ï¼Œè€Œæ˜¯ä¸€ä¸ª `EntityManager` çš„ä»£ç†ç±»ï¼Œç›¸å½“äºï¼š

```java
public class EntityManagerProxy implements EntityManager {
    private EntityManagerFactory emf;
}
```

Spring é‡åˆ°æ ‡æ³¨äº† `@PersistenceContext` çš„ `EntityManager` ä¼šè‡ªåŠ¨æ³¨å…¥ä»£ç†ï¼Œè¯¥ä»£ç†ä¼šåœ¨å¿…è¦çš„æ—¶å€™è‡ªåŠ¨æ‰“å¼€ `EntityManager`ã€‚æ¢å¥è¯è¯´ï¼Œå¤šçº¿ç¨‹å¼•ç”¨çš„ `EntityManager` è™½ç„¶æ˜¯åŒä¸€ä¸ªä»£ç†ç±»ï¼Œä½†è¯¥ä»£ç†ç±»å†…éƒ¨é’ˆå¯¹ä¸åŒçº¿ç¨‹ä¼šåˆ›å»ºä¸åŒçš„ `EntityManager` å®ä¾‹ã€‚

ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œæ ‡æ³¨äº† `@PersistenceContext` çš„ `EntityManager` å¯ä»¥è¢«å¤šçº¿ç¨‹å®‰å…¨åœ°å…±äº«ã€‚

å› æ­¤ï¼Œåœ¨ `UserService` çš„æ¯ä¸ªä¸šåŠ¡æ–¹æ³•é‡Œï¼Œç›´æ¥ä½¿ç”¨ `EntityManager` å°±å¾ˆæ–¹ä¾¿ã€‚ä»¥ä¸»é”®æŸ¥è¯¢ä¸ºä¾‹ï¼š

```java
public User getUserById(long id) {
    User user = this.em.find(User.class, id);
    if (user == null) {
        throw new RuntimeException("User not found by id:" + id);
    }
    return user;
}
```

ä¸ HQL æŸ¥è¯¢ç±»ä¼¼ï¼ŒJPA ä½¿ç”¨ JPQL æŸ¥è¯¢ï¼Œå®ƒçš„è¯­æ³•å’Œ HQL åŸºæœ¬å·®ä¸å¤šï¼š

```java
public User fetchUserByEmail(String email) {
    // JPQL æŸ¥è¯¢:
    TypedQuery<User> query = em.createQuery("SELECT u FROM User u WHERE u.email = :e", User.class);
    query.setParameter("e", email);
    List<User> list = query.getResultList();
    if (list.isEmpty()) {
        return null;
    }
    return list.get(0);
}
```

åŒæ ·çš„ï¼ŒJPA ä¹Ÿæ”¯æŒ `NamedQuery`ï¼Œå³å…ˆç»™æŸ¥è¯¢èµ·ä¸ªåå­—ï¼Œå†æŒ‰åå­—åˆ›å»ºæŸ¥è¯¢ï¼š

```java
public User login(String email, String password) {
    TypedQuery<User> query = em.createNamedQuery("login", User.class);
    query.setParameter("e", email);
    query.setParameter("pwd", password);
    List<User> list = query.getResultList();
    return list.isEmpty() ? null : list.get(0);
}
```

`NamedQuery` é€šè¿‡æ³¨è§£æ ‡æ³¨åœ¨ `User` ç±»ä¸Šï¼Œå®ƒçš„å®šä¹‰å’Œä¸Šä¸€èŠ‚çš„ `User` ç±»ä¸€æ ·ï¼š

```java
@NamedQueries(
    @NamedQuery(
        name = "login",
        query = "SELECT u FROM User u WHERE u.email=:e AND u.password=:pwd"
    )
)
@Entity
public class User {
    ...
}
```

å¯¹æ•°æ®åº“è¿›è¡Œå¢åˆ æ”¹çš„æ“ä½œï¼Œå¯ä»¥åˆ†åˆ«ä½¿ç”¨ `persist()`ã€`remove()` å’Œ `merge()` æ–¹æ³•ï¼Œå‚æ•°å‡ä¸º Entity Bean æœ¬èº«ï¼Œä½¿ç”¨éå¸¸ç®€å•ï¼Œè¿™é‡Œä¸å†å¤šè¿°ã€‚

### ç»ƒä¹ 


### å°ç»“

åœ¨ Spring ä¸­é›†æˆ JPA è¦é€‰æ‹©ä¸€ä¸ªå®ç°ï¼Œå¯ä»¥é€‰æ‹© Hibernate æˆ– EclipseLinkï¼›

ä½¿ç”¨ JPA ä¸ Hibernate ç±»ä¼¼ï¼Œä½†æ³¨å…¥çš„æ ¸å¿ƒèµ„æºæ˜¯å¸¦æœ‰ `@PersistenceContext` æ³¨è§£çš„ `EntityManager` ä»£ç†ç±»ã€‚



## ğŸ€ é›†æˆ MyBatis


ä½¿ç”¨ Hibernate æˆ– JPA æ“ä½œæ•°æ®åº“æ—¶ï¼Œè¿™ç±» ORM å¹²çš„ä¸»è¦å·¥ä½œå°±æ˜¯æŠŠ ResultSet çš„æ¯ä¸€è¡Œå˜æˆ Java Beanï¼Œæˆ–è€…æŠŠ Java Bean è‡ªåŠ¨è½¬æ¢åˆ° INSERT æˆ– UPDATE è¯­å¥çš„å‚æ•°ä¸­ï¼Œä»è€Œå®ç° ORMã€‚

è€Œ ORM æ¡†æ¶ä¹‹æ‰€ä»¥çŸ¥é“å¦‚ä½•æŠŠè¡Œæ•°æ®æ˜ å°„åˆ° Java Beanï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ Java Bean çš„å±æ€§ä¸Šç»™äº†è¶³å¤Ÿçš„æ³¨è§£ä½œä¸ºå…ƒæ•°æ®ï¼ŒORM æ¡†æ¶è·å– Java Bean çš„æ³¨è§£åï¼Œå°±çŸ¥é“å¦‚ä½•è¿›è¡ŒåŒå‘æ˜ å°„ã€‚

é‚£ä¹ˆï¼ŒORM æ¡†æ¶æ˜¯å¦‚ä½•è·Ÿè¸ª Java Bean çš„ä¿®æ”¹ï¼Œä»¥ä¾¿åœ¨ `update()` æ“ä½œä¸­æ›´æ–°å¿…è¦çš„å±æ€§ï¼Ÿ

ç­”æ¡ˆæ˜¯ä½¿ç”¨ [Proxy æ¨¡å¼](https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017)ï¼Œä» ORM æ¡†æ¶è¯»å–çš„ User å®ä¾‹å®é™…ä¸Šå¹¶ä¸æ˜¯ User ç±»ï¼Œè€Œæ˜¯ä»£ç†ç±»ï¼Œä»£ç†ç±»ç»§æ‰¿è‡ª User ç±»ï¼Œä½†é’ˆå¯¹æ¯ä¸ª setter æ–¹æ³•åšäº†è¦†å†™ï¼š

```java
public class UserProxy extends User {
    boolean _isNameChanged;

    public void setName(String name) {
        super.setName(name);
        _isNameChanged = true;
    }
}
```

è¿™æ ·ï¼Œä»£ç†ç±»å¯ä»¥è·Ÿè¸ªåˆ°æ¯ä¸ªå±æ€§çš„å˜åŒ–ã€‚

é’ˆå¯¹ä¸€å¯¹å¤šæˆ–å¤šå¯¹ä¸€å…³ç³»æ—¶ï¼Œä»£ç†ç±»å¯ä»¥ç›´æ¥é€šè¿‡ getter æ–¹æ³•æŸ¥è¯¢æ•°æ®åº“ï¼š

```java
public class UserProxy extends User {
    Session _session;
    boolean _isNameChanged;

    public void setName(String name) {
        super.setName(name);
        _isNameChanged = true;
    }

    /
     * è·å– User å¯¹è±¡å…³è”çš„ Address å¯¹è±¡:
     */
    public Address getAddress() {
        Query q = _session.createQuery("from Address where userId = :userId");
        q.setParameter("userId", this.getId());
        List<Address> list = query.list();
        return list.isEmpty() ? null : list(0);
    }
}
```

ä¸ºäº†å®ç°è¿™æ ·çš„æŸ¥è¯¢ï¼ŒUserProxy å¿…é¡»ä¿å­˜ Hibernate çš„å½“å‰ Sessionã€‚ä½†æ˜¯ï¼Œå½“äº‹åŠ¡æäº¤åï¼ŒSession è‡ªåŠ¨å…³é—­ï¼Œæ­¤æ—¶å†è·å– `getAddress()` å°†æ— æ³•è®¿é—®æ•°æ®åº“ï¼Œæˆ–è€…è·å–çš„ä¸æ˜¯äº‹åŠ¡ä¸€è‡´çš„æ•°æ®ã€‚å› æ­¤ï¼ŒORM æ¡†æ¶æ€»æ˜¯å¼•å…¥äº† Attached/Detached çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰æ­¤ Java Bean åˆ°åº•æ˜¯åœ¨ Session çš„èŒƒå›´å†…ï¼Œè¿˜æ˜¯è„±ç¦»äº† Session å˜æˆäº†ä¸€ä¸ª â€œæ¸¸ç¦»â€ å¯¹è±¡ã€‚å¾ˆå¤šåˆå­¦è€…æ— æ³•æ­£ç¡®ç†è§£çŠ¶æ€å˜åŒ–å’Œäº‹åŠ¡è¾¹ç•Œï¼Œå°±ä¼šé€ æˆå¤§é‡çš„ `PersistentObjectException` å¼‚å¸¸ã€‚è¿™ç§éšå¼çŠ¶æ€ä½¿å¾—æ™®é€š Java Bean çš„ç”Ÿå‘½å‘¨æœŸå˜å¾—å¤æ‚ã€‚

æ­¤å¤–ï¼ŒHibernate å’Œ JPA ä¸ºäº†å®ç°å…¼å®¹å¤šç§æ•°æ®åº“ï¼Œå®ƒä½¿ç”¨ HQL æˆ– JPQL æŸ¥è¯¢ï¼Œç»è¿‡ä¸€é“è½¬æ¢ï¼Œå˜æˆç‰¹å®šæ•°æ®åº“çš„ SQLï¼Œç†è®ºä¸Šè¿™æ ·å¯ä»¥åšåˆ°æ— ç¼åˆ‡æ¢æ•°æ®åº“ï¼Œä½†è¿™ä¸€å±‚è‡ªåŠ¨è½¬æ¢é™¤äº†å°‘è®¸çš„æ€§èƒ½å¼€é”€å¤–ï¼Œç»™ SQL çº§åˆ«çš„ä¼˜åŒ–å¸¦æ¥äº†éº»çƒ¦ã€‚

æœ€åï¼ŒORM æ¡†æ¶é€šå¸¸æä¾›äº†ç¼“å­˜ï¼Œå¹¶ä¸”è¿˜åˆ†ä¸ºä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜ã€‚ä¸€çº§ç¼“å­˜æ˜¯æŒ‡åœ¨ä¸€ä¸ª Session èŒƒå›´å†…çš„ç¼“å­˜ï¼Œå¸¸è§çš„æƒ…æ™¯æ˜¯æ ¹æ®ä¸»é”®æŸ¥è¯¢æ—¶ï¼Œä¸¤æ¬¡æŸ¥è¯¢å¯ä»¥è¿”å›åŒä¸€å®ä¾‹ï¼š

```java
User user1 = session.load(User.class, 123);
User user2 = session.load(User.class, 123);
```

äºŒçº§ç¼“å­˜æ˜¯æŒ‡è·¨ Session çš„ç¼“å­˜ï¼Œä¸€èˆ¬é»˜è®¤å…³é—­ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®ã€‚äºŒçº§ç¼“å­˜æå¤§çš„å¢åŠ äº†æ•°æ®çš„ä¸ä¸€è‡´æ€§ï¼ŒåŸå› åœ¨äº SQL éå¸¸çµæ´»ï¼Œå¸¸å¸¸ä¼šå¯¼è‡´æ„å¤–çš„æ›´æ–°ã€‚ä¾‹å¦‚ï¼š

```java
// çº¿ç¨‹ 1 è¯»å–:
User user1 = session1.load(User.class, 123);
...
// ä¸€æ®µæ—¶é—´åï¼Œçº¿ç¨‹ 2 è¯»å–:
User user2 = session2.load(User.class, 123);
```

å½“äºŒçº§ç¼“å­˜ç”Ÿæ•ˆçš„æ—¶å€™ï¼Œä¸¤ä¸ªçº¿ç¨‹è¯»å–çš„ User å®ä¾‹æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ï¼Œæ•°æ®åº“å¯¹åº”çš„è¡Œè®°å½•å®Œå…¨å¯èƒ½è¢«ä¿®æ”¹ï¼Œä¾‹å¦‚ï¼š

```sql
-- ç»™è€ç”¨æˆ·å¢åŠ  100 ç§¯åˆ†:
UPDATE users SET bonus = bonus + 100 WHERE createdAt <= ?
```

ORM æ— æ³•åˆ¤æ–­ `id=123` çš„ç”¨æˆ·æ˜¯å¦å—è¯¥ `UPDATE` è¯­å¥å½±å“ã€‚è€ƒè™‘åˆ°æ•°æ®åº“é€šå¸¸ä¼šæ”¯æŒå¤šä¸ªåº”ç”¨ç¨‹åºï¼Œæ­¤ UPDATE è¯­å¥å¯èƒ½ç”±å…¶ä»–è¿›ç¨‹æ‰§è¡Œï¼ŒORM æ¡†æ¶å°±æ›´ä¸çŸ¥é“äº†ã€‚

æˆ‘ä»¬æŠŠè¿™ç§ ORM æ¡†æ¶ç§°ä¹‹ä¸ºå…¨è‡ªåŠ¨ ORM æ¡†æ¶ã€‚

å¯¹æ¯” Spring æä¾›çš„ JdbcTemplateï¼Œå®ƒå’Œ ORM æ¡†æ¶ç›¸æ¯”ï¼Œä¸»è¦æœ‰å‡ ç‚¹å·®åˆ«ï¼š

1. æŸ¥è¯¢åéœ€è¦æ‰‹åŠ¨æä¾› Mapper å®ä¾‹ä»¥ä¾¿æŠŠ ResultSet çš„æ¯ä¸€è¡Œå˜ä¸º Java å¯¹è±¡ï¼›
2. å¢åˆ æ”¹æ“ä½œæ‰€éœ€çš„å‚æ•°åˆ—è¡¨ï¼Œéœ€è¦æ‰‹åŠ¨ä¼ å…¥ï¼Œå³æŠŠ User å®ä¾‹å˜ä¸º [user.id, user.name, user.email] è¿™æ ·çš„åˆ—è¡¨ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚

ä½†æ˜¯ JdbcTemplate çš„ä¼˜åŠ¿åœ¨äºå®ƒçš„ç¡®å®šæ€§ï¼šå³æ¯æ¬¡è¯»å–æ“ä½œä¸€å®šæ˜¯æ•°æ®åº“æ“ä½œè€Œä¸æ˜¯ç¼“å­˜ï¼Œæ‰€æ‰§è¡Œçš„ SQL æ˜¯å®Œå…¨ç¡®å®šçš„ï¼Œç¼ºç‚¹å°±æ˜¯ä»£ç æ¯”è¾ƒç¹çï¼Œæ„é€  `INSERT INTO users VALUES (?,?,?)` æ›´æ˜¯å¤æ‚ã€‚

æ‰€ä»¥ï¼Œä»‹äºå…¨è‡ªåŠ¨ ORM å¦‚ Hibernate å’Œæ‰‹å†™å…¨éƒ¨å¦‚ JdbcTemplate ä¹‹é—´ï¼Œè¿˜æœ‰ä¸€ç§åŠè‡ªåŠ¨çš„ ORMï¼Œå®ƒåªè´Ÿè´£æŠŠ ResultSet è‡ªåŠ¨æ˜ å°„åˆ° Java Beanï¼Œæˆ–è€…è‡ªåŠ¨å¡«å…… Java Bean å‚æ•°ï¼Œä½†ä»éœ€è‡ªå·±å†™å‡º SQLã€‚[MyBatis](https://mybatis.org/) å°±æ˜¯è¿™æ ·ä¸€ç§åŠè‡ªåŠ¨åŒ– ORM æ¡†æ¶ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åœ¨ Spring ä¸­é›†æˆ MyBatisã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è¦å¼•å…¥ MyBatis æœ¬èº«ï¼Œå…¶æ¬¡ï¼Œç”±äº Spring å¹¶æ²¡æœ‰åƒ Hibernate é‚£æ ·å†…ç½®å¯¹ MyBatis çš„é›†æˆï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å†å¼•å…¥ MyBatis å®˜æ–¹è‡ªå·±å¼€å‘çš„ä¸€ä¸ªä¸ Spring é›†æˆçš„åº“ï¼š

- org.mybatis:mybatis:3.5.11
- org.mybatis:mybatis-spring:3.0.0

å’Œå‰é¢ä¸€æ ·ï¼Œå…ˆåˆ›å»º `DataSource` æ˜¯å¿…ä¸å¯å°‘çš„ï¼š

```java
@Configuration
@ComponentScan
@EnableTransactionManagement
@PropertySource("jdbc.properties")
public class AppConfig {
    @Bean
    DataSource createDataSource() { ...}
}
```

å†å›é¡¾ä¸€ä¸‹ Hibernate å’Œ JPA çš„ `SessionFactory` ä¸ `EntityManagerFactory`ï¼ŒMyBatis ä¸ä¹‹å¯¹åº”çš„æ˜¯ `SqlSessionFactory` å’Œ `SqlSession`ï¼š

| JDBC       | Hibernate      | JPA                  | MyBatis           |
| :--------- | :------------- | :------------------- | :---------------- |
| DataSource | SessionFactory | EntityManagerFactory | SqlSessionFactory |
| Connection | Session        | EntityManager        | SqlSession        |

å¯è§ï¼ŒORM çš„è®¾è®¡å¥—è·¯éƒ½æ˜¯ç±»ä¼¼çš„ã€‚ä½¿ç”¨ MyBatis çš„æ ¸å¿ƒå°±æ˜¯åˆ›å»º `SqlSessionFactory`ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ›å»ºçš„æ˜¯ `SqlSessionFactoryBean`ï¼š

```java
@Bean
SqlSessionFactoryBean createSqlSessionFactoryBean(@Autowired DataSource dataSource) {
    var sqlSessionFactoryBean = new SqlSessionFactoryBean();
    sqlSessionFactoryBean.setDataSource(dataSource);
    return sqlSessionFactoryBean;
}
```

å› ä¸º MyBatis å¯ä»¥ç›´æ¥ä½¿ç”¨ Spring ç®¡ç†çš„å£°æ˜å¼äº‹åŠ¡ï¼Œå› æ­¤ï¼Œåˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨å’Œä½¿ç”¨ JDBC æ˜¯ä¸€æ ·çš„ï¼š

```java
@Bean
PlatformTransactionManager createTxManager(@Autowired DataSource dataSource) {
    return new DataSourceTransactionManager(dataSource);
}
```

å’Œ Hibernate ä¸åŒçš„æ˜¯ï¼ŒMyBatis ä½¿ç”¨ Mapper æ¥å®ç°æ˜ å°„ï¼Œè€Œä¸” Mapper å¿…é¡»æ˜¯æ¥å£ã€‚æˆ‘ä»¬ä»¥ `User` ç±»ä¸ºä¾‹ï¼Œåœ¨ `User` ç±»å’Œ `users` è¡¨ä¹‹é—´æ˜ å°„çš„ `UserMapper` ç¼–å†™å¦‚ä¸‹ï¼š

```java
public interface UserMapper {
	@Select("SELECT * FROM users WHERE id = #{id}")
	User getById(@Param("id") long id);
}
```

æ³¨æ„ï¼šè¿™é‡Œçš„ Mapper ä¸æ˜¯ `JdbcTemplate` çš„ `RowMapper` çš„æ¦‚å¿µï¼Œå®ƒæ˜¯å®šä¹‰è®¿é—® `users` è¡¨çš„æ¥å£æ–¹æ³•ã€‚æ¯”å¦‚æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `User getById(long)` çš„ä¸»é”®æŸ¥è¯¢æ–¹æ³•ï¼Œä¸ä»…è¦å®šä¹‰æ¥å£æ–¹æ³•æœ¬èº«ï¼Œè¿˜è¦æ˜ç¡®å†™å‡ºæŸ¥è¯¢çš„ SQLï¼Œè¿™é‡Œç”¨æ³¨è§£ `@Select` æ ‡è®°ã€‚SQL è¯­å¥çš„ä»»ä½•å‚æ•°ï¼Œéƒ½ä¸æ–¹æ³•å‚æ•°æŒ‰åç§°å¯¹åº”ã€‚ä¾‹å¦‚ï¼Œæ–¹æ³•å‚æ•° id çš„åå­—é€šè¿‡æ³¨è§£ `@Param()` æ ‡è®°ä¸º `id`ï¼Œåˆ™ SQL è¯­å¥é‡Œå°†æ¥æ›¿æ¢çš„å ä½ç¬¦å°±æ˜¯ `#{id}`ã€‚

å¦‚æœæœ‰å¤šä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæ¯ä¸ªå‚æ•°å‘½ååç›´æ¥åœ¨ SQL ä¸­å†™å‡ºå¯¹åº”çš„å ä½ç¬¦å³å¯ï¼š

```java
@Select("SELECT * FROM users LIMIT #{offset}, #{maxResults}")
List<User> getAll(@Param("offset") int offset, @Param("maxResults") int maxResults);
```

æ³¨æ„ï¼šMyBatis æ‰§è¡ŒæŸ¥è¯¢åï¼Œå°†æ ¹æ®æ–¹æ³•çš„è¿”å›ç±»å‹è‡ªåŠ¨æŠŠ ResultSet çš„æ¯ä¸€è¡Œè½¬æ¢ä¸º User å®ä¾‹ï¼Œè½¬æ¢è§„åˆ™å½“ç„¶æ˜¯æŒ‰åˆ—åå’Œå±æ€§åå¯¹åº”ã€‚å¦‚æœåˆ—åå’Œå±æ€§åä¸åŒï¼Œæœ€ç®€å•çš„æ–¹å¼æ˜¯ç¼–å†™ SELECT è¯­å¥çš„åˆ«åï¼š

```sql
-- åˆ—åæ˜¯ created_timeï¼Œå±æ€§åæ˜¯ createdAt:
SELECT id, name, email, created_time AS createdAt FROM users
```

æ‰§è¡Œ INSERT è¯­å¥å°±ç¨å¾®éº»çƒ¦ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›ä¼ å…¥ User å®ä¾‹ï¼Œå› æ­¤ï¼Œå®šä¹‰çš„æ–¹æ³•æ¥å£ä¸ `@Insert` æ³¨è§£å¦‚ä¸‹ï¼š

```java
@Insert("INSERT INTO users (email, password, name, createdAt) VALUES (#{user.email}, #{user.password}, #{user.name}, #{user.createdAt})")
void insert(@Param("user") User user);
```

ä¸Šè¿°æ–¹æ³•ä¼ å…¥çš„å‚æ•°åç§°æ˜¯ `user`ï¼Œå‚æ•°ç±»å‹æ˜¯ User ç±»ï¼Œåœ¨ SQL ä¸­å¼•ç”¨çš„æ—¶å€™ï¼Œä»¥ `#{obj.property}` çš„æ–¹å¼å†™å ä½ç¬¦ã€‚å’Œ Hibernate è¿™æ ·çš„å…¨è‡ªåŠ¨åŒ– ORM ç›¸æ¯”ï¼ŒMyBatis å¿…é¡»å†™å‡ºå®Œæ•´çš„ INSERT è¯­å¥ã€‚

å¦‚æœ `users` è¡¨çš„ `id` æ˜¯è‡ªå¢ä¸»é”®ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨ SQL ä¸­ä¸ä¼ å…¥ `id`ï¼Œä½†å¸Œæœ›è·å–æ’å…¥åçš„ä¸»é”®ï¼Œéœ€è¦å†åŠ ä¸€ä¸ª `@Options` æ³¨è§£ï¼š

```java
@Options(useGeneratedKeys = true, keyProperty = "id", keyColumn = "id")
@Insert("INSERT INTO users (email, password, name, createdAt) VALUES (#{user.email}, #{user.password}, #{user.name}, #{user.createdAt})")
void insert(@Param("user") User user);
```

`keyProperty` å’Œ `keyColumn` åˆ†åˆ«æŒ‡å‡º JavaBean çš„å±æ€§å’Œæ•°æ®åº“çš„ä¸»é”®åˆ—åã€‚

æ‰§è¡Œ `UPDATE` å’Œ `DELETE` è¯­å¥ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å®šä¹‰æ–¹æ³•å¦‚ä¸‹ï¼š

```java
@Update("UPDATE users SET name = #{user.name}, createdAt = #{user.createdAt} WHERE id = #{user.id}")
void update(@Param("user") User user);

@Delete("DELETE FROM users WHERE id = #{id}")
void deleteById(@Param("id") long id);
```

æœ‰äº† `UserMapper` æ¥å£ï¼Œè¿˜éœ€è¦å¯¹åº”çš„å®ç°ç±»æ‰èƒ½çœŸæ­£æ‰§è¡Œè¿™äº›æ•°æ®åº“æ“ä½œçš„æ–¹æ³•ã€‚è™½ç„¶å¯ä»¥è‡ªå·±å†™å®ç°ç±»ï¼Œä½†æˆ‘ä»¬é™¤äº†ç¼–å†™ `UserMapper` æ¥å£å¤–ï¼Œè¿˜æœ‰ `BookMapper`ã€`BonusMapper`â€¦â€¦ ä¸€ä¸ªä¸€ä¸ªå†™å¤ªéº»çƒ¦ï¼Œå› æ­¤ï¼ŒMyBatis æä¾›äº†ä¸€ä¸ª `MapperFactoryBean` æ¥è‡ªåŠ¨åˆ›å»ºæ‰€æœ‰ Mapper çš„å®ç°ç±»ã€‚å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„æ³¨è§£æ¥å¯ç”¨å®ƒï¼š

```java
@MapperScan("com.itranswarp.learnjava.mapper")
... å…¶ä»–æ³¨è§£...
public class AppConfig {
    ...
}
```

æœ‰äº† `@MapperScan`ï¼Œå°±å¯ä»¥è®© MyBatis è‡ªåŠ¨æ‰«ææŒ‡å®šåŒ…çš„æ‰€æœ‰ Mapper å¹¶åˆ›å»ºå®ç°ç±»ã€‚åœ¨çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ³¨å…¥ï¼š

```java
@Component
@Transactional
public class UserService {
    // æ³¨å…¥ UserMapper:
    @Autowired
    UserMapper userMapper;

    public User getUserById(long id) {
        // è°ƒç”¨ Mapper æ–¹æ³•:
        User user = userMapper.getById(id);
        if (user == null) {
            throw new RuntimeException("User not found by id.");
        }
        return user;
    }
}
```

å¯è§ï¼Œä¸šåŠ¡é€»è¾‘ä¸»è¦å°±æ˜¯é€šè¿‡ `XxxMapper` å®šä¹‰çš„æ•°æ®åº“æ–¹æ³•æ¥è®¿é—®æ•°æ®åº“ã€‚

### XML é…ç½®

ä¸Šè¿°åœ¨ Spring ä¸­é›†æˆ MyBatis çš„æ–¹å¼ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨åˆ°æ³¨è§£ï¼Œå¹¶æ²¡æœ‰ä»»ä½• XML é…ç½®æ–‡ä»¶ã€‚MyBatis ä¹Ÿå…è®¸ä½¿ç”¨ XML é…ç½®æ˜ å°„å…³ç³»å’Œ SQL è¯­å¥ï¼Œä¾‹å¦‚ï¼Œæ›´æ–° `User` æ—¶æ ¹æ®å±æ€§å€¼æ„é€ åŠ¨æ€ SQLï¼š

```xml
<update id="updateUser">
  UPDATE users SET
  <set>
    <if test="user.name != null"> name = #{user.name} </if>
    <if test="user.hobby != null"> hobby = #{user.hobby} </if>
    <if test="user.summary != null"> summary = #{user.summary} </if>
  </set>
  WHERE id = #{user.id}
</update>
```

ç¼–å†™ XML é…ç½®çš„ä¼˜ç‚¹æ˜¯å¯ä»¥ç»„è£…å‡ºåŠ¨æ€ SQLï¼Œå¹¶ä¸”æŠŠæ‰€æœ‰ SQL æ“ä½œé›†ä¸­åœ¨ä¸€èµ·ã€‚ç¼ºç‚¹æ˜¯é…ç½®èµ·æ¥å¤ªç¹çï¼Œè°ƒç”¨æ–¹æ³•æ—¶å¦‚æœæƒ³æŸ¥çœ‹ SQL è¿˜éœ€è¦å®šä½åˆ° XML é…ç½®ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬ä¸ä»‹ç» XML çš„é…ç½®æ–¹å¼ï¼Œéœ€è¦äº†è§£çš„ç«¥é‹è¯·è‡ªè¡Œé˜…è¯» [å®˜æ–¹æ–‡æ¡£](https://mybatis.org/mybatis-3/zh/configuration.html)ã€‚

ä½¿ç”¨ MyBatis æœ€å¤§çš„é—®é¢˜æ˜¯æ‰€æœ‰ SQL éƒ½éœ€è¦å…¨éƒ¨æ‰‹å†™ï¼Œä¼˜ç‚¹æ˜¯æ‰§è¡Œçš„ SQL å°±æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ SQLï¼Œå¯¹ SQL è¿›è¡Œä¼˜åŒ–éå¸¸ç®€å•ï¼Œä¹Ÿå¯ä»¥ç¼–å†™ä»»æ„å¤æ‚çš„ SQLï¼Œæˆ–è€…ä½¿ç”¨æ•°æ®åº“çš„ç‰¹å®šè¯­æ³•ï¼Œä½†åˆ‡æ¢æ•°æ®åº“å¯èƒ½å°±ä¸å¤ªå®¹æ˜“ã€‚å¥½æ¶ˆæ¯æ˜¯å¤§éƒ¨åˆ†é¡¹ç›®å¹¶æ²¡æœ‰åˆ‡æ¢æ•°æ®åº“çš„éœ€æ±‚ï¼Œå®Œå…¨å¯ä»¥é’ˆå¯¹æŸä¸ªæ•°æ®åº“ç¼–å†™å°½å¯èƒ½ä¼˜åŒ–çš„ SQLã€‚

### ç»ƒä¹ 


### å°ç»“

MyBatis æ˜¯ä¸€ä¸ªåŠè‡ªåŠ¨åŒ–çš„ ORM æ¡†æ¶ï¼Œéœ€è¦æ‰‹å†™ SQL è¯­å¥ï¼Œæ²¡æœ‰è‡ªåŠ¨åŠ è½½ä¸€å¯¹å¤šæˆ–å¤šå¯¹ä¸€å…³ç³»çš„åŠŸèƒ½ã€‚



## ğŸ€ è®¾è®¡ ORM


æˆ‘ä»¬ä»å‰å‡ èŠ‚å¯ä»¥çœ‹åˆ°ï¼Œæ‰€è°“ ORMï¼Œä¹Ÿæ˜¯å»ºç«‹åœ¨ JDBC çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡ ResultSet åˆ° JavaBean çš„æ˜ å°„ï¼Œå®ç°å„ç§æŸ¥è¯¢ã€‚æœ‰è‡ªåŠ¨è·Ÿè¸ª Entity ä¿®æ”¹çš„å…¨è‡ªåŠ¨åŒ– ORM å¦‚ Hibernate å’Œ JPAï¼Œéœ€è¦ä¸ºæ¯ä¸ª Entity åˆ›å»ºä»£ç†ï¼Œä¹Ÿæœ‰å®Œå…¨è‡ªå·±æ˜ å°„ï¼Œè¿ INSERT å’Œ UPDATE è¯­å¥éƒ½éœ€è¦æ‰‹åŠ¨ç¼–å†™çš„ MyBatisï¼Œä½†æ²¡æœ‰ä»»ä½•é€æ˜çš„ Proxyã€‚

è€ŒæŸ¥è¯¢æ˜¯æ¶‰åŠåˆ°æ•°æ®åº“ä½¿ç”¨æœ€å¹¿æ³›çš„æ“ä½œï¼Œéœ€è¦æœ€å¤§çš„çµæ´»æ€§ã€‚å„ç§ ORM è§£å†³æ–¹æ¡ˆå„ä¸ç›¸åŒï¼ŒHibernate å’Œ JPA è‡ªå·±å®ç°äº† HQL å’Œ JPQL æŸ¥è¯¢è¯­æ³•ï¼Œç”¨ä»¥ç”Ÿæˆæœ€ç»ˆçš„ SQLï¼Œè€Œ MyBatis åˆ™å®Œå…¨æ‰‹å†™ï¼Œæ¯å¢åŠ ä¸€ä¸ªæŸ¥è¯¢éƒ½éœ€è¦å…ˆç¼–å†™ SQL å¹¶å¢åŠ æ¥å£æ–¹æ³•ã€‚

è¿˜æœ‰ä¸€ç§ Hibernate å’Œ JPA æ”¯æŒçš„ Criteria æŸ¥è¯¢ï¼Œç”¨ Hibernate å†™å‡ºæ¥ç±»ä¼¼ï¼š

```java
DetachedCriteria criteria = DetachedCriteria.forClass(User.class);
criteria.add(Restrictions.eq("email", email))
        .add(Restrictions.eq("password", password));
List<User> list = (List<User>) hibernateTemplate.findByCriteria(criteria);
```

ä¸Šè¿° Criteria æŸ¥è¯¢å†™æ³•å¤æ‚ï¼Œä½†å’Œ JPA ç›¸æ¯”ï¼Œè¿˜æ˜¯å°å·«è§å¤§å·«äº†ï¼š

```java
var cb = em.getCriteriaBuilder();
CriteriaQuery<User> q = cb.createQuery(User.class);
Root<User> r = q.from(User.class);
q.where(cb.equal(r.get("email"), cb.parameter(String.class, "e")));
TypedQuery<User> query = em.createQuery(q);
query.setParameter("e", email);
List<User> list = query.getResultList();
```

æ­¤å¤–ï¼Œæ˜¯å¦æ”¯æŒè‡ªåŠ¨è¯»å–ä¸€å¯¹å¤šå’Œå¤šå¯¹ä¸€å…³ç³»ä¹Ÿæ˜¯å…¨è‡ªåŠ¨åŒ– ORM æ¡†æ¶çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½ã€‚

å¦‚æœæˆ‘ä»¬è‡ªå·±æ¥è®¾è®¡å¹¶å®ç°ä¸€ä¸ª ORMï¼Œåº”è¯¥å¸å–è¿™äº› ORM çš„å“ªäº›ç‰¹è‰²ï¼Œç„¶åé«˜æ•ˆå®ç°å‘¢ï¼Ÿ

### è®¾è®¡ ORM æ¥å£

ä»»ä½•è®¾è®¡ï¼Œéƒ½å¿…é¡»æ˜ç¡®è®¾è®¡ç›®æ ‡ã€‚è¿™é‡Œæˆ‘ä»¬å‡†å¤‡å®ç°çš„ ORM å¹¶ä¸æƒ³è¦å…¨è‡ªåŠ¨ ORM é‚£ç§è‡ªåŠ¨è¯»å–ä¸€å¯¹å¤šå’Œå¤šå¯¹ä¸€å…³ç³»çš„åŠŸèƒ½ï¼Œä¹Ÿä¸æƒ³ç»™ Entity åŠ ä¸Šå¤æ‚çš„çŠ¶æ€ï¼Œå› æ­¤ï¼Œå¯¹äº Entity æ¥è¯´ï¼Œå®ƒå°±æ˜¯çº¯ç²¹çš„ JavaBeanï¼Œæ²¡æœ‰ä»»ä½• Proxyã€‚

æ­¤å¤–ï¼ŒORM è¦å…¼é¡¾æ˜“ç”¨æ€§å’Œé€‚ç”¨æ€§ã€‚æ˜“ç”¨æ€§æ˜¯æŒ‡èƒ½è¦†ç›– 95% çš„åº”ç”¨åœºæ™¯ï¼Œä½†æ€»æœ‰ä¸€äº›å¤æ‚çš„ SQLï¼Œå¾ˆéš¾ç”¨ ORM å»è‡ªåŠ¨ç”Ÿæˆï¼Œå› æ­¤ï¼Œä¹Ÿè¦ç»™å‡ºåŸç”Ÿçš„ JDBC æ¥å£ï¼Œèƒ½æ”¯æŒ 5% çš„ç‰¹æ®Šéœ€æ±‚ã€‚

æœ€åï¼Œæˆ‘ä»¬å¸Œæœ›è®¾è®¡çš„æ¥å£è¦æ˜“äºç¼–å†™ï¼Œå¹¶ä½¿ç”¨æµå¼ API ä¾¿äºé˜…è¯»ã€‚ä¸ºäº†é…åˆç¼–è¯‘å™¨æ£€æŸ¥ï¼Œè¿˜åº”è¯¥æ”¯æŒæ³›å‹ï¼Œé¿å…å¼ºåˆ¶è½¬å‹ã€‚

ä»¥ User ç±»ä¸ºä¾‹ï¼Œæˆ‘ä»¬è®¾è®¡çš„æŸ¥è¯¢æ¥å£å¦‚ä¸‹ï¼š

```java
// æŒ‰ä¸»é”®æŸ¥è¯¢: SELECT * FROM users WHERE id = ?
User u = db.get(User.class, 123);

// æ¡ä»¶æŸ¥è¯¢å”¯ä¸€è®°å½•: SELECT * FROM users WHERE email = ? AND password = ?
User u = db.from(User.class)
           .where("email=? AND password=?", "bob@example.com", "bob123")
           .unique();

// æ¡ä»¶æŸ¥è¯¢å¤šæ¡è®°å½•: SELECT * FROM users WHERE id < ? ORDER BY email LIMIT ?, ?
List<User> us = db.from(User.class)
                  .where("id < ?", 1000)
                  .orderBy("email")
                  .limit(0, 10)
                  .list();

// æŸ¥è¯¢ç‰¹å®šåˆ—: SELECT id, name FROM users WHERE email = ?
User u = db.select("id", "name")
           .from(User.class)
           .where("email = ?", "bob@example.com")
           .unique();
```

è¿™æ ·çš„æµå¼ API ä¾¿äºé˜…è¯»ï¼Œä¹Ÿéå¸¸å®¹æ˜“æ¨å¯¼å‡ºæœ€ç»ˆç”Ÿæˆçš„ SQLã€‚

å¯¹äºæ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œï¼Œå°±ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼š

```java
// æ’å…¥ User:
db.insert(user);

// æŒ‰ä¸»é”®æ›´æ–°æ›´æ–° User:
db.update(user);

// æŒ‰ä¸»é”®åˆ é™¤ User:
db.delete(User.class, 123);
```

å¯¹äº Entity æ¥è¯´ï¼Œé€šå¸¸ä¸€ä¸ªè¡¨å¯¹åº”ä¸€ä¸ªã€‚æ‰‹åŠ¨åˆ—å‡ºæ‰€æœ‰ Entity æ˜¯éå¸¸éº»çƒ¦çš„ï¼Œä¸€å®šè¦ä¼ å…¥ package è‡ªåŠ¨æ‰«æã€‚

æœ€åï¼ŒORM æ€»æ˜¯éœ€è¦å…ƒæ•°æ®æ‰èƒ½çŸ¥é“å¦‚ä½•æ˜ å°„ã€‚æˆ‘ä»¬ä¸æƒ³ç¼–å†™å¤æ‚çš„ XML é…ç½®ï¼Œä¹Ÿæ²¡å¿…è¦è‡ªå·±å»å®šä¹‰ä¸€å¥—è§„åˆ™ï¼Œç›´æ¥ä½¿ç”¨ JPA çš„æ³¨è§£å°±è¡Œã€‚

### å®ç° ORM

æˆ‘ä»¬å¹¶ä¸éœ€è¦ä» JDBC åº•å±‚å¼€å§‹ç¼–å†™ï¼Œå¹¶ä¸”ï¼Œè¿˜è¦è€ƒè™‘åˆ°äº‹åŠ¡ï¼Œæœ€å¥½èƒ½ç›´æ¥ä½¿ç”¨ Spring çš„å£°æ˜å¼äº‹åŠ¡ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªå…¨å±€ `DbTemplate`ï¼Œå®ƒæ³¨å…¥äº† Spring çš„ `JdbcTemplate`ï¼Œæ¶‰åŠåˆ°æ•°æ®åº“æ“ä½œæ—¶ï¼Œå…¨éƒ¨é€šè¿‡ `JdbcTemplate` å®Œæˆï¼Œè‡ªç„¶å¤©ç”Ÿæ”¯æŒ Spring çš„å£°æ˜å¼äº‹åŠ¡ï¼Œå› ä¸ºè¿™ä¸ª ORM åªæ˜¯åœ¨ `JdbcTemplate` çš„åŸºç¡€ä¸Šåšäº†ä¸€å±‚å°è£…ã€‚

åœ¨ `AppConfig` ä¸­ï¼Œæˆ‘ä»¬åˆå§‹åŒ–æ‰€æœ‰ Bean å¦‚ä¸‹ï¼š

```java
@Configuration
@ComponentScan
@EnableTransactionManagement
@PropertySource("jdbc.properties")
public class AppConfig {
    @Bean
    DataSource createDataSource() { ...}

    @Bean
    JdbcTemplate createJdbcTemplate(@Autowired DataSource dataSource) {
        return new JdbcTemplate(dataSource);
    }

    @Bean
    DbTemplate createDbTemplate(@Autowired JdbcTemplate jdbcTemplate) {
        return new DbTemplate(jdbcTemplate, "com.itranswarp.learnjava.entity");
    }

    @Bean
    PlatformTransactionManager createTxManager(@Autowired DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬æ‰€éœ€çš„æ‰€æœ‰é…ç½®ã€‚

ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¾‹å¦‚ `UserService`ï¼Œå†™å‡ºæ¥åƒè¿™æ ·ï¼š

```java
@Component
@Transactional
public class UserService {
    @Autowired
    DbTemplate db;

    public User getUserById(long id) {
        return db.get(User.class, id);
    }

    public User getUserByEmail(String email) {
        return db.from(User.class)
                 .where("email = ?", email)
                 .unique();
    }

    public List<User> getUsers(int pageIndex) {
        int pageSize = 100;
        return db.from(User.class)
                 .orderBy("id")
                 .limit((pageIndex - 1) * pageSize, pageSize)
                 .list();
    }

    public User register(String email, String password, String name) {
        User user = new User();
        user.setEmail(email);
        user.setPassword(password);
        user.setName(name);
        user.setCreatedAt(System.currentTimeMillis());
        db.insert(user);
        return user;
    }
    ...
}
```

ä¸Šè¿°ä»£ç ç»™å‡ºäº† ORM çš„æ¥å£ï¼Œä»¥åŠå¦‚ä½•åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ä½¿ç”¨ ORMã€‚ä¸‹ä¸€æ­¥ï¼Œå°±æ˜¯å¦‚ä½•å®ç°è¿™ä¸ª `DbTemplate`ã€‚è¿™é‡Œæˆ‘ä»¬åªç»™å‡ºæ¡†æ¶ä»£ç ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥è‡ªå·±å®ç°æ ¸å¿ƒä»£ç ï¼š

```java
public class DbTemplate {
    private JdbcTemplate jdbcTemplate;

    // ä¿å­˜ Entity Class åˆ° Mapper çš„æ˜ å°„:
    private Map<Class<?>, Mapper<?>> classMapping;

    public <T> T fetch(Class<T> clazz, Object id) {
        Mapper<T> mapper = getMapper(clazz);
        List<T> list = (List<T>) jdbcTemplate.query(mapper.selectSQL, new Object[] { id }, mapper.rowMapper);
        if (list.isEmpty()) {
            return null;
        }
        return list.get(0);
    }

    public <T> T get(Class<T> clazz, Object id) {
        ...
    }

    public <T> void insert(T bean) {
        ...
    }

    public <T> void update(T bean) {
        ...
    }

    public <T> void delete(Class<T> clazz, Object id) {
        ...
    }
}
```

å®ç°é“¾å¼ API çš„æ ¸å¿ƒä»£ç æ˜¯ç¬¬ä¸€æ­¥ä» `DbTemplate` è°ƒç”¨ `select()` æˆ– `from()` æ—¶å®ä¾‹åŒ–ä¸€ä¸ª `CriteriaQuery` å®ä¾‹ï¼Œå¹¶åœ¨åç»­çš„é“¾å¼è°ƒç”¨ä¸­è®¾ç½®å®ƒçš„å­—æ®µï¼š

```java
public class DbTemplate {
    ...
    public Select select(String... selectFields) {
        return new Select(new Criteria(this), selectFields);
    }

    public <T> From<T> from(Class<T> entityClass) {
        Mapper<T> mapper = getMapper(entityClass);
        return new From<>(new Criteria<>(this), mapper);
    }
}
```

ç„¶åä»¥æ­¤å®šä¹‰ `Select`ã€`From`ã€`Where`ã€`OrderBy`ã€`Limit` ç­‰ã€‚åœ¨ `From` ä¸­å¯ä»¥è®¾ç½® Class ç±»å‹ã€è¡¨åç­‰ï¼š

```java
public final class From<T> extends CriteriaQuery<T> {
    From(Criteria<T> criteria, Mapper<T> mapper) {
        super(criteria);
        // from å¯ä»¥è®¾ç½® classã€tableName:
        this.criteria.mapper = mapper;
        this.criteria.clazz = mapper.entityClass;
        this.criteria.table = mapper.tableName;
    }

    public Where<T> where(String clause, Object... args) {
        return new Where<>(this.criteria, clause, args);
    }
}
```

åœ¨ `Where` ä¸­å¯ä»¥è®¾ç½®æ¡ä»¶å‚æ•°ï¼š

```java
public final class Where<T> extends CriteriaQuery<T> {
    Where(Criteria<T> criteria, String clause, Object... params) {
        super(criteria);
        this.criteria.where = clause;
        this.criteria.whereParams = new ArrayList<>();
        // add:
        for (Object param : params) {
            this.criteria.whereParams.add(param);
        }
    }
}
```

æœ€åï¼Œé“¾å¼è°ƒç”¨çš„å°½å¤´æ˜¯è°ƒç”¨ `list()` è¿”å›ä¸€ç»„ç»“æœï¼Œè°ƒç”¨ `unique()` è¿”å›å”¯ä¸€ç»“æœï¼Œè°ƒç”¨ `first()` è¿”å›é¦–ä¸ªç»“æœã€‚

åœ¨ IDE ä¸­ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°å®ç°é“¾å¼è°ƒç”¨ï¼š

![warpdb](./assets/0.gif)

éœ€è¦å¤æ‚æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ€»æ˜¯å¯ä»¥ä½¿ç”¨ `JdbcTemplate` æ‰§è¡Œä»»æ„å¤æ‚çš„ SQLã€‚

### ç»ƒä¹ 


### å°ç»“

ORM æ¡†æ¶å°±æ˜¯è‡ªåŠ¨æ˜ å°„æ•°æ®åº“è¡¨ç»“æ„åˆ° JavaBean çš„å·¥å…·ï¼Œè®¾è®¡å¹¶å®ç°ä¸€ä¸ªç®€å•é«˜æ•ˆçš„ ORM æ¡†æ¶å¹¶ä¸å›°éš¾ã€‚

