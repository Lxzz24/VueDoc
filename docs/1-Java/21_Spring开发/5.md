---
title: é›†æˆç¬¬ä¸‰æ–¹ç»„ä»¶
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::



Spring æ¡†æ¶ä¸ä»…æä¾›äº†æ ‡å‡†çš„ IoC å®¹å™¨ã€AOP æ”¯æŒã€æ•°æ®åº“è®¿é—®ä»¥åŠ WebMVC ç­‰æ ‡å‡†åŠŸèƒ½ï¼Œè¿˜å¯ä»¥éå¸¸æ–¹ä¾¿åœ°é›†æˆè®¸å¤šå¸¸ç”¨çš„ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼š

- å¯ä»¥é›†æˆ JavaMail å‘é€é‚®ä»¶ï¼›
- å¯ä»¥é›†æˆ JMS æ¶ˆæ¯æœåŠ¡ï¼›
- å¯ä»¥é›†æˆ Quartz å®ç°å®šæ—¶ä»»åŠ¡ï¼›
- å¯ä»¥é›†æˆ Redis ç­‰æœåŠ¡ã€‚

æœ¬ç« æˆ‘ä»¬ä»‹ç»å¦‚ä½•åœ¨ Spring ä¸­ç®€å•å¿«æ·åœ°é›†æˆè¿™äº›ç¬¬ä¸‰æ–¹ç»„ä»¶ã€‚



## ğŸ€ é›†æˆ JavaMail


æˆ‘ä»¬åœ¨ [å‘é€ Email](https://www.liaoxuefeng.com/wiki/1252599548343744/1319099923693601) å’Œ[æ¥æ”¶ Email](https://www.liaoxuefeng.com/wiki/1252599548343744/1319099948859426)ä¸­å·²ç»ä»‹ç»äº†å¦‚ä½•é€šè¿‡ JavaMail æ¥æ”¶å‘ç”µå­é‚®ä»¶ã€‚åœ¨ Spring ä¸­ï¼ŒåŒæ ·å¯ä»¥é›†æˆ JavaMailã€‚

å› ä¸ºåœ¨æœåŠ¡å™¨ç«¯ï¼Œä¸»è¦ä»¥å‘é€é‚®ä»¶ä¸ºä¸»ï¼Œä¾‹å¦‚åœ¨æ³¨å†ŒæˆåŠŸã€ç™»å½•æ—¶ã€è´­ç‰©ä»˜æ¬¾åé€šçŸ¥ç”¨æˆ·ï¼ŒåŸºæœ¬ä¸Šä¸ä¼šé‡åˆ°æ¥æ”¶ç”¨æˆ·é‚®ä»¶çš„æƒ…å†µï¼Œæ‰€ä»¥æœ¬èŠ‚æˆ‘ä»¬åªè®¨è®ºå¦‚ä½•åœ¨ Spring ä¸­å‘é€é‚®ä»¶ã€‚

åœ¨ Spring ä¸­ï¼Œå‘é€é‚®ä»¶æœ€ç»ˆä¹Ÿæ˜¯éœ€è¦ JavaMailï¼ŒSpring åªå¯¹ JavaMail åšäº†ä¸€ç‚¹ç®€å•çš„å°è£…ï¼Œç›®çš„æ˜¯ç®€åŒ–ä»£ç ã€‚ä¸ºäº†åœ¨ Spring ä¸­é›†æˆ JavaMailï¼Œæˆ‘ä»¬åœ¨ `pom.xml` ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š

- org.springframework:spring-context-support:6.0.0
- jakarta.mail:jakarta.mail-api:2.0.1
- com.sun.mail:jakarta.mail:2.0.1

ä»¥åŠå…¶ä»– Web ç›¸å…³ä¾èµ–ã€‚

æˆ‘ä»¬å¸Œæœ›ç”¨æˆ·åœ¨æ³¨å†ŒæˆåŠŸåèƒ½æ”¶åˆ°æ³¨å†Œé‚®ä»¶ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ª `JavaMailSender` çš„ Beanï¼š

```java
@Bean
JavaMailSender createJavaMailSender(
        // smtp.properties:
        @Value("${smtp.host}") String host,
        @Value("${smtp.port}") int port,
        @Value("${smtp.auth}") String auth,
        @Value("${smtp.username}") String username,
        @Value("${smtp.password}") String password,
        @Value("${smtp.debug:true}") String debug)
{
    var mailSender = new JavaMailSenderImpl();
    mailSender.setHost(host);
    mailSender.setPort(port);
    mailSender.setUsername(username);
    mailSender.setPassword(password);
    Properties props = mailSender.getJavaMailProperties();
    props.put("mail.transport.protocol", "smtp");
    props.put("mail.smtp.auth", auth);
    if (port == 587) {
        props.put("mail.smtp.starttls.enable", "true");
    }
    if (port == 465) {
        props.put("mail.smtp.socketFactory.port", "465");
        props.put("mail.smtp.socketFactory.class", "javax.net.ssl.SSLSocketFactory");
    }
    props.put("mail.debug", debug);
    return mailSender;
}
```

è¿™ä¸ª `JavaMailSender` æ¥å£çš„å®ç°ç±»æ˜¯ `JavaMailSenderImpl`ï¼Œåˆå§‹åŒ–æ—¶ï¼Œä¼ å…¥çš„å‚æ•°ä¸ JavaMail æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚

å¦å¤–æ³¨æ„åˆ°éœ€è¦æ³¨å…¥çš„å±æ€§æ˜¯ä» `smtp.properties` ä¸­è¯»å–çš„ï¼Œå› æ­¤ï¼Œ`AppConfig` å¯¼å…¥çš„å°±ä¸æ­¢ä¸€ä¸ª `.properties` æ–‡ä»¶ï¼Œå¯ä»¥å¯¼å…¥å¤šä¸ªï¼š

```java
@Configuration
@ComponentScan
@EnableWebMvc
@EnableTransactionManagement
@PropertySource({"classpath:/jdbc.properties", "classpath:/smtp.properties"})
public class AppConfig {
    ...
}
```

ä¸‹ä¸€æ­¥æ˜¯å°è£…ä¸€ä¸ª `MailService`ï¼Œå¹¶å®šä¹‰ `sendRegistrationMail()` æ–¹æ³•ï¼š

```java
@Component
public class MailService {
    @Value("${smtp.from}")
    String from;

    @Autowired
    JavaMailSender mailSender;

    public void sendRegistrationMail(User user) {
        try {
            MimeMessage mimeMessage = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, "utf-8");
            helper.setFrom(from);
            helper.setTo(user.getEmail());
            helper.setSubject("Welcome to Java course!");
            String html = String.format("<p>Hi, %s,</p><p>Welcome to Java course!</p><p>Sent at %s</p>", user.getName(), LocalDateTime.now());
            helper.setText(html, true);
            mailSender.send(mimeMessage);
        } catch (MessagingException e) {
            throw new RuntimeException(e);
        }
    }
}
```

è§‚å¯Ÿä¸Šè¿°ä»£ç ï¼Œ`MimeMessage` æ˜¯ JavaMail çš„é‚®ä»¶å¯¹è±¡ï¼Œè€Œ `MimeMessageHelper` æ˜¯ Spring æä¾›çš„ç”¨äºç®€åŒ–è®¾ç½® MimeMessage çš„ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬è®¾ç½® HTML é‚®ä»¶å°±å¯ä»¥ç›´æ¥è°ƒç”¨ `setText(String text, boolean html)` æ–¹æ³•ï¼Œè€Œä¸å¿…å†è°ƒç”¨æ¯”è¾ƒç¹ççš„ JavaMail æ¥å£æ–¹æ³•ã€‚

æœ€åä¸€æ­¥æ˜¯è°ƒç”¨ `JavaMailSender.send()` æ–¹æ³•æŠŠé‚®ä»¶å‘é€å‡ºå»ã€‚

åœ¨ MVC çš„æŸä¸ª Controller æ–¹æ³•ä¸­ï¼Œå½“ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œæˆ‘ä»¬å°±å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹æ¥å¼‚æ­¥å‘é€é‚®ä»¶ï¼š

```java
User user = userService.register(email, password, name);
logger.info("user registered: {}", user.getEmail());
// send registration mail:
new Thread(() -> {
    mailService.sendRegistrationMail(user);
}).start();
```

å› ä¸ºå‘é€é‚®ä»¶æ˜¯ä¸€ç§è€—æ—¶çš„ä»»åŠ¡ï¼Œä»å‡ ç§’åˆ°å‡ åˆ†é’Ÿä¸ç­‰ï¼Œå› æ­¤ï¼Œå¼‚æ­¥å‘é€æ˜¯ä¿è¯é¡µé¢èƒ½å¿«é€Ÿæ˜¾ç¤ºçš„å¿…è¦æªæ–½ã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥å¯åŠ¨äº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œä½†å®é™…ä¸Šè¿˜æœ‰æ›´ä¼˜åŒ–çš„æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚è®¨è®ºã€‚

### ç»ƒä¹ 


### å°ç»“

Spring å¯ä»¥é›†æˆ JavaMailï¼Œé€šè¿‡ç®€å•çš„å°è£…ï¼Œèƒ½ç®€åŒ–é‚®ä»¶å‘é€ä»£ç ã€‚å…¶æ ¸å¿ƒæ˜¯å®šä¹‰ä¸€ä¸ª `JavaMailSender` çš„ Beanï¼Œç„¶åè°ƒç”¨å…¶ `send()` æ–¹æ³•ã€‚



## ğŸ€ é›†æˆ JMS

JMS å³ Java Message Serviceï¼Œæ˜¯ JavaEE çš„æ¶ˆæ¯æœåŠ¡æ¥å£ã€‚JMS ä¸»è¦æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼š1.1 å’Œ 2.0ã€‚2.0 å’Œ 1.1 ç›¸æ¯”ï¼Œä¸»è¦æ˜¯ç®€åŒ–äº†æ”¶å‘æ¶ˆæ¯çš„ä»£ç ã€‚

æ‰€è°“æ¶ˆæ¯æœåŠ¡ï¼Œå°±æ˜¯ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´ï¼Œé€šè¿‡æ¶ˆæ¯æœåŠ¡å™¨ä¼ é€’æ¶ˆæ¯ï¼š

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Producerâ”‚â”€â”€â”€>â”‚Message Serverâ”‚â”€â”€â”€>â”‚Consumerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä½¿ç”¨æ¶ˆæ¯æœåŠ¡ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨å¯¹æ–¹çš„ APIï¼Œå®ƒçš„å¥½å¤„æ˜¯ï¼š

- åŒæ–¹å„è‡ªæ— éœ€çŸ¥æ™“å¯¹æ–¹çš„å­˜åœ¨ï¼Œæ¶ˆæ¯å¯ä»¥å¼‚æ­¥å¤„ç†ï¼Œå› ä¸ºæ¶ˆæ¯æœåŠ¡å™¨ä¼šåœ¨ Consumer ç¦»çº¿çš„æ—¶å€™è‡ªåŠ¨ç¼“å­˜æ¶ˆæ¯ï¼›
- å¦‚æœ Producer å‘é€çš„æ¶ˆæ¯é¢‘ç‡é«˜äº Consumer çš„å¤„ç†èƒ½åŠ›ï¼Œæ¶ˆæ¯å¯ä»¥ç§¯å‹åœ¨æ¶ˆæ¯æœåŠ¡å™¨ï¼Œä¸è‡³äºå‹å® Consumerï¼›
- é€šè¿‡ä¸€ä¸ªæ¶ˆæ¯æœåŠ¡å™¨ï¼Œå¯ä»¥è¿æ¥å¤šä¸ª Producer å’Œå¤šä¸ª Consumerã€‚

å› ä¸ºæ¶ˆæ¯æœåŠ¡åœ¨å„ç±»åº”ç”¨ç¨‹åºä¸­éå¸¸æœ‰ç”¨ï¼Œæ‰€ä»¥ JavaEE ä¸“é—¨å®šä¹‰äº† JMS è§„èŒƒã€‚æ³¨æ„åˆ° JMS æ˜¯ä¸€ç»„æ¥å£å®šä¹‰ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ JMSï¼Œè¿˜éœ€è¦é€‰æ‹©ä¸€ä¸ªå…·ä½“çš„ JMS äº§å“ã€‚å¸¸ç”¨çš„ JMS æœåŠ¡å™¨æœ‰å¼€æºçš„ [ActiveMQ](https://activemq.apache.org/)ï¼Œå•†ä¸šæœåŠ¡å™¨å¦‚ WebLogicã€WebSphere ç­‰ä¹Ÿå†…ç½®äº† JMS æ”¯æŒã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹©å¼€æºçš„ ActiveMQ ä½œä¸º JMS æœåŠ¡å™¨ï¼Œå› æ­¤ï¼Œåœ¨å¼€å‘ JMS ä¹‹å‰æˆ‘ä»¬å¿…é¡»é¦–å…ˆå®‰è£… ActiveMQã€‚

ç°åœ¨é—®é¢˜æ¥äº†ï¼šä»å®˜ç½‘ä¸‹è½½ ActiveMQ æ—¶ï¼Œè¹¦å‡ºä¸€ä¸ªé¡µé¢ï¼Œè®©æˆ‘ä»¬é€‰æ‹© ActiveMQ Classic æˆ–è€… ActiveMQ Artemisï¼Œè¿™ä¸¤ä¸ªæ˜¯ä»€ä¹ˆå…³ç³»ï¼Œåˆæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

å®é™…ä¸Š ActiveMQ Classic åŸæ¥å°±å« ActiveMQï¼Œæ˜¯ Apache å¼€å‘çš„åŸºäº JMS 1.1 çš„æ¶ˆæ¯æœåŠ¡å™¨ï¼Œç›®å‰ç¨³å®šç‰ˆæœ¬å·æ˜¯ 5.xï¼Œè€Œ ActiveMQ Artemis æ˜¯ç”± RedHat æèµ çš„ [HornetQ](https://hornetq.jboss.org/) æœåŠ¡å™¨ä»£ç çš„åŸºç¡€ä¸Šå¼€å‘çš„ï¼Œç›®å‰ç¨³å®šç‰ˆæœ¬å·æ˜¯ 2.xã€‚å’Œ ActiveMQ Classic ç›¸æ¯”ï¼ŒArtemis ç‰ˆçš„ä»£ç ä¸ Classic å®Œå…¨ä¸åŒï¼Œå¹¶ä¸”ï¼Œå®ƒæ”¯æŒ JMS 2.0ï¼Œä½¿ç”¨åŸºäº Netty çš„å¼‚æ­¥ IOï¼Œå¤§å¤§æå‡äº†æ€§èƒ½ã€‚æ­¤å¤–ï¼ŒArtemis ä¸ä»…æä¾›äº† JMS æ¥å£ï¼Œå®ƒè¿˜æä¾›äº† AMQP æ¥å£ï¼ŒSTOMP æ¥å£å’Œç‰©è”ç½‘ä½¿ç”¨çš„ MQTT æ¥å£ã€‚é€‰æ‹© Artemisï¼Œç›¸å½“äºä¸€é±¼å››åƒã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿™é‡Œç›´æ¥é€‰æ‹© ActiveMQ Artemisã€‚ä»å®˜ç½‘ [ä¸‹è½½](https://activemq.apache.org/components/artemis/download/) æœ€æ–°çš„ 2.x ç‰ˆæœ¬ï¼Œè§£å‹åè®¾ç½®ç¯å¢ƒå˜é‡ `ARTEMIS_HOME`ï¼ŒæŒ‡å‘ Artemis æ ¹ç›®å½•ï¼Œä¾‹å¦‚ `C:\Apps\artemis`ï¼Œç„¶åï¼ŒæŠŠ `ARTEMIS_HOME/bin` åŠ å…¥ PATH ç¯å¢ƒå˜é‡ï¼š

- Windows ä¸‹æ·»åŠ  `%ARTEMIS_HOME%\bin` åˆ° Path è·¯å¾„ï¼›
- Mac å’Œ Linux ä¸‹æ·»åŠ  `$ARTEMIS_HOME/bin` åˆ° PATH è·¯å¾„ã€‚

Artemis æœ‰ä¸ªå¾ˆå¥½çš„è®¾è®¡ï¼Œå°±æ˜¯å®ƒæŠŠç¨‹åºå’Œæ•°æ®å®Œå…¨åˆ†ç¦»äº†ã€‚æˆ‘ä»¬è§£å‹åçš„ `ARTEMIS_HOME` ç›®å½•æ˜¯ç¨‹åºç›®å½•ï¼Œè¦å¯åŠ¨ä¸€ä¸ª Artemis æœåŠ¡ï¼Œè¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®ç›®å½•ã€‚æˆ‘ä»¬æŠŠæ•°æ®ç›®å½•ç›´æ¥è®¾å®šåœ¨é¡¹ç›® `spring-integration-jms` çš„ `jms-data` ç›®å½•ä¸‹ã€‚æ‰§è¡Œå‘½ä»¤ `artemis create jms-data`ï¼š

```bash
$ pwd
/Users/liaoxuefeng/workspace/spring-integration-jms

$ artemis create jms-data
Creating ActiveMQ Artemis instance at: /Users/liaoxuefeng/workspace/spring-integration-jms/jms-data

--user: is a mandatory property!
Please provide the default username:
admin

--password: is mandatory with this configuration:
Please provide the default password:
********

--allow-anonymous | --require-login: is a mandatory property!
Allow anonymous access?, valid values are Y,N,True,False
N

Auto tuning journal ...
done! Your system can make 0.09 writes per millisecond, your journal-buffer-timeout will be 11392000

You can now start the broker by executing:

   "/Users/liaoxuefeng/workspace/spring-integration-jms/jms-data/bin/artemis" run

Or you can run the broker in the background using:

   "/Users/liaoxuefeng/workspace/spring-integration-jms/jms-data/bin/artemis-service" start
```

åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šè¦æ±‚è¾“å…¥è¿æ¥ç”¨æˆ·å’Œå£ä»¤ï¼Œè¿™é‡Œæˆ‘ä»¬è®¾å®š `admin` å’Œ `password`ï¼Œä»¥åŠæ˜¯å¦å…è®¸åŒ¿åè®¿é—®ï¼ˆè¿™é‡Œé€‰æ‹© `N`ï¼‰ã€‚

æ­¤æ•°æ®ç›®å½• `jms-data` ä¸ä»…åŒ…å«æ¶ˆæ¯æ•°æ®ã€æ—¥å¿—ï¼Œè¿˜è‡ªåŠ¨åˆ›å»ºäº†ä¸¤ä¸ªå¯åŠ¨æœåŠ¡çš„å‘½ä»¤ `bin/artemis` å’Œ `bin/artemis-service`ï¼Œå‰è€…åœ¨å‰å°å¯åŠ¨è¿è¡Œï¼ŒæŒ‰ Ctrl+C ç»“æŸï¼Œåè€…ä¼šä¸€ç›´åœ¨åå°è¿è¡Œã€‚

æˆ‘ä»¬æŠŠç›®å½•åˆ‡æ¢åˆ° `jms-data/bin`ï¼Œç›´æ¥è¿è¡Œ `artemis run` å³å¯å¯åŠ¨ Artemis æœåŠ¡ï¼š

```bash
$ ./artemis run
     _        _               _
    / \  ____| |_  ___ __  __(_) _____
   / _ \|  _ \ __|/ _ \  \/  | |/  __/
  / ___ \ | \/ |_/  __/ |\/| | |\___ \
 /_/   \_\|   \__\____|_|  |_|_|/___ /
 Apache ActiveMQ Artemis 2.13.0

...

2020-06-02 07:50:21,718 INFO  [org.apache.activemq.artemis] AMQ241001: HTTP Server started at http://localhost:8161
2020-06-02 07:50:21,718 INFO  [org.apache.activemq.artemis] AMQ241002: Artemis Jolokia REST API available at http://localhost:8161/console/jolokia
2020-06-02 07:50:21,719 INFO  [org.apache.activemq.artemis] AMQ241004: Artemis Console available at http://localhost:8161/console
```

å¯åŠ¨æˆåŠŸåï¼ŒArtemis æç¤ºå¯ä»¥é€šè¿‡ URL`http://localhost:8161/console` è®¿é—®ç®¡ç†åå°ã€‚æ³¨æ„ * ä¸è¦å…³é—­å‘½ä»¤è¡Œçª—å£ *ã€‚

 å¦‚æœ Artemis å¯åŠ¨æ—¶æ˜¾ç¤ºè­¦å‘Šï¼šAMQ222212: Disk Full! ... Clients will report blocked. è¿™æ˜¯å› ä¸ºç£ç›˜ç©ºé—´ä¸å¤Ÿï¼Œå¯ä»¥åœ¨ etc/broker.xml é…ç½®ä¸­æ‰¾åˆ° <max-disk-usage> å¹¶æ”¹ä¸º 99ã€‚

åœ¨ç¼–å†™ JMS ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—ç†è§£ JMS çš„æ¶ˆæ¯æ¨¡å‹ã€‚JMS æŠŠç”Ÿäº§æ¶ˆæ¯çš„ä¸€æ–¹ç§°ä¸º Producerï¼Œå¤„ç†æ¶ˆæ¯çš„ä¸€æ–¹ç§°ä¸º Consumerã€‚æœ‰ä¸¤ç§ç±»å‹çš„æ¶ˆæ¯é€šé“ï¼Œä¸€ç§æ˜¯ Queueï¼š

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Producerâ”‚â”€â”€â”€>â”‚ Queue  â”‚â”€â”€â”€>â”‚Consumerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä¸€ç§æ˜¯ Topicï¼š

```ascii
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”Œâ”€>â”‚Consumerâ”‚
                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Producerâ”‚â”€â”€â”€>â”‚ Topic  â”‚â”€â”¼â”€>â”‚Consumerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                         â””â”€>â”‚Consumerâ”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å®ƒä»¬çš„åŒºåˆ«åœ¨äºï¼ŒQueue æ˜¯ä¸€ç§ä¸€å¯¹ä¸€çš„é€šé“ï¼Œå¦‚æœ Consumer ç¦»çº¿æ— æ³•å¤„ç†æ¶ˆæ¯æ—¶ï¼ŒQueue ä¼šæŠŠæ¶ˆæ¯å­˜èµ·æ¥ï¼Œç­‰ Consumer å†æ¬¡è¿æ¥çš„æ—¶å€™å‘ç»™å®ƒã€‚è®¾å®šäº†æŒä¹…åŒ–æœºåˆ¶çš„ Queue ä¸ä¼šä¸¢å¤±æ¶ˆæ¯ã€‚å¦‚æœæœ‰å¤šä¸ª Consumer æ¥å…¥åŒä¸€ä¸ª Queueï¼Œé‚£ä¹ˆå®ƒä»¬ç­‰æ•ˆäºä»¥é›†ç¾¤æ–¹å¼å¤„ç†æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼Œå‘é€æ–¹å‘é€çš„æ¶ˆæ¯æ˜¯ Aï¼ŒBï¼ŒCï¼ŒDï¼ŒEï¼ŒFï¼Œä¸¤ä¸ª Consumer å¯èƒ½åˆ†åˆ«æ”¶åˆ° Aï¼ŒCï¼ŒE å’Œ Bï¼ŒDï¼ŒFï¼Œå³æ¯ä¸ªæ¶ˆæ¯åªä¼šäº¤ç»™å…¶ä¸­ä¸€ä¸ª Consumer å¤„ç†ã€‚

Topic åˆ™æ˜¯ä¸€ç§ä¸€å¯¹å¤šé€šé“ã€‚ä¸€ä¸ª Producer å‘å‡ºçš„æ¶ˆæ¯ï¼Œä¼šè¢«å¤šä¸ª Consumer åŒæ—¶æ”¶åˆ°ï¼Œå³æ¯ä¸ª Consumer éƒ½ä¼šæ”¶åˆ°ä¸€ä»½å®Œæ•´çš„æ¶ˆæ¯æµã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šå¦‚æœæŸä¸ª Consumer æš‚æ—¶ç¦»çº¿ï¼Œè¿‡ä¸€æ®µæ—¶é—´ååˆä¸Šçº¿äº†ï¼Œé‚£ä¹ˆåœ¨å®ƒç¦»çº¿æœŸé—´äº§ç”Ÿçš„æ¶ˆæ¯è¿˜èƒ½ä¸èƒ½æ”¶åˆ°å‘¢ï¼Ÿ

è¿™å–å†³äºæ¶ˆæ¯æœåŠ¡å™¨å¯¹ Topic ç±»å‹æ¶ˆæ¯çš„æŒä¹…åŒ–æœºåˆ¶ã€‚å¦‚æœæ¶ˆæ¯æœåŠ¡å™¨ä¸å­˜å‚¨ Topic æ¶ˆæ¯ï¼Œé‚£ä¹ˆç¦»çº¿çš„ Consumer ä¼šä¸¢å¤±éƒ¨åˆ†ç¦»çº¿æ—¶æœŸçš„æ¶ˆæ¯ï¼Œå¦‚æœæ¶ˆæ¯æœåŠ¡å™¨å­˜å‚¨äº† Topic æ¶ˆæ¯ï¼Œé‚£ä¹ˆç¦»çº¿çš„ Consumer å¯ä»¥æ”¶åˆ°è‡ªä¸Šæ¬¡ç¦»çº¿æ—¶åˆ»å¼€å§‹åäº§ç”Ÿçš„æ‰€æœ‰æ¶ˆæ¯ã€‚JMS è§„èŒƒé€šè¿‡ Consumer æŒ‡å®šä¸€ä¸ªæŒä¹…åŒ–è®¢é˜…å¯ä»¥åœ¨ä¸Šçº¿åæ”¶å–æ‰€æœ‰ç¦»çº¿æœŸé—´çš„æ¶ˆæ¯ï¼Œå¦‚æœæŒ‡å®šçš„æ˜¯éæŒä¹…åŒ–è®¢é˜…ï¼Œé‚£ä¹ˆç¦»çº¿æœŸé—´çš„æ¶ˆæ¯ä¼šå…¨éƒ¨ä¸¢å¤±ã€‚

ç»†å¿ƒçš„ç«¥é‹å¯ä»¥çœ‹å‡ºæ¥ï¼Œå¦‚æœä¸€ä¸ª Topic çš„æ¶ˆæ¯å…¨éƒ¨éƒ½æŒä¹…åŒ–äº†ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ª Consumerï¼Œé‚£ä¹ˆå®ƒå’Œ Queue å…¶å®æ˜¯ä¸€æ ·çš„ã€‚å®é™…ä¸Šï¼Œå¾ˆå¤šæ¶ˆæ¯æœåŠ¡å™¨å†…éƒ¨éƒ½åªæœ‰ Topic ç±»å‹çš„æ¶ˆæ¯æ¶æ„ï¼ŒQueue å¯ä»¥é€šè¿‡ Topicâ€œæ¨¡æ‹Ÿâ€ å‡ºæ¥ã€‚

æ— è®ºæ˜¯ Queue è¿˜æ˜¯ Topicï¼Œå¯¹ Producer æ²¡æœ‰ä»€ä¹ˆè¦æ±‚ã€‚å¤šä¸ª Producer ä¹Ÿå¯ä»¥å†™å…¥åŒä¸€ä¸ª Queue æˆ–è€… Topicï¼Œæ­¤æ—¶æ¶ˆæ¯æœåŠ¡å™¨å†…éƒ¨ä¼šè‡ªåŠ¨æ’åºç¡®ä¿æ¶ˆæ¯æ€»æ˜¯æœ‰åºçš„ã€‚

ä»¥ä¸Šæ˜¯æ¶ˆæ¯æœåŠ¡çš„åŸºæœ¬æ¨¡å‹ã€‚å…·ä½“åˆ°æŸä¸ªæ¶ˆæ¯æœåŠ¡å™¨æ—¶ï¼ŒProducer å’Œ Consumer é€šå¸¸æ˜¯é€šè¿‡ TCP è¿æ¥æ¶ˆæ¯æœåŠ¡å™¨ï¼Œåœ¨ç¼–å†™ JMS ç¨‹åºæ—¶ï¼Œåˆä¼šé‡åˆ° `ConnectionFactory`ã€`Connection`ã€`Session` ç­‰æ¦‚å¿µï¼Œå…¶å®è¿™å’Œ JDBC è¿æ¥æ˜¯ç±»ä¼¼çš„ï¼š

- ConnectionFactoryï¼šä»£è¡¨ä¸€ä¸ªåˆ°æ¶ˆæ¯æœåŠ¡å™¨çš„è¿æ¥æ± ï¼Œç±»ä¼¼ JDBC çš„ DataSourceï¼›
- Connectionï¼šä»£è¡¨ä¸€ä¸ªåˆ°æ¶ˆæ¯æœåŠ¡å™¨çš„è¿æ¥ï¼Œç±»ä¼¼ JDBC çš„ Connectionï¼›
- Sessionï¼šä»£è¡¨ä¸€ä¸ªç»è¿‡è®¤è¯åçš„è¿æ¥ä¼šè¯ï¼›
- Messageï¼šä»£è¡¨ä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡ã€‚

åœ¨ JMS 1.1 ä¸­ï¼Œå‘é€æ¶ˆæ¯çš„å…¸å‹ä»£ç å¦‚ä¸‹ï¼š

```java
try {
    Connection connection = null;
    try {
        // åˆ›å»ºè¿æ¥:
        connection = connectionFactory.createConnection();
        // åˆ›å»ºä¼šè¯:
        Session session = connection.createSession(false,Session.AUTO_ACKNOWLEDGE);
        // åˆ›å»ºä¸€ä¸ª Producer å¹¶å…³è”åˆ°æŸä¸ª Queue:
        MessageProducer messageProducer = session.createProducer(queue);
        // åˆ›å»ºä¸€ä¸ªæ–‡æœ¬æ¶ˆæ¯:
        TextMessage textMessage = session.createTextMessage(text);
        // å‘é€æ¶ˆæ¯:
        messageProducer.send(textMessage);
    } finally {
        // å…³é—­è¿æ¥:
        if (connection != null) {
            connection.close();
        }
    }
} catch (JMSException ex) {
    // å¤„ç† JMS å¼‚å¸¸
}
```

JMS 2.0 æ”¹è¿›äº†ä¸€äº› API æ¥å£ï¼Œå‘é€æ¶ˆæ¯å˜å¾—æ›´ç®€å•ï¼š

```java
try (JMSContext context = connectionFactory.createContext()) {
    context.createProducer().send(queue, text);
}
```

`JMSContext` å®ç°äº† `AutoCloseable` æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨ `try(resource)` è¯­æ³•ï¼Œä»£ç æ›´ç®€å•ã€‚

æœ‰äº†ä»¥ä¸Šé¢„å¤‡çŸ¥è¯†ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å¼€å‘ JMS åº”ç”¨äº†ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ `pom.xml` ä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š

- org.springframework:spring-jms:6.0.0
- org.apache.activemq:artemis-jakarta-client:2.27.0

Artemis çš„ Client æ¥å£ä¾èµ–äº† `jakarta.jms:jakarta.jms-api`ï¼Œå› æ­¤ä¸å¿…å†å¼•å…¥ JMS API çš„ä¾èµ–ã€‚

åœ¨ AppConfig ä¸­ï¼Œé€šè¿‡ `@EnableJms` è®© Spring è‡ªåŠ¨æ‰«æ JMS ç›¸å…³çš„ Beanï¼Œå¹¶åŠ è½½ JMS é…ç½®æ–‡ä»¶ `jms.properties`ï¼š

```
@Configuration
@ComponentScan
@EnableWebMvc
@EnableJms // å¯ç”¨ JMS
@EnableTransactionManagement
@PropertySource({"classpath:/jdbc.properties", "classpath:/jms.properties"})
public class AppConfig {
    ...
}
```

é¦–å…ˆè¦åˆ›å»ºçš„ Bean æ˜¯ `ConnectionFactory`ï¼Œå³è¿æ¥æ¶ˆæ¯æœåŠ¡å™¨çš„è¿æ¥æ± ï¼š

```java
@Bean
ConnectionFactory createJMSConnectionFactory(
    @Value("${jms.uri:tcp://localhost:61616}") String uri,
    @Value("${jms.username:admin}") String username,
    @Value("${jms.password:password}") String password)
{
    return new ActiveMQJMSConnectionFactory(uri, username, password);
}
```

å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ¶ˆæ¯æœåŠ¡å™¨æ˜¯ ActiveMQ Artemisï¼Œæ‰€ä»¥ `ConnectionFactory` çš„å®ç°ç±»å°±æ˜¯æ¶ˆæ¯æœåŠ¡å™¨æä¾›çš„ `ActiveMQJMSConnectionFactory`ï¼Œå®ƒéœ€è¦çš„å‚æ•°å‡ç”±é…ç½®æ–‡ä»¶è¯»å–åä¼ å…¥ï¼Œå¹¶è®¾ç½®äº†é»˜è®¤å€¼ã€‚

æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ª `JmsTemplate`ï¼Œå®ƒæ˜¯ Spring æä¾›çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œå’Œ `JdbcTemplate` ç±»ä¼¼ï¼Œå¯ä»¥ç®€åŒ–å‘é€æ¶ˆæ¯çš„ä»£ç ï¼š

```java
@Bean
JmsTemplate createJmsTemplate(@Autowired ConnectionFactory connectionFactory) {
    return new JmsTemplate(connectionFactory);
}
```

ä¸‹ä¸€æ­¥è¦åˆ›å»ºçš„æ˜¯ `JmsListenerContainerFactory`ï¼Œ

```java
@Bean("jmsListenerContainerFactory")
DefaultJmsListenerContainerFactory createJmsListenerContainerFactory(@Autowired ConnectionFactory connectionFactory) {
    var factory = new DefaultJmsListenerContainerFactory();
    factory.setConnectionFactory(connectionFactory);
    return factory;
}
```

é™¤äº†å¿…é¡»æŒ‡å®š Bean çš„åç§°ä¸º `jmsListenerContainerFactory` å¤–ï¼Œè¿™ä¸ª Bean çš„ä½œç”¨æ˜¯å¤„ç†å’Œ Consumer ç›¸å…³çš„ Beanã€‚æˆ‘ä»¬å…ˆè·³è¿‡å®ƒçš„åŸç†ï¼Œç»§ç»­ç¼–å†™ `MessagingService` æ¥å‘é€æ¶ˆæ¯ï¼š

```java
@Component
public class MessagingService {
    @Autowired ObjectMapper objectMapper;
    @Autowired JmsTemplate jmsTemplate;

    public void sendMailMessage(MailMessage msg) throws Exception {
        String text = objectMapper.writeValueAsString(msg);
        jmsTemplate.send("jms/queue/mail", new MessageCreator() {
            public Message createMessage(Session session) throws JMSException {
                return session.createTextMessage(text);
            }
        });
    }
}
```

JMS çš„æ¶ˆæ¯ç±»å‹æ”¯æŒä»¥ä¸‹å‡ ç§ï¼š

- TextMessageï¼šæ–‡æœ¬æ¶ˆæ¯ï¼›
- BytesMessageï¼šäºŒè¿›åˆ¶æ¶ˆæ¯ï¼›
- MapMessageï¼šåŒ…å«å¤šä¸ª Key-Value å¯¹çš„æ¶ˆæ¯ï¼›
- ObjectMessageï¼šç›´æ¥åºåˆ—åŒ– Java å¯¹è±¡çš„æ¶ˆæ¯ï¼›
- StreamMessageï¼šä¸€ä¸ªåŒ…å«åŸºæœ¬ç±»å‹åºåˆ—çš„æ¶ˆæ¯ã€‚

æœ€å¸¸ç”¨çš„æ˜¯å‘é€åŸºäº JSON çš„æ–‡æœ¬æ¶ˆæ¯ï¼Œä¸Šè¿°ä»£ç é€šè¿‡ `JmsTemplate` åˆ›å»ºä¸€ä¸ª `TextMessage` å¹¶å‘é€åˆ°åç§°ä¸º `jms/queue/mail` çš„ Queueã€‚

æ³¨æ„ï¼šArtemis æ¶ˆæ¯æœåŠ¡å™¨é»˜è®¤é…ç½®ä¸‹ä¼šè‡ªåŠ¨åˆ›å»º Queueï¼Œå› æ­¤ä¸å¿…æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªåä¸º `jms/queue/mail` çš„ Queueï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„æ¶ˆæ¯æœåŠ¡å™¨éƒ½ä¼šè‡ªåŠ¨åˆ›å»º Queueï¼Œç”Ÿäº§ç¯å¢ƒçš„æ¶ˆæ¯æœåŠ¡å™¨é€šå¸¸ä¼šå…³é—­è‡ªåŠ¨åˆ›å»ºåŠŸèƒ½ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»º Queueã€‚

å†æ³¨æ„åˆ° `MailMessage` æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ä¸€ä¸ª JavaBeanï¼ŒçœŸæ­£çš„ JMS æ¶ˆæ¯æ˜¯åˆ›å»ºçš„ `TextMessage`ï¼Œå®ƒçš„å†…å®¹æ˜¯ JSONã€‚

å½“ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œæˆ‘ä»¬å°±è°ƒç”¨ `MessagingService.sendMailMessage()` å‘é€ä¸€æ¡ JMS æ¶ˆæ¯ï¼Œæ­¤ä»£ç ååˆ†ç®€å•ï¼Œè¿™é‡Œä¸å†è´´å‡ºã€‚

ä¸‹é¢æˆ‘ä»¬è¦è¯¦ç»†è®¨è®ºçš„æ˜¯å¦‚ä½•å¤„ç†æ¶ˆæ¯ï¼Œå³ç¼–å†™ Consumerã€‚ä»ç†è®ºä¸Šè®²ï¼Œå¯ä»¥åˆ›å»ºå¦ä¸€ä¸ª Java è¿›ç¨‹æ¥å¤„ç†æ¶ˆæ¯ï¼Œä½†å¯¹äºæˆ‘ä»¬è¿™ä¸ªç®€å•çš„ Web ç¨‹åºæ¥è¯´æ²¡æœ‰å¿…è¦ï¼Œç›´æ¥åœ¨åŒä¸€ä¸ª Web åº”ç”¨ä¸­æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯å³å¯ã€‚

å¤„ç†æ¶ˆæ¯çš„æ ¸å¿ƒä»£ç æ˜¯ç¼–å†™ä¸€ä¸ª Beanï¼Œå¹¶åœ¨å¤„ç†æ–¹æ³•ä¸Šæ ‡æ³¨ `@JmsListener`ï¼š

```java
@Component
public class MailMessageListener {
    final Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired ObjectMapper objectMapper;
    @Autowired MailService mailService;

    @JmsListener(destination = "jms/queue/mail", concurrency = "10")
    public void onMailMessageReceived(Message message) throws Exception {
        logger.info("received message:" + message);
        if (message instanceof TextMessage) {
            String text = ((TextMessage) message).getText();
            MailMessage mm = objectMapper.readValue(text, MailMessage.class);
            mailService.sendRegistrationMail(mm);
        } else {
            logger.error("unable to process non-text message!");
        }
    }
}
```

æ³¨æ„åˆ° `@JmsListener` æŒ‡å®šäº† Queue çš„åç§°ï¼Œå› æ­¤ï¼Œå‡¡æ˜¯å‘åˆ°æ­¤ Queue çš„æ¶ˆæ¯éƒ½ä¼šè¢«è¿™ä¸ª `onMailMessageReceived()` æ–¹æ³•å¤„ç†ï¼Œæ–¹æ³•å‚æ•°æ˜¯ JMS çš„ `Message` æ¥å£ï¼Œæˆ‘ä»¬é€šè¿‡å¼ºåˆ¶è½¬å‹ä¸º `TextMessage` å¹¶æå– JSONï¼Œååºåˆ—åŒ–åè·å¾—è‡ªå®šä¹‰çš„ JavaBeanï¼Œä¹Ÿå°±è·å¾—äº†å‘é€é‚®ä»¶æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚

ä¸‹é¢é—®é¢˜æ¥äº†ï¼šSpring å¤„ç† JMS æ¶ˆæ¯çš„æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

å¦‚æœæˆ‘ä»¬ç›´æ¥è°ƒç”¨ JMS çš„ API æ¥å¤„ç†æ¶ˆæ¯ï¼Œé‚£ä¹ˆç¼–å†™çš„ä»£ç å¤§è‡´å¦‚ä¸‹ï¼š

```
// åˆ›å»º JMS è¿æ¥:
Connection connection = connectionFactory.createConnection();
// åˆ›å»ºä¼šè¯:
Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
// åˆ›å»ºä¸€ä¸ª Consumer:
MessageConsumer consumer = session.createConsumer(queue);
// ä¸º Consumer æŒ‡å®šä¸€ä¸ªæ¶ˆæ¯å¤„ç†å™¨:
consumer.setMessageListener(new MessageListener() {
    public void onMessage(Message message) {
        // åœ¨æ­¤å¤„ç†æ¶ˆæ¯...
    }
});
// å¯åŠ¨æ¥æ”¶æ¶ˆæ¯çš„å¾ªç¯:
connection.start();
```

æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ `MailMessageListener.onMailMessageReceived()` ç›¸å½“äºæ¶ˆæ¯å¤„ç†å™¨ï¼š

```
consumer.setMessageListener(new MessageListener() {
    public void onMessage(Message message) {
        mailMessageListener.onMailMessageReceived(message);
    }
});
```

æ‰€ä»¥ï¼ŒSpring æ ¹æ® `AppConfig` çš„æ³¨è§£ `@EnableJms` è‡ªåŠ¨æ‰«æå¸¦æœ‰ `@JmsListener` çš„ Bean æ–¹æ³•ï¼Œå¹¶ä¸ºå…¶åˆ›å»ºä¸€ä¸ª `MessageListener` æŠŠå®ƒåŒ…è£…èµ·æ¥ã€‚

æ³¨æ„åˆ°å‰é¢æˆ‘ä»¬è¿˜åˆ›å»ºäº†ä¸€ä¸ª `JmsListenerContainerFactory` çš„ Beanï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ä¸ºæ¯ä¸ª `MessageListener` åˆ›å»º `MessageConsumer` å¹¶å¯åŠ¨æ¶ˆæ¯æ¥æ”¶å¾ªç¯ã€‚

å†æ³¨æ„åˆ° `@JmsListener` è¿˜æœ‰ä¸€ä¸ª `concurrency` å‚æ•°ï¼Œ10 è¡¨ç¤ºå¯ä»¥æœ€å¤šåŒæ—¶å¹¶å‘å¤„ç† 10 ä¸ªæ¶ˆæ¯ï¼Œ`5-10` è¡¨ç¤ºå¹¶å‘å¤„ç†çš„çº¿ç¨‹å¯ä»¥åœ¨ 5~10 ä¹‹é—´è°ƒæ•´ã€‚

å› æ­¤ï¼ŒSpring åœ¨é€šè¿‡ `MessageListener` æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨ `mailMessageListener.onMailMessageReceived()`ï¼Œè€Œæ˜¯ç”¨çº¿ç¨‹æ± è°ƒç”¨ï¼Œå› æ­¤ï¼Œè¦æ—¶åˆ»ç‰¢è®°ï¼Œ`onMailMessageReceived()` æ–¹æ³•å¯èƒ½è¢«å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œä¸€å®šè¦ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ Spring æ¥æ”¶æ¶ˆæ¯çš„æ­¥éª¤ï¼š

é€šè¿‡ `JmsListenerContainerFactory` é…åˆ `@EnableJms` æ‰«ææ‰€æœ‰ `@JmsListener` æ–¹æ³•ï¼Œè‡ªåŠ¨åˆ›å»º `MessageConsumer`ã€`MessageListener` ä»¥åŠçº¿ç¨‹æ± ï¼Œå¯åŠ¨æ¶ˆæ¯å¾ªç¯æ¥æ”¶å¤„ç†æ¶ˆæ¯ï¼Œæœ€ç»ˆç”±æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ `@JmsListener` æ–¹æ³•å¤„ç†æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šç”±å¤šçº¿ç¨‹åŒæ—¶å¹¶å‘å¤„ç†ã€‚

è¦éªŒè¯æ¶ˆæ¯å‘é€å’Œå¤„ç†ï¼Œæˆ‘ä»¬æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ—¥å¿—è¾“å‡ºï¼š

```
2020-06-02 08:04:27 INFO  c.i.learnjava.web.UserController - user registered: bob@example.com
2020-06-02 08:04:27 INFO  c.i.l.service.MailMessageListener - received message: ActiveMQMessage[ID:9fc5...]:PERSISTENT/ClientMessageImpl[messageID=983, durable=true, address=jms/queue/mail, ...]]
2020-06-02 08:04:27 INFO  c.i.learnjava.service.MailService - [send mail] sending registration mail to bob@example.com...
2020-06-02 08:04:30 INFO  c.i.learnjava.service.MailService - [send mail] registration mail was sent to bob@example.com.
```

å¯è§ï¼Œæ¶ˆæ¯è¢«æˆåŠŸå‘é€åˆ° Artemisï¼Œç„¶ååœ¨å¾ˆçŸ­çš„æ—¶é—´å†…è¢«æ¥æ”¶å¤„ç†äº†ã€‚

ä½¿ç”¨æ¶ˆæ¯æœåŠ¡å¯¹å‘é€ Email è¿›è¡Œæ”¹é€ çš„å¥½å¤„æ˜¯ï¼Œå‘é€ Email çš„èƒ½åŠ›é€šå¸¸æ˜¯æœ‰é™çš„ï¼Œé€šè¿‡ JMS æ¶ˆæ¯æœåŠ¡ï¼Œå¦‚æœçŸ­æ—¶é—´å†…éœ€è¦ç»™å¤§é‡ç”¨æˆ·å‘é€ Emailï¼Œå¯ä»¥å…ˆæŠŠæ¶ˆæ¯å †ç§¯åœ¨ JMS æœåŠ¡å™¨ä¸Šæ…¢æ…¢å‘é€ï¼Œå¯¹äºæ‰¹é‡å‘é€é‚®ä»¶ã€çŸ­ä¿¡ç­‰å°¤å…¶æœ‰ç”¨ã€‚

### ç»ƒä¹ 



### å°ç»“

JMS æ˜¯ Java æ¶ˆæ¯æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡ JMS æœåŠ¡å™¨å®ç°æ¶ˆæ¯çš„å¼‚æ­¥å¤„ç†ã€‚

æ¶ˆæ¯æœåŠ¡ä¸»è¦è§£å†³ Producer å’Œ Consumer ç”Ÿäº§å’Œå¤„ç†é€Ÿåº¦ä¸åŒ¹é…çš„é—®é¢˜ã€‚



## ğŸ€ ä½¿ç”¨ Scheduler


åœ¨å¾ˆå¤šåº”ç”¨ç¨‹åºä¸­ï¼Œç»å¸¸éœ€è¦æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œæ¯å¤©æˆ–æ¯æœˆç»™ç”¨æˆ·å‘é€è´¦æˆ·æ±‡æ€»æŠ¥è¡¨ï¼Œå®šæœŸæ£€æŸ¥å¹¶å‘é€ç³»ç»ŸçŠ¶æ€æŠ¥å‘Šï¼Œç­‰ç­‰ã€‚

å®šæ—¶ä»»åŠ¡æˆ‘ä»¬åœ¨ [ä½¿ç”¨çº¿ç¨‹æ± ](https://www.liaoxuefeng.com/wiki/1252599548343744/1306581130018849) ä¸€èŠ‚ä¸­å·²ç»è®²åˆ°äº†ï¼ŒJava æ ‡å‡†åº“æœ¬èº«å°±æä¾›äº†å®šæ—¶æ‰§è¡Œä»»åŠ¡çš„åŠŸèƒ½ã€‚åœ¨ Spring ä¸­ï¼Œä½¿ç”¨å®šæ—¶ä»»åŠ¡æ›´ç®€å•ï¼Œä¸éœ€è¦æ‰‹å†™çº¿ç¨‹æ± ç›¸å…³ä»£ç ï¼Œåªéœ€è¦ä¸¤ä¸ªæ³¨è§£å³å¯ã€‚

æˆ‘ä»¬è¿˜æ˜¯ä»¥å®é™…ä»£ç ä¸ºä¾‹ï¼Œå»ºç«‹å·¥ç¨‹ `spring-integration-schedule`ï¼Œæ— éœ€é¢å¤–çš„ä¾èµ–ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ `AppConfig` ä¸­åŠ ä¸Š `@EnableScheduling` å°±å¼€å¯äº†å®šæ—¶ä»»åŠ¡çš„æ”¯æŒï¼š

```java
@Configuration
@ComponentScan
@EnableWebMvc
@EnableScheduling
@EnableTransactionManagement
@PropertySource({"classpath:/jdbc.properties", "classpath:/task.properties"})
public class AppConfig {
    ...
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ä¸€ä¸ª Bean ä¸­ç¼–å†™ä¸€ä¸ª `public void` æ— å‚æ•°æ–¹æ³•ï¼Œç„¶ååŠ ä¸Š `@Scheduled` æ³¨è§£ï¼š

```java
@Component
public class TaskService {
    final Logger logger = LoggerFactory.getLogger(getClass());

    @Scheduled(initialDelay = 60_000, fixedRate = 60_000)
    public void checkSystemStatusEveryMinute() {
        logger.info("Start check system status...");
    }
}
```

ä¸Šè¿°æ³¨è§£æŒ‡å®šäº†å¯åŠ¨å»¶è¿Ÿ 60 ç§’ï¼Œå¹¶ä»¥ 60 ç§’çš„é—´éš”æ‰§è¡Œä»»åŠ¡ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ç›´æ¥è¿è¡Œåº”ç”¨ç¨‹åºï¼Œå°±å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°å®šæ—¶ä»»åŠ¡æ‰“å°çš„æ—¥å¿—ï¼š

```bash
2020-06-03 18:47:32 INFO  [pool-1-thread-1] c.i.learnjava.service.TaskService - Start check system status...
2020-06-03 18:48:32 INFO  [pool-1-thread-1] c.i.learnjava.service.TaskService - Start check system status...
2020-06-03 18:49:32 INFO  [pool-1-thread-1] c.i.learnjava.service.TaskService - Start check system status...
```

å¦‚æœæ²¡æœ‰çœ‹åˆ°å®šæ—¶ä»»åŠ¡çš„æ—¥å¿—ï¼Œéœ€è¦æ£€æŸ¥ï¼š

- æ˜¯å¦å¿˜è®°äº†åœ¨ `AppConfig` ä¸­æ ‡æ³¨ `@EnableScheduling`ï¼›
- æ˜¯å¦å¿˜è®°äº†åœ¨å®šæ—¶ä»»åŠ¡çš„æ–¹æ³•æ‰€åœ¨çš„ class æ ‡æ³¨ `@Component`ã€‚

é™¤äº†å¯ä»¥ä½¿ç”¨ `fixedRate` å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `fixedDelay`ï¼Œä¸¤è€…çš„åŒºåˆ«æˆ‘ä»¬å·²ç»åœ¨ [ä½¿ç”¨çº¿ç¨‹æ± ](https://www.liaoxuefeng.com/wiki/1252599548343744/1306581130018849) ä¸€èŠ‚ä¸­è®²è¿‡ï¼Œè¿™é‡Œä¸å†é‡å¤ã€‚

æœ‰çš„ç«¥é‹åœ¨å®é™…å¼€å‘ä¸­ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸º Java çš„æ³¨è§£å…¨éƒ¨æ˜¯å¸¸é‡ï¼Œå†™æ­»äº† `fixedDelay=30000`ï¼Œå¦‚æœæ ¹æ®å®é™…æƒ…å†µè¦æ”¹æˆ 60 ç§’æ€ä¹ˆåŠï¼Œåªèƒ½é‡æ–°ç¼–è¯‘ï¼Ÿ

æˆ‘ä»¬å¯ä»¥æŠŠå®šæ—¶ä»»åŠ¡çš„é…ç½®æ”¾åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚ `task.properties`ï¼š

```
task.checkDiskSpace=30000
```

è¿™æ ·å°±å¯ä»¥éšæ—¶ä¿®æ”¹é…ç½®æ–‡ä»¶è€Œæ— éœ€åŠ¨ä»£ç ã€‚ä½†æ˜¯åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ `fixedDelayString` å–ä»£ `fixedDelay`ï¼š

```java
@Component
public class TaskService {
    ...

    @Scheduled(initialDelay = 30_000, fixedDelayString = "${task.checkDiskSpace:30000}")
    public void checkDiskSpaceEveryMinute() {
        logger.info("Start check disk space...");
    }
}
```

æ³¨æ„åˆ°ä¸Šè¿°ä»£ç çš„æ³¨è§£å‚æ•° `fixedDelayString` æ˜¯ä¸€ä¸ªå±æ€§å ä½ç¬¦ï¼Œå¹¶é…æœ‰é»˜è®¤å€¼ 30000ï¼ŒSpring åœ¨å¤„ç† `@Scheduled` æ³¨è§£æ—¶ï¼Œå¦‚æœé‡åˆ° `String`ï¼Œä¼šæ ¹æ®å ä½ç¬¦è‡ªåŠ¨ç”¨é…ç½®é¡¹æ›¿æ¢ï¼Œè¿™æ ·å°±å¯ä»¥çµæ´»åœ°ä¿®æ”¹å®šæ—¶ä»»åŠ¡çš„é…ç½®ã€‚

æ­¤å¤–ï¼Œ`fixedDelayString` è¿˜å¯ä»¥ä½¿ç”¨æ›´æ˜“è¯»çš„ `Duration`ï¼Œä¾‹å¦‚ï¼š

```
@Scheduled(initialDelay = 30_000, fixedDelayString = "${task.checkDiskSpace:PT2M30S}")
```

ä»¥å­—ç¬¦ä¸² `PT2M30S` è¡¨ç¤ºçš„ `Duration` å°±æ˜¯ 2 åˆ† 30 ç§’ï¼Œè¯·å‚è€ƒ [LocalDateTime](https://www.liaoxuefeng.com/wiki/1252599548343744/1303871087444002) ä¸€èŠ‚çš„ Duration ç›¸å…³éƒ¨åˆ†ã€‚

å¤šä¸ª `@Scheduled` æ–¹æ³•å®Œå…¨å¯ä»¥æ”¾åˆ°ä¸€ä¸ª Bean ä¸­ï¼Œè¿™æ ·ä¾¿äºç»Ÿä¸€ç®¡ç†å„ç±»å®šæ—¶ä»»åŠ¡ã€‚

### ä½¿ç”¨ Cron ä»»åŠ¡

è¿˜æœ‰ä¸€ç±»å®šæ—¶ä»»åŠ¡ï¼Œå®ƒä¸æ˜¯ç®€å•çš„é‡å¤æ‰§è¡Œï¼Œè€Œæ˜¯æŒ‰æ—¶é—´è§¦å‘ï¼Œæˆ‘ä»¬æŠŠè¿™ç±»ä»»åŠ¡ç§°ä¸º Cron ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š

- æ¯å¤©å‡Œæ™¨ 2:15 æ‰§è¡ŒæŠ¥è¡¨ä»»åŠ¡ï¼›
- æ¯ä¸ªå·¥ä½œæ—¥ 12:00 æ‰§è¡Œç‰¹å®šä»»åŠ¡ï¼›
- â€¦â€¦

Cron æºè‡ª Unix/Linux ç³»ç»Ÿè‡ªå¸¦çš„ crond å®ˆæŠ¤è¿›ç¨‹ï¼Œä»¥ä¸€ä¸ªç®€æ´çš„è¡¨è¾¾å¼å®šä¹‰ä»»åŠ¡è§¦å‘æ—¶é—´ã€‚åœ¨ Spring ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Cron è¡¨è¾¾å¼æ¥æ‰§è¡Œ Cron ä»»åŠ¡ï¼Œåœ¨ Spring ä¸­ï¼Œå®ƒçš„æ ¼å¼æ˜¯ï¼š

```
ç§’ åˆ† å°æ—¶ å¤© æœˆä»½ æ˜ŸæœŸ å¹´
```

å¹´æ˜¯å¯ä»¥å¿½ç•¥çš„ï¼Œé€šå¸¸ä¸å†™ã€‚æ¯å¤©å‡Œæ™¨ 2:15 æ‰§è¡Œçš„ Cron è¡¨è¾¾å¼å°±æ˜¯ï¼š

```
0 15 2 * * *
```

æ¯ä¸ªå·¥ä½œæ—¥ 12:00 æ‰§è¡Œçš„ Cron è¡¨è¾¾å¼å°±æ˜¯ï¼š

```
0 0 12 * * MON-FRI
```

æ¯ä¸ªæœˆ 1 å·ï¼Œ2 å·ï¼Œ3 å·å’Œ 10 å· 12:00 æ‰§è¡Œçš„ Cron è¡¨è¾¾å¼å°±æ˜¯ï¼š

```
0 0 12 1-3,10 * *
```

åœ¨ Spring ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ¯å¤©å‡Œæ™¨ 2:15 æ‰§è¡Œçš„ä»»åŠ¡ï¼š

```java
@Component
public class TaskService {
    ...

    @Scheduled(cron = "${task.report:0 15 2 * * *}")
    public void cronDailyReport() {
        logger.info("Start daily report task...");
    }
}
```

Cron ä»»åŠ¡åŒæ ·å¯ä»¥ä½¿ç”¨å±æ€§å ä½ç¬¦ï¼Œè¿™æ ·ä¿®æ”¹èµ·æ¥æ›´åŠ æ–¹ä¾¿ã€‚

Cron è¡¨è¾¾å¼è¿˜å¯ä»¥è¡¨è¾¾æ¯ 10 åˆ†é’Ÿæ‰§è¡Œï¼Œä¾‹å¦‚ï¼š

```
0 */10 * * * *
```

è¿™æ ·ï¼Œåœ¨æ¯ä¸ªå°æ—¶çš„ 0:00ï¼Œ10:00ï¼Œ20:00ï¼Œ30:00ï¼Œ40:00ï¼Œ50:00 å‡ä¼šæ‰§è¡Œä»»åŠ¡ï¼Œå®é™…ä¸Šå®ƒå¯ä»¥å–ä»£ `fixedRate` ç±»å‹çš„å®šæ—¶ä»»åŠ¡ã€‚

### é›†æˆ Quartz

åœ¨ Spring ä¸­ä½¿ç”¨å®šæ—¶ä»»åŠ¡å’Œ Cron ä»»åŠ¡éƒ½ååˆ†ç®€å•ï¼Œä½†æ˜¯è¦æ³¨æ„åˆ°ï¼Œè¿™äº›ä»»åŠ¡çš„è°ƒåº¦éƒ½æ˜¯åœ¨æ¯ä¸ª JVM è¿›ç¨‹ä¸­çš„ã€‚å¦‚æœåœ¨æœ¬æœºå¯åŠ¨ä¸¤ä¸ªè¿›ç¨‹ï¼Œæˆ–è€…åœ¨å¤šå°æœºå™¨ä¸Šå¯åŠ¨åº”ç”¨ï¼Œè¿™äº›è¿›ç¨‹çš„å®šæ—¶ä»»åŠ¡å’Œ Cron ä»»åŠ¡éƒ½æ˜¯ç‹¬ç«‹è¿è¡Œçš„ï¼Œäº’ä¸å½±å“ã€‚

å¦‚æœä¸€äº›å®šæ—¶ä»»åŠ¡è¦ä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œï¼Œä¾‹å¦‚æ¯å¤© 23:00 æ‰§è¡Œæ£€æŸ¥ä»»åŠ¡ï¼Œåªéœ€è¦é›†ç¾¤ä¸­çš„ä¸€å°è¿è¡Œå³å¯ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ [Quartz](https://www.quartz-scheduler.org/)ã€‚

Quartz å¯ä»¥é…ç½®ä¸€ä¸ª JDBC æ•°æ®æºï¼Œä»¥ä¾¿å­˜å‚¨æ‰€æœ‰çš„ä»»åŠ¡è°ƒåº¦è®¡åˆ’ä»¥åŠä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å†…å­˜æ¥è°ƒåº¦ä»»åŠ¡ï¼Œä½†è¿™æ ·é…ç½®å°±å’Œä½¿ç”¨ Spring çš„è°ƒåº¦æ²¡å•¥åŒºåˆ«äº†ï¼Œé¢å¤–é›†æˆ Quartz çš„æ„ä¹‰å°±ä¸å¤§ã€‚

Quartz çš„ JDBC é…ç½®æ¯”è¾ƒå¤æ‚ï¼ŒSpring å¯¹å…¶ä¹Ÿæœ‰ä¸€å®šçš„æ”¯æŒã€‚è¦è¯¦ç»†äº†è§£ Quartz çš„é›†æˆï¼Œè¯·å‚è€ƒ [Spring çš„æ–‡æ¡£](https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#scheduling-quartz)ã€‚

æ€è€ƒï¼šå¦‚æœä¸ä½¿ç”¨ Quartz çš„ JDBC é…ç½®ï¼Œå¤šä¸ª Spring åº”ç”¨åŒæ—¶è¿è¡Œæ—¶ï¼Œå¦‚ä½•ä¿è¯æŸä¸ªä»»åŠ¡åªåœ¨æŸä¸€å°æœºå™¨æ‰§è¡Œï¼Ÿ

### ç»ƒä¹ 


### å°ç»“

Spring å†…ç½®å®šæ—¶ä»»åŠ¡å’Œ Cron ä»»åŠ¡çš„æ”¯æŒï¼Œç¼–å†™è°ƒåº¦ä»»åŠ¡ååˆ†æ–¹ä¾¿ã€‚



## ğŸ€ é›†æˆ JMX

åœ¨ Spring ä¸­ï¼Œå¯ä»¥æ–¹ä¾¿åœ°é›†æˆ JMXã€‚

é‚£ä¹ˆç¬¬ä¸€ä¸ªé—®é¢˜æ¥äº†ï¼šä»€ä¹ˆæ˜¯ JMXï¼Ÿ

JMX æ˜¯ Java Management Extensionsï¼Œå®ƒæ˜¯ä¸€ä¸ª Java å¹³å°çš„ç®¡ç†å’Œç›‘æ§æ¥å£ã€‚ä¸ºä»€ä¹ˆè¦æ JMX å‘¢ï¼Ÿå› ä¸ºåœ¨æ‰€æœ‰çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¯¹è¿è¡Œä¸­çš„ç¨‹åºè¿›è¡Œç›‘æ§éƒ½æ˜¯éå¸¸é‡è¦çš„ï¼ŒJava åº”ç”¨ç¨‹åºä¹Ÿä¸ä¾‹å¤–ã€‚æˆ‘ä»¬è‚¯å®šå¸Œæœ›çŸ¥é“ Java åº”ç”¨ç¨‹åºå½“å‰çš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œå ç”¨äº†å¤šå°‘å†…å­˜ï¼Œåˆ†é…äº†å¤šå°‘å†…å­˜ï¼Œå½“å‰æœ‰å¤šå°‘æ´»åŠ¨çº¿ç¨‹ï¼Œæœ‰å¤šå°‘ä¼‘çœ çº¿ç¨‹ç­‰ç­‰ã€‚å¦‚ä½•è·å–è¿™äº›ä¿¡æ¯å‘¢ï¼Ÿ

ä¸ºäº†æ ‡å‡†åŒ–ç®¡ç†å’Œç›‘æ§ï¼ŒJava å¹³å°ä½¿ç”¨ JMX ä½œä¸ºç®¡ç†å’Œç›‘æ§çš„æ ‡å‡†æ¥å£ï¼Œä»»ä½•ç¨‹åºï¼Œåªè¦æŒ‰ JMX è§„èŒƒè®¿é—®è¿™ä¸ªæ¥å£ï¼Œå°±å¯ä»¥è·å–æ‰€æœ‰ç®¡ç†ä¸ç›‘æ§ä¿¡æ¯ã€‚

å®é™…ä¸Šï¼Œå¸¸ç”¨çš„è¿ç»´ç›‘æ§å¦‚ Zabbixã€Nagios ç­‰å·¥å…·å¯¹ JVM æœ¬èº«çš„ç›‘æ§éƒ½æ˜¯é€šè¿‡ JMX è·å–çš„ä¿¡æ¯ã€‚

å› ä¸º JMX æ˜¯ä¸€ä¸ªæ ‡å‡†æ¥å£ï¼Œä¸ä½†å¯ä»¥ç”¨äºç®¡ç† JVMï¼Œè¿˜å¯ä»¥ç®¡ç†åº”ç”¨ç¨‹åºè‡ªèº«ã€‚ä¸‹å›¾æ˜¯ JMX çš„æ¶æ„ï¼š

```ascii
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚jconsole â”‚  â”‚   Web   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚
â”Œ â”€ â”€ â”€ â”€â”‚â”€ â”€ â”€ â”€ â”€ â”€ â”¼ â”€ â”€ â”€ â”€
 JVM     â–¼            â–¼        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”Œâ”€â”¤Connectorâ”œâ”€â”€â”¤ Adaptor â”œâ”€â” â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚       MBeanServer        â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
  â””â”€â”¤MBean1â”œâ”¤MBean2â”œâ”¤MBean3â”œâ”€â”˜ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜
 â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
```

JMX æŠŠæ‰€æœ‰è¢«ç®¡ç†çš„èµ„æºéƒ½ç§°ä¸º MBeanï¼ˆManaged Beanï¼‰ï¼Œè¿™äº› MBean å…¨éƒ¨ç”± MBeanServer ç®¡ç†ï¼Œå¦‚æœè¦è®¿é—® MBeanï¼Œå¯ä»¥é€šè¿‡ MBeanServer å¯¹å¤–æä¾›çš„è®¿é—®æ¥å£ï¼Œä¾‹å¦‚é€šè¿‡ RMI æˆ– HTTP è®¿é—®ã€‚

æ³¨æ„åˆ°ä½¿ç”¨ JMX ä¸éœ€è¦å®‰è£…ä»»ä½•é¢å¤–ç»„ä»¶ï¼Œä¹Ÿä¸éœ€è¦ç¬¬ä¸‰æ–¹åº“ï¼Œå› ä¸º MBeanServer å·²ç»å†…ç½®åœ¨ JavaSE æ ‡å‡†åº“ä¸­äº†ã€‚JavaSE è¿˜æä¾›äº†ä¸€ä¸ª `jconsole` ç¨‹åºï¼Œç”¨äºé€šè¿‡ RMI è¿æ¥åˆ° MBeanServerï¼Œè¿™æ ·å°±å¯ä»¥ç®¡ç†æ•´ä¸ª Java è¿›ç¨‹ã€‚

é™¤äº† JVM ä¼šæŠŠè‡ªèº«çš„å„ç§èµ„æºä»¥ MBean æ³¨å†Œåˆ° JMX ä¸­ï¼Œæˆ‘ä»¬è‡ªå·±çš„é…ç½®ã€ç›‘æ§ä¿¡æ¯ä¹Ÿå¯ä»¥ä½œä¸º MBean æ³¨å†Œåˆ° JMXï¼Œè¿™æ ·ï¼Œç®¡ç†ç¨‹åºå°±å¯ä»¥ç›´æ¥æ§åˆ¶æˆ‘ä»¬æš´éœ²çš„ MBeanã€‚å› æ­¤ï¼Œåº”ç”¨ç¨‹åºä½¿ç”¨ JMXï¼Œåªéœ€è¦ä¸¤æ­¥ï¼š

1. ç¼–å†™ MBean æä¾›ç®¡ç†æ¥å£å’Œç›‘æ§æ•°æ®ï¼›
2. æ³¨å†Œ MBeanã€‚

åœ¨ Spring åº”ç”¨ç¨‹åºä¸­ï¼Œä½¿ç”¨ JMX åªéœ€è¦ä¸€æ­¥ï¼š

1. ç¼–å†™ MBean æä¾›ç®¡ç†æ¥å£å’Œç›‘æ§æ•°æ®ã€‚

ç¬¬äºŒæ­¥æ³¨å†Œçš„è¿‡ç¨‹ç”± Spring è‡ªåŠ¨å®Œæˆã€‚æˆ‘ä»¬ä»¥å®é™…å·¥ç¨‹ä¸ºä¾‹ï¼Œé¦–å…ˆåœ¨ `AppConfig` ä¸­åŠ ä¸Š `@EnableMBeanExport` æ³¨è§£ï¼Œå‘Šè¯‰ Spring è‡ªåŠ¨æ³¨å†Œ MBeanï¼š

```
@Configuration
@ComponentScan
@EnableWebMvc
@EnableMBeanExport // è‡ªåŠ¨æ³¨å†Œ MBean
@EnableTransactionManagement
@PropertySource({"classpath:/jdbc.properties"})
public class AppConfig {
    ...
}
```

å‰©ä¸‹çš„å…¨éƒ¨å·¥ä½œå°±æ˜¯ç¼–å†™ MBeanã€‚æˆ‘ä»¬ä»¥å®é™…é—®é¢˜ä¸ºä¾‹ï¼Œå‡è®¾æˆ‘ä»¬å¸Œæœ›ç»™åº”ç”¨ç¨‹åºæ·»åŠ ä¸€ä¸ª IP é»‘åå•åŠŸèƒ½ï¼Œå‡¡æ˜¯åœ¨é»‘åå•ä¸­çš„ IP ç¦æ­¢è®¿é—®ï¼Œä¼ ç»Ÿçš„åšæ³•æ˜¯å®šä¹‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨çš„æ—¶å€™è¯»å–ï¼š

```
## ğŸ€ blacklist.txt
1.2.3.4
5.6.7.8
2.2.3.4
...
```

å¦‚æœè¦ä¿®æ”¹é»‘åå•æ€ä¹ˆåŠï¼Ÿä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œç„¶åé‡å¯åº”ç”¨ç¨‹åºã€‚

ä½†æ˜¯æ¯æ¬¡éƒ½é‡å¯åº”ç”¨ç¨‹åºå®åœ¨æ˜¯å¤ªéº»çƒ¦äº†ï¼Œèƒ½ä¸èƒ½ä¸é‡å¯åº”ç”¨ç¨‹åºï¼Ÿå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªå®šæ—¶è¯»å–é…ç½®æ–‡ä»¶çš„åŠŸèƒ½ï¼Œæ£€æµ‹åˆ°æ–‡ä»¶æ”¹åŠ¨æ—¶è‡ªåŠ¨é‡æ–°è¯»å–ã€‚

ä¸Šè¿°éœ€æ±‚æœ¬è´¨ä¸Šæ˜¯åœ¨åº”ç”¨ç¨‹åºè¿è¡ŒæœŸé—´å¯¹å‚æ•°ã€é…ç½®ç­‰è¿›è¡Œçƒ­æ›´æ–°å¹¶è¦æ±‚å°½å¿«ç”Ÿæ•ˆã€‚å¦‚æœä»¥ JMX çš„æ–¹å¼å®ç°ï¼Œæˆ‘ä»¬ä¸å¿…è‡ªå·±ç¼–å†™è‡ªåŠ¨é‡æ–°è¯»å–ç­‰ä»»ä½•ä»£ç ï¼Œåªéœ€è¦æä¾›ä¸€ä¸ªç¬¦åˆ JMX æ ‡å‡†çš„ MBean æ¥å­˜å‚¨é…ç½®å³å¯ã€‚

è¿˜æ˜¯ä»¥ IP é»‘åå•ä¸ºä¾‹ï¼ŒJMX çš„ MBean é€šå¸¸ä»¥ MBean ç»“å°¾ï¼Œå› æ­¤æˆ‘ä»¬éµå¾ªæ ‡å‡†å‘½åè§„èŒƒï¼Œé¦–å…ˆç¼–å†™ä¸€ä¸ª `BlacklistMBean`ï¼š

```
public class BlacklistMBean {
    private Set<String> ips = new HashSet<>();

    public String[] getBlacklist() {
        return ips.toArray(String[]::new);
    }

    public void addBlacklist(String ip) {
        ips.add(ip);
    }

    public void removeBlacklist(String ip) {
        ips.remove(ip);
    }

    public boolean shouldBlock(String ip) {
        return ips.contains(ip);
    }
}
```

è¿™ä¸ª MBean æ²¡ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œå®ƒçš„é€»è¾‘å’Œæ™®é€š Java ç±»æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨ JMX çš„å®¢æˆ·ç«¯æ¥å®æ—¶çƒ­æ›´æ–°è¿™ä¸ª MBeanï¼Œæ‰€ä»¥è¦ç»™å®ƒåŠ ä¸Šä¸€äº›æ³¨è§£ï¼Œè®© Spring èƒ½æ ¹æ®æ³¨è§£è‡ªåŠ¨æŠŠç›¸å…³æ–¹æ³•æ³¨å†Œåˆ° MBeanServer ä¸­ï¼š

```java
@Component
@ManagedResource(objectName = "sample:name=blacklist", description = "Blacklist of IP addresses")
public class BlacklistMBean {
    private Set<String> ips = new HashSet<>();

    @ManagedAttribute(description = "Get IP addresses in blacklist")
    public String[] getBlacklist() {
        return ips.toArray(String[]::new);
    }

    @ManagedOperation
    @ManagedOperationParameter(name = "ip", description = "Target IP address that will be added to blacklist")
    public void addBlacklist(String ip) {
        ips.add(ip);
    }

    @ManagedOperation
    @ManagedOperationParameter(name = "ip", description = "Target IP address that will be removed from blacklist")
    public void removeBlacklist(String ip) {
        ips.remove(ip);
    }

    public boolean shouldBlock(String ip) {
        return ips.contains(ip);
    }
}
```

è§‚å¯Ÿä¸Šè¿°ä»£ç ï¼Œ`BlacklistMBean` é¦–å…ˆæ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Spring ç®¡ç†çš„ Beanï¼Œå…¶æ¬¡ï¼Œæ·»åŠ äº† `@ManagedResource` è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª MBeanï¼Œå°†è¦è¢«æ³¨å†Œåˆ° JMXã€‚objectName æŒ‡å®šäº†è¿™ä¸ª MBean çš„åå­—ï¼Œé€šå¸¸ä»¥ `company:name=Xxx` æ¥åˆ†ç±» MBeanã€‚

å¯¹äºå±æ€§ï¼Œä½¿ç”¨ `@ManagedAttribute` æ³¨è§£æ ‡æ³¨ã€‚ä¸Šè¿° MBean åªæœ‰ get å±æ€§ï¼Œæ²¡æœ‰ set å±æ€§ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªåªè¯»å±æ€§ã€‚

å¯¹äºæ“ä½œï¼Œä½¿ç”¨ `@ManagedOperation` æ³¨è§£æ ‡å‡†ã€‚ä¸Šè¿° MBean å®šä¹‰äº†ä¸¤ä¸ªæ“ä½œï¼š`addBlacklist()` å’Œ `removeBlacklist()`ï¼Œå…¶ä»–æ–¹æ³•å¦‚ `shouldBlock()` ä¸ä¼šè¢«æš´éœ²ç»™ JMXã€‚

ä½¿ç”¨ MBean å’Œæ™®é€š Bean æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ `BlacklistInterceptor` å¯¹ IP è¿›è¡Œé»‘åå•æ‹¦æˆªï¼š

```
@Order(1)
@Component
public class BlacklistInterceptor implements HandlerInterceptor {
    final Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    BlacklistMBean blacklistMBean;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
            throws Exception {
        String ip = request.getRemoteAddr();
        logger.info("check ip address {}...", ip);
        // æ˜¯å¦åœ¨é»‘åå•ä¸­:
        if (blacklistMBean.shouldBlock(ip)) {
            logger.warn("will block ip {} for it is in blacklist.", ip);
            // å‘é€ 403 é”™è¯¯å“åº”:
            response.sendError(403);
            return false;
        }
        return true;
    }
}
```

ä¸‹ä¸€æ­¥å°±æ˜¯æ­£å¸¸å¯åŠ¨ Web åº”ç”¨ç¨‹åºï¼Œä¸è¦å…³é—­å®ƒï¼Œæˆ‘ä»¬æ‰“å¼€å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¾“å…¥ `jconsole` å¯åŠ¨ JavaSE è‡ªå¸¦çš„ä¸€ä¸ª JMX å®¢æˆ·ç«¯ç¨‹åºï¼š

![jconsole](./assets/l-20231221154625091.png)

é€šè¿‡ jconsole è¿æ¥åˆ°ä¸€ä¸ª Java è¿›ç¨‹æœ€ç®€å•çš„æ–¹æ³•æ˜¯ç›´æ¥åœ¨ Local Process ä¸­æ‰¾åˆ°æ­£åœ¨è¿è¡Œçš„ `AppConfig`ï¼Œç‚¹å‡» Connect å³å¯è¿æ¥åˆ°æˆ‘ä»¬å½“å‰æ­£åœ¨è¿è¡Œçš„ Web åº”ç”¨ï¼Œåœ¨ jconsole ä¸­å¯ç›´æ¥çœ‹åˆ°å†…å­˜ã€CPU ç­‰èµ„æºçš„ç›‘æ§ã€‚

æˆ‘ä»¬ç‚¹å‡» MBeanï¼Œå·¦ä¾§æŒ‰åˆ†ç±»åˆ—å‡ºæ‰€æœ‰ MBeanï¼Œå¯ä»¥åœ¨ `java.lang` æŸ¥çœ‹å†…å­˜ç­‰ä¿¡æ¯ï¼š

![mbean](./assets/l-20231221154624489.png)

ç»†å¿ƒçš„ç«¥é‹å¯ä»¥çœ‹åˆ° HikariCP è¿æ¥æ± ä¹Ÿæ˜¯é€šè¿‡ JMX ç›‘æ§çš„ã€‚

åœ¨ `sample` ä¸­å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è‡ªå·±çš„ MBeanï¼Œç‚¹å‡»å¯æŸ¥çœ‹å±æ€§ `blacklist`ï¼š

![mbean-value](./assets/l-20231221154624050.png)

ç‚¹å‡» `Operations`-`addBlacklist`ï¼Œå¯ä»¥å¡«å…¥ `127.0.0.1` å¹¶ç‚¹å‡» `addBlacklist` æŒ‰é’®ï¼Œç›¸å½“äº jconsole é€šè¿‡ JMX æ¥å£ï¼Œè°ƒç”¨äº†æˆ‘ä»¬è‡ªå·±çš„ `BlacklistMBean` çš„ `addBlacklist()` æ–¹æ³•ï¼Œä¼ å…¥çš„å‚æ•°å°±æ˜¯å¡«å…¥çš„ `127.0.0.1`ï¼š

![mbean-invoke-ok](./assets/l-20231221154624316.png)

å†æ¬¡æŸ¥çœ‹å±æ€§ `blacklist`ï¼Œå¯ä»¥çœ‹åˆ°ç»“æœå·²ç»æ›´æ–°äº†ï¼š

![mbean-modified](./assets/l-20231221154623976.png)

æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ä¸€ä¸‹é»‘åå•åŠŸèƒ½æ˜¯å¦å·²ç”Ÿæ•ˆï¼š

![403](./assets/l-20231221154624767.png)

å¯è§ï¼Œ`127.0.0.1` ç¡®å®è¢«æ·»åŠ åˆ°äº†é»‘åå•ï¼Œåå°æ—¥å¿—æ‰“å°å¦‚ä¸‹ï¼š

```
2020-06-06 20:22:12 INFO  c.i.l.web.BlacklistInterceptor - check ip address 127.0.0.1...
2020-06-06 20:22:12 WARN  c.i.l.web.BlacklistInterceptor - will block ip 127.0.0.1 for it is in blacklist.
```

æ³¨æ„ï¼šå¦‚æœä½¿ç”¨ IPv6ï¼Œé‚£ä¹ˆéœ€è¦æŠŠ `0:0:0:0:0:0:0:1` è¿™ä¸ªæœ¬æœºåœ°å€åŠ åˆ°é»‘åå•ã€‚

å¦‚æœä» jconsole ä¸­è°ƒç”¨ `removeBlacklist` ç§»é™¤ `127.0.0.1`ï¼Œåˆ·æ–°æµè§ˆå™¨å¯ä»¥çœ‹åˆ°åˆå…è®¸è®¿é—®äº†ã€‚

ä½¿ç”¨ jconsole ç›´æ¥é€šè¿‡ Local Process è¿æ¥ JVM æœ‰ä¸ªé™åˆ¶ï¼Œå°±æ˜¯ jconsole å’Œæ­£åœ¨è¿è¡Œçš„ JVM å¿…é¡»åœ¨åŒä¸€å°æœºå™¨ã€‚å¦‚æœè¦è¿œç¨‹è¿æ¥ï¼Œé¦–å…ˆè¦æ‰“å¼€ JMX ç«¯å£ã€‚æˆ‘ä»¬åœ¨å¯åŠ¨ `AppConfig` æ—¶ï¼Œéœ€è¦ä¼ å…¥ä»¥ä¸‹ JVM å¯åŠ¨å‚æ•°ï¼š

- -Dcom.sun.management.jmxremote.port=19999
- -Dcom.sun.management.jmxremote.authenticate=false
- -Dcom.sun.management.jmxremote.ssl=false

ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºåœ¨ 19999 ç«¯å£ç›‘å¬ JMX è¿æ¥ï¼Œç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°è¡¨ç¤ºæ— éœ€éªŒè¯ï¼Œä¸ä½¿ç”¨ SSL è¿æ¥ï¼Œåœ¨å¼€å‘æµ‹è¯•é˜¶æ®µæ¯”è¾ƒæ–¹ä¾¿ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»æŒ‡å®šéªŒè¯æ–¹å¼å¹¶å¯ç”¨ SSLã€‚è¯¦ç»†å‚æ•°å¯å‚è€ƒ Oracle[å®˜æ–¹æ–‡æ¡£](https://docs.oracle.com/javase/8/docs/technotes/guides/management/agent.html#gdeum)ã€‚è¿™æ · jconsole å¯ä»¥ç”¨ `ip:19999` çš„è¿œç¨‹æ–¹å¼è¿æ¥ JMXã€‚è¿æ¥åçš„æ“ä½œæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚

è®¸å¤š JavaEE æœåŠ¡å™¨å¦‚ JBoss çš„ç®¡ç†åå°éƒ½æ˜¯é€šè¿‡ JMX æä¾›ç®¡ç†æ¥å£ï¼Œå¹¶ç”± Web æ–¹å¼è®¿é—®ï¼Œå¯¹ç”¨æˆ·æ›´åŠ å‹å¥½ã€‚

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œé€šè¿‡ JMX å®ç°é…ç½®çš„å®æ—¶æ›´æ–°å…¶å®å¹¶ä¸å¸¸ç”¨ï¼ŒJMX æ›´å¤šåœ°ç”¨äºæ”¶é›† JVM çš„è¿è¡ŒçŠ¶æ€å’Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½æ•°æ®ï¼Œç„¶åé€šè¿‡ç›‘æ§æœåŠ¡å™¨æ±‡æ€»æ•°æ®åå®ç°ç›‘æ§ä¸æŠ¥è­¦ã€‚ä¸€ä¸ªå…¸å‹çš„ç›‘æ§ç³»ç»Ÿæ¶æ„å¦‚ä¸‹ï¼š

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web Console  â”‚â—€â”€â”€â”‚Metrics Server â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚
   â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”‚â”€ â”€ â”
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
   â”‚ â”‚      App      â”‚      â”‚    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¤   â”Œâ”€â”€â”€â”€â”€â”
   â”‚ â”‚         â”‚ JMX â”‚â”€â”€â–¶â”‚Agentâ”‚ â”‚
     â”‚         â””â”€â”€â”€â”€â”€â”¤   â””â”€â”€â”€â”€â”€â”˜
   â”‚ â”‚      JVM      â”‚           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
```

å…¶ä¸­ï¼ŒApp è‡ªèº«å’Œ JVM çš„çš„ç»Ÿè®¡æ•°æ®éƒ½é€šè¿‡ JMX æ”¶é›†å¹¶å‘é€ç»™æœ¬æœºçš„ä¸€ä¸ª Agentï¼ŒAgent å†å°†æ•°æ®å‘é€è‡³ç›‘æ§æœåŠ¡å™¨ï¼Œæœ€åä»¥å¯è§†åŒ–çš„å½¢å¼å°†ç›‘æ§æ•°æ®é€šè¿‡ Web ç­‰å½¢å¼å±•ç¤ºç»™ç”¨æˆ·ã€‚å¸¸ç”¨çš„ç›‘æ§ç³»ç»Ÿæœ‰å¼€æºçš„ [Prometheus](https://prometheus.io/) å’Œä»¥äº‘æœåŠ¡æ–¹å¼æä¾›çš„ [DataDog](https://www.datadoghq.com/) ç­‰ã€‚

### ç»ƒä¹ 

ç¼–å†™ä¸€ä¸ª MBean ç»Ÿè®¡å½“å‰æ³¨å†Œç”¨æˆ·æ•°é‡ï¼Œå¹¶åœ¨ jconsole ä¸­æŸ¥çœ‹ï¼š


### å°ç»“

åœ¨ Spring ä¸­ä½¿ç”¨ JMX éœ€è¦ï¼š

- é€šè¿‡ `@EnableMBeanExport` å¯ç”¨è‡ªåŠ¨æ³¨å†Œ MBeanï¼›
- ç¼–å†™ MBean å¹¶å®ç°ç®¡ç†å±æ€§å’Œç®¡ç†æ“ä½œã€‚




