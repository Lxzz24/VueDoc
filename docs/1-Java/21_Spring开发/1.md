---
title: IoC å®¹å™¨
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

åœ¨å­¦ä¹  Spring æ¡†æ¶æ—¶ï¼Œæˆ‘ä»¬é‡åˆ°çš„ç¬¬ä¸€ä¸ªä¹Ÿæ˜¯æœ€æ ¸å¿ƒçš„æ¦‚å¿µå°±æ˜¯å®¹å™¨ã€‚

ä»€ä¹ˆæ˜¯å®¹å™¨ï¼Ÿå®¹å™¨æ˜¯ä¸€ç§ä¸ºæŸç§ç‰¹å®šç»„ä»¶çš„è¿è¡Œæä¾›å¿…è¦æ”¯æŒçš„ä¸€ä¸ªè½¯ä»¶ç¯å¢ƒã€‚ä¾‹å¦‚ï¼ŒTomcat å°±æ˜¯ä¸€ä¸ª Servlet å®¹å™¨ï¼Œå®ƒå¯ä»¥ä¸º Servlet çš„è¿è¡Œæä¾›è¿è¡Œç¯å¢ƒã€‚ç±»ä¼¼ Docker è¿™æ ·çš„è½¯ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå®ƒæä¾›äº†å¿…è¦çš„ Linux ç¯å¢ƒä»¥ä¾¿è¿è¡Œä¸€ä¸ªç‰¹å®šçš„ Linux è¿›ç¨‹ã€‚

é€šå¸¸æ¥è¯´ï¼Œä½¿ç”¨å®¹å™¨è¿è¡Œç»„ä»¶ï¼Œé™¤äº†æä¾›ä¸€ä¸ªç»„ä»¶è¿è¡Œç¯å¢ƒä¹‹å¤–ï¼Œå®¹å™¨è¿˜æä¾›äº†è®¸å¤šåº•å±‚æœåŠ¡ã€‚ä¾‹å¦‚ï¼ŒServlet å®¹å™¨åº•å±‚å®ç°äº† TCP è¿æ¥ï¼Œè§£æ HTTP åè®®ç­‰éå¸¸å¤æ‚çš„æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰å®¹å™¨æ¥æä¾›è¿™äº›æœåŠ¡ï¼Œæˆ‘ä»¬å°±æ— æ³•ç¼–å†™åƒ Servlet è¿™æ ·ä»£ç ç®€å•ï¼ŒåŠŸèƒ½å¼ºå¤§çš„ç»„ä»¶ã€‚æ—©æœŸçš„ JavaEE æœåŠ¡å™¨æä¾›çš„ EJB å®¹å™¨æœ€é‡è¦çš„åŠŸèƒ½å°±æ˜¯é€šè¿‡å£°æ˜å¼äº‹åŠ¡æœåŠ¡ï¼Œä½¿å¾— EJB ç»„ä»¶çš„å¼€å‘äººå‘˜ä¸å¿…è‡ªå·±ç¼–å†™å†—é•¿çš„äº‹åŠ¡å¤„ç†ä»£ç ï¼Œæ‰€ä»¥æå¤§åœ°ç®€åŒ–äº†äº‹åŠ¡å¤„ç†ã€‚

Spring çš„æ ¸å¿ƒå°±æ˜¯æä¾›äº†ä¸€ä¸ª IoC å®¹å™¨ï¼Œå®ƒå¯ä»¥ç®¡ç†æ‰€æœ‰è½»é‡çº§çš„ JavaBean ç»„ä»¶ï¼Œæä¾›çš„åº•å±‚æœåŠ¡åŒ…æ‹¬ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€é…ç½®å’Œç»„è£…æœåŠ¡ã€AOP æ”¯æŒï¼Œä»¥åŠå»ºç«‹åœ¨ AOP åŸºç¡€ä¸Šçš„å£°æ˜å¼äº‹åŠ¡æœåŠ¡ç­‰ã€‚

æœ¬ç« æˆ‘ä»¬è®¨è®ºçš„ IoC å®¹å™¨ï¼Œä¸»è¦ä»‹ç» Spring å®¹å™¨å¦‚ä½•å¯¹ç»„ä»¶è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œé…ç½®ç»„è£…æœåŠ¡ã€‚



## ğŸ€ IoC åŸç†


Spring æä¾›çš„å®¹å™¨åˆç§°ä¸º IoC å®¹å™¨ï¼Œä»€ä¹ˆæ˜¯ IoCï¼Ÿ

IoC å…¨ç§° Inversion of Controlï¼Œç›´è¯‘ä¸ºæ§åˆ¶åè½¬ã€‚é‚£ä¹ˆä½•è°“ IoCï¼Ÿåœ¨ç†è§£ IoC ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹é€šå¸¸çš„ Java ç»„ä»¶æ˜¯å¦‚ä½•åä½œçš„ã€‚

æˆ‘ä»¬å‡å®šä¸€ä¸ªåœ¨çº¿ä¹¦åº—ï¼Œé€šè¿‡ `BookService` è·å–ä¹¦ç±ï¼š

```java
public class BookService {
    private HikariConfig config = new HikariConfig();
    private DataSource dataSource = new HikariDataSource(config);

    public Book getBook(long bookId) {
        try (Connection conn = dataSource.getConnection()) {
            ...
            return book;
        }
    }
}
```

ä¸ºäº†ä»æ•°æ®åº“æŸ¥è¯¢ä¹¦ç±ï¼Œ`BookService` æŒæœ‰ä¸€ä¸ª `DataSource`ã€‚ä¸ºäº†å®ä¾‹åŒ–ä¸€ä¸ª `HikariDataSource`ï¼Œåˆä¸å¾—ä¸å®ä¾‹åŒ–ä¸€ä¸ª `HikariConfig`ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬ç»§ç»­ç¼–å†™ `UserService` è·å–ç”¨æˆ·ï¼š

```java
public class UserService {
    private HikariConfig config = new HikariConfig();
    private DataSource dataSource = new HikariDataSource(config);

    public User getUser(long userId) {
        try (Connection conn = dataSource.getConnection()) {
            ...
            return user;
        }
    }
}
```

å› ä¸º `UserService` ä¹Ÿéœ€è¦è®¿é—®æ•°æ®åº“ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¸å¾—ä¸ä¹Ÿå®ä¾‹åŒ–ä¸€ä¸ª `HikariDataSource`ã€‚

åœ¨å¤„ç†ç”¨æˆ·è´­ä¹°çš„ `CartServlet` ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ä¾‹åŒ– `UserService` å’Œ `BookService`ï¼š

```java
public class CartServlet extends HttpServlet {
    private BookService bookService = new BookService();
    private UserService userService = new UserService();

    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        long currentUserId = getFromCookie(req);
        User currentUser = userService.getUser(currentUserId);
        Book book = bookService.getBook(req.getParameter("bookId"));
        cartService.addToCart(currentUser, book);
        ...
    }
}
```

ç±»ä¼¼çš„ï¼Œåœ¨è´­ä¹°å†å² `HistoryServlet` ä¸­ï¼Œä¹Ÿéœ€è¦å®ä¾‹åŒ– `UserService` å’Œ `BookService`ï¼š

```java
public class HistoryServlet extends HttpServlet {
    private BookService bookService = new BookService();
    private UserService userService = new UserService();
}
```

ä¸Šè¿°æ¯ä¸ªç»„ä»¶éƒ½é‡‡ç”¨äº†ä¸€ç§ç®€å•çš„é€šè¿‡ `new` åˆ›å»ºå®ä¾‹å¹¶æŒæœ‰çš„æ–¹å¼ã€‚ä»”ç»†è§‚å¯Ÿï¼Œä¼šå‘ç°ä»¥ä¸‹ç¼ºç‚¹ï¼š


1. å®ä¾‹åŒ–ä¸€ä¸ªç»„ä»¶å…¶å®å¾ˆéš¾ï¼Œä¾‹å¦‚ï¼Œ`BookService` å’Œ `UserService` è¦åˆ›å»º `HikariDataSource`ï¼Œå®é™…ä¸Šéœ€è¦è¯»å–é…ç½®ï¼Œæ‰èƒ½å…ˆå®ä¾‹åŒ– `HikariConfig`ï¼Œå†å®ä¾‹åŒ– `HikariDataSource`ã€‚
2. æ²¡æœ‰å¿…è¦è®© `BookService` å’Œ `UserService` åˆ†åˆ«åˆ›å»º `DataSource` å®ä¾‹ï¼Œå®Œå…¨å¯ä»¥å…±äº«åŒä¸€ä¸ª `DataSource`ï¼Œä½†è°è´Ÿè´£åˆ›å»º `DataSource`ï¼Œè°è´Ÿè´£è·å–å…¶ä»–ç»„ä»¶å·²ç»åˆ›å»ºçš„ `DataSource`ï¼Œä¸å¥½å¤„ç†ã€‚ç±»ä¼¼çš„ï¼Œ`CartServlet` å’Œ `HistoryServlet` ä¹Ÿåº”å½“å…±äº« `BookService` å®ä¾‹å’Œ `UserService` å®ä¾‹ï¼Œä½†ä¹Ÿä¸å¥½å¤„ç†ã€‚
3. å¾ˆå¤šç»„ä»¶éœ€è¦é”€æ¯ä»¥ä¾¿é‡Šæ”¾èµ„æºï¼Œä¾‹å¦‚ `DataSource`ï¼Œä½†å¦‚æœè¯¥ç»„ä»¶è¢«å¤šä¸ªç»„ä»¶å…±äº«ï¼Œå¦‚ä½•ç¡®ä¿å®ƒçš„ä½¿ç”¨æ–¹éƒ½å·²ç»å…¨éƒ¨è¢«é”€æ¯ï¼Ÿ
4. éšç€æ›´å¤šçš„ç»„ä»¶è¢«å¼•å…¥ï¼Œä¾‹å¦‚ï¼Œä¹¦ç±è¯„è®ºï¼Œéœ€è¦å…±äº«çš„ç»„ä»¶å†™èµ·æ¥ä¼šæ›´å›°éš¾ï¼Œè¿™äº›ç»„ä»¶çš„ä¾èµ–å…³ç³»ä¼šè¶Šæ¥è¶Šå¤æ‚ã€‚
5. æµ‹è¯•æŸä¸ªç»„ä»¶ï¼Œä¾‹å¦‚ `BookService`ï¼Œæ˜¯å¤æ‚çš„ï¼Œå› ä¸ºå¿…é¡»è¦åœ¨çœŸå®çš„æ•°æ®åº“ç¯å¢ƒä¸‹æ‰§è¡Œã€‚

ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä¸€ä¸ªç³»ç»Ÿæœ‰å¤§é‡çš„ç»„ä»¶ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸå’Œç›¸äº’ä¹‹é—´çš„ä¾èµ–å…³ç³»å¦‚æœç”±ç»„ä»¶è‡ªèº«æ¥ç»´æŠ¤ï¼Œä¸ä½†å¤§å¤§å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œè€Œä¸”ä¼šå¯¼è‡´ç»„ä»¶ä¹‹é—´æä¸ºç´§å¯†çš„è€¦åˆï¼Œç»§è€Œç»™æµ‹è¯•å’Œç»´æŠ¤å¸¦æ¥äº†æå¤§çš„å›°éš¾ã€‚

å› æ­¤ï¼Œæ ¸å¿ƒé—®é¢˜æ˜¯ï¼š

1. è°è´Ÿè´£åˆ›å»ºç»„ä»¶ï¼Ÿ
2. è°è´Ÿè´£æ ¹æ®ä¾èµ–å…³ç³»ç»„è£…ç»„ä»¶ï¼Ÿ
3. é”€æ¯æ—¶ï¼Œå¦‚ä½•æŒ‰ä¾èµ–é¡ºåºæ­£ç¡®é”€æ¯ï¼Ÿ

è§£å†³è¿™ä¸€é—®é¢˜çš„æ ¸å¿ƒæ–¹æ¡ˆå°±æ˜¯ IoCã€‚

ä¼ ç»Ÿçš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ§åˆ¶æƒåœ¨ç¨‹åºæœ¬èº«ï¼Œç¨‹åºçš„æ§åˆ¶æµç¨‹å®Œå…¨ç”±å¼€å‘è€…æ§åˆ¶ï¼Œä¾‹å¦‚ï¼š

`CartServlet` åˆ›å»ºäº† `BookService`ï¼Œåœ¨åˆ›å»º `BookService` çš„è¿‡ç¨‹ä¸­ï¼Œåˆåˆ›å»ºäº† `DataSource` ç»„ä»¶ã€‚è¿™ç§æ¨¡å¼çš„ç¼ºç‚¹æ˜¯ï¼Œä¸€ä¸ªç»„ä»¶å¦‚æœè¦ä½¿ç”¨å¦ä¸€ä¸ªç»„ä»¶ï¼Œå¿…é¡»å…ˆçŸ¥é“å¦‚ä½•æ­£ç¡®åœ°åˆ›å»ºå®ƒã€‚

åœ¨ IoC æ¨¡å¼ä¸‹ï¼Œæ§åˆ¶æƒå‘ç”Ÿäº†åè½¬ï¼Œå³ä»åº”ç”¨ç¨‹åºè½¬ç§»åˆ°äº† IoC å®¹å™¨ï¼Œæ‰€æœ‰ç»„ä»¶ä¸å†ç”±åº”ç”¨ç¨‹åºè‡ªå·±åˆ›å»ºå’Œé…ç½®ï¼Œè€Œæ˜¯ç”± IoC å®¹å™¨è´Ÿè´£ï¼Œè¿™æ ·ï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦ç›´æ¥ä½¿ç”¨å·²ç»åˆ›å»ºå¥½å¹¶ä¸”é…ç½®å¥½çš„ç»„ä»¶ã€‚ä¸ºäº†èƒ½è®©ç»„ä»¶åœ¨ IoC å®¹å™¨ä¸­è¢« â€œè£…é…â€ å‡ºæ¥ï¼Œéœ€è¦æŸç§ â€œæ³¨å…¥â€ æœºåˆ¶ï¼Œä¾‹å¦‚ï¼Œ`BookService` è‡ªå·±å¹¶ä¸ä¼šåˆ›å»º `DataSource`ï¼Œè€Œæ˜¯ç­‰å¾…å¤–éƒ¨é€šè¿‡ `setDataSource()` æ–¹æ³•æ¥æ³¨å…¥ä¸€ä¸ª `DataSource`ï¼š

```java
public class BookService {
    private DataSource dataSource;

    public void setDataSource(DataSource dataSource) {
        this.dataSource = dataSource;
    }
}
```

ä¸ç›´æ¥ `new` ä¸€ä¸ª `DataSource`ï¼Œè€Œæ˜¯æ³¨å…¥ä¸€ä¸ª `DataSource`ï¼Œè¿™ä¸ªå°å°çš„æ”¹åŠ¨è™½ç„¶ç®€å•ï¼Œå´å¸¦æ¥äº†ä¸€ç³»åˆ—å¥½å¤„ï¼š

1. `BookService` ä¸å†å…³å¿ƒå¦‚ä½•åˆ›å»º `DataSource`ï¼Œå› æ­¤ï¼Œä¸å¿…ç¼–å†™è¯»å–æ•°æ®åº“é…ç½®ä¹‹ç±»çš„ä»£ç ï¼›
2. `DataSource` å®ä¾‹è¢«æ³¨å…¥åˆ° `BookService`ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥æ³¨å…¥åˆ° `UserService`ï¼Œå› æ­¤ï¼Œå…±äº«ä¸€ä¸ªç»„ä»¶éå¸¸ç®€å•ï¼›
3. æµ‹è¯• `BookService` æ›´å®¹æ˜“ï¼Œå› ä¸ºæ³¨å…¥çš„æ˜¯ `DataSource`ï¼Œå¯ä»¥ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼Œè€Œä¸æ˜¯çœŸå®çš„ MySQL é…ç½®ã€‚

å› æ­¤ï¼ŒIoC åˆç§°ä¸ºä¾èµ–æ³¨å…¥ï¼ˆDIï¼šDependency Injectionï¼‰ï¼Œå®ƒè§£å†³äº†ä¸€ä¸ªæœ€ä¸»è¦çš„é—®é¢˜ï¼šå°†ç»„ä»¶çš„åˆ›å»º + é…ç½®ä¸ç»„ä»¶çš„ä½¿ç”¨ç›¸åˆ†ç¦»ï¼Œå¹¶ä¸”ï¼Œç”± IoC å®¹å™¨è´Ÿè´£ç®¡ç†ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚

å› ä¸º IoC å®¹å™¨è¦è´Ÿè´£å®ä¾‹åŒ–æ‰€æœ‰çš„ç»„ä»¶ï¼Œå› æ­¤ï¼Œæœ‰å¿…è¦å‘Šè¯‰å®¹å™¨å¦‚ä½•åˆ›å»ºç»„ä»¶ï¼Œä»¥åŠå„ç»„ä»¶çš„ä¾èµ–å…³ç³»ã€‚ä¸€ç§æœ€ç®€å•çš„é…ç½®æ˜¯é€šè¿‡ XML æ–‡ä»¶æ¥å®ç°ï¼Œä¾‹å¦‚ï¼š

```xml
<beans>
    <bean id="dataSource" class="HikariDataSource" />
    <bean id="bookService" class="BookService">
        <property name="dataSource" ref="dataSource" />
    </bean>
    <bean id="userService" class="UserService">
        <property name="dataSource" ref="dataSource" />
    </bean>
</beans>
```

ä¸Šè¿° XML é…ç½®æ–‡ä»¶æŒ‡ç¤º IoC å®¹å™¨åˆ›å»º 3 ä¸ª JavaBean ç»„ä»¶ï¼Œå¹¶æŠŠ id ä¸º `dataSource` çš„ç»„ä»¶é€šè¿‡å±æ€§ `dataSource`ï¼ˆå³è°ƒç”¨ `setDataSource()` æ–¹æ³•ï¼‰æ³¨å…¥åˆ°å¦å¤–ä¸¤ä¸ªç»„ä»¶ä¸­ã€‚

åœ¨ Spring çš„ IoC å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰ç»„ä»¶ç»Ÿç§°ä¸º JavaBeanï¼Œå³é…ç½®ä¸€ä¸ªç»„ä»¶å°±æ˜¯é…ç½®ä¸€ä¸ª Beanã€‚

### ä¾èµ–æ³¨å…¥æ–¹å¼

æˆ‘ä»¬ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œä¾èµ–æ³¨å…¥å¯ä»¥é€šè¿‡ `set()` æ–¹æ³•å®ç°ã€‚ä½†ä¾èµ–æ³¨å…¥ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•å®ç°ã€‚

å¾ˆå¤š Java ç±»éƒ½å…·æœ‰å¸¦å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬æŠŠ `BookService` æ”¹é€ ä¸ºé€šè¿‡æ„é€ æ–¹æ³•æ³¨å…¥ï¼Œé‚£ä¹ˆå®ç°ä»£ç å¦‚ä¸‹ï¼š

```java
public class BookService {
    private DataSource dataSource;

    public BookService(DataSource dataSource) {
        this.dataSource = dataSource;
    }
}
```

Spring çš„ IoC å®¹å™¨åŒæ—¶æ”¯æŒå±æ€§æ³¨å…¥å’Œæ„é€ æ–¹æ³•æ³¨å…¥ï¼Œå¹¶å…è®¸æ··åˆä½¿ç”¨ã€‚

### æ— ä¾µå…¥å®¹å™¨

åœ¨è®¾è®¡ä¸Šï¼ŒSpring çš„ IoC å®¹å™¨æ˜¯ä¸€ä¸ªé«˜åº¦å¯æ‰©å±•çš„æ— ä¾µå…¥å®¹å™¨ã€‚æ‰€è°“æ— ä¾µå…¥ï¼Œæ˜¯æŒ‡åº”ç”¨ç¨‹åºçš„ç»„ä»¶æ— éœ€å®ç° Spring çš„ç‰¹å®šæ¥å£ï¼Œæˆ–è€…è¯´ï¼Œç»„ä»¶æ ¹æœ¬ä¸çŸ¥é“è‡ªå·±åœ¨ Spring çš„å®¹å™¨ä¸­è¿è¡Œã€‚è¿™ç§æ— ä¾µå…¥çš„è®¾è®¡æœ‰ä»¥ä¸‹å¥½å¤„ï¼š

1. åº”ç”¨ç¨‹åºç»„ä»¶æ—¢å¯ä»¥åœ¨ Spring çš„ IoC å®¹å™¨ä¸­è¿è¡Œï¼Œä¹Ÿå¯ä»¥è‡ªå·±ç¼–å†™ä»£ç è‡ªè¡Œç»„è£…é…ç½®ï¼›
2. æµ‹è¯•çš„æ—¶å€™å¹¶ä¸ä¾èµ– Spring å®¹å™¨ï¼Œå¯å•ç‹¬è¿›è¡Œæµ‹è¯•ï¼Œå¤§å¤§æé«˜äº†å¼€å‘æ•ˆç‡ã€‚



## ğŸ€ è£…é… Bean


æˆ‘ä»¬å‰é¢è®¨è®ºäº†ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Spring çš„ IoC å®¹å™¨ï¼Œå› ä¸ºè®©å®¹å™¨æ¥ä¸ºæˆ‘ä»¬åˆ›å»ºå¹¶è£…é… Bean èƒ½è·å¾—å¾ˆå¤§çš„å¥½å¤„ï¼Œé‚£ä¹ˆåˆ°åº•å¦‚ä½•ä½¿ç”¨ IoC å®¹å™¨ï¼Ÿè£…é…å¥½çš„ Bean åˆå¦‚ä½•ä½¿ç”¨ï¼Ÿ

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ç”¨æˆ·æ³¨å†Œç™»å½•çš„ä¾‹å­ã€‚æ•´ä¸ªå·¥ç¨‹çš„ç»“æ„å¦‚ä¸‹ï¼š

![image-20231221141823078](./assets/image-20231221141823078.png)

é¦–å…ˆï¼Œæˆ‘ä»¬ç”¨ Maven åˆ›å»ºå·¥ç¨‹å¹¶å¼•å…¥ `spring-context` ä¾èµ–ï¼š

- org.springframework:spring-context:6.0.0

æˆ‘ä»¬å…ˆç¼–å†™ä¸€ä¸ª `MailService`ï¼Œç”¨äºåœ¨ç”¨æˆ·ç™»å½•å’Œæ³¨å†ŒæˆåŠŸåå‘é€é‚®ä»¶é€šçŸ¥ï¼š

```java
public class MailService {
    private ZoneId zoneId = ZoneId.systemDefault();

    public void setZoneId(ZoneId zoneId) {
        this.zoneId = zoneId;
    }

    public String getTime() {
        return ZonedDateTime.now(this.zoneId).format(DateTimeFormatter.ISO_ZONED_DATE_TIME);
    }

    public void sendLoginMail(User user) {
        System.err.println(String.format("Hi, %s! You are logged in at %s", user.getName(), getTime()));
    }

    public void sendRegistrationMail(User user) {
        System.err.println(String.format("Welcome, %s!", user.getName()));

    }
}
```

å†ç¼–å†™ä¸€ä¸ª `UserService`ï¼Œå®ç°ç”¨æˆ·æ³¨å†Œå’Œç™»å½•ï¼š

```java
public class UserService {
    private MailService mailService;

    public void setMailService(MailService mailService) {
        this.mailService = mailService;
    }

    private List<User> users = new ArrayList<>(List.of( // users:
            new User(1, "bob@example.com", "password", "Bob"), // bob
            new User(2, "alice@example.com", "password", "Alice"), // alice
            new User(3, "tom@example.com", "password", "Tom"))); // tom

    public User login(String email, String password) {
        for (User user : users) {
            if (user.getEmail().equalsIgnoreCase(email) && user.getPassword().equals(password)) {
                mailService.sendLoginMail(user);
                return user;
            }
        }
        throw new RuntimeException("login failed.");
    }

    public User getUser(long id) {
        return this.users.stream().filter(user -> user.getId() == id).findFirst().orElseThrow();
    }

    public User register(String email, String password, String name) {
        users.forEach((user) -> {
            if (user.getEmail().equalsIgnoreCase(email)) {
                throw new RuntimeException("email exist.");
            }
        });
        User user = new User(users.stream().mapToLong(u -> u.getId()).max().getAsLong() + 1, email, password, name);
        users.add(user);
        mailService.sendRegistrationMail(user);
        return user;
    }
}
```

æ³¨æ„åˆ° `UserService` é€šè¿‡ `setMailService()` æ³¨å…¥äº†ä¸€ä¸ª `MailService`ã€‚

ç„¶åï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªç‰¹å®šçš„ `application.xml` é…ç½®æ–‡ä»¶ï¼Œå‘Šè¯‰ Spring çš„ IoC å®¹å™¨åº”è¯¥å¦‚ä½•åˆ›å»ºå¹¶ç»„è£… Beanï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="userService" class="com.itranswarp.learnjava.service.UserService">
        <property name="mailService" ref="mailService" />
    </bean>

    <bean id="mailService" class="com.itranswarp.learnjava.service.MailService" />
</beans>
```

æ³¨æ„è§‚å¯Ÿä¸Šè¿°é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­ä¸ XML Schema ç›¸å…³çš„éƒ¨åˆ†æ ¼å¼æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬åªå…³æ³¨ä¸¤ä¸ª `<bean ...>` çš„é…ç½®ï¼š

- æ¯ä¸ª `<bean ...>` éƒ½æœ‰ä¸€ä¸ª `id` æ ‡è¯†ï¼Œç›¸å½“äº Bean çš„å”¯ä¸€ IDï¼›
- åœ¨ `userService`Bean ä¸­ï¼Œé€šè¿‡ `<property name="..." ref="..." />` æ³¨å…¥äº†å¦ä¸€ä¸ª Beanï¼›
- Bean çš„é¡ºåºä¸é‡è¦ï¼ŒSpring æ ¹æ®ä¾èµ–å…³ç³»ä¼šè‡ªåŠ¨æ­£ç¡®åˆå§‹åŒ–ã€‚

æŠŠä¸Šè¿° XML é…ç½®æ–‡ä»¶ç”¨ Java ä»£ç å†™å‡ºæ¥ï¼Œå°±åƒè¿™æ ·ï¼š

```java
UserService userService = new UserService();
MailService mailService = new MailService();
userService.setMailService(mailService);
```

åªä¸è¿‡ Spring å®¹å™¨æ˜¯é€šè¿‡è¯»å– XML æ–‡ä»¶åä½¿ç”¨åå°„å®Œæˆçš„ã€‚

å¦‚æœæ³¨å…¥çš„ä¸æ˜¯ Beanï¼Œè€Œæ˜¯ `boolean`ã€`int`ã€`String` è¿™æ ·çš„æ•°æ®ç±»å‹ï¼Œåˆ™é€šè¿‡ `value` æ³¨å…¥ï¼Œä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ä¸ª `HikariDataSource`ï¼š

```xml
<bean id="dataSource" class="com.zaxxer.hikari.HikariDataSource">
    <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/test" />
    <property name="username" value="root" />
    <property name="password" value="password" />
    <property name="maximumPoolSize" value="10" />
    <property name="autoCommit" value="true" />
</bean>
```

æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª Spring çš„ IoC å®¹å™¨å®ä¾‹ï¼Œç„¶ååŠ è½½é…ç½®æ–‡ä»¶ï¼Œè®© Spring å®¹å™¨ä¸ºæˆ‘ä»¬åˆ›å»ºå¹¶è£…é…å¥½é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„æ‰€æœ‰ Beanï¼Œè¿™åªéœ€è¦ä¸€è¡Œä»£ç ï¼š

```java
ApplicationContext context = new ClassPathXmlApplicationContext("application.xml");
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä» Spring å®¹å™¨ä¸­ â€œå–å‡ºâ€ è£…é…å¥½çš„ Bean ç„¶åä½¿ç”¨å®ƒï¼š

```java
// è·å– Bean:
UserService userService = context.getBean(UserService.class);
// æ­£å¸¸è°ƒç”¨:
User user = userService.login("bob@example.com", "password");
```

å®Œæ•´çš„ `main()` æ–¹æ³•å¦‚ä¸‹ï¼š

```java
public class Main {
    public static void main(String[] args) {
        ApplicationContext context = new ClassPathXmlApplicationContext("application.xml");
        UserService userService = context.getBean(UserService.class);
        User user = userService.login("bob@example.com", "password");
        System.out.println(user.getName());
    }
}
```

### ApplicationContext

æˆ‘ä»¬ä»åˆ›å»º Spring å®¹å™¨çš„ä»£ç ï¼š

```java
ApplicationContext context = new ClassPathXmlApplicationContext("application.xml");
```

å¯ä»¥çœ‹åˆ°ï¼ŒSpring å®¹å™¨å°±æ˜¯ `ApplicationContext`ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰å¾ˆå¤šå®ç°ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹© `ClassPathXmlApplicationContext`ï¼Œè¡¨ç¤ºå®ƒä¼šè‡ªåŠ¨ä» classpath ä¸­æŸ¥æ‰¾æŒ‡å®šçš„ XML é…ç½®æ–‡ä»¶ã€‚

è·å¾—äº† `ApplicationContext` çš„å®ä¾‹ï¼Œå°±è·å¾—äº† IoC å®¹å™¨çš„å¼•ç”¨ã€‚ä» `ApplicationContext` ä¸­æˆ‘ä»¬å¯ä»¥æ ¹æ® Bean çš„ ID è·å– Beanï¼Œä½†æ›´å¤šçš„æ—¶å€™æˆ‘ä»¬æ ¹æ® Bean çš„ç±»å‹è·å– Bean çš„å¼•ç”¨ï¼š

```java
UserService userService = context.getBean(UserService.class);
```

Spring è¿˜æä¾›å¦ä¸€ç§ IoC å®¹å™¨å« `BeanFactory`ï¼Œä½¿ç”¨æ–¹å¼å’Œ `ApplicationContext` ç±»ä¼¼ï¼š

```java
BeanFactory factory = new XmlBeanFactory(new ClassPathResource("application.xml"));
MailService mailService = factory.getBean(MailService.class);
```

`BeanFactory` å’Œ `ApplicationContext` çš„åŒºåˆ«åœ¨äºï¼Œ`BeanFactory` çš„å®ç°æ˜¯æŒ‰éœ€åˆ›å»ºï¼Œå³ç¬¬ä¸€æ¬¡è·å– Bean æ—¶æ‰åˆ›å»ºè¿™ä¸ª Beanï¼Œè€Œ `ApplicationContext` ä¼šä¸€æ¬¡æ€§åˆ›å»ºæ‰€æœ‰çš„ Beanã€‚å®é™…ä¸Šï¼Œ`ApplicationContext` æ¥å£æ˜¯ä» `BeanFactory` æ¥å£ç»§æ‰¿è€Œæ¥çš„ï¼Œå¹¶ä¸”ï¼Œ`ApplicationContext` æä¾›äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å›½é™…åŒ–æ”¯æŒã€äº‹ä»¶å’Œé€šçŸ¥æœºåˆ¶ç­‰ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ€»æ˜¯ä½¿ç”¨ `ApplicationContext`ï¼Œå¾ˆå°‘ä¼šè€ƒè™‘ä½¿ç”¨ `BeanFactory`ã€‚

### ç»ƒä¹ 

åœ¨ä¸Šè¿°ç¤ºä¾‹çš„åŸºç¡€ä¸Šï¼Œç»§ç»­ç»™ `UserService` æ³¨å…¥ `DataSource`ï¼Œå¹¶æŠŠæ³¨å†Œå’Œç™»å½•åŠŸèƒ½é€šè¿‡æ•°æ®åº“å®ç°ã€‚


### å°ç»“

Spring çš„ IoC å®¹å™¨æ¥å£æ˜¯ `ApplicationContext`ï¼Œå¹¶æä¾›äº†å¤šç§å®ç°ç±»ï¼›

é€šè¿‡ XML é…ç½®æ–‡ä»¶åˆ›å»º IoC å®¹å™¨æ—¶ï¼Œä½¿ç”¨ `ClassPathXmlApplicationContext`ï¼›

æŒæœ‰ IoC å®¹å™¨åï¼Œé€šè¿‡ `getBean()` æ–¹æ³•è·å– Bean çš„å¼•ç”¨ã€‚



## ğŸ€ ä½¿ç”¨ Annotation é…ç½®


ä½¿ç”¨ Spring çš„ IoC å®¹å™¨ï¼Œå®é™…ä¸Šå°±æ˜¯é€šè¿‡ç±»ä¼¼ XML è¿™æ ·çš„é…ç½®æ–‡ä»¶ï¼ŒæŠŠæˆ‘ä»¬è‡ªå·±çš„ Bean çš„ä¾èµ–å…³ç³»æè¿°å‡ºæ¥ï¼Œç„¶åè®©å®¹å™¨æ¥åˆ›å»ºå¹¶è£…é… Beanã€‚ä¸€æ—¦å®¹å™¨åˆå§‹åŒ–å®Œæ¯•ï¼Œæˆ‘ä»¬å°±ç›´æ¥ä»å®¹å™¨ä¸­è·å– Bean ä½¿ç”¨å®ƒä»¬ã€‚

ä½¿ç”¨ XML é…ç½®çš„ä¼˜ç‚¹æ˜¯æ‰€æœ‰çš„ Bean éƒ½èƒ½ä¸€ç›®äº†ç„¶åœ°åˆ—å‡ºæ¥ï¼Œå¹¶é€šè¿‡é…ç½®æ³¨å…¥èƒ½ç›´è§‚åœ°çœ‹åˆ°æ¯ä¸ª Bean çš„ä¾èµ–ã€‚å®ƒçš„ç¼ºç‚¹æ˜¯å†™èµ·æ¥éå¸¸ç¹çï¼Œæ¯å¢åŠ ä¸€ä¸ªç»„ä»¶ï¼Œå°±å¿…é¡»æŠŠæ–°çš„ Bean é…ç½®åˆ° XML ä¸­ã€‚

æœ‰æ²¡æœ‰å…¶ä»–æ›´ç®€å•çš„é…ç½®æ–¹å¼å‘¢ï¼Ÿ

æœ‰ï¼æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Annotation é…ç½®ï¼Œå¯ä»¥å®Œå…¨ä¸éœ€è¦ XMLï¼Œè®© Spring è‡ªåŠ¨æ‰«æ Bean å¹¶ç»„è£…å®ƒä»¬ã€‚

æˆ‘ä»¬æŠŠä¸Šä¸€èŠ‚çš„ç¤ºä¾‹æ”¹é€ ä¸€ä¸‹ï¼Œå…ˆåˆ é™¤ XML é…ç½®æ–‡ä»¶ï¼Œç„¶åï¼Œç»™ `UserService` å’Œ `MailService` æ·»åŠ å‡ ä¸ªæ³¨è§£ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬ç»™ `MailService` æ·»åŠ ä¸€ä¸ª `@Component` æ³¨è§£ï¼š

```java
@Component
public class MailService {
    ...
}
```

è¿™ä¸ª `@Component` æ³¨è§£å°±ç›¸å½“äºå®šä¹‰äº†ä¸€ä¸ª Beanï¼Œå®ƒæœ‰ä¸€ä¸ªå¯é€‰çš„åç§°ï¼Œé»˜è®¤æ˜¯ `mailService`ï¼Œå³å°å†™å¼€å¤´çš„ç±»åã€‚

ç„¶åï¼Œæˆ‘ä»¬ç»™ `UserService` æ·»åŠ ä¸€ä¸ª `@Component` æ³¨è§£å’Œä¸€ä¸ª `@Autowired` æ³¨è§£ï¼š

```java
@Component
public class UserService {
    @Autowired
    MailService mailService;

    ...
}
```

ä½¿ç”¨ `@Autowired` å°±ç›¸å½“äºæŠŠæŒ‡å®šç±»å‹çš„ Bean æ³¨å…¥åˆ°æŒ‡å®šçš„å­—æ®µä¸­ã€‚å’Œ XML é…ç½®ç›¸æ¯”ï¼Œ`@Autowired` å¤§å¹…ç®€åŒ–äº†æ³¨å…¥ï¼Œå› ä¸ºå®ƒä¸ä½†å¯ä»¥å†™åœ¨ `set()` æ–¹æ³•ä¸Šï¼Œè¿˜å¯ä»¥ç›´æ¥å†™åœ¨å­—æ®µä¸Šï¼Œç”šè‡³å¯ä»¥å†™åœ¨æ„é€ æ–¹æ³•ä¸­ï¼š

```java
@Component
public class UserService {
    MailService mailService;

    public UserService(@Autowired MailService mailService) {
        this.mailService = mailService;
    }
    ...
}
```

æˆ‘ä»¬ä¸€èˆ¬æŠŠ `@Autowired` å†™åœ¨å­—æ®µä¸Šï¼Œé€šå¸¸ä½¿ç”¨ package æƒé™çš„å­—æ®µï¼Œä¾¿äºæµ‹è¯•ã€‚

æœ€åï¼Œç¼–å†™ä¸€ä¸ª `AppConfig` ç±»å¯åŠ¨å®¹å™¨ï¼š

```java
@Configuration
@ComponentScan
public class AppConfig {
    public static void main(String[] args) {
        ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);
        UserService userService = context.getBean(UserService.class);
        User user = userService.login("bob@example.com", "password");
        System.out.println(user.getName());
    }
}
```

é™¤äº† `main()` æ–¹æ³•å¤–ï¼Œ`AppConfig` æ ‡æ³¨äº† `@Configuration`ï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œå› ä¸ºæˆ‘ä»¬åˆ›å»º `ApplicationContext` æ—¶ï¼š

```java
ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);
```

ä½¿ç”¨çš„å®ç°ç±»æ˜¯ `AnnotationConfigApplicationContext`ï¼Œå¿…é¡»ä¼ å…¥ä¸€ä¸ªæ ‡æ³¨äº† `@Configuration` çš„ç±»åã€‚

æ­¤å¤–ï¼Œ`AppConfig` è¿˜æ ‡æ³¨äº† `@ComponentScan`ï¼Œå®ƒå‘Šè¯‰å®¹å™¨ï¼Œè‡ªåŠ¨æœç´¢å½“å‰ç±»æ‰€åœ¨çš„åŒ…ä»¥åŠå­åŒ…ï¼ŒæŠŠæ‰€æœ‰æ ‡æ³¨ä¸º `@Component` çš„ Bean è‡ªåŠ¨åˆ›å»ºå‡ºæ¥ï¼Œå¹¶æ ¹æ® `@Autowired` è¿›è¡Œè£…é…ã€‚

æ•´ä¸ªå·¥ç¨‹ç»“æ„å¦‚ä¸‹ï¼š

![image-20231221141916813](./assets/image-20231221141916813.png)

ä½¿ç”¨ Annotation é…åˆè‡ªåŠ¨æ‰«æèƒ½å¤§å¹…ç®€åŒ– Spring çš„é…ç½®ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿è¯ï¼š

- æ¯ä¸ª Bean è¢«æ ‡æ³¨ä¸º `@Component` å¹¶æ­£ç¡®ä½¿ç”¨ `@Autowired` æ³¨å…¥ï¼›
- é…ç½®ç±»è¢«æ ‡æ³¨ä¸º `@Configuration` å’Œ `@ComponentScan`ï¼›
- æ‰€æœ‰ Bean å‡åœ¨æŒ‡å®šåŒ…ä»¥åŠå­åŒ…å†…ã€‚

ä½¿ç”¨ `@ComponentScan` éå¸¸æ–¹ä¾¿ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿè¦ç‰¹åˆ«æ³¨æ„åŒ…çš„å±‚æ¬¡ç»“æ„ã€‚é€šå¸¸æ¥è¯´ï¼Œå¯åŠ¨é…ç½® `AppConfig` ä½äºè‡ªå®šä¹‰çš„é¡¶å±‚åŒ…ï¼ˆä¾‹å¦‚ `com.itranswarp.learnjava`ï¼‰ï¼Œå…¶ä»– Bean æŒ‰ç±»åˆ«æ”¾å…¥å­åŒ…ã€‚

### æ€è€ƒ

å¦‚æœæˆ‘ä»¬æƒ³ç»™ `UserService` æ³¨å…¥ `HikariDataSource`ï¼Œä½†æ˜¯è¿™ä¸ªç±»ä½äº `com.zaxxer.hikari` åŒ…ä¸­ï¼Œå¹¶ä¸” `HikariDataSource` ä¹Ÿä¸å¯èƒ½æœ‰ `@Component` æ³¨è§£ï¼Œå¦‚ä½•å‘Šè¯‰ IoC å®¹å™¨åˆ›å»ºå¹¶é…ç½® `HikariDataSource`ï¼Ÿæˆ–è€…æ¢ä¸ªè¯´æ³•ï¼Œå¦‚ä½•åˆ›å»ºå¹¶é…ç½®ä¸€ä¸ªç¬¬ä¸‰æ–¹ Beanï¼Ÿ

### ç»ƒä¹ 

ä½¿ç”¨ Annotation é…ç½® IoC å®¹å™¨

### å°ç»“

ä½¿ç”¨ Annotation å¯ä»¥å¤§å¹…ç®€åŒ–é…ç½®ï¼Œæ¯ä¸ª Bean é€šè¿‡ `@Component` å’Œ `@Autowired` æ³¨å…¥ï¼›

å¿…é¡»åˆç†è®¾è®¡åŒ…çš„å±‚æ¬¡ç»“æ„ï¼Œæ‰èƒ½å‘æŒ¥ `@ComponentScan` çš„å¨åŠ›ã€‚



## ğŸ€ å®šåˆ¶ Bean


### Scope

å¯¹äº Spring å®¹å™¨æ¥è¯´ï¼Œå½“æˆ‘ä»¬æŠŠä¸€ä¸ª Bean æ ‡è®°ä¸º `@Component` åï¼Œå®ƒå°±ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå•ä¾‹ï¼ˆSingletonï¼‰ï¼Œå³å®¹å™¨åˆå§‹åŒ–æ—¶åˆ›å»º Beanï¼Œå®¹å™¨å…³é—­å‰é”€æ¯ Beanã€‚åœ¨å®¹å™¨è¿è¡ŒæœŸé—´ï¼Œæˆ‘ä»¬è°ƒç”¨ `getBean(Class)` è·å–åˆ°çš„ Bean æ€»æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚

è¿˜æœ‰ä¸€ç§ Beanï¼Œæˆ‘ä»¬æ¯æ¬¡è°ƒç”¨ `getBean(Class)`ï¼Œå®¹å™¨éƒ½è¿”å›ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œè¿™ç§ Bean ç§°ä¸º Prototypeï¼ˆåŸå‹ï¼‰ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¾ç„¶å’Œ Singleton ä¸åŒã€‚å£°æ˜ä¸€ä¸ª Prototype çš„ Bean æ—¶ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªé¢å¤–çš„ `@Scope` æ³¨è§£ï¼š

```java
@Component
@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE) // @Scope("prototype")
public class MailSession {
    ...
}
```

### æ³¨å…¥ List

æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸€ç³»åˆ—æ¥å£ç›¸åŒï¼Œä¸åŒå®ç°ç±»çš„ Beanã€‚ä¾‹å¦‚ï¼Œæ³¨å†Œç”¨æˆ·æ—¶ï¼Œæˆ‘ä»¬è¦å¯¹ emailã€password å’Œ name è¿™ 3 ä¸ªå˜é‡è¿›è¡ŒéªŒè¯ã€‚ä¸ºäº†ä¾¿äºæ‰©å±•ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰éªŒè¯æ¥å£ï¼š

```java
public interface Validator {
    void validate(String email, String password, String name);
}
```

ç„¶åï¼Œåˆ†åˆ«ä½¿ç”¨ 3 ä¸ª `Validator` å¯¹ç”¨æˆ·å‚æ•°è¿›è¡ŒéªŒè¯ï¼š

```java
@Component
public class EmailValidator implements Validator {
    public void validate(String email, String password, String name) {
        if (!email.matches("^[a-z0-9]+\\@[a-z0-9]+\\.[a-z]{2,10}$")) {
            throw new IllegalArgumentException("invalid email:" + email);
        }
    }
}

@Component
public class PasswordValidator implements Validator {
    public void validate(String email, String password, String name) {
        if (!password.matches("^.{6,20}$")) {
            throw new IllegalArgumentException("invalid password");
        }
    }
}

@Component
public class NameValidator implements Validator {
    public void validate(String email, String password, String name) {
        if (name == null || name.isBlank() || name.length() > 20) {
            throw new IllegalArgumentException("invalid name:" + name);
        }
    }
}
```

æœ€åï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ª `Validators` ä½œä¸ºå…¥å£è¿›è¡ŒéªŒè¯ï¼š

```java
@Component
public class Validators {
    @Autowired
    List<Validator> validators;

    public void validate(String email, String password, String name) {
        for (var validator : this.validators) {
            validator.validate(email, password, name);
        }
    }
}
```

æ³¨æ„åˆ° `Validators` è¢«æ³¨å…¥äº†ä¸€ä¸ª `List<Validator>`ï¼ŒSpring ä¼šè‡ªåŠ¨æŠŠæ‰€æœ‰ç±»å‹ä¸º `Validator` çš„ Bean è£…é…ä¸ºä¸€ä¸ª `List` æ³¨å…¥è¿›æ¥ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬æ¯æ–°å¢ä¸€ä¸ª `Validator` ç±»å‹ï¼Œå°±è‡ªåŠ¨è¢« Spring è£…é…åˆ° `Validators` ä¸­äº†ï¼Œéå¸¸æ–¹ä¾¿ã€‚

å› ä¸º Spring æ˜¯é€šè¿‡æ‰«æ classpath è·å–åˆ°æ‰€æœ‰çš„ Beanï¼Œè€Œ `List` æ˜¯æœ‰åºçš„ï¼Œè¦æŒ‡å®š `List` ä¸­ Bean çš„é¡ºåºï¼Œå¯ä»¥åŠ ä¸Š `@Order` æ³¨è§£ï¼š

```java
@Component
@Order(1)
public class EmailValidator implements Validator {
    ...
}

@Component
@Order(2)
public class PasswordValidator implements Validator {
    ...
}

@Component
@Order(3)
public class NameValidator implements Validator {
    ...
}
```

### å¯é€‰æ³¨å…¥

é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“æˆ‘ä»¬æ ‡è®°äº†ä¸€ä¸ª `@Autowired` åï¼ŒSpring å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”ç±»å‹çš„ Beanï¼Œå®ƒä¼šæŠ›å‡º `NoSuchBeanDefinitionException` å¼‚å¸¸ã€‚

å¯ä»¥ç»™ `@Autowired` å¢åŠ ä¸€ä¸ª `required = false` çš„å‚æ•°ï¼š

```java
@Component
public class MailService {
    @Autowired(required = false)
    ZoneId zoneId = ZoneId.systemDefault();
    ...
}
```

è¿™ä¸ªå‚æ•°å‘Šè¯‰ Spring å®¹å™¨ï¼Œå¦‚æœæ‰¾åˆ°ä¸€ä¸ªç±»å‹ä¸º `ZoneId` çš„ Beanï¼Œå°±æ³¨å…¥ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±å¿½ç•¥ã€‚

è¿™ç§æ–¹å¼éå¸¸é€‚åˆæœ‰å®šä¹‰å°±ä½¿ç”¨å®šä¹‰ï¼Œæ²¡æœ‰å°±ä½¿ç”¨é»˜è®¤å€¼çš„æƒ…å†µã€‚

### åˆ›å»ºç¬¬ä¸‰æ–¹ Bean

å¦‚æœä¸€ä¸ª Bean ä¸åœ¨æˆ‘ä»¬è‡ªå·±çš„ package ç®¡ç†ä¹‹å†…ï¼Œä¾‹å¦‚ `ZoneId`ï¼Œå¦‚ä½•åˆ›å»ºå®ƒï¼Ÿ

ç­”æ¡ˆæ˜¯æˆ‘ä»¬è‡ªå·±åœ¨ `@Configuration` ç±»ä¸­ç¼–å†™ä¸€ä¸ª Java æ–¹æ³•åˆ›å»ºå¹¶è¿”å›å®ƒï¼Œæ³¨æ„ç»™æ–¹æ³•æ ‡è®°ä¸€ä¸ª `@Bean` æ³¨è§£ï¼š

```java
@Configuration
@ComponentScan
public class AppConfig {
    // åˆ›å»ºä¸€ä¸ª Bean:
    @Bean
    ZoneId createZoneId() {
        return ZoneId.of("Z");
    }
}
```

Spring å¯¹æ ‡è®°ä¸º `@Bean` çš„æ–¹æ³•åªè°ƒç”¨ä¸€æ¬¡ï¼Œå› æ­¤è¿”å›çš„ Bean ä»ç„¶æ˜¯å•ä¾‹ã€‚

### åˆå§‹åŒ–å’Œé”€æ¯

æœ‰äº›æ—¶å€™ï¼Œä¸€ä¸ª Bean åœ¨æ³¨å…¥å¿…è¦çš„ä¾èµ–åï¼Œéœ€è¦è¿›è¡Œåˆå§‹åŒ–ï¼ˆç›‘å¬æ¶ˆæ¯ç­‰ï¼‰ã€‚åœ¨å®¹å™¨å…³é—­æ—¶ï¼Œæœ‰æ—¶å€™è¿˜éœ€è¦æ¸…ç†èµ„æºï¼ˆå…³é—­è¿æ¥æ± ç­‰ï¼‰ã€‚æˆ‘ä»¬é€šå¸¸ä¼šå®šä¹‰ä¸€ä¸ª `init()` æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œå®šä¹‰ä¸€ä¸ª `shutdown()` æ–¹æ³•è¿›è¡Œæ¸…ç†ï¼Œç„¶åï¼Œå¼•å…¥ JSR-250 å®šä¹‰çš„ Annotationï¼š

- jakarta.annotation:jakarta.annotation-api:2.1.1

åœ¨ Bean çš„åˆå§‹åŒ–å’Œæ¸…ç†æ–¹æ³•ä¸Šæ ‡è®° `@PostConstruct` å’Œ `@PreDestroy`ï¼š

```java
@Component
public class MailService {
    @Autowired(required = false)
    ZoneId zoneId = ZoneId.systemDefault();

    @PostConstruct
    public void init() {
        System.out.println("Init mail service with zoneId =" + this.zoneId);
    }

    @PreDestroy
    public void shutdown() {
        System.out.println("Shutdown mail service");
    }
}
```

Spring å®¹å™¨ä¼šå¯¹ä¸Šè¿° Bean åšå¦‚ä¸‹åˆå§‹åŒ–æµç¨‹ï¼š

- è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»º `MailService` å®ä¾‹ï¼›
- æ ¹æ® `@Autowired` è¿›è¡Œæ³¨å…¥ï¼›
- è°ƒç”¨æ ‡è®°æœ‰ `@PostConstruct` çš„ `init()` æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚

è€Œé”€æ¯æ—¶ï¼Œå®¹å™¨ä¼šé¦–å…ˆè°ƒç”¨æ ‡è®°æœ‰ `@PreDestroy` çš„ `shutdown()` æ–¹æ³•ã€‚

Spring åªæ ¹æ® Annotation æŸ¥æ‰¾ * æ— å‚æ•° * æ–¹æ³•ï¼Œå¯¹æ–¹æ³•åä¸ä½œè¦æ±‚ã€‚

### ä½¿ç”¨åˆ«å

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹ä¸€ç§ç±»å‹çš„ Beanï¼Œå®¹å™¨åªåˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚ä½†æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä¸€ç§ç±»å‹çš„ Bean åˆ›å»ºå¤šä¸ªå®ä¾‹ã€‚ä¾‹å¦‚ï¼ŒåŒæ—¶è¿æ¥å¤šä¸ªæ•°æ®åº“ï¼Œå°±å¿…é¡»åˆ›å»ºå¤šä¸ª `DataSource` å®ä¾‹ã€‚

å¦‚æœæˆ‘ä»¬åœ¨ `@Configuration` ç±»ä¸­åˆ›å»ºäº†å¤šä¸ªåŒç±»å‹çš„ Beanï¼š

```java
@Configuration
@ComponentScan
public class AppConfig {
    @Bean
    ZoneId createZoneOfZ() {
        return ZoneId.of("Z");
    }

    @Bean
    ZoneId createZoneOfUTC8() {
        return ZoneId.of("UTC+08:00");
    }
}
```

Spring ä¼šæŠ¥ `NoUniqueBeanDefinitionException` å¼‚å¸¸ï¼Œæ„æ€æ˜¯å‡ºç°äº†é‡å¤çš„ Bean å®šä¹‰ã€‚

è¿™ä¸ªæ—¶å€™ï¼Œéœ€è¦ç»™æ¯ä¸ª Bean æ·»åŠ ä¸åŒçš„åå­—ï¼š

```java
@Configuration
@ComponentScan
public class AppConfig {
    @Bean("z")
    ZoneId createZoneOfZ() {
        return ZoneId.of("Z");
    }

    @Bean
    @Qualifier("utc8")
    ZoneId createZoneOfUTC8() {
        return ZoneId.of("UTC+08:00");
    }
}
```

å¯ä»¥ç”¨ `@Bean("name")` æŒ‡å®šåˆ«åï¼Œä¹Ÿå¯ä»¥ç”¨ `@Bean`+`@Qualifier("name")` æŒ‡å®šåˆ«åã€‚

å­˜åœ¨å¤šä¸ªåŒç±»å‹çš„ Bean æ—¶ï¼Œæ³¨å…¥ `ZoneId` åˆä¼šæŠ¥é”™ï¼š

```bash
NoUniqueBeanDefinitionException: No qualifying bean of type 'java.time.ZoneId' available: expected single matching bean but found 2
```

æ„æ€æ˜¯æœŸå¾…æ‰¾åˆ°å”¯ä¸€çš„ `ZoneId` ç±»å‹ Beanï¼Œä½†æ˜¯æ‰¾åˆ°ä¸¤ã€‚å› æ­¤ï¼Œæ³¨å…¥æ—¶ï¼Œè¦æŒ‡å®š Bean çš„åç§°ï¼š

```java
@Component
public class MailService {
	@Autowired(required = false)
	@Qualifier("z") // æŒ‡å®šæ³¨å…¥åç§°ä¸º "z" çš„ ZoneId
	ZoneId zoneId = ZoneId.systemDefault();
    ...
}
```

è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯æŠŠå…¶ä¸­æŸä¸ª Bean æŒ‡å®šä¸º `@Primary`ï¼š

```java
@Configuration
@ComponentScan
public class AppConfig {
    @Bean
    @Primary // æŒ‡å®šä¸ºä¸»è¦ Bean
    @Qualifier("z")
    ZoneId createZoneOfZ() {
        return ZoneId.of("Z");
    }

    @Bean
    @Qualifier("utc8")
    ZoneId createZoneOfUTC8() {
        return ZoneId.of("UTC+08:00");
    }
}
```

è¿™æ ·ï¼Œåœ¨æ³¨å…¥æ—¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å‡º Bean çš„åå­—ï¼ŒSpring ä¼šæ³¨å…¥æ ‡è®°æœ‰ `@Primary` çš„ Beanã€‚è¿™ç§æ–¹å¼ä¹Ÿå¾ˆå¸¸ç”¨ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸»ä»ä¸¤ä¸ªæ•°æ®æºï¼Œé€šå¸¸å°†ä¸»æ•°æ®æºå®šä¹‰ä¸º `@Primary`ï¼š

```java
@Configuration
@ComponentScan
public class AppConfig {
    @Bean
    @Primary
    DataSource createMasterDataSource() {
        ...
    }

    @Bean
    @Qualifier("slave")
    DataSource createSlaveDataSource() {
        ...
    }
}
```

å…¶ä»– Bean é»˜è®¤æ³¨å…¥çš„å°±æ˜¯ä¸»æ•°æ®æºã€‚å¦‚æœè¦æ³¨å…¥ä»æ•°æ®æºï¼Œé‚£ä¹ˆåªéœ€è¦æŒ‡å®šåç§°å³å¯ã€‚

### ä½¿ç”¨ FactoryBean

æˆ‘ä»¬åœ¨è®¾è®¡æ¨¡å¼çš„ [å·¥å‚æ–¹æ³•](https://www.liaoxuefeng.com/wiki/1252599548343744/1281319170474017) ä¸­è®²åˆ°ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œå¯ä»¥é€šè¿‡å·¥å‚æ¨¡å¼åˆ›å»ºå¯¹è±¡ã€‚Spring ä¹Ÿæä¾›äº†å·¥å‚æ¨¡å¼ï¼Œå…è®¸å®šä¹‰ä¸€ä¸ªå·¥å‚ï¼Œç„¶åç”±å·¥å‚åˆ›å»ºçœŸæ­£çš„ Beanã€‚

ç”¨å·¥å‚æ¨¡å¼åˆ›å»º Bean éœ€è¦å®ç° `FactoryBean` æ¥å£ã€‚æˆ‘ä»¬è§‚å¯Ÿä¸‹é¢çš„ä»£ç ï¼š

```java
@Component
public class ZoneIdFactoryBean implements FactoryBean<ZoneId> {

    String zone = "Z";

    @Override
    public ZoneId getObject() throws Exception {
        return ZoneId.of(zone);
    }

    @Override
    public Class<?> getObjectType() {
        return ZoneId.class;
    }
}
```

å½“ä¸€ä¸ª Bean å®ç°äº† `FactoryBean` æ¥å£åï¼ŒSpring ä¼šå…ˆå®ä¾‹åŒ–è¿™ä¸ªå·¥å‚ï¼Œç„¶åè°ƒç”¨ `getObject()` åˆ›å»ºçœŸæ­£çš„ Beanã€‚`getObjectType()` å¯ä»¥æŒ‡å®šåˆ›å»ºçš„ Bean çš„ç±»å‹ï¼Œå› ä¸ºæŒ‡å®šç±»å‹ä¸ä¸€å®šä¸å®é™…ç±»å‹ä¸€è‡´ï¼Œå¯ä»¥æ˜¯æ¥å£æˆ–æŠ½è±¡ç±»ã€‚

å› æ­¤ï¼Œå¦‚æœå®šä¹‰äº†ä¸€ä¸ª `FactoryBean`ï¼Œè¦æ³¨æ„ Spring åˆ›å»ºçš„ Bean å®é™…ä¸Šæ˜¯è¿™ä¸ª `FactoryBean` çš„ `getObject()` æ–¹æ³•è¿”å›çš„ Beanã€‚ä¸ºäº†å’Œæ™®é€š Bean åŒºåˆ†ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½ä»¥ `XxxFactoryBean` å‘½åã€‚

ç”±äºå¯ä»¥ç”¨ `@Bean` æ–¹æ³•åˆ›å»ºç¬¬ä¸‰æ–¹ Beanï¼Œæœ¬è´¨ä¸Š `@Bean` æ–¹æ³•å°±æ˜¯å·¥å‚æ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œ`FactoryBean` å·²ç»ç”¨å¾—è¶Šæ¥è¶Šå°‘äº†ã€‚

### ç»ƒä¹ 

å®šåˆ¶ Bean

### å°ç»“

Spring é»˜è®¤ä½¿ç”¨ Singleton åˆ›å»º Beanï¼Œä¹Ÿå¯æŒ‡å®š Scope ä¸º Prototypeï¼›

å¯å°†ç›¸åŒç±»å‹çš„ Bean æ³¨å…¥ `List` æˆ–æ•°ç»„ï¼›

å¯ç”¨ `@Autowired(required=false)` å…è®¸å¯é€‰æ³¨å…¥ï¼›

å¯ç”¨å¸¦ `@Bean` æ ‡æ³¨çš„æ–¹æ³•åˆ›å»º Beanï¼›

å¯ä½¿ç”¨ `@PostConstruct` å’Œ `@PreDestroy` å¯¹ Bean è¿›è¡Œåˆå§‹åŒ–å’Œæ¸…ç†ï¼›

ç›¸åŒç±»å‹çš„ Bean åªèƒ½æœ‰ä¸€ä¸ªæŒ‡å®šä¸º `@Primary`ï¼Œå…¶ä»–å¿…é¡»ç”¨ `@Qualifier("beanName")` æŒ‡å®šåˆ«åï¼›

æ³¨å…¥æ—¶ï¼Œå¯é€šè¿‡åˆ«å `@Qualifier("beanName")` æŒ‡å®šæŸä¸ª Beanï¼›

å¯ä»¥å®šä¹‰ `FactoryBean` æ¥ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»º Beanã€‚



## ğŸ€ ä½¿ç”¨ Resource


åœ¨ Java ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šè¯»å–é…ç½®æ–‡ä»¶ã€èµ„æºæ–‡ä»¶ç­‰ã€‚ä½¿ç”¨ Spring å®¹å™¨æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠ â€œæ–‡ä»¶â€ æ³¨å…¥è¿›æ¥ï¼Œæ–¹ä¾¿ç¨‹åºè¯»å–ã€‚

ä¾‹å¦‚ï¼ŒAppService éœ€è¦è¯»å– `logo.txt` è¿™ä¸ªæ–‡ä»¶ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å†™å¾ˆå¤šç¹ççš„ä»£ç ï¼Œä¸»è¦æ˜¯ä¸ºäº†å®šä½æ–‡ä»¶ï¼Œæ‰“å¼€ InputStreamã€‚

Spring æä¾›äº†ä¸€ä¸ª `org.springframework.core.io.Resource`ï¼ˆæ³¨æ„ä¸æ˜¯ `jarkata.annotation.Resource` æˆ– `javax.annotation.Resource`ï¼‰ï¼Œå®ƒå¯ä»¥åƒ `String`ã€`int` ä¸€æ ·ä½¿ç”¨ `@Value` æ³¨å…¥ï¼š

```java
@Component
public class AppService {
    @Value("classpath:/logo.txt")
    private Resource resource;

    private String logo;

    @PostConstruct
    public void init() throws IOException {
        try (var reader = new BufferedReader(
                new InputStreamReader(resource.getInputStream(), StandardCharsets.UTF_8))) {
            this.logo = reader.lines().collect(Collectors.joining("\n"));
        }
    }
}
```

æ³¨å…¥ `Resource` æœ€å¸¸ç”¨çš„æ–¹å¼æ˜¯é€šè¿‡ classpathï¼Œå³ç±»ä¼¼ `classpath:/logo.txt` è¡¨ç¤ºåœ¨ classpath ä¸­æœç´¢ `logo.txt` æ–‡ä»¶ï¼Œç„¶åï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨ `Resource.getInputStream()` å°±å¯ä»¥è·å–åˆ°è¾“å…¥æµï¼Œé¿å…äº†è‡ªå·±æœç´¢æ–‡ä»¶çš„ä»£ç ã€‚

ä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šæ–‡ä»¶çš„è·¯å¾„ï¼Œä¾‹å¦‚ï¼š

```java
@Value("file:/path/to/logo.txt")
private Resource resource;
```

ä½†ä½¿ç”¨ classpath æ˜¯æœ€ç®€å•çš„æ–¹å¼ã€‚ä¸Šè¿°å·¥ç¨‹ç»“æ„å¦‚ä¸‹ï¼š

![image-20231221142031735](./assets/image-20231221142031735.png)

ä½¿ç”¨ Maven çš„æ ‡å‡†ç›®å½•ç»“æ„ï¼Œæ‰€æœ‰èµ„æºæ–‡ä»¶æ”¾å…¥ `src/main/resources` å³å¯ã€‚

### ç»ƒä¹ 

ä½¿ç”¨ Spring çš„ `Resource` æ³¨å…¥ `app.properties` æ–‡ä»¶ï¼Œç„¶åè¯»å–è¯¥é…ç½®æ–‡ä»¶ã€‚


### å°ç»“

Spring æä¾›äº† Resource ç±»ä¾¿äºæ³¨å…¥èµ„æºæ–‡ä»¶ã€‚

æœ€å¸¸ç”¨çš„æ³¨å…¥æ˜¯é€šè¿‡ classpath ä»¥ `classpath:/path/to/file` çš„å½¢å¼æ³¨å…¥ã€‚



## ğŸ€ æ³¨å…¥é…ç½®


åœ¨å¼€å‘åº”ç”¨ç¨‹åºæ—¶ï¼Œç»å¸¸éœ€è¦è¯»å–é…ç½®æ–‡ä»¶ã€‚æœ€å¸¸ç”¨çš„é…ç½®æ–¹æ³•æ˜¯ä»¥ `key=value` çš„å½¢å¼å†™åœ¨ `.properties` æ–‡ä»¶ä¸­ã€‚

ä¾‹å¦‚ï¼Œ`MailService` æ ¹æ®é…ç½®çš„ `app.zone=Asia/Shanghai` æ¥å†³å®šä½¿ç”¨å“ªä¸ªæ—¶åŒºã€‚è¦è¯»å–é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šä¸€èŠ‚è®²åˆ°çš„ `Resource` æ¥è¯»å–ä½äº classpath ä¸‹çš„ä¸€ä¸ª `app.properties` æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œè¿™æ ·ä»ç„¶æ¯”è¾ƒç¹çã€‚

Spring å®¹å™¨è¿˜æä¾›äº†ä¸€ä¸ªæ›´ç®€å•çš„ `@PropertySource` æ¥è‡ªåŠ¨è¯»å–é…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨ `@Configuration` é…ç½®ç±»ä¸Šå†æ·»åŠ ä¸€ä¸ªæ³¨è§£ï¼š

```java
@Configuration
@ComponentScan
@PropertySource("app.properties") // è¡¨ç¤ºè¯»å– classpath çš„ app.properties
public class AppConfig {
    @Value("${app.zone:Z}")
    String zoneId;

    @Bean
    ZoneId createZoneId() {
        return ZoneId.of(zoneId);
    }
}
```

Spring å®¹å™¨çœ‹åˆ° `@PropertySource("app.properties")` æ³¨è§£åï¼Œè‡ªåŠ¨è¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ `@Value` æ­£å¸¸æ³¨å…¥ï¼š

```java
@Value("${app.zone:Z}")
String zoneId;
```

æ³¨æ„æ³¨å…¥çš„å­—ç¬¦ä¸²è¯­æ³•ï¼Œå®ƒçš„æ ¼å¼å¦‚ä¸‹ï¼š

- `"${app.zone}"` è¡¨ç¤ºè¯»å– key ä¸º `app.zone` çš„ valueï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œå¯åŠ¨å°†æŠ¥é”™ï¼›
- `"${app.zone:Z}"` è¡¨ç¤ºè¯»å– key ä¸º `app.zone` çš„ valueï¼Œä½†å¦‚æœ key ä¸å­˜åœ¨ï¼Œå°±ä½¿ç”¨é»˜è®¤å€¼ `Z`ã€‚

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ® `app.zone` çš„é…ç½®æ¥åˆ›å»º `ZoneId`ã€‚

è¿˜å¯ä»¥æŠŠæ³¨å…¥çš„æ³¨è§£å†™åˆ°æ–¹æ³•å‚æ•°ä¸­ï¼š

```java
@Bean
ZoneId createZoneId(@Value("${app.zone:Z}") String zoneId) {
    return ZoneId.of(zoneId);
}
```

å¯è§ï¼Œå…ˆä½¿ç”¨ `@PropertySource` è¯»å–é…ç½®æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ `@Value` ä»¥ `${key:defaultValue}` çš„å½¢å¼æ³¨å…¥ï¼Œå¯ä»¥æå¤§åœ°ç®€åŒ–è¯»å–é…ç½®çš„éº»çƒ¦ã€‚

å¦ä¸€ç§æ³¨å…¥é…ç½®çš„æ–¹å¼æ˜¯å…ˆé€šè¿‡ä¸€ä¸ªç®€å•çš„ JavaBean æŒæœ‰æ‰€æœ‰çš„é…ç½®ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ª `SmtpConfig`ï¼š

```java
@Component
public class SmtpConfig {
    @Value("${smtp.host}")
    private String host;

    @Value("${smtp.port:25}")
    private int port;

    public String getHost() {
        return host;
    }

    public int getPort() {
        return port;
    }
}
```

ç„¶åï¼Œåœ¨éœ€è¦è¯»å–çš„åœ°æ–¹ï¼Œä½¿ç”¨ `#{smtpConfig.host}` æ³¨å…¥ï¼š

```java
@Component
public class MailService {
    @Value("#{smtpConfig.host}")
    private String smtpHost;

    @Value("#{smtpConfig.port}")
    private int smtpPort;
}
```

æ³¨æ„è§‚å¯Ÿ `#{}` è¿™ç§æ³¨å…¥è¯­æ³•ï¼Œå®ƒå’Œ `${key}` ä¸åŒçš„æ˜¯ï¼Œ`#{}` è¡¨ç¤ºä» JavaBean è¯»å–å±æ€§ã€‚`"#{smtpConfig.host}"` çš„æ„æ€æ˜¯ï¼Œä»åç§°ä¸º `smtpConfig` çš„ Bean è¯»å– `host` å±æ€§ï¼Œå³è°ƒç”¨ `getHost()` æ–¹æ³•ã€‚ä¸€ä¸ª Class åä¸º `SmtpConfig` çš„ Beanï¼Œå®ƒåœ¨ Spring å®¹å™¨ä¸­çš„é»˜è®¤åç§°å°±æ˜¯ `smtpConfig`ï¼Œé™¤éç”¨ `@Qualifier` æŒ‡å®šäº†åç§°ã€‚

ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„ JavaBean æŒæœ‰æ‰€æœ‰å±æ€§ï¼Œç„¶ååœ¨å…¶ä»– Bean ä¸­ä»¥ `#{bean.property}` æ³¨å…¥çš„å¥½å¤„æ˜¯ï¼Œå¤šä¸ª Bean éƒ½å¯ä»¥å¼•ç”¨åŒä¸€ä¸ª Bean çš„æŸä¸ªå±æ€§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ `SmtpConfig` å†³å®šä»æ•°æ®åº“ä¸­è¯»å–ç›¸å…³é…ç½®é¡¹ï¼Œé‚£ä¹ˆ `MailService` æ³¨å…¥çš„ `@Value("#{smtpConfig.host}")` ä»ç„¶å¯ä»¥ä¸ä¿®æ”¹æ­£å¸¸è¿è¡Œã€‚

### ç»ƒä¹ 

æ³¨å…¥ SMTP é…ç½®

### å°ç»“

Spring å®¹å™¨å¯ä»¥é€šè¿‡ `@PropertySource` è‡ªåŠ¨è¯»å–é…ç½®ï¼Œå¹¶ä»¥ `@Value("${key}")` çš„å½¢å¼æ³¨å…¥ï¼›

å¯ä»¥é€šè¿‡ `${key:defaultValue}` æŒ‡å®šé»˜è®¤å€¼ï¼›

ä»¥ `#{bean.property}` å½¢å¼æ³¨å…¥æ—¶ï¼ŒSpring å®¹å™¨è‡ªåŠ¨æŠŠæŒ‡å®š Bean çš„æŒ‡å®šå±æ€§å€¼æ³¨å…¥ã€‚



## ğŸ€ ä½¿ç”¨æ¡ä»¶è£…é…


å¼€å‘åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨å¼€å‘ç¯å¢ƒï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨å†…å­˜æ•°æ®åº“ä»¥ä¾¿å¿«é€Ÿå¯åŠ¨ã€‚è€Œè¿è¡Œåœ¨ç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ç”Ÿäº§ç¯å¢ƒï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨ MySQL æ•°æ®åº“ã€‚å¦‚æœåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®è‡ªèº«çš„ç¯å¢ƒåšä¸€äº›é€‚é…ï¼Œæ— ç–‘ä¼šæ›´åŠ çµæ´»ã€‚

Spring ä¸ºåº”ç”¨ç¨‹åºå‡†å¤‡äº† Profile è¿™ä¸€æ¦‚å¿µï¼Œç”¨æ¥è¡¨ç¤ºä¸åŒçš„ç¯å¢ƒã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åˆ†åˆ«å®šä¹‰å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§è¿™ 3 ä¸ªç¯å¢ƒï¼š

- native
- test
- production

åˆ›å»ºæŸä¸ª Bean æ—¶ï¼ŒSpring å®¹å™¨å¯ä»¥æ ¹æ®æ³¨è§£ `@Profile` æ¥å†³å®šæ˜¯å¦åˆ›å»ºã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹é…ç½®ï¼š

```java
@Configuration
@ComponentScan
public class AppConfig {
    @Bean
    @Profile("!test")
    ZoneId createZoneId() {
        return ZoneId.systemDefault();
    }

    @Bean
    @Profile("test")
    ZoneId createZoneIdForTest() {
        return ZoneId.of("America/New_York");
    }
}
```

å¦‚æœå½“å‰çš„ Profile è®¾ç½®ä¸º `test`ï¼Œåˆ™ Spring å®¹å™¨ä¼šè°ƒç”¨ `createZoneIdForTest()` åˆ›å»º `ZoneId`ï¼Œå¦åˆ™ï¼Œè°ƒç”¨ `createZoneId()` åˆ›å»º `ZoneId`ã€‚æ³¨æ„åˆ° `@Profile("!test")` è¡¨ç¤ºé test ç¯å¢ƒã€‚

åœ¨è¿è¡Œç¨‹åºæ—¶ï¼ŒåŠ ä¸Š JVM å‚æ•° `-Dspring.profiles.active=test` å°±å¯ä»¥æŒ‡å®šä»¥ `test` ç¯å¢ƒå¯åŠ¨ã€‚

å®é™…ä¸Šï¼ŒSpring å…è®¸æŒ‡å®šå¤šä¸ª Profileï¼Œä¾‹å¦‚ï¼š

```
-Dspring.profiles.active=test,master
```

å¯ä»¥è¡¨ç¤º `test` ç¯å¢ƒï¼Œå¹¶ä½¿ç”¨ `master` åˆ†æ”¯ä»£ç ã€‚

è¦æ»¡è¶³å¤šä¸ª Profile æ¡ä»¶ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```java
@Bean
@Profile({"test", "master"}) // æ»¡è¶³ test æˆ– master
ZoneId createZoneId() {
    ...
}
```

### ä½¿ç”¨ Conditional

é™¤äº†æ ¹æ® `@Profile` æ¡ä»¶æ¥å†³å®šæ˜¯å¦åˆ›å»ºæŸä¸ª Bean å¤–ï¼ŒSpring è¿˜å¯ä»¥æ ¹æ® `@Conditional` å†³å®šæ˜¯å¦åˆ›å»ºæŸä¸ª Beanã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯¹ `SmtpMailService` æ·»åŠ å¦‚ä¸‹æ³¨è§£ï¼š

```java
@Component
@Conditional(OnSmtpEnvCondition.class)
public class SmtpMailService implements MailService {
    ...
}
```

å®ƒçš„æ„æ€æ˜¯ï¼Œå¦‚æœæ»¡è¶³ `OnSmtpEnvCondition` çš„æ¡ä»¶ï¼Œæ‰ä¼šåˆ›å»º `SmtpMailService` è¿™ä¸ª Beanã€‚`OnSmtpEnvCondition` çš„æ¡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£ç ï¼š

```java
public class OnSmtpEnvCondition implements Condition {
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        return "true".equalsIgnoreCase(System.getenv("smtp"));
    }
}
```

å› æ­¤ï¼Œ`OnSmtpEnvCondition` çš„æ¡ä»¶æ˜¯å­˜åœ¨ç¯å¢ƒå˜é‡ `smtp`ï¼Œå€¼ä¸º `true`ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æ¥æ§åˆ¶æ˜¯å¦åˆ›å»º `SmtpMailService`ã€‚

Spring åªæä¾›äº† `@Conditional` æ³¨è§£ï¼Œå…·ä½“åˆ¤æ–­é€»è¾‘è¿˜éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ã€‚Spring Boot æä¾›äº†æ›´å¤šä½¿ç”¨èµ·æ¥æ›´ç®€å•çš„æ¡ä»¶æ³¨è§£ï¼Œä¾‹å¦‚ï¼Œå¦‚æœé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨ `app.smtp=true`ï¼Œåˆ™åˆ›å»º `MailService`ï¼š

```java
@Component
@ConditionalOnProperty(name="app.smtp", havingValue="true")
public class MailService {
    ...
}
```

å¦‚æœå½“å‰ classpath ä¸­å­˜åœ¨ç±» `javax.mail.Transport`ï¼Œåˆ™åˆ›å»º `MailService`ï¼š

```java
@Component
@ConditionalOnClass(name = "javax.mail.Transport")
public class MailService {
    ...
}
```

åç»­æˆ‘ä»¬ä¼šä»‹ç» Spring Boot çš„æ¡ä»¶è£…é…ã€‚æˆ‘ä»¬ä»¥æ–‡ä»¶å­˜å‚¨ä¸ºä¾‹ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦ä¿å­˜ç”¨æˆ·ä¸Šä¼ çš„å¤´åƒï¼Œå¹¶è¿”å›å­˜å‚¨è·¯å¾„ï¼Œåœ¨æœ¬åœ°å¼€å‘è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬æ€»æ˜¯å­˜å‚¨åˆ°æ–‡ä»¶ï¼š

```java
@Component
@ConditionalOnProperty(name = "app.storage", havingValue = "file", matchIfMissing = true)
public class FileUploader implements Uploader {
    ...
}
```

åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¼šæŠŠæ–‡ä»¶å­˜å‚¨åˆ°ç±»ä¼¼ AWS S3 ä¸Šï¼š

```java
@Component
@ConditionalOnProperty(name = "app.storage", havingValue = "s3")
public class S3Uploader implements Uploader {
    ...
}
```

å…¶ä»–éœ€è¦å­˜å‚¨çš„æœåŠ¡åˆ™æ³¨å…¥ `Uploader`ï¼š

```java
@Component
public class UserImageService {
    @Autowired
    Uploader uploader;
}
```

å½“åº”ç”¨ç¨‹åºæ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å­˜åœ¨ `app.storage=s3` æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨ `S3Uploader`ï¼Œå¦‚æœå­˜åœ¨é…ç½® `app.storage=file`ï¼Œæˆ–è€…é…ç½® `app.storage` ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ `FileUploader`ã€‚

å¯è§ï¼Œä½¿ç”¨æ¡ä»¶æ³¨è§£ï¼Œèƒ½æ›´çµæ´»åœ°è£…é… Beanã€‚

### ç»ƒä¹ 

ä½¿ç”¨ @Profile è¿›è¡Œæ¡ä»¶è£…é…

### å°ç»“

Spring å…è®¸é€šè¿‡ `@Profile` é…ç½®ä¸åŒçš„ Beanï¼›

Spring è¿˜æä¾›äº† `@Conditional` æ¥è¿›è¡Œæ¡ä»¶è£…é…ï¼ŒSpring Boot åœ¨æ­¤åŸºç¡€ä¸Šè¿›ä¸€æ­¥æä¾›äº†åŸºäºé…ç½®ã€Classã€Bean ç­‰æ¡ä»¶è¿›è¡Œè£…é…ã€‚


