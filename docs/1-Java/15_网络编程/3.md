---
title: UDP ç¼–ç¨‹
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

å’Œ TCP ç¼–ç¨‹ç›¸æ¯”ï¼ŒUDP ç¼–ç¨‹å°±ç®€å•å¾—å¤šï¼Œå› ä¸º UDP æ²¡æœ‰åˆ›å»ºè¿æ¥ï¼Œæ•°æ®åŒ…ä¹Ÿæ˜¯ä¸€æ¬¡æ”¶å‘ä¸€ä¸ªï¼Œæ‰€ä»¥æ²¡æœ‰æµçš„æ¦‚å¿µã€‚

åœ¨ Java ä¸­ä½¿ç”¨ UDP ç¼–ç¨‹ï¼Œä»ç„¶éœ€è¦ä½¿ç”¨ Socketï¼Œå› ä¸ºåº”ç”¨ç¨‹åºåœ¨ä½¿ç”¨ UDP æ—¶å¿…é¡»æŒ‡å®šç½‘ç»œæ¥å£ï¼ˆIPï¼‰å’Œç«¯å£å·ã€‚

> [!caution]
> UDP ç«¯å£å’Œ TCP ç«¯å£è™½ç„¶éƒ½ä½¿ç”¨ 0 ~ 65535ï¼Œä½†ä»–ä»¬æ˜¯ä¸¤å¥—ç‹¬ç«‹çš„ç«¯å£ï¼Œå³ä¸€ä¸ªåº”ç”¨ç¨‹åºç”¨ TCP å ç”¨äº†ç«¯å£ 1234ï¼Œä¸å½±å“å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºç”¨ UDP å ç”¨ç«¯å£ 1234ã€‚

## ğŸ€ æœåŠ¡å™¨ç«¯

åœ¨æœåŠ¡å™¨ç«¯ï¼Œä½¿ç”¨ UDP ä¹Ÿéœ€è¦ç›‘å¬æŒ‡å®šçš„ç«¯å£ã€‚Java æä¾›äº† `DatagramSocket` æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
DatagramSocket ds = new DatagramSocket(6666); // ç›‘å¬æŒ‡å®šç«¯å£
for (;;) { // æ— é™å¾ªç¯
    // æ•°æ®ç¼“å†²åŒº:
    byte[] buffer = new byte[1024];
    DatagramPacket packet = new DatagramPacket(buffer, buffer.length);
    ds.receive(packet); // æ”¶å–ä¸€ä¸ª UDP æ•°æ®åŒ…
    // æ”¶å–åˆ°çš„æ•°æ®å­˜å‚¨åœ¨ buffer ä¸­ï¼Œç”± packet.getOffset(), packet.getLength() æŒ‡å®šèµ·å§‹ä½ç½®å’Œé•¿åº¦
    // å°†å…¶æŒ‰ UTF-8 ç¼–ç è½¬æ¢ä¸º String:
    String s = new String(packet.getData(), packet.getOffset(), packet.getLength(), StandardCharsets.UTF_8);
    // å‘é€æ•°æ®:
    byte[] data = "ACK".getBytes(StandardCharsets.UTF_8);
    packet.setData(data);
    ds.send(packet);
}
```

æœåŠ¡å™¨ç«¯é¦–å…ˆä½¿ç”¨å¦‚ä¸‹è¯­å¥åœ¨æŒ‡å®šçš„ç«¯å£ç›‘å¬ UDP æ•°æ®åŒ…ï¼š

```java
DatagramSocket ds = new DatagramSocket(6666);
```

å¦‚æœæ²¡æœ‰å…¶ä»–åº”ç”¨ç¨‹åºå æ®è¿™ä¸ªç«¯å£ï¼Œé‚£ä¹ˆç›‘å¬æˆåŠŸï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ä¸€ä¸ªæ— é™å¾ªç¯æ¥å¤„ç†æ”¶åˆ°çš„ UDP æ•°æ®åŒ…ï¼š

```java
for (;;) {
    ...
}
```

è¦æ¥æ”¶ä¸€ä¸ª UDP æ•°æ®åŒ…ï¼Œéœ€è¦å‡†å¤‡ä¸€ä¸ª `byte[]` ç¼“å†²åŒºï¼Œå¹¶é€šè¿‡ `DatagramPacket` å®ç°æ¥æ”¶ï¼š

```java
byte[] buffer = new byte[1024];
DatagramPacket packet = new DatagramPacket(buffer, buffer.length);
ds.receive(packet);
```

å‡è®¾æˆ‘ä»¬æ”¶å–åˆ°çš„æ˜¯ä¸€ä¸ª `String`ï¼Œé‚£ä¹ˆï¼Œé€šè¿‡ `DatagramPacket` è¿”å›çš„ `packet.getOffset()` å’Œ `packet.getLength()` ç¡®å®šæ•°æ®åœ¨ç¼“å†²åŒºçš„èµ·æ­¢ä½ç½®ï¼š

```java
String s = new String(packet.getData(), packet.getOffset(), packet.getLength(), StandardCharsets.UTF_8);
```

å½“æœåŠ¡å™¨æ”¶åˆ°ä¸€ä¸ª DatagramPacket åï¼Œé€šå¸¸å¿…é¡»ç«‹åˆ»å›å¤ä¸€ä¸ªæˆ–å¤šä¸ª UDP åŒ…ï¼Œå› ä¸ºå®¢æˆ·ç«¯åœ°å€åœ¨ DatagramPacket ä¸­ï¼Œæ¯æ¬¡æ”¶åˆ°çš„ DatagramPacket å¯èƒ½æ˜¯ä¸åŒçš„å®¢æˆ·ç«¯ï¼Œå¦‚æœä¸å›å¤ï¼Œå®¢æˆ·ç«¯å°±æ”¶ä¸åˆ°ä»»ä½• UDP åŒ…ã€‚

å‘é€ UDP åŒ…ä¹Ÿæ˜¯é€šè¿‡ `DatagramPacket` å®ç°çš„ï¼Œå‘é€ä»£ç éå¸¸ç®€å•ï¼š

```java
byte[] data = ...
packet.setData(data);
ds.send(packet);
```

## ğŸ€ å®¢æˆ·ç«¯

å’ŒæœåŠ¡å™¨ç«¯ç›¸æ¯”ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ UDP æ—¶ï¼Œåªéœ€è¦ç›´æ¥å‘æœåŠ¡å™¨ç«¯å‘é€ UDP åŒ…ï¼Œç„¶åæ¥æ”¶è¿”å›çš„ UDP åŒ…ï¼š

```java
DatagramSocket ds = new DatagramSocket();
ds.setSoTimeout(1000);
ds.connect(InetAddress.getByName("localhost"), 6666); // è¿æ¥æŒ‡å®šæœåŠ¡å™¨å’Œç«¯å£
// å‘é€:
byte[] data = "Hello".getBytes();
DatagramPacket packet = new DatagramPacket(data, data.length);
ds.send(packet);
// æ¥æ”¶:
byte[] buffer = new byte[1024];
packet = new DatagramPacket(buffer, buffer.length);
ds.receive(packet);
String resp = new String(packet.getData(), packet.getOffset(), packet.getLength());
ds.disconnect();
// å…³é—­:
ds.close();
```

å®¢æˆ·ç«¯æ‰“å¼€ä¸€ä¸ª `DatagramSocket` ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š

```java
DatagramSocket ds = new DatagramSocket();
ds.setSoTimeout(1000);
ds.connect(InetAddress.getByName("localhost"), 6666);
```

å®¢æˆ·ç«¯åˆ›å»º `DatagramSocket` å®ä¾‹æ—¶å¹¶ä¸éœ€è¦æŒ‡å®šç«¯å£ï¼Œè€Œæ˜¯ç”±æ“ä½œç³»ç»Ÿè‡ªåŠ¨æŒ‡å®šä¸€ä¸ªå½“å‰æœªä½¿ç”¨çš„ç«¯å£ã€‚ç´§æ¥ç€ï¼Œè°ƒç”¨ `setSoTimeout(1000)` è®¾å®šè¶…æ—¶ 1 ç§’ï¼Œæ„æ€æ˜¯åç»­æ¥æ”¶ UDP åŒ…æ—¶ï¼Œç­‰å¾…æ—¶é—´æœ€å¤šä¸ä¼šè¶…è¿‡ 1 ç§’ï¼Œå¦åˆ™åœ¨æ²¡æœ‰æ”¶åˆ° UDP åŒ…æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šæ— é™ç­‰å¾…ä¸‹å»ã€‚è¿™ä¸€ç‚¹å’ŒæœåŠ¡å™¨ç«¯ä¸ä¸€æ ·ï¼ŒæœåŠ¡å™¨ç«¯å¯ä»¥æ— é™ç­‰å¾…ï¼Œå› ä¸ºå®ƒæœ¬æ¥å°±è¢«è®¾è®¡æˆé•¿æ—¶é—´è¿è¡Œã€‚

æ³¨æ„åˆ°å®¢æˆ·ç«¯çš„ `DatagramSocket` è¿˜è°ƒç”¨äº†ä¸€ä¸ª `connect()` æ–¹æ³• â€œè¿æ¥â€ åˆ°æŒ‡å®šçš„æœåŠ¡å™¨ç«¯ã€‚ä¸æ˜¯è¯´ UDP æ˜¯æ— è¿æ¥çš„åè®®å—ï¼Ÿä¸ºå•¥è¿™é‡Œéœ€è¦ `connect()`ï¼Ÿ

è¿™ä¸ª `connect()` æ–¹æ³•ä¸æ˜¯çœŸè¿æ¥ï¼Œå®ƒæ˜¯ä¸ºäº†åœ¨å®¢æˆ·ç«¯çš„ `DatagramSocket` å®ä¾‹ä¸­ä¿å­˜æœåŠ¡å™¨ç«¯çš„ IP å’Œç«¯å£å·ï¼Œç¡®ä¿è¿™ä¸ª `DatagramSocket` å®ä¾‹åªèƒ½å¾€æŒ‡å®šçš„åœ°å€å’Œç«¯å£å‘é€ UDP åŒ…ï¼Œä¸èƒ½å¾€å…¶ä»–åœ°å€å’Œç«¯å£å‘é€ã€‚è¿™ä¹ˆåšä¸æ˜¯ UDP çš„é™åˆ¶ï¼Œè€Œæ˜¯ Java å†…ç½®äº†å®‰å…¨æ£€æŸ¥ã€‚

åç»­çš„æ”¶å‘æ•°æ®å’ŒæœåŠ¡å™¨ç«¯æ˜¯ä¸€è‡´çš„ã€‚é€šå¸¸æ¥è¯´ï¼Œå®¢æˆ·ç«¯å¿…é¡»å…ˆå‘ UDP åŒ…ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¸å‘ UDP åŒ…ï¼ŒæœåŠ¡å™¨ç«¯å°±æ ¹æœ¬ä¸çŸ¥é“å®¢æˆ·ç«¯çš„åœ°å€å’Œç«¯å£å·ã€‚

å¦‚æœå®¢æˆ·ç«¯è®¤ä¸ºé€šä¿¡ç»“æŸï¼Œå°±å¯ä»¥è°ƒç”¨ `disconnect()` æ–­å¼€è¿æ¥ï¼š

```java
ds.disconnect();
```

æ³¨æ„åˆ° `disconnect()` ä¹Ÿä¸æ˜¯çœŸæ­£åœ°æ–­å¼€è¿æ¥ï¼Œå®ƒåªæ˜¯æ¸…é™¤äº†å®¢æˆ·ç«¯ `DatagramSocket` å®ä¾‹è®°å½•çš„è¿œç¨‹æœåŠ¡å™¨åœ°å€å’Œç«¯å£å·ï¼Œè¿™æ ·ï¼Œ`DatagramSocket` å®ä¾‹å°±å¯ä»¥è¿æ¥å¦ä¸€ä¸ªæœåŠ¡å™¨ç«¯ã€‚

å¦‚æœå®¢æˆ·ç«¯å¸Œæœ›å‘ä¸¤ä¸ªä¸åŒçš„æœåŠ¡å™¨å‘é€ UDP åŒ…ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š

1. å®¢æˆ·ç«¯å¯ä»¥åˆ›å»ºä¸¤ä¸ª `DatagramSocket` å®ä¾‹ï¼Œç”¨ `connect()` è¿æ¥åˆ°ä¸åŒçš„æœåŠ¡å™¨ï¼›
2. å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ä¸è°ƒç”¨ `connect()` æ–¹æ³•ï¼Œè€Œæ˜¯åœ¨åˆ›å»º `DatagramPacket` çš„æ—¶å€™æŒ‡å®šæœåŠ¡å™¨åœ°å€ï¼Œè¿™æ ·å¯ä»¥ç”¨ä¸€ä¸ª `DatagramSocket` å®ä¾‹å‘é€ `DatagramPacket` åˆ°ä¸åŒçš„æœåŠ¡å™¨ã€‚

ä¸è°ƒç”¨ `connect()` æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š

```java
DatagramSocket ds = new DatagramSocket();
ds.setSoTimeout(1000);
// å‘é€åˆ° localhost:6666:
byte[] data1 = "Hello".getBytes();
var packet1 = new DatagramPacket(data1, data1.length, InetAddress.getByName("localhost"), 6666);
ds.send(packet1);
// å‘é€åˆ° localhost:8888:
byte[] data2 = "Hi".getBytes();
var packet2 = new DatagramPacket(data2, data2.length, InetAddress.getByName("localhost"), 8888);
ds.send(packet2);
// å…³é—­:
ds.close();
```

## ğŸ€ ç»ƒä¹ 

ä½¿ç”¨ UDP å®ç°æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é€šä¿¡

## ğŸ€ å°ç»“

ä½¿ç”¨ UDP åè®®é€šä¿¡æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åŒæ–¹æ— éœ€å»ºç«‹è¿æ¥ï¼š

- æœåŠ¡å™¨ç«¯ç”¨ `DatagramSocket(port)` ç›‘å¬ç«¯å£ï¼›
- å®¢æˆ·ç«¯ä½¿ç”¨ `DatagramSocket.connect()` æŒ‡å®šè¿œç¨‹åœ°å€å’Œç«¯å£ï¼›
- åŒæ–¹é€šè¿‡ `receive()` å’Œ `send()` è¯»å†™æ•°æ®ï¼›
- `DatagramSocket` æ²¡æœ‰ IO æµæ¥å£ï¼Œæ•°æ®è¢«ç›´æ¥å†™å…¥ `byte[]` ç¼“å†²åŒºã€‚

