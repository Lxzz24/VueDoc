---
title: å‘é€ Email
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

Email å°±æ˜¯ç”µå­é‚®ä»¶ã€‚ç”µå­é‚®ä»¶çš„åº”ç”¨å·²ç»æœ‰å‡ åå¹´çš„å†å²äº†ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„é‚®ç®±åœ°å€æ¯”å¦‚ `abc@example.com`ï¼Œé‚®ä»¶è½¯ä»¶æ¯”å¦‚ Outlook éƒ½æ˜¯ç”¨æ¥æ”¶å‘é‚®ä»¶çš„ã€‚

ä½¿ç”¨ Java ç¨‹åºä¹Ÿå¯ä»¥æ”¶å‘ç”µå­é‚®ä»¶ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä¼ ç»Ÿçš„é‚®ä»¶æ˜¯å¦‚ä½•å‘é€çš„ã€‚

ä¼ ç»Ÿçš„é‚®ä»¶æ˜¯é€šè¿‡é‚®å±€æŠ•é€’ï¼Œç„¶åä»ä¸€ä¸ªé‚®å±€åˆ°å¦ä¸€ä¸ªé‚®å±€ï¼Œæœ€ç»ˆåˆ°è¾¾ç”¨æˆ·çš„é‚®ç®±ï¼š

![](./assets/image-20231219113231503.png =500x)

ç”µå­é‚®ä»¶çš„å‘é€è¿‡ç¨‹ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡æ˜¯ç”µå­é‚®ä»¶æ˜¯ä»ç”¨æˆ·ç”µè„‘çš„é‚®ä»¶è½¯ä»¶ï¼Œä¾‹å¦‚ Outlookï¼Œå‘é€åˆ°é‚®ä»¶æœåŠ¡å™¨ä¸Šï¼Œå¯èƒ½ç»è¿‡è‹¥å¹²ä¸ªé‚®ä»¶æœåŠ¡å™¨çš„ä¸­è½¬ï¼Œæœ€ç»ˆåˆ°è¾¾å¯¹æ–¹é‚®ä»¶æœåŠ¡å™¨ä¸Šï¼Œæ”¶ä»¶æ–¹å°±å¯ä»¥ç”¨è½¯ä»¶æ¥æ”¶é‚®ä»¶ï¼š

![](./assets/image-20231219113254638.png =500x)

- æˆ‘ä»¬æŠŠç±»ä¼¼ Outlook è¿™æ ·çš„é‚®ä»¶è½¯ä»¶ç§°ä¸º **MUA**ï¼šMail User Agentï¼Œæ„æ€æ˜¯ _ç»™ç”¨æˆ·æœåŠ¡çš„é‚®ä»¶ä»£ç†_ï¼›
- é‚®ä»¶æœåŠ¡å™¨åˆ™ç§°ä¸º **MTA**ï¼šMail Transfer Agentï¼Œæ„æ€æ˜¯ _é‚®ä»¶ä¸­è½¬çš„ä»£ç†_ï¼›
- æœ€ç»ˆåˆ°è¾¾çš„é‚®ä»¶æœåŠ¡å™¨ç§°ä¸º **MDA**ï¼šMail Delivery Agentï¼Œæ„æ€æ˜¯ _é‚®ä»¶åˆ°è¾¾çš„ä»£ç†_ã€‚

ç”µå­é‚®ä»¶ä¸€æ—¦åˆ°è¾¾ MDAï¼Œå°±ä¸å†åŠ¨äº†ã€‚å®é™…ä¸Šï¼Œç”µå­é‚®ä»¶é€šå¸¸å°±å­˜å‚¨åœ¨ MDA æœåŠ¡å™¨çš„ç¡¬ç›˜ä¸Šï¼Œç„¶åç­‰æ”¶ä»¶äººé€šè¿‡è½¯ä»¶æˆ–è€…ç™»é™†æµè§ˆå™¨æŸ¥çœ‹é‚®ä»¶ã€‚

MTA å’Œ MDA è¿™æ ·çš„æœåŠ¡å™¨è½¯ä»¶é€šå¸¸æ˜¯ç°æˆçš„ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒè¿™äº›æœåŠ¡å™¨å†…éƒ¨æ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚è¦å‘é€é‚®ä»¶ï¼Œæˆ‘ä»¬å…³å¿ƒçš„æ˜¯å¦‚ä½•ç¼–å†™ä¸€ä¸ª MUA çš„è½¯ä»¶ï¼ŒæŠŠé‚®ä»¶å‘é€åˆ° MTA ä¸Šã€‚

MUA åˆ° MTA å‘é€é‚®ä»¶çš„åè®®å°±æ˜¯ **SMTP åè®®**ï¼Œå®ƒæ˜¯ Simple Mail Transport Protocol çš„ç¼©å†™ï¼Œä½¿ç”¨æ ‡å‡†ç«¯å£ 25ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŠ å¯†ç«¯å£ 465 æˆ– 587ã€‚

SMTP åè®®æ˜¯ä¸€ä¸ªå»ºç«‹åœ¨ TCP ä¹‹ä¸Šçš„åè®®ï¼Œä»»ä½•ç¨‹åºå‘é€é‚®ä»¶éƒ½å¿…é¡»éµå®ˆ SMTP åè®®ã€‚ä½¿ç”¨ Java ç¨‹åºå‘é€é‚®ä»¶æ—¶ï¼Œæˆ‘ä»¬æ— éœ€å…³å¿ƒ SMTP åè®®çš„åº•å±‚åŸç†ï¼Œåªéœ€è¦ä½¿ç”¨ JavaMail è¿™ä¸ªæ ‡å‡† API å°±å¯ä»¥ç›´æ¥å‘é€é‚®ä»¶ã€‚

## ğŸ€ å‡†å¤‡ SMTP ç™»å½•ä¿¡æ¯

å‡è®¾æˆ‘ä»¬å‡†å¤‡ä½¿ç”¨è‡ªå·±çš„é‚®ä»¶åœ°å€ `me@example.com` ç»™å°æ˜å‘é€é‚®ä»¶ï¼Œå·²çŸ¥å°æ˜çš„é‚®ä»¶åœ°å€æ˜¯ `xiaoming@somewhere.com`ï¼Œå‘é€é‚®ä»¶å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦ç¡®å®šä½œä¸º MTA çš„é‚®ä»¶æœåŠ¡å™¨åœ°å€å’Œç«¯å£å·ã€‚é‚®ä»¶æœåŠ¡å™¨åœ°å€é€šå¸¸æ˜¯ `smtp.example.com`ï¼Œç«¯å£å·ç”±é‚®ä»¶æœåŠ¡å•†ç¡®å®šä½¿ç”¨ 25ã€465 è¿˜æ˜¯ 587ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨é‚®ä»¶æœåŠ¡å•†çš„ SMTP ä¿¡æ¯ï¼š

- QQ é‚®ç®±ï¼šSMTP æœåŠ¡å™¨æ˜¯ smtp.qq.comï¼Œç«¯å£æ˜¯ 465/587ï¼›
- 163 é‚®ç®±ï¼šSMTP æœåŠ¡å™¨æ˜¯ smtp.163.comï¼Œç«¯å£æ˜¯ 465ï¼›
- Gmail é‚®ç®±ï¼šSMTP æœåŠ¡å™¨æ˜¯ smtp.gmail.comï¼Œç«¯å£æ˜¯ 465/587ã€‚

æœ‰äº† SMTP æœåŠ¡å™¨çš„åŸŸåå’Œç«¯å£å·ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ SMTP æœåŠ¡å™¨çš„ç™»å½•ä¿¡æ¯ï¼Œé€šå¸¸æ˜¯ä½¿ç”¨è‡ªå·±çš„é‚®ä»¶åœ°å€ä½œä¸ºç”¨æˆ·åï¼Œç™»å½•å£ä»¤æ˜¯ç”¨æˆ·å£ä»¤æˆ–è€…ä¸€ä¸ªç‹¬ç«‹è®¾ç½®çš„ SMTP å£ä»¤ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ JavaMail å‘é€é‚®ä»¶ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª Maven å·¥ç¨‹ï¼Œå¹¶æŠŠ JavaMail ç›¸å…³çš„ä¸¤ä¸ªä¾èµ–åŠ å…¥è¿›æ¥ï¼š

- jakarta.mail:javax.mail-api:2.0.1
- com.sun.mail:jakarta.mail:2.0.1

è¿™ä¸¤ä¸ªåŒ…ä¸€ä¸ªæ˜¯æ¥å£å®šä¹‰ï¼Œä¸€ä¸ªæ˜¯å…·ä½“å®ç°ã€‚å¦‚æœä½¿ç”¨æ—©æœŸçš„ 1.x ç‰ˆæœ¬ï¼Œåˆ™éœ€æ³¨æ„å¼•å…¥çš„åŒ…åæœ‰æ‰€ä¸åŒï¼š

- javax.mail:javax.mail-api:1.6.2
- com.sun.mail:javax.mail:1.6.2

å¹¶ä¸”ä»£ç å¼•ç”¨çš„ `jakarta.mail` éœ€æ›¿æ¢ä¸º `javax.mail`ã€‚

ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡ JavaMail API è¿æ¥åˆ° SMTP æœåŠ¡å™¨ä¸Šï¼š

```java
// æœåŠ¡å™¨åœ°å€:
String smtp = "smtp.office365.com";
// ç™»å½•ç”¨æˆ·å:
String username = "jxsmtp101@outlook.com";
// ç™»å½•å£ä»¤:
String password = "********";
// è¿æ¥åˆ° SMTP æœåŠ¡å™¨ 587 ç«¯å£:
Properties props = new Properties();
props.put("mail.smtp.host", smtp); // SMTP ä¸»æœºå
props.put("mail.smtp.port", "587"); // ä¸»æœºç«¯å£å·
props.put("mail.smtp.auth", "true"); // æ˜¯å¦éœ€è¦ç”¨æˆ·è®¤è¯
props.put("mail.smtp.starttls.enable", "true"); // å¯ç”¨ TLS åŠ å¯†
// è·å– Session å®ä¾‹:
Session session = Session.getInstance(props, new Authenticator() {
    protected PasswordAuthentication getPasswordAuthentication() {
        return new PasswordAuthentication(username, password);
    }
});
// è®¾ç½® debug æ¨¡å¼ä¾¿äºè°ƒè¯•:
session.setDebug(true);
```

ä»¥ 587 ç«¯å£ä¸ºä¾‹ï¼Œè¿æ¥ SMTP æœåŠ¡å™¨æ—¶ï¼Œéœ€è¦å‡†å¤‡ä¸€ä¸ª `Properties` å¯¹è±¡ï¼Œå¡«å…¥ç›¸å…³ä¿¡æ¯ã€‚æœ€åè·å– `Session` å®ä¾‹æ—¶ï¼Œå¦‚æœæœåŠ¡å™¨éœ€è¦è®¤è¯ï¼Œè¿˜éœ€è¦ä¼ å…¥ä¸€ä¸ª `Authenticator` å¯¹è±¡ï¼Œå¹¶è¿”å›æŒ‡å®šçš„ç”¨æˆ·åå’Œå£ä»¤ã€‚

å½“æˆ‘ä»¬è·å–åˆ° `Session` å®ä¾‹åï¼Œæ‰“å¼€è°ƒè¯•æ¨¡å¼å¯ä»¥çœ‹åˆ° SMTP é€šä¿¡çš„è¯¦ç»†å†…å®¹ï¼Œä¾¿äºè°ƒè¯•ã€‚

## ğŸ€ å‘é€é‚®ä»¶

å‘é€é‚®ä»¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ª `Message` å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ `Transport.send(Message)` å³å¯å®Œæˆå‘é€ï¼š

```java
MimeMessage message = new MimeMessage(session);
// è®¾ç½®å‘é€æ–¹åœ°å€:
message.setFrom(new InternetAddress("me@example.com"));
// è®¾ç½®æ¥æ”¶æ–¹åœ°å€:
message.setRecipient(Message.RecipientType.TO, new InternetAddress("xiaoming@somewhere.com"));
// è®¾ç½®é‚®ä»¶ä¸»é¢˜:
message.setSubject("Hello", "UTF-8");
// è®¾ç½®é‚®ä»¶æ­£æ–‡:
message.setText("Hi Xiaoming...", "UTF-8");
// å‘é€:
Transport.send(message);
```

ç»å¤§å¤šæ•°é‚®ä»¶æœåŠ¡å™¨è¦æ±‚å‘é€æ–¹åœ°å€å’Œç™»å½•ç”¨æˆ·åå¿…é¡»ä¸€è‡´ï¼Œå¦åˆ™å‘é€å°†å¤±è´¥ã€‚

å¡«å…¥çœŸå®çš„åœ°å€ï¼Œè¿è¡Œä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ° JavaMail æ‰“å°çš„è°ƒè¯•ä¿¡æ¯ï¼š

```sh
è¿™æ˜¯ JavaMail æ‰“å°çš„è°ƒè¯•ä¿¡æ¯:
DEBUG: setDebug: JavaMail version 1.6.2
DEBUG: getProvider() returning javax.mail.Provider[TRANSPORT,smtp,com.sun.mail.smtp.SMTPTransport,Oracle]
DEBUG SMTP: need username and password for authentication
DEBUG SMTP: protocolConnect returning false, host=smtp.office365.com, ...
DEBUG SMTP: useEhlo true, useAuth true
å¼€å§‹å°è¯•è¿æ¥ smtp.office365.com:
DEBUG SMTP: trying to connect to host "smtp.office365.com", port 587, ...
DEBUG SMTP: connected to host "smtp.office365.com", port: 587
å‘é€å‘½ä»¤ EHLO:
EHLO localhost
SMTP æœåŠ¡å™¨å“åº” 250:
250-SG3P274CA0024.outlook.office365.com Hello
250-SIZE 157286400
...
DEBUG SMTP: Found extension "SIZE", arg "157286400"
å‘é€å‘½ä»¤ STARTTLS:
STARTTLS
SMTP æœåŠ¡å™¨å“åº” 220:
220 2.0.0 SMTP server ready
EHLO localhost
250-SG3P274CA0024.outlook.office365.com Hello [111.196.164.63]
250-SIZE 157286400
250-PIPELINING
250-...
DEBUG SMTP: Found extension "SIZE", arg "157286400"
...
å°è¯•ç™»å½•:
DEBUG SMTP: protocolConnect login, host=smtp.office365.com, user=********, password=********
DEBUG SMTP: Attempt to authenticate using mechanisms: LOGIN PLAIN DIGEST-MD5 NTLM XOAUTH2
DEBUG SMTP: Using mechanism LOGIN
DEBUG SMTP: AUTH LOGIN command trace suppressed
ç™»å½•æˆåŠŸ:
DEBUG SMTP: AUTH LOGIN succeeded
DEBUG SMTP: use8bit false
å¼€å‘å‘é€é‚®ä»¶ï¼Œè®¾ç½® FROM:
MAIL FROM:<********@outlook.com>
250 2.1.0 Sender OK
è®¾ç½® TO:
RCPT TO:<********@sina.com>
250 2.1.5 Recipient OK
å‘é€é‚®ä»¶æ•°æ®:
DATA
æœåŠ¡å™¨å“åº” 354:
354 Start mail input; end with <CRLF>.<CRLF>
çœŸæ­£çš„é‚®ä»¶æ•°æ®:
Date: Mon, 2 Dec 2019 09:37:52 +0800 (CST)
From: ********@outlook.com
To: ********001@sina.com
Message-ID: <1617791695.0.1575250672483@localhost>
é‚®ä»¶ä¸»é¢˜æ˜¯ç¼–ç åçš„æ–‡æœ¬:
Subject: =?UTF-8?Q?JavaMail=E9=82=AE=E4=BB=B6?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: base64

é‚®ä»¶æ­£æ–‡æ˜¯ Base64 ç¼–ç çš„æ–‡æœ¬:
SGVsbG8sIOi/meaYr+S4gOWwgeadpeiHqmphdmFtYWls55qE6YKu5Lu277yB
.
é‚®ä»¶æ•°æ®å‘é€å®Œæˆåï¼Œä»¥ \ r\n.\r\n ç»“æŸï¼ŒæœåŠ¡å™¨å“åº” 250 è¡¨ç¤ºå‘é€æˆåŠŸ:
250 2.0.0 OK <HK0PR03MB4961.apcprd03.prod.outlook.com> [Hostname=HK0PR03MB4961.apcprd03.prod.outlook.com]
DEBUG SMTP: message successfully delivered to mail server
å‘é€ QUIT å‘½ä»¤:
QUIT
æœåŠ¡å™¨å“åº” 221 ç»“æŸ TCP è¿æ¥:
221 2.0.0 Service closing transmission channel
```

ä»ä¸Šé¢çš„è°ƒè¯•ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼ŒSMTP åè®®æ˜¯ä¸€ä¸ªè¯·æ±‚-å“åº”åè®®ï¼Œå®¢æˆ·ç«¯æ€»æ˜¯å‘é€å‘½ä»¤ï¼Œç„¶åç­‰å¾…æœåŠ¡å™¨å“åº”ã€‚æœåŠ¡å™¨å“åº”æ€»æ˜¯ä»¥æ•°å­—å¼€å¤´ï¼Œåé¢çš„ä¿¡æ¯æ‰æ˜¯ç”¨äºè°ƒè¯•çš„æ–‡æœ¬ã€‚è¿™äº›å“åº”ç å·²ç»è¢«å®šä¹‰åœ¨ [SMTP åè®®](https://www.iana.org/assignments/smtp-enhanced-status-codes/smtp-enhanced-status-codes.txt) ä¸­äº†ï¼ŒæŸ¥çœ‹å…·ä½“çš„å“åº”ç å°±å¯ä»¥çŸ¥é“å‡ºé”™åŸå› ã€‚

å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œå¯¹æ–¹å°†æ”¶åˆ°ä¸€å°æ–‡æœ¬æ ¼å¼çš„ç”µå­é‚®ä»¶ï¼š

![](./assets/l-20231219113112750.png)

## ğŸ€ å‘é€ HTML é‚®ä»¶

å‘é€ HTML é‚®ä»¶å’Œæ–‡æœ¬é‚®ä»¶æ˜¯ç±»ä¼¼çš„ï¼Œåªéœ€è¦æŠŠï¼š

```java
message.setText(body, "UTF-8");
```

æ”¹ä¸ºï¼š

```java
message.setText(body, "UTF-8", "html");
```

ä¼ å…¥çš„ `body` æ˜¯ç±»ä¼¼ `<h1>Hello</h1><p>Hi, xxx</p>` è¿™æ ·çš„ HTML å­—ç¬¦ä¸²å³å¯ã€‚

HTML é‚®ä»¶å¯ä»¥åœ¨é‚®ä»¶å®¢æˆ·ç«¯ç›´æ¥æ˜¾ç¤ºä¸ºç½‘é¡µæ ¼å¼ï¼š

![](./assets/l-20231219113112844.png)

## ğŸ€ å‘é€é™„ä»¶

è¦åœ¨ç”µå­é‚®ä»¶ä¸­æºå¸¦é™„ä»¶ï¼Œæˆ‘ä»¬å°±ä¸èƒ½ç›´æ¥è°ƒç”¨ `message.setText()` æ–¹æ³•ï¼Œè€Œæ˜¯è¦æ„é€ ä¸€ä¸ª `Multipart` å¯¹è±¡ï¼š

```java
Multipart multipart = new MimeMultipart();
// æ·»åŠ  text:
BodyPart textpart = new MimeBodyPart();
textpart.setContent(body, "text/html;charset=utf-8");
multipart.addBodyPart(textpart);
// æ·»åŠ  image:
BodyPart imagepart = new MimeBodyPart();
imagepart.setFileName(fileName);
imagepart.setDataHandler(new DataHandler(new ByteArrayDataSource(input, "application/octet-stream")));
multipart.addBodyPart(imagepart);
// è®¾ç½®é‚®ä»¶å†…å®¹ä¸º multipart:
message.setContent(multipart);
```

ä¸€ä¸ª `Multipart` å¯¹è±¡å¯ä»¥æ·»åŠ è‹¥å¹²ä¸ª `BodyPart`ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ª `BodyPart` æ˜¯æ–‡æœ¬ï¼Œå³é‚®ä»¶æ­£æ–‡ï¼Œåé¢çš„ BodyPart æ˜¯é™„ä»¶ã€‚`BodyPart` ä¾é  `setContent()` å†³å®šæ·»åŠ çš„å†…å®¹ï¼Œå¦‚æœæ·»åŠ æ–‡æœ¬ï¼Œç”¨ `setContent("...", "text/plain;charset=utf-8")` æ·»åŠ çº¯æ–‡æœ¬ï¼Œæˆ–è€…ç”¨ `setContent("...", "text/html;charset=utf-8")` æ·»åŠ  HTML æ–‡æœ¬ã€‚å¦‚æœæ·»åŠ é™„ä»¶ï¼Œéœ€è¦è®¾ç½®æ–‡ä»¶åï¼ˆä¸ä¸€å®šå’ŒçœŸå®æ–‡ä»¶åä¸€è‡´ï¼‰ï¼Œå¹¶ä¸”æ·»åŠ ä¸€ä¸ª `DataHandler()`ï¼Œä¼ å…¥æ–‡ä»¶çš„ MIME ç±»å‹ã€‚äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥ç”¨ `application/octet-stream`ï¼ŒWord æ–‡æ¡£åˆ™æ˜¯ `application/msword`ã€‚

æœ€åï¼Œé€šè¿‡ `setContent()` æŠŠ `Multipart` æ·»åŠ åˆ° `Message` ä¸­ï¼Œå³å¯å‘é€ã€‚

å¸¦é™„ä»¶çš„é‚®ä»¶åœ¨å®¢æˆ·ç«¯ä¼šè¢«æç¤ºä¸‹è½½ï¼š

![](./assets/l-20231219113112812.png)

## ğŸ€ å‘é€å†…åµŒå›¾ç‰‡çš„ HTML é‚®ä»¶

æœ‰äº›ç«¥é‹å¯èƒ½æ³¨æ„åˆ°ï¼ŒHTML é‚®ä»¶ä¸­å¯ä»¥å†…åµŒå›¾ç‰‡ï¼Œè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿ

å¦‚æœç»™ä¸€ä¸ª `<img src="http://example.com/test.jpg">`ï¼Œè¿™æ ·çš„å¤–éƒ¨å›¾ç‰‡é“¾æ¥é€šå¸¸ä¼šè¢«é‚®ä»¶å®¢æˆ·ç«¯è¿‡æ»¤ï¼Œå¹¶æç¤ºç”¨æˆ·æ˜¾ç¤ºå›¾ç‰‡å¹¶ä¸å®‰å…¨ã€‚åªæœ‰å†…åµŒçš„å›¾ç‰‡æ‰èƒ½æ­£å¸¸åœ¨é‚®ä»¶ä¸­æ˜¾ç¤ºã€‚

å†…åµŒå›¾ç‰‡å®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªé™„ä»¶ï¼Œå³é‚®ä»¶æœ¬èº«ä¹Ÿæ˜¯ `Multipart`ï¼Œä½†éœ€è¦åšä¸€ç‚¹é¢å¤–çš„å¤„ç†ï¼š

```java
Multipart multipart = new MimeMultipart();
// æ·»åŠ  text:
BodyPart textpart = new MimeBodyPart();
textpart.setContent("<h1>Hello</h1><p><img src=\"cid:img01\"></p>", "text/html;charset=utf-8");
multipart.addBodyPart(textpart);
// æ·»åŠ  image:
BodyPart imagepart = new MimeBodyPart();
imagepart.setFileName(fileName);
imagepart.setDataHandler(new DataHandler(new ByteArrayDataSource(input, "image/jpeg")));
// ä¸ HTML çš„ <img src="cid:img01"> å…³è”:
imagepart.setHeader("Content-ID", "<img01>");
multipart.addBodyPart(imagepart);
```

åœ¨ HTML é‚®ä»¶ä¸­å¼•ç”¨å›¾ç‰‡æ—¶ï¼Œéœ€è¦è®¾å®šä¸€ä¸ª IDï¼Œç”¨ç±»ä¼¼ `<img src=\"cid:img01\">` å¼•ç”¨ï¼Œç„¶åï¼Œåœ¨æ·»åŠ å›¾ç‰‡ä½œä¸º BodyPart æ—¶ï¼Œé™¤äº†è¦æ­£ç¡®è®¾ç½® MIME ç±»å‹ï¼ˆæ ¹æ®å›¾ç‰‡ç±»å‹ä½¿ç”¨ `image/jpeg` æˆ– `image/png`ï¼‰ï¼Œè¿˜éœ€è¦è®¾ç½®ä¸€ä¸ª Headerï¼š

```java
imagepart.setHeader("Content-ID", "<img01>");
```

è¿™ä¸ª ID å’Œ HTML ä¸­å¼•ç”¨çš„ ID å¯¹åº”èµ·æ¥ï¼Œé‚®ä»¶å®¢æˆ·ç«¯å°±å¯ä»¥æ­£å¸¸æ˜¾ç¤ºå†…åµŒå›¾ç‰‡ï¼š

![](./assets/l-20231219113112877.png)

## ğŸ€ å¸¸è§é—®é¢˜

å¦‚æœç”¨æˆ·åæˆ–å£ä»¤é”™è¯¯ï¼Œä¼šå¯¼è‡´ `535` ç™»å½•å¤±è´¥ï¼š

```sh
DEBUG SMTP: AUTH LOGIN failed
Exception in thread "main" javax.mail.AuthenticationFailedException: 535 5.7.3 Authentication unsuccessful [HK0PR03CA0105.apcprd03.prod.outlook.com]
```

å¦‚æœç™»å½•ç”¨æˆ·å’Œå‘ä»¶äººä¸ä¸€è‡´ï¼Œä¼šå¯¼è‡´ `554` æ‹’ç»å‘é€é”™è¯¯ï¼š

```sh
DEBUG SMTP: MessagingException while sending, THROW:
com.sun.mail.smtp.SMTPSendFailedException: 554 5.2.0 STOREDRV.Submission.Exception:SendAsDeniedException.MapiExceptionSendAsDenied;
```

æœ‰äº›æ—¶å€™ï¼Œå¦‚æœé‚®ä»¶ä¸»é¢˜å’Œæ­£æ–‡è¿‡äºç®€å•ï¼Œä¼šå¯¼è‡´ `554` è¢«è¯†åˆ«ä¸ºåƒåœ¾é‚®ä»¶çš„é”™è¯¯ï¼š

```sh
DEBUG SMTP: MessagingException while sending, THROW:
com.sun.mail.smtp.SMTPSendFailedException: 554 DT:SPM
```

## ğŸ€ ç»ƒä¹ 

ä½¿ç”¨ SMTP å‘é€é‚®ä»¶

## ğŸ€ å°ç»“

- ä½¿ç”¨ JavaMail API å‘é€é‚®ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª MUA è½¯ä»¶é€šè¿‡ SMTP åè®®å‘é€é‚®ä»¶è‡³ MTA æœåŠ¡å™¨ï¼›

- æ‰“å¼€è°ƒè¯•æ¨¡å¼å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„ SMTP äº¤äº’ä¿¡æ¯ï¼›

- æŸäº›é‚®ä»¶æœåŠ¡å•†éœ€è¦å¼€å¯ SMTPï¼Œå¹¶éœ€è¦ç‹¬ç«‹çš„ SMTP ç™»å½•å¯†ç ã€‚

