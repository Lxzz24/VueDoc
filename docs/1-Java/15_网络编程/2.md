---
title: TCP ç¼–ç¨‹
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::


åœ¨å¼€å‘ç½‘ç»œåº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆä¼šé‡åˆ° Socket è¿™ä¸ªæ¦‚å¿µã€‚Socket æ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºé€šè¿‡ä¸€ä¸ª Socket æ¥å»ºç«‹ä¸€ä¸ªè¿œç¨‹è¿æ¥ï¼Œè€Œ Socket å†…éƒ¨é€šè¿‡ TCP/IP åè®®æŠŠæ•°æ®ä¼ è¾“åˆ°ç½‘ç»œï¼š

![image-20231219105723473](./assets/image-20231219105723473.png)

Socketã€TCP å’Œéƒ¨åˆ† IP çš„åŠŸèƒ½éƒ½æ˜¯ç”±æ“ä½œç³»ç»Ÿæä¾›çš„ï¼Œä¸åŒçš„ç¼–ç¨‹è¯­è¨€åªæ˜¯æä¾›äº†å¯¹æ“ä½œç³»ç»Ÿè°ƒç”¨çš„ç®€å•çš„å°è£…ã€‚ä¾‹å¦‚ï¼ŒJava æä¾›çš„å‡ ä¸ª Socket ç›¸å…³çš„ç±»å°±å°è£…äº†æ“ä½œç³»ç»Ÿæä¾›çš„æ¥å£ã€‚

*ä¸ºä»€ä¹ˆéœ€è¦ Socket è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Ÿ* 

> å› ä¸ºä»…ä»…é€šè¿‡ IP åœ°å€è¿›è¡Œé€šä¿¡æ˜¯ä¸å¤Ÿçš„ï¼ŒåŒä¸€å°è®¡ç®—æœºåŒä¸€æ—¶é—´ä¼šè¿è¡Œå¤šä¸ªç½‘ç»œåº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚æµè§ˆå™¨ã€QQã€é‚®ä»¶å®¢æˆ·ç«¯ç­‰ã€‚å½“æ“ä½œç³»ç»Ÿæ¥æ”¶åˆ°ä¸€ä¸ªæ•°æ®åŒ…çš„æ—¶å€™ï¼Œå¦‚æœåªæœ‰ IP åœ°å€ï¼Œå®ƒæ²¡æ³•åˆ¤æ–­åº”è¯¥å‘ç»™å“ªä¸ªåº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥ï¼Œæ“ä½œç³»ç»ŸæŠ½è±¡å‡º Socket æ¥å£ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºéœ€è¦å„è‡ªå¯¹åº”åˆ°ä¸åŒçš„ Socketï¼Œæ•°æ®åŒ…æ‰èƒ½æ ¹æ® Socket æ­£ç¡®åœ°å‘åˆ°å¯¹åº”çš„åº”ç”¨ç¨‹åºã€‚

ä¸€ä¸ª Socket å°±æ˜¯ç”± IP åœ°å€å’Œç«¯å£å·ï¼ˆèŒƒå›´æ˜¯ 0ï½65535ï¼‰ç»„æˆï¼Œå¯ä»¥æŠŠ Socket ç®€å•ç†è§£ä¸º IP åœ°å€åŠ ç«¯å£å·ã€‚ç«¯å£å·æ€»æ˜¯ç”±æ“ä½œç³»ç»Ÿåˆ†é…ï¼Œå®ƒæ˜¯ä¸€ä¸ª 0ï½65535 ä¹‹é—´çš„æ•°å­—ï¼Œå…¶ä¸­ï¼Œå°äº 1024 çš„ç«¯å£å±äº *ç‰¹æƒç«¯å£*ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œå¤§äº 1024 çš„ç«¯å£å¯ä»¥ç”±ä»»æ„ç”¨æˆ·çš„åº”ç”¨ç¨‹åºæ‰“å¼€ã€‚

![image-20231219110607652](./assets/image-20231219110607652.png)

ä½¿ç”¨ Socket è¿›è¡Œç½‘ç»œç¼–ç¨‹æ—¶ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„ç½‘ç»œé€šä¿¡ã€‚å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹å¿…é¡»å……å½“æœåŠ¡å™¨ç«¯ï¼Œå®ƒä¼šä¸»åŠ¨ç›‘å¬æŸä¸ªæŒ‡å®šçš„ç«¯å£ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹å¿…é¡»å……å½“å®¢æˆ·ç«¯ï¼Œå®ƒå¿…é¡»ä¸»åŠ¨è¿æ¥æœåŠ¡å™¨çš„ IP åœ°å€å’ŒæŒ‡å®šç«¯å£ï¼Œå¦‚æœè¿æ¥æˆåŠŸï¼ŒæœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯å°±æˆåŠŸåœ°å»ºç«‹äº†ä¸€ä¸ª TCP è¿æ¥ï¼ŒåŒæ–¹åç»­å°±å¯ä»¥éšæ—¶å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚

å› æ­¤ï¼Œå½“ Socket è¿æ¥æˆåŠŸåœ°åœ¨æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´å»ºç«‹åï¼š

- å¯¹æœåŠ¡å™¨ç«¯æ¥è¯´ï¼Œå®ƒçš„ Socket æ˜¯æŒ‡å®šçš„ IP åœ°å€å’ŒæŒ‡å®šçš„ç«¯å£å·ï¼›
- å¯¹å®¢æˆ·ç«¯æ¥è¯´ï¼Œå®ƒçš„ Socket æ˜¯å®ƒæ‰€åœ¨è®¡ç®—æœºçš„ IP åœ°å€å’Œä¸€ä¸ªç”±æ“ä½œç³»ç»Ÿåˆ†é…çš„éšæœºç«¯å£å·ã€‚

## ğŸ€ æœåŠ¡å™¨ç«¯

è¦ä½¿ç”¨ Socket ç¼–ç¨‹ï¼Œæˆ‘ä»¬é¦–å…ˆè¦ç¼–å†™æœåŠ¡å™¨ç«¯ç¨‹åºã€‚Java æ ‡å‡†åº“æä¾›äº† `ServerSocket` æ¥å®ç°å¯¹æŒ‡å®š IP å’ŒæŒ‡å®šç«¯å£çš„ç›‘å¬ã€‚`ServerSocket` çš„å…¸å‹å®ç°ä»£ç å¦‚ä¸‹ï¼š

```java
public class Server {
    public static void main(String[] args) throws IOException {
        ServerSocket ss = new ServerSocket(6666); // ç›‘å¬æŒ‡å®šç«¯å£
        System.out.println("server is running...");
        for (;;) {
            Socket sock = ss.accept();
            System.out.println("connected from" + sock.getRemoteSocketAddress());
            Thread t = new Handler(sock);
            t.start();
        }
    }
}

class Handler extends Thread {
    Socket sock;

    public Handler(Socket sock) {
        this.sock = sock;
    }

    @Override
    public void run() {
        try (InputStream input = this.sock.getInputStream()) {
            try (OutputStream output = this.sock.getOutputStream()) {
                handle(input, output);
            }
        } catch (Exception e) {
            try {
                this.sock.close();
            } catch (IOException ioe) {
            }
            System.out.println("client disconnected.");
        }
    }

    private void handle(InputStream input, OutputStream output) throws IOException {
        var writer = new BufferedWriter(new OutputStreamWriter(output, StandardCharsets.UTF_8));
        var reader = new BufferedReader(new InputStreamReader(input, StandardCharsets.UTF_8));
        writer.write("hello\n");
        writer.flush();
        for (;;) {
            String s = reader.readLine();
            if (s.equals("bye")) {
                writer.write("bye\n");
                writer.flush();
                break;
            }
            writer.write("ok:" + s + "\n");
            writer.flush();
        }
    }
}
```

æœåŠ¡å™¨ç«¯é€šè¿‡ä»£ç ï¼š

```java
ServerSocket ss = new ServerSocket(6666);
```

åœ¨æŒ‡å®šç«¯å£ `6666` ç›‘å¬ã€‚è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰æŒ‡å®š IP åœ°å€ï¼Œè¡¨ç¤ºåœ¨è®¡ç®—æœºçš„æ‰€æœ‰ç½‘ç»œæ¥å£ä¸Šè¿›è¡Œç›‘å¬ã€‚

å¦‚æœ `ServerSocket` ç›‘å¬æˆåŠŸï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ä¸€ä¸ªæ— é™å¾ªç¯æ¥å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥ï¼š

```java
for (;;) {
    Socket sock = ss.accept();
    Thread t = new Handler(sock);
    t.start();
}
```

æ³¨æ„åˆ°ä»£ç  `ss.accept()` è¡¨ç¤ºæ¯å½“æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¿›æ¥åï¼Œå°±è¿”å›ä¸€ä¸ª `Socket` å®ä¾‹ï¼Œè¿™ä¸ª `Socket` å®ä¾‹å°±æ˜¯ç”¨æ¥å’Œåˆšè¿æ¥çš„å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡çš„ã€‚ç”±äºå®¢æˆ·ç«¯å¾ˆå¤šï¼Œè¦å®ç°å¹¶å‘å¤„ç†ï¼Œæˆ‘ä»¬å°±å¿…é¡»ä¸ºæ¯ä¸ªæ–°çš„ `Socket` åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥å¤„ç†ï¼Œè¿™æ ·ï¼Œä¸»çº¿ç¨‹çš„ä½œç”¨å°±æ˜¯æ¥æ”¶æ–°çš„è¿æ¥ï¼Œæ¯å½“æ”¶åˆ°æ–°è¿æ¥åï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹è¿›è¡Œå¤„ç†ã€‚

æˆ‘ä»¬åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹çš„ç« èŠ‚ä¸­ä»‹ç»è¿‡çº¿ç¨‹æ± ï¼Œè¿™é‡Œä¹Ÿå®Œå…¨å¯ä»¥åˆ©ç”¨çº¿ç¨‹æ± æ¥å¤„ç†å®¢æˆ·ç«¯è¿æ¥ï¼Œèƒ½å¤§å¤§æé«˜è¿è¡Œæ•ˆç‡ã€‚

å¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥è¿›æ¥ï¼Œ`accept()` æ–¹æ³•ä¼šé˜»å¡å¹¶ä¸€ç›´ç­‰å¾…ã€‚å¦‚æœæœ‰å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥è¿›æ¥ï¼Œ`ServerSocket` ä¼šæŠŠè¿æ¥æ‰”åˆ°é˜Ÿåˆ—é‡Œï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªå¤„ç†ã€‚å¯¹äº Java ç¨‹åºè€Œè¨€ï¼Œåªéœ€è¦é€šè¿‡å¾ªç¯ä¸æ–­è°ƒç”¨ `accept()` å°±å¯ä»¥è·å–æ–°çš„è¿æ¥ã€‚

## ğŸ€ å®¢æˆ·ç«¯

ç›¸æ¯”æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯ç¨‹åºå°±è¦ç®€å•å¾ˆå¤šã€‚ä¸€ä¸ªå…¸å‹çš„å®¢æˆ·ç«¯ç¨‹åºå¦‚ä¸‹ï¼š

```java
public class Client {
    public static void main(String[] args) throws IOException {
        Socket sock = new Socket("localhost", 6666); // è¿æ¥æŒ‡å®šæœåŠ¡å™¨å’Œç«¯å£
        try (InputStream input = sock.getInputStream()) {
            try (OutputStream output = sock.getOutputStream()) {
                handle(input, output);
            }
        }
        sock.close();
        System.out.println("disconnected.");
    }

    private static void handle(InputStream input, OutputStream output) throws IOException {
        var writer = new BufferedWriter(new OutputStreamWriter(output, StandardCharsets.UTF_8));
        var reader = new BufferedReader(new InputStreamReader(input, StandardCharsets.UTF_8));
        Scanner scanner = new Scanner(System.in);
        System.out.println("[server]" + reader.readLine());
        for (;;) {
            System.out.print(">>>"); // æ‰“å°æç¤º
            String s = scanner.nextLine(); // è¯»å–ä¸€è¡Œè¾“å…¥
            writer.write(s);
            writer.newLine();
            writer.flush();
            String resp = reader.readLine();
            System.out.println("<<<" + resp);
            if (resp.equals("bye")) {
                break;
            }
        }
    }
}
```

å®¢æˆ·ç«¯ç¨‹åºé€šè¿‡ï¼š

```java
Socket sock = new Socket("localhost", 6666);
```

è¿æ¥åˆ°æœåŠ¡å™¨ç«¯ï¼Œæ³¨æ„ä¸Šè¿°ä»£ç çš„æœåŠ¡å™¨åœ°å€æ˜¯ `"localhost"`ï¼Œè¡¨ç¤ºæœ¬æœºåœ°å€ï¼Œç«¯å£å·æ˜¯ `6666`ã€‚å¦‚æœè¿æ¥æˆåŠŸï¼Œå°†è¿”å›ä¸€ä¸ª `Socket` å®ä¾‹ï¼Œç”¨äºåç»­é€šä¿¡ã€‚

## ğŸ€ Socket æµ

å½“ Socket è¿æ¥åˆ›å»ºæˆåŠŸåï¼Œæ— è®ºæ˜¯æœåŠ¡å™¨ç«¯ï¼Œè¿˜æ˜¯å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬éƒ½ä½¿ç”¨ `Socket` å®ä¾‹è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚å› ä¸º TCP æ˜¯ä¸€ç§åŸºäºæµçš„åè®®ï¼Œå› æ­¤ï¼ŒJava æ ‡å‡†åº“ä½¿ç”¨ `InputStream` å’Œ `OutputStream` æ¥å°è£… Socket çš„æ•°æ®æµï¼Œè¿™æ ·æˆ‘ä»¬ä½¿ç”¨ Socket çš„æµï¼Œå’Œæ™®é€š IO æµç±»ä¼¼ï¼š

```java
// ç”¨äºè¯»å–ç½‘ç»œæ•°æ®:
InputStream in = sock.getInputStream();
// ç”¨äºå†™å…¥ç½‘ç»œæ•°æ®:
OutputStream out = sock.getOutputStream();
```

æœ€åæˆ‘ä»¬é‡ç‚¹æ¥çœ‹çœ‹ï¼Œä¸ºä»€ä¹ˆå†™å…¥ç½‘ç»œæ•°æ®æ—¶ï¼Œè¦è°ƒç”¨ `flush()` æ–¹æ³•ã€‚

å¦‚æœä¸è°ƒç”¨ `flush()`ï¼Œæˆ‘ä»¬å¾ˆå¯èƒ½ä¼šå‘ç°ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½æ”¶ä¸åˆ°æ•°æ®ï¼Œè¿™å¹¶ä¸æ˜¯ Java æ ‡å‡†åº“çš„è®¾è®¡é—®é¢˜ï¼Œè€Œæ˜¯æˆ‘ä»¬ä»¥æµçš„å½¢å¼å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ä¸€å†™å…¥å°±ç«‹åˆ»å‘é€åˆ°ç½‘ç»œï¼Œè€Œæ˜¯å…ˆå†™å…¥å†…å­˜ç¼“å†²åŒºï¼Œç›´åˆ°ç¼“å†²åŒºæ»¡äº†ä»¥åï¼Œæ‰ä¼šä¸€æ¬¡æ€§çœŸæ­£å‘é€åˆ°ç½‘ç»œï¼Œè¿™æ ·è®¾è®¡çš„ç›®çš„æ˜¯ä¸ºäº†æé«˜ä¼ è¾“æ•ˆç‡ã€‚å¦‚æœç¼“å†²åŒºçš„æ•°æ®å¾ˆå°‘ï¼Œè€Œæˆ‘ä»¬åˆæƒ³å¼ºåˆ¶æŠŠè¿™äº›æ•°æ®å‘é€åˆ°ç½‘ç»œï¼Œå°±å¿…é¡»è°ƒç”¨ `flush()` å¼ºåˆ¶æŠŠç¼“å†²åŒºæ•°æ®å‘é€å‡ºå»ã€‚

## ğŸ€ ç»ƒä¹ 

ä½¿ç”¨ Socket å®ç°æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é€šä¿¡

## ğŸ€ å°ç»“

ä½¿ç”¨ Java è¿›è¡Œ TCP ç¼–ç¨‹æ—¶ï¼Œéœ€è¦ä½¿ç”¨ Socket æ¨¡å‹ï¼š

- æœåŠ¡å™¨ç«¯ç”¨ `ServerSocket` ç›‘å¬æŒ‡å®šç«¯å£ï¼›
- å®¢æˆ·ç«¯ä½¿ç”¨ `Socket(InetAddress, port)` è¿æ¥æœåŠ¡å™¨ï¼›
- æœåŠ¡å™¨ç«¯ç”¨ `accept()` æ¥æ”¶è¿æ¥å¹¶è¿”å› `Socket`ï¼›
- åŒæ–¹é€šè¿‡ `Socket` æ‰“å¼€ `InputStream`/`OutputStream` è¯»å†™æ•°æ®ï¼›
- æœåŠ¡å™¨ç«¯é€šå¸¸ä½¿ç”¨å¤šçº¿ç¨‹åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œåˆ©ç”¨çº¿ç¨‹æ± å¯å¤§å¹…æå‡æ•ˆç‡ï¼›
- `flush()` ç”¨äºå¼ºåˆ¶è¾“å‡ºç¼“å†²åŒºåˆ°ç½‘ç»œã€‚


