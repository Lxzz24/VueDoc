---
title: æ¨¡æ¿æ–¹æ³•
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---


> å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ï¼Œä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æ„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚

æ¨¡æ¿æ–¹æ³•ï¼ˆTemplate Methodï¼‰æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ¨¡å¼ã€‚å®ƒçš„ä¸»è¦æ€æƒ³æ˜¯ï¼Œå®šä¹‰ä¸€ä¸ªæ“ä½œçš„ä¸€ç³»åˆ—æ­¥éª¤ï¼Œå¯¹äºæŸäº›æš‚æ—¶ç¡®å®šä¸ä¸‹æ¥çš„æ­¥éª¤ï¼Œå°±ç•™ç»™å­ç±»å»å®ç°å¥½äº†ï¼Œè¿™æ ·ä¸åŒçš„å­ç±»å°±å¯ä»¥å®šä¹‰å‡ºä¸åŒçš„æ­¥éª¤ã€‚

å› æ­¤ï¼Œæ¨¡æ¿æ–¹æ³•çš„æ ¸å¿ƒåœ¨äºå®šä¹‰ä¸€ä¸ª â€œéª¨æ¶â€ã€‚æˆ‘ä»¬è¿˜æ˜¯ä¸¾ä¾‹è¯´æ˜ã€‚

å‡è®¾æˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªä»æ•°æ®åº“è¯»å–è®¾ç½®çš„ç±»ï¼š

```java
public class Setting {
    public final String getSetting(String key) {
        String value = readFromDatabase(key);
        return value;
    }

	private String readFromDatabase(String key) {
        // TODO: ä»æ•°æ®åº“è¯»å–
    }
}
```

ç”±äºä»æ•°æ®åº“è¯»å–æ•°æ®è¾ƒæ…¢ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠè¯»å–çš„è®¾ç½®ç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡è¯»å–åŒæ ·çš„ key å°±ä¸å¿…å†è®¿é—®æ•°æ®åº“äº†ã€‚ä½†æ˜¯æ€ä¹ˆå®ç°ç¼“å­˜ï¼Œæš‚æ—¶æ²¡æƒ³å¥½ï¼Œä½†ä¸å¦¨ç¢æˆ‘ä»¬å…ˆå†™å‡ºä½¿ç”¨ç¼“å­˜çš„ä»£ç ï¼š

```java
public class Setting {
    public final String getSetting(String key) {
        // å…ˆä»ç¼“å­˜è¯»å–:
        String value = lookupCache(key);
        if (value == null) {
            // åœ¨ç¼“å­˜ä¸­æœªæ‰¾åˆ°, ä»æ•°æ®åº“è¯»å–:
            value = readFromDatabase(key);
            System.out.println("[DEBUG] load from db:" + key + "=" + value);
            // æ”¾å…¥ç¼“å­˜:
            putIntoCache(key, value);
        } else {
            System.out.println("[DEBUG] load from cache:" + key + "=" + value);
        }
        return value;
    }
}
```

æ•´ä¸ªæµç¨‹æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ï¼Œ`lookupCache(key)` å’Œ `putIntoCache(key, value)` è¿™ä¸¤ä¸ªæ–¹æ³•è¿˜æ ¹æœ¬æ²¡å®ç°ï¼Œæ€ä¹ˆç¼–è¯‘é€šè¿‡ï¼Ÿè¿™ä¸ªä¸è¦ç´§ï¼Œæˆ‘ä»¬å£°æ˜æŠ½è±¡æ–¹æ³•å°±å¯ä»¥ï¼š

```java
public abstract class AbstractSetting {
    public final String getSetting(String key) {
        String value = lookupCache(key);
        if (value == null) {
            value = readFromDatabase(key);
            putIntoCache(key, value);
        }
        return value;
    }

    protected abstract String lookupCache(String key);

    protected abstract void putIntoCache(String key, String value);
}
```

å› ä¸ºå£°æ˜äº†æŠ½è±¡æ–¹æ³•ï¼Œè‡ªç„¶æ•´ä¸ªç±»ä¹Ÿå¿…é¡»æ˜¯æŠ½è±¡ç±»ã€‚å¦‚ä½•å®ç° `lookupCache(key)` å’Œ `putIntoCache(key, value)` è¿™ä¸¤ä¸ªæ–¹æ³•å°±äº¤ç»™å­ç±»äº†ã€‚å­ç±»å…¶å®å¹¶ä¸å…³å¿ƒæ ¸å¿ƒä»£ç  `getSetting(key)` çš„é€»è¾‘ï¼Œå®ƒåªéœ€è¦å…³å¿ƒå¦‚ä½•å®Œæˆä¸¤ä¸ªå°å°çš„å­ä»»åŠ¡å°±å¯ä»¥äº†ã€‚

å‡è®¾æˆ‘ä»¬å¸Œæœ›ç”¨ä¸€ä¸ª `Map` åšç¼“å­˜ï¼Œé‚£ä¹ˆå¯ä»¥å†™ä¸€ä¸ª `LocalSetting`ï¼š

```java
public class LocalSetting extends AbstractSetting {
    private Map<String, String> cache = new HashMap<>();

    protected String lookupCache(String key) {
        return cache.get(key);
    }

    protected void putIntoCache(String key, String value) {
        cache.put(key, value);
    }
}
```

å¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ Redis åšç¼“å­˜ï¼Œé‚£ä¹ˆå¯ä»¥å†å†™ä¸€ä¸ª `RedisSetting`ï¼š

```java
public class RedisSetting extends AbstractSetting {
    private RedisClient client = RedisClient.create("redis://localhost:6379");

    protected String lookupCache(String key) {
        try (StatefulRedisConnection<String, String> connection = client.connect()) {
            RedisCommands<String, String> commands = connection.sync();
            return commands.get(key);
        }
    }

    protected void putIntoCache(String key, String value) {
        try (StatefulRedisConnection<String, String> connection = client.connect()) {
            RedisCommands<String, String> commands = connection.sync();
            commands.set(key, value);
        }
    }
}
```

å®¢æˆ·ç«¯ä»£ç ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„ä»£ç è¿™ä¹ˆå†™ï¼š

```java
AbstractSetting setting1 = new LocalSetting();
System.out.println("test =" + setting1.getSetting("test"));
System.out.println("test =" + setting1.getSetting("test"));
```

è¦æ”¹æˆ Redis ç¼“å­˜ï¼Œåªéœ€è¦æŠŠ `LocalSetting` æ›¿æ¢ä¸º `RedisSetting`ï¼š

```java
AbstractSetting setting2 = new RedisSetting();
System.out.println("autosave =" + setting2.getSetting("autosave"));
System.out.println("autosave =" + setting2.getSetting("autosave"));
```

å¯è§ï¼Œæ¨¡æ¿æ–¹æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šçˆ¶ç±»å®šä¹‰éª¨æ¶ï¼Œå­ç±»å®ç°æŸäº›ç»†èŠ‚ã€‚

ä¸ºäº†é˜²æ­¢å­ç±»é‡å†™çˆ¶ç±»çš„éª¨æ¶æ–¹æ³•ï¼Œå¯ä»¥åœ¨çˆ¶ç±»ä¸­å¯¹éª¨æ¶æ–¹æ³•ä½¿ç”¨ `final`ã€‚å¯¹äºéœ€è¦å­ç±»å®ç°çš„æŠ½è±¡æ–¹æ³•ï¼Œä¸€èˆ¬å£°æ˜ä¸º `protected`ï¼Œä½¿å¾—è¿™äº›æ–¹æ³•å¯¹å¤–éƒ¨å®¢æˆ·ç«¯ä¸å¯è§ã€‚

Java æ ‡å‡†åº“ä¹Ÿæœ‰å¾ˆå¤šæ¨¡æ¿æ–¹æ³•çš„åº”ç”¨ã€‚åœ¨é›†åˆç±»ä¸­ï¼Œ`AbstractList` å’Œ `AbstractQueuedSynchronizer` éƒ½å®šä¹‰äº†å¾ˆå¤šé€šç”¨æ“ä½œï¼Œå­ç±»åªéœ€è¦å®ç°æŸäº›å¿…è¦æ–¹æ³•ã€‚

## ğŸ€ ç»ƒä¹ 

ä½¿ç”¨æ¨¡æ¿æ–¹æ³•å¢åŠ ä¸€ä¸ªä½¿ç”¨ Guava Cache çš„å­ç±»ã€‚


æ€è€ƒï¼šèƒ½å¦å°† `readFromDatabase()` ä½œä¸ºæ¨¡æ¿æ–¹æ³•ï¼Œä½¿å¾—å­ç±»å¯ä»¥é€‰æ‹©ä»æ•°æ®åº“è¯»å–è¿˜æ˜¯ä»æ–‡ä»¶è¯»å–ã€‚

å†æ€è€ƒå¦‚æœæ—¢å¯ä»¥æ‰©å±•ç¼“å­˜ï¼Œåˆå¯ä»¥æ‰©å±•åº•å±‚å­˜å‚¨ï¼Œä¼šä¸ä¼šå‡ºç°å­ç±»æ•°é‡çˆ†ç‚¸çš„æƒ…å†µï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ

## ğŸ€ å°ç»“

æ¨¡æ¿æ–¹æ³•æ˜¯ä¸€ç§é«˜å±‚å®šä¹‰éª¨æ¶ï¼Œåº•å±‚å®ç°ç»†èŠ‚çš„è®¾è®¡æ¨¡å¼ï¼Œé€‚ç”¨äºæµç¨‹å›ºå®šï¼Œä½†æŸäº›æ­¥éª¤ä¸ç¡®å®šæˆ–å¯æ›¿æ¢çš„æƒ…å†µã€‚





