---
title: ä»£ç†
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::


> ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚

ä»£ç†æ¨¡å¼ï¼Œå³ Proxyï¼Œå®ƒå’Œ Adapter æ¨¡å¼å¾ˆç±»ä¼¼ã€‚æˆ‘ä»¬å…ˆå›é¡¾ Adapter æ¨¡å¼ï¼Œå®ƒç”¨äºæŠŠ A æ¥å£è½¬æ¢ä¸º B æ¥å£ï¼š

```java
public class BAdapter implements B {
    private A a;
    public BAdapter(A a) {
        this.a = a;
    }
    public void b() {
        a.a();
    }
}
```

è€Œ Proxy æ¨¡å¼ä¸æ˜¯æŠŠ A æ¥å£è½¬æ¢æˆ B æ¥å£ï¼Œå®ƒè¿˜æ˜¯è½¬æ¢æˆ A æ¥å£ï¼š

```java
public class AProxy implements A {
    private A a;
    public AProxy(A a) {
        this.a = a;
    }
    public void a() {
        this.a.a();
    }
}
```

åˆç€ Proxy å°±æ˜¯ä¸ºäº†ç»™ A æ¥å£å†åŒ…ä¸€å±‚ï¼Œè¿™ä¸æ˜¯è„±äº†è£¤å­æ”¾å±å—ï¼Ÿ

å½“ç„¶ä¸æ˜¯ã€‚æˆ‘ä»¬è§‚å¯Ÿ Proxy çš„å®ç° A æ¥å£çš„æ–¹æ³•ï¼š

```java
public void a() {
    this.a.a();
}
```

è¿™æ ·å†™å½“ç„¶æ²¡å•¥åµç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è°ƒç”¨ `a.a()` çš„å‰åï¼ŒåŠ ä¸€äº›é¢å¤–çš„ä»£ç ï¼š

```java
public void a() {
    if (getCurrentUser().isRoot()) {
        this.a.a();
    } else {
        throw new SecurityException("Forbidden");
    }
}
```

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å®ç°äº†æƒé™æ£€æŸ¥ï¼Œåªæœ‰ç¬¦åˆè¦æ±‚çš„ç”¨æˆ·ï¼Œæ‰ä¼šçœŸæ­£è°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼Œå¦åˆ™ï¼Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚

æœ‰çš„ç«¥é‹ä¼šé—®ï¼Œä¸ºå•¥ä¸æŠŠæƒé™æ£€æŸ¥çš„åŠŸèƒ½ç›´æ¥å†™åˆ°ç›®æ ‡å®ä¾‹ A çš„å†…éƒ¨ï¼Ÿ

å› ä¸ºæˆ‘ä»¬ç¼–å†™ä»£ç çš„åŸåˆ™æœ‰ï¼š

- èŒè´£æ¸…æ™°ï¼šä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä»¶äº‹ï¼›
- æ˜“äºæµ‹è¯•ï¼šä¸€æ¬¡åªæµ‹ä¸€ä¸ªåŠŸèƒ½ã€‚

ç”¨ Proxy å®ç°è¿™ä¸ªæƒé™æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—æ›´æ¸…æ™°ã€æ›´ç®€æ´çš„ä»£ç ï¼š

- `A` æ¥å£ï¼šåªå®šä¹‰æ¥å£ï¼›
- `ABusiness` ç±»ï¼šåªå®ç° A æ¥å£çš„ä¸šåŠ¡é€»è¾‘ï¼›
- `APermissionProxy` ç±»ï¼šåªå®ç° A æ¥å£çš„æƒé™æ£€æŸ¥ä»£ç†ã€‚

å¦‚æœæˆ‘ä»¬å¸Œæœ›ç¼–å†™å…¶ä»–ç±»å‹çš„ä»£ç†ï¼Œå¯ä»¥ç»§ç»­å¢åŠ ç±»ä¼¼ ALogProxy ï¼Œè€Œä¸å¿…å¯¹ç°æœ‰çš„ A æ¥å£ã€ ABusiness ç±»è¿›è¡Œä¿®æ”¹ã€‚

å®é™…ä¸Šæƒé™æ£€æŸ¥åªæ˜¯ä»£ç†æ¨¡å¼çš„ä¸€ç§åº”ç”¨ã€‚ Proxy è¿˜å¹¿æ³›åº”ç”¨åœ¨ï¼š

## ğŸ€ è¿œç¨‹ä»£ç†

è¿œç¨‹ä»£ç†å³ Remote Proxy ï¼Œæœ¬åœ°çš„è°ƒç”¨è€…æŒæœ‰çš„æ¥å£å®é™…ä¸Šæ˜¯ä¸€ä¸ªä»£ç†ï¼Œè¿™ä¸ªä»£ç†è´Ÿè´£æŠŠå¯¹æ¥å£çš„æ–¹æ³•è®¿é—®è½¬æ¢æˆè¿œç¨‹è°ƒç”¨ï¼Œç„¶åè¿”å›ç»“æœã€‚Java å†…ç½®çš„ RMI æœºåˆ¶å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¿œç¨‹ä»£ç†æ¨¡å¼ã€‚

## ğŸ€ è™šä»£ç†

è™šä»£ç†å³ Virtual Proxyï¼Œå®ƒè®©è°ƒç”¨è€…å…ˆæŒæœ‰ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä½†çœŸæ­£çš„å¯¹è±¡å°šæœªåˆ›å»ºã€‚å¦‚æœæ²¡æœ‰å¿…è¦ï¼Œè¿™ä¸ªçœŸæ­£çš„å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆ›å»ºçš„ï¼Œç›´åˆ°å®¢æˆ·ç«¯éœ€è¦çœŸçš„å¿…é¡»è°ƒç”¨æ—¶ï¼Œæ‰åˆ›å»ºçœŸæ­£çš„å¯¹è±¡ã€‚ JDBC çš„è¿æ¥æ± è¿”å›çš„ JDBC è¿æ¥ï¼ˆConnection å¯¹è±¡ï¼‰å°±å¯ä»¥æ˜¯ä¸€ä¸ªè™šä»£ç†ï¼Œå³è·å–è¿æ¥æ—¶æ ¹æœ¬æ²¡æœ‰ä»»ä½•å®é™…çš„æ•°æ®åº“è¿æ¥ï¼Œç›´åˆ°ç¬¬ä¸€æ¬¡æ‰§è¡Œ JDBC æŸ¥è¯¢æˆ–æ›´æ–°æ“ä½œæ—¶ï¼Œæ‰çœŸæ­£åˆ›å»ºå®é™…çš„ JDBC è¿æ¥ã€‚

## ğŸ€ ä¿æŠ¤ä»£ç†

ä¿æŠ¤ä»£ç†å³ Protection Proxy ï¼Œå®ƒç”¨ä»£ç†å¯¹è±¡æ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®ï¼Œå¸¸ç”¨äºé‰´æƒã€‚

## ğŸ€ æ™ºèƒ½å¼•ç”¨

æ™ºèƒ½å¼•ç”¨å³ Smart Reference ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ç§ä»£ç†å¯¹è±¡ï¼Œå¦‚æœæœ‰å¾ˆå¤šå®¢æˆ·ç«¯å¯¹å®ƒè¿›è¡Œè®¿é—®ï¼Œé€šè¿‡å†…éƒ¨çš„è®¡æ•°å™¨å¯ä»¥åœ¨å¤–éƒ¨è°ƒç”¨è€…éƒ½ä¸ä½¿ç”¨åè‡ªåŠ¨é‡Šæ”¾å®ƒã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•åº”ç”¨ä»£ç†æ¨¡å¼ç¼–å†™ä¸€ä¸ª JDBC è¿æ¥æ± ï¼ˆ`DataSource`ï¼‰ã€‚æˆ‘ä»¬é¦–å…ˆæ¥ç¼–å†™ä¸€ä¸ªè™šä»£ç†ï¼Œå³å¦‚æœè°ƒç”¨è€…è·å–åˆ° `Connection` åï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œä»»ä½• SQL æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ª Connection Proxy å®é™…ä¸Šå¹¶ä¸ä¼šçœŸæ­£æ‰“å¼€ JDBC è¿æ¥ã€‚è°ƒç”¨è€…ä»£ç å¦‚ä¸‹ï¼š

```java
DataSource lazyDataSource = new LazyDataSource(jdbcUrl, jdbcUsername, jdbcPassword);
System.out.println("get lazy connection...");
try (Connection conn1 = lazyDataSource.getConnection()) {
    // å¹¶æ²¡æœ‰å®é™…æ‰“å¼€çœŸæ­£çš„ Connection
}
System.out.println("get lazy connection...");
try (Connection conn2 = lazyDataSource.getConnection()) {
    try (PreparedStatement ps = conn2.prepareStatement("SELECT * FROM students")) { // æ‰“å¼€äº†çœŸæ­£çš„ Connection
        try (ResultSet rs = ps.executeQuery()) {
            while (rs.next()) {
                System.out.println(rs.getString("name"));
            }
        }
    }
}
```

ç°åœ¨æˆ‘ä»¬æ¥æ€è€ƒå¦‚ä½•å®ç°è¿™ä¸ª `LazyConnectionProxy` ã€‚ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œæˆ‘ä»¬é¦–å…ˆé’ˆå¯¹ `Connection` æ¥å£åšä¸€ä¸ªæŠ½è±¡çš„ä»£ç†ç±»ï¼š

```java
public abstract class AbstractConnectionProxy implements Connection {

    // æŠ½è±¡æ–¹æ³•è·å–å®é™…çš„ Connection:
    protected abstract Connection getRealConnection();

    // å®ç° Connection æ¥å£çš„æ¯ä¸€ä¸ªæ–¹æ³•:
    public Statement createStatement() throws SQLException {
        return getRealConnection().createStatement();
    }

    public PreparedStatement prepareStatement(String sql) throws SQLException {
        return getRealConnection().prepareStatement(sql);
    }

    //... å…¶ä»–ä»£ç†æ–¹æ³•...
}
```

è¿™ä¸ª `AbstractConnectionProxy` ä»£ç†ç±»çš„ä½œç”¨æ˜¯æŠŠ `Connection` æ¥å£å®šä¹‰çš„æ–¹æ³•å…¨éƒ¨å®ç°ä¸€éï¼Œå› ä¸º `Connection` æ¥å£å®šä¹‰çš„æ–¹æ³•å¤ªå¤šäº†ï¼Œåé¢æˆ‘ä»¬è¦ç¼–å†™çš„ `LazyConnectionProxy` åªéœ€è¦ç»§æ‰¿ `AbstractConnectionProxy`ï¼Œå°±ä¸å¿…å†æŠŠ `Connection` æ¥å£æ–¹æ³•æŒ¨ä¸ªå®ç°ä¸€éã€‚

`LazyConnectionProxy` å®ç°å¦‚ä¸‹ï¼š

```java
public class LazyConnectionProxy extends AbstractConnectionProxy {
    private Supplier<Connection> supplier;
    private Connection target = null;

    public LazyConnectionProxy(Supplier<Connection> supplier) {
        this.supplier = supplier;
    }

    // è¦†å†™ close æ–¹æ³•ï¼šåªæœ‰ target ä¸ä¸º null æ—¶æ‰éœ€è¦å…³é—­:
    public void close() throws SQLException {
        if (target != null) {
            System.out.println("Close connection:" + target);
            super.close();
        }
    }

    @Override
    protected Connection getRealConnection() {
        if (target == null) {
            target = supplier.get();
        }
        return target;
    }
}
```

å¦‚æœè°ƒç”¨è€…æ²¡æœ‰æ‰§è¡Œä»»ä½• SQL è¯­å¥ï¼Œé‚£ä¹ˆ `target` å­—æ®µå§‹ç»ˆä¸º `null`ã€‚åªæœ‰ç¬¬ä¸€æ¬¡æ‰§è¡Œ SQL è¯­å¥æ—¶ï¼ˆå³è°ƒç”¨ä»»ä½•ç±»ä¼¼ `prepareStatement()` æ–¹æ³•æ—¶ï¼Œè§¦å‘ `getRealConnection()` è°ƒç”¨ï¼‰ï¼Œæ‰ä¼šçœŸæ­£æ‰“å¼€å®é™…çš„ JDBC Connectionã€‚

æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™ä¸€ä¸ª `LazyDataSource` æ¥æ”¯æŒè¿™ä¸ª `LazyConnectionProxy`ï¼š

```java
public class LazyDataSource implements DataSource {
    private String url;
    private String username;
    private String password;

    public LazyDataSource(String url, String username, String password) {
        this.url = url;
        this.username = username;
        this.password = password;
    }

    public Connection getConnection(String username, String password) throws SQLException {
        return new LazyConnectionProxy(() -> {
            try {
                Connection conn = DriverManager.getConnection(url, username, password);
                System.out.println("Open connection:" + conn);
                return conn;
            } catch (SQLException e) {
                throw new RuntimeException(e);
            }
        });
    }
    ...
}
```

æˆ‘ä»¬æ‰§è¡Œä»£ç ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

```sh
get lazy connection...
get lazy connection...
Open connection: com.mysql.jdbc.JDBC4Connection@7a36aefa
å°æ˜
å°çº¢
å°å†›
å°ç™½
...
Close connection: com.mysql.jdbc.JDBC4Connection@7a36aefa
```

å¯è§ç¬¬ä¸€ä¸ª `getConnection()` è°ƒç”¨è·å–åˆ°çš„ `LazyConnectionProxy` å¹¶æ²¡æœ‰å®é™…æ‰“å¼€çœŸæ­£çš„ JDBC Connection ã€‚

ä½¿ç”¨è¿æ¥æ± çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›èƒ½é‡å¤ä½¿ç”¨è¿æ¥ã€‚å¦‚æœè°ƒç”¨æ–¹ç¼–å†™è¿™æ ·çš„ä»£ç ï¼š

```java
DataSource pooledDataSource = new PooledDataSource(jdbcUrl, jdbcUsername, jdbcPassword);
try (Connection conn = pooledDataSource.getConnection()) {
}
try (Connection conn = pooledDataSource.getConnection()) {
    // è·å–åˆ°çš„æ˜¯åŒä¸€ä¸ª Connection
}
try (Connection conn = pooledDataSource.getConnection()) {
    // è·å–åˆ°çš„æ˜¯åŒä¸€ä¸ª Connection
}
```

è°ƒç”¨æ–¹å¹¶ä¸å…³å¿ƒæ˜¯å¦å¤ç”¨äº† `Connection`ï¼Œä½†ä» `PooledDataSource` è·å–çš„ `Connection` ç¡®å®è‡ªå¸¦è¿™ä¸ªä¼˜åŒ–åŠŸèƒ½ã€‚å¦‚ä½•å®ç°å¯å¤ç”¨ `Connection` çš„è¿æ¥æ± ï¼Ÿç­”æ¡ˆä»ç„¶æ˜¯ä½¿ç”¨ä»£ç†æ¨¡å¼ã€‚

```java
public class PooledConnectionProxy extends AbstractConnectionProxy {
    // å®é™…çš„ Connection:
    Connection target;
    // ç©ºé—²é˜Ÿåˆ—:
    Queue<PooledConnectionProxy> idleQueue;

    public PooledConnectionProxy(Queue<PooledConnectionProxy> idleQueue, Connection target) {
        this.idleQueue = idleQueue;
        this.target = target;
    }

    public void close() throws SQLException {
        System.out.println("Fake close and released to idle queue for future reuse:" + target);
        // å¹¶æ²¡æœ‰è°ƒç”¨å®é™… Connection çš„ close() æ–¹æ³•,
        // è€Œæ˜¯æŠŠè‡ªå·±æ”¾å…¥ç©ºé—²é˜Ÿåˆ—:
        idleQueue.offer(this);
    }

    protected Connection getRealConnection() {
        return target;
    }
}
```

å¤ç”¨è¿æ¥çš„å…³é”®åœ¨äºè¦†å†™ `close()` æ–¹æ³•ï¼Œå®ƒå¹¶æ²¡æœ‰çœŸæ­£å…³é—­åº•å±‚ JDBC è¿æ¥ï¼Œè€Œæ˜¯æŠŠè‡ªå·±æ”¾å›ä¸€ä¸ªç©ºé—²é˜Ÿåˆ—ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨ã€‚

ç©ºé—²é˜Ÿåˆ—ç”± `PooledDataSource` è´Ÿè´£ç»´æŠ¤ï¼š

```java
public class PooledDataSource implements DataSource {
    private String url;
    private String username;
    private String password;

    // ç»´æŠ¤ä¸€ä¸ªç©ºé—²é˜Ÿåˆ—:
    private Queue<PooledConnectionProxy> idleQueue = new ArrayBlockingQueue<>(100);

    public PooledDataSource(String url, String username, String password) {
        this.url = url;
        this.username = username;
        this.password = password;
    }

    public Connection getConnection(String username, String password) throws SQLException {
        // é¦–å…ˆè¯•å›¾è·å–ä¸€ä¸ªç©ºé—²è¿æ¥:
        PooledConnectionProxy conn = idleQueue.poll();
        if (conn == null) {
            // æ²¡æœ‰ç©ºé—²è¿æ¥æ—¶ï¼Œæ‰“å¼€ä¸€ä¸ªæ–°è¿æ¥:
            conn = openNewConnection();
        } else {
            System.out.println("Return pooled connection:" + conn.target);
        }
        return conn;
    }

    private PooledConnectionProxy openNewConnection() throws SQLException {
        Connection conn = DriverManager.getConnection(url, username, password);
        System.out.println("Open new connection:" + conn);
        return new PooledConnectionProxy(idleQueue, conn);
    }
    // ...
}
```

æˆ‘ä»¬æ‰§è¡Œè°ƒç”¨æ–¹ä»£ç ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

```sh
Open new connection: com.mysql.jdbc.JDBC4Connection@61ca2dfa
Fake close and released to idle queue for future reuse: com.mysql.jdbc.JDBC4Connection@61ca2dfa
Return pooled connection: com.mysql.jdbc.JDBC4Connection@61ca2dfa
Fake close and released to idle queue for future reuse: com.mysql.jdbc.JDBC4Connection@61ca2dfa
Return pooled connection: com.mysql.jdbc.JDBC4Connection@61ca2dfa
Fake close and released to idle queue for future reuse: com.mysql.jdbc.JDBC4Connection@61ca2dfa
```

é™¤äº†ç¬¬ä¸€æ¬¡æ‰“å¼€äº†ä¸€ä¸ªçœŸæ­£çš„ JDBC Connection ï¼Œåç»­è·å–çš„ `Connection` å®é™…ä¸Šæ˜¯åŒä¸€ä¸ª JDBC Connection ã€‚ä½†æ˜¯ï¼Œå¯¹äºè°ƒç”¨æ–¹æ¥è¯´ï¼Œå®Œå…¨ä¸éœ€è¦çŸ¥é“åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ã€‚

æˆ‘ä»¬å®é™…ä½¿ç”¨çš„ DataSource ï¼Œä¾‹å¦‚ HikariCP ï¼Œéƒ½æ˜¯åŸºäºä»£ç†æ¨¡å¼å®ç°çš„ï¼ŒåŸç†åŒä¸Šï¼Œä½†å¢åŠ äº†æ›´å¤šçš„å¦‚åŠ¨æ€ä¼¸ç¼©çš„åŠŸèƒ½ï¼ˆä¸€ä¸ªè¿æ¥ç©ºé—²ä¸€æ®µæ—¶é—´åè‡ªåŠ¨å…³é—­ï¼‰ã€‚

æœ‰çš„ç«¥é‹ä¼šå‘ç° Proxy æ¨¡å¼å’Œ Decorator æ¨¡å¼æœ‰äº›ç±»ä¼¼ã€‚ç¡®å®ï¼Œè¿™ä¸¤è€…çœ‹èµ·æ¥å¾ˆåƒï¼Œä½†åŒºåˆ«åœ¨äºï¼šDecorator æ¨¡å¼è®©è°ƒç”¨è€…è‡ªå·±åˆ›å»ºæ ¸å¿ƒç±»ï¼Œç„¶åç»„åˆå„ç§åŠŸèƒ½ï¼Œè€Œ Proxy æ¨¡å¼å†³ä¸èƒ½è®©è°ƒç”¨è€…è‡ªå·±åˆ›å»ºå†ç»„åˆï¼Œå¦åˆ™å°±å¤±å»äº†ä»£ç†çš„åŠŸèƒ½ã€‚Proxy æ¨¡å¼è®©è°ƒç”¨è€…è®¤ä¸ºè·å–åˆ°çš„æ˜¯æ ¸å¿ƒç±»æ¥å£ï¼Œä½†å®é™…ä¸Šæ˜¯ä»£ç†ç±»ã€‚

## ğŸ€ ç»ƒä¹ 

ä½¿ç”¨ä»£ç†æ¨¡å¼ç¼–å†™ä¸€ä¸ª JDBC è¿æ¥æ± 

## ğŸ€ å°ç»“

ä»£ç†æ¨¡å¼é€šè¿‡å°è£…ä¸€ä¸ªå·²æœ‰æ¥å£ï¼Œå¹¶å‘è°ƒç”¨æ–¹è¿”å›ç›¸åŒçš„æ¥å£ç±»å‹ï¼Œèƒ½è®©è°ƒç”¨æ–¹åœ¨ä¸æ”¹å˜ä»»ä½•ä»£ç çš„å‰æä¸‹å¢å¼ºæŸäº›åŠŸèƒ½ï¼ˆä¾‹å¦‚ï¼Œé‰´æƒã€å»¶è¿ŸåŠ è½½ã€è¿æ¥æ± å¤ç”¨ç­‰ï¼‰ã€‚

ä½¿ç”¨ Proxy æ¨¡å¼è¦æ±‚è°ƒç”¨æ–¹æŒæœ‰æ¥å£ï¼Œä½œä¸º Proxy çš„ç±»ä¹Ÿå¿…é¡»å®ç°ç›¸åŒçš„æ¥å£ç±»å‹ã€‚







