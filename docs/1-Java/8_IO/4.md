---
title: Filter æ¨¡å¼
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

Java çš„ IO æ ‡å‡†åº“æä¾›çš„ InputStream æ ¹æ®æ¥æºå¯ä»¥åŒ…æ‹¬ï¼š

- FileInputStreamï¼šä»æ–‡ä»¶è¯»å–æ•°æ®ï¼Œæ˜¯æœ€ç»ˆæ•°æ®æºï¼›
- ServletInputStreamï¼šä» HTTP è¯·æ±‚è¯»å–æ•°æ®ï¼Œæ˜¯æœ€ç»ˆæ•°æ®æºï¼›
- `Socket.getInputStream()`ï¼šä» TCP è¿æ¥è¯»å–æ•°æ®ï¼Œæ˜¯æœ€ç»ˆæ•°æ®æºï¼›
- ...

å¦‚æœæˆ‘ä»¬è¦ç»™ FileInputStream æ·»åŠ ç¼“å†²åŠŸèƒ½ï¼Œåˆ™å¯ä»¥ä» FileInputStream æ´¾ç”Ÿä¸€ä¸ªç±»ï¼š

```java
BufferedFileInputStream extends FileInputStream
```

å¦‚æœè¦ç»™ FileInputStream æ·»åŠ è®¡ç®—ç­¾åçš„åŠŸèƒ½ï¼Œç±»ä¼¼çš„ï¼Œä¹Ÿå¯ä»¥ä» FileInputStream æ´¾ç”Ÿä¸€ä¸ªç±»ï¼š

```java
DigestFileInputStream extends FileInputStream
```

å¦‚æœè¦ç»™ FileInputStream æ·»åŠ åŠ å¯† / è§£å¯†åŠŸèƒ½ï¼Œè¿˜æ˜¯å¯ä»¥ä» FileInputStream æ´¾ç”Ÿä¸€ä¸ªç±»ï¼š

```java
CipherFileInputStream extends FileInputStream
```

å¦‚æœè¦ç»™ FileInputStream æ·»åŠ ç¼“å†²å’Œç­¾åçš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦æ´¾ç”Ÿ BufferedDigestFileInputStreamã€‚å¦‚æœè¦ç»™ FileInputStream æ·»åŠ ç¼“å†²å’ŒåŠ è§£å¯†çš„åŠŸèƒ½ï¼Œåˆ™éœ€è¦æ´¾ç”Ÿ BufferedCipherFileInputStreamã€‚

æˆ‘ä»¬å‘ç°ï¼Œç»™ FileInputStream æ·»åŠ  3 ç§åŠŸèƒ½ï¼Œè‡³å°‘éœ€è¦ 3 ä¸ªå­ç±»ã€‚è¿™ 3 ç§åŠŸèƒ½çš„ç»„åˆï¼Œåˆéœ€è¦æ›´å¤šçš„å­ç±»ï¼š

![](assets/20221123213034.png)

è¿™è¿˜åªæ˜¯é’ˆå¯¹ FileInputStream è®¾è®¡ï¼Œå¦‚æœé’ˆå¯¹å¦ä¸€ç§ InputStream è®¾è®¡ï¼Œå¾ˆå¿«ä¼šå‡ºç°å­ç±»çˆ†ç‚¸çš„æƒ…å†µã€‚

::: caution
å› æ­¤ï¼Œç›´æ¥ä½¿ç”¨ç»§æ‰¿ï¼Œä¸ºå„ç§ InputStream é™„åŠ æ›´å¤šçš„åŠŸèƒ½ï¼Œæ ¹æœ¬æ— æ³•æ§åˆ¶ä»£ç çš„å¤æ‚åº¦ï¼Œå¾ˆå¿«å°±ä¼š **å¤±æ§**ã€‚

:::

ä¸ºäº†è§£å†³ä¾èµ–ç»§æ‰¿ä¼šå¯¼è‡´å­ç±»æ•°é‡å¤±æ§çš„é—®é¢˜ï¼ŒJDK é¦–å…ˆå°† InputStream åˆ†ä¸ºä¸¤å¤§ç±»ï¼š

ä¸€ç±»æ˜¯ç›´æ¥æä¾›æ•°æ®çš„åŸºç¡€ InputStream ï¼Œä¾‹å¦‚ï¼š

- FileInputStream
- ByteArrayInputStream
- ServletInputStream
- ...

ä¸€ç±»æ˜¯æä¾›é¢å¤–é™„åŠ åŠŸèƒ½çš„ InputStreamï¼Œä¾‹å¦‚ï¼š

- BufferedInputStream
- DigestInputStream
- CipherInputStream
- ...

å½“æˆ‘ä»¬éœ€è¦ç»™ä¸€ä¸ª â€œåŸºç¡€â€ InputStream é™„åŠ å„ç§åŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬å…ˆç¡®å®šè¿™ä¸ªèƒ½æä¾›æ•°æ®æºçš„ InputStreamï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦çš„æ•°æ®æ€»å¾—æ¥è‡ªæŸä¸ªåœ°æ–¹ï¼Œä¾‹å¦‚ï¼ŒFileInputStreamï¼Œæ•°æ®æ¥æºè‡ªæ–‡ä»¶ï¼š

```java
InputStream file = new FileInputStream("test.gz");
```

ç´§æ¥ç€ï¼Œæˆ‘ä»¬å¸Œæœ› FileInputStream èƒ½æä¾›ç¼“å†²çš„åŠŸèƒ½æ¥æé«˜è¯»å–çš„æ•ˆç‡ï¼Œå› æ­¤æˆ‘ä»¬ç”¨ BufferedInputStream åŒ…è£…è¿™ä¸ª InputStreamï¼Œå¾—åˆ°çš„åŒ…è£…ç±»å‹æ˜¯ BufferedInputStreamï¼Œä½†å®ƒä»ç„¶è¢«è§†ä¸ºä¸€ä¸ª InputStreamï¼š

```java
InputStream buffered = new BufferedInputStream(file);
```

æœ€åï¼Œå‡è®¾è¯¥æ–‡ä»¶å·²ç»ç”¨ gzip å‹ç¼©äº†ï¼Œæˆ‘ä»¬å¸Œæœ›ç›´æ¥è¯»å–è§£å‹ç¼©çš„å†…å®¹ï¼Œå°±å¯ä»¥å†åŒ…è£…ä¸€ä¸ª GZIPInputStreamï¼š

```java
InputStream gzip = new GZIPInputStream(buffered);
```

æ— è®ºæˆ‘ä»¬åŒ…è£…å¤šå°‘æ¬¡ï¼Œå¾—åˆ°çš„å¯¹è±¡å§‹ç»ˆæ˜¯ InputStreamï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ InputStream æ¥å¼•ç”¨å®ƒï¼Œå°±å¯ä»¥æ­£å¸¸è¯»å–ï¼š

![](assets/20221123213203.png)

ä¸Šè¿°è¿™ç§é€šè¿‡ä¸€ä¸ª â€œåŸºç¡€â€ ç»„ä»¶å†å åŠ å„ç§ â€œé™„åŠ â€ åŠŸèƒ½ç»„ä»¶çš„æ¨¡å¼ï¼Œç§°ä¹‹ä¸º **Filter æ¨¡å¼**ï¼ˆæˆ–è€…è£…é¥°å™¨æ¨¡å¼ï¼šDecoratorï¼‰ã€‚å®ƒå¯ä»¥è®©æˆ‘ä»¬é€šè¿‡å°‘é‡çš„ç±»æ¥å®ç°å„ç§åŠŸèƒ½çš„ç»„åˆï¼š

![](assets/20221123213231.png)

ç±»ä¼¼çš„ï¼ŒOutputStream ä¹Ÿæ˜¯ä»¥è¿™ç§æ¨¡å¼æ¥æä¾›å„ç§åŠŸèƒ½ï¼š

![](assets/20221123213259.png)

## ğŸ€ ç¼–å†™ FilterInputStream

æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±ç¼–å†™ FilterInputStreamï¼Œä»¥ä¾¿å¯ä»¥æŠŠè‡ªå·±çš„ FilterInputStreamâ€œå åŠ â€ åˆ°ä»»ä½•ä¸€ä¸ª InputStream ä¸­ã€‚

ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•ç¼–å†™ä¸€ä¸ª CountInputStreamï¼Œå®ƒçš„ä½œç”¨æ˜¯å¯¹è¾“å…¥çš„å­—èŠ‚è¿›è¡Œè®¡æ•°ï¼š

```java
import java.io.*;

public class Main {
    public static void main(String[] args) throws IOException {
        byte[] data = "hello, world!".getBytes("UTF-8");
        try (CountInputStream input = new CountInputStream(new ByteArrayInputStream(data))) {
            int n;
            while ((n = input.read()) != -1) {
                System.out.println((char)n);
            }
            System.out.println("Total read " + input.getBytesRead() + " bytes");
        }
    }
}

class CountInputStream extends FilterInputStream {
    private int count = 0;

    CountInputStream(InputStream in) {
        super(in);
    }

    public int getBytesRead() {
        return this.count;
    }

    public int read() throws IOException {
        int n = in.read();
        if (n != -1) {
            this.count ++;
        }
        return n;
    }

    public int read(byte[] b, int off, int len) throws IOException {
        int n = in.read(b, off, len);
        if (n != -1) {
            this.count += n;
        }
        return n;
    }
}
```

æ³¨æ„åˆ°åœ¨å åŠ å¤šä¸ª FilterInputStreamï¼Œæˆ‘ä»¬åªéœ€è¦æŒæœ‰æœ€å¤–å±‚çš„ InputStreamï¼Œå¹¶ä¸”ï¼Œå½“æœ€å¤–å±‚çš„ InputStream å…³é—­æ—¶ï¼ˆåœ¨ `try(resource)` å—çš„ç»“æŸå¤„è‡ªåŠ¨å…³é—­ï¼‰ï¼Œå†…å±‚çš„ InputStream çš„ `close()` æ–¹æ³•ä¹Ÿä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨åˆ°æœ€æ ¸å¿ƒçš„ â€œåŸºç¡€â€InputStreamï¼Œå› æ­¤ä¸å­˜åœ¨èµ„æºæ³„éœ²ã€‚

## ğŸ€ å°ç»“

- Java çš„ IO æ ‡å‡†åº“ä½¿ç”¨ Filter æ¨¡å¼ä¸º InputStream å’Œ OutputStream å¢åŠ åŠŸèƒ½ï¼š

  - å¯ä»¥æŠŠä¸€ä¸ª InputStream å’Œä»»æ„ä¸ª FilterInputStream ç»„åˆï¼›
  - å¯ä»¥æŠŠä¸€ä¸ª OutputStream å’Œä»»æ„ä¸ª FilterOutputStream ç»„åˆã€‚

- Filter æ¨¡å¼å¯ä»¥åœ¨è¿è¡ŒæœŸåŠ¨æ€å¢åŠ åŠŸèƒ½ï¼ˆåˆç§° Decorator æ¨¡å¼ï¼‰ã€‚
