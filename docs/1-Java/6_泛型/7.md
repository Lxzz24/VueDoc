---
title: æ³›å‹å’Œåå°„*
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

Java çš„éƒ¨åˆ†åå°„ API ä¹Ÿæ˜¯æ³›å‹ã€‚ä¾‹å¦‚ï¼š `Class<T>` å°±æ˜¯æ³›å‹ï¼š

```java
// compile warning:
Class clazz = String.class;
String str = (String) clazz.newInstance();

// no warning:
Class<String> clazz = String.class;
String str = clazz.newInstance();
```

è°ƒç”¨ `Class` çš„ `getSuperclass()` æ–¹æ³•è¿”å›çš„ `Class` ç±»å‹æ˜¯ `Class<? super T>` ï¼š

```java
Class<? super String> sup = String.class.getSuperclass();
```

æ„é€ æ–¹æ³• `Constructor<T>` ä¹Ÿæ˜¯æ³›å‹ï¼š

```java
Class<Integer> clazz = Integer.class;
Constructor<Integer> cons = clazz.getConstructor(int.class);
Integer i = cons.newInstance(123);
```

æˆ‘ä»¬å¯ä»¥å£°æ˜å¸¦æ³›å‹çš„æ•°ç»„ï¼Œä½†ä¸èƒ½ç”¨ `new` æ“ä½œç¬¦åˆ›å»ºå¸¦æ³›å‹çš„æ•°ç»„ï¼š

```java
Pair<String>[] ps = null; // ok
Pair<String>[] ps = new Pair<String>[2]; // compile error!
```

å¿…é¡»é€šè¿‡å¼ºåˆ¶è½¬å‹å®ç°å¸¦æ³›å‹çš„æ•°ç»„ï¼š

```java
@SuppressWarnings("unchecked")
Pair<String>[] ps = (Pair<String>[]) new Pair[2];
```

ä½¿ç”¨æ³›å‹æ•°ç»„è¦ç‰¹åˆ«å°å¿ƒï¼Œå› ä¸ºæ•°ç»„å®é™…ä¸Šåœ¨è¿è¡ŒæœŸæ²¡æœ‰æ³›å‹ï¼Œç¼–è¯‘å™¨å¯ä»¥å¼ºåˆ¶æ£€æŸ¥å˜é‡ `ps` ï¼Œå› ä¸ºå®ƒçš„ç±»å‹æ˜¯æ³›å‹æ•°ç»„ã€‚ä½†æ˜¯ï¼Œç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥å˜é‡ `arr` ï¼Œå› ä¸ºå®ƒä¸æ˜¯æ³›å‹æ•°ç»„ã€‚å› ä¸ºè¿™ä¸¤ä¸ªå˜é‡å®é™…ä¸ŠæŒ‡å‘åŒä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥ï¼Œæ“ä½œ `arr` å¯èƒ½å¯¼è‡´ä» `ps` è·å–å…ƒç´ æ—¶æŠ¥é”™ï¼Œä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç æ¼”ç¤ºäº†ä¸å®‰å…¨åœ°ä½¿ç”¨å¸¦æ³›å‹çš„æ•°ç»„ï¼š

```java
Pair[] arr = new Pair[2];
Pair<String>[] ps = (Pair<String>[]) arr;

ps[0] = new Pair<String>("a", "b");
arr[1] = new Pair<Integer>(1, 2);

// ClassCastException:
Pair<String> p = ps[1];
String s = p.getFirst();
```

è¦å®‰å…¨åœ°ä½¿ç”¨æ³›å‹æ•°ç»„ï¼Œå¿…é¡»æ‰”æ‰ `arr` çš„å¼•ç”¨ï¼š

```java
@SuppressWarnings("unchecked")
Pair<String>[] ps = (Pair<String>[]) new Pair[2];
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œç”±äºæ‹¿ä¸åˆ°åŸå§‹æ•°ç»„çš„å¼•ç”¨ï¼Œå°±åªèƒ½å¯¹æ³›å‹æ•°ç»„ `ps` è¿›è¡Œæ“ä½œï¼Œè¿™ç§æ“ä½œå°±æ˜¯å®‰å…¨çš„ã€‚

å¸¦æ³›å‹çš„æ•°ç»„å®é™…ä¸Šæ˜¯ç¼–è¯‘å™¨çš„ç±»å‹æ“¦é™¤ï¼š

```java
Pair[] arr = new Pair[2];
Pair<String>[] ps = (Pair<String>[]) arr;

System.out.println(ps.getClass() == Pair[].class); // true

String s1 = (String) arr[0].getFirst();
String s2 = ps[0].getFirst();
```

æ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥åˆ›å»ºæ³›å‹æ•°ç»„ `T[]` ï¼Œå› ä¸ºæ“¦æ‹­åä»£ç å˜ä¸º `Object[]` ï¼š

```java
// compile error:
public class Abc<T> {
    T[] createArray() {
        return new T[5];
    }
}
```

å¿…é¡»å€ŸåŠ© `Class<T>` æ¥åˆ›å»ºæ³›å‹æ•°ç»„ï¼š

```java
T[] createArray(Class<T> cls) {
    return (T[]) Array.newInstance(cls, 5);
}
```

æˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨å¯å˜å‚æ•°åˆ›å»ºæ³›å‹æ•°ç»„ `T[]`ï¼š

```java
public class ArrayHelper {
    @SafeVarargs
    static <T> T[] asArray(T... objs) {
        return objs;
    }
}

String[] ss = ArrayHelper.asArray("a", "b", "c");
Integer[] ns = ArrayHelper.asArray(1, 2, 3);
```

## ğŸ€ è°¨æ…ä½¿ç”¨æ³›å‹å¯å˜å‚æ•°

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œé€šè¿‡ï¼š

```java
static <T> T[] asArray(T... objs) {
    return objs;
}
```

ä¼¼ä¹å¯ä»¥å®‰å…¨åœ°åˆ›å»ºä¸€ä¸ªæ³›å‹æ•°ç»„ã€‚ä½†å®é™…ä¸Šï¼Œè¿™ç§æ–¹æ³•éå¸¸å±é™©ã€‚ä»¥ä¸‹ä»£ç æ¥è‡ªã€ŠEffective Javaã€‹çš„ç¤ºä¾‹ï¼š

```java
import java.util.Arrays;

public class Main {
    public static void main(String[] args) {
        String[] arr = asArray("one", "two", "three");
        System.out.println(Arrays.toString(arr));
        // ClassCastException:
        String[] firstTwo = pickTwo("one", "two", "three");
        System.out.println(Arrays.toString(firstTwo));
    }

    static <K> K[] pickTwo(K k1, K k2, K k3) {
        return asArray(k1, k2);
    }

    static <T> T[] asArray(T... objs) {
        return objs;
    }
}
```

ç›´æ¥è°ƒç”¨ `asArray(T...)` ä¼¼ä¹æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¦ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ªæ³›å‹æ•°ç»„å°±ä¼šäº§ç”Ÿ `ClassCastException` ï¼ŒåŸå› è¿˜æ˜¯å› ä¸ºæ“¦æ‹­æ³•ï¼Œåœ¨ `pickTwo()` æ–¹æ³•å†…éƒ¨ï¼Œç¼–è¯‘å™¨æ— æ³•æ£€æµ‹ `K[]` çš„æ­£ç¡®ç±»å‹ï¼Œå› æ­¤è¿”å›äº† `Object[]` ã€‚

å¦‚æœä»”ç»†è§‚å¯Ÿï¼Œå¯ä»¥å‘ç°ç¼–è¯‘å™¨å¯¹æ‰€æœ‰å¯å˜æ³›å‹å‚æ•°éƒ½ä¼šå‘å‡ºè­¦å‘Šï¼Œé™¤éç¡®è®¤å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼Œæ‰å¯ä»¥ç”¨ `@SafeVarargs` æ¶ˆé™¤è­¦å‘Šã€‚

::: warning
å¦‚æœåœ¨æ–¹æ³•å†…éƒ¨åˆ›å»ºäº†æ³›å‹æ•°ç»„ï¼Œæœ€å¥½ä¸è¦å°†å®ƒè¿”å›ç»™å¤–éƒ¨ä½¿ç”¨ã€‚
:::

æ›´è¯¦ç»†çš„è§£é‡Šè¯·å‚è€ƒã€ŠEffective Javaã€‹â€œItem 32: Combine generics and varargs judiciouslyâ€ã€‚

## ğŸ€ å°ç»“

- éƒ¨åˆ†åå°„ API æ˜¯æ³›å‹ï¼Œä¾‹å¦‚ï¼š `Class<T>` ï¼Œ `Constructor<T>` ï¼›
- å¯ä»¥å£°æ˜å¸¦æ³›å‹çš„æ•°ç»„ï¼Œä½†ä¸èƒ½ç›´æ¥åˆ›å»ºå¸¦æ³›å‹çš„æ•°ç»„ï¼Œå¿…é¡»å¼ºåˆ¶è½¬å‹ï¼›
- å¯ä»¥é€šè¿‡ `Array.newInstance(Class<T>, int)` åˆ›å»º `T[]` æ•°ç»„ï¼Œéœ€è¦å¼ºåˆ¶è½¬å‹ï¼›
- åŒæ—¶ä½¿ç”¨æ³›å‹å’Œå¯å˜å‚æ•°æ—¶éœ€è¦ç‰¹åˆ«å°å¿ƒã€‚
