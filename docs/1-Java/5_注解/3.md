---
title: å¤„ç†æ³¨è§£
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

Java çš„æ³¨è§£æœ¬èº«å¯¹ä»£ç é€»è¾‘æ²¡æœ‰ä»»ä½•å½±å“ã€‚æ ¹æ® `@Retention` çš„é…ç½®ï¼š

- `SOURCE` ç±»å‹çš„æ³¨è§£åœ¨ç¼–è¯‘æœŸå°±è¢«ä¸¢æ‰äº†ï¼›
- `CLASS` ç±»å‹çš„æ³¨è§£ä»…ä¿å­˜åœ¨ class æ–‡ä»¶ä¸­ï¼Œå®ƒä»¬ä¸ä¼šè¢«åŠ è½½è¿› JVMï¼›
- `RUNTIME` ç±»å‹çš„æ³¨è§£ä¼šè¢«åŠ è½½è¿› JVM ï¼Œå¹¶ä¸”åœ¨è¿è¡ŒæœŸå¯ä»¥è¢«ç¨‹åºè¯»å–ã€‚

å¦‚ä½•ä½¿ç”¨æ³¨è§£å®Œå…¨ç”±å·¥å…·å†³å®šã€‚`SOURCE` ç±»å‹çš„æ³¨è§£ä¸»è¦ç”±ç¼–è¯‘å™¨ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬ä¸€èˆ¬åªä½¿ç”¨ï¼Œä¸ç¼–å†™ã€‚`CLASS` ç±»å‹çš„æ³¨è§£ä¸»è¦ç”±åº•å±‚å·¥å…·åº“ä½¿ç”¨ï¼Œæ¶‰åŠåˆ° class çš„åŠ è½½ï¼Œä¸€èˆ¬æˆ‘ä»¬å¾ˆå°‘ç”¨åˆ°ã€‚åªæœ‰ `RUNTIME` ç±»å‹çš„æ³¨è§£ä¸ä½†è¦ä½¿ç”¨ï¼Œè¿˜ç»å¸¸éœ€è¦ç¼–å†™ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åªè®¨è®ºå¦‚ä½•è¯»å– `RUNTIME` ç±»å‹çš„æ³¨è§£ã€‚

å› ä¸ºæ³¨è§£å®šä¹‰åä¹Ÿæ˜¯ä¸€ç§ `class`ï¼Œæ‰€æœ‰çš„æ³¨è§£éƒ½ç»§æ‰¿è‡ª `java.lang.annotation.Annotation`ï¼Œå› æ­¤ï¼Œè¯»å–æ³¨è§£ï¼Œéœ€è¦ä½¿ç”¨åå°„ API ã€‚

Java æä¾›çš„ä½¿ç”¨åå°„ API è¯»å– `Annotation` çš„æ–¹æ³•åŒ…æ‹¬ï¼š

_åˆ¤æ–­æŸä¸ªæ³¨è§£æ˜¯å¦å­˜åœ¨äº `Class`ã€`Field`ã€`Method` æˆ– `Constructor`ï¼š_

- `Class.isAnnotationPresent(Class)`
- `Field.isAnnotationPresent(Class)`
- `Method.isAnnotationPresent(Class)`
- `Constructor.isAnnotationPresent(Class)`

ä¾‹å¦‚ï¼š

```java
// åˆ¤æ–­ @Report æ˜¯å¦å­˜åœ¨äº Person ç±»:
Person.class.isAnnotationPresent(Report.class);
```

_ä½¿ç”¨åå°„ API è¯»å– Annotation ï¼š_

- `Class.getAnnotation(Class)`
- `Field.getAnnotation(Class)`
- `Method.getAnnotation(Class)`
- `Constructor.getAnnotation(Class)`

ä¾‹å¦‚ï¼š

```java
// è·å– Person å®šä¹‰çš„ @Report æ³¨è§£:
Report report = Person.class.getAnnotation(Report.class);
int type = report.type();
String level = report.level();
```

ä½¿ç”¨åå°„ API è¯»å– `Annotation` æœ‰ä¸¤ç§æ–¹æ³•ã€‚

1. æ–¹æ³•ä¸€æ˜¯å…ˆåˆ¤æ–­ `Annotation` æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±ç›´æ¥è¯»å–ï¼š

```java
Class cls = Person.class;
if (cls.isAnnotationPresent(Report.class)) {
    Report report = cls.getAnnotation(Report.class);
    // ...
}
```

2. ç¬¬äºŒç§æ–¹æ³•æ˜¯ç›´æ¥è¯»å– `Annotation`ï¼Œå¦‚æœ `Annotation` ä¸å­˜åœ¨ï¼Œå°†è¿”å› `null` ï¼š

```java
Class cls = Person.class;
Report report = cls.getAnnotation(Report.class);
if (report != null) {
//    ...
}
```

è¯»å–æ–¹æ³•ã€å­—æ®µå’Œæ„é€ æ–¹æ³•çš„ `Annotation` å’Œ `Class` ç±»ä¼¼ã€‚ä½†è¦è¯»å–æ–¹æ³•å‚æ•°çš„ `Annotation` å°±æ¯”è¾ƒéº»çƒ¦ä¸€ç‚¹ï¼Œå› ä¸ºæ–¹æ³•å‚æ•°æœ¬èº«å¯ä»¥çœ‹æˆä¸€ä¸ªæ•°ç»„ï¼Œè€Œæ¯ä¸ªå‚æ•°åˆå¯ä»¥å®šä¹‰å¤šä¸ªæ³¨è§£ï¼Œæ‰€ä»¥ï¼Œä¸€æ¬¡è·å–æ–¹æ³•å‚æ•°çš„æ‰€æœ‰æ³¨è§£å°±å¿…é¡»ç”¨ä¸€ä¸ªäºŒç»´æ•°ç»„æ¥è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œå¯¹äºä»¥ä¸‹æ–¹æ³•å®šä¹‰çš„æ³¨è§£ï¼š

```java
public void hello(
    @NotNull
    @Range(max=5)
    String name,
    @NotNull
    String prefix) {
}
```

è¦è¯»å–æ–¹æ³•å‚æ•°çš„æ³¨è§£ï¼Œæˆ‘ä»¬å…ˆç”¨åå°„è·å– `Method` å®ä¾‹ï¼Œç„¶åè¯»å–æ–¹æ³•å‚æ•°çš„æ‰€æœ‰æ³¨è§£ï¼š

```java
// è·å– Method å®ä¾‹:
Method m = ...
// è·å–æ‰€æœ‰å‚æ•°çš„ Annotation:
Annotation[][] annos = m.getParameterAnnotations();
// ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆç´¢å¼•ä¸º 0ï¼‰çš„æ‰€æœ‰ Annotation:
Annotation[] annosOfName = annos[0];
for (Annotation anno : annosOfName) {
    if (anno instanceof Range) { // @Range æ³¨è§£
        Range r = (Range) anno;
    }
    if (anno instanceof NotNull) { // @NotNull æ³¨è§£
        NotNull n = (NotNull) anno;
    }
}
```

## ğŸ€ ä½¿ç”¨æ³¨è§£

æ³¨è§£å¦‚ä½•ä½¿ç”¨ï¼Œå®Œå…¨ç”±ç¨‹åºè‡ªå·±å†³å®šã€‚ä¾‹å¦‚ï¼Œ`JUnit` æ˜¯ä¸€ä¸ªæµ‹è¯•æ¡†æ¶ï¼Œå®ƒä¼šè‡ªåŠ¨è¿è¡Œæ‰€æœ‰æ ‡è®°ä¸º `@Test` çš„æ–¹æ³•ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª `@Range` æ³¨è§£ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨å®ƒæ¥å®šä¹‰ä¸€ä¸ª `String` å­—æ®µçš„è§„åˆ™ï¼šå­—æ®µé•¿åº¦æ»¡è¶³ `@Range` çš„å‚æ•°å®šä¹‰ï¼š

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.FIELD)
public @interface Range {
    int min() default 0;
    int max() default 255;
}
```

åœ¨æŸä¸ª JavaBean ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥æ³¨è§£ï¼š

```java
public class Person {
    @Range(min = 1, max = 20)
    public String name;

    @Range(max = 10)
    public String city;
}
```

ä½†æ˜¯ï¼Œå®šä¹‰äº†æ³¨è§£ï¼Œæœ¬èº«å¯¹ç¨‹åºé€»è¾‘æ²¡æœ‰ä»»ä½•å½±å“ã€‚æˆ‘ä»¬å¿…é¡»è‡ªå·±ç¼–å†™ä»£ç æ¥ä½¿ç”¨æ³¨è§£ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ª `Person` å®ä¾‹çš„æ£€æŸ¥æ–¹æ³•ï¼Œå®ƒå¯ä»¥æ£€æŸ¥ `Person` å®ä¾‹çš„ `String` å­—æ®µé•¿åº¦æ˜¯å¦æ»¡è¶³ `@Range` çš„å®šä¹‰ï¼š

```java
void check(Person person) throws IllegalArgumentException, ReflectiveOperationException {
    // éå†æ‰€æœ‰ Field:
    for (Field field : person.getClass().getFields()) {
        // è·å– Field å®šä¹‰çš„ @Range:
        Range range = field.getAnnotation(Range.class);
        // å¦‚æœ @Range å­˜åœ¨:
        if (range != null) {
            // è·å– Field çš„å€¼:
            Object value = field.get(person);
            // å¦‚æœå€¼æ˜¯ String:
            if (value instanceof String) {
                String s = (String) value;
                // åˆ¤æ–­å€¼æ˜¯å¦æ»¡è¶³ @Range çš„ min/max:
                if (s.length() < range.min() || s.length() > range.max()) {
                    throw new IllegalArgumentException("Invalid field:" + field.getName());
                }
            }
        }
    }
}
```

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ `@Range` æ³¨è§£ï¼Œé…åˆ `check()` æ–¹æ³•ï¼Œå°±å¯ä»¥å®Œæˆ `Person` å®ä¾‹çš„æ£€æŸ¥ã€‚æ³¨æ„æ£€æŸ¥é€»è¾‘å®Œå…¨æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ï¼ŒJVM ä¸ä¼šè‡ªåŠ¨ç»™æ³¨è§£æ·»åŠ ä»»ä½•é¢å¤–çš„é€»è¾‘ã€‚

## ğŸ€ ç»ƒä¹ 

ä½¿ç”¨ `@Range` æ³¨è§£æ¥æ£€æŸ¥ Java Bean çš„å­—æ®µã€‚å¦‚æœå­—æ®µç±»å‹æ˜¯ `String`ï¼Œå°±æ£€æŸ¥ `String` çš„é•¿åº¦ï¼Œå¦‚æœå­—æ®µæ˜¯ `int`ï¼Œå°±æ£€æŸ¥ `int` çš„èŒƒå›´ã€‚

```java
import java.lang.reflect.Field;

public class Main {
    public static void main(String[] args) throws Exception {
        Person p1 = new Person("Bob", "Beijing", 20);
        Person p2 = new Person("", "Shanghai", 20);
        Person p3 = new Person("Alice", "Shanghai", 199);

        for (Person p : new Person[] { p1, p2, p3 }) {
            try {
                check(p);
                System.out.println("Person " + p + " checked ok.");
            } catch (IllegalArgumentException e) {
                System.out.println("Person " + p + " checked failed: " + e);
            }
        }
    }

    static void check(PersonA personA) throws IllegalArgumentException, ReflectiveOperationException {
        for (Field field : personA.getClass().getFields()) {
            Range range = field.getAnnotation(Range.class);
            if (range != null) {
                Object value = field.get(personA);
                // TODO:
                // å¦‚æœå€¼æ˜¯ String
                if (value instanceof String) {
                    String s = (String) value;
                    // åˆ¤æ–­å€¼æ˜¯å¦æ»¡è¶³ @Range çš„ min/max:
                    if (s.length() < range.min() || s.length() > range.max()) {
                        throw new IllegalArgumentException("Invalid field:" + field.getName());
                    }
                } else if (value instanceof Integer) {// å¦‚æœå€¼æ˜¯ int
                    int i = (int) value;
                    if (i < range.min() || i > range.max()) {
                        throw new IllegalArgumentException("Invalid field:" + field.getName());
                    }
                }
            }
        }
    }
}

public class Person {

    @Range(min = 1, max = 20)
    public String name;

    @Range(max = 10)
    public String city;

    @Range(min = 1, max = 100)
    public int age;

    public Person(String name, String city, int age) {
        this.name = name;
        this.city = city;
        this.age = age;
    }

    @Override
    public String toString() {
        return String.format("{Person: name=%s, city=%s, age=%d}", name, city, age);
    }
}
```

```java
import java.lang.annotation.ElementType;
import java.lang.annotation.RetentionPolicy;

import java.lang.annotation.Retention;
import java.lang.annotation.Target;

@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.FIELD)
public @interface Range {

    int min() default 0;

    int max() default 255;

}
```

## ğŸ€ å°ç»“

1. å¯ä»¥åœ¨è¿è¡ŒæœŸé€šè¿‡åå°„è¯»å– `RUNTIME` ç±»å‹çš„æ³¨è§£ï¼Œæ³¨æ„åƒä¸‡ä¸è¦æ¼å†™ `@Retention(RetentionPolicy.RUNTIME)`ï¼Œå¦åˆ™è¿è¡ŒæœŸæ— æ³•è¯»å–åˆ°è¯¥æ³¨è§£ã€‚
2. å¯ä»¥é€šè¿‡ç¨‹åºå¤„ç†æ³¨è§£æ¥å®ç°ç›¸åº”çš„åŠŸèƒ½ï¼š
   - å¯¹ JavaBean çš„å±æ€§å€¼æŒ‰è§„åˆ™è¿›è¡Œæ£€æŸ¥ï¼›
   - JUnit ä¼šè‡ªåŠ¨è¿è¡Œ `@Test` æ ‡è®°çš„æµ‹è¯•æ–¹æ³•ã€‚
