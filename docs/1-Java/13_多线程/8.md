---
title: æ­»é”
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

Java çš„çº¿ç¨‹é”æ˜¯**å¯é‡å…¥**çš„é”ã€‚

ä»€ä¹ˆæ˜¯å¯é‡å…¥çš„é”ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹ä¾‹å­ï¼š

```java
public class Counter {
    private int count = 0;

    public synchronized void add(int n) {
        if (n < 0) {
            dec(-n);
        } else {
            count += n;
        }
    }

    public synchronized void dec(int n) {
        count += n;
    }
}
```

è§‚å¯Ÿ `synchronized` ä¿®é¥°çš„ `add()` æ–¹æ³•ï¼Œä¸€æ—¦çº¿ç¨‹æ‰§è¡Œåˆ° `add()` æ–¹æ³•å†…éƒ¨ï¼Œè¯´æ˜å®ƒå·²ç»è·å–äº†å½“å‰å®ä¾‹çš„ `this` é”ã€‚å¦‚æœä¼ å…¥çš„ `n < 0`ï¼Œå°†åœ¨ `add()` æ–¹æ³•å†…éƒ¨è°ƒç”¨ `dec()` æ–¹æ³•ã€‚ç”±äº `dec()` æ–¹æ³•ä¹Ÿéœ€è¦è·å– `this` é”ï¼Œç°åœ¨é—®é¢˜æ¥äº†ï¼š

> å¯¹åŒä¸€ä¸ªçº¿ç¨‹ï¼Œèƒ½å¦åœ¨è·å–åˆ°é”ä»¥åç»§ç»­è·å–åŒä¸€ä¸ªé”ï¼Ÿ

ç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚JVM å…è®¸åŒä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–åŒä¸€ä¸ªé”ï¼Œè¿™ç§ _èƒ½è¢«åŒä¸€ä¸ªçº¿ç¨‹åå¤è·å–çš„é”_ï¼Œå°±å«åš**å¯é‡å…¥é”**ã€‚

ç”±äº Java çš„çº¿ç¨‹é”æ˜¯å¯é‡å…¥é”ï¼Œæ‰€ä»¥ï¼Œè·å–é”çš„æ—¶å€™ï¼Œä¸ä½†è¦åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è·å–ï¼Œè¿˜è¦è®°å½•è¿™æ˜¯ç¬¬å‡ æ¬¡è·å–ã€‚æ¯è·å–ä¸€æ¬¡é”ï¼Œè®°å½• +1ï¼Œæ¯é€€å‡º `synchronized` å—ï¼Œè®°å½• -1ï¼Œå‡åˆ° 0 çš„æ—¶å€™ï¼Œæ‰ä¼šçœŸæ­£é‡Šæ”¾é”ã€‚

### æ­»é”

ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–ä¸€ä¸ªé”åï¼Œå†ç»§ç»­è·å–å¦ä¸€ä¸ªé”ã€‚ä¾‹å¦‚ï¼š

```java
public void add(int m) {
    synchronized(lockA) { // è·å¾— lockA çš„é”
        this.value += m;
        synchronized(lockB) { // è·å¾— lockB çš„é”
            this.another += m;
        } // é‡Šæ”¾ lockB çš„é”
    } // é‡Šæ”¾ lockA çš„é”
}

public void dec(int m) {
    synchronized(lockB) { // è·å¾— lockB çš„é”
        this.another -= m;
        synchronized(lockA) { // è·å¾— lockA çš„é”
            this.value -= m;
        } // é‡Šæ”¾ lockA çš„é”
    } // é‡Šæ”¾ lockB çš„é”
}
```

åœ¨è·å–å¤šä¸ªé”çš„æ—¶å€™ï¼Œä¸åŒçº¿ç¨‹è·å–å¤šä¸ªä¸åŒå¯¹è±¡çš„é”å¯èƒ½å¯¼è‡´æ­»é”ã€‚å¯¹äºä¸Šè¿°ä»£ç ï¼Œçº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 å¦‚æœåˆ†åˆ«æ‰§è¡Œ `add()` å’Œ `dec()` æ–¹æ³•æ—¶ï¼š

- çº¿ç¨‹ 1ï¼šè¿›å…¥ `add()`ï¼Œè·å¾— `lockA`ï¼›
- çº¿ç¨‹ 2ï¼šè¿›å…¥ `dec()`ï¼Œè·å¾— `lockB`ã€‚

éšåï¼š

- çº¿ç¨‹ 1ï¼šå‡†å¤‡è·å¾— `lockB`ï¼Œå¤±è´¥ï¼Œç­‰å¾…ä¸­ï¼›
- çº¿ç¨‹ 2ï¼šå‡†å¤‡è·å¾— `lockA`ï¼Œå¤±è´¥ï¼Œç­‰å¾…ä¸­ã€‚

æ­¤æ—¶ï¼Œ_ä¸¤ä¸ªçº¿ç¨‹å„è‡ªæŒæœ‰ä¸åŒçš„é”ï¼Œç„¶åå„è‡ªè¯•å›¾è·å–å¯¹æ–¹æ‰‹é‡Œçš„é”ï¼Œé€ æˆäº†åŒæ–¹æ— é™ç­‰å¾…ä¸‹å»_ï¼Œè¿™å°±æ˜¯ **æ­»é”**ã€‚

æ­»é”å‘ç”Ÿåï¼Œæ²¡æœ‰ä»»ä½•æœºåˆ¶èƒ½è§£é™¤æ­»é”ï¼Œåªèƒ½å¼ºåˆ¶ç»“æŸ JVM è¿›ç¨‹ã€‚

å› æ­¤ï¼Œåœ¨ç¼–å†™å¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼Œè¦ç‰¹åˆ«æ³¨æ„é˜²æ­¢æ­»é”ã€‚å› ä¸º ~~æ­»é”ä¸€æ—¦å½¢æˆï¼Œå°±åªèƒ½å¼ºåˆ¶ç»“æŸè¿›ç¨‹~~ã€‚

> é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•é¿å…æ­»é”å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼š_çº¿ç¨‹è·å–é”çš„é¡ºåºè¦ä¸€è‡´_ã€‚å³ä¸¥æ ¼æŒ‰ç…§å…ˆè·å– `lockA`ï¼Œå†è·å– `lockB` çš„é¡ºåºï¼Œæ”¹å†™ `dec()` æ–¹æ³•å¦‚ä¸‹ï¼š

```java
public void dec(int m) {
    synchronized(lockA) { // è·å¾— lockA çš„é”
        this.value -= m;
        synchronized(lockB) { // è·å¾— lockB çš„é”
            this.another -= m;
        } // é‡Šæ”¾ lockB çš„é”
    } // é‡Šæ”¾ lockA çš„é”
}
```

## ğŸ€ ç»ƒä¹ 

è¯·è§‚å¯Ÿæ­»é”çš„ä»£ç è¾“å‡ºï¼Œç„¶åä¿®å¤ã€‚

```java
public class Main {
    static final Object LOCK_A = new Object();
    static final Object LOCK_B = new Object();

    public static void main(String[] args) {
        new Thread1().start();
        new Thread2().start();
    }

    static void sleep1s() {
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}

class Thread1 extends Thread {

    public void run() {
        System.out.println("Thread-1: try get lock A...");
        synchronized (Main.LOCK_A) {
            System.out.println("Thread-1: lock A got.");
            Main.sleep1s();
            System.out.println("Thread-1: try get lock B...");
            synchronized (Main.LOCK_B) {
                System.out.println("Thread-1: lock B got.");
                Main.sleep1s();
            }
            System.out.println("Thread-1: lock B released.");
        }
        System.out.println("Thread-1: lock A released.");
    }
}

class Thread2 extends Thread {
    public void run() {
        // System.out.println("Thread-2: try get lock B...");
        // synchronized (Main.LOCK_B) {
        //     System.out.println("Thread-2: lock B got.");
        //     Main.sleep1s();
        //     System.out.println("Thread-2: try get lock A...");
        //     synchronized (Main.LOCK_A) {
        //         System.out.println("Thread-2: lock A got.");
        //         Main.sleep1s();
        //     }
        //     System.out.println("Thread-2: lock A released.");
        // }
        // System.out.println("Thread-2: lock B released.");
        /**
         * 2 ä¸ªçº¿ç¨‹è·å–é”çš„é¡ºåºè¦ä¸€è‡´ï¼Œå…ˆ A å B
         */
        System.out.println("Thread-2: try get lock A...");
        synchronized (DeadlockTest.LOCK_A) {
            System.out.println("Thread-2: lock A got.");
            DeadlockTest.sleep1s();
            System.out.println("Thread-2: try get lock B...");
            synchronized (DeadlockTest.LOCK_B) {
                System.out.println("Thread-2: lock B got.");
                DeadlockTest.sleep1s();
            }
            System.out.println("Thread-2: lock B released.");
        }
        System.out.println("Thread-2: lock A released.");
    }
}
```

## ğŸ€ å°ç»“

- Java çš„ `synchronized` é”æ˜¯å¯é‡å…¥é”ï¼›

- æ­»é”äº§ç”Ÿçš„æ¡ä»¶æ˜¯å¤šçº¿ç¨‹å„è‡ªæŒæœ‰ä¸åŒçš„é”ï¼Œå¹¶äº’ç›¸è¯•å›¾è·å–å¯¹æ–¹å·²æŒæœ‰çš„é”ï¼Œå¯¼è‡´æ— é™ç­‰å¾…ï¼›

- é¿å…æ­»é”çš„æ–¹æ³•æ˜¯å¤šçº¿ç¨‹è·å–é”çš„é¡ºåºè¦ä¸€è‡´ã€‚
