---
title: ä½¿ç”¨ CompletableFuture
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::


ä½¿ç”¨ `Future` è·å¾—å¼‚æ­¥æ‰§è¡Œç»“æœæ—¶ï¼Œè¦ä¹ˆè°ƒç”¨é˜»å¡æ–¹æ³• `get()`ï¼Œè¦ä¹ˆè½®è¯¢çœ‹ `isDone()` æ˜¯å¦ä¸º `true`ï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºä¸»çº¿ç¨‹ä¹Ÿä¼šè¢«è¿«ç­‰å¾…ã€‚

ä» Java 8 å¼€å§‹å¼•å…¥äº† `CompletableFuture`ï¼Œå®ƒé’ˆå¯¹ `Future` åšäº†æ”¹è¿›ï¼Œå¯ä»¥ä¼ å…¥å›è°ƒå¯¹è±¡ï¼Œå½“å¼‚æ­¥ä»»åŠ¡å®Œæˆæˆ–è€…å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨å›è°ƒå¯¹è±¡çš„å›è°ƒæ–¹æ³•ã€‚

æˆ‘ä»¬ä»¥è·å–è‚¡ç¥¨ä»·æ ¼ä¸ºä¾‹ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨ `CompletableFuture`ï¼š

```java
// CompletableFuture
import java.util.concurrent.CompletableFuture;

public class Main {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºå¼‚æ­¥æ‰§è¡Œä»»åŠ¡:
        CompletableFuture<Double> cf = CompletableFuture.supplyAsync(Main::fetchPrice);
        // å¦‚æœæ‰§è¡ŒæˆåŠŸ:
        cf.thenAccept((result) -> {
            System.out.println("price:" + result);
        });
        // å¦‚æœæ‰§è¡Œå¼‚å¸¸:
        cf.exceptionally((e) -> {
            e.printStackTrace();
            return null;
        });
        // ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™ CompletableFuture é»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
        Thread.sleep(200);
    }

    static Double fetchPrice() {
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
        }
        if (Math.random() < 0.3) {
            throw new RuntimeException("fetch price failed!");
        }
        return 5 + Math.random() * 20;
    }
}

```


åˆ›å»ºä¸€ä¸ª `CompletableFuture` æ˜¯é€šè¿‡ `CompletableFuture.supplyAsync()` å®ç°çš„ï¼Œå®ƒéœ€è¦ä¸€ä¸ªå®ç°äº† `Supplier` æ¥å£çš„å¯¹è±¡ï¼š

```java
public interface Supplier<T> {
    T get();
}
```

è¿™é‡Œæˆ‘ä»¬ç”¨ lambda è¯­æ³•ç®€åŒ–äº†ä¸€ä¸‹ï¼Œç›´æ¥ä¼ å…¥ `Main::fetchPrice`ï¼Œå› ä¸º `Main.fetchPrice()` é™æ€æ–¹æ³•çš„ç­¾åç¬¦åˆ `Supplier` æ¥å£çš„å®šä¹‰ï¼ˆé™¤äº†æ–¹æ³•åå¤–ï¼‰ã€‚

ç´§æ¥ç€ï¼Œ`CompletableFuture` å·²ç»è¢«æäº¤ç»™é»˜è®¤çš„çº¿ç¨‹æ± æ‰§è¡Œäº†ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰çš„æ˜¯ `CompletableFuture` å®Œæˆæ—¶å’Œå¼‚å¸¸æ—¶éœ€è¦å›è°ƒçš„å®ä¾‹ã€‚å®Œæˆæ—¶ï¼Œ`CompletableFuture` ä¼šè°ƒç”¨ `Consumer` å¯¹è±¡ï¼š

```java
public interface Consumer<T> {
    void accept(T t);
}
```

å¼‚å¸¸æ—¶ï¼Œ`CompletableFuture` ä¼šè°ƒç”¨ `Function` å¯¹è±¡ï¼š

```java
public interface Function<T, R> {
    R apply(T t);
}
```

è¿™é‡Œæˆ‘ä»¬éƒ½ç”¨ lambda è¯­æ³•ç®€åŒ–äº†ä»£ç ã€‚

å¯è§ `CompletableFuture` çš„ä¼˜ç‚¹æ˜¯ï¼š

- å¼‚æ­¥ä»»åŠ¡ç»“æŸæ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼›
- å¼‚æ­¥ä»»åŠ¡å‡ºé”™æ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼›
- ä¸»çº¿ç¨‹è®¾ç½®å¥½å›è°ƒåï¼Œä¸å†å…³å¿ƒå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œã€‚

å¦‚æœåªæ˜¯å®ç°äº†å¼‚æ­¥å›è°ƒæœºåˆ¶ï¼Œæˆ‘ä»¬è¿˜çœ‹ä¸å‡º `CompletableFuture` ç›¸æ¯” `Future` çš„ä¼˜åŠ¿ã€‚`CompletableFuture` æ›´å¼ºå¤§çš„åŠŸèƒ½æ˜¯ï¼Œå¤šä¸ª `CompletableFuture` å¯ä»¥ä¸²è¡Œæ‰§è¡Œï¼Œä¾‹å¦‚ï¼Œå®šä¹‰ä¸¤ä¸ª `CompletableFuture`ï¼Œç¬¬ä¸€ä¸ª `CompletableFuture` æ ¹æ®è¯åˆ¸åç§°æŸ¥è¯¢è¯åˆ¸ä»£ç ï¼Œç¬¬äºŒä¸ª `CompletableFuture` æ ¹æ®è¯åˆ¸ä»£ç æŸ¥è¯¢è¯åˆ¸ä»·æ ¼ï¼Œè¿™ä¸¤ä¸ª `CompletableFuture` å®ç°ä¸²è¡Œæ“ä½œå¦‚ä¸‹ï¼š

```java
// CompletableFuture
import java.util.concurrent.CompletableFuture;

public class Main {
    public static void main(String[] args) throws Exception {
        // ç¬¬ä¸€ä¸ªä»»åŠ¡:
        CompletableFuture<String> cfQuery = CompletableFuture.supplyAsync(() -> {
            return queryCode("ä¸­å›½çŸ³æ²¹");
        });
        // cfQuery æˆåŠŸåç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡:
        CompletableFuture<Double> cfFetch = cfQuery.thenApplyAsync((code) -> {
            return fetchPrice(code);
        });
        // cfFetch æˆåŠŸåæ‰“å°ç»“æœ:
        cfFetch.thenAccept((result) -> {
            System.out.println("price:" + result);
        });
        // ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™ CompletableFuture é»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
        Thread.sleep(2000);
    }

    static String queryCode(String name) {
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
        }
        return "601857";
    }

    static Double fetchPrice(String code) {
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
        }
        return 5 + Math.random() * 20;
    }
}
```


é™¤äº†ä¸²è¡Œæ‰§è¡Œå¤–ï¼Œå¤šä¸ª `CompletableFuture` è¿˜å¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼š

åŒæ—¶ä»æ–°æµªå’Œç½‘æ˜“æŸ¥è¯¢è¯åˆ¸ä»£ç ï¼Œåªè¦ä»»æ„ä¸€ä¸ªè¿”å›ç»“æœï¼Œå°±è¿›è¡Œä¸‹ä¸€æ­¥æŸ¥è¯¢ä»·æ ¼ï¼ŒæŸ¥è¯¢ä»·æ ¼ä¹ŸåŒæ—¶ä»æ–°æµªå’Œç½‘æ˜“æŸ¥è¯¢ï¼Œåªè¦ä»»æ„ä¸€ä¸ªè¿”å›ç»“æœï¼Œå°±å®Œæˆæ“ä½œï¼š

```java
// CompletableFuture
import java.util.concurrent.CompletableFuture;
public class Main {
    public static void main(String[] args) throws Exception {
        // ä¸¤ä¸ª CompletableFuture æ‰§è¡Œå¼‚æ­¥æŸ¥è¯¢:
        CompletableFuture<String> cfQueryFromSina = CompletableFuture.supplyAsync(() -> {
            return queryCode("ä¸­å›½çŸ³æ²¹", "https://finance.sina.com.cn/code/");
        });
        CompletableFuture<String> cfQueryFrom163 = CompletableFuture.supplyAsync(() -> {
            return queryCode("ä¸­å›½çŸ³æ²¹", "https://money.163.com/code/");
        });

        // ç”¨ anyOf åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„ CompletableFuture:
        CompletableFuture<Object> cfQuery = CompletableFuture.anyOf(cfQueryFromSina, cfQueryFrom163);

        // ä¸¤ä¸ª CompletableFuture æ‰§è¡Œå¼‚æ­¥æŸ¥è¯¢:
        CompletableFuture<Double> cfFetchFromSina = cfQuery.thenApplyAsync((code) -> {
            return fetchPrice((String) code, "https://finance.sina.com.cn/price/");
        });
        CompletableFuture<Double> cfFetchFrom163 = cfQuery.thenApplyAsync((code) -> {
            return fetchPrice((String) code, "https://money.163.com/price/");
        });

        // ç”¨ anyOf åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„ CompletableFuture:
        CompletableFuture<Object> cfFetch = CompletableFuture.anyOf(cfFetchFromSina, cfFetchFrom163);

        // æœ€ç»ˆç»“æœ:
        cfFetch.thenAccept((result) -> {
            System.out.println("price:" + result);
        });
        // ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™ CompletableFuture é»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
        Thread.sleep(200);
    }

    static String queryCode(String name, String url) {
        System.out.println("query code from" + url + "...");
        try {
            Thread.sleep((long) (Math.random() * 100));
        } catch (InterruptedException e) {
        }
        return "601857";
    }

    static Double fetchPrice(String code, String url) {
        System.out.println("query price from" + url + "...");
        try {
            Thread.sleep((long) (Math.random() * 100));
        } catch (InterruptedException e) {
        }
        return 5 + Math.random() * 20;
    }
}
```


ä¸Šè¿°é€»è¾‘å®ç°çš„å¼‚æ­¥æŸ¥è¯¢è§„åˆ™å®é™…ä¸Šæ˜¯ï¼š

![image-20231129160059946](assets/image-20231129160059946.png)

é™¤äº† `anyOf()` å¯ä»¥å®ç° â€œä»»æ„ä¸ª `CompletableFuture` åªè¦ä¸€ä¸ªæˆåŠŸâ€ï¼Œ`allOf()` å¯ä»¥å®ç° â€œæ‰€æœ‰ `CompletableFuture` éƒ½å¿…é¡»æˆåŠŸâ€ï¼Œè¿™äº›ç»„åˆæ“ä½œå¯ä»¥å®ç°éå¸¸å¤æ‚çš„å¼‚æ­¥æµç¨‹æ§åˆ¶ã€‚

æœ€åæˆ‘ä»¬æ³¨æ„ `CompletableFuture` çš„å‘½åè§„åˆ™ï¼š

- `xxx()`ï¼šè¡¨ç¤ºè¯¥æ–¹æ³•å°†ç»§ç»­åœ¨å·²æœ‰çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼›
- `xxxAsync()`ï¼šè¡¨ç¤ºå°†å¼‚æ­¥åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚

## ğŸ€ ç»ƒä¹ 

```java
package com.itranswarp.learnjava;

import java.util.concurrent.CompletableFuture;

/**
 * Learn Java from https://www.liaoxuefeng.com/
 *
 * @author liaoxuefeng
 */
public class Main {
	public static void main(String[] args) throws Exception {
		// ä¸¤ä¸ª CompletableFuture æ‰§è¡Œå¼‚æ­¥æŸ¥è¯¢:
		CompletableFuture<String> cfQueryFromSina = CompletableFuture.supplyAsync(() -> {
			return queryCode("ä¸­å›½çŸ³æ²¹", "https://finance.sina.com.cn/code/");
		});
		CompletableFuture<String> cfQueryFrom163 = CompletableFuture.supplyAsync(() -> {
			return queryCode("ä¸­å›½çŸ³æ²¹", "https://money.163.com/code/");
		});

		// ç”¨ anyOf åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„ CompletableFuture:
		CompletableFuture<Object> cfQuery = CompletableFuture.anyOf(cfQueryFromSina, cfQueryFrom163);

		// ä¸¤ä¸ª CompletableFuture æ‰§è¡Œå¼‚æ­¥æŸ¥è¯¢:
		CompletableFuture<Double> cfFetchFromSina = cfQuery.thenApplyAsync((code) -> {
			return fetchPrice((String) code, "https://finance.sina.com.cn/price/");
		});
		CompletableFuture<Double> cfFetchFrom163 = cfQuery.thenApplyAsync((code) -> {
			return fetchPrice((String) code, "https://money.163.com/price/");
		});

		// ç”¨ anyOf åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„ CompletableFuture:
		CompletableFuture<Object> cfFetch = CompletableFuture.anyOf(cfFetchFromSina, cfFetchFrom163);

		// æœ€ç»ˆç»“æœ:
		cfFetch.thenAccept((result) -> {
			System.out.println("price:" + result);
		});
		// ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™ CompletableFuture é»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
		Thread.sleep(2000);
	}

	static String queryCode(String name, String url) {
		System.out.println("query code from" + url + "...");
		try {
			Thread.sleep((long) Math.random() * 1000);
		} catch (InterruptedException e) {
		}
		return "601857";
	}

	static Double fetchPrice(String code, String url) {
		System.out.println("query price from" + url + "...");
		try {
			Thread.sleep((long) Math.random() * 1000);
		} catch (InterruptedException e) {
		}
		return 5 + Math.random() * 20;
	}
}
```

## ğŸ€ å°ç»“

`CompletableFuture` å¯ä»¥æŒ‡å®šå¼‚æ­¥å¤„ç†æµç¨‹ï¼š

- `thenAccept()` å¤„ç†æ­£å¸¸ç»“æœï¼›
- `exceptional()` å¤„ç†å¼‚å¸¸ç»“æœï¼›
- `thenApplyAsync()` ç”¨äºä¸²è¡ŒåŒ–å¦ä¸€ä¸ª `CompletableFuture`ï¼›
- `anyOf()` å’Œ `allOf()` ç”¨äºå¹¶è¡ŒåŒ–å¤šä¸ª `CompletableFuture`