---
title: ä½¿ç”¨ ThreadLocal
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

å¤šçº¿ç¨‹æ˜¯ Java å®ç°å¤šä»»åŠ¡çš„åŸºç¡€ï¼Œ`Thread` å¯¹è±¡ä»£è¡¨ä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­è°ƒç”¨ `Thread.currentThread()` è·å–å½“å‰çº¿ç¨‹ã€‚ä¾‹å¦‚ï¼Œæ‰“å°æ—¥å¿—æ—¶ï¼Œå¯ä»¥åŒæ—¶æ‰“å°å‡ºå½“å‰çº¿ç¨‹çš„åå­—ï¼š

```java
public class Main {
    public static void main(String[] args) throws Exception {
        log("start main...");
        new Thread(() -> {
            log("run task...");
        }).start();
        new Thread(() -> {
            log("print...");
        }).start();
        log("end main.");
    }

    static void log(String s) {
        System.out.println(Thread.currentThread().getName() + ":" + s);
    }
}
```

å¯¹äºå¤šä»»åŠ¡ï¼ŒJava æ ‡å‡†åº“æä¾›çš„çº¿ç¨‹æ± å¯ä»¥æ–¹ä¾¿åœ°æ‰§è¡Œè¿™äº›ä»»åŠ¡ï¼ŒåŒæ—¶å¤ç”¨çº¿ç¨‹ã€‚Web åº”ç”¨ç¨‹åºå°±æ˜¯å…¸å‹çš„å¤šä»»åŠ¡åº”ç”¨ï¼Œæ¯ä¸ªç”¨æˆ·è¯·æ±‚é¡µé¢æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šåˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œç±»ä¼¼ï¼š

```java
public void process(User user) {
    checkPermission();
    doWork();
    saveStatus();
    sendResponse();
}
```

ç„¶åï¼Œé€šè¿‡çº¿ç¨‹æ± å»æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚

è§‚å¯Ÿ `process()` æ–¹æ³•ï¼Œå®ƒå†…éƒ¨éœ€è¦è°ƒç”¨è‹¥å¹²å…¶ä»–æ–¹æ³•ï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå¦‚ä½•åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ä¼ é€’çŠ¶æ€ï¼Ÿ

`process()` æ–¹æ³•éœ€è¦ä¼ é€’çš„çŠ¶æ€å°±æ˜¯ `User` å®ä¾‹ã€‚æœ‰çš„ç«¥é‹ä¼šæƒ³ï¼Œç®€å•åœ°ä¼ å…¥ `User` å°±å¯ä»¥äº†ï¼š

```java
public void process(User user) {
    checkPermission(user);
    doWork(user);
    saveStatus(user);
    sendResponse(user);
}
```

ä½†æ˜¯å¾€å¾€ä¸€ä¸ªæ–¹æ³•åˆä¼šè°ƒç”¨å…¶ä»–å¾ˆå¤šæ–¹æ³•ï¼Œè¿™æ ·ä¼šå¯¼è‡´ `User` ä¼ é€’åˆ°æ‰€æœ‰åœ°æ–¹ï¼š

```java
void doWork(User user) {
    queryStatus(user);
    checkStatus();
    setNewStatus(user);
    log();
}
```

è¿™ç§åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œæ¨ªè·¨è‹¥å¹²æ–¹æ³•è°ƒç”¨ï¼Œéœ€è¦ä¼ é€’çš„å¯¹è±¡ï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¹‹ä¸º**ä¸Šä¸‹æ–‡**ï¼ˆContextï¼‰ï¼Œå®ƒæ˜¯ä¸€ç§çŠ¶æ€ï¼Œå¯ä»¥æ˜¯ç”¨æˆ·èº«ä»½ã€ä»»åŠ¡ä¿¡æ¯ç­‰ã€‚

ç»™æ¯ä¸ªæ–¹æ³•å¢åŠ ä¸€ä¸ª context å‚æ•°éå¸¸éº»çƒ¦ï¼Œè€Œä¸”æœ‰äº›æ—¶å€™ï¼Œå¦‚æœè°ƒç”¨é“¾æœ‰æ— æ³•ä¿®æ”¹æºç çš„ç¬¬ä¸‰æ–¹åº“ï¼Œ`User` å¯¹è±¡å°±ä¼ ä¸è¿›å»äº†ã€‚

---

Java æ ‡å‡†åº“æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„ `ThreadLocal`ï¼Œå®ƒå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä¼ é€’åŒä¸€ä¸ªå¯¹è±¡ã€‚

`ThreadLocal` å®ä¾‹é€šå¸¸æ€»æ˜¯ä»¥é™æ€å­—æ®µåˆå§‹åŒ–å¦‚ä¸‹ï¼š

```java
static ThreadLocal<User> threadLocalUser = new ThreadLocal<>();
```

å®ƒçš„å…¸å‹ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```java
void processUser(user) {
    try {
        threadLocalUser.set(user);
        step1();
        step2();
    } finally {
        threadLocalUser.remove();
    }
}
```

é€šè¿‡è®¾ç½®ä¸€ä¸ª `User` å®ä¾‹å…³è”åˆ° `ThreadLocal` ä¸­ï¼Œåœ¨ç§»é™¤ä¹‹å‰ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½å¯ä»¥éšæ—¶è·å–åˆ°è¯¥ `User` å®ä¾‹ï¼š

```java
void step1() {
    User u = threadLocalUser.get();
    log();
    printUser();
}

void log() {
    User u = threadLocalUser.get();
    println(u.name);
}

void step2() {
    User u = threadLocalUser.get();
    checkUser(u.id);
}
```

æ³¨æ„åˆ°æ™®é€šçš„æ–¹æ³•è°ƒç”¨ä¸€å®šæ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ï¼Œ`step1()`ã€`step2()` ä»¥åŠ `log()` æ–¹æ³•å†…ï¼Œ`threadLocalUser.get()` è·å–çš„ `User` å¯¹è±¡æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚

å®é™…ä¸Šï¼Œå¯ä»¥æŠŠ `ThreadLocal` çœ‹æˆä¸€ä¸ªå…¨å±€ `Map<Thread, Object>`ï¼šæ¯ä¸ªçº¿ç¨‹è·å– `ThreadLocal` å˜é‡æ—¶ï¼Œæ€»æ˜¯ä½¿ç”¨ `Thread` è‡ªèº«ä½œä¸º keyï¼š

```java
Object threadLocalValue = threadLocalMap.get(Thread.currentThread());
```

å› æ­¤ï¼Œ`ThreadLocal` ç›¸å½“äºç»™æ¯ä¸ªçº¿ç¨‹éƒ½å¼€è¾Ÿäº†ä¸€ä¸ªç‹¬ç«‹çš„å­˜å‚¨ç©ºé—´ï¼Œå„ä¸ªçº¿ç¨‹çš„ `ThreadLocal` å…³è”çš„å®ä¾‹äº’ä¸å¹²æ‰°ã€‚

æœ€åï¼Œç‰¹åˆ«æ³¨æ„ `ThreadLocal` ä¸€å®šè¦åœ¨ `finally` ä¸­æ¸…é™¤ï¼š

```java
try {
    threadLocalUser.set(user);
    ...
} finally {
    threadLocalUser.remove();
}
```

è¿™æ˜¯å› ä¸ºå½“å‰çº¿ç¨‹æ‰§è¡Œå®Œç›¸å…³ä»£ç åï¼Œå¾ˆå¯èƒ½ä¼šè¢«é‡æ–°æ”¾å…¥çº¿ç¨‹æ± ä¸­ï¼Œå¦‚æœ `ThreadLocal` æ²¡æœ‰è¢«æ¸…é™¤ï¼Œè¯¥çº¿ç¨‹æ‰§è¡Œå…¶ä»–ä»£ç æ—¶ï¼Œä¼šæŠŠä¸Šä¸€æ¬¡çš„çŠ¶æ€å¸¦è¿›å»ã€‚

ä¸ºäº†ä¿è¯èƒ½é‡Šæ”¾ `ThreadLocal` å…³è”çš„å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `AutoCloseable` æ¥å£é…åˆ `try (resource) {...}` ç»“æ„ï¼Œè®©ç¼–è¯‘å™¨è‡ªåŠ¨ä¸ºæˆ‘ä»¬å…³é—­ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªä¿å­˜äº†å½“å‰ç”¨æˆ·åçš„ `ThreadLocal` å¯ä»¥å°è£…ä¸ºä¸€ä¸ª `UserContext` å¯¹è±¡ï¼š

```java
public class UserContext implements AutoCloseable {

    static final ThreadLocal<String> ctx = new ThreadLocal<>();

    public UserContext(String user) {
        ctx.set(user);
    }

    public static String currentUser() {
        return ctx.get();
    }

    @Override
    public void close() {
        ctx.remove();
    }
}
```

ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å€ŸåŠ© `try (resource) {...}` ç»“æ„ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼š

```java
try (var ctx = new UserContext("Bob")) {
    // å¯ä»»æ„è°ƒç”¨ UserContext.currentUser():
    String currentUser = UserContext.currentUser();
} // åœ¨æ­¤è‡ªåŠ¨è°ƒç”¨ UserContext.close() æ–¹æ³•é‡Šæ”¾ ThreadLocal å…³è”å¯¹è±¡
```

è¿™æ ·å°±åœ¨ `UserContext` ä¸­å®Œå…¨å°è£…äº† `ThreadLocal`ï¼Œå¤–éƒ¨ä»£ç åœ¨ `try (resource) {...}` å†…éƒ¨å¯ä»¥éšæ—¶è°ƒç”¨ `UserContext.currentUser()` è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„ç”¨æˆ·åã€‚

## ğŸ€ ç»ƒä¹ 

```java
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

public class Main {
	public static void main(String[] args) throws Exception {
		ExecutorService es = Executors.newFixedThreadPool(3);
		String[] users = new String[] { "Bob", "Alice", "Tim", "Mike", "Lily", "Jack", "Bush" };
		for (String user : users) {
			es.submit(new Task(user));
		}
		es.awaitTermination(3, TimeUnit.SECONDS);
		es.shutdown();
	}
}

class UserContext implements AutoCloseable {
	private static final ThreadLocal<String> userThreadLocal = new ThreadLocal<>();

	public UserContext(String name) {
		userThreadLocal.set(name);
		System.out.printf("[%s] init user %s...\n", Thread.currentThread().getName(), UserContext.getCurrentUser());
	}

	public static String getCurrentUser() {
		return userThreadLocal.get();
	}

	@Override
	public void close() {
		System.out.printf("[%s] cleanup for user %s...\n", Thread.currentThread().getName(),
				UserContext.getCurrentUser());
		userThreadLocal.remove();
	}
}

class Task implements Runnable {

	final String username;

	public Task(String username) {
		this.username = username;
	}

	@Override
	public void run() {
		try (var ctx = new UserContext(this.username)) {
			new Task1().process();
			new Task2().process();
			new Task3().process();
		}
	}
}

class Task1 {
	public void process() {
		try {
			Thread.sleep(100);
		} catch (InterruptedException e) {
		}
		System.out.printf("[%s] check user %s...\n", Thread.currentThread().getName(), UserContext.getCurrentUser());
	}
}

class Task2 {
	public void process() {
		try {
			Thread.sleep(100);
		} catch (InterruptedException e) {
		}
		System.out.printf("[%s] %s registered ok.\n", Thread.currentThread().getName(), UserContext.getCurrentUser());
	}
}

class Task3 {
	public void process() {
		try {
			Thread.sleep(100);
		} catch (InterruptedException e) {
		}
		System.out.printf("[%s] work of %s has done.\n", Thread.currentThread().getName(),
				UserContext.getCurrentUser());
	}
}
```

## ğŸ€ å°ç»“

- `ThreadLocal` è¡¨ç¤ºçº¿ç¨‹çš„ â€œå±€éƒ¨å˜é‡â€ï¼Œå®ƒç¡®ä¿æ¯ä¸ªçº¿ç¨‹çš„ `ThreadLocal` å˜é‡éƒ½æ˜¯å„è‡ªç‹¬ç«‹çš„ï¼›

- `ThreadLocal` é€‚åˆåœ¨ä¸€ä¸ªçº¿ç¨‹çš„å¤„ç†æµç¨‹ä¸­ä¿æŒä¸Šä¸‹æ–‡ï¼ˆé¿å…äº†åŒä¸€å‚æ•°åœ¨æ‰€æœ‰æ–¹æ³•ä¸­ä¼ é€’ï¼‰ï¼›

- ä½¿ç”¨ `ThreadLocal` è¦ç”¨ `try ... finally` ç»“æ„ï¼Œå¹¶åœ¨ `finally` ä¸­æ¸…é™¤ã€‚
