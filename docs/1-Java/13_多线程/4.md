---
title: ä¸­æ–­çº¿ç¨‹
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

å¦‚æœçº¿ç¨‹éœ€è¦æ‰§è¡Œä¸€ä¸ªé•¿æ—¶é—´ä»»åŠ¡ï¼Œå°±å¯èƒ½éœ€è¦èƒ½ä¸­æ–­çº¿ç¨‹ã€‚

> [!tip]
> ä¸­æ–­çº¿ç¨‹å°±æ˜¯å…¶ä»–çº¿ç¨‹ç»™è¯¥çº¿ç¨‹å‘ä¸€ä¸ªä¿¡å·ï¼Œè¯¥çº¿ç¨‹æ”¶åˆ°ä¿¡å·åç»“æŸæ‰§è¡Œ `run()` æ–¹æ³•ï¼Œä½¿å¾—è‡ªèº«çº¿ç¨‹èƒ½ç«‹åˆ»ç»“æŸè¿è¡Œã€‚

æˆ‘ä»¬ä¸¾ä¸ªæ —å­ï¼šå‡è®¾ä»ç½‘ç»œä¸‹è½½ä¸€ä¸ª 100M çš„æ–‡ä»¶ï¼Œå¦‚æœç½‘é€Ÿå¾ˆæ…¢ï¼Œç”¨æˆ·ç­‰å¾—ä¸è€çƒ¦ï¼Œå°±å¯èƒ½åœ¨ä¸‹è½½è¿‡ç¨‹ä¸­ç‚¹ â€œå–æ¶ˆâ€ï¼Œè¿™æ—¶ï¼Œç¨‹åºå°±éœ€è¦ä¸­æ–­ä¸‹è½½çº¿ç¨‹çš„æ‰§è¡Œã€‚

ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨å…¶ä»–çº¿ç¨‹ä¸­å¯¹ç›®æ ‡çº¿ç¨‹è°ƒç”¨ `interrupt()` æ–¹æ³•ï¼Œç›®æ ‡çº¿ç¨‹éœ€è¦åå¤æ£€æµ‹è‡ªèº«çŠ¶æ€æ˜¯å¦æ˜¯ `interrupted` çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œå°±ç«‹åˆ»ç»“æŸè¿è¡Œã€‚

æˆ‘ä»¬è¿˜æ˜¯çœ‹ç¤ºä¾‹ä»£ç ï¼š

```java
public class Main {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new MyThread();
        t.start();
        Thread.sleep(1); // æš‚åœ 1 æ¯«ç§’
        t.interrupt(); // ä¸­æ–­ t çº¿ç¨‹
        t.join(); // ç­‰å¾… t çº¿ç¨‹ç»“æŸ
        System.out.println("end");
    }
}

class MyThread extends Thread {
    public void run() {
        int n = 0;
        while (! isInterrupted()) {
            n ++;
            System.out.println(n + "hello!");
        }
    }
}
```

ä»”ç»†çœ‹ä¸Šè¿°ä»£ç ï¼Œ`main` çº¿ç¨‹é€šè¿‡è°ƒç”¨ `t.interrupt()` æ–¹æ³•ä¸­æ–­ `t` çº¿ç¨‹ï¼Œä½†æ˜¯è¦æ³¨æ„ï¼Œ`interrupt()` æ–¹æ³•ä»…ä»…å‘ `t` çº¿ç¨‹å‘å‡ºäº† â€œä¸­æ–­è¯·æ±‚â€ï¼Œè‡³äº `t` çº¿ç¨‹æ˜¯å¦èƒ½ç«‹åˆ»å“åº”ï¼Œè¦çœ‹å…·ä½“ä»£ç ã€‚è€Œ `t` çº¿ç¨‹çš„ `while` å¾ªç¯ä¼šæ£€æµ‹ `isInterrupted()`ï¼Œæ‰€ä»¥ä¸Šè¿°ä»£ç èƒ½æ­£ç¡®å“åº” `interrupt()` è¯·æ±‚ï¼Œä½¿å¾—è‡ªèº«ç«‹åˆ»ç»“æŸè¿è¡Œ `run()` æ–¹æ³•ã€‚

å¦‚æœçº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œ`t.join()` ä¼šè®© `main` çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œæ­¤æ—¶ï¼Œå¦‚æœå¯¹ `main` çº¿ç¨‹è°ƒç”¨ `interrupt()`ï¼Œ`join()` æ–¹æ³•ä¼šç«‹åˆ»æŠ›å‡º `InterruptedException`ï¼Œå› æ­¤ï¼Œç›®æ ‡çº¿ç¨‹åªè¦æ•è·åˆ° `join()` æ–¹æ³•æŠ›å‡ºçš„ `InterruptedException`ï¼Œå°±è¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å¯¹å…¶è°ƒç”¨äº† `interrupt()` æ–¹æ³•ï¼Œé€šå¸¸æƒ…å†µä¸‹è¯¥çº¿ç¨‹åº”è¯¥ç«‹åˆ»ç»“æŸè¿è¡Œã€‚

æˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ï¼š

```java
public class Main {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new MyThread();
        t.start();
        Thread.sleep(1000);
        t.interrupt(); // ä¸­æ–­ t çº¿ç¨‹
        t.join(); // ç­‰å¾… t çº¿ç¨‹ç»“æŸ
        System.out.println("end");
    }
}

class MyThread extends Thread {
    public void run() {
        Thread hello = new HelloThread();
        hello.start(); // å¯åŠ¨ hello çº¿ç¨‹
        try {
            hello.join(); // ç­‰å¾… hello çº¿ç¨‹ç»“æŸ
        } catch (InterruptedException e) {
            System.out.println("interrupted!");
        }
        hello.interrupt();
    }
}

class HelloThread extends Thread {
    public void run() {
        int n = 0;
        while (!isInterrupted()) {
            n++;
            System.out.println(n + "hello!");
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                break;
            }
        }
    }
}
```

`main` çº¿ç¨‹é€šè¿‡è°ƒç”¨ `t.interrupt()` ä»è€Œé€šçŸ¥ `t` çº¿ç¨‹ä¸­æ–­ï¼Œè€Œæ­¤æ—¶ `t` çº¿ç¨‹æ­£ä½äº `hello.join()` çš„ç­‰å¾…ä¸­ï¼Œæ­¤æ–¹æ³•ä¼šç«‹åˆ»ç»“æŸç­‰å¾…å¹¶æŠ›å‡º `InterruptedException` ã€‚ç”±äºæˆ‘ä»¬åœ¨ `t` çº¿ç¨‹ä¸­æ•è·äº† `InterruptedException`ï¼Œå› æ­¤ï¼Œå°±å¯ä»¥å‡†å¤‡ç»“æŸè¯¥çº¿ç¨‹ã€‚åœ¨ `t` çº¿ç¨‹ç»“æŸå‰ï¼Œå¯¹ `hello` çº¿ç¨‹ä¹Ÿè¿›è¡Œäº† `interrupt()` è°ƒç”¨é€šçŸ¥å…¶ä¸­æ–­ã€‚å¦‚æœå»æ‰è¿™ä¸€è¡Œä»£ç ï¼Œå¯ä»¥å‘ç° `hello` çº¿ç¨‹ä»ç„¶ä¼šç»§ç»­è¿è¡Œï¼Œä¸” JVM ä¸ä¼šé€€å‡ºã€‚

å¦ä¸€ä¸ªå¸¸ç”¨çš„ä¸­æ–­çº¿ç¨‹çš„æ–¹æ³•æ˜¯è®¾ç½®æ ‡å¿—ä½ã€‚æˆ‘ä»¬é€šå¸¸ä¼šç”¨ä¸€ä¸ª `running` æ ‡å¿—ä½æ¥æ ‡è¯†çº¿ç¨‹æ˜¯å¦åº”è¯¥ç»§ç»­è¿è¡Œï¼Œåœ¨å¤–éƒ¨çº¿ç¨‹ä¸­ï¼Œé€šè¿‡æŠŠ `HelloThread.running` ç½®ä¸º `false`ï¼Œå°±å¯ä»¥è®©çº¿ç¨‹ç»“æŸï¼š

```java
public class Main {
    public static void main(String[] args)  throws InterruptedException {
        HelloThread t = new HelloThread();
        t.start();
        Thread.sleep(1);
        t.running = false; // æ ‡å¿—ä½ç½®ä¸º false
    }
}

class HelloThread extends Thread {
    public volatile boolean running = true;
    public void run() {
        int n = 0;
        while (running) {
            n ++;
            System.out.println(n + "hello!");
        }
        System.out.println("end!");
    }
}
```

æ³¨æ„åˆ° `HelloThread` çš„æ ‡å¿—ä½ `boolean running` æ˜¯ä¸€ä¸ªçº¿ç¨‹é—´å…±äº«çš„å˜é‡ã€‚çº¿ç¨‹é—´å…±äº«å˜é‡éœ€è¦ä½¿ç”¨ `volatile` å…³é”®å­—æ ‡è®°ï¼Œç¡®ä¿æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½è¯»å–åˆ°æ›´æ–°åçš„å˜é‡å€¼ã€‚

ä¸ºä»€ä¹ˆè¦å¯¹çº¿ç¨‹é—´å…±äº«çš„å˜é‡ç”¨å…³é”®å­— `volatile` å£°æ˜ï¼Ÿè¿™æ¶‰åŠåˆ° Java çš„å†…å­˜æ¨¡å‹ã€‚åœ¨ Java è™šæ‹Ÿæœºä¸­ï¼Œå˜é‡çš„å€¼ä¿å­˜åœ¨ä¸»å†…å­˜ä¸­ï¼Œä½†æ˜¯ï¼Œå½“çº¿ç¨‹è®¿é—®å˜é‡æ—¶ï¼Œå®ƒä¼šå…ˆè·å–ä¸€ä¸ªå‰¯æœ¬ï¼Œå¹¶ä¿å­˜åœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­ã€‚å¦‚æœçº¿ç¨‹ä¿®æ”¹äº†å˜é‡çš„å€¼ï¼Œè™šæ‹Ÿæœºä¼šåœ¨æŸä¸ªæ—¶åˆ»æŠŠä¿®æ”¹åçš„å€¼å›å†™åˆ°ä¸»å†…å­˜ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ä¸ç¡®å®šçš„ï¼

![20220627155007](assets/20220627155007.png)

è¿™ä¼šå¯¼è‡´å¦‚æœä¸€ä¸ªçº¿ç¨‹æ›´æ–°äº†æŸä¸ªå˜é‡ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»å–çš„å€¼å¯èƒ½è¿˜æ˜¯æ›´æ–°å‰çš„ã€‚ä¾‹å¦‚ï¼Œä¸»å†…å­˜çš„å˜é‡ `a = true`ï¼Œçº¿ç¨‹ 1 æ‰§è¡Œ `a = false` æ—¶ï¼Œå®ƒåœ¨æ­¤åˆ»ä»…ä»…æ˜¯æŠŠå˜é‡ `a` çš„å‰¯æœ¬å˜æˆäº† `false`ï¼Œä¸»å†…å­˜çš„å˜é‡ `a` è¿˜æ˜¯ `true`ï¼Œåœ¨ JVM æŠŠä¿®æ”¹åçš„ `a` å›å†™åˆ°ä¸»å†…å­˜ä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹è¯»å–åˆ°çš„ `a` çš„å€¼ä»ç„¶æ˜¯ `true`ï¼Œè¿™å°±é€ æˆäº†å¤šçº¿ç¨‹ä¹‹é—´å…±äº«çš„å˜é‡ä¸ä¸€è‡´ã€‚

å› æ­¤ï¼Œ`volatile` å…³é”®å­—çš„ç›®çš„æ˜¯å‘Šè¯‰è™šæ‹Ÿæœºï¼š

- æ¯æ¬¡è®¿é—®å˜é‡æ—¶ï¼Œæ€»æ˜¯è·å–ä¸»å†…å­˜çš„æœ€æ–°å€¼ï¼›
- æ¯æ¬¡ä¿®æ”¹å˜é‡åï¼Œç«‹åˆ»å›å†™åˆ°ä¸»å†…å­˜ã€‚

`volatile` å…³é”®å­—è§£å†³çš„æ˜¯å¯è§æ€§é—®é¢˜ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»çœ‹åˆ°ä¿®æ”¹åçš„å€¼ã€‚

å¦‚æœæˆ‘ä»¬å»æ‰ `volatile` å…³é”®å­—ï¼Œè¿è¡Œä¸Šè¿°ç¨‹åºï¼Œå‘ç°æ•ˆæœå’Œå¸¦ `volatile` å·®ä¸å¤šï¼Œè¿™æ˜¯å› ä¸ºåœ¨ x86 çš„æ¶æ„ä¸‹ï¼ŒJVM å›å†™ä¸»å†…å­˜çš„é€Ÿåº¦éå¸¸å¿«ï¼Œä½†æ˜¯ï¼Œæ¢æˆ ARM çš„æ¶æ„ï¼Œå°±ä¼šæœ‰æ˜¾è‘—çš„å»¶è¿Ÿã€‚

## ğŸ€ å°ç»“

- å¯¹ç›®æ ‡çº¿ç¨‹è°ƒç”¨ `interrupt()` æ–¹æ³•å¯ä»¥è¯·æ±‚ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ï¼Œç›®æ ‡çº¿ç¨‹é€šè¿‡æ£€æµ‹ `isInterrupted()` æ ‡å¿—è·å–è‡ªèº«æ˜¯å¦å·²ä¸­æ–­ã€‚å¦‚æœç›®æ ‡çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè¯¥çº¿ç¨‹ä¼šæ•è·åˆ° `InterruptedException` ï¼›
- ç›®æ ‡çº¿ç¨‹æ£€æµ‹åˆ° `isInterrupted()` ä¸º `true` æˆ–è€…æ•è·äº† `InterruptedException` éƒ½åº”è¯¥ç«‹åˆ»ç»“æŸè‡ªèº«çº¿ç¨‹ï¼›
- é€šè¿‡æ ‡å¿—ä½åˆ¤æ–­éœ€è¦æ­£ç¡®ä½¿ç”¨ `volatile` å…³é”®å­—ï¼›
- `volatile` å…³é”®å­—è§£å†³äº†å…±äº«å˜é‡åœ¨çº¿ç¨‹é—´çš„å¯è§æ€§é—®é¢˜ã€‚
