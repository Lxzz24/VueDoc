---
title: ä½¿ç”¨ Concurrent é›†åˆ
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::


æˆ‘ä»¬åœ¨å‰é¢å·²ç»é€šè¿‡ `ReentrantLock` å’Œ `Condition` å®ç°äº†ä¸€ä¸ª `BlockingQueue`ï¼š

```java
public class TaskQueue {
    private final Lock lock = new ReentrantLock();
    private final Condition condition = lock.newCondition();
    private Queue<String> queue = new LinkedList<>();

    public void addTask(String s) {
        lock.lock();
        try {
            queue.add(s);
            condition.signalAll();
        } finally {
            lock.unlock();
        }
    }

    public String getTask() {
        lock.lock();
        try {
            while (queue.isEmpty()) {
                condition.await();
            }
            return queue.remove();
        } finally {
            lock.unlock();
        }
    }
}
```

`BlockingQueue` çš„æ„æ€å°±æ˜¯è¯´ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¿™ä¸ª `TaskQueue` çš„ `getTask()` æ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•å†…éƒ¨å¯èƒ½ä¼šè®©çº¿ç¨‹å˜æˆç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°é˜Ÿåˆ—æ¡ä»¶æ»¡è¶³ä¸ä¸ºç©ºï¼Œçº¿ç¨‹è¢«å”¤é†’åï¼Œ`getTask()` æ–¹æ³•æ‰ä¼šè¿”å›ã€‚

å› ä¸º `BlockingQueue` éå¸¸æœ‰ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¿…è‡ªå·±ç¼–å†™ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Java æ ‡å‡†åº“çš„ `java.util.concurrent` åŒ…æä¾›çš„çº¿ç¨‹å®‰å…¨çš„é›†åˆï¼š`ArrayBlockingQueue`ã€‚

é™¤äº† `BlockingQueue` å¤–ï¼Œé’ˆå¯¹ `List`ã€`Map`ã€`Set`ã€`Deque` ç­‰ï¼Œ`java.util.concurrent` åŒ…ä¹Ÿæä¾›äº†å¯¹åº”çš„å¹¶å‘é›†åˆç±»ã€‚æˆ‘ä»¬å½’çº³ä¸€ä¸‹ï¼š

| interface | non-thread-safe         | thread-safe                              |
| :-------- | :---------------------- | :--------------------------------------- |
| List      | ArrayList               | CopyOnWriteArrayList                     |
| Map       | HashMap                 | ConcurrentHashMap                        |
| Set       | HashSet / TreeSet       | CopyOnWriteArraySet                      |
| Queue     | ArrayDeque / LinkedList | ArrayBlockingQueue / LinkedBlockingQueue |
| Deque     | ArrayDeque / LinkedList | LinkedBlockingDeque                      |

ä½¿ç”¨è¿™äº›å¹¶å‘é›†åˆä¸ä½¿ç”¨éçº¿ç¨‹å®‰å…¨çš„é›†åˆç±»å®Œå…¨ç›¸åŒã€‚æˆ‘ä»¬ä»¥ `ConcurrentHashMap` ä¸ºä¾‹ï¼š

```java
Map<String, String> map = new ConcurrentHashMap<>();
// åœ¨ä¸åŒçš„çº¿ç¨‹è¯»å†™:
map.put("A", "1");
map.put("B", "2");
map.get("A", "1");
```

å› ä¸ºæ‰€æœ‰çš„åŒæ­¥å’ŒåŠ é”çš„é€»è¾‘éƒ½åœ¨é›†åˆå†…éƒ¨å®ç°ï¼Œå¯¹å¤–éƒ¨è°ƒç”¨è€…æ¥è¯´ï¼Œåªéœ€è¦æ­£å¸¸æŒ‰æ¥å£å¼•ç”¨ï¼Œå…¶ä»–ä»£ç å’ŒåŸæ¥çš„éçº¿ç¨‹å®‰å…¨ä»£ç å®Œå…¨ä¸€æ ·ã€‚å³å½“æˆ‘ä»¬éœ€è¦å¤šçº¿ç¨‹è®¿é—®æ—¶ï¼ŒæŠŠï¼š

```java
Map<String, String> map = new HashMap<>();
```

æ”¹ä¸ºï¼š

```java
Map<String, String> map = new ConcurrentHashMap<>();
```

å°±å¯ä»¥äº†ã€‚

`java.util.Collections` å·¥å…·ç±»è¿˜æä¾›äº†ä¸€ä¸ªæ—§çš„çº¿ç¨‹å®‰å…¨é›†åˆè½¬æ¢å™¨ï¼Œå¯ä»¥è¿™ä¹ˆç”¨ï¼š

```java
Map unsafeMap = new HashMap();
Map threadSafeMap = Collections.synchronizedMap(unsafeMap);
```

ä½†æ˜¯å®ƒå®é™…ä¸Šæ˜¯ç”¨ä¸€ä¸ªåŒ…è£…ç±»åŒ…è£…äº†éçº¿ç¨‹å®‰å…¨çš„ `Map`ï¼Œç„¶åå¯¹æ‰€æœ‰è¯»å†™æ–¹æ³•éƒ½ç”¨ `synchronized` åŠ é”ï¼Œè¿™æ ·è·å¾—çš„çº¿ç¨‹å®‰å…¨é›†åˆçš„æ€§èƒ½æ¯” `java.util.concurrent` é›†åˆè¦ä½å¾ˆå¤šï¼Œæ‰€ä»¥ä¸æ¨èä½¿ç”¨ã€‚

## ğŸ€ å°ç»“

ä½¿ç”¨ `java.util.concurrent` åŒ…æä¾›çš„çº¿ç¨‹å®‰å…¨çš„å¹¶å‘é›†åˆå¯ä»¥å¤§å¤§ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼š

å¤šçº¿ç¨‹åŒæ—¶è¯»å†™å¹¶å‘é›†åˆæ˜¯å®‰å…¨çš„ï¼›

å°½é‡ä½¿ç”¨ Java æ ‡å‡†åº“æä¾›çš„å¹¶å‘é›†åˆï¼Œé¿å…è‡ªå·±ç¼–å†™åŒæ­¥ä»£ç ã€‚


