---
title: åŒæ­¥æ–¹æ³•
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

æˆ‘ä»¬çŸ¥é“ Java ç¨‹åºä¾é  `synchronized` å¯¹çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œä½¿ç”¨ `synchronized` çš„æ—¶å€™ï¼Œé”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡éå¸¸é‡è¦ã€‚

è®©çº¿ç¨‹è‡ªå·±é€‰æ‹©é”å¯¹è±¡å¾€å¾€ä¼šä½¿å¾—ä»£ç é€»è¾‘æ··ä¹±ï¼Œä¹Ÿä¸åˆ©äºå°è£…ã€‚æ›´å¥½çš„æ–¹æ³•æ˜¯æŠŠ `synchronized` é€»è¾‘å°è£…èµ·æ¥ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè®¡æ•°å™¨å¦‚ä¸‹ï¼š

```java
public class Counter {
    private int count = 0;

    public void add(int n) {
        synchronized(this) {
            count += n;
        }
    }

    public void dec(int n) {
        synchronized(this) {
            count -= n;
        }
    }

    public int get() {
        return count;
    }
}
```

è¿™æ ·ä¸€æ¥ï¼Œçº¿ç¨‹è°ƒç”¨ `add()`ã€`dec()` æ–¹æ³•æ—¶ï¼Œå®ƒä¸å¿…å…³å¿ƒåŒæ­¥é€»è¾‘ï¼Œå› ä¸º `synchronized` ä»£ç å—åœ¨ `add()`ã€`dec()` æ–¹æ³•å†…éƒ¨ã€‚å¹¶ä¸”ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œ`synchronized` é”ä½çš„å¯¹è±¡æ˜¯ `this`ï¼Œå³å½“å‰å®ä¾‹ï¼Œè¿™åˆä½¿å¾—åˆ›å»ºå¤šä¸ª `Counter` å®ä¾‹çš„æ—¶å€™ï¼Œå®ƒä»¬ä¹‹é—´äº’ä¸å½±å“ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œï¼š

```java
var c1 = Counter();
var c2 = Counter();

// å¯¹ c1 è¿›è¡Œæ“ä½œçš„çº¿ç¨‹:
new Thread(() -> {
    c1.add();
}).start();
new Thread(() -> {
    c1.dec();
}).start();

// å¯¹ c2 è¿›è¡Œæ“ä½œçš„çº¿ç¨‹:
new Thread(() -> {
    c2.add();
}).start();
new Thread(() -> {
    c2.dec();
}).start();
```

ç°åœ¨ï¼Œå¯¹äº `Counter` ç±»ï¼Œå¤šçº¿ç¨‹å¯ä»¥æ­£ç¡®è°ƒç”¨ã€‚

_å¦‚æœä¸€ä¸ªç±»è¢«è®¾è®¡ä¸ºå…è®¸å¤šçº¿ç¨‹æ­£ç¡®è®¿é—®_ï¼Œæˆ‘ä»¬å°±è¯´è¿™ä¸ªç±»å°±æ˜¯ â€œ**çº¿ç¨‹å®‰å…¨**â€ çš„ï¼ˆthread-safeï¼‰ï¼Œä¸Šé¢çš„ `Counter` ç±»å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚Java æ ‡å‡†åº“çš„ `java.lang.StringBuffer` ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

è¿˜æœ‰ä¸€äº›ä¸å˜ç±»ï¼Œä¾‹å¦‚ `String`ï¼Œ`Integer`ï¼Œ`LocalDate`ï¼Œå®ƒä»¬çš„æ‰€æœ‰æˆå‘˜å˜é‡éƒ½æ˜¯ `final`ï¼Œå¤šçº¿ç¨‹åŒæ—¶è®¿é—®æ—¶åªèƒ½è¯»ä¸èƒ½å†™ï¼Œè¿™äº›ä¸å˜ç±»ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

æœ€åï¼Œç±»ä¼¼ `Math` è¿™äº›åªæä¾›é™æ€æ–¹æ³•ï¼Œæ²¡æœ‰æˆå‘˜å˜é‡çš„ç±»ï¼Œä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

é™¤äº†ä¸Šè¿°å‡ ç§å°‘æ•°æƒ…å†µï¼Œå¤§éƒ¨åˆ†ç±»ï¼Œä¾‹å¦‚ `ArrayList`ï¼Œéƒ½æ˜¯éçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¸­ä¿®æ”¹å®ƒä»¬ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½åªè¯»å–ï¼Œä¸å†™å…¥ï¼Œé‚£ä¹ˆ `ArrayList` æ˜¯å¯ä»¥å®‰å…¨åœ°åœ¨çº¿ç¨‹é—´å…±äº«çš„ã€‚

> æ²¡æœ‰ç‰¹æ®Šè¯´æ˜æ—¶ï¼Œä¸€ä¸ªç±»é»˜è®¤æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚

æˆ‘ä»¬å†è§‚å¯Ÿ `Counter` çš„ä»£ç ï¼š

```java
public class Counter {
    public void add(int n) {
        synchronized(this) {
            count += n;
        }
    }
    ...
}
```

å½“æˆ‘ä»¬é”ä½çš„æ˜¯ `this` å®ä¾‹æ—¶ï¼Œå®é™…ä¸Šå¯ä»¥ç”¨ `synchronized` ä¿®é¥°è¿™ä¸ªæ–¹æ³•ã€‚ä¸‹é¢ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„ï¼š

```java
public void add(int n) {
    synchronized(this) { // é”ä½ this
        count += n;
    } // è§£é”
}
public synchronized void add(int n) { // é”ä½ this
    count += n;
} // è§£é”
```

å› æ­¤ï¼Œ_ç”¨ `synchronized` ä¿®é¥°çš„æ–¹æ³•å°±æ˜¯åŒæ­¥æ–¹æ³•_ï¼Œå®ƒè¡¨ç¤ºæ•´ä¸ªæ–¹æ³•éƒ½å¿…é¡»ç”¨ `this` å®ä¾‹åŠ é”ã€‚

æˆ‘ä»¬å†æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœå¯¹ä¸€ä¸ªé™æ€æ–¹æ³•æ·»åŠ  `synchronized` ä¿®é¥°ç¬¦ï¼Œå®ƒé”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡ï¼Ÿ

```java
public synchronized static void test(int n) {
    ...
}
```

å¯¹äº `static` æ–¹æ³•ï¼Œæ˜¯æ²¡æœ‰ `this` å®ä¾‹çš„ï¼Œå› ä¸º `static` æ–¹æ³•æ˜¯é’ˆå¯¹ç±»è€Œä¸æ˜¯å®ä¾‹ã€‚ä½†æ˜¯æˆ‘ä»¬æ³¨æ„åˆ°ä»»ä½•ä¸€ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªç”± JVM è‡ªåŠ¨åˆ›å»ºçš„ `Class` å®ä¾‹ï¼Œå› æ­¤ï¼Œå¯¹ `static` æ–¹æ³•æ·»åŠ  `synchronized`ï¼Œé”ä½çš„æ˜¯è¯¥ç±»çš„ `Class` å®ä¾‹ã€‚ä¸Šè¿° `synchronized static` æ–¹æ³•å®é™…ä¸Šç›¸å½“äºï¼š

```java
public class Counter {
    public static void test(int n) {
        synchronized(Counter.class) {
            ...
        }
    }
}
```

æˆ‘ä»¬å†è€ƒå¯Ÿ `Counter` çš„ `get()` æ–¹æ³•ï¼š

```java
public class Counter {
    private int count;

    public int get() {
        return count;
    }
    ...
}
```

å®ƒæ²¡æœ‰åŒæ­¥ï¼Œå› ä¸ºè¯»ä¸€ä¸ª `int` å˜é‡ä¸éœ€è¦åŒæ­¥ã€‚

ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬æŠŠä»£ç ç¨å¾®æ”¹ä¸€ä¸‹ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«ä¸¤ä¸ª `int` çš„å¯¹è±¡ï¼š

```java
public class Counter {
    private int first;
    private int last;

    public Pair get() {
        Pair p = new Pair();
        p.first = first;
        p.last = last;
        return p;
    }
    ...
}
```

å°±å¿…é¡»è¦åŒæ­¥äº†ã€‚

## ğŸ€ å°ç»“

- ç”¨ `synchronized` ä¿®é¥°æ–¹æ³•å¯ä»¥æŠŠæ•´ä¸ªæ–¹æ³•å˜ä¸ºåŒæ­¥ä»£ç å—ï¼Œ`synchronized` æ–¹æ³•åŠ é”å¯¹è±¡æ˜¯ `this`ï¼›

- é€šè¿‡åˆç†çš„è®¾è®¡å’Œæ•°æ®å°è£…å¯ä»¥è®©ä¸€ä¸ªç±»å˜ä¸º â€œçº¿ç¨‹å®‰å…¨â€ï¼›

- ä¸€ä¸ªç±»æ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œé»˜è®¤ä¸æ˜¯ thread-safeï¼›

- å¤šçº¿ç¨‹èƒ½å¦å®‰å…¨è®¿é—®æŸä¸ªéçº¿ç¨‹å®‰å…¨çš„å®ä¾‹ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚
