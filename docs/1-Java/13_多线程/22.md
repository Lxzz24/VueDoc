---
title: ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::


è™šæ‹Ÿçº¿ç¨‹ï¼ˆVirtual Threadï¼‰æ˜¯ Java 19 å¼•å…¥çš„ä¸€ç§è½»é‡çº§çº¿ç¨‹ï¼Œå®ƒåœ¨å¾ˆå¤šå…¶ä»–è¯­è¨€ä¸­è¢«ç§°ä¸ºåç¨‹ã€çº¤ç¨‹ã€ç»¿è‰²çº¿ç¨‹ã€ç”¨æˆ·æ€çº¿ç¨‹ç­‰ã€‚

åœ¨ç†è§£è™šæ‹Ÿçº¿ç¨‹å‰ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹çº¿ç¨‹çš„ç‰¹ç‚¹ï¼š

- çº¿ç¨‹æ˜¯ç”±æ“ä½œç³»ç»Ÿåˆ›å»ºå¹¶è°ƒåº¦çš„èµ„æºï¼›
- çº¿ç¨‹åˆ‡æ¢ä¼šè€—è´¹å¤§é‡ CPU æ—¶é—´ï¼›
- ä¸€ä¸ªç³»ç»Ÿèƒ½åŒæ—¶è°ƒåº¦çš„çº¿ç¨‹æ•°é‡æ˜¯æœ‰é™çš„ï¼Œé€šå¸¸åœ¨å‡ ç™¾è‡³å‡ åƒçº§åˆ«ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬è¯´çº¿ç¨‹æ˜¯ä¸€ç§é‡é‡çº§èµ„æºã€‚åœ¨æœåŠ¡å™¨ç«¯ï¼Œå¯¹ç”¨æˆ·è¯·æ±‚ï¼Œé€šå¸¸éƒ½å®ç°ä¸ºä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªè¯·æ±‚ã€‚ç”±äºç”¨æˆ·çš„è¯·æ±‚æ•°å¾€å¾€è¿œè¶…æ“ä½œç³»ç»Ÿèƒ½åŒæ—¶è°ƒåº¦çš„çº¿ç¨‹æ•°é‡ï¼Œæ‰€ä»¥é€šå¸¸ä½¿ç”¨çº¿ç¨‹æ± æ¥å°½é‡å‡å°‘é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æˆæœ¬ã€‚

---

_å¯¹äºéœ€è¦å¤„ç†å¤§é‡ IO è¯·æ±‚çš„ä»»åŠ¡æ¥è¯´ï¼Œä½¿ç”¨çº¿ç¨‹æ˜¯ä½æ•ˆçš„_ï¼Œå› ä¸ºä¸€æ—¦è¯»å†™ IOï¼Œçº¿ç¨‹å°±å¿…é¡»è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ° IO æ•°æ®è¿”å›ã€‚å¸¸è§çš„ IO æ“ä½œåŒ…æ‹¬ï¼š

- è¯»å†™æ–‡ä»¶ï¼›
- è¯»å†™ç½‘ç»œï¼Œä¾‹å¦‚ HTTP è¯·æ±‚ï¼›
- è¯»å†™æ•°æ®åº“ï¼Œæœ¬è´¨ä¸Šæ˜¯é€šè¿‡ JDBC å®ç°ç½‘ç»œè°ƒç”¨ã€‚

æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªå¤„ç† HTTP è¯·æ±‚çš„çº¿ç¨‹ï¼Œå®ƒåœ¨è¯»å†™ç½‘ç»œã€æ–‡ä»¶çš„æ—¶å€™å°±ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼š

![](assets/image-20231129161059148.png =300x)

çœŸæ­£ç”± CPU æ‰§è¡Œçš„ä»£ç æ¶ˆè€—çš„æ—¶é—´éå¸¸å°‘ï¼Œçº¿ç¨‹çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾… IOã€‚æˆ‘ä»¬æŠŠè¿™ç±»ä»»åŠ¡ç§°ä¸º **IO å¯†é›†å‹ä»»åŠ¡**ã€‚

ä¸ºäº†èƒ½é«˜æ•ˆæ‰§è¡Œ IO å¯†é›†å‹ä»»åŠ¡ï¼ŒJava ä» 19 å¼€å§‹å¼•å…¥äº†è™šæ‹Ÿçº¿ç¨‹ã€‚è™šæ‹Ÿçº¿ç¨‹çš„æ¥å£å’Œæ™®é€šçº¿ç¨‹æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ‰§è¡Œæ–¹å¼ä¸ä¸€æ ·ã€‚è™šæ‹Ÿçº¿ç¨‹ä¸æ˜¯ç”±æ“ä½œç³»ç»Ÿè°ƒåº¦ï¼Œè€Œæ˜¯ç”±æ™®é€šçº¿ç¨‹è°ƒåº¦ï¼Œå³æˆç™¾ä¸Šåƒä¸ªè™šæ‹Ÿçº¿ç¨‹å¯ä»¥ç”±ä¸€ä¸ªæ™®é€šçº¿ç¨‹è°ƒåº¦ã€‚ä»»ä½•æ—¶åˆ»ï¼Œåªèƒ½æ‰§è¡Œä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œä½†æ˜¯ï¼Œä¸€æ—¦è¯¥è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œä¸€ä¸ª IO æ“ä½œè¿›å…¥ç­‰å¾…æ—¶ï¼Œå®ƒä¼šè¢«ç«‹åˆ» â€œæŒ‚èµ·â€ï¼Œç„¶åæ‰§è¡Œä¸‹ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ã€‚ä»€ä¹ˆæ—¶å€™ IO æ•°æ®è¿”å›äº†ï¼Œè¿™ä¸ªæŒ‚èµ·çš„è™šæ‹Ÿçº¿ç¨‹æ‰ä¼šè¢«å†æ¬¡è°ƒåº¦ã€‚å› æ­¤ï¼Œè‹¥å¹²ä¸ªè™šæ‹Ÿçº¿ç¨‹å¯ä»¥åœ¨ä¸€ä¸ªæ™®é€šçº¿ç¨‹ä¸­äº¤æ›¿è¿è¡Œï¼š

![](assets/image-20231129161137834.png =300x)

å¦‚æœæˆ‘ä»¬å•ç‹¬çœ‹ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹çš„ä»£ç ï¼Œåœ¨ä¸€ä¸ªæ–¹æ³•ä¸­ï¼š

```java
void register() {
    config = readConfigFile("./config.json"); // #1
    if (config.useFullName) {
        name = req.firstName + " " + req.lastName;
    }
    insertInto(db, name); // #2
    if (config.cache) {
        redis.set(key, name); // #3
    }
}
```

æ¶‰åŠåˆ° IO è¯»å†™çš„ #1ã€#2ã€#3 å¤„ï¼Œæ‰§è¡Œåˆ°è¿™äº›åœ°æ–¹çš„æ—¶å€™ï¼ˆè¿›å…¥ç›¸å…³çš„ JNI æ–¹æ³•å†…éƒ¨æ—¶ï¼‰ä¼šè‡ªåŠ¨æŒ‚èµ·ï¼Œå¹¶åˆ‡æ¢åˆ°å…¶ä»–è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œã€‚ç­‰åˆ°æ•°æ®è¿”å›åï¼Œå½“å‰è™šæ‹Ÿçº¿ç¨‹ä¼šå†æ¬¡è°ƒåº¦å¹¶æ‰§è¡Œï¼Œå› æ­¤ï¼Œä»£ç çœ‹èµ·æ¥æ˜¯åŒæ­¥æ‰§è¡Œï¼Œä½†å®é™…ä¸Šæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚

## ğŸ€ ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹

è™šæ‹Ÿçº¿ç¨‹çš„æ¥å£å’Œæ™®é€šçº¿ç¨‹ä¸€æ ·ï¼Œå”¯ä¸€åŒºåˆ«åœ¨äºåˆ›å»ºè™šæ‹Ÿçº¿ç¨‹åªèƒ½é€šè¿‡ç‰¹å®šæ–¹æ³•ã€‚

æ–¹æ³•ä¸€ï¼šç›´æ¥åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹å¹¶è¿è¡Œï¼š

```java
// ä¼ å…¥ Runnable å®ä¾‹å¹¶ç«‹åˆ»è¿è¡Œ:
Thread vt = Thread.startVirtualThread(() -> {
    System.out.println("Start virtual thread...");
    Thread.sleep(10);
    System.out.println("End virtual thread.");
});
```

æ–¹æ³•äºŒï¼šåˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ä½†ä¸è‡ªåŠ¨è¿è¡Œï¼Œè€Œæ˜¯æ‰‹åŠ¨è°ƒç”¨ `start()` å¼€å§‹è¿è¡Œï¼š

```java
// åˆ›å»º VirtualThread:
Thread.ofVirtual().unstarted(() -> {
    System.out.println("Start virtual thread...");
    Thread.sleep(1000);
    System.out.println("End virtual thread.");
});
// è¿è¡Œ:
vt.start();
```

æ–¹æ³•ä¸‰ï¼šé€šè¿‡è™šæ‹Ÿçº¿ç¨‹çš„ ThreadFactory åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨ `start()` å¼€å§‹è¿è¡Œï¼š

```java
// åˆ›å»º ThreadFactory:
ThreadFactory tf = Thread.ofVirtual().factory();
// åˆ›å»º VirtualThread:
Thread vt = tf.newThread(() -> {
    System.out.println("Start virtual thread...");
    Thread.sleep(1000);
    System.out.println("End virtual thread.");
});
// è¿è¡Œ:
vt.start();
```

ç›´æ¥è°ƒç”¨ `start()` å®é™…ä¸Šæ˜¯ç”± `ForkJoinPool` çš„çº¿ç¨‹æ¥è°ƒåº¦çš„ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±åˆ›å»ºè°ƒåº¦çº¿ç¨‹ï¼Œç„¶åè¿è¡Œè™šæ‹Ÿçº¿ç¨‹ï¼š

```java
// åˆ›å»ºè°ƒåº¦å™¨:
ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();
// åˆ›å»ºå¤§é‡è™šæ‹Ÿçº¿ç¨‹å¹¶è°ƒåº¦:
ThreadFactory tf = Thread.ofVirtual().factory();
for (int i=0; i<100000; i++) {
    Thread vt = tf.newThread(() -> { ... });
    executor.submit(vt);
    // ä¹Ÿå¯ä»¥ç›´æ¥ä¼ å…¥ Runnable æˆ– Callable:
    executor.submit(() -> {
        System.out.println("Start virtual thread...");
        Thread.sleep(1000);
        System.out.println("End virtual thread.");
        return true;
    });
}
```

ç”±äºè™šæ‹Ÿçº¿ç¨‹å±äºéå¸¸è½»é‡çº§çš„èµ„æºï¼Œå› æ­¤ï¼Œç”¨æ—¶åˆ›å»ºï¼Œç”¨å®Œå°±æ‰”ï¼Œä¸è¦æ± åŒ–è™šæ‹Ÿçº¿ç¨‹ã€‚

æœ€åæ³¨æ„ï¼Œè™šæ‹Ÿçº¿ç¨‹åœ¨ Java 21 æ­£å¼å‘å¸ƒï¼Œåœ¨ Java 19/20 æ˜¯é¢„è§ˆåŠŸèƒ½ï¼Œé»˜è®¤å…³é—­ï¼Œéœ€è¦æ·»åŠ å‚æ•° `--enable-preview` å¯ç”¨ï¼š

```sh
java --source 19 --enable-preview Main.java
```

## ğŸ€ ä½¿ç”¨é™åˆ¶

æ³¨æ„åˆ°åªæœ‰ä»¥è™šæ‹Ÿçº¿ç¨‹æ–¹å¼è¿è¡Œçš„ä»£ç ï¼Œæ‰ä¼šåœ¨æ‰§è¡Œ IO æ“ä½œæ—¶è‡ªåŠ¨è¢«æŒ‚èµ·å¹¶åˆ‡æ¢åˆ°å…¶ä»–è™šæ‹Ÿçº¿ç¨‹ã€‚æ™®é€šçº¿ç¨‹çš„ IO æ“ä½œä»ç„¶ä¼šç­‰å¾…ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ `main()` æ–¹æ³•ä¸­è¯»å†™æ–‡ä»¶ï¼Œæ˜¯ä¸ä¼šæœ‰è°ƒåº¦å’Œè‡ªåŠ¨æŒ‚èµ·çš„ã€‚

å¯ä»¥è‡ªåŠ¨å¼•å‘è°ƒåº¦åˆ‡æ¢çš„æ“ä½œåŒ…æ‹¬ï¼š

- æ–‡ä»¶ IOï¼›
- ç½‘ç»œ IOï¼›
- ä½¿ç”¨ Concurrent åº“å¼•å‘ç­‰å¾…ï¼›
- Thread.sleep() æ“ä½œã€‚

è¿™æ˜¯å› ä¸º JDK ä¸ºäº†å®ç°è™šæ‹Ÿçº¿ç¨‹ï¼Œå·²ç»å¯¹åº•å±‚ç›¸å…³æ“ä½œè¿›è¡Œäº†ä¿®æ”¹ï¼Œè¿™æ ·åº”ç”¨å±‚çš„ Java ä»£ç æ— éœ€ä¿®æ”¹å³å¯ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹ã€‚æ— æ³•è‡ªåŠ¨åˆ‡æ¢çš„è¯­è¨€éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è°ƒç”¨ `await` æ¥å®ç°å¼‚æ­¥æ“ä½œï¼š

```java
async function doWork() {
    await readFile();
    await sendNetworkData();
}
```

åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­ï¼Œå¦‚æœç»•è¿‡ JDK çš„ IO æ¥å£ï¼Œç›´æ¥é€šè¿‡ JNI è¯»å†™æ–‡ä»¶æˆ–ç½‘ç»œæ˜¯æ— æ³•å®ç°è°ƒåº¦çš„ã€‚æ­¤å¤–ï¼Œåœ¨ `synchronized` å—å†…éƒ¨ä¹Ÿæ— æ³•è°ƒåº¦ã€‚

## ğŸ€ ç»ƒä¹ 

ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹è°ƒåº¦ 10 ä¸‡ä¸ªä»»åŠ¡å¹¶è§‚å¯Ÿè€—æ—¶ï¼š

```java
public class Main {
    public static void main(String[] args) {
        ExecutorService es = Executors.newVirtualThreadPerTaskExecutor();
        for (int i=0; i<100000; i++) {
            es.submit(() -> {
                Thread.sleep(1000);
                return 0;
            });
        }
        es.close();
    }
}
```

å†å°† `ExecutorService` æ”¹ä¸ºçº¿ç¨‹æ± æ¨¡å¼å¹¶å¯¹æ¯”ç»“æœã€‚


```java
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class Main {

    public static void main(String[] args) throws InterruptedException {
        ExecutorService es = Executors.newVirtualThreadPerTaskExecutor();
        long start = System.currentTimeMillis();
        for (int i = 0; i < 100000; i++) {
            es.submit(() -> {
                Thread.sleep(1000);
                return 0;
            });
        }
        es.close();
        long end = System.currentTimeMillis();
        System.out.printf("All virtual threads end at %s ms.\n", end - start);
    }
}
```


## ğŸ€ å°ç»“

- Java 19 å¼•å…¥çš„è™šæ‹Ÿçº¿ç¨‹æ˜¯ä¸ºäº†è§£å†³ IO å¯†é›†å‹ä»»åŠ¡çš„ååé‡ï¼Œå®ƒå¯ä»¥é«˜æ•ˆé€šè¿‡å°‘æ•°çº¿ç¨‹å»è°ƒåº¦å¤§é‡è™šæ‹Ÿçº¿ç¨‹ï¼›

- è™šæ‹Ÿçº¿ç¨‹åœ¨æ‰§è¡Œåˆ° IO æ“ä½œæˆ– Blocking æ“ä½œæ—¶ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œï¼Œä»è€Œé¿å…å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œèƒ½æœ€å¤§åŒ–çº¿ç¨‹çš„æ‰§è¡Œæ•ˆç‡ï¼›

- è™šæ‹Ÿçº¿ç¨‹ä½¿ç”¨æ™®é€šçº¿ç¨‹ç›¸åŒçš„æ¥å£ï¼Œæœ€å¤§çš„å¥½å¤„æ˜¯æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç ï¼Œå°±å¯ä»¥å°†ç°æœ‰çš„ IO æ“ä½œå¼‚æ­¥åŒ–è·å¾—æ›´å¤§çš„ååèƒ½åŠ›ã€‚

- è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¸åº”ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹ï¼Œåªèƒ½é€šè¿‡å¢åŠ  CPU æ ¸å¿ƒè§£å†³ï¼Œæˆ–è€…åˆ©ç”¨åˆ†å¸ƒå¼è®¡ç®—èµ„æºã€‚

