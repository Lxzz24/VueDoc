---
title: ä½¿ç”¨ Atomic
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::


Java çš„ `java.util.concurrent` åŒ…é™¤äº†æä¾›åº•å±‚é”ã€å¹¶å‘é›†åˆå¤–ï¼Œè¿˜æä¾›äº†ä¸€ç»„åŸå­æ“ä½œçš„å°è£…ç±»ï¼Œå®ƒä»¬ä½äº `java.util.concurrent.atomic` åŒ…ã€‚

æˆ‘ä»¬ä»¥ `AtomicInteger` ä¸ºä¾‹ï¼Œå®ƒæä¾›çš„ä¸»è¦æ“ä½œæœ‰ï¼š

- å¢åŠ å€¼å¹¶è¿”å›æ–°å€¼ï¼š`int addAndGet(int delta)`
- åŠ  1 åè¿”å›æ–°å€¼ï¼š`int incrementAndGet()`
- è·å–å½“å‰å€¼ï¼š`int get()`
- ç”¨ CAS æ–¹å¼è®¾ç½®ï¼š`int compareAndSet(int expect, int update)`

Atomic ç±»æ˜¯é€šè¿‡æ— é”ï¼ˆlock-freeï¼‰çš„æ–¹å¼å®ç°çš„çº¿ç¨‹å®‰å…¨ï¼ˆthread-safeï¼‰è®¿é—®ã€‚å®ƒçš„ä¸»è¦åŸç†æ˜¯åˆ©ç”¨äº† CASï¼šCompare and Setã€‚

å¦‚æœæˆ‘ä»¬è‡ªå·±é€šè¿‡ CAS ç¼–å†™ `incrementAndGet()`ï¼Œå®ƒå¤§æ¦‚é•¿è¿™æ ·ï¼š

```java
public int incrementAndGet(AtomicInteger var) {
    int prev, next;
    do {
        prev = var.get();
        next = prev + 1;
    } while (! var.compareAndSet(prev, next));
    return next;
}
```

CAS æ˜¯æŒ‡ï¼Œåœ¨è¿™ä¸ªæ“ä½œä¸­ï¼Œå¦‚æœ `AtomicInteger` çš„å½“å‰å€¼æ˜¯ `prev`ï¼Œé‚£ä¹ˆå°±æ›´æ–°ä¸º `next`ï¼Œè¿”å› `true`ã€‚å¦‚æœ `AtomicInteger` çš„å½“å‰å€¼ä¸æ˜¯ `prev`ï¼Œå°±ä»€ä¹ˆä¹Ÿä¸å¹²ï¼Œè¿”å› `false`ã€‚é€šè¿‡ CAS æ“ä½œå¹¶é…åˆ `do ... while` å¾ªç¯ï¼Œå³ä½¿å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº† `AtomicInteger` çš„å€¼ï¼Œæœ€ç»ˆçš„ç»“æœä¹Ÿæ˜¯æ­£ç¡®çš„ã€‚

æˆ‘ä»¬åˆ©ç”¨ `AtomicLong` å¯ä»¥ç¼–å†™ä¸€ä¸ªå¤šçº¿ç¨‹å®‰å…¨çš„å…¨å±€å”¯ä¸€ ID ç”Ÿæˆå™¨ï¼š

```java
class IdGenerator {
    AtomicLong var = new AtomicLong(0);

    public long getNextId() {
        return var.incrementAndGet();
    }
}
```

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ç›´æ¥ç”¨ `do ... while` å¾ªç¯è°ƒç”¨ `compareAndSet` å®ç°å¤æ‚çš„å¹¶å‘æ“ä½œï¼Œè€Œæ˜¯ç”¨ `incrementAndGet()` è¿™æ ·çš„å°è£…å¥½çš„æ–¹æ³•ï¼Œå› æ­¤ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ã€‚

åœ¨é«˜åº¦ç«äº‰çš„æƒ…å†µä¸‹ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ Java 8 æä¾›çš„ `LongAdder` å’Œ `LongAccumulator`ã€‚

## ğŸ€ å°ç»“

ä½¿ç”¨ `java.util.concurrent.atomic` æä¾›çš„åŸå­æ“ä½œå¯ä»¥ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼š

- åŸå­æ“ä½œå®ç°äº†æ— é”çš„çº¿ç¨‹å®‰å…¨ï¼›
- é€‚ç”¨äºè®¡æ•°å™¨ï¼Œç´¯åŠ å™¨ç­‰ã€‚