---
title: ä½¿ç”¨ ForkJoin
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

Java 7 å¼€å§‹å¼•å…¥äº†ä¸€ç§æ–°çš„ Fork/Join çº¿ç¨‹æ± ï¼Œå®ƒå¯ä»¥æ‰§è¡Œä¸€ç§ç‰¹æ®Šçš„ä»»åŠ¡ï¼š_æŠŠä¸€ä¸ªå¤§ä»»åŠ¡æ‹†æˆå¤šä¸ªå°ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œã€‚_

æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼šå¦‚æœè¦è®¡ç®—ä¸€ä¸ªè¶…å¤§æ•°ç»„çš„å’Œï¼Œæœ€ç®€å•çš„åšæ³•æ˜¯ç”¨ä¸€ä¸ªå¾ªç¯åœ¨ä¸€ä¸ªçº¿ç¨‹å†…å®Œæˆï¼š

![](assets/image-20231129160321253.png =600x)

è¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥æŠŠæ•°ç»„æ‹†æˆä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«è®¡ç®—ï¼Œæœ€ååŠ èµ·æ¥å°±æ˜¯æœ€ç»ˆç»“æœï¼Œè¿™æ ·å¯ä»¥ç”¨ä¸¤ä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼š

![](assets/image-20231129160340002.png =350x)

å¦‚æœæ‹†æˆä¸¤éƒ¨åˆ†è¿˜æ˜¯å¾ˆå¤§ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç»§ç»­æ‹†ï¼Œç”¨ 4 ä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼š

![](assets/image-20231129160404284.png =200x)

è¿™å°±æ˜¯ Fork/Join ä»»åŠ¡çš„åŸç†ï¼š_åˆ¤æ–­ä¸€ä¸ªä»»åŠ¡æ˜¯å¦è¶³å¤Ÿå°ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥è®¡ç®—ï¼Œå¦åˆ™ï¼Œå°±åˆ†æ‹†æˆå‡ ä¸ªå°ä»»åŠ¡åˆ†åˆ«è®¡ç®—ã€‚_ è¿™ä¸ªè¿‡ç¨‹å¯ä»¥åå¤ â€œè£‚å˜â€ æˆä¸€ç³»åˆ—å°ä»»åŠ¡ã€‚

æˆ‘ä»¬æ¥çœ‹å¦‚ä½•ä½¿ç”¨ Fork/Join å¯¹å¤§æ•°æ®è¿›è¡Œå¹¶è¡Œæ±‚å’Œï¼š

```java
import java.util.Random;
import java.util.concurrent.*;

public class Main {
    public static void main(String[] args) throws Exception {
        // åˆ›å»º 2000 ä¸ªéšæœºæ•°ç»„æˆçš„æ•°ç»„:
        long[] array = new long[2000];
        long expectedSum = 0;
        for (int i = 0; i < array.length; i++) {
            array[i] = random();
            expectedSum += array[i];
        }
        System.out.println("Expected sum:" + expectedSum);
        // fork/join:
        ForkJoinTask<Long> task = new SumTask(array, 0, array.length);
        long startTime = System.currentTimeMillis();
        Long result = ForkJoinPool.commonPool().invoke(task);
        long endTime = System.currentTimeMillis();
        System.out.println("Fork/join sum:" + result + "in" + (endTime - startTime) + "ms.");
    }

    static Random random = new Random(0);

    static long random() {
        return random.nextInt(10000);
    }
}

class SumTask extends RecursiveTask<Long> {
    static final int THRESHOLD = 500;
    long[] array;
    int start;
    int end;

    SumTask(long[] array, int start, int end) {
        this.array = array;
        this.start = start;
        this.end = end;
    }

    @Override
    protected Long compute() {
        if (end - start <= THRESHOLD) {
            // å¦‚æœä»»åŠ¡è¶³å¤Ÿå°, ç›´æ¥è®¡ç®—:
            long sum = 0;
            for (int i = start; i < end; i++) {
                sum += this.array[i];
                // æ•…æ„æ”¾æ…¢è®¡ç®—é€Ÿåº¦:
                try {
                    Thread.sleep(1);
                } catch (InterruptedException e) {
                }
            }
            return sum;
        }
        // ä»»åŠ¡å¤ªå¤§, ä¸€åˆ†ä¸ºäºŒ:
        int middle = (end + start) / 2;
        System.out.println(String.format("split %d~%d ==> %d~%d, %d~%d", start, end, start, middle, middle, end));
        SumTask subtask1 = new SumTask(this.array, start, middle);
        SumTask subtask2 = new SumTask(this.array, middle, end);
        invokeAll(subtask1, subtask2);
        Long subresult1 = subtask1.join();
        Long subresult2 = subtask2.join();
        Long result = subresult1 + subresult2;
        System.out.println("result =" + subresult1 + "+" + subresult2 + "==>" + result);
        return result;
    }
}

```

è§‚å¯Ÿä¸Šè¿°ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä¸€ä¸ªå¤§çš„è®¡ç®—ä»»åŠ¡ 0~2000 é¦–å…ˆåˆ†è£‚ä¸ºä¸¤ä¸ªå°ä»»åŠ¡ 0~1000 å’Œ 1000~2000ï¼Œè¿™ä¸¤ä¸ªå°ä»»åŠ¡ä»ç„¶å¤ªå¤§ï¼Œç»§ç»­åˆ†è£‚ä¸ºæ›´å°çš„ 0~500ï¼Œ500~1000ï¼Œ1000~1500ï¼Œ1500~2000ï¼Œæœ€åï¼Œè®¡ç®—ç»“æœè¢«ä¾æ¬¡åˆå¹¶ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœã€‚

å› æ­¤ï¼Œæ ¸å¿ƒä»£ç  `SumTask` ç»§æ‰¿è‡ª `RecursiveTask`ï¼Œåœ¨ `compute()` æ–¹æ³•ä¸­ï¼Œå…³é”®æ˜¯å¦‚ä½• â€œåˆ†è£‚â€ å‡ºå­ä»»åŠ¡å¹¶ä¸”æäº¤å­ä»»åŠ¡ï¼š

```java
class SumTask extends RecursiveTask<Long> {
    protected Long compute() {
        // â€œåˆ†è£‚â€ å­ä»»åŠ¡:
        SumTask subtask1 = new SumTask(...);
        SumTask subtask2 = new SumTask(...);
        // invokeAll ä¼šå¹¶è¡Œè¿è¡Œä¸¤ä¸ªå­ä»»åŠ¡:
        invokeAll(subtask1, subtask2);
        // è·å¾—å­ä»»åŠ¡çš„ç»“æœ:
        Long subresult1 = subtask1.join();
        Long subresult2 = subtask2.join();
        // æ±‡æ€»ç»“æœ:
        return subresult1 + subresult2;
    }
}
```

Fork/Join çº¿ç¨‹æ± åœ¨ Java æ ‡å‡†åº“ä¸­å°±æœ‰åº”ç”¨ã€‚Java æ ‡å‡†åº“æä¾›çš„ `java.util.Arrays.parallelSort(array)` å¯ä»¥è¿›è¡Œå¹¶è¡Œæ’åºï¼Œå®ƒçš„åŸç†å°±æ˜¯å†…éƒ¨é€šè¿‡ Fork/Join å¯¹å¤§æ•°ç»„åˆ†æ‹†è¿›è¡Œå¹¶è¡Œæ’åºï¼Œåœ¨å¤šæ ¸ CPU ä¸Šå°±å¯ä»¥å¤§å¤§æé«˜æ’åºçš„é€Ÿåº¦ã€‚

## ğŸ€ å°ç»“

- Fork/Join æ˜¯ä¸€ç§åŸºäº â€œåˆ†æ²»â€ çš„ç®—æ³•ï¼šé€šè¿‡åˆ†è§£ä»»åŠ¡ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œæœ€ååˆå¹¶ç»“æœå¾—åˆ°æœ€ç»ˆç»“æœã€‚

- `ForkJoinPool` çº¿ç¨‹æ± å¯ä»¥æŠŠä¸€ä¸ªå¤§ä»»åŠ¡åˆ†æ‹†æˆå°ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œä»»åŠ¡ç±»å¿…é¡»ç»§æ‰¿è‡ª `RecursiveTask` æˆ– `RecursiveAction`ã€‚

- ä½¿ç”¨ Fork/Join æ¨¡å¼å¯ä»¥è¿›è¡Œå¹¶è¡Œè®¡ç®—ä»¥æé«˜æ•ˆç‡ã€‚
