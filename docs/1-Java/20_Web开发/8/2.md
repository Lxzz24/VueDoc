---
title: ä¿®æ”¹å“åº”
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---


æ—¢ç„¶æˆ‘ä»¬èƒ½é€šè¿‡ Filter ä¿®æ”¹ `HttpServletRequest`ï¼Œè‡ªç„¶ä¹Ÿèƒ½ä¿®æ”¹ `HttpServletResponse`ï¼Œå› ä¸ºè¿™ä¸¤è€…éƒ½æ˜¯æ¥å£ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨ä»€ä¹ˆæƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦ä¿®æ”¹ `HttpServletResponse`ã€‚

å‡è®¾æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ª Servletï¼Œä½†ç”±äºä¸šåŠ¡é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œå¤„ç†è¯¥è¯·æ±‚éœ€è¦è€—è´¹å¾ˆé•¿çš„æ—¶é—´ï¼š

```java
@WebServlet(urlPatterns = "/slow/hello")
public class HelloServlet extends HttpServlet {
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        resp.setContentType("text/html");
        // æ¨¡æ‹Ÿè€—æ—¶ 1 ç§’:
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
        }
        PrintWriter pw = resp.getWriter();
        pw.write("<h1>Hello, world!</h1>");
        pw.flush();
    }
}
```

å¥½æ¶ˆæ¯æ˜¯æ¯æ¬¡è¿”å›çš„å“åº”å†…å®¹æ˜¯å›ºå®šçš„ï¼Œå› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬èƒ½ä½¿ç”¨ç¼“å­˜å°†ç»“æœç¼“å­˜èµ·æ¥ï¼Œå°±å¯ä»¥å¤§å¤§æé«˜ Web åº”ç”¨ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚

ç¼“å­˜é€»è¾‘æœ€å¥½ä¸è¦åœ¨ Servlet å†…éƒ¨å®ç°ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›èƒ½å¤ç”¨ç¼“å­˜é€»è¾‘ï¼Œæ‰€ä»¥ï¼Œç¼–å†™ä¸€ä¸ª `CacheFilter` æœ€åˆé€‚ï¼š

```java
@WebFilter("/slow/*")
public class CacheFilter implements Filter {
    // Path åˆ° byte[] çš„ç¼“å­˜:
    private Map<String, byte[]> cache = new ConcurrentHashMap<>();

    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        // è·å– Path:
        String url = req.getRequestURI();
        // è·å–ç¼“å­˜å†…å®¹:
        byte[] data = this.cache.get(url);
        resp.setHeader("X-Cache-Hit", data == null ? "No" : "Yes");
        if (data == null) {
            // ç¼“å­˜æœªæ‰¾åˆ°, æ„é€ ä¸€ä¸ªä¼ªé€ çš„ Response:
            CachedHttpServletResponse wrapper = new CachedHttpServletResponse(resp);
            // è®©ä¸‹æ¸¸ç»„ä»¶å†™å…¥æ•°æ®åˆ°ä¼ªé€ çš„ Response:
            chain.doFilter(request, wrapper);
            // ä»ä¼ªé€ çš„ Response ä¸­è¯»å–å†™å…¥çš„å†…å®¹å¹¶æ”¾å…¥ç¼“å­˜:
            data = wrapper.getContent();
            cache.put(url, data);
        }
        // å†™å…¥åˆ°åŸå§‹çš„ Response:
        ServletOutputStream output = resp.getOutputStream();
        output.write(data);
        output.flush();
    }
}
```

å®ç°ç¼“å­˜çš„å…³é”®åœ¨äºï¼Œè°ƒç”¨ `doFilter()` æ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½ä¼ å…¥åŸå§‹çš„ `HttpServletResponse`ï¼Œå› ä¸ºè¿™æ ·å°±ä¼šå†™å…¥ Socketï¼Œæˆ‘ä»¬ä¹Ÿå°±æ— æ³•è·å–ä¸‹æ¸¸ç»„ä»¶å†™å…¥çš„å†…å®¹ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ â€œä¼ªé€ â€ çš„ `HttpServletResponse`ï¼Œè®©ä¸‹æ¸¸ç»„ä»¶å†™å…¥åˆ°æˆ‘ä»¬é¢„è®¾çš„ `ByteArrayOutputStream`ï¼Œæˆ‘ä»¬å°± â€œæˆªè·â€ äº†ä¸‹æ¸¸ç»„ä»¶å†™å…¥çš„å†…å®¹ï¼Œäºæ˜¯ï¼Œå°±å¯ä»¥æŠŠå†…å®¹ç¼“å­˜èµ·æ¥ï¼Œå†é€šè¿‡åŸå§‹çš„ `HttpServletResponse` å®ä¾‹å†™å…¥åˆ°ç½‘ç»œã€‚

è¿™ä¸ª `CachedHttpServletResponse` å®ç°å¦‚ä¸‹ï¼š

```java
class CachedHttpServletResponse extends HttpServletResponseWrapper {
    private boolean open = false;
    private ByteArrayOutputStream output = new ByteArrayOutputStream();

    public CachedHttpServletResponse(HttpServletResponse response) {
        super(response);
    }

    // è·å– Writer:
    public PrintWriter getWriter() throws IOException {
        if (open) {
            throw new IllegalStateException("Cannot re-open writer!");
        }
        open = true;
        return new PrintWriter(output, false, StandardCharsets.UTF_8);
    }

    // è·å– OutputStream:
    public ServletOutputStream getOutputStream() throws IOException {
        if (open) {
            throw new IllegalStateException("Cannot re-open output stream!");
        }
        open = true;
        return new ServletOutputStream() {
            public boolean isReady() {
                return true;
            }

            public void setWriteListener(WriteListener listener) {
            }

            // å®é™…å†™å…¥ ByteArrayOutputStream:
            public void write(int b) throws IOException {
                output.write(b);
            }
        };
    }

    // è¿”å›å†™å…¥çš„ byte[]:
    public byte[] getContent() {
        return output.toByteArray();
    }
}
```

å¯è§ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¿®æ”¹å“åº”ï¼Œå°±å¯ä»¥é€šè¿‡ `HttpServletResponseWrapper` æ„é€ ä¸€ä¸ª â€œä¼ªé€ â€ çš„ `HttpServletResponse`ï¼Œè¿™æ ·å°±èƒ½æ‹¦æˆªåˆ°å†™å…¥çš„æ•°æ®ã€‚

ä¿®æ”¹å“åº”æ—¶ï¼Œæœ€åä¸è¦å¿˜è®°æŠŠæ•°æ®å†™å…¥åŸå§‹çš„ `HttpServletResponse` å®ä¾‹ã€‚

è¿™ä¸ª `CacheFilter` åŒæ ·æ˜¯ä¸€ä¸ª â€œå¯æ’æ‹”â€ ç»„ä»¶ï¼Œå®ƒæ˜¯å¦å¯ç”¨ä¸å½±å“ Web åº”ç”¨ç¨‹åºçš„å…¶ä»–ç»„ä»¶ï¼ˆFilterã€Servletï¼‰ã€‚

## ğŸ€ ç»ƒä¹ 

é€šè¿‡ Filter ä¿®æ”¹å“åº”

## ğŸ€ å°ç»“

å€ŸåŠ© `HttpServletResponseWrapper`ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Filter ä¸­å®ç°å¯¹åŸå§‹ `HttpServletResponse` çš„ä¿®æ”¹ã€‚


