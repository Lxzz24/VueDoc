---
title: ä¿®æ”¹è¯·æ±‚
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---


Filter å¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œé¢„å¤„ç†ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå¾ˆå¤šå…¬å…±é¢„å¤„ç†é€»è¾‘æ”¾åˆ° Filter ä¸­å®Œæˆã€‚

è€ƒå¯Ÿè¿™æ ·ä¸€ç§éœ€æ±‚ï¼šæˆ‘ä»¬åœ¨ Web åº”ç”¨ä¸­ç»å¸¸éœ€è¦å¤„ç†ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ª UploadServlet å¯ä»¥ç®€å•åœ°ç¼–å†™å¦‚ä¸‹ï¼š

```java
@WebServlet(urlPatterns = "/upload/file")
public class UploadServlet extends HttpServlet {
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // è¯»å– Request Body:
        InputStream input = req.getInputStream();
        ByteArrayOutputStream output = new ByteArrayOutputStream();
        byte[] buffer = new byte[1024];
        for (;;) {
            int len = input.read(buffer);
            if (len == -1) {
                break;
            }
            output.write(buffer, 0, len);
        }
        // TODO: å†™å…¥æ–‡ä»¶:
        // æ˜¾ç¤ºä¸Šä¼ ç»“æœ:
        String uploadedText = output.toString(StandardCharsets.UTF_8);
        PrintWriter pw = resp.getWriter();
        pw.write("<h1>Uploaded:</h1>");
        pw.write("<pre><code>");
        pw.write(uploadedText);
        pw.write("</code></pre>");
        pw.flush();
    }
}
```

ä½†æ˜¯è¦ä¿è¯æ–‡ä»¶ä¸Šä¼ çš„å®Œæ•´æ€§æ€ä¹ˆåŠï¼Ÿåœ¨ [å“ˆå¸Œç®—æ³•](https://www.liaoxuefeng.com/wiki/1252599548343744/1304227729113121) ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœåœ¨ä¸Šä¼ æ–‡ä»¶çš„åŒæ—¶ï¼ŒæŠŠæ–‡ä»¶çš„å“ˆå¸Œä¹Ÿä¼ è¿‡æ¥ï¼ŒæœåŠ¡å™¨ç«¯åšä¸€ä¸ªéªŒè¯ï¼Œå°±å¯ä»¥ç¡®ä¿ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ä¸€å®šæ˜¯å®Œæ•´çš„ã€‚

è¿™ä¸ªéªŒè¯é€»è¾‘éå¸¸é€‚åˆå†™åœ¨ `ValidateUploadFilter` ä¸­ï¼Œå› ä¸ºå®ƒå¯ä»¥å¤ç”¨ã€‚

æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç®€å•çš„ç‰ˆæœ¬ï¼Œå¿«é€Ÿå®ç° `ValidateUploadFilter` çš„é€»è¾‘ï¼š

```java
@WebFilter("/upload/*")
public class ValidateUploadFilter implements Filter {

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        // è·å–å®¢æˆ·ç«¯ä¼ å…¥çš„ç­¾åæ–¹æ³•å’Œç­¾å:
        String digest = req.getHeader("Signature-Method");
        String signature = req.getHeader("Signature");
        if (digest == null || digest.isEmpty() || signature == null || signature.isEmpty()) {
            sendErrorPage(resp, "Missing signature.");
            return;
        }
        // è¯»å– Request çš„ Body å¹¶éªŒè¯ç­¾å:
        MessageDigest md = getMessageDigest(digest);
        InputStream input = new DigestInputStream(request.getInputStream(), md);
        byte[] buffer = new byte[1024];
        for (;;) {
            int len = input.read(buffer);
            if (len == -1) {
                break;
            }
        }
        String actual = toHexString(md.digest());
        if (!signature.equals(actual)) {
            sendErrorPage(resp, "Invalid signature.");
            return;
        }
        // éªŒè¯æˆåŠŸåç»§ç»­å¤„ç†:
        chain.doFilter(request, response);
    }

    // å°† byte[] è½¬æ¢ä¸º hex string:
    private String toHexString(byte[] digest) {
        StringBuilder sb = new StringBuilder();
        for (byte b : digest) {
            sb.append(String.format("%02x", b));
        }
        return sb.toString();
    }

    // æ ¹æ®åç§°åˆ›å»º MessageDigest:
    private MessageDigest getMessageDigest(String name) throws ServletException {
        try {
            return MessageDigest.getInstance(name);
        } catch (NoSuchAlgorithmException e) {
            throw new ServletException(e);
        }
    }

    // å‘é€ä¸€ä¸ªé”™è¯¯å“åº”:
    private void sendErrorPage(HttpServletResponse resp, String errorMessage) throws IOException {
        resp.setStatus(HttpServletResponse.SC_BAD_REQUEST);
        PrintWriter pw = resp.getWriter();
        pw.write("<html><body><h1>");
        pw.write(errorMessage);
        pw.write("</h1></body></html>");
        pw.flush();
    }
}
```

è¿™ä¸ª `ValidateUploadFilter` çš„é€»è¾‘ä¼¼ä¹æ²¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ curl å‘½ä»¤æµ‹è¯•ï¼š

```sh
$ curl http://localhost:8080/upload/file -v -d 'test-data' \
  -H 'Signature-Method: SHA-1' \
  -H 'Signature: 7115e9890f5b5cc6914bdfa3b7c011db1cdafedb' \
  -H 'Content-Type: application/octet-stream'
*   Trying ::1...
* TCP_NODELAY set
* Connected to localhost (::1) port 8080 (#0)
> POST /upload/file HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/7.64.1
> Accept: */*
> Signature-Method: SHA-1
> Signature: 7115e9890f5b5cc6914bdfa3b7c011db1cdafedb
> Content-Type: application/octet-stream
> Content-Length: 9
>
* upload completely sent off: 9 out of 9 bytes
< HTTP/1.1 200
< Transfer-Encoding: chunked
< Date: Thu, 30 Jan 2020 13:56:39 GMT
<
* Connection #0 to host localhost left intact
<h1>Uploaded:</h1><pre><code></code></pre>
* Closing connection 0
```

`ValidateUploadFilter` å¯¹ç­¾åè¿›è¡ŒéªŒè¯çš„é€»è¾‘æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ï¼Œç»†å¿ƒçš„ç«¥é‹æ³¨æ„åˆ°ï¼Œ`UploadServlet` å¹¶æœªè¯»å–åˆ°ä»»ä½•æ•°æ®ï¼

è¿™é‡Œçš„åŸå› æ˜¯å¯¹ `HttpServletRequest` è¿›è¡Œè¯»å–æ—¶ï¼Œåªèƒ½è¯»å–ä¸€æ¬¡ã€‚å¦‚æœ Filter è°ƒç”¨ `getInputStream()` è¯»å–äº†ä¸€æ¬¡æ•°æ®ï¼Œåç»­ Servlet å¤„ç†æ—¶ï¼Œå†æ¬¡è¯»å–ï¼Œå°†æ— æ³•è¯»åˆ°ä»»ä½•æ•°æ®ã€‚æ€ä¹ˆåŠï¼Ÿ

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª â€œä¼ªé€ â€ çš„ `HttpServletRequest`ï¼Œå…·ä½“åšæ³•æ˜¯ä½¿ç”¨ [ä»£ç†æ¨¡å¼](https://www.liaoxuefeng.com/wiki/1252599548343744/1281319432618017)ï¼Œå¯¹ `getInputStream()` å’Œ `getReader()` è¿”å›ä¸€ä¸ªæ–°çš„æµï¼š

```java
class ReReadableHttpServletRequest extends HttpServletRequestWrapper {
    private byte[] body;
    private boolean open = false;

    public ReReadableHttpServletRequest(HttpServletRequest request, byte[] body) {
        super(request);
        this.body = body;
    }

    // è¿”å› InputStream:
    public ServletInputStream getInputStream() throws IOException {
        if (open) {
            throw new IllegalStateException("Cannot re-open input stream!");
        }
        open = true;
        return new ServletInputStream() {
            private int offset = 0;

            public boolean isFinished() {
                return offset >= body.length;
            }

            public boolean isReady() {
                return true;
            }

            public void setReadListener(ReadListener listener) {
            }

            public int read() throws IOException {
                if (offset>= body.length) {
                    return -1;
                }
                int n = body[offset] & 0xff;
                offset++;
                return n;
            }
        };
    }

    // è¿”å› Reader:
    public BufferedReader getReader() throws IOException {
        if (open) {
            throw new IllegalStateException("Cannot re-open reader!");
        }
        open = true;
        return new BufferedReader(new InputStreamReader(new ByteArrayInputStream(body), "UTF-8"));
    }
}
```

æ³¨æ„è§‚å¯Ÿ `ReReadableHttpServletRequest` çš„æ„é€ æ–¹æ³•ï¼Œå®ƒä¿å­˜äº† `ValidateUploadFilter` è¯»å–çš„ `byte[]` å†…å®¹ï¼Œå¹¶åœ¨è°ƒç”¨ `getInputStream()` æ—¶é€šè¿‡ `byte[]` æ„é€ äº†ä¸€ä¸ªæ–°çš„ `ServletInputStream`ã€‚

ç„¶åï¼Œæˆ‘ä»¬åœ¨ `ValidateUploadFilter` ä¸­ï¼ŒæŠŠ `doFilter()` è°ƒç”¨æ—¶ä¼ ç»™ä¸‹ä¸€ä¸ªå¤„ç†è€…çš„ `HttpServletRequest` æ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå·± â€œä¼ªé€ â€ çš„ `ReReadableHttpServletRequest`ï¼š

```java
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
        throws IOException, ServletException {
    ...
    chain.doFilter(new ReReadableHttpServletRequest(req, output.toByteArray()), response);
}
```

å†æ³¨æ„åˆ°æˆ‘ä»¬ç¼–å†™ `ReReadableHttpServletRequest` æ—¶ï¼Œæ˜¯ä» `HttpServletRequestWrapper` ç»§æ‰¿ï¼Œè€Œä¸æ˜¯ç›´æ¥å®ç° `HttpServletRequest` æ¥å£ã€‚è¿™æ˜¯å› ä¸ºï¼ŒServlet çš„æ¯ä¸ªæ–°ç‰ˆæœ¬éƒ½ä¼šå¯¹æ¥å£å¢åŠ ä¸€äº›æ–°æ–¹æ³•ï¼Œä» `HttpServletRequestWrapper` ç»§æ‰¿å¯ä»¥ç¡®ä¿æ–°æ–¹æ³•è¢«æ­£ç¡®åœ°è¦†å†™äº†ï¼Œå› ä¸º `HttpServletRequestWrapper` æ˜¯ç”± Servlet çš„ jar åŒ…æä¾›çš„ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†è®©æˆ‘ä»¬æ–¹ä¾¿åœ°å®ç°å¯¹ `HttpServletRequest` æ¥å£çš„ä»£ç†ã€‚

æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹å¯¹ `HttpServletRequest` æ¥å£è¿›è¡Œä»£ç†çš„æ­¥éª¤ï¼š

1. ä» `HttpServletRequestWrapper` ç»§æ‰¿ä¸€ä¸ª `XxxHttpServletRequest`ï¼Œéœ€è¦ä¼ å…¥åŸå§‹çš„ `HttpServletRequest` å®ä¾‹ï¼›
2. è¦†å†™æŸäº›æ–¹æ³•ï¼Œä½¿å¾—æ–°çš„ `XxxHttpServletRequest` å®ä¾‹çœ‹ä¸Šå» â€œæ”¹å˜â€ äº†åŸå§‹çš„ `HttpServletRequest` å®ä¾‹ï¼›
3. åœ¨ `doFilter()` ä¸­ä¼ å…¥æ–°çš„ `XxxHttpServletRequest` å®ä¾‹ã€‚

è™½ç„¶æ•´ä¸ª Filter çš„ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œä½†å®ƒçš„å¥½å¤„åœ¨äºï¼šè¿™ä¸ª Filter åœ¨æ•´ä¸ªå¤„ç†é“¾ä¸­å®ç°äº†çµæ´»çš„ â€œå¯æ’æ‹”â€ ç‰¹æ€§ï¼Œå³æ˜¯å¦å¯ç”¨å¯¹ Web åº”ç”¨ç¨‹åºçš„å…¶ä»–ç»„ä»¶ï¼ˆFilterã€Servletï¼‰å®Œå…¨æ²¡æœ‰å½±å“ã€‚

## ğŸ€ ç»ƒä¹ 

ä½¿ç”¨ Filter ä¿®æ”¹è¯·æ±‚

## ğŸ€ å°ç»“

å€ŸåŠ© `HttpServletRequestWrapper`ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Filter ä¸­å®ç°å¯¹åŸå§‹ `HttpServletRequest` çš„ä¿®æ”¹ã€‚



