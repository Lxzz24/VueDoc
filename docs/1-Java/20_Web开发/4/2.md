---
title: ä½¿ç”¨ Session å’Œ Cookie
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

åœ¨ Web åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ç»å¸¸è¦è·Ÿè¸ªç”¨æˆ·èº«ä»½ã€‚å½“ä¸€ä¸ªç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œå¦‚æœä»–ç»§ç»­è®¿é—®å…¶ä»–é¡µé¢ï¼ŒWeb ç¨‹åºå¦‚ä½•æ‰èƒ½è¯†åˆ«å‡ºè¯¥ç”¨æˆ·èº«ä»½ï¼Ÿ

å› ä¸º HTTP åè®®æ˜¯ä¸€ä¸ªæ— çŠ¶æ€åè®®ï¼Œå³ Web åº”ç”¨ç¨‹åºæ— æ³•åŒºåˆ†æ”¶åˆ°çš„ä¸¤ä¸ª HTTP è¯·æ±‚æ˜¯å¦æ˜¯åŒä¸€ä¸ªæµè§ˆå™¨å‘å‡ºçš„ã€‚ä¸ºäº†è·Ÿè¸ªç”¨æˆ·çŠ¶æ€ï¼ŒæœåŠ¡å™¨å¯ä»¥å‘æµè§ˆå™¨åˆ†é…ä¸€ä¸ªå”¯ä¸€ IDï¼Œå¹¶ä»¥ Cookie çš„å½¢å¼å‘é€åˆ°æµè§ˆå™¨ï¼Œæµè§ˆå™¨åœ¨åç»­è®¿é—®æ—¶æ€»æ˜¯é™„å¸¦æ­¤ Cookieï¼Œè¿™æ ·ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥è¯†åˆ«ç”¨æˆ·èº«ä»½ã€‚

## ğŸ€ Session

æˆ‘ä»¬æŠŠè¿™ç§åŸºäºå”¯ä¸€ ID è¯†åˆ«ç”¨æˆ·èº«ä»½çš„æœºåˆ¶ç§°ä¸º Sessionã€‚æ¯ä¸ªç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æœåŠ¡å™¨åï¼Œä¼šè‡ªåŠ¨è·å¾—ä¸€ä¸ª Session IDã€‚å¦‚æœç”¨æˆ·åœ¨ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰è®¿é—®æœåŠ¡å™¨ï¼Œé‚£ä¹ˆ Session ä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œä¸‹æ¬¡å³ä½¿å¸¦ç€ä¸Šæ¬¡åˆ†é…çš„ Session ID è®¿é—®ï¼ŒæœåŠ¡å™¨ä¹Ÿè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œä¼šåˆ†é…æ–°çš„ Session IDã€‚

JavaEE çš„ Servlet æœºåˆ¶å†…å»ºäº†å¯¹ Session çš„æ”¯æŒã€‚æˆ‘ä»¬ä»¥ç™»å½•ä¸ºä¾‹ï¼Œå½“ä¸€ä¸ªç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™ä¸ªç”¨æˆ·çš„åå­—æ”¾å…¥ä¸€ä¸ª `HttpSession` å¯¹è±¡ï¼Œä»¥ä¾¿åç»­è®¿é—®å…¶ä»–é¡µé¢çš„æ—¶å€™ï¼Œèƒ½ç›´æ¥ä» `HttpSession` å–å‡ºç”¨æˆ·åï¼š

```java
@WebServlet(urlPatterns = "/signin")
public class SignInServlet extends HttpServlet {
    // æ¨¡æ‹Ÿä¸€ä¸ªæ•°æ®åº“:
    private Map<String, String> users = Map.of("bob", "bob123", "alice", "alice123", "tom", "tomcat");

    // GET è¯·æ±‚æ—¶æ˜¾ç¤ºç™»å½•é¡µ:
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        resp.setContentType("text/html");
        PrintWriter pw = resp.getWriter();
        pw.write("<h1>Sign In</h1>");
        pw.write("<form action=\"/signin\"method=\"post\">");
        pw.write("<p>Username: <input name=\"username\"></p>");
        pw.write("<p>Password: <input name=\"password\"type=\"password\"></p>");
        pw.write("<p><button type=\"submit\">Sign In</button> <a href=\"/\">Cancel</a></p>");
        pw.write("</form>");
        pw.flush();
    }

    // POST è¯·æ±‚æ—¶å¤„ç†ç”¨æˆ·ç™»å½•:
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String name = req.getParameter("username");
        String password = req.getParameter("password");
        String expectedPassword = users.get(name.toLowerCase());
        if (expectedPassword != null && expectedPassword.equals(password)) {
            // ç™»å½•æˆåŠŸ:
            req.getSession().setAttribute("user", name);
            resp.sendRedirect("/");
        } else {
            resp.sendError(HttpServletResponse.SC_FORBIDDEN);
        }
    }
}
```

ä¸Šè¿° `SignInServlet` åœ¨åˆ¤æ–­ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œç«‹åˆ»å°†ç”¨æˆ·åæ”¾å…¥å½“å‰ `HttpSession` ä¸­ï¼š

```java
HttpSession session = req.getSession();
session.setAttribute("user", name);
```

åœ¨ `IndexServlet` ä¸­ï¼Œå¯ä»¥ä» `HttpSession` å–å‡ºç”¨æˆ·åï¼š

```java
@WebServlet(urlPatterns = "/")
public class IndexServlet extends HttpServlet {
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // ä» HttpSession è·å–å½“å‰ç”¨æˆ·å:
        String user = (String) req.getSession().getAttribute("user");
        resp.setContentType("text/html");
        resp.setCharacterEncoding("UTF-8");
        resp.setHeader("X-Powered-By", "JavaEE Servlet");
        PrintWriter pw = resp.getWriter();
        pw.write("<h1>Welcome," + (user != null ? user : "Guest") + "</h1>");
        if (user == null) {
            // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é“¾æ¥:
            pw.write("<p><a href=\"/signin\">Sign In</a></p>");
        } else {
            // å·²ç™»å½•ï¼Œæ˜¾ç¤ºç™»å‡ºé“¾æ¥:
            pw.write("<p><a href=\"/signout\">Sign Out</a></p>");
        }
        pw.flush();
    }
}
```

å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œå¯ä»¥é€šè¿‡è®¿é—® `/signout` ç™»å‡ºã€‚ç™»å‡ºé€»è¾‘å°±æ˜¯ä» `HttpSession` ä¸­ç§»é™¤ç”¨æˆ·ç›¸å…³ä¿¡æ¯ï¼š

```java
@WebServlet(urlPatterns = "/signout")
public class SignOutServlet extends HttpServlet {
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        // ä» HttpSession ç§»é™¤ç”¨æˆ·å:
        req.getSession().removeAttribute("user");
        resp.sendRedirect("/");
    }
}
```

å¯¹äº Web åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬æ€»æ˜¯é€šè¿‡ `HttpSession` è¿™ä¸ªé«˜çº§æ¥å£è®¿é—®å½“å‰ Sessionã€‚å¦‚æœè¦æ·±å…¥ç†è§£ Session åŸç†ï¼Œå¯ä»¥è®¤ä¸º Web æœåŠ¡å™¨åœ¨å†…å­˜ä¸­è‡ªåŠ¨ç»´æŠ¤äº†ä¸€ä¸ª ID åˆ° `HttpSession` çš„æ˜ å°„è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š

![image-20231220171947674](./assets/image-20231220171947674.png)

è€ŒæœåŠ¡å™¨è¯†åˆ« Session çš„å…³é”®å°±æ˜¯ä¾é ä¸€ä¸ªåä¸º `JSESSIONID` çš„ Cookieã€‚åœ¨ Servlet ä¸­ç¬¬ä¸€æ¬¡è°ƒç”¨ `req.getSession()` æ—¶ï¼ŒServlet å®¹å™¨è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Session IDï¼Œç„¶åé€šè¿‡ä¸€ä¸ªåä¸º `JSESSIONID` çš„ Cookie å‘é€ç»™æµè§ˆå™¨ï¼š

![session](./assets/l-20231220171655657.jpeg)

è¿™é‡Œè¦æ³¨æ„çš„å‡ ç‚¹æ˜¯ï¼š

- `JSESSIONID` æ˜¯ç”± Servlet å®¹å™¨è‡ªåŠ¨åˆ›å»ºçš„ï¼Œç›®çš„æ˜¯ç»´æŠ¤ä¸€ä¸ªæµè§ˆå™¨ä¼šè¯ï¼Œå®ƒå’Œæˆ‘ä»¬çš„ç™»å½•é€»è¾‘æ²¡æœ‰å…³ç³»ï¼›
- ç™»å½•å’Œç™»å‡ºçš„ä¸šåŠ¡é€»è¾‘æ˜¯æˆ‘ä»¬è‡ªå·±æ ¹æ® `HttpSession` æ˜¯å¦å­˜åœ¨ä¸€ä¸ª `"user"` çš„ Key åˆ¤æ–­çš„ï¼Œç™»å‡ºåï¼ŒSession ID å¹¶ä¸ä¼šæ”¹å˜ï¼›
- å³ä½¿æ²¡æœ‰ç™»å½•åŠŸèƒ½ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨ `HttpSession` è¿½è¸ªç”¨æˆ·ï¼Œä¾‹å¦‚ï¼Œæ”¾å…¥ä¸€äº›ç”¨æˆ·é…ç½®ä¿¡æ¯ç­‰ã€‚

é™¤äº†ä½¿ç”¨ Cookie æœºåˆ¶å¯ä»¥å®ç° Session å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡éšè—è¡¨å•ã€URL æœ«å°¾é™„åŠ  ID æ¥è¿½è¸ª Sessionã€‚è¿™äº›æœºåˆ¶å¾ˆå°‘ä½¿ç”¨ï¼Œæœ€å¸¸ç”¨çš„ Session æœºåˆ¶ä»ç„¶æ˜¯ Cookieã€‚

ä½¿ç”¨ Session æ—¶ï¼Œç”±äºæœåŠ¡å™¨æŠŠæ‰€æœ‰ç”¨æˆ·çš„ Session éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœé‡åˆ°å†…å­˜ä¸è¶³çš„æƒ…å†µï¼Œå°±éœ€è¦æŠŠéƒ¨åˆ†ä¸æ´»åŠ¨çš„ Session åºåˆ—åŒ–åˆ°ç£ç›˜ä¸Šï¼Œè¿™ä¼šå¤§å¤§é™ä½æœåŠ¡å™¨çš„è¿è¡Œæ•ˆç‡ï¼Œå› æ­¤ï¼Œæ”¾å…¥ Session çš„å¯¹è±¡è¦å°ï¼Œé€šå¸¸æˆ‘ä»¬æ”¾å…¥ä¸€ä¸ªç®€å•çš„ `User` å¯¹è±¡å°±è¶³å¤Ÿäº†ï¼š

```java
public class User {
    public long id; // å”¯ä¸€æ ‡è¯†
    public String email;
    public String name;
}
```

åœ¨ä½¿ç”¨å¤šå°æœåŠ¡å™¨æ„æˆé›†ç¾¤æ—¶ï¼Œä½¿ç”¨ Session ä¼šé‡åˆ°ä¸€äº›é¢å¤–çš„é—®é¢˜ã€‚é€šå¸¸ï¼Œå¤šå°æœåŠ¡å™¨é›†ç¾¤ä½¿ç”¨åå‘ä»£ç†ä½œä¸ºç½‘ç«™å…¥å£ï¼š

![image-20231220172005588](./assets/image-20231220172005588.png)

å¦‚æœå¤šå° Web Server é‡‡ç”¨æ— çŠ¶æ€é›†ç¾¤ï¼Œé‚£ä¹ˆåå‘ä»£ç†æ€»æ˜¯ä»¥è½®è¯¢æ–¹å¼å°†è¯·æ±‚ä¾æ¬¡è½¬å‘ç»™æ¯å° Web Serverï¼Œè¿™ä¼šé€ æˆä¸€ä¸ªç”¨æˆ·åœ¨ Web Server 1 å­˜å‚¨çš„ Session ä¿¡æ¯ï¼Œåœ¨ Web Server 2 å’Œ 3 ä¸Šå¹¶ä¸å­˜åœ¨ï¼Œå³ä» Web Server 1 ç™»å½•åï¼Œå¦‚æœåç»­è¯·æ±‚è¢«è½¬å‘åˆ° Web Server 2 æˆ– 3ï¼Œé‚£ä¹ˆç”¨æˆ·çœ‹åˆ°çš„ä»ç„¶æ˜¯æœªç™»å½•çŠ¶æ€ã€‚

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ–¹æ¡ˆä¸€æ˜¯åœ¨æ‰€æœ‰ Web Server ä¹‹é—´è¿›è¡Œ Session å¤åˆ¶ï¼Œä½†è¿™æ ·ä¼šä¸¥é‡æ¶ˆè€—ç½‘ç»œå¸¦å®½ï¼Œå¹¶ä¸”ï¼Œæ¯ä¸ª Web Server çš„å†…å­˜å‡å­˜å‚¨æ‰€æœ‰ç”¨æˆ·çš„ Sessionï¼Œå†…å­˜ä½¿ç”¨ç‡å¾ˆä½ã€‚

å¦ä¸€ä¸ªæ–¹æ¡ˆæ˜¯é‡‡ç”¨ç²˜æ»ä¼šè¯ï¼ˆSticky Sessionï¼‰æœºåˆ¶ï¼Œå³åå‘ä»£ç†åœ¨è½¬å‘è¯·æ±‚çš„æ—¶å€™ï¼Œæ€»æ˜¯æ ¹æ® JSESSIONID çš„å€¼åˆ¤æ–­ï¼Œç›¸åŒçš„ JSESSIONID æ€»æ˜¯è½¬å‘åˆ°å›ºå®šçš„ Web Serverï¼Œä½†è¿™éœ€è¦åå‘ä»£ç†çš„æ”¯æŒã€‚

æ— è®ºé‡‡ç”¨ä½•ç§æ–¹æ¡ˆï¼Œä½¿ç”¨ Session æœºåˆ¶ï¼Œä¼šä½¿å¾— Web Server çš„é›†ç¾¤å¾ˆéš¾æ‰©å±•ï¼Œå› æ­¤ï¼ŒSession é€‚ç”¨äºä¸­å°å‹ Web åº”ç”¨ç¨‹åºã€‚å¯¹äºå¤§å‹ Web åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œé€šå¸¸éœ€è¦é¿å…ä½¿ç”¨ Session æœºåˆ¶ã€‚

## ğŸ€ Cookie

å®é™…ä¸Šï¼ŒServlet æä¾›çš„ `HttpSession` æœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡ä¸€ä¸ªåä¸º `JSESSIONID` çš„ Cookie æ¥è·Ÿè¸ªç”¨æˆ·ä¼šè¯çš„ã€‚é™¤äº†è¿™ä¸ªåç§°å¤–ï¼Œå…¶ä»–åç§°çš„ Cookie æˆ‘ä»¬å¯ä»¥ä»»æ„ä½¿ç”¨ã€‚

å¦‚æœæˆ‘ä»¬æƒ³è¦è®¾ç½®ä¸€ä¸ª Cookieï¼Œä¾‹å¦‚ï¼Œè®°å½•ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€ï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ª `LanguageServlet`ï¼š

```java
@WebServlet(urlPatterns = "/pref")
public class LanguageServlet extends HttpServlet {

    private static final Set<String> LANGUAGES = Set.of("en", "zh");

    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        String lang = req.getParameter("lang");
        if (LANGUAGES.contains(lang)) {
            // åˆ›å»ºä¸€ä¸ªæ–°çš„ Cookie:
            Cookie cookie = new Cookie("lang", lang);
            // è¯¥ Cookie ç”Ÿæ•ˆçš„è·¯å¾„èŒƒå›´:
            cookie.setPath("/");
            // è¯¥ Cookie æœ‰æ•ˆæœŸ:
            cookie.setMaxAge(8640000); // 8640000 ç§’ = 100 å¤©
            // å°†è¯¥ Cookie æ·»åŠ åˆ°å“åº”:
            resp.addCookie(cookie);
        }
        resp.sendRedirect("/");
    }
}
```

åˆ›å»ºä¸€ä¸ªæ–° Cookie æ—¶ï¼Œé™¤äº†æŒ‡å®šåç§°å’Œå€¼ä»¥å¤–ï¼Œé€šå¸¸éœ€è¦è®¾ç½® `setPath("/")`ï¼Œæµè§ˆå™¨æ ¹æ®æ­¤å‰ç¼€å†³å®šæ˜¯å¦å‘é€ Cookieã€‚å¦‚æœä¸€ä¸ª Cookie è°ƒç”¨äº† `setPath("/user/")`ï¼Œé‚£ä¹ˆæµè§ˆå™¨åªæœ‰åœ¨è¯·æ±‚ä»¥ `/user/` å¼€å¤´çš„è·¯å¾„æ—¶æ‰ä¼šé™„åŠ æ­¤ Cookieã€‚é€šè¿‡ `setMaxAge()` è®¾ç½® Cookie çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ï¼Œæœ€åé€šè¿‡ `resp.addCookie()` æŠŠå®ƒæ·»åŠ åˆ°å“åº”ã€‚

å¦‚æœè®¿é—®çš„æ˜¯ https ç½‘é¡µï¼Œè¿˜éœ€è¦è°ƒç”¨ `setSecure(true)`ï¼Œå¦åˆ™æµè§ˆå™¨ä¸ä¼šå‘é€è¯¥ Cookieã€‚

å› æ­¤ï¼ŒåŠ¡å¿…æ³¨æ„ï¼šæµè§ˆå™¨åœ¨è¯·æ±‚æŸä¸ª URL æ—¶ï¼Œæ˜¯å¦æºå¸¦æŒ‡å®šçš„ Cookieï¼Œå–å†³äº Cookie æ˜¯å¦æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰è¦æ±‚ï¼š

- URL å‰ç¼€æ˜¯è®¾ç½® Cookie æ—¶çš„ Pathï¼›
- Cookie åœ¨æœ‰æ•ˆæœŸå†…ï¼›
- Cookie è®¾ç½®äº† secure æ—¶å¿…é¡»ä»¥ https è®¿é—®ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨çœ‹åˆ°æœåŠ¡å™¨å‘é€çš„ Cookieï¼š

![cookie](./assets/l-20231220171655613.jpeg)

å¦‚æœæˆ‘ä»¬è¦è¯»å– Cookieï¼Œä¾‹å¦‚ï¼Œåœ¨ `IndexServlet` ä¸­ï¼Œè¯»å–åä¸º `lang` çš„ Cookie ä»¥è·å–ç”¨æˆ·è®¾ç½®çš„è¯­è¨€ï¼Œå¯ä»¥å†™ä¸€ä¸ªæ–¹æ³•å¦‚ä¸‹ï¼š

```java
private String parseLanguageFromCookie(HttpServletRequest req) {
    // è·å–è¯·æ±‚é™„å¸¦çš„æ‰€æœ‰ Cookie:
    Cookie[] cookies = req.getCookies();
    // å¦‚æœè·å–åˆ° Cookie:
    if (cookies != null) {
        // å¾ªç¯æ¯ä¸ª Cookie:
        for (Cookie cookie : cookies) {
            // å¦‚æœ Cookie åç§°ä¸º lang:
            if (cookie.getName().equals("lang")) {
                // è¿”å› Cookie çš„å€¼:
                return cookie.getValue();
            }
        }
    }
    // è¿”å›é»˜è®¤å€¼:
    return "en";
}
```

å¯è§ï¼Œè¯»å– Cookie ä¸»è¦ä¾é éå† `HttpServletRequest` é™„å¸¦çš„æ‰€æœ‰ Cookieã€‚

## ğŸ€ ç»ƒä¹ 


## ğŸ€ å°ç»“

Servlet å®¹å™¨æä¾›äº† Session æœºåˆ¶ä»¥è·Ÿè¸ªç”¨æˆ·ï¼›

é»˜è®¤çš„ Session æœºåˆ¶æ˜¯ä»¥ Cookie å½¢å¼å®ç°çš„ï¼ŒCookie åç§°ä¸º `JSESSIONID`ï¼›

é€šè¿‡è¯»å†™ Cookie å¯ä»¥åœ¨å®¢æˆ·ç«¯è®¾ç½®ç”¨æˆ·åå¥½ç­‰ã€‚

