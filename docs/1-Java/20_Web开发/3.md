---
title: Servlet å¼€å‘
sidebarDepth: 1
category: Java æ•™ç¨‹
tag: Java
---

::: details ç›®å½•
[[toc]]
:::

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œä¸€ä¸ªå®Œæ•´çš„ Web åº”ç”¨ç¨‹åºçš„å¼€å‘æµç¨‹å¦‚ä¸‹ï¼š

1. ç¼–å†™ Servletï¼›
2. æ‰“åŒ…ä¸º war æ–‡ä»¶ï¼›
3. å¤åˆ¶åˆ° Tomcat çš„ webapps ç›®å½•ä¸‹ï¼›
4. å¯åŠ¨ Tomcatã€‚

è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸æ˜¯å¾ˆç¹çï¼Ÿå¦‚æœæˆ‘ä»¬æƒ³åœ¨ IDE ä¸­æ–­ç‚¹è°ƒè¯•ï¼Œè¿˜éœ€è¦æ‰“å¼€ Tomcat çš„è¿œç¨‹è°ƒè¯•ç«¯å£å¹¶ä¸”è¿æ¥ä¸Šå»ã€‚

![javaee-expert](./assets/l-20231220153735267.png)

![javaee-newbee](./assets/l-20231220153735157.png)

è®¸å¤šåˆå­¦è€…ç»å¸¸å¡åœ¨å¦‚ä½•åœ¨ IDE ä¸­å¯åŠ¨ Tomcat å¹¶åŠ è½½ webappï¼Œæ›´ä¸è¦è¯´æ–­ç‚¹è°ƒè¯•äº†ã€‚

æˆ‘ä»¬éœ€è¦ä¸€ç§ç®€å•å¯é ï¼Œèƒ½ç›´æ¥åœ¨ IDE ä¸­å¯åŠ¨å¹¶è°ƒè¯• webapp çš„æ–¹æ³•ã€‚

å› ä¸º Tomcat å®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ª Java ç¨‹åºï¼Œæˆ‘ä»¬çœ‹çœ‹ Tomcat çš„å¯åŠ¨æµç¨‹ï¼š

1. å¯åŠ¨ JVM å¹¶æ‰§è¡Œ Tomcat çš„ `main()` æ–¹æ³•ï¼›
2. åŠ è½½ war å¹¶åˆå§‹åŒ– Servletï¼›
3. æ­£å¸¸æœåŠ¡ã€‚

å¯åŠ¨ Tomcat æ— éå°±æ˜¯è®¾ç½®å¥½ classpath å¹¶æ‰§è¡Œ Tomcat æŸä¸ª jar åŒ…çš„ `main()` æ–¹æ³•ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠ Tomcat çš„ jar åŒ…å…¨éƒ¨å¼•å…¥è¿›æ¥ï¼Œç„¶åè‡ªå·±ç¼–å†™ä¸€ä¸ª `main()` æ–¹æ³•ï¼Œå…ˆå¯åŠ¨ Tomcatï¼Œç„¶åè®©å®ƒåŠ è½½æˆ‘ä»¬çš„ webapp å°±è¡Œã€‚

æˆ‘ä»¬æ–°å»ºä¸€ä¸ª `web-servlet-embedded` å·¥ç¨‹ï¼Œç¼–å†™ `pom.xml` å¦‚ä¸‹ï¼š

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.itranswarp.learnjava</groupId>
    <artifactId>web-servlet-embedded</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>war</packaging>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <java.version>17</java.version>
        <tomcat.version>10.1.1</tomcat.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.apache.tomcat.embed</groupId>
            <artifactId>tomcat-embed-core</artifactId>
            <version>${tomcat.version}</version>
            <scope>provided</scope>
        </dependency>
        <dependency>
            <groupId>org.apache.tomcat.embed</groupId>
            <artifactId>tomcat-embed-jasper</artifactId>
            <version>${tomcat.version}</version>
            <scope>provided</scope>
        </dependency>
    </dependencies>
</project>
```

å…¶ä¸­ï¼Œ`<packaging>` ç±»å‹ä»ç„¶ä¸º `war`ï¼Œå¼•å…¥ä¾èµ– `tomcat-embed-core` å’Œ `tomcat-embed-jasper`ï¼Œå¼•å…¥çš„ Tomcat ç‰ˆæœ¬ `<tomcat.version>` ä¸º `10.1.1`ã€‚

ä¸å¿…å¼•å…¥ Servlet APIï¼Œå› ä¸ºå¼•å…¥ Tomcat ä¾èµ–åè‡ªåŠ¨å¼•å…¥äº† Servlet APIã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ­£å¸¸ç¼–å†™ Servlet å¦‚ä¸‹ï¼š

```java
@WebServlet(urlPatterns = "/")
public class HelloServlet extends HttpServlet {
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        resp.setContentType("text/html");
        String name = req.getParameter("name");
        if (name == null) {
            name = "world";
        }
        PrintWriter pw = resp.getWriter();
        pw.write("<h1>Hello," + name + "!</h1>");
        pw.flush();
    }
}
```

ç„¶åï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ª `main()` æ–¹æ³•ï¼Œå¯åŠ¨ Tomcat æœåŠ¡å™¨ï¼š

```java
public class Main {
    public static void main(String[] args) throws Exception {
        // å¯åŠ¨ Tomcat:
        Tomcat tomcat = new Tomcat();
        tomcat.setPort(Integer.getInteger("port", 8080));
        tomcat.getConnector();
        // åˆ›å»º webapp:
        Context ctx = tomcat.addWebapp("", new File("src/main/webapp").getAbsolutePath());
        WebResourceRoot resources = new StandardRoot(ctx);
        resources.addPreResources(
                new DirResourceSet(resources, "/WEB-INF/classes", new File("target/classes").getAbsolutePath(), "/"));
        ctx.setResources(resources);
        tomcat.start();
        tomcat.getServer().await();
    }
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬ç›´æ¥è¿è¡Œ `main()` æ–¹æ³•ï¼Œå³å¯å¯åŠ¨åµŒå…¥å¼ Tomcat æœåŠ¡å™¨ï¼Œç„¶åï¼Œé€šè¿‡é¢„è®¾çš„ `tomcat.addWebapp("", new File("src/main/webapp")`ï¼ŒTomcat ä¼šè‡ªåŠ¨åŠ è½½å½“å‰å·¥ç¨‹ä½œä¸ºæ ¹ webappï¼Œå¯ç›´æ¥åœ¨æµè§ˆå™¨è®¿é—® `http://localhost:8080/`ï¼š

![embedded-tomcat](./assets/l-20231220153735205.png)

é€šè¿‡ `main()` æ–¹æ³•å¯åŠ¨ Tomcat æœåŠ¡å™¨å¹¶åŠ è½½æˆ‘ä»¬è‡ªå·±çš„ webapp æœ‰å¦‚ä¸‹å¥½å¤„ï¼š

1. å¯åŠ¨ç®€å•ï¼Œæ— éœ€ä¸‹è½½ Tomcat æˆ–å®‰è£…ä»»ä½• IDE æ’ä»¶ï¼›
2. è°ƒè¯•æ–¹ä¾¿ï¼Œå¯åœ¨ IDE ä¸­ä½¿ç”¨æ–­ç‚¹è°ƒè¯•ï¼›
3. ä½¿ç”¨ Maven åˆ›å»º war åŒ…åï¼Œä¹Ÿå¯ä»¥æ­£å¸¸éƒ¨ç½²åˆ°ç‹¬ç«‹çš„ Tomcat æœåŠ¡å™¨ä¸­ã€‚

## ğŸ€ ç”Ÿæˆå¯æ‰§è¡Œ war åŒ…

å¦‚æœè¦ç”Ÿæˆå¯æ‰§è¡Œçš„ war åŒ…ï¼Œç”¨ `java -jar xxx.war` å¯åŠ¨ï¼Œåˆ™éœ€è¦æŠŠ Tomcat çš„ä¾èµ–é¡¹çš„ `<scope>` å»æ‰ï¼Œç„¶åé…ç½® `maven-war-plugin` å¦‚ä¸‹ï¼š

```xml
<project ...>
    ...
	<build>
		<finalName>hello</finalName>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-war-plugin</artifactId>
				<version>3.3.2</version>
				<configuration>
					<!-- å¤åˆ¶ classes åˆ° war åŒ…æ ¹ç›®å½• -->
					<webResources>
						<resource>
							<directory>${project.build.directory}/classes</directory>
						</resource>
					</webResources>
					<archiveClasses>true</archiveClasses>
					<archive>
						<manifest>
							<!-- æ·»åŠ  Class-Path -->
							<addClasspath>true</addClasspath>
							<!-- Classpath å‰ç¼€ -->
							<classpathPrefix>tmp-webapp/WEB-INF/lib/</classpathPrefix>
							<!-- main å¯åŠ¨ç±» -->
							<mainClass>com.itranswarp.learnjava.Main</mainClass>
						</manifest>
					</archive>
				</configuration>
			</plugin>
		</plugins>
	</build>
</project>
```

ç”Ÿæˆçš„ war åŒ…ç»“æ„å¦‚ä¸‹ï¼š

![image-20231220154101109](./assets/image-20231220154101109.png)

ä¹‹æ‰€ä»¥è¦æŠŠç¼–è¯‘åçš„ classes å¤åˆ¶åˆ° war åŒ…æ ¹ç›®å½•ï¼Œæ˜¯å› ä¸ºç”¨ `java -jar hello.war` å¯åŠ¨æ—¶ï¼ŒJVM çš„ Class Loader ä¸ä¼šæŸ¥æ‰¾ `WEB-INF/lib` çš„ jar åŒ…ï¼Œè€Œæ˜¯ç›´æ¥ä» `hello.war` çš„æ ¹ç›®å½•æŸ¥æ‰¾ã€‚`MANIFEST.MF` ç”Ÿæˆçš„å†…å®¹å¦‚ä¸‹ï¼š

```sh
Main-Class: com.itranswarp.learnjava.Main
Class-Path: tmp-webapp/WEB-INF/lib/tomcat-embed-core-10.1.1.jar tmp-weba
 pp/WEB-INF/lib/tomcat-annotations-api-10.1.1.jar tmp-webapp/WEB-INF/lib
 /tomcat-embed-jasper-10.1.1.jar tmp-webapp/WEB-INF/lib/tomcat-embed-el-
 10.1.1.jar tmp-webapp/WEB-INF/lib/ecj-3.18.0.jar
```

æ³¨æ„åˆ° `Class-Path` çš„è·¯å¾„ï¼Œè¿™é‡Œå®šä¹‰çš„ `Class-Path` ç›¸å½“äº `java -cp` æŒ‡å®šçš„ Classpathï¼ŒJVM ä¸ä¼šåœ¨ä¸€ä¸ª jar åŒ…ä¸­æŸ¥æ‰¾ jar åŒ…å†…çš„ jar åŒ…ï¼Œå®ƒåªä¼šåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æœç´¢ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¦ä¿®æ”¹ `main()` æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œ `main()` æ–¹æ³•æ—¶ï¼Œå…ˆè‡ªè§£å‹ `war` åŒ…ï¼Œå†å¯åŠ¨ Tomcatï¼š

```java
public class Main {
    public static void main(String[] args) throws Exception {
        // åˆ¤å®šæ˜¯å¦ä» jar/war å¯åŠ¨:
        String jarFile = Main.class.getProtectionDomain().getCodeSource().getLocation().getFile();
        boolean isJarFile = jarFile.endsWith(".war") || jarFile.endsWith(".jar");
        // å®šä½ webapp æ ¹ç›®å½•:
        String webDir = isJarFile ? "tmp-webapp" : "src/main/webapp";
        if (isJarFile) {
            // è§£å‹åˆ° tmp-webapp:
            Path baseDir = Paths.get(webDir).normalize().toAbsolutePath();
            if (Files.isDirectory(baseDir)) {
                Files.delete(baseDir);
            }
            Files.createDirectories(baseDir);
            System.out.println("extract to:" + baseDir);
            try (JarFile jar = new JarFile(jarFile)) {
                List<JarEntry> entries = jar.stream().sorted(Comparator.comparing(JarEntry::getName))
                        .collect(Collectors.toList());
                for (JarEntry entry : entries) {
                    Path res = baseDir.resolve(entry.getName());
                    if (!entry.isDirectory()) {
                        System.out.println(res);
                        Files.createDirectories(res.getParent());
                        Files.copy(jar.getInputStream(entry), res);
                    }
                }
            }
            // JVM é€€å‡ºæ—¶è‡ªåŠ¨åˆ é™¤ tmp-webapp:
            Runtime.getRuntime().addShutdownHook(new Thread(() -> {
                try {
                    Files.walk(baseDir).sorted(Comparator.reverseOrder()).map(Path::toFile).forEach(File::delete);
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }));
        }
        // å¯åŠ¨ Tomcat:
        TomcatRunner.run(webDir, isJarFile ? "tmp-webapp" : "target/classes");
    }
}

// Tomcat å¯åŠ¨ç±»:
class TomcatRunner {
    public static void run(String webDir, String baseDir) throws Exception {
        Tomcat tomcat = new Tomcat();
        tomcat.setPort(Integer.getInteger("port", 8080));
        tomcat.getConnector();
        Context ctx = tomcat.addWebapp("", new File(webDir).getAbsolutePath());
        WebResourceRoot resources = new StandardRoot(ctx);
        resources.addPreResources(new DirResourceSet(resources, "/WEB-INF/classes", new File(baseDir).getAbsolutePath(), "/"));
        ctx.setResources(resources);
        tomcat.start();
        tomcat.getServer().await();
    }
}
```

ç°åœ¨ï¼Œæ‰§è¡Œ `java -jar hello.war` æ—¶ï¼ŒJVM å…ˆå®šä½ `hello.war` çš„ `Main` ç±»ï¼Œè¿è¡Œ `main()`ï¼Œè‡ªåŠ¨è§£å‹åï¼Œæ–‡ä»¶ç³»ç»Ÿç›®å½•å¦‚ä¸‹ï¼š

![image-20231220154024058](./assets/image-20231220154024058.png)

è§£å‹åçš„ç›®å½•ç»“æ„å’Œæˆ‘ä»¬åœ¨ `MANIFEST.MF` ä¸­è®¾å®šçš„ `Class-Path` ä¸€è‡´ï¼Œå› æ­¤ï¼ŒJVM èƒ½é¡ºåˆ©åŠ è½½ Tomcat çš„ jar åŒ…ï¼Œç„¶åè¿è¡Œ Tomcatï¼Œå¯åŠ¨ Web Appã€‚

ç¼–å†™å¯æ‰§è¡Œçš„ jar æˆ–è€… war éœ€è¦æ³¨æ„çš„å‡ ç‚¹ï¼š

- å¿…é¡»åœ¨ `MANIFEST.MF` ä¸­æŒ‡å®š `Main-Class` å’Œ `Class-Path`ï¼›
- `Main` å¿…é¡»èƒ½åœ¨ jar/war åŒ…çš„æ ¹ç›®å½•ä¸‹è¢« JVM çš„ Class Loader åŠ è½½ï¼›
- `Main` è´Ÿè´£è§£å‹ jar/warï¼Œè§£å‹åçš„ç›®å½•ç»“æ„ä¸ `MANIFEST.MF` ä¸­è®¾å®šçš„ `Class-Path` ä¸€è‡´ï¼›
- `Main` ä¸èƒ½å¼•ç”¨ä»»ä½•è§£å‹åæ‰èƒ½è¢«åŠ è½½çš„ç±»ï¼Œä¾‹å¦‚ `org.apache.catalina.startup.Tomcat`ã€‚

å¯¹ SpringBoot æœ‰æ‰€äº†è§£çš„ç«¥é‹å¯èƒ½çŸ¥é“ï¼ŒSpringBoot ä¹Ÿæ”¯æŒåœ¨ `main()` æ–¹æ³•ä¸­ä¸€è¡Œä»£ç ç›´æ¥å¯åŠ¨ Tomcatï¼Œå¹¶ä¸”è¿˜èƒ½æ–¹ä¾¿åœ°æ›´æ¢æˆ Jetty ç­‰å…¶ä»–æœåŠ¡å™¨ã€‚å®ƒçš„å¯åŠ¨æ–¹å¼å’Œæˆ‘ä»¬ä»‹ç»çš„æ˜¯åŸºæœ¬ä¸€æ ·çš„ï¼Œåç»­æ¶‰åŠåˆ° SpringBoot çš„éƒ¨åˆ†æˆ‘ä»¬è¿˜ä¼šè¯¦ç»†è®²è§£ã€‚

## ğŸ€ ç»ƒä¹ 

ä½¿ç”¨åµŒå…¥å¼ Tomcat è¿è¡Œ Servlet

æ³¨æ„ï¼šå¼•å…¥çš„ Tomcat çš„ scope ä¸º `provided`ï¼Œåœ¨ Idea ä¸‹è¿è¡Œæ—¶ï¼Œéœ€è¦è®¾ç½® `Run/Debug Configurations`ï¼Œé€‰æ‹© `Application - Main`ï¼Œé’©ä¸Š `Include dependencies with "Provided" scope`ï¼Œè¿™æ ·æ‰èƒ½è®© Idea åœ¨è¿è¡Œæ—¶æŠŠ Tomcat ç›¸å…³ä¾èµ–åŒ…è‡ªåŠ¨æ·»åŠ åˆ° classpath ä¸­ã€‚

## ğŸ€ å°ç»“

å¼€å‘ Servlet æ—¶ï¼Œæ¨èä½¿ç”¨ `main()` æ–¹æ³•å¯åŠ¨åµŒå…¥å¼ Tomcat æœåŠ¡å™¨å¹¶åŠ è½½å½“å‰å·¥ç¨‹çš„ webappï¼Œä¾¿äºå¼€å‘è°ƒè¯•ï¼Œä¸”ä¸å½±å“æ‰“åŒ…éƒ¨ç½²ï¼Œèƒ½æå¤§åœ°æå‡å¼€å‘æ•ˆç‡ã€‚


